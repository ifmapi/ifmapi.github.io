
//============================================================================

// Copyright © IFM Infomaster. All rights reserved.

//============================================================================

"use strict";function b64_sha1(n){return binb2b64(core_sha1(str2binb(n),n.length*8))}function str_sha1(n){return binb2str(core_sha1(str2binb(n),n.length*8))}function b64_hmac_sha1(n,t){return binb2b64(core_hmac_sha1(n,t))}function str_hmac_sha1(n,t){return binb2str(core_hmac_sha1(n,t))}function core_sha1(n,t){n[t>>5]|=128<<24-t%32;n[(t+64>>9<<4)+15]=t;for(var o=new Array(80),r=1732584193,u=-271733879,f=-1732584194,e=271733878,s=-1009589776,i,c,l,a,v,y,p,h=0;h<n.length;h+=16){for(l=r,a=u,v=f,y=e,p=s,i=0;i<80;i++)o[i]=i<16?n[h+i]:rol(o[i-3]^o[i-8]^o[i-14]^o[i-16],1),c=safe_add(safe_add(rol(r,5),sha1_ft(i,u,f,e)),safe_add(safe_add(s,o[i]),sha1_kt(i))),s=e,e=f,f=rol(u,30),u=r,r=c;r=safe_add(r,l);u=safe_add(u,a);f=safe_add(f,v);e=safe_add(e,y);s=safe_add(s,p)}return[r,u,f,e,s]}function sha1_ft(n,t,i,r){return n<20?t&i|~t&r:n<40?t^i^r:n<60?t&i|t&r|i&r:t^i^r}function sha1_kt(n){return n<20?1518500249:n<40?1859775393:n<60?-1894007588:-899497514}function core_hmac_sha1(n,t){var r=str2binb(n),u,f,i,e;for(r.length>16&&(r=core_sha1(r,n.length*8)),u=new Array(16),f=new Array(16),i=0;i<16;i++)u[i]=r[i]^909522486,f[i]=r[i]^1549556828;return e=core_sha1(u.concat(str2binb(t)),512+t.length*8),core_sha1(f.concat(e),672)}function safe_add(n,t){var i=(n&65535)+(t&65535),r=(n>>16)+(t>>16)+(i>>16);return r<<16|i&65535}function rol(n,t){return n<<t|n>>>32-t}function str2binb(n){for(var i=[],t=0;t<n.length*8;t+=8)i[t>>5]|=(n.charCodeAt(t/8)&255)<<24-t%32;return i}function binb2str(n){for(var i="",t=0;t<n.length*32;t+=8)i+=String.fromCharCode(n[t>>5]>>>24-t%32&255);return i}function binb2b64(n){for(var r="",u,i,t=0;t<n.length*4;t+=3)for(u=(n[t>>2]>>8*(3-t%4)&255)<<16|(n[t+1>>2]>>8*(3-(t+1)%4)&255)<<8|n[t+2>>2]>>8*(3-(t+2)%4)&255,i=0;i<4;i++)r+=t*8+i*6>n.length*32?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(u>>6*(3-i)&63);return r}var Base64,MD5,Mustache,dateFormat,Candy;namespace("Ifm.Net").WebSocket=function(){var n={},t;return n.ErrorReasons={Failed:"Connection failed",Security:"Security error",Lost:"Connection lost"},n.MessageType={BINARY:"Binary",OBJECT:"Object",TEXT:"Text"},n.isSupported=function(){return global&&global.Ifm&&global.WebSocket?!0:!1},n.create=function(i,r){var u,f,e;if(!n.isSupported())throw Ifm.Diagnostics.Errors.notsup("WebSocket");if(!Ifm.Type.isString(i))throw Ifm.Diagnostics.Errors.arg("url");return u={},u.events=defineEvents("connecting","open","closing","closed","error","receive"),u.id=function(){return t+=1}(),u.connect=function(){if(!f||!(f.readyState<WebSocket.CLOSING)){u.events.connecting.raise(u,{});try{f=new WebSocket(i,r)}catch(o){u.events.error.raise(u,{error:o});u.events.closed.raise(u,{clean:!1,reason:Ifm.Net.WebSocket.ErrorReasons.Failed});return}f.onopen=function(){console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",t,i,r,"onopen");e=!0;u.events.open.raise(u,{})};f.onmessage=function(t){var i,r;if(!e)f.onopen({});if(Ifm.Type.isString(t.data)){if(i=t.data,i.startsWith("{")&&i.endsWith("}")){r=null;try{r=JSON.parse(i)}catch(o){}if(r!==null){u.events.receive.raise(u,{type:n.MessageType.OBJECT,message:r});return}}u.events.receive.raise(u,{type:n.MessageType.TEXT,message:i})}else u.events.receive.raise(u,{type:n.MessageType.BINARY,message:t.data})};f.onclose=function(n){console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s (code: %d)",t,i,r,"onclose",n.code);u.events.closed.raise(u,{clean:n.wasClean,reason:n.wasClean!==!0&&e===!0?Ifm.Net.WebSocket.ErrorReasons.Lost:""});e=!1;f=null};f.onerror=function(n){console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",t,i,r,"onerror");u.events.error.raise(u,n)}}},u.close=function(){(console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",t,i,r,"close"),f&&f.readyState!==WebSocket.CLOSED)&&(u.events.closing.raise(u,{}),f.close())},u.send=function(n){if(!f||f.readyState!==WebSocket.OPEN)throw Ifm.Diagnostics.Errors.op("WebSocket not open");f.send(n)},Object.defineProperties(u,{isOpen:{get:function(){return u.state===WebSocket.OPEN}},state:{get:function(){return f?f.readyState:WebSocket.CLOSED}}}),f=null,e=!1,u},t=0,n}();namespace("Ifm.Net").Peer=function(){var n={};return n.isSupported=function(){return Ifm&&Ifm.Net&&Ifm.Net.WebSocket&&Ifm.Net.WebSocket.isSupported()?!0:!1},n.query=function(t,i,r,u){n.create(t,i,function(n){n?n.query(r,function(t){u(t);n.close()}):u(null)})},n.create=function(t,i,r){function e(){u.events.closed.removeAllHandlers();u.events.receive.removeAllHandlers()}var f,u;if(!n.isSupported())throw Ifm.Diagnostics.Errors.notsup("Peer");if(!Ifm.Type.isFunction(r))throw Ifm.Diagnostics.Errors.func("callback");return f={},f.query=function(n,t){if(!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("query");if(!Ifm.Type.isFunction(t))throw Ifm.Diagnostics.Errors.func("callback");e();u.events.closed=function(){e();t(null)};u.events.receive=function(n,i){e();t(i)};u.isOpen?u.send(n):t(null)},f.receive=function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");e();u.events.closed=function(){n(null)};u.events.receive=function(t,i){n(i)}},f.send=function(n){u.isOpen&&u.send(n)},f.close=function(){e();u.close()},u=Ifm.Net.WebSocket.create(t,i),u.events.closed=function(){e();r(null)},u.events.receive=function(n,t){if(e(),t.type===Ifm.Net.WebSocket.MessageType.TEXT){var i=t.message.split("|");switch(i[0]){case"#ready":r(f);return;case"#close":console.warn(i[1]||"Forcibly closed by server");n.close();r(null);return}}console.warn("[Ifm.Net.Services.Peer] Unexpected message from server",t.data);n.close();r(null)},u.connect(),f},n}();namespace("Ifm.Net.Services").FileTransfer=function(){var n={};n.ErrorReasons={Unavailable:"Service unavailable",RequestRefused:"Request refused",InvalidToken:"Invalid token",FileCorrupted:"File corrupted",FileReadError:"File read error",SecurityError:"Security error: {err}"};n.isSupported=function(){return global&&global.Ifm&&Ifm.Net.Peer&&Ifm.Net.Peer.isSupported()&&global.File&&global.FileList&&global.FileReader&&global.Blob?!0:!1};n.create=function(u){if(!n.isSupported())throw Ifm.Diagnostics.Errors.notsup("FileTransfer");var f={};return f.events=defineEvents("waiting","started","progress","finished","canceled","error"),f.id=function(){return r+=1}(),f.isSender=undefined,f.enabled=function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");Ifm.Net.Peer.query(u,i,"#enabled",function(t){n(t&&t.message||!1)})},f.receive=function(n){if(!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("token");if(f.isSender!==undefined)throw Ifm.Diagnostics.Errors.op("FileTransfer instance already in use");f.isSender=!1;var c=Ifm.Net.WebSocket.MessageType.BINARY,a=Ifm.Net.WebSocket.MessageType.OBJECT,l=Ifm.Net.WebSocket.MessageType.TEXT,r=Ifm.Net.Services.FileTransfer.ErrorReasons,e=[],o,s,h;Ifm.Net.Peer.create(u,i,function(i){if(!i){f.events.error.raise(f,{reason:r.Unavailable});return}f.accept=function(){f.accept=function(){};i.send("#start")};f.cancel=function(){f.cancel=function(){};i.send("#cancel");i.close();f.events.canceled.raise(f,{})};i.receive(function(u){var a,v;if(!u){f.events.error.raise(f,{reason:r.RequestRefused});return}if(u.type===l){a=u.message.split("|");switch(a[0]){case"#invalidtoken":i.close();f.events.error.raise(f,{reason:r.InvalidToken});break;case"#cancel":f.cancel();break;case"#paired":f.events.waiting.raise(f,{token:n});break;case"#info":o=a[1];s=Number(a[2]);h=a[3];f.events.started.raise(f,{});break;case"#finished":if(f.cancel=function(){},i.close(),v=new Blob(e,{type:h}),v.size!=s){f.events.error.raise(f,{reason:r.FileCorrupted});return}f.events.finished.raise(f,{fileBlob:v,openOrSaveFunc:function(){if(Ifm.Type.isFunction(window.navigator.msSaveOrOpenBlob))window.navigator.msSaveOrOpenBlob(v,o);else{var n=document.createElement("a");n.href=URL.createObjectURL(v);n.download=o;n.target="_blank";n.style.cssText="display:none!important;";document.body.appendChild(n);n.click();document.body.removeChild(n)}return!1}});break;default:console.warn("[Ifm.Net.Services.FileTransfer] %s Unexpected message: %s","receive()",u.message)}}else u.type===c&&(e.push(u.message),f.events.progress.raise(f,{percentage:Math.ceil(e.length*t*100/s)}))});i.send("#receive|"+n)})},f.transfer=function(n){if(!(n instanceof File))throw Ifm.Diagnostics.Errors.arg("file");if(f.isSender!==undefined)throw Ifm.Diagnostics.Errors.op("FileTransfer instance already in use");f.isSender=!0;var h=Ifm.Net.WebSocket.MessageType.BINARY,c=Ifm.Net.WebSocket.MessageType.OBJECT,s=Ifm.Net.WebSocket.MessageType.TEXT,e=Ifm.Net.Services.FileTransfer.ErrorReasons,r=0,o=!1;Ifm.Net.Peer.create(u,i,function(i){if(!i){f.events.error.raise(f,{reason:e.Unavailable});return}f.cancel=function(){f.cancel=function(){};o=!0;u&&(u.onloadend=function(){},u.onerror=function(){},u.abort(),u=null);i.send("#cancel");i.close();f.events.canceled.raise(f,{})};var u=new FileReader;u.onloadend=function(){var e,s;o||u.readyState===FileReader.DONE&&(i.send(u.result),r+=t,e=r+Math.min(t,n.size-r),r<n.size?(f.events.progress.raise(f,{percentage:Math.ceil(r*100/n.size)}),s=n.slice(r,e),u.readAsArrayBuffer(s)):(f.cancel=function(){},i.send("#finished"),i.close(),f.events.finished.raise(f,{openOrSaveFunc:null})))};u.onerror=function(){i.close();f.events.error.raise(f,{reason:e.FileReadError})};i.receive(function(o){var h,c;if(!o){f.events.error.raise(f,{reason:e.RequestRefused});return}if(o.type===s){h=o.message.split("|");switch(h[0]){case"#denied":i.close();f.events.error.raise(f,{reason:e.SecurityError.replace("{err}",h[1])});break;case"#cancel":f.cancel();break;case"#token":f.events.waiting.raise(f,{token:h[1]});break;case"#paired":break;case"#start":i.send("#info|"+n.name+"|"+n.size+"|"+n.type);f.events.started.raise(f,{});c=n.slice(r,Math.min(t,n.size));u.readAsArrayBuffer(c);break;default:console.warn("[Ifm.Net.Services.FileTransfer] %s Unexpected message: %s","transfer()",o.message)}}});i.send("#transfer|"+n.name+"|"+n.size+"|"+n.type)})},f.accept=function(){},f.cancel=function(){},f};var i="ift",t=32768,r=0;return n}();Base64=function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var e="",o,i,r,h,c,s,u,f=0;do o=t.charCodeAt(f++),i=t.charCodeAt(f++),r=t.charCodeAt(f++),h=o>>2,c=(o&3)<<4|i>>4,s=(i&15)<<2|r>>6,u=r&63,isNaN(i)?s=u=64:isNaN(r)&&(u=64),e=e+n.charAt(h)+n.charAt(c)+n.charAt(s)+n.charAt(u);while(f<t.length);return e},decode:function(t){var i="",o,s,h,c,f,u,e,r=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do c=n.indexOf(t.charAt(r++)),f=n.indexOf(t.charAt(r++)),u=n.indexOf(t.charAt(r++)),e=n.indexOf(t.charAt(r++)),o=c<<2|f>>4,s=(f&15)<<4|u>>2,h=(u&3)<<6|e,i=i+String.fromCharCode(o),u!=64&&(i=i+String.fromCharCode(s)),e!=64&&(i=i+String.fromCharCode(h));while(r<t.length);return i}}}();MD5=function(){var u=function(n,t){var i=(n&65535)+(t&65535),r=(n>>16)+(t>>16)+(i>>16);return r<<16|i&65535},s=function(n,t){return n<<t|n>>>32-t},e=function(n){for(var i=[],t=0;t<n.length*8;t+=8)i[t>>5]|=(n.charCodeAt(t/8)&255)<<t%32;return i},h=function(n){for(var i="",t=0;t<n.length*32;t+=8)i+=String.fromCharCode(n[t>>5]>>>t%32&255);return i},c=function(n){for(var i="0123456789abcdef",r="",t=0;t<n.length*4;t++)r+=i.charAt(n[t>>2]>>t%4*8+4&15)+i.charAt(n[t>>2]>>t%4*8&15);return r},f=function(n,t,i,r,f,e){return u(s(u(u(t,n),u(r,e)),f),i)},n=function(n,t,i,r,u,e,o){return f(t&i|~t&r,n,t,u,e,o)},t=function(n,t,i,r,u,e,o){return f(t&r|i&~r,n,t,u,e,o)},i=function(n,t,i,r,u,e,o){return f(t^i^r,n,t,u,e,o)},r=function(n,t,i,r,u,e,o){return f(i^(t|~r),n,t,u,e,o)},o=function(f,e){var l;f[e>>5]|=128<<e%32;f[(e+64>>>9<<4)+14]=e;var o=1732584193,s=-271733879,h=-1732584194,c=271733878,a,v,y,p;for(l=0;l<f.length;l+=16)a=o,v=s,y=h,p=c,o=n(o,s,h,c,f[l+0],7,-680876936),c=n(c,o,s,h,f[l+1],12,-389564586),h=n(h,c,o,s,f[l+2],17,606105819),s=n(s,h,c,o,f[l+3],22,-1044525330),o=n(o,s,h,c,f[l+4],7,-176418897),c=n(c,o,s,h,f[l+5],12,1200080426),h=n(h,c,o,s,f[l+6],17,-1473231341),s=n(s,h,c,o,f[l+7],22,-45705983),o=n(o,s,h,c,f[l+8],7,1770035416),c=n(c,o,s,h,f[l+9],12,-1958414417),h=n(h,c,o,s,f[l+10],17,-42063),s=n(s,h,c,o,f[l+11],22,-1990404162),o=n(o,s,h,c,f[l+12],7,1804603682),c=n(c,o,s,h,f[l+13],12,-40341101),h=n(h,c,o,s,f[l+14],17,-1502002290),s=n(s,h,c,o,f[l+15],22,1236535329),o=t(o,s,h,c,f[l+1],5,-165796510),c=t(c,o,s,h,f[l+6],9,-1069501632),h=t(h,c,o,s,f[l+11],14,643717713),s=t(s,h,c,o,f[l+0],20,-373897302),o=t(o,s,h,c,f[l+5],5,-701558691),c=t(c,o,s,h,f[l+10],9,38016083),h=t(h,c,o,s,f[l+15],14,-660478335),s=t(s,h,c,o,f[l+4],20,-405537848),o=t(o,s,h,c,f[l+9],5,568446438),c=t(c,o,s,h,f[l+14],9,-1019803690),h=t(h,c,o,s,f[l+3],14,-187363961),s=t(s,h,c,o,f[l+8],20,1163531501),o=t(o,s,h,c,f[l+13],5,-1444681467),c=t(c,o,s,h,f[l+2],9,-51403784),h=t(h,c,o,s,f[l+7],14,1735328473),s=t(s,h,c,o,f[l+12],20,-1926607734),o=i(o,s,h,c,f[l+5],4,-378558),c=i(c,o,s,h,f[l+8],11,-2022574463),h=i(h,c,o,s,f[l+11],16,1839030562),s=i(s,h,c,o,f[l+14],23,-35309556),o=i(o,s,h,c,f[l+1],4,-1530992060),c=i(c,o,s,h,f[l+4],11,1272893353),h=i(h,c,o,s,f[l+7],16,-155497632),s=i(s,h,c,o,f[l+10],23,-1094730640),o=i(o,s,h,c,f[l+13],4,681279174),c=i(c,o,s,h,f[l+0],11,-358537222),h=i(h,c,o,s,f[l+3],16,-722521979),s=i(s,h,c,o,f[l+6],23,76029189),o=i(o,s,h,c,f[l+9],4,-640364487),c=i(c,o,s,h,f[l+12],11,-421815835),h=i(h,c,o,s,f[l+15],16,530742520),s=i(s,h,c,o,f[l+2],23,-995338651),o=r(o,s,h,c,f[l+0],6,-198630844),c=r(c,o,s,h,f[l+7],10,1126891415),h=r(h,c,o,s,f[l+14],15,-1416354905),s=r(s,h,c,o,f[l+5],21,-57434055),o=r(o,s,h,c,f[l+12],6,1700485571),c=r(c,o,s,h,f[l+3],10,-1894986606),h=r(h,c,o,s,f[l+10],15,-1051523),s=r(s,h,c,o,f[l+1],21,-2054922799),o=r(o,s,h,c,f[l+8],6,1873313359),c=r(c,o,s,h,f[l+15],10,-30611744),h=r(h,c,o,s,f[l+6],15,-1560198380),s=r(s,h,c,o,f[l+13],21,1309151649),o=r(o,s,h,c,f[l+4],6,-145523070),c=r(c,o,s,h,f[l+11],10,-1120210379),h=r(h,c,o,s,f[l+2],15,718787259),s=r(s,h,c,o,f[l+9],21,-343485551),o=u(o,a),s=u(s,v),h=u(h,y),c=u(c,p);return[o,s,h,c]};return{hexdigest:function(n){return c(o(e(n),n.length*8))},hash:function(n){return h(o(e(n),n.length*8))}}}();Function.prototype.bind||(Function.prototype.bind=function(n){var i=this,t=Array.prototype.slice,r=Array.prototype.concat,u=t.call(arguments,1);return function(){return i.apply(n?n:this,r.call(u,t.call(arguments,0)))}});Array.prototype.indexOf||(Array.prototype.indexOf=function(n){var i=this.length,t=Number(arguments[1])||0;for(t=t<0?Math.ceil(t):Math.floor(t),t<0&&(t+=i);t<i;t++)if(t in this&&this[t]===n)return t;return-1}),function(n){function r(n,i){return new t.Builder(n,i)}function f(n){return new t.Builder("message",n)}function i(n){return new t.Builder("iq",n)}function u(n){return new t.Builder("presence",n)}var t;t={VERSION:"02c798f",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(n){for(var i=0;i<t.XHTML.tags.length;i++)if(n==t.XHTML.tags[i])return!0;return!1},validAttribute:function(n,i){if(typeof t.XHTML.attributes[n]!="undefined"&&t.XHTML.attributes[n].length>0)for(var r=0;r<t.XHTML.attributes[n].length;r++)if(i==t.XHTML.attributes[n][r])return!0;return!1},validCSS:function(n){for(var i=0;i<t.XHTML.css.length;i++)if(n==t.XHTML.css[i])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(n,i){t.NS[n]=i},forEachChild:function(n,i,r){for(var f,u=0;u<n.childNodes.length;u++)f=n.childNodes[u],f.nodeType==t.ElementType.NORMAL&&(!i||this.isTagEqual(f,i))&&r(f)},isTagEqual:function(n,t){return n.tagName.toLowerCase()==t.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var n;return document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(n=this._getIEXmlDom(),n.appendChild(n.createElement("strophe"))):n=document.implementation.createDocument("jabber:client","strophe",null),n},xmlGenerator:function(){return t._xmlGenerator||(t._xmlGenerator=t._makeGenerator()),t._xmlGenerator},_getIEXmlDom:function(){for(var n=null,i=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],t=0;t<i.length;t++)if(n===null)try{n=new ActiveXObject(i[t])}catch(r){n=null}else break;return n},xmlElement:function(n){if(!n)return null;for(var u=t.xmlGenerator().createElement(n),r,f,i=1;i<arguments.length;i++)if(arguments[i])if(typeof arguments[i]=="string"||typeof arguments[i]=="number")u.appendChild(t.xmlTextNode(arguments[i]));else if(typeof arguments[i]=="object"&&typeof arguments[i].sort=="function")for(r=0;r<arguments[i].length;r++)typeof arguments[i][r]=="object"&&typeof arguments[i][r].sort=="function"&&u.setAttribute(arguments[i][r][0],arguments[i][r][1]);else if(typeof arguments[i]=="object")for(f in arguments[i])arguments[i].hasOwnProperty(f)&&u.setAttribute(f,arguments[i][f]);return u},xmlescape:function(n){return n=n.replace(/\&/g,"&amp;"),n=n.replace(/</g,"&lt;"),n=n.replace(/>/g,"&gt;"),n=n.replace(/'/g,"&apos;"),n.replace(/"/g,"&quot;")},xmlTextNode:function(n){return t.xmlGenerator().createTextNode(n)},xmlHtmlNode:function(n){var t,i;return window.DOMParser?(i=new DOMParser,t=i.parseFromString(n,"text/xml")):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(n)),t},getText:function(n){var r,i;if(!n)return null;for(r="",n.childNodes.length===0&&n.nodeType==t.ElementType.TEXT&&(r+=n.nodeValue),i=0;i<n.childNodes.length;i++)n.childNodes[i].nodeType==t.ElementType.TEXT&&(r+=n.childNodes[i].nodeValue);return t.xmlescape(r)},copyElement:function(n){var i,r;if(n.nodeType==t.ElementType.NORMAL){for(r=t.xmlElement(n.tagName),i=0;i<n.attributes.length;i++)r.setAttribute(n.attributes[i].nodeName.toLowerCase(),n.attributes[i].value);for(i=0;i<n.childNodes.length;i++)r.appendChild(t.copyElement(n.childNodes[i]))}else n.nodeType==t.ElementType.TEXT&&(r=t.xmlGenerator().createTextNode(n.nodeValue));return r},createHtml:function(n){var i,u,o,e,f,r,s,h,c,l,a;if(n.nodeType==t.ElementType.NORMAL)if(e=n.nodeName.toLowerCase(),t.XHTML.validTag(e))try{for(u=t.xmlElement(e),i=0;i<t.XHTML.attributes[e].length;i++)if(f=t.XHTML.attributes[e][i],r=n.getAttribute(f),typeof r!="undefined"&&r!==null&&r!==""&&r!==!1&&r!==0)if(f=="style"&&typeof r=="object"&&typeof r.cssText!="undefined"&&(r=r.cssText),f=="style"){for(s=[],h=r.split(";"),o=0;o<h.length;o++)c=h[o].split(":"),l=c[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),t.XHTML.validCSS(l)&&(a=c[1].replace(/^\s*/,"").replace(/\s*$/,""),s.push(l+": "+a));s.length>0&&(r=s.join("; "),u.setAttribute(f,r))}else u.setAttribute(f,r);for(i=0;i<n.childNodes.length;i++)u.appendChild(t.createHtml(n.childNodes[i]))}catch(v){u=t.xmlTextNode("")}else for(u=t.xmlGenerator().createDocumentFragment(),i=0;i<n.childNodes.length;i++)u.appendChild(t.createHtml(n.childNodes[i]));else if(n.nodeType==t.ElementType.FRAGMENT)for(u=t.xmlGenerator().createDocumentFragment(),i=0;i<n.childNodes.length;i++)u.appendChild(t.createHtml(n.childNodes[i]));else n.nodeType==t.ElementType.TEXT&&(u=t.xmlTextNode(n.nodeValue));return u},escapeNode:function(n){return n.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(n){return n.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(n){return n.indexOf("@")<0?null:n.split("@")[0]},getDomainFromJid:function(n){var i=t.getBareJidFromJid(n),r;return i.indexOf("@")<0?i:(r=i.split("@"),r.splice(0,1),r.join("@"))},getResourceFromJid:function(n){var t=n.split("/");return t.length<2?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(n){return n?n.split("/")[0]:null},log:function(){return},debug:function(n){this.log(this.LogLevel.DEBUG,n)},info:function(n){this.log(this.LogLevel.INFO,n)},warn:function(n){this.log(this.LogLevel.WARN,n)},error:function(n){this.log(this.LogLevel.ERROR,n)},fatal:function(n){this.log(this.LogLevel.FATAL,n)},serialize:function(n){var r,f,i,u;if(!n)return null;for(typeof n.tree=="function"&&(n=n.tree()),f=n.nodeName,n.getAttribute("_realname")&&(f=n.getAttribute("_realname")),r="<"+f,i=0;i<n.attributes.length;i++)n.attributes[i].nodeName!="_realname"&&(r+=" "+n.attributes[i].nodeName.toLowerCase()+"='"+n.attributes[i].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'");if(n.childNodes.length>0){for(r+=">",i=0;i<n.childNodes.length;i++){u=n.childNodes[i];switch(u.nodeType){case t.ElementType.NORMAL:r+=t.serialize(u);break;case t.ElementType.TEXT:r+=t.xmlescape(u.nodeValue);break;case t.ElementType.CDATA:r+="<![CDATA["+u.nodeValue+"]\]>"}}r+="<\/"+f+">"}else r+="/>";return r},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(n,i){t._connectionPlugins[n]=i}};t.Builder=function(n,i){(n=="presence"||n=="message"||n=="iq")&&(i&&!i.xmlns?i.xmlns=t.NS.CLIENT:i||(i={xmlns:t.NS.CLIENT}));this.nodeTree=t.xmlElement(n,i);this.node=this.nodeTree};t.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return t.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},attrs:function(n){for(var t in n)n.hasOwnProperty(t)&&this.node.setAttribute(t,n[t]);return this},c:function(n,i,r){var u=t.xmlElement(n,i,r);return this.node.appendChild(u),r||(this.node=u),this},cnode:function(n){var i,u=t.xmlGenerator(),r;try{i=u.importNode!==undefined}catch(f){i=!1}return r=i?u.importNode(n,!0):t.copyElement(n),this.node.appendChild(r),this.node=r,this},t:function(n){var i=t.xmlTextNode(n);return this.node.appendChild(i),this},h:function(n){var r=document.createElement("body"),i;for(r.innerHTML=n,i=t.createHtml(r);i.childNodes.length>0;)this.node.appendChild(i.childNodes[0]);return this}};t.Handler=function(n,i,r,u,f,e,o){this.handler=n;this.ns=i;this.name=r;this.type=u;this.id=f;this.options=o||{matchBare:!1};this.options.matchBare||(this.options.matchBare=!1);this.from=this.options.matchBare?e?t.getBareJidFromJid(e):null:e;this.user=!0};t.Handler.prototype={isMatch:function(n){var i,r=null,u;return(r=this.options.matchBare?t.getBareJidFromJid(n.getAttribute("from")):n.getAttribute("from"),i=!1,this.ns?(u=this,t.forEachChild(n,null,function(n){n.getAttribute("xmlns")==u.ns&&(i=!0)}),i=i||n.getAttribute("xmlns")==this.ns):i=!0,i&&(!this.name||t.isTagEqual(n,this.name))&&(!this.type||n.getAttribute("type")==this.type)&&(!this.id||n.getAttribute("id")==this.id)&&(!this.from||r==this.from))?!0:!1},run:function(n){var r=null;try{r=this.handler(n)}catch(i){i.sourceURL?t.fatal("error: "+this.handler+" "+i.sourceURL+":"+i.line+" - "+i.name+": "+i.message):i.fileName?(typeof console!="undefined"&&(console.trace(),console.error(this.handler," - error - ",i,i.message)),t.fatal("error: "+this.handler+" "+i.fileName+":"+i.lineNumber+" - "+i.name+": "+i.message)):t.fatal("error: "+i.message+"\n"+i.stack);throw i;}return r},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};t.TimedHandler=function(n,t){this.period=n;this.handler=t;this.lastCalled=(new Date).getTime();this.user=!0};t.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};t.Connection=function(n,i){var f,r,e,u;this.service=n;this.options=i||{};f=this.options.protocol||"";this._proto=n.indexOf("ws:")===0||n.indexOf("wss:")===0||f.indexOf("ws")===0?new t.Websocket(this):new t.Bosh(this);this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=!1;this.do_bind=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.do_authentication=!0;this.authenticated=!1;this.disconnecting=!1;this.connected=!1;this.errors=0;this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(r in t._connectionPlugins)t._connectionPlugins.hasOwnProperty(r)&&(e=t._connectionPlugins[r],u=function(){},u.prototype=e,this[r]=new u,this[r].init(this))};t.Connection.prototype={reset:function(){this._proto._reset();this.do_session=!1;this.do_bind=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=!1;this.disconnecting=!1;this.connected=!1;this.errors=0;this._requests=[];this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(n){var i=t.getNodeFromJid(this.jid),r=(Math.floor(Math.random()*4026531840)+268435456).toString(16);return typeof n=="string"||typeof n=="number"?++this._uniqueId+":"+i+"-"+r+":"+n:++this._uniqueId+":"+i+"-"+r},connect:function(n,i,r,u,f,e){this.jid=n;this.authzid=t.getBareJidFromJid(this.jid);this.authcid=t.getNodeFromJid(this.jid);this.pass=i;this.servtype="xmpp";this.connect_callback=r;this.disconnecting=!1;this.connected=!1;this.authenticated=!1;this.errors=0;this.domain=t.getDomainFromJid(this.jid);this._changeConnectStatus(t.Status.CONNECTING,null);this._proto._connect(u,f,e)},attach:function(n,t,i,r,u,f,e){this._proto._attach(n,t,i,r,u,f,e)},xmlInput:function(){return},xmlOutput:function(){return},rawInput:function(){return},rawOutput:function(){return},send:function(n){if(n!==null){if(typeof n.sort=="function")for(var t=0;t<n.length;t++)this._queueData(n[t]);else typeof n.tree=="function"?this._queueData(n.tree()):this._queueData(n);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(n,t,i,r){var f=null,e=this,u,o;return typeof n.tree=="function"&&(n=n.tree()),u=n.getAttribute("id"),u||(u=this.getUniqueId("sendIQ"),n.setAttribute("id",u)),o=this.addHandler(function(n){f&&e.deleteTimedHandler(f);var r=n.getAttribute("type");if(r=="result")t&&t(n);else if(r=="error")i&&i(n);else throw{name:"StropheError",message:"Got bad IQ type of "+r};},null,"iq",null,u),r&&(f=this.addTimedHandler(r,function(){return e.deleteHandler(o),i&&i(null),!1})),this.send(n),u},_queueData:function(n){if(n===null||!n.tagName||!n.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(n)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(n,i){var r=new t.TimedHandler(n,i);return this.addTimeds.push(r),r},deleteTimedHandler:function(n){this.removeTimeds.push(n)},addHandler:function(n,i,r,u,f,e,o){var s=new t.Handler(n,i,r,u,f,e,o);return this.addHandlers.push(s),s},deleteHandler:function(n){this.removeHandlers.push(n)},disconnect:function(n){if(this._changeConnectStatus(t.Status.DISCONNECTING,n),t.info("Disconnect was called because: "+n),this.connected){var i=!1;this.disconnecting=!0;this.authenticated&&(i=u({xmlns:t.NS.CLIENT,type:"unavailable"}));this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this));this._proto._disconnect(i)}},_changeConnectStatus:function(n,i){var r,u;for(r in t._connectionPlugins)if(t._connectionPlugins.hasOwnProperty(r)&&(u=this[r],u.statusChanged))try{u.statusChanged(n,i)}catch(f){t.error(""+r+" plugin caused an exception changing status: "+f)}if(this.connect_callback)try{this.connect_callback(n,i)}catch(e){t.error("User connection callback caused an exception: "+e)}},_doDisconnect:function(){this._disconnectTimeout!==null&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);t.info("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=!1;this.disconnecting=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(t.Status.DISCONNECTED,null);this.connected=!1},_dataRecv:function(n,i){var r,e,s,o,f,h,u;if(t.debug("_dataRecv called"),r=this._proto._reqToData(n),r!==null){for(this.xmlInput!==t.Connection.prototype.xmlInput&&(r.nodeName===this._proto.strip&&r.childNodes.length?this.xmlInput(r.childNodes[0]):this.xmlInput(r)),this.rawInput!==t.Connection.prototype.rawInput&&(i?this.rawInput(i):this.rawInput(t.serialize(r)));this.removeHandlers.length>0;)s=this.removeHandlers.pop(),e=this.handlers.indexOf(s),e>=0&&this.handlers.splice(e,1);while(this.addHandlers.length>0)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return}if(o=r.getAttribute("type"),o!==null&&o=="terminate"){if(this.disconnecting)return;f=r.getAttribute("condition");h=r.getElementsByTagName("conflict");f!==null?(f=="remote-stream-error"&&h.length>0&&(f="conflict"),this._changeConnectStatus(t.Status.CONNFAIL,f)):this._changeConnectStatus(t.Status.CONNFAIL,"unknown");this.disconnect("unknown stream-error");return}u=this;t.forEachChild(r,null,function(n){var r,f,i;for(f=u.handlers,u.handlers=[],r=0;r<f.length;r++){i=f[r];try{i.isMatch(n)&&(u.authenticated||!i.user)?i.run(n)&&u.handlers.push(i):u.handlers.push(i)}catch(e){t.warn("Removing Strophe handlers due to uncaught exception: "+e.message)}}})}},mechanisms:{},_connect_cb:function(n,i,r){var u,c,f;if((t.info("_connect_cb was called"),this.connected=!0,u=this._proto._reqToData(n),u)&&(this.xmlInput!==t.Connection.prototype.xmlInput&&(u.nodeName===this._proto.strip&&u.childNodes.length?this.xmlInput(u.childNodes[0]):this.xmlInput(u)),this.rawInput!==t.Connection.prototype.rawInput&&(r?this.rawInput(r):this.rawInput(t.serialize(u))),c=this._proto._connect_cb(u),c!==t.Status.CONNFAIL)){this._authentication.sasl_scram_sha1=!1;this._authentication.sasl_plain=!1;this._authentication.sasl_digest_md5=!1;this._authentication.sasl_anonymous=!1;this._authentication.legacy_auth=!1;f=u.getElementsByTagName("stream:features").length>0;f||(f=u.getElementsByTagName("features").length>0);var o=u.getElementsByTagName("mechanism"),s=[],e,h,l=!1;if(!f){this._proto._no_auth_received(i);return}if(o.length>0)for(e=0;e<o.length;e++)h=t.getText(o[e]),this.mechanisms[h]&&s.push(this.mechanisms[h]);if(this._authentication.legacy_auth=u.getElementsByTagName("auth").length>0,l=this._authentication.legacy_auth||s.length>0,!l){this._proto._no_auth_received(i);return}this.do_authentication!==!1&&this.authenticate(s)}},authenticate:function(n){for(var f,e,h,o,s,c,u=0;u<n.length-1;++u){for(f=u,e=u+1;e<n.length;++e)n[e].prototype.priority>n[f].prototype.priority&&(f=e);f!=u&&(h=n[u],n[u]=n[f],n[f]=h)}for(o=!1,u=0;u<n.length;++u)if(n[u].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new n[u];this._sasl_mechanism.onStart(this);s=r("auth",{xmlns:t.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(c=this._sasl_mechanism.onChallenge(this,null),s.t(Base64.encode(c)));this.send(s.tree());o=!0;break}o||(t.getNodeFromJid(this.jid)===null?(this._changeConnectStatus(t.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(t.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(i({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:t.NS.AUTH}).c("username",{}).t(t.getNodeFromJid(this.jid)).tree())))},_sasl_challenge_cb:function(n){var f=Base64.decode(t.getText(n)),i=this._sasl_mechanism.onChallenge(this,f),u=r("response",{xmlns:t.NS.SASL});return i!==""&&u.t(Base64.encode(i)),this.send(u.tree()),!0},_auth1_cb:function(){var n=i({type:"set",id:"_auth_2"}).c("query",{xmlns:t.NS.AUTH}).c("username",{}).t(t.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return t.getResourceFromJid(this.jid)||(this.jid=t.getBareJidFromJid(this.jid)+"/strophe"),n.up().c("resource",{}).t(t.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(n.tree()),!1},_sasl_success_cb:function(n){if(this._sasl_data["server-signature"]){var i,u=Base64.decode(t.getText(n)),r=u.match(/([a-z]+)=([^,]+)(,|$)/);if(r[1]=="v"&&(i=r[2]),i!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}return t.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null),this._sendRestart(),!1},_sasl_auth1_cb:function(n){var r,u,f;for(this.features=n,r=0;r<n.childNodes.length;r++)u=n.childNodes[r],u.nodeName=="bind"&&(this.do_bind=!0),u.nodeName=="session"&&(this.do_session=!0);if(this.do_bind)this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),f=t.getResourceFromJid(this.jid),f?this.send(i({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:t.NS.BIND}).c("resource",{}).t(f).tree()):this.send(i({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:t.NS.BIND}).tree());else return this._changeConnectStatus(t.Status.AUTHFAIL,null),!1;return!1},_sasl_bind_cb:function(n){var f,e,r,u;if(n.getAttribute("type")=="error")return t.info("SASL binding failed."),f=n.getElementsByTagName("conflict"),f.length>0&&(e="conflict"),this._changeConnectStatus(t.Status.AUTHFAIL,e),!1;if(r=n.getElementsByTagName("bind"),r.length>0)u=r[0].getElementsByTagName("jid"),u.length>0&&(this.jid=t.getText(u[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(i({type:"set",id:"_session_auth_2"}).c("session",{xmlns:t.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(t.Status.CONNECTED,null)));else return t.info("SASL binding failed."),this._changeConnectStatus(t.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(n){if(n.getAttribute("type")=="result")this.authenticated=!0,this._changeConnectStatus(t.Status.CONNECTED,null);else if(n.getAttribute("type")=="error")return t.info("Session creation failed."),this._changeConnectStatus(t.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(t.Status.AUTHFAIL,null),!1},_auth2_cb:function(n){return n.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(t.Status.CONNECTED,null)):n.getAttribute("type")=="error"&&(this._changeConnectStatus(t.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(n,i){var r=new t.TimedHandler(n,i);return r.user=!1,this.addTimeds.push(r),r},_addSysHandler:function(n,i,r,u,f){var e=new t.Handler(n,i,r,u,f);return e.user=!1,this.addHandlers.push(e),e},_onDisconnectTimeout:function(){return t.info("_onDisconnectTimeout was called"),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var t,n,r,i,u;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());while(this.removeTimeds.length>0)n=this.removeTimeds.pop(),t=this.timedHandlers.indexOf(n),t>=0&&this.timedHandlers.splice(t,1);for(u=(new Date).getTime(),i=[],t=0;t<this.timedHandlers.length;t++)n=this.timedHandlers[t],(this.authenticated||!n.user)&&(r=n.lastCalled+n.period,r-u<=0?n.run()&&i.push(n):i.push(n));this.timedHandlers=i;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(this._onIdle.bind(this),100))}};n&&n(t,r,f,i,u);t.SASLMechanism=function(n,t,i){this.name=n;this.isClientFirst=t;this.priority=i};t.SASLMechanism.prototype={test:function(){return!0},onStart:function(n){this._connection=n},onChallenge:function(){throw new Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};t.SASLAnonymous=function(){};t.SASLAnonymous.prototype=new t.SASLMechanism("ANONYMOUS",!1,10);t.SASLAnonymous.test=function(n){return n.authcid===null};t.Connection.prototype.mechanisms[t.SASLAnonymous.prototype.name]=t.SASLAnonymous;t.SASLPlain=function(){};t.SASLPlain.prototype=new t.SASLMechanism("PLAIN",!0,20);t.SASLPlain.test=function(n){return n.authcid!==null};t.SASLPlain.prototype.onChallenge=function(n){var t=n.authzid;return t=t+"\x00",t=t+n.authcid,t=t+"\x00",t+n.pass};t.Connection.prototype.mechanisms[t.SASLPlain.prototype.name]=t.SASLPlain;t.SASLSHA1=function(){};t.SASLSHA1.prototype=new t.SASLMechanism("SCRAM-SHA-1",!0,40);t.SASLSHA1.test=function(n){return n.authcid!==null};t.SASLSHA1.prototype.onChallenge=function(n,t,i){var u=i||MD5.hexdigest(Math.random()*1234567890),r="n="+n.authcid;return r+=",r=",r+=u,n._sasl_data.cnonce=u,n._sasl_data["client-first-message-bare"]=r,r="n,,"+r,this.onChallenge=function(n,t){for(var o,f,v,r,s,h,c,i,e,y,p,l="c=biws,",a=n._sasl_data["client-first-message-bare"]+","+t+",",w=n._sasl_data.cnonce,b=/([a-z]+)=([^,]+)(,|$)/,u;t.match(b);){u=t.match(b);t=t.replace(u[0],"");switch(u[1]){case"r":o=u[2];break;case"s":f=u[2];break;case"i":v=u[2]}}if(o.substr(0,w.length)!==w)return n._sasl_data={},n._sasl_failure_cb();for(l+="r="+o,a+=l,f=Base64.decode(f),f+="\x00\x00\x00\x01",r=h=core_hmac_sha1(n.pass,f),c=1;c<v;c++){for(s=core_hmac_sha1(n.pass,binb2str(h)),i=0;i<5;i++)r[i]^=s[i];h=s}for(r=binb2str(r),e=core_hmac_sha1(r,"Client Key"),y=str_hmac_sha1(r,"Server Key"),p=core_hmac_sha1(str_sha1(binb2str(e)),a),n._sasl_data["server-signature"]=b64_hmac_sha1(y,a),i=0;i<5;i++)e[i]^=p[i];return l+(",p="+Base64.encode(binb2str(e)))}.bind(this),r};t.Connection.prototype.mechanisms[t.SASLSHA1.prototype.name]=t.SASLSHA1;t.SASLMD5=function(){};t.SASLMD5.prototype=new t.SASLMechanism("DIGEST-MD5",!1,30);t.SASLMD5.test=function(n){return n.authcid!==null};t.SASLMD5.prototype._quote=function(n){return'"'+n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};t.SASLMD5.prototype.onChallenge=function(n,t,i){for(var c=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,o=i||MD5.hexdigest(""+Math.random()*1234567890),s="",h=null,e="",l="",u,f;t.match(c);){u=t.match(c);t=t.replace(u[0],"");u[2]=u[2].replace(/^"(.+)"$/,"$1");switch(u[1]){case"realm":s=u[2];break;case"nonce":e=u[2];break;case"qop":l=u[2];break;case"host":h=u[2]}}f=n.servtype+"/"+n.domain;h!==null&&(f=f+"/"+h);var a=MD5.hash(n.authcid+":"+s+":"+this._connection.pass)+":"+e+":"+o,v="AUTHENTICATE:"+f,r="";return r+="charset=utf-8,",r+="username="+this._quote(n.authcid)+",",r+="realm="+this._quote(s)+",",r+="nonce="+this._quote(e)+",",r+="nc=00000001,",r+="cnonce="+this._quote(o)+",",r+="digest-uri="+this._quote(f)+",",r+="response="+MD5.hexdigest(MD5.hexdigest(a)+":"+e+":00000001:"+o+":auth:"+MD5.hexdigest(v))+",",r+="qop=auth",this.onChallenge=function(){return""}.bind(this),r};t.Connection.prototype.mechanisms[t.SASLMD5.prototype.name]=t.SASLMD5}(function(){window.Strophe=arguments[0];window.$build=arguments[1];window.$msg=arguments[2];window.$iq=arguments[3];window.$pres=arguments[4]});Strophe.Request=function(n,t,i,r){this.id=++Strophe._requestId;this.xmlData=n;this.data=Strophe.serialize(n);this.origFunc=t;this.func=t;this.rid=i;this.date=NaN;this.sends=r||0;this.abort=!1;this.dead=null;this.age=function(){if(!this.date)return 0;var n=new Date;return(n-this.date)/1e3};this.timeDead=function(){if(!this.dead)return 0;var n=new Date;return(n-this.dead)/1e3};this.xhr=this._newXHR()};Strophe.Request.prototype={getResponse:function(){var n=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(n=this.xhr.responseXML.documentElement,n.tagName=="parsererror"){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML));throw"parsererror";}}else this.xhr.responseText&&(Strophe.error("invalid response received"),Strophe.error("responseText: "+this.xhr.responseText),Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML)));return n},_newXHR:function(){var n=null;return window.XMLHttpRequest?(n=new XMLHttpRequest,n.overrideMimeType&&n.overrideMimeType("text/xml")):window.ActiveXObject&&(n=new ActiveXObject("Microsoft.XMLHTTP")),n.onreadystatechange=this.func.bind(null,this),n}};Strophe.Bosh=function(n){this._conn=n;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this._requests=[]};Strophe.Bosh.prototype={strip:null,_buildBody:function(){var n=$build("body",{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});return this.sid!==null&&n.attrs({sid:this.sid}),n},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null},_connect:function(n,t,i){var r,u;this.wait=n||this.wait;this.hold=t||this.hold;r=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});i&&r.attrs({route:i});u=this._conn._connect_cb;this._requests.push(new Strophe.Request(r.tree(),this._onRequestStateChange.bind(this,u.bind(this._conn)),r.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(n,t,i,r,u,f,e){this._conn.jid=n;this.sid=t;this.rid=i;this._conn.connect_callback=r;this._conn.domain=Strophe.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=u||this.wait;this.hold=f||this.hold;this.window=e||this.window;this._conn._changeConnectStatus(Strophe.Status.ATTACHED,null)},_connect_cb:function(n){var f=n.getAttribute("type"),t,e,i,r,u;if(f!==null&&f=="terminate")return Strophe.error("BOSH-Connection failed: "+t),t=n.getAttribute("condition"),e=n.getElementsByTagName("conflict"),t!==null?(t=="remote-stream-error"&&e.length>0&&(t="conflict"),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,t)):this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(),Strophe.Status.CONNFAIL;this.sid||(this.sid=n.getAttribute("sid"));i=n.getAttribute("requests");i&&(this.window=parseInt(i,10));r=n.getAttribute("hold");r&&(this.hold=parseInt(r,10));u=n.getAttribute("wait");u&&(this.wait=parseInt(u,10))},_disconnect:function(n){this._sendTerminate(n)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295)},_emptyQueue:function(){return this._requests.length===0},_hitError:function(n){this.errors++;Strophe.warn("request errored, status: "+n+", number of errors: "+this.errors);this.errors>4&&this._onDisconnectTimeout()},_no_auth_received:function(n){n=n?n.bind(this._conn):this._conn._connect_cb.bind(this._conn);var t=this._buildBody();this._requests.push(new Strophe.Request(t.tree(),this._onRequestStateChange.bind(this,n.bind(this._conn)),t.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){for(var n;this._requests.length>0;)n=this._requests.pop(),n.abort=!0,n.xhr.abort(),n.xhr.onreadystatechange=function(){}},_onIdle:function(){var n=this._conn._data,i,t,r;if(this._conn.authenticated&&this._requests.length===0&&n.length===0&&!this._conn.disconnecting&&(Strophe.debug("no requests during idle cycle, sending blank request"),n.push(null)),this._requests.length<2&&n.length>0&&!this._conn.paused){for(i=this._buildBody(),t=0;t<n.length;t++)n[t]!==null&&(n[t]==="restart"?i.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH}):i.cnode(n[t]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new Strophe.Request(i.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),i.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}this._requests.length>0&&(r=this._requests[0].age(),this._requests[0].dead!==null&&this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),r>Math.floor(Strophe.TIMEOUT*this.wait)&&(Strophe.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))},_onRequestStateChange:function(n,t){var i,r,u;if(Strophe.debug("request id "+t.id+"."+t.sends+" state changed to "+t.xhr.readyState),t.abort){t.abort=!1;return}if(t.xhr.readyState==4){i=0;try{i=t.xhr.status}catch(f){}if(typeof i=="undefined"&&(i=0),this.disconnecting&&i>=400){this._hitError(i);return}r=this._requests[0]==t;u=this._requests[1]==t;(i>0&&i<500||t.sends>5)&&(this._removeRequest(t),Strophe.debug("request id "+t.id+" should now be removed"));i==200?((u||r&&this._requests.length>0&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),Strophe.debug("request id "+t.id+"."+t.sends+" got 200"),n(t),this.errors=0):(Strophe.error("request id "+t.id+"."+t.sends+" error "+i+" happened"),(i===0||i>=400&&i<600||i>=12e3)&&(this._hitError(i),i>=400&&i<500&&(this._conn._changeConnectStatus(Strophe.Status.DISCONNECTING,null),this._conn._doDisconnect())));i>0&&i<500||t.sends>5||this._throttledRequestHandler()}},_processRequest:function(n){var u=this,t=this._requests[n],i=-1,r,o;try{t.xhr.readyState==4&&(i=t.xhr.status)}catch(c){Strophe.error("caught an error in _requests["+n+"], reqStatus: "+i)}if(typeof i=="undefined"&&(i=-1),t.sends>this.maxRetries){this._onDisconnectTimeout();return}var f=t.age(),s=!isNaN(f)&&f>Math.floor(Strophe.TIMEOUT*this.wait),e=t.dead!==null&&t.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait),h=t.xhr.readyState==4&&(i<1||i>=500);if((s||e||h)&&(e&&Strophe.error("Request "+this._requests[n].id+" timed out (secondary), restarting"),t.abort=!0,t.xhr.abort(),t.xhr.onreadystatechange=function(){},this._requests[n]=new Strophe.Request(t.xmlData,t.origFunc,t.rid,t.sends),t=this._requests[n]),t.xhr.readyState===0){Strophe.debug("request id "+t.id+"."+t.sends+" posting");try{t.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0)}catch(l){Strophe.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-service");this._conn.disconnect();return}r=function(){var n,i;if(t.date=new Date,u._conn.options.customHeaders){n=u._conn.options.customHeaders;for(i in n)n.hasOwnProperty(i)&&t.xhr.setRequestHeader(i,n[i])}t.xhr.send(t.data)};t.sends>1?(o=Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(t.sends,3))*1e3,setTimeout(r,o)):r();t.sends++;this._conn.xmlOutput!==Strophe.Connection.prototype.xmlOutput&&(t.xmlData.nodeName===this.strip&&t.xmlData.childNodes.length?this._conn.xmlOutput(t.xmlData.childNodes[0]):this._conn.xmlOutput(t.xmlData));this._conn.rawOutput!==Strophe.Connection.prototype.rawOutput&&this._conn.rawOutput(t.data)}else Strophe.debug("_processRequest: "+(n===0?"first":"second")+" request has readyState of "+t.xhr.readyState)},_removeRequest:function(n){Strophe.debug("removing request");for(var t=this._requests.length-1;t>=0;t--)n==this._requests[t]&&this._requests.splice(t,1);n.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(n){var t=this._requests[n];t.dead===null&&(t.dead=new Date);this._processRequest(n)},_reqToData:function(n){try{return n.getResponse()}catch(t){if(t!="parsererror")throw t;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(n){var t,i;Strophe.info("_sendTerminate was called");t=this._buildBody().attrs({type:"terminate"});n&&t.cnode(n.tree());i=new Strophe.Request(t.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),t.tree().getAttribute("rid"));this._requests.push(i);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(this._conn._onIdle.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){(this._requests?Strophe.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):Strophe.debug("_throttledRequestHandler called with undefined requests"),this._requests&&this._requests.length!==0)&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};Strophe.Websocket=function(n){var t,i;this._conn=n;this.strip="stream:stream";t=n.service;t.indexOf("ws:")!==0&&t.indexOf("wss:")!==0&&(i="",i+=n.options.protocol==="ws"&&window.location.protocol!=="https:"?"ws":"wss",i+="://"+window.location.host,i+=t.indexOf("/")!==0?window.location.pathname+t:t,n.service=i)};Strophe.Websocket.prototype={_buildStream:function(){return $build("stream:stream",{to:this._conn.domain,xmlns:Strophe.NS.CLIENT,"xmlns:stream":Strophe.NS.STREAM,version:"1.0"})},_check_streamerror:function(n,t){var e=n.getElementsByTagName("stream:error"),u,r,f;if(e.length===0)return!1;var o=e[0],i="",s="";for(u=0;u<o.childNodes.length;u++){if(r=o.childNodes[u],r.getAttribute("xmlns")!=="urn:ietf:params:xml:ns:xmpp-streams")break;r.nodeName==="text"?s=r.textContent:i=r.nodeName}return f="WebSocket stream error: ",f+=i?i:"unknown",s&&(f+=" - "+i),Strophe.error(f),this._conn._changeConnectStatus(t,i),this._conn._doDisconnect(),!0},_reset:function(){return},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(n){var t=this._check_streamerror(n,Strophe.Status.CONNFAIL);if(t)return Strophe.Status.CONNFAIL},_handleStreamStart:function(n){var t=!1,u=n.getAttribute("xmlns"),i,r;return(typeof u!="string"?t="Missing xmlns in stream:stream":u!==Strophe.NS.CLIENT&&(t="Wrong xmlns in stream:stream: "+u),i=n.namespaceURI,typeof i!="string"?t="Missing xmlns:stream in stream:stream":i!==Strophe.NS.STREAM&&(t="Wrong xmlns:stream in stream:stream: "+i),r=n.getAttribute("version"),typeof r!="string"?t="Missing version in stream:stream":r!=="1.0"&&(t="Wrong version in stream:stream: "+r),t)?(this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,t),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(n){var t,i,r,u;if(n.data.indexOf("<stream:stream ")===0||n.data.indexOf("<?xml")===0){if(t=n.data.replace(/^(<\?.*?\?>\s*)*/,""),t==="")return;t=n.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>");i=(new DOMParser).parseFromString(t,"text/xml").documentElement;this._conn.xmlInput(i);this._conn.rawInput(n.data);this._handleStreamStart(i)&&(this._connect_cb(i),this.streamStart=n.data.replace(/^<stream:(.*)\/>$/,"<stream:$1>"))}else{if(n.data==="<\/stream:stream>"){this._conn.rawInput(n.data);this._conn.xmlInput(document.createElement("stream:stream"));this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Received closing stream");this._conn._doDisconnect();return}r=this._streamWrap(n.data);u=(new DOMParser).parseFromString(r,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this);this._conn._connect_cb(u,null,n.data)}},_disconnect:function(n){if(this.socket.readyState!==WebSocket.CLOSED){n&&this._conn.send(n);var t="<\/stream:stream>";this._conn.xmlOutput(document.createElement("stream:stream"));this._conn.rawOutput(t);try{this.socket.send(t)}catch(i){Strophe.info("Couldn't send closing stream tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){Strophe.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(n){return this.streamStart+n+"<\/stream:stream>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(n){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(Strophe.error("Websocket closed unexcectedly"),this._conn._doDisconnect()):Strophe.info("Websocket closed")},_no_auth_received:function(n){Strophe.error("Server did not send any auth methods");this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Server did not send any auth methods");n&&(n=n.bind(this._conn),n());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_onError:function(n){Strophe.error("Websocket error "+n);this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"The WebSocket connection could not be established was disconnected.");this._disconnect()},_onIdle:function(){var i=this._conn._data,t,n,r;if(i.length>0&&!this._conn.paused){for(t=0;t<i.length;t++)i[t]!==null&&(i[t]==="restart"?(n=this._buildStream(),r=this._removeClosingTag(n),n=n.tree()):(n=i[t],r=Strophe.serialize(n)),this._conn.xmlOutput(n),this._conn.rawOutput(r),this.socket.send(r));this._conn._data=[]}},_onMessage:function(n){var t,i,r;if(n.data==="<\/stream:stream>"){r="<\/stream:stream>";this._conn.rawInput(r);this._conn.xmlInput(document.createElement("stream:stream"));this._conn.disconnecting||this._conn._doDisconnect();return}if(n.data.search("<stream:stream ")===0){if(i=n.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>"),t=(new DOMParser).parseFromString(i,"text/xml").documentElement,!this._handleStreamStart(t))return}else i=this._streamWrap(n.data),t=(new DOMParser).parseFromString(i,"text/xml").documentElement;if(!this._check_streamerror(t,Strophe.Status.ERROR)){if(this._conn.disconnecting&&t.firstChild.nodeName==="presence"&&t.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(t);this._conn.rawInput(Strophe.serialize(t));return}this._conn._dataRecv(t,n.data)}},_onOpen:function(){var n,t;Strophe.info("Websocket open");n=this._buildStream();this._conn.xmlOutput(n.tree());t=this._removeClosingTag(n);this._conn.rawOutput(t);this.socket.send(t)},_removeClosingTag:function(n){var t=Strophe.serialize(n);return t.replace(/<(stream:stream .*[^\/])\/>$/,"<$1>")},_reqToData:function(n){return n},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}},function(){var t,r,i,n=function(n,t){return function(){return n.apply(t,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(n){return this._connection=n,this._muc_handler=null,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user"),Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(n,t,r,u,f,e,o){var s,h;return h=this.test_append_nick(n,t),s=$pres({from:this._connection.jid,to:h}).c("x",{xmlns:Strophe.NS.MUC}),o!=null&&(s=s.c("history",o).up),e!=null&&s.cnode(Strophe.xmlElement("password",[],e)),typeof extended_presence!="undefined"&&extended_presence!==null&&s.up.cnode(extended_presence),this._muc_handler==null&&(this._muc_handler=this._connection.addHandler(function(t){return function(i){var e,c,r,o,s,l,h,u,f,a;if((e=i.getAttribute("from"),!e)||(s=e.split("/")[0],!t.rooms[s]))return!0;if(n=t.rooms[s],r={},i.nodeName==="message")r=n._message_handlers;else if(i.nodeName==="presence"&&(u=i.getElementsByTagName("x"),u.length>0))for(f=0,a=u.length;f<a;f++)if(l=u[f],h=l.getAttribute("xmlns"),h&&h.match(Strophe.NS.MUC)){r=n._presence_handlers;break}for(o in r)c=r[o],c(i,n)||delete r[o];return!0}}(this))),this.rooms.hasOwnProperty(n)||(this.rooms[n]=new i(this,n,t,e),this.roomNames.push(n)),u&&this.rooms[n].addHandler("presence",u),r&&this.rooms[n].addHandler("message",r),f&&this.rooms[n].addHandler("roster",f),this._connection.send(s)},leave:function(n,t,i,r){var f,e,u,o;return f=this.roomNames.indexOf(n),delete this.rooms[n],f>=0&&(this.roomNames.splice(f,1),this.roomNames.length===0&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null)),o=this.test_append_nick(n,t),u=this._connection.getUniqueId(),e=$pres({type:"unavailable",id:u,from:this._connection.jid,to:o}),r!=null&&e.c("status",r),i!=null&&this._connection.addHandler(i,null,"presence",null,u),this._connection.send(e),u},message:function(n,t,i,r,u){var f,e,o,s;return s=this.test_append_nick(n,t),u=u||(t!=null?"chat":"groupchat"),e=this._connection.getUniqueId(),f=$msg({to:s,from:this._connection.jid,type:u,id:e}).c("body",{xmlns:Strophe.NS.CLIENT}).t(i),f.up(),r!=null&&(f.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(r),f.node.childNodes.length===0?(o=f.node.parentNode,f.up().up(),f.node.removeChild(o)):f.up().up()),f.c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(f),e},groupchat:function(n,t,i){return this.message(n,null,t,i)},invite:function(n,t,i){var r,u;return u=this._connection.getUniqueId(),r=$msg({from:this._connection.jid,to:n,id:u}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:t}),i!=null&&r.c("reason",i),this._connection.send(r),u},directInvite:function(n,t,i,r){var u,e,f;return f=this._connection.getUniqueId(),u={xmlns:"jabber:x:conference",jid:n},i!=null&&(u.reason=i),r!=null&&(u.password=r),e=$msg({from:this._connection.jid,to:t,id:f}).c("x",u),this._connection.send(e),f},queryOccupants:function(n,t,i){var r,u;return r={xmlns:Strophe.NS.DISCO_ITEMS},u=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",r),this._connection.sendIQ(u,t,i)},configure:function(n,t,i){var r,u;return r=$iq({to:n,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),u=r.tree(),this._connection.sendIQ(u,t,i)},cancelConfigure:function(n){var t,i;return t=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}),i=t.tree(),this._connection.sendIQ(i)},saveConfiguration:function(n,t,i,r){var e,u,o,f,s;if(u=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),typeof Form!="undefined"&&t instanceof Form)t.type="submit",u.cnode(t.toXML());else for(u.c("x",{xmlns:"jabber:x:data",type:"submit"}),f=0,s=t.length;f<s;f++)e=t[f],u.cnode(e).up();return o=u.tree(),this._connection.sendIQ(o,i,r)},createInstantRoom:function(n,t,i){var r;return r=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this._connection.sendIQ(r.tree(),t,i)},setTopic:function(n,t){var i;return i=$msg({to:n,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(t),this._connection.send(i.tree())},_modifyPrivilege:function(n,t,i,r,u){var f;return f=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(t.node),i!=null&&f.c("reason",i),this._connection.sendIQ(f.tree(),r,u)},modifyRole:function(n,t,i,r,u,f){var e;return e=$build("item",{nick:t,role:i}),this._modifyPrivilege(n,e,r,u,f)},kick:function(n,t,i,r,u){return this.modifyRole(n,t,"none",i,r,u)},voice:function(n,t,i,r,u){return this.modifyRole(n,t,"participant",i,r,u)},mute:function(n,t,i,r,u){return this.modifyRole(n,t,"visitor",i,r,u)},op:function(n,t,i,r,u){return this.modifyRole(n,t,"moderator",i,r,u)},deop:function(n,t,i,r,u){return this.modifyRole(n,t,"participant",i,r,u)},modifyAffiliation:function(n,t,i,r,u,f){var e;return e=$build("item",{jid:t,affiliation:i}),this._modifyPrivilege(n,e,r,u,f)},ban:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"outcast",i,r,u)},member:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"member",i,r,u)},revoke:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"none",i,r,u)},owner:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"owner",i,r,u)},admin:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"admin",i,r,u)},changeNick:function(n,t){var i,r;return r=this.test_append_nick(n,t),i=$pres({from:this._connection.jid,to:r,id:this._connection.getUniqueId()}),this._connection.send(i.tree())},setStatus:function(n,t,i,r){var u,f;return f=this.test_append_nick(n,t),u=$pres({from:this._connection.jid,to:f}),i!=null&&u.c("show",i).up(),r!=null&&u.c("status",r),this._connection.send(u.tree())},listRooms:function(n,t,i){var r;return r=$iq({to:n,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),this._connection.sendIQ(r,t,i)},test_append_nick:function(n,t){var i,r;return r=Strophe.escapeNode(Strophe.getNodeFromJid(n)),i=Strophe.getDomainFromJid(n),r+"@"+i+(t!=null?"/"+t:"")}});i=function(){function i(t,i,r,u){this.client=t;this.name=i;this.nick=r;this.password=u;this._roomRosterHandler=n(this._roomRosterHandler,this);this._addOccupant=n(this._addOccupant,this);this.roster={};this._message_handlers={};this._presence_handlers={};this._roster_handlers={};this._handler_ids=0;t.muc&&(this.client=t.muc);this.name=Strophe.getBareJidFromJid(i);this.addHandler("presence",this._roomRosterHandler)}return i.prototype.join=function(n,t,i){return this.client.join(this.name,this.nick,n,t,i,this.password)},i.prototype.leave=function(n,t){return this.client.leave(this.name,this.nick,n,t),delete this.client.rooms[this.name]},i.prototype.message=function(n,t,i,r){return this.client.message(this.name,n,t,i,r)},i.prototype.groupchat=function(n,t){return this.client.groupchat(this.name,n,t)},i.prototype.invite=function(n,t){return this.client.invite(this.name,n,t)},i.prototype.directInvite=function(n,t){return this.client.directInvite(this.name,n,t,this.password)},i.prototype.configure=function(n){return this.client.configure(this.name,n)},i.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)},i.prototype.saveConfiguration=function(n){return this.client.saveConfiguration(this.name,n)},i.prototype.queryOccupants=function(n,t){return this.client.queryOccupants(this.name,n,t)},i.prototype.setTopic=function(n){return this.client.setTopic(this.name,n)},i.prototype.modifyRole=function(n,t,i,r,u){return this.client.modifyRole(this.name,n,t,i,r,u)},i.prototype.kick=function(n,t,i,r){return this.client.kick(this.name,n,t,i,r)},i.prototype.voice=function(n,t,i,r){return this.client.voice(this.name,n,t,i,r)},i.prototype.mute=function(n,t,i,r){return this.client.mute(this.name,n,t,i,r)},i.prototype.op=function(n,t,i,r){return this.client.op(this.name,n,t,i,r)},i.prototype.deop=function(n,t,i,r){return this.client.deop(this.name,n,t,i,r)},i.prototype.modifyAffiliation=function(n,t,i,r,u){return this.client.modifyAffiliation(this.name,n,t,i,r,u)},i.prototype.ban=function(n,t,i,r){return this.client.ban(this.name,n,t,i,r)},i.prototype.member=function(n,t,i,r){return this.client.member(this.name,n,t,i,r)},i.prototype.revoke=function(n,t,i,r){return this.client.revoke(this.name,n,t,i,r)},i.prototype.owner=function(n,t,i,r){return this.client.owner(this.name,n,t,i,r)},i.prototype.admin=function(n,t,i,r){return this.client.admin(this.name,n,t,i,r)},i.prototype.changeNick=function(n){return this.nick=n,this.client.changeNick(this.name,n)},i.prototype.setStatus=function(n,t){return this.client.setStatus(this.name,this.nick,n,t)},i.prototype.addHandler=function(n,t){var i=this._handler_ids++;switch(n){case"presence":this._presence_handlers[i]=t;break;case"message":this._message_handlers[i]=t;break;case"roster":this._roster_handlers[i]=t;break;default:return this._handler_ids--,null}return i},i.prototype.removeHandler=function(n){return delete this._presence_handlers[n],delete this._message_handlers[n],delete this._roster_handlers[n]},i.prototype._addOccupant=function(n){var i;return i=new t(n,this),this.roster[i.nick]=i,i},i.prototype._roomRosterHandler=function(n){var r,o,f,u,t,e;r=i._parsePresence(n);t=r.nick;u=r.newnick||null;switch(r.type){case"error":return;case"unavailable":u&&(r.nick=u,this.roster[t]&&this.roster[u]&&(this.roster[t].update(this.roster[u]),this.roster[u]=this.roster[t]),this.roster[t]&&!this.roster[u]&&(this.roster[u]=this.roster[t].update(r)));delete this.roster[t];break;default:this.roster[t]?this.roster[t].update(r):this._addOccupant(r)}e=this._roster_handlers;for(f in e)o=e[f],o(this.roster,this)||delete this._roster_handlers[f];return!0},i._parsePresence=function(n){var i,r,u,t,f,e,h,c,l,o,a,s,v,y,p,w;for(t={},i=n.attributes,t.nick=Strophe.getResourceFromJid(i.from.textContent),t.type=((l=i.type)!=null?l.textContent:void 0)||null,t.states=[],o=n.childNodes,f=0,h=o.length;f<h;f++){r=o[f];switch(r.nodeName){case"status":t.status=r.textContent||null;break;case"show":t.show=r.textContent||null;break;case"x":if(i=r.attributes,((a=i.xmlns)!=null?a.textContent:void 0)===Strophe.NS.MUC_USER)for(s=r.childNodes,e=0,c=s.length;e<c;e++){u=s[e];switch(u.nodeName){case"item":i=u.attributes;t.affiliation=((v=i.affiliation)!=null?v.textContent:void 0)||null;t.role=((y=i.role)!=null?y.textContent:void 0)||null;t.jid=((p=i.jid)!=null?p.textContent:void 0)||null;t.newnick=((w=i.nick)!=null?w.textContent:void 0)||null;break;case"status":u.attributes.code&&t.states.push(u.attributes.code.textContent)}}}}return t},i}();r=function(){function t(t){this.parse=n(this.parse,this);t!=null&&this.parse(t)}return t.prototype.parse=function(n){var o,t,i,r,s,h,u,f,e,l,a,v,c;for(h=n.getElementsByTagName("query")[0].childNodes,this.identities=[],this.features=[],this.x=[],u=0,l=h.length;u<l;u++){i=h[u];t=i.attributes;switch(i.nodeName){case"identity":for(s={},f=0,a=t.length;f<a;f++)o=t[f],s[o.name]=o.textContent;this.identities.push(s);break;case"feature":this.features.push(t["var"].textContent);break;case"x":if(t=i.childNodes[0].attributes,!1)break;for(c=i.childNodes,e=0,v=c.length;e<v;e++)(r=c[e],r.attributes.type)||(t=r.attributes,this.x.push({"var":t["var"].textContent,label:t.label.textContent||"",value:r.firstChild.textContent||""}))}}return{identities:this.identities,features:this.features,x:this.x}},t}();t=function(){function t(t,i){this.room=i;this.update=n(this.update,this);this.admin=n(this.admin,this);this.owner=n(this.owner,this);this.revoke=n(this.revoke,this);this.member=n(this.member,this);this.ban=n(this.ban,this);this.modifyAffiliation=n(this.modifyAffiliation,this);this.deop=n(this.deop,this);this.op=n(this.op,this);this.mute=n(this.mute,this);this.voice=n(this.voice,this);this.kick=n(this.kick,this);this.modifyRole=n(this.modifyRole,this);this.update(t)}return t.prototype.modifyRole=function(n,t,i,r){return this.room.modifyRole(this.nick,n,t,i,r)},t.prototype.kick=function(n,t,i){return this.room.kick(this.nick,n,t,i)},t.prototype.voice=function(n,t,i){return this.room.voice(this.nick,n,t,i)},t.prototype.mute=function(n,t,i){return this.room.mute(this.nick,n,t,i)},t.prototype.op=function(n,t,i){return this.room.op(this.nick,n,t,i)},t.prototype.deop=function(n,t,i){return this.room.deop(this.nick,n,t,i)},t.prototype.modifyAffiliation=function(n,t,i,r){return this.room.modifyAffiliation(this.jid,n,t,i,r)},t.prototype.ban=function(n,t,i){return this.room.ban(this.jid,n,t,i)},t.prototype.member=function(n,t,i){return this.room.member(this.jid,n,t,i)},t.prototype.revoke=function(n,t,i){return this.room.revoke(this.jid,n,t,i)},t.prototype.owner=function(n,t,i){return this.room.owner(this.jid,n,t,i)},t.prototype.admin=function(n,t,i){return this.room.admin(this.jid,n,t,i)},t.prototype.update=function(n){return this.nick=n.nick||null,this.affiliation=n.affiliation||null,this.role=n.role||null,this.jid=n.jid||null,this.status=n.status||null,this.show=n.show||null,this},t}()}.call(this);Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(n){this._connection=n;this._identities=[];this._features=[];this._items=[];n.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);n.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(n,t,i,r){for(var u=0;u<this._identities.length;u++)if(this._identities[u].category==n&&this._identities[u].type==t&&this._identities[u].name==i&&this._identities[u].lang==r)return!1;return this._identities.push({category:n,type:t,name:i,lang:r}),!0},addFeature:function(n){for(var t=0;t<this._features.length;t++)if(this._features[t]==n)return!1;return this._features.push(n),!0},removeFeature:function(n){for(var t=0;t<this._features.length;t++)if(this._features[t]===n)return this._features.splice(t,1),!0;return!1},addItem:function(n,t,i,r){return i&&!r?!1:(this._items.push({jid:n,name:t,node:i,call_back:r}),!0)},info:function(n,t,i,r,u){var f={xmlns:Strophe.NS.DISCO_INFO},e;t&&(f.node=t);e=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",f);this._connection.sendIQ(e,i,r,u)},items:function(n,t,i,r,u){var f={xmlns:Strophe.NS.DISCO_ITEMS},e;t&&(f.node=t);e=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",f);this._connection.sendIQ(e,i,r,u)},_buildIQResult:function(n,t){var u=n.getAttribute("id"),i=n.getAttribute("from"),r=$iq({type:"result",id:u});return i!==null&&r.attrs({to:i}),r.c("query",t)},_onDiscoInfo:function(n){var u=n.getElementsByTagName("query")[0].getAttribute("node"),i={xmlns:Strophe.NS.DISCO_INFO},r,t;for(u&&(i.node=u),r=this._buildIQResult(n,i),t=0;t<this._identities.length;t++)i={category:this._identities[t].category,type:this._identities[t].type},this._identities[t].name&&(i.name=this._identities[t].name),this._identities[t].lang&&(i["xml:lang"]=this._identities[t].lang),r.c("identity",i).up();for(t=0;t<this._features.length;t++)r.c("feature",{"var":this._features[t]}).up();return this._connection.send(r.tree()),!0},_onDiscoItems:function(n){var e={xmlns:Strophe.NS.DISCO_ITEMS},u=n.getElementsByTagName("query")[0].getAttribute("node"),i,f,t,r;if(u){for(e.node=u,i=[],t=0;t<this._items.length;t++)if(this._items[t].node==u){i=this._items[t].call_back(n);break}}else i=this._items;for(f=this._buildIQResult(n,e),t=0;t<i.length;t++)r={jid:i[t].jid},i[t].name&&(r.name=i[t].name),i[t].node&&(r.node=i[t].node),f.c("item",r).up();return this._connection.send(f.tree()),!0}});Strophe.addConnectionPlugin("caps",{HASH:"sha-1",node:"http://strophe.im/strophejs/",_ver:"",_connection:null,_knownCapabilities:{},_jidVerIndex:{},init:function(n){if(this._connection=n,Strophe.addNamespace("CAPS","http://jabber.org/protocol/caps"),!this._connection.disco)throw"Caps plugin requires the disco plugin to be installed.";this._connection.disco.addFeature(Strophe.NS.CAPS);this._connection.addHandler(this._delegateCapabilities.bind(this),Strophe.NS.CAPS)},generateCapsAttrs:function(){return{xmlns:Strophe.NS.CAPS,hash:this.HASH,node:this.node,ver:this.generateVer()}},generateVer:function(){var t,n;if(this._ver!=="")return this._ver;var i="",r=this._connection.disco._identities.sort(this._sortIdentities),f=r.length,u=this._connection.disco._features.sort(),e=u.length;for(n=0;n<f;n++)t=r[n],i+=t.category+"/"+t.type+"/"+t.lang+"/"+t.name+"<";for(n=0;n<e;n++)i+=u[n]+"<";return this._ver=b64_sha1(i),this._ver},getCapabilitiesByJid:function(n){return this._jidVerIndex[n]?this._knownCapabilities[this._jidVerIndex[n]]:null},_delegateCapabilities:function(n){var t=n.getAttribute("from"),r=n.querySelector("c"),i=r.getAttribute("ver"),u=r.getAttribute("node");if(this._knownCapabilities[i])this._jidVerIndex[t]=i;else return this._requestCapabilities(t,u,i);return this._jidVerIndex[t]&&!this._jidVerIndex[t]===i||(this._jidVerIndex[t]=i),!0},_requestCapabilities:function(n,t,i){if(n!==this._connection.jid){var r=this._connection.disco.info(n,t+"#"+i);this._connection.addHandler(this._handleDiscoInfoReply.bind(this),Strophe.NS.DISCO_INFO,"iq","result",r,n)}return!0},_handleDiscoInfoReply:function(n){var e=n.querySelector("query"),i=e.getAttribute("node").split("#"),t=i[1],r=n.getAttribute("from"),f,o,u;if(this._knownCapabilities[t])this._jidVerIndex[r]&&!this._jidVerIndex[r]===t||(this._jidVerIndex[r]=t);else{for(f=e.childNodes,o=f.length,this._knownCapabilities[t]=[],u=0;u<o;u++)i=f[u],this._knownCapabilities[t].push({name:i.nodeName,attributes:i.attributes});this._jidVerIndex[r]=t}return!1},_sortIdentities:function(n,t){return n.category>t.category?1:n.category<t.category?-1:n.type>t.type?1:n.type<t.type?-1:n.lang>t.lang?1:n.lang<t.lang?-1:0}});Mustache=function(){var n=function(){};return n.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},context:{},render:function(n,t,i,r){if(r||(this.context=t,this.buffer=[]),!this.includes("",n)){if(r)return n;this.send(n);return}n=this.render_pragmas(n);var u=this.render_section(n,t,i);if(r)return this.render_tags(u,t,i,r);this.render_tags(u,t,i,r)},send:function(n){n!==""&&this.buffer.push(n)},render_pragmas:function(n){if(!this.includes("%",n))return n;var t=this,i=new RegExp(this.otag+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+this.ctag,"g");return n.replace(i,function(n,i,r){if(!t.pragmas_implemented[i])throw{message:"This implementation of mustache doesn't understand the '"+i+"' pragma"};if(t.pragmas[i]={},r){var u=r.split("=");t.pragmas[i][u[0]]=u[1]}return""})},render_partial:function(n,t,i){if(n=this.trim(n),!i||i[n]===undefined)throw{message:"unknown_partial '"+n+"'"};return typeof t[n]!="object"?this.render(i[n],t,i,!0):this.render(i[n],t[n],i,!0)},render_section:function(n,t,i){if(!this.includes("#",n)&&!this.includes("^",n))return n;var r=this,u=new RegExp(this.otag+"(\\^|\\#)\\s*(.+)\\s*"+this.ctag+"\n*([\\s\\S]+?)"+this.otag+"\\/\\s*\\2\\s*"+this.ctag+"\\s*","mg");return n.replace(u,function(n,u,f,e){var o=r.find(f,t);return u=="^"?!o||r.is_array(o)&&o.length===0?r.render(e,t,i,!0):"":u=="#"?r.is_array(o)?r.map(o,function(n){return r.render(e,r.create_context(n),i,!0)}).join(""):r.is_object(o)?r.render(e,r.create_context(o),i,!0):typeof o=="function"?o.call(t,e,function(n){return r.render(n,t,i,!0)}):o?r.render(e,t,i,!0):"":void 0})},render_tags:function(n,t,i,r){for(var u=this,o=function(){return new RegExp(u.otag+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+u.ctag+"+","g")},s=o(),h=function(n,r,f){switch(r){case"!":return"";case"=":return u.set_delimiters(f),s=o(),"";case">":return u.render_partial(f,t,i);case"{":return u.find(f,t);default:return u.escape(u.find(f,t))}},f=n.split("\n"),e=0;e<f.length;e++)f[e]=f[e].replace(s,h,this),r||this.send(f[e]);if(r)return f.join("\n")},set_delimiters:function(n){var t=n.split(" ");this.otag=this.escape_regex(t[0]);this.ctag=this.escape_regex(t[1])},escape_regex:function(n){if(!arguments.callee.sRE)arguments.callee.sRE=new RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g");return n.replace(arguments.callee.sRE,"\\$1")},find:function(n,t){function r(n){return n===!1||n===0||n}n=this.trim(n);var i;return(r(t[n])?i=t[n]:r(this.context[n])&&(i=this.context[n]),typeof i=="function")?i.apply(t):i!==undefined?i:""},includes:function(n,t){return t.indexOf(this.otag+n)!=-1},escape:function(n){return n=String(n===null?"":n),n.replace(/&(?!\w+;)|["'<>\\]/g,function(n){switch(n){case"&":return"&amp;";case"\\":return"\\\\";case'"':return"&quot;";case"'":return"&#39;";case"<":return"&lt;";case">":return"&gt;";default:return n}})},create_context:function(n){var t,i;return this.is_object(n)?n:(t=".",this.pragmas["IMPLICIT-ITERATOR"]&&(t=this.pragmas["IMPLICIT-ITERATOR"].iterator),i={},i[t]=n,i)},is_object:function(n){return n&&typeof n=="object"},is_array:function(n){return Object.prototype.toString.call(n)==="[object Array]"},trim:function(n){return n.replace(/^\s*|\s*$/g,"")},map:function(n,t){var r,u,i;if(typeof n.map=="function")return n.map(t);for(r=[],u=n.length,i=0;i<u;i++)r.push(t(n[i]));return r}},{name:"mustache.js",version:"0.3.1-dev",to_html:function(t,i,r,u){var f=new n;return u&&(f.send=u),f.render(t,i,r),u?void 0:f.buffer.join("\n")}}}(),function(n){var i=Array.prototype.slice,t={dict:null,load:function(t){this.dict!==null?n.extend(this.dict,t):this.dict=t},_:function(n){var t=this.dict,r;return t&&t.hasOwnProperty(n)&&(n=t[n]),r=i.call(arguments),r[0]=n,this.printf.apply(this,r)},printf:function(t,r){return arguments.length<2?t:(r=n.isArray(r)?r:i.call(arguments,1),t.replace(/([^%]|^)%(?:(\d+)\$)?s/g,function(n,t,i){return i?t+r[parseInt(i)-1]:t+r.shift()}).replace(/%%s/g,"%s"))}};n.fn._t=function(){return n(this).html(t._.apply(t,arguments))};n.i18n=t}(jQuery);dateFormat=function(){var t=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,i=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,r=/[^-+\dA-Z]/g,n=function(n,t){for(n=String(n),t=t||2;n.length<t;)n="0"+n;return n};return function(u,f,e){var h=dateFormat;if(arguments.length!=1||Object.prototype.toString.call(u)!="[object String]"||/\d/.test(u)||(f=u,u=undefined),u=u?new Date(u):new Date,isNaN(u))throw SyntaxError("invalid date");f=String(h.masks[f]||f||h.masks["default"]);f.slice(0,4)=="UTC:"&&(f=f.slice(4),e=!0);var o=e?"getUTC":"get",c=u[o+"Date"](),y=u[o+"Day"](),l=u[o+"Month"](),p=u[o+"FullYear"](),s=u[o+"Hours"](),w=u[o+"Minutes"](),b=u[o+"Seconds"](),a=u[o+"Milliseconds"](),v=e?0:u.getTimezoneOffset(),k={d:c,dd:n(c),ddd:h.i18n.dayNames[y],dddd:h.i18n.dayNames[y+7],m:l+1,mm:n(l+1),mmm:h.i18n.monthNames[l],mmmm:h.i18n.monthNames[l+12],yy:String(p).slice(2),yyyy:p,h:s%12||12,hh:n(s%12||12),H:s,HH:n(s),M:w,MM:n(w),s:b,ss:n(b),l:n(a,3),L:n(a>99?Math.round(a/10):a),t:s<12?"a":"p",tt:s<12?"am":"pm",T:s<12?"A":"P",TT:s<12?"AM":"PM",Z:e?"UTC":(String(u).match(i)||[""]).pop().replace(r,""),o:(v>0?"-":"+")+n(Math.floor(Math.abs(v)/60)*100+Math.abs(v)%60,4),S:["th","st","nd","rd"][c%10>3?0:(c%100-c%10!=10)*c%10]};return f.replace(t,function(n){return n in k?k[n]:n.slice(1,n.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(n,t){return dateFormat(this,n,t)};Candy=function(n,t){return n.about={name:"Candy",version:"1.9.9/ifm"},n.init=function(i,r){r.viewClass||(r.viewClass=n.View);r.viewClass.init(t("#candy"),r.view);n.Core.init(i,r.core)},n}(Candy||{},jQuery);Candy.Core=function(n,t,i){var r=null,h=null,f=null,o={},s=!1,c,u={autojoin:undefined,disconnectWithoutTabs:!0,debug:!1,disableWindowUnload:!1,presencePriority:1,resource:Candy.about.name},e=function(n,i){t.addNamespace(n,i)},a=function(){e("PRIVATE","jabber:iq:private");e("BOOKMARKS","storage:bookmarks");e("PRIVACY","jabber:iq:privacy");e("DELAY","jabber:x:delay");e("PUBSUB","http://jabber.org/protocol/pubsub")},l=function(n){var i=t.getNodeFromJid(n),r=t.getDomainFromJid(n);return i?t.escapeNode(i)+"@"+r:r};return n.init=function(f,e){h=f;i.extend(!0,u,e);u.debug&&(n.debug=function(){if(u.debug==="verbose"){var n=[];n.push("[Candy]");n.push("[Debug]");try{Array.prototype.push.apply(n,arguments);console.debug.apply(console,n)}catch(t){}}},n.log=function(){var n=[];n.push("[Candy]");n.push("[Info]");try{Array.prototype.push.apply(n,arguments);console.log.apply(console,n)}catch(t){}},t.log=function(n,i){var r,f;switch(n){case t.LogLevel.DEBUG:if(u.debug!=="verbose")return;r="Debug";f="debug";break;case t.LogLevel.INFO:r="Info";f="log";break;case t.LogLevel.WARN:r="WARN";f="warn";break;case t.LogLevel.ERROR:r="ERROR";f="error";break;case t.LogLevel.FATAL:r="FATAL";f="error"}try{console[f]("[Strophe]","["+r+"]",i)}catch(e){}},n.log("[Init] Debugging enabled"));a();r=new t.Connection(h);r.rawInput=n.rawInput.bind(n);r.rawOutput=n.rawOutput.bind(n);r.caps.node="https://candy-chat.github.io/candy/";u.disableWindowUnload||(window.onbeforeunload=n.onWindowUnload)},n.registerEventHandlers=function(){n.addHandler(n.Event.Jabber.Version,t.NS.VERSION,"iq");n.addHandler(n.Event.Jabber.Presence,null,"presence");n.addHandler(n.Event.Jabber.Message,null,"message");n.addHandler(n.Event.Jabber.Bookmarks,t.NS.PRIVATE,"iq");n.addHandler(n.Event.Jabber.Room.Disco,t.NS.DISCO_INFO,"iq","result");n.addHandler(r.disco._onDiscoInfo.bind(r.disco),t.NS.DISCO_INFO,"iq","get");n.addHandler(r.disco._onDiscoItems.bind(r.disco),t.NS.DISCO_ITEMS,"iq","get")},n.connect=function(e,o,h){r.reset();n.registerEventHandlers();i(Candy).triggerHandler("candy:core.before-connect",{connection:r});s=s?!0:e&&e.indexOf("@")<0;e&&o?(r.connect(l(e)+"/"+u.resource,o,Candy.Core.Event.Strophe.Connect),f=h?new n.ChatUser(e,h):new n.ChatUser(e,t.getNodeFromJid(e))):e&&h?(r.connect(l(e)+"/"+u.resource,null,Candy.Core.Event.Strophe.Connect),f=new n.ChatUser(null,h)):e?Candy.Core.Event.Login(e):Candy.Core.Event.Login()},n.attach=function(i,u,e){f=new n.ChatUser(i,t.getNodeFromJid(i));n.registerEventHandlers();r.attach(i,u,e,Candy.Core.Event.Strophe.Connect)},n.disconnect=function(){r.connected&&(i.each(n.getRooms(),function(){Candy.Core.Action.Jabber.Room.Leave(this.getJid())}),r.disconnect())},n.addHandler=function(n,t,i,u,f,e,o){return r.addHandler(n,t,i,u,f,e,o)},n.getUser=function(){return f},n.setUser=function(n){f=n},n.getConnection=function(){return r},n.removeRoom=function(n){delete o[n]},n.getRooms=function(){return o},n.getStropheStatus=function(){return c},n.setStropheStatus=function(n){c=n},n.isAnonymousConnection=function(){return s},n.getOptions=function(){return u},n.getRoom=function(n){return o[n]?o[n]:null},n.onWindowUnload=function(){r.options.sync=!0;n.disconnect();r.flush()},n.rawInput=function(n){this.debug("RECV: "+n)},n.rawOutput=function(n){this.debug("SENT: "+n)},n.log=function(){},n.debug=function(){},n}(Candy.Core||{},Strophe,jQuery);Candy.View=function(n,t){var i={container:null,roomJid:null},r={language:"en",assets:"res/",messages:{limit:2e3,remove:500},crop:{message:{nickname:15,body:1e3},roster:{nickname:15}},enableXHTML:!1},u=function(i){t.i18n.load(n.Translation[i])},f=function(){t(Candy).on("candy:core.chat.connection",n.Observer.Chat.Connection);t(Candy).on("candy:core.chat.message",n.Observer.Chat.Message);t(Candy).on("candy:core.login",n.Observer.Login);t(Candy).on("candy:core.autojoin-missing",n.Observer.AutojoinMissing);t(Candy).on("candy:core.presence",n.Observer.Presence.update);t(Candy).on("candy:core.presence.leave",n.Observer.Presence.update);t(Candy).on("candy:core.presence.room",n.Observer.Presence.update);t(Candy).on("candy:core.presence.error",n.Observer.PresenceError);t(Candy).on("candy:core.message",n.Observer.Message)},e=function(){Candy.Util.getIeVersion()<9?t(document).focusin(Candy.View.Pane.Window.onFocus).focusout(Candy.View.Pane.Window.onBlur):t(window).focus(Candy.View.Pane.Window.onFocus).blur(Candy.View.Pane.Window.onBlur);t(window).resize(Candy.View.Pane.Chat.fitTabs)},o=function(){n.Pane.Chat.Toolbar.init()},s=function(){t("body").delegate("li[data-tooltip]","mouseenter",Candy.View.Pane.Chat.Tooltip.show)};return n.init=function(n,h){h.resources&&(h.assets=h.resources,delete h.resources);t.extend(!0,r,h);u(r.language);Candy.Util.Parser.setEmoticonPath("img/emoticons/");i.container=n;i.container.html(Mustache.to_html(Candy.View.Template.Chat.pane,{tooltipEmoticons:t.i18n._("tooltipEmoticons"),tooltipSound:t.i18n._("tooltipSound"),tooltipAutoscroll:t.i18n._("tooltipAutoscroll"),tooltipStatusmessage:t.i18n._("tooltipStatusmessage"),tooltipAdministration:t.i18n._("tooltipAdministration"),tooltipUsercount:t.i18n._("tooltipUsercount")},{tabs:Candy.View.Template.Chat.tabs,rooms:Candy.View.Template.Chat.rooms,modal:Candy.View.Template.Chat.modal,toolbar:Candy.View.Template.Chat.toolbar}));e();o();f();s()},n.getCurrent=function(){return i},n.getOptions=function(){return r},n}(Candy.View||{},jQuery);Candy.Util=function(n,t){n.jidToId=function(n){return MD5.hexdigest(n)};n.escapeJid=function(n){var i=Strophe.escapeNode(Strophe.getNodeFromJid(n)),r=Strophe.getDomainFromJid(n),t=Strophe.getResourceFromJid(n);return n=i+"@"+r,t&&(n+="/"+t),n};n.unescapeJid=function(n){var i=Strophe.unescapeNode(Strophe.getNodeFromJid(n)),r=Strophe.getDomainFromJid(n),t=Strophe.getResourceFromJid(n);return n=i+"@"+r,t&&(n+="/"+t),n};n.crop=function(n,t){return n.length>t&&(n=n.substr(0,t-3)+"..."),n};n.getDisplayName=function(n){var t=Strophe.unescapeNode(n);return t.lastIndexOf("_")>0?t.substring(0,t.lastIndexOf("_")):t};n.parseAndCropXhtml=function(i,r){return t("<div/>").append(n.createHtml(t(i).get(0),r)).html()};n.setCookie=function(n,t,i){var r=new Date;r.setDate(r.getDate()+i);document.cookie=n+"="+t+";expires="+r.toUTCString()+";path=/"};n.cookieExists=function(n){return document.cookie.indexOf(n)>-1};n.getCookie=function(n){if(document.cookie){var i=new RegExp(escape(n)+"=([^;]*)","gm"),t=i.exec(document.cookie);if(t)return t[1]}};n.deleteCookie=function(n){document.cookie=n+"=;expires=Thu, 01-Jan-70 00:00:01 GMT;path=/"};n.getPosLeftAccordingToWindowBounds=function(n,i){var f=t(document).width(),r=n.outerWidth(),e=r-n.outerWidth(!0),u="left",o=t(document).find("#candy").length>0?t("#candy").offset().left:0;return i+r>=f&&(i-=r-e,u="right"),{px:i-o,backgroundPositionAlignment:u}};n.getPosTopAccordingToWindowBounds=function(n,i){var f=t(document).height(),r=n.outerHeight(),e=r-n.outerHeight(!0),u="top",o=t(document).find("#candy").length>0?t("#candy").offset().top:0;return i+r>=f&&(i-=r-e,u="bottom"),{px:i-o,backgroundPositionAlignment:u}};n.localizedTime=function(i){if(i===undefined)return undefined;var r=n.iso8601toDate(i);return r.toDateString()===(new Date).toDateString()?r.format(t.i18n._("timeFormat")):r.format(t.i18n._("dateFormat"))};n.iso8601toDate=function(n){var r=Date.parse(n),t,i;if(isNaN(r)){if(t=/^(\d{4}|[+\-]\d{6})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?))?/.exec(n),t)return i=0,t[8]!=="Z"&&(i=+t[10]*60+ +t[11],t[9]==="+"&&(i=-i)),i-=(new Date).getTimezoneOffset(),new Date(+t[1],+t[2]-1,+t[3],+t[4],+t[5]+i,+t[6],t[7]?+t[7].substr(0,3):0);r=Date.parse(n.replace(/^(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")+"Z")}return new Date(r)};n.isEmptyObject=function(n){for(var t in n)if(n.hasOwnProperty(t))return!1;return!0};n.forceRedraw=function(n){n.css({display:"none"});setTimeout(function(){this.css({display:"block"})}.bind(n),1)};var i=function(){for(var i,n=3,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+ ++n+"]><i><\/i><![endif]-->",r[0];);return n>4?n:i}();return n.getIeVersion=function(){return i},n.Parser={_emoticonPath:"",setEmoticonPath:function(n){Candy.View.getOptions().assets&&(this._emoticonPath=Candy.View.getOptions().assets+n)},emoticons:[{plain:":)",regex:/((\s):-?\)|:-?\)(\s|$))/gm,image:"Smiling.png"},{plain:";)",regex:/((\s);-?\)|;-?\)(\s|$))/gm,image:"Winking.png"},{plain:":D",regex:/((\s):-?D|:-?D(\s|$))/gm,image:"Grinning.png"},{plain:"XD",regex:/((\s)XD|XD(\s|$))/gm,image:"Laughing.png"},{plain:":(",regex:/((\s):-?\(|:-?\((\s|$))/gm,image:"Unhappy.png"},{plain:"^^",regex:/((\s)\^\^|\^\^(\s|$))/gm,image:"Happy.png"},{plain:":P",regex:/((\s):-?P|:-?P(\s|$))/gim,image:"Tease.png"},{plain:";P",regex:/((\s);-?P|;-?P(\s|$))/gim,image:"Tongue_Out_Winking.png"},{plain:":S",regex:/((\s):-?S|:-?S(\s|$))/gim,image:"Confused.png"},{plain:":/",regex:/((\s):-?\/|:-?\/(\s|$))/gm,image:"Uncertain.png"},{plain:"8)",regex:/((\s)8-?\)|8-?\)(\s|$))/gm,image:"Cool.png"},{plain:":OK:",regex:/((\s):OK:|:OK:(\s|$))/gm,image:"Thumb_Up.png"},{plain:"oO",regex:/((\s)oO|oO(\s|$))/gm,image:"Huh.png"},{plain:":x",regex:/((\s):x|:x(\s|$))/gm,image:"Lips_Sealed.png"},{plain:":666:",regex:/((\s):666:|:666:(\s|$))/gm,image:"Devil.png"},{plain:"<3",regex:/((\s)&lt;3|&lt;3(\s|$))/gm,image:"Heart.png"}],emotify:function(n){if(!Candy.View.getOptions().assets)return n;for(var t=this.emoticons.length-1;t>=0;t--)n=n.replace(this.emoticons[t].regex,'$2<img class="emoticon" alt="$1" src="'+this._emoticonPath+this.emoticons[t].image+'" />$3');return n},linkify:function(n){return n=n.replace(/(^|[^\/])(www\.[^\.]+\.[\S]+(\b|$))/gi,"$1http://$2"),n.replace(/(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/gi,'<a href="$1" target="_blank">$1<\/a>')},escape:function(n){return t("<div/>").text(n).html()},nl2br:function(n){return n.replace(/\r\n|\r|\n/g,"<br />")},all:function(n){return n&&(n=this.escape(n),n=this.linkify(n),n=this.emotify(n),n=this.nl2br(n)),n}},n.createHtml=function(i,r,u){var f,o,l,c,h,e,a,v,y,p,w,s;if(u=u||0,i.nodeType===Strophe.ElementType.NORMAL)if(c=i.nodeName.toLowerCase(),Strophe.XHTML.validTag(c))try{for(o=t("<"+c+"/>"),f=0;f<Strophe.XHTML.attributes[c].length;f++)if(h=Strophe.XHTML.attributes[c][f],e=i.getAttribute(h),typeof e!="undefined"&&e!==null&&e!==""&&e!==!1&&e!==0)if(h==="style"&&typeof e=="object"&&typeof e.cssText!="undefined"&&(e=e.cssText),h==="style"){for(a=[],v=e.split(";"),l=0;l<v.length;l++)y=v[l].split(":"),p=y[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),Strophe.XHTML.validCSS(p)&&(w=y[1].replace(/^\s*/,"").replace(/\s*$/,""),a.push(p+": "+w));a.length>0&&(e=a.join("; "),o.attr(h,e))}else o.attr(h,e);for(f=0;f<i.childNodes.length;f++)o.append(n.createHtml(i.childNodes[f],r,u))}catch(b){Candy.Core.log("[Util:createHtml] Error while parsing XHTML:");Candy.Core.log(b);o=Strophe.xmlTextNode("")}else for(o=Strophe.xmlGenerator().createDocumentFragment(),f=0;f<i.childNodes.length;f++)o.appendChild(n.createHtml(i.childNodes[f],r,u));else if(i.nodeType===Strophe.ElementType.FRAGMENT)for(o=Strophe.xmlGenerator().createDocumentFragment(),f=0;f<i.childNodes.length;f++)o.appendChild(n.createHtml(i.childNodes[f],r,u));else i.nodeType===Strophe.ElementType.TEXT&&(s=i.nodeValue,u+=s.length,r&&u>r&&(s=s.substring(0,r)),s=Candy.Util.Parser.all(s),o=t.parseHTML(s));return o},n}(Candy.Util||{},jQuery);Candy.Core.Action=function(n,t,i){return n.Jabber={Version:function(n){Candy.Core.getConnection().sendIQ($iq({type:"result",to:Candy.Util.escapeJid(n.attr("from")),from:Candy.Util.escapeJid(n.attr("to")),id:n.attr("id")}).c("query",{name:Candy.about.name,version:Candy.about.version,os:navigator.userAgent}))},SetNickname:function(n,t){t=t instanceof Array?t:Candy.Core.getRooms();var r,u,f=Candy.Core.getConnection();i.each(t,function(t){r=Candy.Util.escapeJid(t+"/"+n);u=$pres({to:r,from:f.jid,id:"pres:"+f.getUniqueId()});Candy.Core.getConnection().send(u)})},Roster:function(){Candy.Core.getConnection().sendIQ($iq({type:"get",xmlns:t.NS.CLIENT}).c("query",{xmlns:t.NS.ROSTER}).tree())},Presence:function(n,t){var i=Candy.Core.getConnection(),r;n=n||{};n.id||(n.id="pres:"+i.getUniqueId());r=$pres(n).c("priority").t(Candy.Core.getOptions().presencePriority.toString()).up().c("c",i.caps.generateCapsAttrs()).up();t&&r.node.appendChild(t.node);i.send(r.tree())},Services:function(){Candy.Core.getConnection().sendIQ($iq({type:"get",xmlns:t.NS.CLIENT}).c("query",{xmlns:t.NS.DISCO_ITEMS}).tree())},Autojoin:function(){if(Candy.Core.getOptions().autojoin===!0){Candy.Core.getConnection().sendIQ($iq({type:"get",xmlns:t.NS.CLIENT}).c("query",{xmlns:t.NS.PRIVATE}).c("storage",{xmlns:t.NS.BOOKMARKS}).tree());var r=Candy.Core.getConnection().getUniqueId("pubsub");Candy.Core.addHandler(Candy.Core.Event.Jabber.Bookmarks,t.NS.PUBSUB,"iq","result",r);Candy.Core.getConnection().sendIQ($iq({type:"get",id:r}).c("pubsub",{xmlns:t.NS.PUBSUB}).c("items",{node:t.NS.BOOKMARKS}).tree())}else i.isArray(Candy.Core.getOptions().autojoin)?i.each(Candy.Core.getOptions().autojoin,function(){n.Jabber.Room.Join.apply(null,this.valueOf().split(":",2))}):i(Candy).triggerHandler("candy:core.autojoin-missing")},ResetIgnoreList:function(){Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:t.NS.PRIVACY}).c("list",{name:"ignore"}).c("item",{action:"allow",order:"0"}).tree())},RemoveIgnoreList:function(){Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:t.NS.PRIVACY}).c("list",{name:"ignore"}).tree())},GetIgnoreList:function(){var n=$iq({type:"get",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:t.NS.PRIVACY}).c("list",{name:"ignore"}).tree(),i=Candy.Core.getConnection().sendIQ(n);Candy.Core.addHandler(Candy.Core.Event.Jabber.PrivacyList,null,"iq",null,i)},SetIgnoreListActive:function(){Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:t.NS.PRIVACY}).c("active",{name:"ignore"}).tree())},GetJidIfAnonymous:function(){Candy.Core.getUser().getJid()||(Candy.Core.log("[Jabber] Anonymous login"),Candy.Core.getUser().data.jid=Candy.Core.getConnection().jid)},Room:{Join:function(i,r){n.Jabber.Room.Disco(i);i=Candy.Util.escapeJid(i);var u=Candy.Core.getConnection(),e=i+"/"+Candy.Core.getUser().getNick(),f=$pres({to:e,id:"pres:"+u.getUniqueId()}).c("x",{xmlns:t.NS.MUC});r&&f.c("password").t(r);f.up().c("c",u.caps.generateCapsAttrs());u.send(f.tree())},Leave:function(n){var i=Candy.Core.getRoom(n),t;i&&(t=i.getUser(),t&&(n=Candy.Util.escapeJid(n),Candy.Core.getConnection().muc.leave(n,t.getNick(),function(){})))},Disco:function(n){Candy.Core.getConnection().sendIQ($iq({type:"get",from:Candy.Core.getUser().getEscapedJid(),to:Candy.Util.escapeJid(n)}).c("query",{xmlns:t.NS.DISCO_INFO}).tree())},Message:function(n,r,u,f){if(r=i.trim(r),r==="")return!1;var e=null;return u==="chat"&&(e=t.getResourceFromJid(n),n=t.getBareJidFromJid(n)),Candy.Core.getConnection().muc.message(n,e,r,f,u),!0},Invite:function(n,r,u,f){u=i.trim(u);var o=$msg({to:n}),e=o.c("x",{xmlns:t.NS.MUC_USER});i.each(r,function(n,i){i=t.getBareJidFromJid(i);e.c("invite",{to:i});typeof u!="undefined"&&u!==""&&e.c("reason",u)});typeof f!="undefined"&&f!==""&&e.c("password",f);Candy.Core.getConnection().send(o)},IgnoreUnignore:function(n){Candy.Core.getUser().addToOrRemoveFromPrivacyList("ignore",n);Candy.Core.Action.Jabber.Room.UpdatePrivacyList()},UpdatePrivacyList:function(){var t=Candy.Core.getUser(),n=$iq({type:"set",from:t.getEscapedJid()}).c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"ignore"}),r=t.getPrivacyList("ignore");r.length>0?i.each(r,function(t,i){n.c("item",{type:"jid",value:Candy.Util.escapeJid(i),action:"deny",order:t}).c("message").up().up()}):n.c("item",{action:"allow",order:"0"});Candy.Core.getConnection().sendIQ(n.tree())},Admin:{UserAction:function(n,i,r,u){n=Candy.Util.escapeJid(n);i=Candy.Util.escapeJid(i);var f={nick:t.getResourceFromJid(i)};switch(r){case"kick":f.role="none";break;case"ban":f.affiliation="outcast";break;default:return!1}return Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid(),to:n}).c("query",{xmlns:t.NS.MUC_ADMIN}).c("item",f).c("reason").t(u).tree()),!0},SetSubject:function(n,t){Candy.Core.getConnection().muc.setTopic(Candy.Util.escapeJid(n),t)}}}},n}(Candy.Core.Action||{},Strophe,jQuery);Candy.Core.ChatRoom=function(n){this.room={jid:n,name:Strophe.getNodeFromJid(n)};this.user=null;this.roster=new Candy.Core.ChatRoster;this.setUser=function(n){this.user=n};this.getUser=function(){return this.user};this.getJid=function(){return this.room.jid};this.setName=function(n){this.room.name=n};this.getName=function(){return this.room.name};this.setRoster=function(n){this.roster=n};this.getRoster=function(){return this.roster}};Candy.Core.ChatRoster=function(){this.items={};this.add=function(n){this.items[n.getJid()]=n};this.remove=function(n){delete this.items[n]};this.get=function(n){return this.items[n]};this.getAll=function(){return this.items}};Candy.Core.ChatUser=function(n,t,i,r){this.ROLE_MODERATOR="moderator";this.AFFILIATION_OWNER="owner";this.data={jid:n,nick:Strophe.unescapeNode(t),affiliation:i,role:r,privacyLists:{},customData:{},previousNick:undefined};this.getJid=function(){if(this.data.jid)return Candy.Util.unescapeJid(this.data.jid)};this.getEscapedJid=function(){return Candy.Util.escapeJid(this.data.jid)};this.setJid=function(n){this.data.jid=n};this.getNick=function(n){var t=Strophe.unescapeNode(this.data.nick);return n&&t.lastIndexOf("_")>0?t.substring(0,t.lastIndexOf("_")):t};this.setNick=function(n){this.data.nick=n};this.getRole=function(){return this.data.role};this.setRole=function(n){this.data.role=n};this.setAffiliation=function(n){this.data.affiliation=n};this.getAffiliation=function(){return this.data.affiliation};this.isModerator=function(){return this.getRole()===this.ROLE_MODERATOR||this.getAffiliation()===this.AFFILIATION_OWNER};this.addToOrRemoveFromPrivacyList=function(n,t){this.data.privacyLists[n]||(this.data.privacyLists[n]=[]);var i=-1;return(i=this.data.privacyLists[n].indexOf(t))!==-1?this.data.privacyLists[n].splice(i,1):this.data.privacyLists[n].push(t),this.data.privacyLists[n]};this.getPrivacyList=function(n){return this.data.privacyLists[n]||(this.data.privacyLists[n]=[]),this.data.privacyLists[n]};this.setPrivacyLists=function(n){this.data.privacyLists=n};this.isInPrivacyList=function(n,t){return this.data.privacyLists[n]?this.data.privacyLists[n].indexOf(t)!==-1:!1};this.setCustomData=function(n){this.data.customData=n};this.getCustomData=function(){return this.data.customData};this.setPreviousNick=function(n){this.data.previousNick=n};this.getPreviousNick=function(){return this.data.previousNick}};Candy.Core.Event=function(n,t,i){return n.Login=function(n){i(Candy).triggerHandler("candy:core.login",{presetJid:n})},n.Strophe={Connect:function(n){Candy.Core.setStropheStatus(n);switch(n){case t.Status.CONNECTED:Candy.Core.log("[Connection] Connected");Candy.Core.Action.Jabber.GetJidIfAnonymous();case t.Status.ATTACHED:Candy.Core.log("[Connection] Attached");Candy.Core.Action.Jabber.Presence();Candy.Core.Action.Jabber.Autojoin();Candy.Core.Action.Jabber.GetIgnoreList();break;case t.Status.DISCONNECTED:Candy.Core.log("[Connection] Disconnected");break;case t.Status.AUTHFAIL:Candy.Core.log("[Connection] Authentication failed");break;case t.Status.CONNECTING:Candy.Core.log("[Connection] Connecting");break;case t.Status.DISCONNECTING:Candy.Core.log("[Connection] Disconnecting");break;case t.Status.AUTHENTICATING:Candy.Core.log("[Connection] Authenticating");break;case t.Status.ERROR:case t.Status.CONNFAIL:Candy.Core.log("[Connection] Failed ("+n+")");break;default:Candy.Core.log("[Connection] What?!")}i(Candy).triggerHandler("candy:core.chat.connection",{status:n})}},n.Jabber={Version:function(n){return Candy.Core.log("[Jabber] Version"),Candy.Core.Action.Jabber.Version(i(n)),!0},Presence:function(r){return Candy.Core.log("[Jabber] Presence"),r=i(r),r.children('x[xmlns^="'+t.NS.MUC+'"]').length>0?r.attr("type")==="error"?n.Jabber.Room.PresenceError(r):n.Jabber.Room.Presence(r):i(Candy).triggerHandler("candy:core.presence",{from:r.attr("from"),stanza:r}),!0},Bookmarks:function(n){return Candy.Core.log("[Jabber] Bookmarks"),i("conference",n).each(function(){var n=i(this);n.attr("autojoin")&&Candy.Core.Action.Jabber.Room.Join(n.attr("jid"))}),!0},PrivacyList:function(t){Candy.Core.log("[Jabber] PrivacyList");var r=Candy.Core.getUser();return(t=i(t),t.attr("type")==="result")?(i('list[name="ignore"] item',t).each(function(){var n=i(this);n.attr("action")==="deny"&&r.addToOrRemoveFromPrivacyList("ignore",n.attr("value"))}),Candy.Core.Action.Jabber.SetIgnoreListActive(),!1):n.Jabber.PrivacyListError(t)},PrivacyListError:function(n){return i('error[code="503"][type="cancel"] service-unavailable',n)?!1:(Candy.Core.log("[Jabber] PrivacyListError"),i('error[code="404"][type="cancel"] item-not-found',n)&&(Candy.Core.Action.Jabber.ResetIgnoreList(),Candy.Core.Action.Jabber.SetIgnoreListActive()),!1)},Message:function(r){var o,e;Candy.Core.log("[Jabber] Message");r=i(r);var f=r.attr("from"),u=r.attr("type")||"undefined",s=r.attr("to");if(u==="normal"||u==="undefined"){if(o=r.find("invite"),e=r.find('x[xmlns="jabber:x:conference"]'),o.length>0){var h=r.find("password"),c=null,l=o.find("continue"),a=null;h&&(c=h.text());l&&(a=l.attr("thread"));i(Candy).triggerHandler("candy:core:chat:invite",{roomJid:f,from:o.attr("from")||"undefined",reason:o.find("reason")||"",password:c,continuedThread:a,inviteType:"MediatedInvite"})}return e.length>0&&i(Candy).triggerHandler("candy:core:chat:invite",{roomJid:e.attr("jid"),from:f,reason:e.attr("reason")||"",password:e.attr("password"),continuedThread:e.attr("thread"),inviteType:"DirectInvite"}),i(Candy).triggerHandler("candy:core:chat:message:normal",{type:u||"normal",message:r}),!0}return u!=="groupchat"&&u!=="chat"&&u!=="error"&&u!=="headline"?(i(Candy).triggerHandler("candy:core:chat:message:other",{type:u,message:r}),!0):(f!==t.getDomainFromJid(f)&&(u==="groupchat"||u==="chat"||u==="error")?n.Jabber.Room.Message(r):s||f!==t.getDomainFromJid(f)?s&&f===t.getDomainFromJid(f)&&i(Candy).triggerHandler("candy:core.chat.message.server",{type:u||"message",subject:r.children("subject").text(),message:r.children("body").text()}):i(Candy).triggerHandler("candy:core.chat.message.admin",{type:u||"message",message:r.children("body").text()}),!0)},Room:{Leave:function(n){var f,r,o,c;if(Candy.Core.log("[Jabber:Room] Leave"),n=i(n),f=Candy.Util.unescapeJid(n.attr("from")),r=t.getBareJidFromJid(f),!Candy.Core.getRoom(r))return!0;var l=Candy.Core.getRoom(r).getName(),u=n.find("item"),e="leave",s,h;return delete Candy.Core.getRooms()[r],u.attr("role")==="none"&&(o=n.find("status").attr("code"),o==="307"?e="kick":o==="301"&&(e="ban"),s=u.find("reason").text(),h=u.find("actor").attr("jid")),c=new Candy.Core.ChatUser(f,t.getResourceFromJid(f),u.attr("affiliation"),u.attr("role")),i(Candy).triggerHandler("candy:core.presence.leave",{roomJid:r,roomName:l,type:e,reason:s,actor:h,user:c}),!0},Disco:function(n){var r,u,e,f;return(Candy.Core.log("[Jabber:Room] Disco"),n=i(n),!n.find('identity[category="conference"]').length)?!0:(r=t.getBareJidFromJid(Candy.Util.unescapeJid(n.attr("from"))),Candy.Core.getRooms()[r]||(Candy.Core.getRooms()[r]=new Candy.Core.ChatRoom(r)),u=n.find("identity"),u.length&&(e=u.attr("name"),f=Candy.Core.getRoom(r),f.getName()===null&&f.setName(t.unescapeNode(e))),!0)},Presence:function(r){var a,d,g,w,e,v,o,s,u,c,h,nt,tt;Candy.Core.log("[Jabber:Room] Presence");var f=Candy.Util.unescapeJid(r.attr("from")),l=t.getBareJidFromJid(f),b=r.attr("type"),y=r.find("status"),k=!1,p=!1;if(y.length)for(a=0,d=y.length;a<d;a++)g=i(y[a]),w=g.attr("code"),w==="303"?p=!0:w==="210"&&(k=!0);return(e=Candy.Core.getRoom(l),e||(Candy.Core.getRooms()[l]=new Candy.Core.ChatRoom(l),e=Candy.Core.getRoom(l)),v=e.getUser()?e.getUser():Candy.Core.getUser(),t.getResourceFromJid(f)===v.getNick()&&b==="unavailable"&&p===!1)?(n.Jabber.Room.Leave(r),!0):(o=e.getRoster(),h=r.find("item"),b!=="unavailable"?o.get(f)?(u=o.get(f),nt=h.attr("role"),tt=h.attr("affiliation"),u.setRole(nt),u.setAffiliation(tt),s="join"):(c=t.getResourceFromJid(f),u=new Candy.Core.ChatUser(f,c,h.attr("affiliation"),h.attr("role")),e.getUser()===null&&(Candy.Core.getUser().getNick()===c||k)&&(e.setUser(u),v=u),o.add(u),s="join"):(u=o.get(f),o.remove(f),p?(c=h.attr("nick"),s="nickchange",u.setPreviousNick(u.getNick()),u.setNick(c),u.setJid(t.getBareJidFromJid(f)+"/"+c),o.add(u)):(s="leave",h.attr("role")==="none"&&(r.find("status").attr("code")==="307"?s="kick":r.find("status").attr("code")==="301"&&(s="ban")))),i(Candy).triggerHandler("candy:core.presence.room",{roomJid:l,roomName:e.getName(),user:u,action:s,currentUser:v}),!0)},PresenceError:function(n){Candy.Core.log("[Jabber:Room] Presence Error");var f=Candy.Util.unescapeJid(n.attr("from")),r=t.getBareJidFromJid(f),u=Candy.Core.getRooms()[r],e=u&&u.getName()||null;return Candy.Core.removeRoom(r),u=undefined,i(Candy).triggerHandler("candy:core.presence.error",{msg:n,type:n.children("error").children()[0].tagName.toLowerCase(),roomJid:r,roomName:e}),!0},Message:function(n){var r,u,o,c,p,l,s,h,f,a,w,v,e,y,b;if(Candy.Core.log("[Jabber:Room] Message"),n.children("subject").length>0&&n.children("subject").text().length>0&&n.attr("type")==="groupchat")r=Candy.Util.unescapeJid(t.getBareJidFromJid(n.attr("from"))),u={name:t.getNodeFromJid(r),body:n.children("subject").text(),type:"subject"};else if(n.attr("type")==="error")c=n.children("error"),c.children("text").length>0&&(r=n.attr("from"),u={type:"info",body:c.children("text").text()});else if(n.children("body").length>0){if(n.attr("type")==="chat"||n.attr("type")==="normal")r=Candy.Util.unescapeJid(n.attr("from")),p=t.getBareJidFromJid(r),l=!Candy.Core.getRoom(p),o=l?t.getNodeFromJid(r):t.getResourceFromJid(r),u={name:o,body:n.children("body").text(),type:n.attr("type"),isNoConferenceRoomJid:l};else if(r=Candy.Util.unescapeJid(t.getBareJidFromJid(n.attr("from"))),s=t.getResourceFromJid(n.attr("from")),s)s=t.unescapeNode(s),u={name:s,body:n.children("body").text(),type:n.attr("type")};else{if(!Candy.View.Pane.Chat.rooms[n.attr("from")])return!0;u={name:"",body:n.children("body").text(),type:"info"}}for(h=[],f=0;f<n[0].attributes.length;f++)h.push(n[0].attributes[f]);for(u.attributes={},f=0;f<h.length;f++)u.attributes[h[f].name]=h[f].value;a=n.children('html[xmlns="'+t.NS.XHTML_IM+'"]');Candy.View.getOptions().enableXHTML===!0&&a.length>0&&(w=a.children('body[xmlns="'+t.NS.XHTML+'"]').first().html(),u.xhtmlMessage=w)}else return n.children("composing").length>0||n.children("inactive").length>0||n.children("paused").length>0||n.children("gone").length>0?(v=Candy.Util.unescapeJid(n.attr("from")),r=t.getBareJidFromJid(v),o=t.getResourceFromJid(v),n.children("active").length>0?e="active":n.children("composing").length>0?e="composing":n.children("paused").length>0?e="paused":n.children("inactive").length>0?e="inactive":n.children("gone").length>0&&(e="gone"),i(Candy).triggerHandler("candy:core.message.chatstate",{name:o,displayName:Candy.Util.getDisplayName(o),roomJid:r,chatstate:e}),!0):!0;return y=n.children("delay")?n.children("delay"):n.children('x[xmlns="'+t.NS.DELAY+'"]'),b=y!==undefined?y.attr("stamp"):null,i(Candy).triggerHandler("candy:core.message",{roomJid:r,message:u,timestamp:b}),!0}}},n}(Candy.Core.Event||{},Strophe,jQuery);Candy.View.Observer=function(n,t){var i=!0;return n.Chat={Connection:function(n,r){var f="candy:view.connection.status-"+r.status,u;if(t(Candy).triggerHandler(f)===!1)return!1;switch(r.status){case Strophe.Status.CONNECTING:case Strophe.Status.AUTHENTICATING:Candy.View.Pane.Chat.Modal.show(t.i18n._("statusConnecting"),!1,!0);break;case Strophe.Status.ATTACHED:case Strophe.Status.CONNECTED:i===!0&&(Candy.View.Pane.Chat.Modal.show(t.i18n._("statusConnected")),Candy.View.Pane.Chat.Modal.hide());break;case Strophe.Status.DISCONNECTING:Candy.View.Pane.Chat.Modal.show(t.i18n._("statusDisconnecting"),!1,!0);break;case Strophe.Status.DISCONNECTED:u=Candy.Core.isAnonymousConnection()?Strophe.getDomainFromJid(Candy.Core.getUser().getJid()):null;Candy.View.Pane.Chat.Modal.showLoginForm(t.i18n._("statusDisconnected"),u);break;case Strophe.Status.AUTHFAIL:Candy.View.Pane.Chat.Modal.showLoginForm(t.i18n._("statusAuthfail"));break;default:Candy.View.Pane.Chat.Modal.show(t.i18n._("status",r.status))}},Message:function(n,t){if(t.type==="message")Candy.View.Pane.Chat.adminMessage(t.subject||"",t.message);else if(t.type==="chat"||t.type==="groupchat")Candy.View.Pane.Chat.onInfoMessage(Candy.View.getCurrent().roomJid,t.subject||"",t.message)}},n.Presence={update:function(n,i){if(i.type==="leave"||i.type==="kick"||i.type==="ban"){var r={type:i.type,reason:i.reason,roomJid:i.roomJid,user:i.user};t(Candy).triggerHandler("candy:view.presence",[r])}else if(i.roomJid){if(!i.user)return!1;if(i.roomJid=Candy.Util.unescapeJid(i.roomJid),!Candy.View.Pane.Chat.rooms[i.roomJid]){if(Candy.View.Pane.Room.init(i.roomJid,i.roomName)===!1)return!1;t("#chat-rooms").children().length===1&&Candy.View.Pane.Room.show(i.roomJid)}Candy.View.Pane.Roster.update(i.roomJid,i.user,i.action,i.currentUser);Candy.View.Pane.Chat.rooms[i.user.getJid()]&&i.action!=="nickchange"&&(Candy.View.Pane.Roster.update(i.user.getJid(),i.user,i.action,i.currentUser),Candy.View.Pane.PrivateRoom.setStatus(i.user.getJid(),i.action))}},notifyPrivateChats:function(n,t){Candy.Core.log("[View:Observer] notify Private Chats");for(var i in Candy.View.Pane.Chat.rooms)Candy.View.Pane.Chat.rooms.hasOwnProperty(i)&&Candy.View.Pane.Room.getUser(i)&&n.getJid()===Candy.View.Pane.Room.getUser(i).getJid()&&(Candy.View.Pane.Roster.update(i,n,t,n),Candy.View.Pane.PrivateRoom.setStatus(i,t))}},n.PresenceError=function(n,i){switch(i.type){case"not-authorized":var r;i.msg.children("x").children("password").length>0&&(r=t.i18n._("passwordEnteredInvalid",[i.roomName]));Candy.View.Pane.Chat.Modal.showEnterPasswordForm(i.roomJid,i.roomName,r);break;case"conflict":Candy.View.Pane.Chat.Modal.showNicknameConflictForm(i.roomJid);break;case"registration-required":Candy.View.Pane.Chat.Modal.showError("errorMembersOnly",[i.roomName]);break;case"service-unavailable":Candy.View.Pane.Chat.Modal.showError("errorMaxOccupantsReached",[i.roomName])}},n.Message=function(n,t){t.message.type==="subject"?(Candy.View.Pane.Chat.rooms[t.roomJid]||(Candy.View.Pane.Room.init(t.roomJid,t.message.name),Candy.View.Pane.Room.show(t.roomJid)),Candy.View.Pane.Room.setSubject(t.roomJid,t.message.body)):t.message.type==="info"?Candy.View.Pane.Chat.infoMessage(t.roomJid,t.message.body):(t.message.type!=="chat"||Candy.View.Pane.Chat.rooms[t.roomJid]||Candy.View.Pane.PrivateRoom.open(t.roomJid,t.message.name,!1,t.message.isNoConferenceRoomJid),Candy.View.Pane.Message.show(t.roomJid,t.message.name,t.message.body,t.message.xhtmlMessage,t.timestamp,t.message.attributes))},n.Login=function(n,t){Candy.View.Pane.Chat.Modal.showLoginForm(null,t.presetJid)},n.AutojoinMissing=function(){i=!1;Candy.View.Pane.Chat.Modal.showError("errorAutojoinMissing")},n}(Candy.View.Observer||{},jQuery);Candy.View.Pane=function(n,t){return n.Window={_hasFocus:!0,_plainTitle:document.title,_unreadMessagesCount:0,autoscroll:!0,hasFocus:function(){return n.Window._hasFocus},increaseUnreadMessages:function(){n.Window.renderUnreadMessages(++n.Window._unreadMessagesCount)},reduceUnreadMessages:function(t){n.Window._unreadMessagesCount-=t;n.Window._unreadMessagesCount<=0?n.Window.clearUnreadMessages():n.Window.renderUnreadMessages(n.Window._unreadMessagesCount)},clearUnreadMessages:function(){n.Window._unreadMessagesCount=0;document.title=n.Window._plainTitle},renderUnreadMessages:function(t){document.title=Candy.View.Template.Window.unreadmessages.replace("{{count}}",t).replace("{{title}}",n.Window._plainTitle)},onFocus:function(){n.Window._hasFocus=!0;Candy.View.getCurrent().roomJid&&(n.Room.setFocusToForm(Candy.View.getCurrent().roomJid),n.Chat.clearUnreadMessages(Candy.View.getCurrent().roomJid))},onBlur:function(){n.Window._hasFocus=!1}},n.Chat={rooms:[],addTab:function(i,r,u){var e=Candy.Util.jidToId(i),o=Mustache.to_html(Candy.View.Template.Chat.tab,{roomJid:i,roomId:e,name:r||Strophe.getNodeFromJid(i),privateUserChat:function(){return u==="chat"},roomType:u}),f=t(o).appendTo("#chat-tabs");f.click(n.Chat.tabClick);t("a.close",f).click(n.Chat.tabClose);n.Chat.fitTabs()},getTab:function(n){return t("#chat-tabs").children('li[data-roomjid="'+n+'"]')},removeTab:function(t){n.Chat.getTab(t).remove();n.Chat.fitTabs()},setActiveTab:function(n){t("#chat-tabs").children().each(function(){var i=t(this);i.attr("data-roomjid")===n?i.addClass("active"):i.removeClass("active")})},increaseUnreadMessages:function(t){var i=this.getTab(t).find(".unread");i.show().text(i.text()!==""?parseInt(i.text(),10)+1:1);n.Chat.rooms[t].type==="chat"&&n.Window.increaseUnreadMessages()},clearUnreadMessages:function(t){var i=n.Chat.getTab(t).find(".unread");n.Window.reduceUnreadMessages(i.text());i.hide().text("")},tabClick:function(i){var r=Candy.View.getCurrent().roomJid;n.Chat.rooms[r].scrollPosition=n.Room.getPane(r,".message-pane-wrapper").scrollTop();n.Room.show(t(this).attr("data-roomjid"));i.preventDefault()},tabClose:function(){var i=t(this).parent().attr("data-roomjid");return n.Chat.rooms[i].type==="chat"?n.Room.close(i):Candy.Core.Action.Jabber.Room.Leave(i),!1},allTabsClosed:function(){n.Chat.Toolbar.hide();Candy.Core.getOptions().disconnectWithoutTabs&&Candy.Core.disconnect()},fitTabs:function(){var i=t("#chat-tabs").innerWidth(),r=0,n=t("#chat-tabs").children(),u,f;n.each(function(){r+=t(this).css({width:"auto",overflow:"visible"}).outerWidth(!0)});r>i&&(u=n.outerWidth(!0)-n.width(),f=Math.floor(i/n.length)-u,n.css({width:f,overflow:"hidden"}))},adminMessage:function(i,r){if(Candy.View.getCurrent().roomJid){var u=Mustache.to_html(Candy.View.Template.Chat.adminMessage,{subject:i,message:r,sender:t.i18n._("administratorMessageSubject"),time:Candy.Util.localizedTime((new Date).toGMTString())});t("#chat-rooms").children().each(function(){n.Room.appendToMessagePane(t(this).attr("data-roomjid"),u)});n.Room.scrollToBottom(Candy.View.getCurrent().roomJid);t(Candy).triggerHandler("candy:view.chat.admin-message",{subject:i,message:r})}},infoMessage:function(t,i,r){n.Chat.onInfoMessage(t,i,r)},onInfoMessage:function(i,r,u){if(Candy.View.Pane.Room.getPane(i)){var f=Mustache.to_html(Candy.View.Template.Chat.infoMessage,{subject:r,message:t.i18n._(u),time:Candy.Util.localizedTime((new Date).toGMTString())});n.Room.appendToMessagePane(i,f);Candy.View.getCurrent().roomJid===i&&n.Room.scrollToBottom(Candy.View.getCurrent().roomJid)}},Toolbar:{_supportsNativeAudio:null,init:function(){t("#emoticons-icon").click(function(t){n.Chat.Context.showEmoticonsMenu(t.currentTarget);t.stopPropagation()});t("#chat-autoscroll-control").click(n.Chat.Toolbar.onAutoscrollControlClick);try{if(!!document.createElement("audio").canPlayType){var i=document.createElement("audio");i.canPlayType("audio/mpeg;").replace(/no/,"")?n.Chat.Toolbar._supportsNativeAudio="mp3":i.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")?n.Chat.Toolbar._supportsNativeAudio="ogg":!i.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,"")||(n.Chat.Toolbar._supportsNativeAudio="m4a")}}catch(r){Candy.Core.log("[View:Pane:Toolbar] init error:");Candy.Core.log(r)}t("#chat-sound-control").click(n.Chat.Toolbar.onSoundControlClick);Candy.Util.cookieExists("candy-nosound")&&t("#chat-sound-control").click();t("#chat-statusmessage-control").click(n.Chat.Toolbar.onStatusMessageControlClick);Candy.Util.cookieExists("candy-nostatusmessages")&&t("#chat-statusmessage-control").click()},show:function(){t("#chat-toolbar").show()},hide:function(){t("#chat-toolbar").hide()},update:function(i){var r=t("#chat-toolbar").find(".context"),u=n.Room.getUser(i);u&&u.isModerator()?r.show().click(function(t){n.Chat.Context.show(t.currentTarget,i);t.stopPropagation()}):r.hide();n.Chat.Toolbar.updateUsercount(n.Chat.rooms[i].usercount)},playSound:function(t){n.Chat.Toolbar.onPlaySound(t)},onPlaySound:function(i){if(Candy.View.getOptions().assets){var r=i||"new_message";try{n.Chat.Toolbar._supportsNativeAudio!==null?new Audio(Candy.View.getOptions().assets+"sfx/"+r+"."+n.Chat.Toolbar._supportsNativeAudio).play():(t("#chat-sound-control bgsound").remove(),t("<bgsound/>").attr({src:Candy.View.getOptions().assets+"sfx/"+r+".mp3",loop:1,autostart:!0}).appendTo("#chat-sound-control"))}catch(u){Candy.Core.log("[View:Pane:Toolbar] onPlaySound error:");Candy.Core.log(u)}}},onSoundControlClick:function(){var i=t("#chat-sound-control");i.hasClass("checked")?(n.Chat.Toolbar.playSound=function(){},Candy.Util.setCookie("candy-nosound","1",365)):(n.Chat.Toolbar.playSound=function(t){n.Chat.Toolbar.onPlaySound(t)},Candy.Util.deleteCookie("candy-nosound"),n.Chat.Toolbar.playSound("toggle_on"));i.toggleClass("checked")},onAutoscrollControlClick:function(){var i=t("#chat-autoscroll-control");i.hasClass("checked")?(n.Room.scrollToBottom=function(t){n.Room.onScrollToStoredPosition(t)},n.Window.autoscroll=!1):(n.Room.scrollToBottom=function(t){n.Room.onScrollToBottom(t)},n.Room.scrollToBottom(Candy.View.getCurrent().roomJid),n.Window.autoscroll=!0);i.toggleClass("checked")},onStatusMessageControlClick:function(){var i=t("#chat-statusmessage-control");i.hasClass("checked")?(n.Chat.infoMessage=function(){},Candy.Util.setCookie("candy-nostatusmessages","1",365)):(n.Chat.infoMessage=function(t,i,r){n.Chat.onInfoMessage(t,i,r)},Candy.Util.deleteCookie("candy-nostatusmessages"));i.toggleClass("checked")},updateUsercount:function(n){t("#chat-usercount").text(n)}},Modal:{show:function(i,r,u){r?n.Chat.Modal.showCloseControl():n.Chat.Modal.hideCloseControl();u?n.Chat.Modal.showSpinner():n.Chat.Modal.hideSpinner();t("#chat-modal").stop(!1,!0);t("#chat-modal-body").html(i);t("#chat-modal").fadeIn("fast");t("#chat-modal-overlay").show()},hide:function(n){t("#chat-modal").fadeOut("fast",function(){t("#chat-modal-body").text("");t("#chat-modal-overlay").hide()});t(document).keydown(function(n){n.which===27&&n.preventDefault()});n&&n()},showSpinner:function(){t("#chat-modal-spinner").show()},hideSpinner:function(){t("#chat-modal-spinner").hide()},showCloseControl:function(){t("#admin-message-cancel").show().click(function(t){n.Chat.Modal.hide();t.preventDefault()});t(document).keydown(function(t){t.which===27&&(n.Chat.Modal.hide(),t.preventDefault())})},hideCloseControl:function(){t("#admin-message-cancel").hide().click(function(){})},showLoginForm:function(i,r){n.Chat.Modal.show((i?i:"")+Mustache.to_html(Candy.View.Template.Login.form,{_labelNickname:t.i18n._("labelNickname"),_labelUsername:t.i18n._("labelUsername"),_labelPassword:t.i18n._("labelPassword"),_loginSubmit:t.i18n._("loginSubmit"),displayPassword:!Candy.Core.isAnonymousConnection(),displayUsername:!r,displayNickname:Candy.Core.isAnonymousConnection(),presetJid:r?r:!1}));t("#login-form").children(":input:first").focus();t("#login-form").submit(function(){var n=t("#username").val(),u=t("#password").val(),i;return Candy.Core.isAnonymousConnection()?Candy.Core.connect(r,null,n):(i=Candy.Core.getUser()&&n.indexOf("@")<0?n+"@"+Strophe.getDomainFromJid(Candy.Core.getUser().getJid()):n,i.indexOf("@")<0&&!Candy.Core.getUser()?Candy.View.Pane.Chat.Modal.showLoginForm(t.i18n._("loginInvalid")):Candy.Core.connect(i,u)),!1})},showEnterPasswordForm:function(i,r,u){n.Chat.Modal.show(Mustache.to_html(Candy.View.Template.PresenceError.enterPasswordForm,{roomName:r,_labelPassword:t.i18n._("labelPassword"),_label:u?u:t.i18n._("enterRoomPassword",[r]),_joinSubmit:t.i18n._("enterRoomPasswordSubmit")}),!0);t("#password").focus();t("#enter-password-form").submit(function(){var r=t("#password").val();return n.Chat.Modal.hide(function(){Candy.Core.Action.Jabber.Room.Join(i,r)}),!1})},showNicknameConflictForm:function(i){n.Chat.Modal.show(Mustache.to_html(Candy.View.Template.PresenceError.nicknameConflictForm,{_labelNickname:t.i18n._("labelNickname"),_label:t.i18n._("nicknameConflict"),_loginSubmit:t.i18n._("loginSubmit")}));t("#nickname").focus();t("#nickname-conflict-form").submit(function(){var r=t("#nickname").val();return n.Chat.Modal.hide(function(){Candy.Core.getUser().data.nick=r;Candy.Core.Action.Jabber.Room.Join(i)}),!1})},showError:function(i,r){n.Chat.Modal.show(Mustache.to_html(Candy.View.Template.PresenceError.displayError,{_error:t.i18n._(i,r)}),!0)}},Tooltip:{show:function(n,i){var r=t("#tooltip"),u=t(n.currentTarget),f;i||(i=u.attr("data-tooltip"));r.length===0&&(f=Mustache.to_html(Candy.View.Template.Chat.tooltip),t("#chat-pane").append(f),r=t("#tooltip"));t("#context-menu").hide();r.stop(!1,!0);r.children("div").html(i);var e=u.offset(),o=Candy.Util.getPosLeftAccordingToWindowBounds(r,e.left),s=Candy.Util.getPosTopAccordingToWindowBounds(r,e.top);r.css({left:o.px,top:s.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(o.backgroundPositionAlignment+"-"+s.backgroundPositionAlignment).fadeIn("fast");u.mouseleave(function(n){n.stopPropagation();t("#tooltip").stop(!1,!0).fadeOut("fast",function(){t(this).css({top:0,left:0})})})}},Context:{init:function(){if(t("#context-menu").length===0){var n=Mustache.to_html(Candy.View.Template.Chat.Context.menu);t("#chat-pane").append(n);t("#context-menu").mouseleave(function(){t(this).fadeOut("fast")})}},show:function(i,r,u){var o,e,h,s,c;i=t(i);var y=n.Chat.rooms[r].id,f=t("#context-menu"),p=t("ul li",f);t("#tooltip").hide();u||(u=Candy.Core.getUser());p.remove();o=this.getMenuLinks(r,u,i);h=function(n,i){return function(r){r.data.callback(r,n,i);t("#context-menu").hide()}};for(e in o)o.hasOwnProperty(e)&&(s=o[e],c=Mustache.to_html(Candy.View.Template.Chat.Context.menulinks,{roomId:y,"class":s["class"],id:e,label:s.label}),t("ul",f).append(c),t("#context-menu-"+e).bind("click",s,h(r,u)));if(e){var l=i.offset(),a=Candy.Util.getPosLeftAccordingToWindowBounds(f,l.left),v=Candy.Util.getPosTopAccordingToWindowBounds(f,l.top);return f.css({left:a.px,top:v.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(a.backgroundPositionAlignment+"-"+v.backgroundPositionAlignment).fadeIn("fast"),t(Candy).triggerHandler("candy:view.roster.after-context-menu",{roomJid:r,user:u,element:f}),!0}},getMenuLinks:function(i,r,u){var f,e,o={roomJid:i,user:r,elem:u,menulinks:this.initialMenuLinks(u)};t(Candy).triggerHandler("candy:view.roster.context-menu",o);f=o.menulinks;for(e in f)f.hasOwnProperty(e)&&f[e].requiredPermission!==undefined&&!f[e].requiredPermission(r,n.Room.getUser(i),u)&&delete f[e];return f},initialMenuLinks:function(){return{"private":{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&Candy.Core.getRoom(Candy.View.getCurrent().roomJid)&&!Candy.Core.getUser().isInPrivacyList("ignore",n.getJid())},"class":"private",label:t.i18n._("privateActionLabel"),callback:function(n,i,r){t("#user-"+Candy.Util.jidToId(i)+"-"+Candy.Util.jidToId(r.getJid())).click()}},ignore:{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&!Candy.Core.getUser().isInPrivacyList("ignore",n.getJid())},"class":"ignore",label:t.i18n._("ignoreActionLabel"),callback:function(n,t,i){Candy.View.Pane.Room.ignoreUser(t,i.getJid())}},unignore:{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&Candy.Core.getUser().isInPrivacyList("ignore",n.getJid())},"class":"unignore",label:t.i18n._("unignoreActionLabel"),callback:function(n,t,i){Candy.View.Pane.Room.unignoreUser(t,i.getJid())}},kick:{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&t.isModerator()&&!n.isModerator()},"class":"kick",label:t.i18n._("kickActionLabel"),callback:function(i,r,u){n.Chat.Modal.show(Mustache.to_html(Candy.View.Template.Chat.Context.contextModalForm,{_label:t.i18n._("reason"),_submit:t.i18n._("kickActionLabel")}),!0);t("#context-modal-field").focus();t("#context-modal-form").submit(function(){return Candy.Core.Action.Jabber.Room.Admin.UserAction(r,u.getJid(),"kick",t("#context-modal-field").val()),n.Chat.Modal.hide(),!1})}},ban:{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&t.isModerator()&&!n.isModerator()},"class":"ban",label:t.i18n._("banActionLabel"),callback:function(i,r,u){n.Chat.Modal.show(Mustache.to_html(Candy.View.Template.Chat.Context.contextModalForm,{_label:t.i18n._("reason"),_submit:t.i18n._("banActionLabel")}),!0);t("#context-modal-field").focus();t("#context-modal-form").submit(function(){return Candy.Core.Action.Jabber.Room.Admin.UserAction(r,u.getJid(),"ban",t("#context-modal-field").val()),n.Chat.Modal.hide(),!1})}},subject:{requiredPermission:function(n,t){return t.getNick()===n.getNick()&&t.isModerator()},"class":"subject",label:t.i18n._("setSubjectActionLabel"),callback:function(i,r){n.Chat.Modal.show(Mustache.to_html(Candy.View.Template.Chat.Context.contextModalForm,{_label:t.i18n._("subject"),_submit:t.i18n._("setSubjectActionLabel")}),!0);t("#context-modal-field").focus();t("#context-modal-form").submit(function(i){Candy.Core.Action.Jabber.Room.Admin.SetSubject(r,t("#context-modal-field").val());n.Chat.Modal.hide();i.preventDefault()})}}}},showEmoticonsMenu:function(n){var f,e;n=t(n);var o=n.offset(),r=t("#context-menu"),s=t("ul",r),u="",i;for(t("#tooltip").hide(),i=Candy.Util.Parser.emoticons.length-1;i>=0;i--)u='<img src="'+Candy.Util.Parser._emoticonPath+Candy.Util.Parser.emoticons[i].image+'" alt="'+Candy.Util.Parser.emoticons[i].plain+'" />'+u;return s.html('<li class="emoticons">'+u+"<\/li>"),s.find("img").click(function(){var n=Candy.View.Pane.Room.getPane(Candy.View.getCurrent().roomJid,".message-form").children(".field"),i=n.val(),r=t(this).attr("alt")+" ";n.val(i?i+" "+r:r).focus()}),f=Candy.Util.getPosLeftAccordingToWindowBounds(r,o.left),e=Candy.Util.getPosTopAccordingToWindowBounds(r,o.top),r.css({left:f.px,top:e.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(f.backgroundPositionAlignment+"-"+e.backgroundPositionAlignment).fadeIn("fast"),!0}}},n.Room={init:function(i,r,u){var f,e;return(u=u||"groupchat",i=Candy.Util.unescapeJid(i),f={roomJid:i,type:u},t(Candy).triggerHandler("candy:view.room.before-add",f)===!1)?!1:(Candy.Util.isEmptyObject(n.Chat.rooms)&&n.Chat.Toolbar.show(),e=Candy.Util.jidToId(i),n.Chat.rooms[i]={id:e,usercount:0,name:r,type:u,messageCount:0,scrollPosition:-1},t("#chat-rooms").append(Mustache.to_html(Candy.View.Template.Room.pane,{roomId:e,roomJid:i,roomType:u,form:{_messageSubmit:t.i18n._("messageSubmit")},roster:{_userOnline:t.i18n._("userOnline")}},{roster:Candy.View.Template.Roster.pane,messages:Mustache.to_html(Candy.View.Template.Message.pane,{},{header:Candy.View.Template.Message.header}),form:Candy.View.Template.Room.form})),n.Chat.addTab(i,r,u),n.Room.getPane(i,".message-form").submit(n.Message.submit),f.element=n.Room.getPane(i),t(Candy).triggerHandler("candy:view.room.after-add",f),n.Chat.Toolbar.playSound("new_chat"),e)},show:function(i){var u=n.Chat.rooms[i].id,r;t(".room-pane").each(function(){var f=t(this);r={roomJid:f.attr("data-roomjid"),element:f};f.attr("id")==="chat-room-"+u?(f.show(),Candy.View.getCurrent().roomJid=i,n.Chat.setActiveTab(i),n.Chat.Toolbar.update(i),n.Chat.clearUnreadMessages(i),n.Room.setFocusToForm(i),n.Room.scrollToBottom(i),t(Candy).triggerHandler("candy:view.room.after-show",r)):f.is(":visible")&&(f.hide(),t(Candy).triggerHandler("candy:view.room.after-hide",r))})},setSubject:function(i,r){r=Candy.Util.Parser.linkify(Candy.Util.Parser.escape(r));var u=Mustache.to_html(Candy.View.Template.Room.subject,{subject:r,roomName:n.Chat.rooms[i].name,_roomSubject:t.i18n._("roomSubject"),time:Candy.Util.localizedTime((new Date).toGMTString())});n.Room.appendToMessagePane(i,u);n.Room.scrollToBottom(i);t(Candy).triggerHandler("candy:view.room.after-subject-change",{roomJid:i,element:n.Room.getPane(i),subject:r})},close:function(i){n.Chat.removeTab(i);n.Window.clearUnreadMessages();n.Room.getPane(i).remove();var r=t("#chat-rooms").children();Candy.View.getCurrent().roomJid===i&&(Candy.View.getCurrent().roomJid=null,r.length===0?n.Chat.allTabsClosed():n.Room.show(r.last().attr("data-roomjid")));delete n.Chat.rooms[i];t(Candy).triggerHandler("candy:view.room.after-close",{roomJid:i})},appendToMessagePane:function(t,i){n.Room.getPane(t,".message-pane").append(i);n.Chat.rooms[t].messageCount++;n.Room.sliceMessagePane(t)},sliceMessagePane:function(t){if(n.Window.autoscroll){var i=Candy.View.getOptions().messages;n.Chat.rooms[t].messageCount>i.limit&&(n.Room.getPane(t,".message-pane").children().slice(0,i.remove).remove(),n.Chat.rooms[t].messageCount-=i.remove)}},scrollToBottom:function(t){n.Room.onScrollToBottom(t)},onScrollToBottom:function(t){var i=n.Room.getPane(t,".message-pane-wrapper");i.scrollTop(i.prop("scrollHeight"))},onScrollToStoredPosition:function(t){if(n.Chat.rooms[t].scrollPosition>-1){var i=n.Room.getPane(t,".message-pane-wrapper");i.scrollTop(n.Chat.rooms[t].scrollPosition);n.Chat.rooms[t].scrollPosition=-1}},setFocusToForm:function(t){var i=n.Room.getPane(t,".message-form");if(i)try{i.children(".field")[0].focus()}catch(r){}},setUser:function(i,r){n.Chat.rooms[i].user=r;var f=n.Room.getPane(i),u=t("#chat-pane");f.attr("data-userjid",r.getJid());r.isModerator()?(r.getRole()===r.ROLE_MODERATOR&&u.addClass("role-moderator"),r.getAffiliation()===r.AFFILIATION_OWNER&&u.addClass("affiliation-owner")):u.removeClass("role-moderator affiliation-owner");n.Chat.Context.init()},getUser:function(t){return n.Chat.rooms[t].user},ignoreUser:function(n,t){Candy.Core.Action.Jabber.Room.IgnoreUnignore(t);Candy.View.Pane.Room.addIgnoreIcon(n,t)},unignoreUser:function(n,t){Candy.Core.Action.Jabber.Room.IgnoreUnignore(t);Candy.View.Pane.Room.removeIgnoreIcon(n,t)},addIgnoreIcon:function(n,i){Candy.View.Pane.Chat.rooms[i]&&t("#user-"+Candy.View.Pane.Chat.rooms[i].id+"-"+Candy.Util.jidToId(i)).addClass("status-ignored");Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)]&&t("#user-"+Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)].id+"-"+Candy.Util.jidToId(i)).addClass("status-ignored")},removeIgnoreIcon:function(n,i){Candy.View.Pane.Chat.rooms[i]&&t("#user-"+Candy.View.Pane.Chat.rooms[i].id+"-"+Candy.Util.jidToId(i)).removeClass("status-ignored");Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)]&&t("#user-"+Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)].id+"-"+Candy.Util.jidToId(i)).removeClass("status-ignored")},getPane:function(i,r){if(n.Chat.rooms[i])return r?n.Chat.rooms[i]["pane-"+r]?n.Chat.rooms[i]["pane-"+r]:(n.Chat.rooms[i]["pane-"+r]=t("#chat-room-"+n.Chat.rooms[i].id).find(r),n.Chat.rooms[i]["pane-"+r]):t("#chat-room-"+n.Chat.rooms[i].id)},changeDataUserJidIfUserIsMe:function(n,i){if(i.getNick()===Candy.Core.getUser().getNick()){var r=t("#chat-room-"+n);r.attr("data-userjid",Strophe.getBareJidFromJid(r.attr("data-userjid"))+"/"+i.getNick())}}},n.PrivateRoom={open:function(i,r,u,f){var e=f?Candy.Core.getUser():n.Room.getUser(Strophe.getBareJidFromJid(i)),o={roomJid:i,roomName:r,type:"chat"};if(t(Candy).triggerHandler("candy:view.private-room.before-open",o)===!1||Candy.Core.getUser().isInPrivacyList("ignore",i)||!n.Chat.rooms[i]&&n.Room.init(i,r,"chat")===!1)return!1;u&&n.Room.show(i);n.Roster.update(i,new Candy.Core.ChatUser(i,r),"join",e);n.Roster.update(i,e,"join",e);n.PrivateRoom.setStatus(i,"join");f&&n.Chat.infoMessage(i,t.i18n._("presenceUnknownWarningSubject"),t.i18n._("presenceUnknownWarning"));o.element=n.Room.getPane(i);t(Candy).triggerHandler("candy:view.private-room.after-open",o)},setStatus:function(t,i){var r=n.Room.getPane(t,".message-form");i==="join"?(n.Chat.getTab(t).addClass("online").removeClass("offline"),r.children(".field").removeAttr("disabled"),r.children(".submit").removeAttr("disabled"),n.Chat.getTab(t)):i==="leave"&&(n.Chat.getTab(t).addClass("offline").removeClass("online"),r.children(".field").attr("disabled",!0),r.children(".submit").attr("disabled",!0))},changeNick:function(i,r){Candy.Core.log("[View:Pane:PrivateRoom] changeNick");var e=i+"/"+r.getPreviousNick(),f=i+"/"+r.getNick(),s=Candy.Util.jidToId(e),c=Candy.Util.jidToId(f),o=n.Chat.rooms[e],u,h;n.Chat.rooms[f]&&n.Room.close(f);o?(o.name=r.getNick(!0),o.id=c,n.Chat.rooms[f]=o,delete n.Chat.rooms[e],u=t("#chat-room-"+s),u&&(u.attr("data-roomjid",f),u.attr("id","chat-room-"+c),h=t('#chat-tabs li[data-roomjid="'+e+'"]'),h.attr("data-roomjid",f),h.children("a.label").text("@"+r.getNick(!0)),Candy.View.getCurrent().roomJid===e&&(Candy.View.getCurrent().roomJid=f))):(u=t('.room-pane.roomtype-chat[data-userjid="'+e+'"]'),u.length&&(s=Candy.Util.jidToId(u.attr("data-roomjid")),u.attr("data-userjid",f)));u&&u.length&&n.Roster.changeNick(s,r)}},n.Roster={update:function(i,r,u,f){var h,v,c,y,p;Candy.Core.log("[View:Pane:Roster] "+u);var e=n.Chat.rooms[i].id,o=Candy.Util.jidToId(r.getJid()),s=-1,l=t("#user-"+e+"-"+o),a={roomJid:i,user:r,action:u,element:l};if(t(Candy).triggerHandler("candy:view.roster.before-update",a),u==="join")s=1,h=Mustache.to_html(Candy.View.Template.Roster.user,{roomId:e,userId:o,userJid:r.getJid(),nick:r.getNick(),displayNick:Candy.Util.crop(r.getNick(!0),Candy.View.getOptions().crop.roster.nickname),role:r.getRole(),affiliation:r.getAffiliation(),me:f!==undefined&&r.getNick()===f.getNick(),tooltipRole:t.i18n._("tooltipRole"),tooltipIgnored:t.i18n._("tooltipIgnored")}),l.length<1?(v=!1,c=n.Room.getPane(i,".roster-pane"),c.children().length>0&&(y=r.getNick().toUpperCase(),c.children().each(function(){var n=t(this);return n.attr("data-nick").toUpperCase()>y?(n.before(h),v=!0,!1):!0})),v||c.append(h),n.Roster.showJoinAnimation(r,o,e,i,f),n.Roster.showJoinMessage(r,o,e,i,f)):(s=0,l.replaceWith(h),t("#user-"+e+"-"+o).css({opacity:1}).show(),f!==undefined&&r.getNick()===f.getNick()&&n.Room.getUser(i)&&n.Chat.Toolbar.update(i)),f!==undefined&&f.getNick()===r.getNick()?n.Room.setUser(i,r):t("#user-"+e+"-"+o).click(n.Roster.userClick),t("#user-"+e+"-"+o+" .context").click(function(t){n.Chat.Context.show(t.currentTarget,i,r);t.stopPropagation()}),f!==undefined&&f.isInPrivacyList("ignore",r.getJid())&&Candy.View.Pane.Room.addIgnoreIcon(i,r.getJid());else if(u==="leave"||u==="kick"||u==="ban")if(n.Roster.leaveAnimation("user-"+e+"-"+o),n.Chat.rooms[i].type==="chat")n.Chat.onInfoMessage(i,t.i18n._("userLeftRoom",[r.getNick(!0)]));else n.Chat.infoMessage(i,t.i18n._("userLeftRoom",[r.getNick(!0)]));else if(u==="nickchange"){s=0;n.Roster.changeNick(e,r);n.Room.changeDataUserJidIfUserIsMe(e,r);n.PrivateRoom.changeNick(i,r);p=t.i18n._("userChangedNick",[r.getPreviousNick(),r.getNick(!0)]);n.Chat.onInfoMessage(i,p)}Candy.View.Pane.Chat.rooms[i].usercount+=s;i===Candy.View.getCurrent().roomJid&&Candy.View.Pane.Chat.Toolbar.updateUsercount(Candy.View.Pane.Chat.rooms[i].usercount);a.element=t("#user-"+e+"-"+o);t(Candy).triggerHandler("candy:view.roster.after-update",a)},userClick:function(){var i=t(this);n.PrivateRoom.open(i.attr("data-jid"),i.attr("data-nick"),!0)},showJoinAnimation:function(i,r,u){var f="user-"+u+"-"+r,e=t("#"+f);i.getPreviousNick()&&e&&e.is(":visible")!==!1||n.Roster.joinAnimation(f)},showJoinMessage:function(i,r,u,f,e){if(!i.getPreviousNick()&&e!==undefined&&i.getNick()!==e.getNick()&&!i.isModerator())n.Chat.onInfoMessage(f,t.i18n._("userJoinedRoom",[i.getNick(!0)]))},joinAnimation:function(n){t("#"+n).stop(!0).slideDown("normal",function(){t(this).animate({opacity:1})})},leaveAnimation:function(n){t("#"+n).stop(!0).attr("id","#"+n+"-leaving").animate({opacity:0},{complete:function(){t(this).slideUp("normal",function(){t(this).remove()})}})},changeNick:function(n,i){Candy.Core.log("[View:Pane:Roster] changeNick");var u=Strophe.getBareJidFromJid(i.getJid())+"/"+i.getPreviousNick(),f="user-"+n+"-"+Candy.Util.jidToId(u),r=t("#"+f);r.attr("data-nick",i.getNick());r.attr("data-jid",i.getJid());r.children("div.label").text(i.getNick());r.attr("id","user-"+n+"-"+Candy.Util.jidToId(i.getJid()))}},n.Message={submit:function(i){var r=Candy.View.getCurrent().roomJid,o=Candy.View.Pane.Chat.rooms[r].type,u=t(this).children(".field").val().substring(0,Candy.View.getOptions().crop.message.body),f,e={roomJid:r,message:u,xhtmlMessage:f};if(t(Candy).triggerHandler("candy:view.message.before-send",e)===!1){i.preventDefault();return}u=e.message;f=e.xhtmlMessage;Candy.Core.Action.Jabber.Room.Message(r,u,o,f);o==="chat"&&u&&n.Message.show(r,n.Room.getUser(r).getNick(!0),u);t(this).children(".field").val("").trigger("change").focus();i.preventDefault()},show:function(i,r,u,f,e,o){var a=u,s,c,h,v,l;(u=Candy.Util.Parser.all(u.substring(0,Candy.View.getOptions().crop.message.body)),f&&(f=Candy.Util.parseAndCropXhtml(f,Candy.View.getOptions().crop.message.body)),s={roomJid:i,name:r,rawMessage:a,attributes:o,message:u,xhtmlMessage:f,history:!!e},t(Candy).triggerHandler("candy:view.message.before-show",s)!==!1)&&(u=s.message,f=s.xhtmlMessage,f!==undefined&&f.length>0&&(u=f),u)&&(c=new Date,h={rawMessage:a,attributes:o,template:Candy.View.Template.Message.item,templateData:{name:r,displayName:Candy.Util.getDisplayName(r),croppedDisplayName:Candy.Util.crop(Candy.Util.getDisplayName(r),Candy.View.getOptions().crop.message.nickname),message:u,time:Candy.Util.localizedTime(e||c.toGMTString()),timestamp:e||c.toISOString(),roomJid:i,sender:r===n.Room.getUser(Candy.View.getCurrent().roomJid).getNick()?"sender-is-me":"sender-is-other"},history:s.history},t(Candy).triggerHandler("candy:view.message.before-render",h)!==!1)&&(v=Mustache.to_html(h.template,h.templateData),n.Room.appendToMessagePane(i,v),l=n.Room.getPane(i,".message-pane").children().last(),l.find("a.label").click(function(n){return n.preventDefault(),!1}),Candy.View.getCurrent().roomJid===i&&n.Window.hasFocus()||(n.Chat.increaseUnreadMessages(i),n.Chat.Toolbar.playSound("new_message")),Candy.View.getCurrent().roomJid===i&&n.Room.scrollToBottom(i),s.element=l,t(Candy).triggerHandler("candy:view.message.after-show",s))}},n}(Candy.View.Pane||{},jQuery);Candy.View.Template=function(n){return n.Window={unreadmessages:"({{count}}) {{title}}"},n.Chat={pane:'<div id="chat-pane">{{> tabs}}{{> toolbar}}{{> rooms}}<\/div>{{> modal}}',rooms:'<div id="chat-rooms" class="rooms"><\/div>',tabs:'<ul id="chat-tabs"><\/ul>',tab:'<li class="roomtype-{{roomType}}" data-roomjid="{{roomJid}}" data-roomtype="{{roomType}}"><a href="#" class="label">{{#privateUserChat}}@{{/privateUserChat}}{{name}}<\/a><small class="transfer"><\/small><small class="unread"><\/small><\/li>',modal:'<div id="chat-modal"><a id="admin-message-cancel" class="close" href="#">×<\/a><span id="chat-modal-body"><\/span><span id="chat-modal-spinner-wrapper"><div id="chat-modal-spinner" /><span><\/div><div id="chat-modal-overlay"><\/div>',adminMessage:'<li><small>{{time}}<\/small><div class="adminmessage"><span class="label">{{sender}}<\/span><span class="spacer">▸<\/span><span class="message">{{subject}} {{message}}<\/span><\/div><\/li>',infoMessage:'<li><small>{{time}}<\/small><div class="infomessage"><span class="spacer">•<\/span><span class="message">{{subject}} {{message}}<\/span><\/div><\/li>',stateMessage:'<li name="chat-state-message"><div class="statemessage">{{subject}} {{message}}<\/div><\/li>',toolbar:'<ul id="chat-toolbar"><li id="emoticons-icon" data-tooltip="{{tooltipEmoticons}}"><\/li><li id="chat-sound-control" class="checked" data-tooltip="{{tooltipSound}}"><\/li><li id="chat-autoscroll-control" class="checked" data-tooltip="{{tooltipAutoscroll}}"><\/li><li class="checked" id="chat-statusmessage-control" data-tooltip="{{tooltipStatusmessage}}"><\/li><li class="context" data-tooltip="{{tooltipAdministration}}"><\/li><li class="usercount" data-tooltip="{{tooltipUsercount}}"><span id="chat-usercount"><\/span><\/li><\/ul>',Context:{menu:'<div id="context-menu"><i class="arrow arrow-top"><\/i><ul><\/ul><i class="arrow arrow-bottom"><\/i><\/div>',menulinks:'<li class="{{class}}" id="context-menu-{{id}}">{{label}}<\/li>',contextModalForm:'<form action="#" id="context-modal-form"><label for="context-modal-label">{{_label}}<\/label><input type="text" name="contextModalField" id="context-modal-field" /><input type="submit" class="button" name="send" value="{{_submit}}" /><\/form>',adminMessageReason:'<a id="admin-message-cancel" class="close" href="#">×<\/a><p>{{_action}}<\/p>{{#reason}}<p>{{_reason}}<\/p>{{/reason}}'},tooltip:'<div id="tooltip"><i class="arrow arrow-top"><\/i><div><\/div><i class="arrow arrow-bottom"><\/i><\/div>'},n.Room={pane:'<div class="room-pane roomtype-{{roomType}}" id="chat-room-{{roomId}}" data-roomjid="{{roomJid}}" data-roomtype="{{roomType}}">{{> roster}}{{> messages}}{{> form}}<\/div>',subject:'<li><small>{{time}}<\/small><div class="subject"><span class="label">{{roomName}}<\/span><span class="spacer">▸<\/span>{{_roomSubject}} {{{subject}}}<\/div><\/li>',form:'<div class="message-form-wrapper"><form method="post" class="message-form"><input name="message" class="field" type="text" aria-label="Message Form Text Field" autocomplete="off" maxlength="1000" /><input type="submit" class="submit" name="submit" value="{{_messageSubmit}}" /><\/form><\/div>'},n.Roster={pane:'<div class="roster-pane"><\/div>',user:'<div class="user role-{{role}} affiliation-{{affiliation}}{{#me}} me{{/me}}" id="user-{{roomId}}-{{userId}}" data-jid="{{userJid}}" data-nick="{{nick}}" data-role="{{role}}" data-affiliation="{{affiliation}}"><div class="label">{{displayNick}}<\/div><ul><li class="context" id="context-{{roomId}}-{{userId}}">&#x25BE;<\/li><li class="role role-{{role}} affiliation-{{affiliation}}" data-tooltip="{{tooltipRole}}"><\/li><li class="ignore" data-tooltip="{{tooltipIgnored}}"><\/li><\/ul><\/div>'},n.Message={pane:'{{> header}}<div class="message-pane-wrapper"><ul class="message-pane"><\/ul><\/div>',item:'<li class="{{sender}}"><small>{{time}}<\/small><div><a class="label name" href="#">{{croppedDisplayName}}<\/a><span class="spacer">▸<\/span><span class="message">{{{message}}}<\/span><\/div><\/li>',header:'<div id="header"><\/div>'},n.Login={form:'<form method="post" id="login-form" class="login-form">{{#displayNickname}}<label for="username">{{_labelNickname}}<\/label><input type="text" id="username" name="username"/>{{/displayNickname}}{{#displayUsername}}<label for="username">{{_labelUsername}}<\/label><input type="text" id="username" name="username"/>{{/displayUsername}}{{#presetJid}}<input type="hidden" id="username" name="username" value="{{presetJid}}"/>{{/presetJid}}{{#displayPassword}}<label for="password">{{_labelPassword}}<\/label><input type="password" id="password" name="password" />{{/displayPassword}}<input type="submit" class="button" value="{{_loginSubmit}}" /><\/form>'},n.PresenceError={enterPasswordForm:'<strong>{{_label}}<\/strong><form method="post" id="enter-password-form" class="enter-password-form"><label for="password">{{_labelPassword}}<\/label><input type="password" id="password" name="password" /><input type="submit" class="button" value="{{_joinSubmit}}" /><\/form>',nicknameConflictForm:'<strong>{{_label}}<\/strong><form method="post" id="nickname-conflict-form" class="nickname-conflict-form"><label for="nickname">{{_labelNickname}}<\/label><input type="text" id="nickname" name="nickname" /><input type="submit" class="button" value="{{_loginSubmit}}" /><\/form>',displayError:"<strong>{{_error}}<\/strong>"},n}(Candy.View.Template||{});Candy.View.Translation={en:{status:"Status: %s",statusConnecting:"Connecting...",statusConnected:"Connected",statusDisconnecting:"Disconnecting...",statusDisconnected:"Disconnected",statusAuthfail:"Authentication failed",roomSubject:"Subject:",messageSubmit:"Send",labelUsername:"Username:",labelNickname:"Nickname:",labelPassword:"Password:",loginSubmit:"Login",loginInvalid:"Invalid JID",reason:"Reason:",subject:"Subject:",reasonWas:"Reason was: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"You have been kicked from %2$s by %1$s",youHaveBeenKicked:"You have been kicked from %s",banActionLabel:"Ban",youHaveBeenBannedBy:"You have been banned from %1$s by %2$s",youHaveBeenBanned:"You have been banned from %s",privateActionLabel:"Private chat",ignoreActionLabel:"Ignore",unignoreActionLabel:"Unignore",setSubjectActionLabel:"Change Subject",administratorMessageSubject:"Administrator",userJoinedRoom:"%s joined the room.",userLeftRoom:"%s left the room.",userHasBeenKickedFromRoom:"%s has been kicked from the room.",userHasBeenBannedFromRoom:"%s has been banned from the room.",userChangedNick:"%1$s has changed his nickname to %2$s.",presenceUnknownWarningSubject:"Notice:",presenceUnknownWarning:"This user might be offline. We can't track his presence.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"You ignore this user",tooltipEmoticons:"Emoticons",tooltipSound:"Play sound for new messages",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Display status messages",tooltipAdministration:"Room Administration",tooltipUsercount:"Room Occupants",enterRoomPassword:'Room "%s" is password protected.',enterRoomPasswordSubmit:"Join room",passwordEnteredInvalid:'Invalid password for room "%s".',nicknameConflict:"Username already in use. Please choose another one.",errorMembersOnly:'You can\'t join room "%s": Insufficient rights.',errorMaxOccupantsReached:'You can\'t join room "%s": Too many occupants.',errorAutojoinMissing:"No autojoin parameter set in configuration. Please set one to continue.",antiSpamMessage:"Please do not spam. You have been blocked for a short-time."},de:{status:"Status: %s",statusConnecting:"Verbinden...",statusConnected:"Verbunden",statusDisconnecting:"Verbindung trennen...",statusDisconnected:"Verbindung getrennt",statusAuthfail:"Authentifizierung fehlgeschlagen",roomSubject:"Thema:",messageSubmit:"Senden",labelUsername:"Benutzername:",labelNickname:"Spitzname:",labelPassword:"Passwort:",loginSubmit:"Anmelden",loginInvalid:"Ungültige JID",reason:"Begründung:",subject:"Titel:",reasonWas:"Begründung: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"Du wurdest soeben aus dem Raum %1$s gekickt (%2$s)",youHaveBeenKicked:"Du wurdest soeben aus dem Raum %s gekickt",banActionLabel:"Ban",youHaveBeenBannedBy:"Du wurdest soeben aus dem Raum %1$s verbannt (%2$s)",youHaveBeenBanned:"Du wurdest soeben aus dem Raum %s verbannt",privateActionLabel:"Privater Chat",ignoreActionLabel:"Ignorieren",unignoreActionLabel:"Nicht mehr ignorieren",setSubjectActionLabel:"Thema ändern",administratorMessageSubject:"Administrator",userJoinedRoom:"%s hat soeben den Raum betreten.",userLeftRoom:"%s hat soeben den Raum verlassen.",userHasBeenKickedFromRoom:"%s ist aus dem Raum gekickt worden.",userHasBeenBannedFromRoom:"%s ist aus dem Raum verbannt worden.",userChangedNick:"%1$s hat den Nicknamen zu %2$s geändert.",presenceUnknownWarningSubject:"Hinweis:",presenceUnknownWarning:"Dieser Benutzer könnte bereits abgemeldet sein. Wir können seine Anwesenheit nicht verfolgen.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Du ignorierst diesen Benutzer",tooltipEmoticons:"Smileys",tooltipSound:"Ton abspielen bei neuen Nachrichten",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Statusnachrichten anzeigen",tooltipAdministration:"Raum Administration",tooltipUsercount:"Anzahl Benutzer im Raum",enterRoomPassword:'Raum "%s" ist durch ein Passwort geschützt.',enterRoomPasswordSubmit:"Raum betreten",passwordEnteredInvalid:'Inkorrektes Passwort für Raum "%s".',nicknameConflict:"Der Benutzername wird bereits verwendet. Bitte wähle einen anderen.",errorMembersOnly:'Du kannst den Raum "%s" nicht betreten: Ungenügende Rechte.',errorMaxOccupantsReached:'Du kannst den Raum "%s" nicht betreten: Benutzerlimit erreicht.',errorAutojoinMissing:'Keine "autojoin" Konfiguration gefunden. Bitte setze eine konfiguration um fortzufahren.',antiSpamMessage:"Bitte nicht spammen. Du wurdest für eine kurze Zeit blockiert."},fr:{status:"Status : %s",statusConnecting:"Connexion…",statusConnected:"Connecté.",statusDisconnecting:"Déconnexion…",statusDisconnected:"Déconnecté.",statusAuthfail:"L'authentification a échoué",roomSubject:"Sujet :",messageSubmit:"Envoyer",labelUsername:"Nom d'utilisateur :",labelPassword:"Mot de passe :",loginSubmit:"Connexion",loginInvalid:"JID invalide",reason:"Motif :",subject:"Titre :",reasonWas:"Motif : %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"Vous avez été expulsé du salon %1$s (%2$s)",youHaveBeenKicked:"Vous avez été expulsé du salon %s",banActionLabel:"Ban",youHaveBeenBannedBy:"Vous avez été banni du salon %1$s (%2$s)",youHaveBeenBanned:"Vous avez été banni du salon %s",privateActionLabel:"Chat privé",ignoreActionLabel:"Ignorer",unignoreActionLabel:"Ne plus ignorer",setSubjectActionLabel:"Changer le sujet",administratorMessageSubject:"Administrateur",userJoinedRoom:"%s vient d'entrer dans le salon.",userLeftRoom:"%s vient de quitter le salon.",userHasBeenKickedFromRoom:"%s a été expulsé du salon.",userHasBeenBannedFromRoom:"%s a été banni du salon.",presenceUnknownWarningSubject:"Note :",presenceUnknownWarning:"Cet utilisateur n'est malheureusement plus connecté, le message ne sera pas envoyé.",dateFormat:"dd/mm/yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Modérateur",tooltipIgnored:"Vous ignorez cette personne",tooltipEmoticons:"Smileys",tooltipSound:"Jouer un son lors de la réception de nouveaux messages",tooltipAutoscroll:"Défilement automatique",tooltipStatusmessage:"Messages d'état",tooltipAdministration:"Administration du salon",tooltipUsercount:"Nombre d'utilisateurs dans le salon",enterRoomPassword:'Le salon "%s" est protégé par un mot de passe.',enterRoomPasswordSubmit:"Entrer dans le salon",passwordEnteredInvalid:'Le mot de passe pour le salon "%s" est invalide.',nicknameConflict:"Le nom d'utilisateur est déjà utilisé. Veuillez en choisir un autre.",errorMembersOnly:'Vous ne pouvez pas entrer dans le salon "%s" : droits insuffisants.',errorMaxOccupantsReached:'Vous ne pouvez pas entrer dans le salon "%s": Limite d\'utilisateur atteint.',antiSpamMessage:"Merci de ne pas envoyer de spam. Vous avez été bloqué pendant une courte période.."},nl:{status:"Status: %s",statusConnecting:"Verbinding maken...",statusConnected:"Verbinding is gereed",statusDisconnecting:"Verbinding verbreken...",statusDisconnected:"Verbinding is verbroken",statusAuthfail:"Authenticatie is mislukt",roomSubject:"Onderwerp:",messageSubmit:"Verstuur",labelUsername:"Gebruikersnaam:",labelPassword:"Wachtwoord:",loginSubmit:"Inloggen",loginInvalid:"JID is onjuist",reason:"Reden:",subject:"Onderwerp:",reasonWas:"De reden was: %s.",kickActionLabel:"Verwijderen",youHaveBeenKickedBy:"Je bent verwijderd van %1$s door %2$s",youHaveBeenKicked:"Je bent verwijderd van %s",banActionLabel:"Blokkeren",youHaveBeenBannedBy:"Je bent geblokkeerd van %1$s door %2$s",youHaveBeenBanned:"Je bent geblokkeerd van %s",privateActionLabel:"Prive gesprek",ignoreActionLabel:"Negeren",unignoreActionLabel:"Niet negeren",setSubjectActionLabel:"Onderwerp wijzigen",administratorMessageSubject:"Beheerder",userJoinedRoom:"%s komt de chat binnen.",userLeftRoom:"%s heeft de chat verlaten.",userHasBeenKickedFromRoom:"%s is verwijderd.",userHasBeenBannedFromRoom:"%s is geblokkeerd.",presenceUnknownWarningSubject:"Mededeling:",presenceUnknownWarning:"Deze gebruiker is waarschijnlijk offline, we kunnen zijn/haar aanwezigheid niet vaststellen.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Je negeert deze gebruiker",tooltipEmoticons:"Emotie-iconen",tooltipSound:"Speel een geluid af bij nieuwe berichten.",tooltipAutoscroll:"Automatisch scrollen",tooltipStatusmessage:"Statusberichten weergeven",tooltipAdministration:"Instellingen",tooltipUsercount:"Gebruikers",enterRoomPassword:'De Chatroom "%s" is met een wachtwoord beveiligd.',enterRoomPasswordSubmit:"Ga naar Chatroom",passwordEnteredInvalid:'Het wachtwoord voor de Chatroom "%s" is onjuist.',nicknameConflict:"De gebruikersnaam is reeds in gebruik. Probeer a.u.b. een andere gebruikersnaam.",errorMembersOnly:'Je kunt niet deelnemen aan de Chatroom "%s": Je hebt onvoldoende rechten.',errorMaxOccupantsReached:'Je kunt niet deelnemen aan de Chatroom "%s": Het maximum aantal gebruikers is bereikt.',antiSpamMessage:"Het is niet toegestaan om veel berichten naar de server te versturen. Je bent voor een korte periode geblokkeerd."},es:{status:"Estado: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desconectando...",statusDisconnected:"Desconectado",statusAuthfail:"Falló la autenticación",roomSubject:"Asunto:",messageSubmit:"Enviar",labelUsername:"Usuario:",labelPassword:"Clave:",loginSubmit:"Entrar",loginInvalid:"JID no válido",reason:"Razón:",subject:"Asunto:",reasonWas:"La razón fue: %s.",kickActionLabel:"Expulsar",youHaveBeenKickedBy:"Has sido expulsado de %1$s por %2$s",youHaveBeenKicked:"Has sido expulsado de %s",banActionLabel:"Prohibir",youHaveBeenBannedBy:"Has sido expulsado permanentemente de %1$s por %2$s",youHaveBeenBanned:"Has sido expulsado permanentemente de %s",privateActionLabel:"Chat privado",ignoreActionLabel:"Ignorar",unignoreActionLabel:"No ignorar",setSubjectActionLabel:"Cambiar asunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s se ha unido a la sala.",userLeftRoom:"%s ha dejado la sala.",userHasBeenKickedFromRoom:"%s ha sido expulsado de la sala.",userHasBeenBannedFromRoom:"%s ha sido expulsado permanentemente de la sala.",presenceUnknownWarningSubject:"Atención:",presenceUnknownWarning:"Éste usuario podría estar desconectado..",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Ignoras a éste usuario",tooltipEmoticons:"Emoticonos",tooltipSound:"Reproducir un sonido para nuevos mensajes",tooltipAutoscroll:"Desplazamiento automático",tooltipStatusmessage:"Mostrar mensajes de estado",tooltipAdministration:"Administración de la sala",tooltipUsercount:"Usuarios en la sala",enterRoomPassword:'La sala "%s" está protegida mediante contraseña.',enterRoomPasswordSubmit:"Unirse a la sala",passwordEnteredInvalid:'Contraseña incorrecta para la sala "%s".',nicknameConflict:"El nombre de usuario ya está siendo utilizado. Por favor elija otro.",errorMembersOnly:'No se puede unir a la sala "%s": no tiene privilegios suficientes.',errorMaxOccupantsReached:'No se puede unir a la sala "%s": demasiados participantes.',antiSpamMessage:"Por favor, no hagas spam. Has sido bloqueado temporalmente."},cn:{status:"状态: %s",statusConnecting:"连接中...",statusConnected:"已连接",statusDisconnecting:"断开连接中...",statusDisconnected:"已断开连接",statusAuthfail:"认证失败",roomSubject:"主题:",messageSubmit:"发送",labelUsername:"用户名:",labelPassword:"密码:",loginSubmit:"登录",loginInvalid:"用户名不合法",reason:"原因:",subject:"主题:",reasonWas:"原因是: %s.",kickActionLabel:"踢除",youHaveBeenKickedBy:"你在 %1$s 被管理者 %2$s 请出房间",banActionLabel:"禁言",youHaveBeenBannedBy:"你在 %1$s 被管理者 %2$s 禁言",privateActionLabel:"单独对话",ignoreActionLabel:"忽略",unignoreActionLabel:"不忽略",setSubjectActionLabel:"变更主题",administratorMessageSubject:"管理员",userJoinedRoom:"%s 加入房间",userLeftRoom:"%s 离开房间",userHasBeenKickedFromRoom:"%s 被请出这个房间",userHasBeenBannedFromRoom:"%s 被管理者禁言",presenceUnknownWarningSubject:"注意:",presenceUnknownWarning:"这个会员可能已经下线，不能追踪到他的连接信息",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"管理",tooltipIgnored:"你忽略了这个会员",tooltipEmoticons:"表情",tooltipSound:"新消息发音",tooltipAutoscroll:"滚动条",tooltipStatusmessage:"禁用状态消息",tooltipAdministration:"房间管理",tooltipUsercount:"房间占有者",enterRoomPassword:'登录房间 "%s" 需要密码.',enterRoomPasswordSubmit:"加入房间",passwordEnteredInvalid:'登录房间 "%s" 的密码不正确',nicknameConflict:"用户名已经存在，请另选一个",errorMembersOnly:'您的权限不够，不能登录房间 "%s" ',errorMaxOccupantsReached:'房间 "%s" 的人数已达上限，您不能登录',antiSpamMessage:"因为您在短时间内发送过多的消息 服务器要阻止您一小段时间。"},ja:{status:"ステータス: %s",statusConnecting:"接続中…",statusConnected:"接続されました",statusDisconnecting:"ディスコネクト中…",statusDisconnected:"ディスコネクトされました",statusAuthfail:"認証に失敗しました",roomSubject:"トピック：",messageSubmit:"送信",labelUsername:"ユーザーネーム：",labelPassword:"パスワード：",loginSubmit:"ログイン",loginInvalid:"ユーザーネームが正しくありません",reason:"理由：",subject:"トピック：",reasonWas:"理由: %s。",kickActionLabel:"キック",youHaveBeenKickedBy:"あなたは%2$sにより%1$sからキックされました。",youHaveBeenKicked:"あなたは%sからキックされました。",banActionLabel:"アカウントバン",youHaveBeenBannedBy:"あなたは%2$sにより%1$sからアカウントバンされました。",youHaveBeenBanned:"あなたは%sからアカウントバンされました。",privateActionLabel:"プライベートメッセージ",ignoreActionLabel:"無視する",unignoreActionLabel:"無視をやめる",setSubjectActionLabel:"トピックを変える",administratorMessageSubject:"管理者",userJoinedRoom:"%sは入室しました。",userLeftRoom:"%sは退室しました。",userHasBeenKickedFromRoom:"%sは部屋からキックされました。",userHasBeenBannedFromRoom:"%sは部屋からアカウントバンされました。",presenceUnknownWarningSubject:"忠告：",presenceUnknownWarning:"このユーザーのステータスは不明です。",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"モデレーター",tooltipIgnored:"このユーザーを無視設定にしている",tooltipEmoticons:"絵文字",tooltipSound:"新しいメッセージが届くたびに音を鳴らす",tooltipAutoscroll:"オートスクロール",tooltipStatusmessage:"ステータスメッセージを表示",tooltipAdministration:"部屋の管理",tooltipUsercount:"この部屋の参加者の数",enterRoomPassword:'"%s"の部屋に入るにはパスワードが必要です。',enterRoomPasswordSubmit:"部屋に入る",passwordEnteredInvalid:'"%s"のパスワードと異なるパスワードを入力しました。',nicknameConflict:"このユーザーネームはすでに利用されているため、別のユーザーネームを選んでください。",errorMembersOnly:'"%s"の部屋に入ることができません: 利用権限を満たしていません。',errorMaxOccupantsReached:'"%s"の部屋に入ることができません: 参加者の数はすでに上限に達しました。',antiSpamMessage:"スパムなどの行為はやめてください。あなたは一時的にブロックされました。"},sv:{status:"Status: %s",statusConnecting:"Ansluter...",statusConnected:"Ansluten",statusDisconnecting:"Kopplar från...",statusDisconnected:"Frånkopplad",statusAuthfail:"Autentisering misslyckades",roomSubject:"Ämne:",messageSubmit:"Skicka",labelUsername:"Användarnamn:",labelPassword:"Lösenord:",loginSubmit:"Logga in",loginInvalid:"Ogiltigt JID",reason:"Anledning:",subject:"Ämne:",reasonWas:"Anledningen var: %s.",kickActionLabel:"Sparka ut",youHaveBeenKickedBy:"Du har blivit utsparkad från %2$s av %1$s",youHaveBeenKicked:"Du har blivit utsparkad från %s",banActionLabel:"Bannlys",youHaveBeenBannedBy:"Du har blivit bannlyst från %1$s av %2$s",youHaveBeenBanned:"Du har blivit bannlyst från %s",privateActionLabel:"Privat chatt",ignoreActionLabel:"Blockera",unignoreActionLabel:"Avblockera",setSubjectActionLabel:"Ändra ämne",administratorMessageSubject:"Administratör",userJoinedRoom:"%s kom in i rummet.",userLeftRoom:"%s har lämnat rummet.",userHasBeenKickedFromRoom:"%s har blivit utsparkad ur rummet.",userHasBeenBannedFromRoom:"%s har blivit bannlyst från rummet.",presenceUnknownWarningSubject:"Notera:",presenceUnknownWarning:"Denna användare kan vara offline. Vi kan inte följa dennes närvaro.",dateFormat:"yyyy-mm-dd",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Du blockerar denna användare",tooltipEmoticons:"Smilies",tooltipSound:"Spela upp ett ljud vid nytt meddelande",tooltipAutoscroll:"Autoskrolla",tooltipStatusmessage:"Visa statusmeddelanden",tooltipAdministration:"Rumadministrering",tooltipUsercount:"Antal användare i rummet",enterRoomPassword:'Rummet "%s" är lösenordsskyddat.',enterRoomPasswordSubmit:"Anslut till rum",passwordEnteredInvalid:'Ogiltigt lösenord för rummet "%s".',nicknameConflict:"Upptaget användarnamn. Var god välj ett annat.",errorMembersOnly:'Du kan inte ansluta till rummet "%s": Otillräckliga rättigheter.',errorMaxOccupantsReached:'Du kan inte ansluta till rummet "%s": Rummet är fullt.',antiSpamMessage:"Var god avstå från att spamma. Du har blivit blockerad för en kort stund."},it:{status:"Stato: %s",statusConnecting:"Connessione...",statusConnected:"Connessione",statusDisconnecting:"Disconnessione...",statusDisconnected:"Disconnesso",statusAuthfail:"Autenticazione fallita",roomSubject:"Oggetto:",messageSubmit:"Invia",labelUsername:"Nome utente:",labelPassword:"Password:",loginSubmit:"Login",loginInvalid:"JID non valido",reason:"Ragione:",subject:"Oggetto:",reasonWas:"Ragione precedente: %s.",kickActionLabel:"Espelli",youHaveBeenKickedBy:"Sei stato espulso da %2$s da %1$s",youHaveBeenKicked:"Sei stato espulso da %s",banActionLabel:"Escluso",youHaveBeenBannedBy:"Sei stato escluso da %1$s da %2$s",youHaveBeenBanned:"Sei stato escluso da %s",privateActionLabel:"Stanza privata",ignoreActionLabel:"Ignora",unignoreActionLabel:"Non ignorare",setSubjectActionLabel:"Cambia oggetto",administratorMessageSubject:"Amministratore",userJoinedRoom:"%s si è unito alla stanza.",userLeftRoom:"%s ha lasciato la stanza.",userHasBeenKickedFromRoom:"%s è stato espulso dalla stanza.",userHasBeenBannedFromRoom:"%s è stato escluso dalla stanza.",presenceUnknownWarningSubject:"Nota:",presenceUnknownWarning:"Questo utente potrebbe essere offline. Non possiamo tracciare la sua presenza.",dateFormat:"dd/mm/yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderatore",tooltipIgnored:"Stai ignorando questo utente",tooltipEmoticons:"Emoticons",tooltipSound:"Riproduci un suono quando arrivano messaggi",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Mostra messaggi di stato",tooltipAdministration:"Amministrazione stanza",tooltipUsercount:"Partecipanti alla stanza",enterRoomPassword:'La stanza "%s" è protetta da password.',enterRoomPasswordSubmit:"Unisciti alla stanza",passwordEnteredInvalid:'Password non valida per la stanza "%s".',nicknameConflict:"Nome utente già in uso. Scegline un altro.",errorMembersOnly:'Non puoi unirti alla stanza "%s": Permessi insufficienti.',errorMaxOccupantsReached:'Non puoi unirti alla stanza "%s": Troppi partecipanti.',antiSpamMessage:"Per favore non scrivere messaggi pubblicitari. Sei stato bloccato per un po' di tempo."},pt:{status:"Status: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desligando...",statusDisconnected:"Desligado",statusAuthfail:"Falha na autenticação",roomSubject:"Assunto:",messageSubmit:"Enviar",labelUsername:"Usuário:",labelPassword:"Senha:",loginSubmit:"Entrar",loginInvalid:"JID inválido",reason:"Motivo:",subject:"Assunto:",reasonWas:"O motivo foi: %s.",kickActionLabel:"Excluir",youHaveBeenKickedBy:"Você foi excluido de %1$s por %2$s",youHaveBeenKicked:"Você foi excluido de %s",banActionLabel:"Bloquear",youHaveBeenBannedBy:"Você foi excluido permanentemente de %1$s por %2$s",youHaveBeenBanned:"Você foi excluido permanentemente de %s",privateActionLabel:"Bate-papo privado",ignoreActionLabel:"Ignorar",unignoreActionLabel:"Não ignorar",setSubjectActionLabel:"Trocar Assunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s entrou na sala.",userLeftRoom:"%s saiu da sala.",userHasBeenKickedFromRoom:"%s foi excluido da sala.",userHasBeenBannedFromRoom:"%s foi excluido permanentemente da sala.",presenceUnknownWarning:"Este usuário pode estar desconectado. Não é possível determinar o status.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Você ignora este usuário",tooltipEmoticons:"Emoticons",tooltipSound:"Reproduzir o som para novas mensagens",tooltipAutoscroll:"Deslocamento automático",tooltipStatusmessage:"Mostrar mensagens de status",tooltipAdministration:"Administração da sala",tooltipUsercount:"Usuários na sala",enterRoomPassword:'A sala "%s" é protegida por senha.',enterRoomPasswordSubmit:"Junte-se à sala",passwordEnteredInvalid:'Senha incorreta para a sala "%s".',nicknameConflict:"O nome de usuário já está em uso. Por favor, escolha outro.",errorMembersOnly:'Você não pode participar da sala "%s":  privilégios insuficientes.',errorMaxOccupantsReached:'Você não pode participar da sala "%s": muitos participantes.',antiSpamMessage:"Por favor, não envie spam. Você foi bloqueado temporariamente."},pt_br:{status:"Estado: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desconectando...",statusDisconnected:"Desconectado",statusAuthfail:"Autenticação falhou",roomSubject:"Assunto:",messageSubmit:"Enviar",labelUsername:"Usuário:",labelPassword:"Senha:",loginSubmit:"Entrar",loginInvalid:"JID inválido",reason:"Motivo:",subject:"Assunto:",reasonWas:"Motivo foi: %s.",kickActionLabel:"Derrubar",youHaveBeenKickedBy:"Você foi derrubado de %2$s por %1$s",youHaveBeenKicked:"Você foi derrubado de %s",banActionLabel:"Banir",youHaveBeenBannedBy:"Você foi banido de %1$s por %2$s",youHaveBeenBanned:"Você foi banido de %s",privateActionLabel:"Conversa privada",ignoreActionLabel:"Ignorar",unignoreActionLabel:"Não ignorar",setSubjectActionLabel:"Mudar Assunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s entrou na sala.",userLeftRoom:"%s saiu da sala.",userHasBeenKickedFromRoom:"%s foi derrubado da sala.",userHasBeenBannedFromRoom:"%s foi banido da sala.",presenceUnknownWarningSubject:"Aviso:",presenceUnknownWarning:"Este usuário pode estar desconectado.. Não conseguimos rastrear sua presença..",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Você ignora este usuário",tooltipEmoticons:"Emoticons",tooltipSound:"Tocar som para novas mensagens",tooltipAutoscroll:"Auto-rolagem",tooltipStatusmessage:"Exibir mensagens de estados",tooltipAdministration:"Administração de Sala",tooltipUsercount:"Participantes da Sala",enterRoomPassword:'Sala "%s" é protegida por senha.',enterRoomPasswordSubmit:"Entrar na sala",passwordEnteredInvalid:'Senha inváida para sala "%s".',nicknameConflict:"Nome de usuário já em uso. Por favor escolha outro.",errorMembersOnly:'Você não pode entrar na sala "%s": privilégios insuficientes.',errorMaxOccupantsReached:'Você não pode entrar na sala "%s": máximo de participantes atingido.',antiSpamMessage:"Por favor, não faça spam. Você foi bloqueado temporariamente."},ru:{status:"Статус: %s",statusConnecting:"Подключение...",statusConnected:"Подключено",statusDisconnecting:"Отключение...",statusDisconnected:"Отключено",statusAuthfail:"Неверный логин",roomSubject:"Топик:",messageSubmit:"Послать",labelUsername:"Имя:",labelPassword:"Пароль:",loginSubmit:"Логин",loginInvalid:"Неверный JID",reason:"Причина:",subject:"Топик:",reasonWas:"Причина была: %s.",kickActionLabel:"Выбросить",youHaveBeenKickedBy:"Пользователь %1$s выбросил вас из чата %2$s",youHaveBeenKicked:"Вас выбросили из чата %s",banActionLabel:"Запретить доступ",youHaveBeenBannedBy:"Пользователь %1$s запретил вам доступ в чат %2$s",youHaveBeenBanned:"Вам запретили доступ в чат %s",privateActionLabel:"Один-на-один чат",ignoreActionLabel:"Игнорировать",unignoreActionLabel:"Отменить игнорирование",setSubjectActionLabel:"Изменить топик",administratorMessageSubject:"Администратор",userJoinedRoom:"%s вошёл в чат.",userLeftRoom:"%s вышел из чата.",userHasBeenKickedFromRoom:"%s выброшен из чата.",userHasBeenBannedFromRoom:"%s запрещён доступ в чат.",presenceUnknownWarningSubject:"Уведомление:",presenceUnknownWarning:"Этот пользователь вероятнее всего оффлайн.",dateFormat:"mm.dd.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Модератор",tooltipIgnored:"Вы игнорируете этого пользователя.",tooltipEmoticons:"Смайлики",tooltipSound:"Озвучивать новое сообщение",tooltipAutoscroll:"Авто-прокручивание",tooltipStatusmessage:"Показывать статус сообщения",tooltipAdministration:"Администрирование чат комнаты",tooltipUsercount:"Участники чата",enterRoomPassword:'Чат комната "%s" защищена паролем.',enterRoomPasswordSubmit:"Войти в чат",passwordEnteredInvalid:'Неверный пароль для комнаты "%s".',nicknameConflict:"Это имя уже используется. Пожалуйста выберите другое имя.",errorMembersOnly:'Вы не можете войти в чат "%s": Недостаточно прав доступа.',errorMaxOccupantsReached:'Вы не можете войти в чат "%s": Слишком много участников.',antiSpamMessage:"Пожалуйста не рассылайте спам. Вас заблокировали на короткое время."},ca:{status:"Estat: %s",statusConnecting:"Connectant...",statusConnected:"Connectat",statusDisconnecting:"Desconnectant...",statusDisconnected:"Desconnectat",statusAuthfail:"Ha fallat la autenticació",roomSubject:"Assumpte:",messageSubmit:"Enviar",labelUsername:"Usuari:",labelPassword:"Clau:",loginSubmit:"Entrar",loginInvalid:"JID no vàlid",reason:"Raó:",subject:"Assumpte:",reasonWas:"La raó ha estat: %s.",kickActionLabel:"Expulsar",youHaveBeenKickedBy:"Has estat expulsat de %1$s per %2$s",youHaveBeenKicked:"Has estat expulsat de %s",banActionLabel:"Prohibir",youHaveBeenBannedBy:"Has estat expulsat permanentment de %1$s per %2$s",youHaveBeenBanned:"Has estat expulsat permanentment de %s",privateActionLabel:"Xat privat",ignoreActionLabel:"Ignorar",unignoreActionLabel:"No ignorar",setSubjectActionLabel:"Canviar assumpte",administratorMessageSubject:"Administrador",userJoinedRoom:"%s ha entrat a la sala.",userLeftRoom:"%s ha deixat la sala.",userHasBeenKickedFromRoom:"%s ha estat expulsat de la sala.",userHasBeenBannedFromRoom:"%s ha estat expulsat permanentment de la sala.",presenceUnknownWarningSubject:"Atenció:",presenceUnknownWarning:"Aquest usuari podria estar desconnectat ...",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Estàs ignorant aquest usuari",tooltipEmoticons:"Emoticones",tooltipSound:"Reproduir un so per a nous missatges",tooltipAutoscroll:"Desplaçament automàtic",tooltipStatusmessage:"Mostrar missatges d'estat",tooltipAdministration:"Administració de la sala",tooltipUsercount:"Usuaris dins la sala",enterRoomPassword:'La sala "%s" està protegida amb contrasenya.',enterRoomPasswordSubmit:"Entrar a la sala",passwordEnteredInvalid:'Contrasenya incorrecta per a la sala "%s".',nicknameConflict:"El nom d'usuari ja s'està utilitzant. Si us plau, escolleix-ne un altre.",errorMembersOnly:'No pots unir-te a la sala "%s": no tens prous privilegis.',errorMaxOccupantsReached:'No pots unir-te a la sala "%s": hi ha masses participants.',antiSpamMessage:"Si us plau, no facis spam. Has estat bloquejat temporalment."}},function(){if(!window.jQuery)throw Ifm.Diagnostics.Errors.miss("Candy");Candy.View.Translation.en.labelNickname="Your name:";Candy.View.Translation.en.loginSubmit="Enter chat";Candy.View.Translation.en.userJoinedRoom="%s has entered the conversation.";Candy.View.Translation.en.userLeftRoom="%s has left the conversation.";Candy.View.Translation.it.labelNickname="Il tuo nome:";Candy.View.Translation.it.loginSubmit="Entra in chat";Candy.View.Translation.it.userJoinedRoom="%s &egrave; entrato nella conversazione.";Candy.View.Translation.it.userLeftRoom="%s ha lasciato la conversazione.";Candy.Core.isConnected=function(){return Candy.Core.getConnection().connected};Candy.Core.getUsername=function(){return Candy.Core.getUser().getNick()};Candy.Core.available=function(n){var t=$pres({from:Candy.Core.getConnection().jid,to:n});Ifm.Diagnostics.Debug.print("Sending availability to",n);Candy.Core.getConnection().send(t)};Candy.Core.subscribe=function(n,t,i){var u="pres:"+Candy.Core.getConnection().getUniqueId(),r=$pres({from:Candy.Core.getConnection().jid,to:n,id:u,type:"subscribe"});t&&r.c("nick",{xmlns:"http://jabber.org/protocol/nick"},t);i&&r.c("status",{},i);Ifm.Diagnostics.Debug.print("Requesting subscription to",n,"(id",u,")",t?"as "+t:"");Candy.Core.getConnection().send(r)};Candy.Core.subscribed=function(n,t){var i=t||"pres:"+Candy.Core.getConnection().getUniqueId(),r=$pres({from:Candy.Core.getConnection().jid,to:n,id:i,type:"subscribed"});Ifm.Diagnostics.Debug.print("Replying subscription to",n,"(id",i,")");Candy.Core.getConnection().send(r)};Candy.Core.notifystate=function(n,t){var i=$msg({from:Candy.Core.getConnection().jid,to:n,type:"groupchat"}).c(t,{xmlns:"http://jabber.org/protocol/chatstates"});Ifm.Diagnostics.Debug.print("Sending",t,"notification");Candy.Core.getConnection().send(i)};Candy.View.deletenotification=function(n){var i=Candy.View.Pane.Room.getPane(n),r,t;i&&(r=Candy.View.Pane.Room.getPane(n,".message-pane"),t=i.data(),t.resetnotificationtmr&&(clearTimeout(t.resetnotificationtmr),t.resetnotificationtmr=0),r.find("[name=chat-state-message]").remove())};Candy.View.movenotification=function(n){if(Candy.View.Pane.Room.getPane(n)){var t=Candy.View.Pane.Room.getPane(n,".message-pane"),i=t.find("[name=chat-state-message]");i.length&&t.append(i)}};Candy.View.updatenotification=function(n,t,i,r){var u,f;Candy.View.deletenotification(n);u=Candy.View.Pane.Room.getPane(n);u&&(f=Mustache.to_html(Candy.View.Template.Chat.stateMessage,{subject:t,message:r}),Candy.View.Pane.Room.appendToMessagePane(n,f),Candy.View.getCurrent().roomJid===n&&Candy.View.Pane.Room.scrollToBottom(n),u.data({resetnotificationtmr:setTimeout(function(){Candy.View.deletenotification(n)},1e4)}))}}(),function(){var t=namespace("Ifm.PhoneBar.Media"),n;t.Xmpp={events:defineEvents("initialized","reachable","unreachable","newcall","newmessage","callclosed","filetransfer")};t.Xmpp.instance=function(){function c(){var h,c;document.getElementById("candy")||(h=document.createElement("div"),h.id="candy",h.style.display="none",document.body.appendChild(h));t.theme?(t.theme.endsWith("/")||(t.theme+="/"),$("head").append('<link rel="stylesheet" href="'+t.theme+'default.css" />')):document.getElementById("candy").style.display="none";Candy.init(t.service,{core:{debug:t.debug,autojoin:[],disconnectWithoutTabs:!1},view:{assets:t.theme,language:t.language}});u=Ifm.Chat.strings[t.language]||Ifm.Chat.strings.it;c=window.onbeforeunload;window.onunload=function(){window.onerror=null;n.disconnect();c()};window.onbeforeunload=null;Candy.View.Pane.Chat.baseInfoMessage=Candy.View.Pane.Chat.onInfoMessage;Candy.View.Pane.Chat.infoMessage=Candy.View.Pane.Chat.onInfoMessage=function(n,t,i){if(Candy.View.Pane.Room.getPane(n)){var r=Candy.View.Pane.Room.getPane(n,".message-pane").children().last().text();r.indexOf(t)<0&&r.indexOf(i)<0&&Candy.View.Pane.Chat.baseInfoMessage(n,t,i)}};Candy.View.Template.FileTransfer={item:'<li><small>{{time}}<\/small><div class="filetransfer"><span class="spacer">•<\/span><span class="message">{{{view}}}<\/span><\/div><\/li>'};Candy.View.Template.Message.header='<div class="header-wrapper"><span class="chatstatus-text header-text"><\/span><span timerid="" class="chatduration-text header-text"><\/span><button class="header-button hangup-button"><\/button><button class="header-button chattransfer-button"><\/button><button class="header-button chatclosetab-button" style="display:none;"><\/button><\/div>';$(Candy).on("candy:core.chat.connection",function(n,i){switch(i.status){case Strophe.Status.CONNECTING:r.log("PhoneBar.Media.Xmpp","Debug","Connecting to Xmpp Server");break;case Strophe.Status.CONNECTED:r.log("PhoneBar.Media.Xmpp","Debug","Connected to Xmpp Server");setTimeout(function(){t.mediatypes&Ifm.PhoneBar.Mediatypes.NearRealTime&&(Candy.Core.subscribe(t.getPresence_nrt(),t.getAgentPre(),t.presence),Candy.Core.subscribe(t.getDomain_nrt()),Candy.Core.subscribe(t.getAdmin_nrt()));t.mediatypes&Ifm.PhoneBar.Mediatypes.StoreAndForward&&(Candy.Core.subscribe(t.getPresence_saf(),t.getAgentPre(),t.presence),Candy.Core.subscribe(t.getDomain_saf()),Candy.Core.subscribe(t.getAdmin_saf()))},100);break;case Strophe.Status.DISCONNECTING:r.log("PhoneBar.Media.Xmpp","Debug","Disconnecting from Xmpp Server");break;case Strophe.Status.DISCONNECTED:r.log("PhoneBar.Media.Xmpp","Debug","Disconnected from Xmpp Server");Candy.Core.keepconnected?setTimeout(function(){Candy.Core.keepconnected=!1;Candy.Core.connect(t.server,null,t.getUsername())},200):e.unreachable.raise(r,{reason:null});break;case Strophe.Status.CONNFAIL:case Strophe.Status.AUTHFAIL:r.log("PhoneBar.Media.Xmpp","Debug","Connection with Xmpp Server failed",i.status);e.unreachable.raise(r,{reason:"Connection failed"});break;default:r.log("PhoneBar.Media.Xmpp","Debug","Connection with Xmpp Server in status",i.status)}});$(Candy).on("candy:view.connection.status-6",function(){Candy.View.Pane.Chat.Modal.hide();for(var n in f)o(n),Candy.View.Pane.Room.close(n);return i={},f={},!1});$(Candy).on("candy:view.connection.status-7",function(){return Candy.View.Pane.Chat.Modal.hide(),!1});$(Candy).on("candy:core.presence",function(n,i){var f=i.stanza,u=f.attr("from"),o=f.attr("id"),s=f.attr("type")||"available";r.log("PhoneBar.Media.Xmpp","Debug","Got",s,"message from",u,"(id",o||"none",")");switch(s){case"subscribe":Candy.Core.subscribed(u,o);break;case"subscribed":Candy.Core.available(u);u.startsWith(t.presence)&&e.reachable.raise(r,{})}});$(Candy).on("candy:core:chat:invite",function(n,t){var i,u;(t.inviteType===undefined||t.inviteType==="DirectInvite")&&(i=t.inviteType||"Invite",r.log("PhoneBar.Media.Xmpp","Debug","Got",i,"message from",t.roomJid),u=Candy.Util.unescapeJid(t.roomJid),Candy.Core.Action.Jabber.Room.Join(u,null))});$(Candy).on("candy:core.message.chatstate",function(n,t){t.chatstate&&t.name!==Candy.Core.getUsername()&&(t.chatstate==="composing"?Candy.View.updatenotification(t.roomJid,t.displayName,t.chatstate,u.ChatStateComposing):Candy.View.deletenotification(t.roomJid))});$(Candy).on("candy:view.room.before-add",function(n,t){var e=t.roomJid,u,s=e.substr(1,36).toUpperCase(),o;r.log("PhoneBar.Media.Xmpp","Debug","Matching conversation");o=!1;for(u in i)if(s===i[u].callGuid){i[u].roomJid=e;f[e]=Number(u);o=!0;break}if(!o)return r.log("PhoneBar.Media.Xmpp","Debug","Unable to match conversation, probably post-mortem event"),!1});$(Candy).on("candy:view.room.after-add",function(r,e){var c=e.roomJid,v=f[c],o,l,w,b;Candy.View.Pane.Chat.getTab(c).find(".label").html(i[v].campaignName);o=Candy.View.Pane.Room.getPane(c);l=o.find(".hangup-button");l.click(function(){n.close(v)});l=o.find(".chatclosetab-button");l.click(function(){n.ready(v)});l=o.find(".chattransfer-button");t.showtransfer?l.click(function(){n.showTransferDialog(v)}):l.hide();w=o.find(".chatstatus-text");w.text(u.ChatStateTalking);var k=setInterval(function(){var u=new Date,t=Math.abs(b-u),i=Math.floor(t/36e5),n,r;i<10&&(i="0"+i);t-=i*36e5;n=Math.floor(t/6e4);n<10&&(n="0"+n);t-=n*6e4;r=Math.floor(t/1e3);r<10&&(r="0"+r);y.text(i+":"+n+":"+r)},1e3),y=o.find(".chatduration-text"),a=y.data();a.timerid=k;b=new Date;y.text("00:00:00");var a=o.data(),p=o.find(".message-pane-wrapper")[0],h=o.find("[name=message]")[0];a.filetransfers={};Candy.View.Pane.Chat.getTab(c).find(".unread").text("0");Candy.View.Pane.Chat.fitTabs();h.onchange=h.oninput=function(){h.value===""?(Candy.Core.notifystate(c,"paused"),a.lastnotificationsent=0):(!a.lastnotificationsent||dT()-a.lastnotificationsent>5e3)&&(Candy.Core.notifystate(c,"composing"),a.lastnotificationsent=dT())};p.ondragover=h.ondragover=function(n){n||(n=window.event);n&&n.preventDefault()};p.ondrop=h.ondrop=function(n){var i,t;if((n||(n=window.event),n&&n.preventDefault(),Candy.Core.isConnected())&&n.source!==p&&n.source!==h){if(i=n.dataTransfer.getData("text"),i){h.value=i;h.select();return}if(t=n.dataTransfer.files,t&&t.length>0){s(c,t[0]);return}}}});$(Candy).on("candy:view.pane.roster.after-update",function(n,t){var h=t.roomJid,u=f[h],o,s;if(t.action==="join"){if(u===undefined){r.log("PhoneBar.Media.Xmpp","Debug","Discarding unmatched conversation notification");return}i[u].externalPartyUserName||(o=t.user,s=o.getNick(),o.getRole()!==o.ROLE_MODERATOR&&s!==Candy.Core.getUsername()&&(i[u].externalPartyUserName=s,i[u].externalPartyDisplayName=o.getNick(!0),e.newcall.raise(r,{callId:u})))}else Candy.View.deletenotification(h)});$(Candy).on("candy:view.message.before-show",function(n,t){var i,r;if(t.message.startsWith("*begin*"))return t.history||t.name===Candy.Core.getUsername()||(i=new Ifm.Messaging.FStringMessageReader(t.message),i.type==="FTTOKEN"&&(r={token:i.data[0],name:i.data[1],size:Number(i.data[2]),type:i.data[3]},s(t.roomJid,r))),!1});$(Candy).on("candy:view.message.before-render",function(n,t){var u=t.templateData,s=f[u.roomJid],h=i[s].mediatype,o={callId:s,sender:u.displayName,sentFromHere:u.name!==i[s].externalPartyUserName,rawMessage:t.rawMessage,message:u.message,time:u.time,timestamp:u.timestamp,attributes:t.attributes,history:t.history};return u.sender=o.sentFromHere?"sender-is-me":"sender-is-other",e.newmessage.raise(r,o),u.message=o.message,u.time=o.time,u.message===null||u.message==""?!1:void 0});$(Candy).on("candy:view.message.after-show",function(n,t){if(t.name!==Candy.Core.getUsername()){var i=t.element;i.addClass("new-message-highlight");setTimeout(function(){i.removeClass("new-message-highlight")},4e3);Candy.View.movenotification(t.roomJid)}});$(Candy).on("candy:view.presence",function(n,t){var h=t.roomJid,c=f[h],y=i[c]&&i[c].transfer,s=Candy.View.Pane.Room.getPane(h),l,a,v;Candy.View.deletenotification(h);o(h);y?Candy.View.Pane.Room.close(h):s&&(Candy.View.Pane.Chat.getTab(h).find(".label").css({opacity:".80"}),s.find(".message-form-wrapper").hide(),s.find(".message-pane-wrapper").css({opacity:".80"}),s.find(".hangup-button").hide(),s.find(".chattransfer-button").hide(),s.find(".chatclosetab-button").show(),l=s.find(".chatduration-text"),a=l.data(),clearInterval(a.timerid),v=s.find(".chatstatus-text"),v.text(u.ChatStateClosed));e.callclosed.raise(r,{callId:c})});$(Candy).on("candy:view.room.after-close",function(n,t){delete i[f[t.roomJid]];delete f[t.roomJid]})}function s(n,i){var s,h,o;if(n===undefined||f[n]===undefined){r.log("PhoneBar.Media.Xmpp","Debug","Invalid conversation");return}if(!i||!i.name||i.size===undefined||!i.type===undefined){r.log("PhoneBar.Media.Xmpp","Debug","Invalid argument file");return}if(s=i.token?!1:!0,h=i.size>=1073741824?Math.round(i.size/1073741824)+" GB":i.size>=1048576?Math.round(i.size/1048576)+" MB":i.size>=1024?Math.round(i.size/1024)+" KB":i.size>1?i.size+" bytes":i.size===1?"1 byte":"0 bytes",!Ifm.Net.Services.FileTransfer.isSupported()||!t.ftservice){Candy.View.Pane.Chat.Modal.showError(u.FileTransfer.NotAvailable);return}o=Ifm.Net.Services.FileTransfer.create(t.ftservice);o.events.waiting=function(t,r){var o=Candy.View.Pane.Room.getPane(n),c=o&&o.data(),e,a,f;if(!c){t.cancel();return}s&&(e=new Ifm.Messaging.FStringMessageWriter("FTTOKEN"),e.add(r.token).add(i.name).add(i.size).add(i.type).end(),Candy.Core.Action.Jabber.Room.Message(n,e.toString()));var l="ft-item-"+t.id,v="<span id='"+l+"'> <span class='filetransfer-title'> "+u.FileTransfer.TransferTitle+" <\/span> <span class='filetransfer-file'> <b>"+i.name+"<\/b> <\/span> <span class='filetransfer-status'> "+u.FileTransfer.Waiting+" <\/span> <a class='filetransfer-accept' href='#'> "+u.FileTransfer.Accept+" <\/a> <a class='filetransfer-cancel' href='#'> "+u.FileTransfer.Cancel+" <\/a> <\/span>",y=Candy.View.Template.FileTransfer.item,p={view:v,time:Candy.Util.localizedTime((new Date).toGMTString())},w=Mustache.to_html(y,p);Candy.View.Pane.Room.appendToMessagePane(n,w);a=Candy.View.Pane.Chat.getTab(n);a.find(".transfer").show();f=$("#"+l);c.filetransfers[t.id]={filetransfer:t,viewelement:f};f.find(".filetransfer-cancel").click(function(){return t.cancel(),!1});s?f.find(".filetransfer-accept").remove():(f.find(".filetransfer-status").text(h),f.find(".filetransfer-accept").click(function(){return t.accept(),f.find(".filetransfer-accept").remove(),!1}))};o.events.started=function(t){var r=Candy.View.Pane.Room.getPane(n),f=r&&r.data(),i,e;f&&(i=f.filetransfers[t.id].viewelement,s?i.find(".filetransfer-status").text(u.FileTransfer.Sending):i.find(".filetransfer-status").text(u.FileTransfer.Receiving),e=Candy.View.Pane.Chat.getTab(n),e.find(".transfer").hide())};o.events.progress=function(t,i){var r=Candy.View.Pane.Room.getPane(n),u=r&&r.data(),f;u&&(f=u.filetransfers[t.id].viewelement,f.find(".filetransfer-status").text(i.percentage+"%"))};o.events.finished=function(t,r){var e=Candy.View.Pane.Room.getPane(n),o=e&&e.data(),f;o&&(f=o.filetransfers[t.id].viewelement,f.find(".filetransfer-cancel").remove(),s?f.find(".filetransfer-status").text(u.FileTransfer.Sent):(f.find(".filetransfer-status").text(u.FileTransfer.Received),f.append($("<a>",{"class":"filetransfer-open",click:r.openOrSaveFunc,href:"#",text:u.FileTransfer.Open})),Candy.Core.Action.Jabber.Room.Message(n,u.FileTransfer.TransferTitle+" "+i.name+" "+h+" "+u.FileTransfer.Complete)))};o.events.canceled=function(t){var r=Candy.View.Pane.Room.getPane(n),f=r&&r.data(),i,e;f&&(i=f.filetransfers[t.id].viewelement,i.find(".filetransfer-status").text(u.FileTransfer.Canceled),i.find(".filetransfer-cancel").remove(),s||i.find(".filetransfer-accept").remove(),e=Candy.View.Pane.Chat.getTab(n),e.find(".transfer").hide())};o.events.error=function(t,i){var e=Candy.View.Pane.Room.getPane(n),f=e&&e.data(),r,o;f&&(Candy.View.Pane.Chat.Modal.showError("File Transfer: "+i.reason),f.filetransfers[t.id]&&(r=f.filetransfers[t.id].viewelement,r.find(".filetransfer-status").text(u.FileTransfer.Error),r.find(".filetransfer-cancel").remove(),s||r.find(".filetransfer-accept").remove(),o=Candy.View.Pane.Chat.getTab(n),o.find(".transfer").hide()))};s?o.transfer(i):o.receive(i.token);e.filetransfer.raise(r,{callId:f[n],file:i,filetransfer:o})}function o(n){var r=Candy.View.Pane.Room.getPane(n),t=r&&r.data(),i;if(t&&t.filetransfers)for(i in t.filetransfers)t.filetransfers[i].filetransfer.cancel(),delete t.filetransfers[i]}if(!window.jQuery)throw Ifm.Diagnostics.Errors.miss("jQuery");if(!window.Strophe)throw Ifm.Diagnostics.Errors.miss("Candy/Libs");if(!window.Candy)throw Ifm.Diagnostics.Errors.miss("Candy");var r=null,i={},f={},h=!1,u,e=Ifm.PhoneBar.Media.Xmpp.events,t={mediatypes:0,service:"",server:"",ftservice:"",nickname:"",theme:"assets/xmpp/",language:"it",domain_nrt:"xmpp-nrt",domain_saf:"xmpp-saf",admin_nrt:"lxadmin-nrt",admin_saf:"lxadmin-saf",presence:"login",debug:!1,showtransfer:!0,areValidMediatypes:function(){return Ifm.Type.isNumber(this.mediatypes)&&this.mediatypes>0&&this.mediatypes&Ifm.PhoneBar.Mediatypes.NearRealTime||this.mediatypes&Ifm.PhoneBar.Mediatypes.StoreAndForward?!0:!1},getAdmin_nrt:function(){return this.admin_nrt+"@"+this.server},getAdmin_saf:function(){return this.admin_saf+"@"+this.server},getDomain_nrt:function(){return this.domain_nrt+"."+this.server},getDomain_saf:function(){return this.domain_saf+"."+this.server},getPresence_nrt:function(){return this.presence+"@"+this.domain_nrt+"."+this.server},getPresence_saf:function(){return this.presence+"@"+this.domain_saf+"."+this.server},getAgentPre:function(){return"Agent_"+this.extension},getUsername:function(){return(this.displayname||"Agent")+"_"+this.extension}};return Ifm.PhoneBar.events.assignment=function(n,t){n.log("PhoneBar.Media.Xmpp","Debug","Assignment event");i[t.callId]=t},Ifm.PhoneBar.events.callfailure=function(n,t){n.log("PhoneBar.Media.Xmpp","Debug","CallFailure event");delete i[t.callId]},Ifm.PhoneBar.events.readyfordetach=function(n,t){var r;n.log("PhoneBar.Media.Xmpp","Debug","ReadyForDetach event");t.callId&&i[t.callId]!==undefined&&(r=i[t.callId].roomJid,Candy.Core.Action.Jabber.Room.Leave(r),i[t.callId].transfer&&(r=i[t.callId].roomJid,Candy.View.Pane.Room.getPane(r)&&(o(r),Candy.View.Pane.Room.close(r))))},Ifm.PhoneBar.events.readyfortransfer=function(n,t){n.log("PhoneBar.Media.Xmpp","Debug","ReadyForTransfer event");t.callId&&i[t.callId]!==undefined&&(i[t.callId].transfer=!0)},Ifm.PhoneBar.events.terminated=function(n,t){n.log("PhoneBar.Media.Xmpp","Debug","Terminated event");i[t.callId]&&t.postcall&&(i[t.callId].postcall=!0);var r=Candy.Core.getConnection();(!r.connected||r.errors>=r.maxRetries||r._proto.errors>=r.maxRetries-1)&&(n.log("PhoneBar.Media.Xmpp","Debug","Connection with Xmpp Server lost"),e.unreachable.raise(n,{reason:"Connection lost"}))},{isConnected:function(){return Candy.Core.isConnected()},activeCalls:function(){throw new Error("Obsolete. Use Ifm.PhoneBar.instance.calls() instead");},getCall:function(){throw new Error("Obsolete. Use Ifm.PhoneBar.instance.calls() instead");},initialize:function(n,i){if(!n)throw Ifm.Diagnostics.Errors.arg("pb");if(r=n,!i||!(i.hasOwnProperty("mediatypes")&&i.mediatypes&&i.hasOwnProperty("service")&&i.service&&i.hasOwnProperty("server")&&i.server))throw new Error("Invalid configuration. Should be { <mediatypes>, <service>, <server> }");if(t.mediatypes=i.mediatypes,t.service=i.service,t.server=i.server,t.ftservice=i.hasOwnProperty("ftservice")?i.ftservice:t.ftservice,t.nickname=i.hasOwnProperty("nickname")?i.nickname:t.nickname,t.theme=i.hasOwnProperty("theme")?i.theme:t.theme,t.language=i.hasOwnProperty("language")?i.language:t.language,t.domain_nrt=i.hasOwnProperty("domain_nrt")?i.domain_nrt:t.domain_nrt,t.domain_saf=i.hasOwnProperty("domain_saf")?i.domain_saf:t.domain_saf,t.admin_nrt=i.hasOwnProperty("admin_nrt")?i.admin_nrt:t.admin_nrt,t.admin_saf=i.hasOwnProperty("admin_saf")?i.admin_saf:t.admin_saf,t.presence=i.hasOwnProperty("presence")?i.presence:t.presence,t.debug=i.hasOwnProperty("debug")?i.debug:t.debug,t.showtransfer=i.hasOwnProperty("showtransfer")?i.showtransfer:t.showtransfer,!t.areValidMediatypes())throw new Error("Invalid mediatypes");h||(c(),h=!0,e.initialized.raise(r,{}))},connect:function(){var i=r.agent.extension,f=r.agent.firstName,s=r.agent.lastName,e=t.extension||null,o,u,n;t.extension=i;o=t.firstname||null;t.firstname=f;u=t.displayname||null;t.displayname=t.nickname||t.firstname;n=Candy.Core.isConnected();(i!=e||t.displayname!=u)&&n&&(Candy.Core.keepconnected=!0,Candy.Core.disconnect());n||(r.log("PhoneBar.Media.Xmpp","Debug","Loggin'in as",t.displayname),Candy.Core.connect(t.server,null,t.getUsername()))},disconnect:function(){if(this.isConnected()){for(var n in f)Candy.Core.Action.Jabber.Room.Leave(n);setTimeout(function(){var n=0,t=setInterval(function(){var u=Ifm.Enum.getLength(f),i;if(u>0&&++n<10){r.log("PhoneBar.Media.Xmpp","Debug","Waiting for calls to close:",u,"remaining");return}clearInterval(t);for(i in f)o(i),Candy.View.Pane.Room.close(i);Candy.Core.disconnect()},100)},100)}},handled:function(n){if(this.isConnected()){if(i[n]===undefined||i[n].terminated){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}var t=new Ifm.Messaging.FStringMessageWriter("HANDLED");t.end();this.send(n,t.toString());i[n].handled=!0}},send:function(n,t){var r,u;if(this.isConnected()){if(i[n]===undefined||i[n].terminated){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}if(r=i[n].roomJid,r===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}u=Candy.View.Pane.Chat.rooms[r].type;Candy.Core.Action.Jabber.Room.Message(r,t,u,null)}},showTransferDialog:function(n){Ifm.PhoneBar.UI.instance.commands.showTransferForm(n)},close:function(n){if(this.isConnected()){if(i[n]===undefined||i[n].terminated){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}var t=i[n].roomJid;if(t===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}Candy.Core.Action.Jabber.Room.Leave(t)}},ready:function(n){if(Candy.Core.isConnected()){if(i[n]===undefined){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}i[n].postcall&&Ifm.PhoneBar.instance.ready(n);var t=i[n].roomJid;if(t===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}Candy.View.Pane.Room.getPane(t)&&(o(t),Candy.View.Pane.Room.close(t))}},append:function(t,i){console.warn("Obsolete. Use xmpp.conversation.append() instead");n.conversation.append(t,i)},conversation:{append:function(n,t){var r;if(i[n]===undefined){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}if(r=i[n].roomJid,r===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}Candy.View.Pane.Chat.onInfoMessage(r,"{{message}}");var f=Candy.View.Pane.Room.getPane(r),u=f.find(".message-pane").children().last(),e=u.html();u.html(e.replace("{{message}}",t))},html:function(n){var t,r;if(i[n]===undefined){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}if(t=i[n].roomJid,t===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}return r=Candy.View.Pane.Room.getPane(t),r.find(".message-pane").html()},prepend:function(n,t){var r,u;if(i[n]===undefined){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}if(r=i[n].roomJid,r===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}t&&(u=Candy.View.Pane.Room.getPane(r),u.find(".message-pane").prepend(t))},select:function(n){if(i[n]===undefined){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}var t=i[n].roomJid;if(t===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}Candy.View.Pane.Room.show(t)}},queryFileTransfer:function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");if(!Ifm.Net.Services.FileTransfer.isSupported()||!t.ftservice){n(!1);return}var i=Ifm.Net.Services.FileTransfer.create(t.ftservice);i.enabled(n)},requestFileTransfer:function(n,t){var u,r;if(i[n]===undefined||i[n].terminated){Ifm.Diagnostics.Debug.fail("Invalid callId "+n);return}if(u=i[n].roomJid,u===undefined){Ifm.Diagnostics.Debug.fail("Session not yet created "+n);return}if(!t||!t.name||t.size===undefined||!t.type){r=document.createElement("input");r.type="file";r.style.cssText="display:none!important;";document.body.appendChild(r);r.click();document.body.removeChild(r);r.onchange=function(){r.files&&r.files.length>0&&s(u,r.files[0])};return}}}}();n=t.Xmpp.instance}();namespace("Ifm.Chat.strings"),function(n){n.en={ChatStateComposing:"is writing...",ChatStateTalking:"Chatting",ChatStateClosed:"Chat terminated",FileTransfer:{NotAvailable:"File transfer not available",TransferTitle:"File",Complete:"transferred",Accept:"Accept",Cancel:"Cancel",Open:"Open",Waiting:"waiting",Canceled:"canceled",Error:"error",Receiving:"receiving",Sending:"sending",Received:"received",Sent:"sent"}};n.it={ChatStateComposing:"sta scrivendo...",ChatStateTalking:"In conversazione",ChatStateClosed:"Conversazione chiusa",FileTransfer:{NotAvailable:"Trasferimento file non disponibile",TransferTitle:"File",Complete:"trasferito",Accept:"Accetta",Cancel:"Annulla",Open:"Apri",Waiting:"in attesa",Canceled:"annullato",Error:"errore",Receiving:"ricezione",Sending:"invio",Received:"ricevuto",Sent:"inviato"}}}(Ifm.Chat.strings);