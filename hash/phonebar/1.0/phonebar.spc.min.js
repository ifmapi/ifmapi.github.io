
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";(function(){var n=namespace("Ifm.SoftPhone");n.about={title:"softphone.js",version:"1.0.8-3420"};n.instance=function(){function w(n){try{b(n)}catch(t){console.error("Error processing message:",n,t)}}function b(n){var i=n.split("|"),r,a,y,w;switch(i[0]){case"#ready":break;case"#go":t.events.readytogo.raise({});break;case"#audio":break;case"#registered":v=!0;s=i[1];h=i[2];t.events.registered.raise({domain:s,extension:h});break;case"#notregistered":v=!1;s=null;h=null;t.events.notregistered.raise({});break;case"#bandwidth":p=Number(i[1]);t.events.bandwidth.raise({bandwidth:p});break;case"#conference":l=i[1]==="True";t.events.conference.raise({inConference:l});break;case"#lineselected":u=Number(i[1]);t.events.lineselected.raise({line:u});break;case"#dnd":t.lines[i[1]]._updateDND(i[2]==="True");break;case"#mute":c=i[1]==="True";Ifm.SoftPhone.instance.events.mute.raise({isMuted:c});break;case"#linestate":t.lines[i[1]]._update(i);break;case"#callrefused":break;case"#incomingcall":t.events.incomingcall.raise({line:Number(i[1])});break;case"#ringing":t.events.ringing.raise({line:Number(i[1]),rings:Number(i[2])});break;case"#displayname":t.events.displayname.raise({line:Number(i[1]),displayName:i[2]});break;case"#calling":t.events.calling.raise({line:Number(i[1]),displayName:i[2]});break;case"#callprogress":break;case"#callconnected":t.events.callconnected.raise({line:Number(i[1]),displayName:i[2]});break;case"#calldisconnected":r=Number(i[3]);t.events.calldisconnected.raise({line:Number(i[1]),displayName:i[2],sipCode:r,sipCause:i[4],wasByed:r===99,wasCanceled:r===98});break;case"#vumeter":a=Number(i[1]);y=Number(i[2]);e.shift();e.push(a);o.shift();o.push(y);t.events.vumeter.raise({microphone:a,micdata:e,speakers:y,spkdata:o});break;default:f[i[0]]?(w=f[i[0]].shift(),w&&w(Number(i[1]))):console.warn("Unexpected notification:",i[0])}}function r(n,t,r){if(!i||!i.isOpen||!n||!n.length){console.warn("Unexpected or invalid sendMessage request");return}t=t||"";f[n]===undefined&&(f[n]=[]);f[n].push(function(i){i===400?console.error("Bad request:",n+t):i===0?console.debug("Request",n,"succeeded"):i===200||i===202?(i=i===200?!0:!1,console.debug("Request",n,"succeeded, result:",i)):console.warn("Request",n,"failed:",i);typeof r=="function"&&r(i)});i.send(n+t)}function k(){for(var n=a;n--;)e[n]=o[n]=0}var t={};t.events=defineEvents("connected","disconnected","readytogo","registered","notregistered","bandwidth","conference","lineselected","dnd","mute","linestate","incomingcall","ringing","displayname","calling","callconnected","calldisconnected","vumeter");Object.defineProperties(t,{domain:{get:function(){return s}},extension:{get:function(){return h}},lines:{value:[]},isInitialized:{get:function(){return y}},isConnected:{get:function(){return i&&i.isOpen}},isRegistered:{get:function(){return v}},inDND:{get:function(){return t.lines[0].inDND&&t.lines[1].inDND}},isMuted:{get:function(){return c}},inConference:{get:function(){return l}},selectedLine:{get:function(){return u}}});t.initialize=function(){t.initialize=function(){};t.lines.push(new n.Line(0,r));t.lines.push(new n.Line(1,r));k();y=!0};t.connect=function(n){var r=d;if(n&&n.service)if(Ifm.Type.isArray(n.service)&&n.service.length>0)r=n.service[0];else if(Ifm.Type.isString(n.service))r=n.service;else throw Ifm.Diagnostics.Errors.arg("config.service");i&&i.close();i=Ifm.Net.WebSocket.create(r,"isp");i.events.closed=function(r,u){i=null;!u.clean&&Ifm.Type.isArray(n.service)&&n.service.length>1?t.connect({service:n.service.splice(1)}):t.events.disconnected.raise(u)};i.events.open=function(n,i){t.events.connected.raise(i)};i.events.receive=function(n,t){t.type===Ifm.Net.WebSocket.MessageType.TEXT&&w(t.message)};i.connect()};t.disconnect=function(){i&&i.close()};t.register=function(n,t,i){r("#register","|"+n+"|"+t,i)};t.unregister=function(n){r("#unregister","",n)};t.setBandwidth=function(n,t){r("#setbandwidth","|"+n,t)};t.selectLine=function(n,t){r("#selectline","|"+n,t)};t.canConference=function(n){if(n&&!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");r("#canconference","",n)};t.enterConference=function(n){r("#enterconference","",n)};t.leaveConference=function(n){r("#leaveconference","",n)};t.toggleConference=function(n){l?t.leaveConference(n):t.canConference(function(i){i&&t.enterConference(n)})};t.setDND=function(n,i){t.lines[0].setDND(n,i);t.lines[1].setDND(n)};t.canAnswer=function(n){t.lines[u].canAnswer(n)};t.answer=function(n){t.lines[u].answer(n)};t.canDial=function(n){t.lines[u].canDial(n)};t.dial=function(n,i){t.lines[u].dial(n,i)};t.canSendDigits=function(n){t.lines[u].canSendDigits(n)};t.sendDigits=function(n,i){t.lines[u].sendDigits(n,i)};t.canDrop=function(n){t.lines[u].canDrop(n)};t.drop=function(n){t.lines[u].drop(n)};t.setMute=function(n,t){r("#setmute","|"+n,t)};t.toggleMic=function(n){r("#setmute","|"+!c,n)};t.soundcheck=function(n){r("#soundcheck","",n)};t.stopSoundcheck=function(n){r("#stopsoundcheck","",n)};t.playFile=function(n,i){t.lines[u].playFile(n,i)};t.stopFile=function(n){t.lines[u].stopFile(n)};t.setToken=function(n,t){r("#settoken","|"+n,t)};var d="ws://localhost:6080/",i,f=[],a=8,e=new Array(a),o=new Array(a),s=null,h=null,y=!1,v=!1,c=!1,l=!1,u=0,p=2;return t}()})(),function(){var n=namespace("Ifm.SoftPhone");n.LineStates={Idle:"Idle",Calling:"Calling",IncomingCall:"IncomingCall",Talking:"Talking"};n.Line=function(n,t){var i={},r,u,f;return Object.defineProperties(i,{index:{value:n},isSelected:{get:function(){return selectedLine===n}},inDND:{get:function(){return r}},isMuted:{get:function(){return Ifm.SoftPhone.instance.isMuted}},state:{get:function(){return u}},stateTime:{get:function(){return f}}}),i.setDND=function(i,r){t("#setdnd","|"+n+"|"+i,r)},i.canAnswer=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#cananswer","|"+n,i)},i.answer=function(i){t("#answer","|"+n,i)},i.canDial=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#candial","|"+n,i)},i.dial=function(i,r){t("#dial","|"+n+"|"+i,r)},i.canSendDigits=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#cansenddigits","|"+n,i)},i.sendDigits=function(i,r){t("#senddigits","|"+n+"|"+i,r)},i.canDrop=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#candrop","|"+n,i)},i.drop=function(i){t("#drop","|"+n,i)},i.playFile=function(i,r){t("#playfile","|"+n+"|"+i,r)},i.stopFile=function(i){t("#stopfile","|"+n,i)},i._update=function(t){u=t[2];f=Number(t[3]);Ifm.SoftPhone.instance.events.linestate.raise({line:n,state:u,stateTime:f})},i._updateDND=function(t){r=t;Ifm.SoftPhone.instance.events.dnd.raise({line:n,inDND:r})},i}}(),function(){function n(){r.apply(this,arguments);this.phonebar.log(t,i,"Creating instance")}function e(n){var t=n.softphone.events;t.connected.addHandler(n._onSoftPhoneConnected,n);t.disconnected.addHandler(n._onSoftPhoneDisconnected,n);t.readytogo.addHandler(n._onSoftPhoneReadyToGo,n);t.registered.addHandler(n._onSoftPhoneRegistered,n);t.notregistered.addHandler(n._onSoftPhoneNotRegistered,n);t.bandwidth.addHandler(n._onSoftPhoneBandwidth,n);t.conference.addHandler(n._onSoftPhoneConference,n);t.dnd.addHandler(n._onSoftPhoneDND,n);t.lineselected.addHandler(n._onSoftPhoneLineSelected,n);t.linestate.addHandler(n._onSoftPhoneLineState,n);t.calling.addHandler(n._onSoftPhoneCalling,n);t.callconnected.addHandler(n._onSoftPhoneCallConnected,n);t.calldisconnected.addHandler(n._onSoftPhoneCallDisconnected,n);t.displayname.addHandler(n._onSoftPhoneDisplayName,n);t.incomingcall.addHandler(n._onSoftPhoneIncomingCall,n);t.ringing.addHandler(n._onSoftPhoneRinging,n);t.mute.addHandler(n._onSoftPhoneMute,n);t.vumeter.addHandler(n._onSoftPhoneVUMeter,n)}function o(n){var t=n.softphone.events;t.connected.removeHandler(n._onSoftPhoneConnected);t.disconnected.removeHandler(n._onSoftPhoneDisconnected);t.readytogo.removeHandler(n._onSoftPhoneReadyToGo);t.registered.removeHandler(n._onSoftPhoneRegistered);t.notregistered.removeHandler(n._onSoftPhoneNotRegistered);t.bandwidth.removeHandler(n._onSoftPhoneBandwidth);t.conference.removeHandler(n._onSoftPhoneConference);t.dnd.removeHandler(n._onSoftPhoneDND);t.lineselected.removeHandler(n._onSoftPhoneLineSelected);t.linestate.removeHandler(n._onSoftPhoneLineState);t.calling.removeHandler(n._onSoftPhoneCalling);t.callconnected.removeHandler(n._onSoftPhoneCallConnected);t.calldisconnected.removeHandler(n._onSoftPhoneCallDisconnected);t.displayname.removeHandler(n._onSoftPhoneDisplayName);t.incomingcall.removeHandler(n._onSoftPhoneIncomingCall);t.ringing.removeHandler(n._onSoftPhoneRinging);t.mute.removeHandler(n._onSoftPhoneMute);t.vumeter.removeHandler(n._onSoftPhoneVUMeter)}var u=namespace("Ifm.PhoneBar.Media"),r=u.Phone,s=inherits(n,r);n.prototype.numberOfLines=2;n.prototype.supportsConference=!0;n.prototype._initialize=function(){this.phonebar.log(t,i,"Initializing SoftPhone");this.domain=this._settings.softphoneconfig.domain;this.softphone=Ifm.SoftPhone.instance;this.softphone.initialize();e(this);this._onInitialized()};n.prototype._connect=function(){this.phonebar.log(t,i,"Connecting to SoftPhone Controller service");this.softphone.connect(this._settings.softphoneconfig)};n.prototype._disconnect=function(){this.phonebar.log(t,i,"Disconnecting from SoftPhone Controller service");this.softphone.disconnect()};n.prototype._terminate=function(){this.phonebar.log(t,i,"Terminating SoftPhone");o(this)};n.prototype._setAccessToken=function(n){this.phonebar.log(t,i,"Setting Access Token");this.softphone.setToken(n)};n.prototype._answer=function(){this.phonebar.log(t,i,"Answering on line",this.softphone.selectedLine+1);this.softphone.answer()};n.prototype._dial=function(n){this.phonebar.log(t,i,"Dialing number",n,"on line",this.softphone.selectedLine+1);this.softphone.dial(n)};n.prototype._dtmf=function(n){this.phonebar.log(t,i,"Dialing tones",n,"on line",this.softphone.selectedLine+1);this.softphone.sendDigits(n)};n.prototype._drop=function(){this.phonebar.log(t,i,"Dropping on line",this.softphone.selectedLine+1);this.softphone.drop()};n.prototype._enterConference=function(){this.softphone.enterConference()};n.prototype._leaveConference=function(){this.softphone.leaveConference()};n.prototype._mute=function(){this.softphone.setMute(!0)};n.prototype._register=function(n,r){if(!n||!r){this.phonebar.log(t,i,"SoftPhone can't register without domain and extension");return}if(this.softphone.isRegistered&&this.softphone.domain===n&&this.softphone.extension===r){this.phonebar.log(t,i,"SoftPhone already registered:",n,r);return}this.softphone.register(n,r)};n.prototype._selectLine=function(n){if(this.softphone.selectedLine===n){this.phonebar.log(t,i,"Line already selected:",n);return}this.softphone.selectLine(n)};n.prototype._unmute=function(){this.softphone.setMute(!1)};n.prototype._unregister=function(){this.softphone.unregister()};n.prototype._onSoftPhoneConnected=function(){this.phonebar.log(t,f,"Connected to SoftPhone Controller service");this._onConnected()};n.prototype._onSoftPhoneDisconnected=function(n){this.phonebar.log(t,f,n.reason||"Disconnected from SoftPhone Controller service");this._onDisconnected(n.clean)};n.prototype._onSoftPhoneReadyToGo=function(){this.phonebar.log(t,i,"Device ready to receive commands");this.softphone.setMute(!1);this._selectedLineId>0&&this.selectLine(0);this.register()};n.prototype._onSoftPhoneRegistered=function(n){this.phonebar.log(t,i,"SoftPhone registered to ",n.domain,n.extension);this._onRegisteredStateChanged(!0)};n.prototype._onSoftPhoneNotRegistered=function(){this.phonebar.log(t,i,"SoftPhone not registered");this._onRegisteredStateChanged(!1)};n.prototype._onSoftPhoneBandwidth=function(n){this.phonebar.log(t,i,"Bandwidth set to ",n.bandwidth)};n.prototype._onSoftPhoneConference=function(n){this._onConferenceStateChanged(n.inConference)};n.prototype._onSoftPhoneDND=function(n){this.phonebar.log(t,i,"DND state changed for line ",n.line+1,"; DND is",n.inDND?"ON":"OFF")};n.prototype._onSoftPhoneLineSelected=function(n){this._onLineSelected(n.line)};n.prototype._onSoftPhoneLineState=function(n){var t=Ifm.SoftPhone.LineStates,i;i=n.state===t.Calling?r.States.Calling:n.state===t.IncomingCall?r.States.Incoming:n.state===t.Talking?r.States.Talking:r.States.Idle;this._onLineStateChanged(n.line,i)};n.prototype._onSoftPhoneCalling=function(n){this._onCallConnected(n.line)};n.prototype._onSoftPhoneCallConnected=function(n){this._onCallConnected(n.line)};n.prototype._onSoftPhoneCallDisconnected=function(n){this._onCallDisconnected(n.line,n.sipCode,n.sipCause)};n.prototype._onSoftPhoneDisplayName=function(n){this._onDisplayName(n.line,n.displayName)};n.prototype._onSoftPhoneIncomingCall=function(n){this._onIncomingCall(n.line)};n.prototype._onSoftPhoneRinging=function(n){this._onRinging(n.line,n.rings)};n.prototype._onSoftPhoneMute=function(n){this._onMuteChanged(n.isMuted)};n.prototype._onSoftPhoneVUMeter=function(n){this._onVUMeter(n.microphone,n.speakers)};var t="PhoneBar.Media.Phone.SPC",i="Debug",f="Info";u.SPC=n}();