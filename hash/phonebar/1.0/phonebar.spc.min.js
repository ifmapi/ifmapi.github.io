
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";(function(){var n=namespace("Ifm.SoftPhone");n.instance=function(){function p(n){try{w(n)}catch(t){console.error("Error processing message:",n,t)}}function w(n){var i=n.split("|"),r,a,p,w;switch(i[0]){case"#ready":break;case"#go":t.events.readytogo.raise({});break;case"#audio":break;case"#registered":v=!0;s=i[1];h=i[2];t.events.registered.raise({domain:s,extension:h});break;case"#notregistered":v=!1;s=null;h=null;t.events.notregistered.raise({});break;case"#bandwidth":y=Number(i[1]);t.events.bandwidth.raise({bandwidth:y});break;case"#conference":l=i[1]==="True";t.events.conference.raise({inConference:l});break;case"#lineselected":u=Number(i[1]);t.events.lineselected.raise({line:u});break;case"#dnd":t.lines[i[1]]._updateDND(i[2]==="True");break;case"#mute":c=i[1]==="True";Ifm.SoftPhone.instance.events.mute.raise({isMuted:c});break;case"#linestate":t.lines[i[1]]._update(i);break;case"#callrefused":break;case"#incomingcall":t.events.incomingcall.raise({line:Number(i[1])});break;case"#ringing":t.events.ringing.raise({line:Number(i[1]),rings:Number(i[2])});break;case"#displayname":t.events.displayname.raise({line:Number(i[1]),displayName:i[2]});break;case"#calling":t.events.calling.raise({line:Number(i[1]),displayName:i[2]});break;case"#callprogress":break;case"#callconnected":t.events.callconnected.raise({line:Number(i[1]),displayName:i[2]});break;case"#calldisconnected":r=Number(i[3]);t.events.calldisconnected.raise({line:Number(i[1]),displayName:i[2],sipCode:r,sipCause:i[4],wasByed:r===99,wasCanceled:r===98});break;case"#vumeter":a=Number(i[1]);p=Number(i[2]);e.shift();e.push(a);o.shift();o.push(p);t.events.vumeter.raise({microphone:a,micdata:e,speakers:p,spkdata:o});break;default:f[i[0]]?(w=f[i[0]].shift(),w&&w(Number(i[1]))):console.warn("Unexpected notification:",i[0])}}function r(n,t,r){if(!i||!i.isOpen||!n||!n.length){console.warn("Unexpected or invalid sendMessage request");return}t=t||"";f[n]===undefined&&(f[n]=[]);f[n].push(function(i){i===400?console.error("Bad request:",n+t):i===0?console.log("Request",n,"succeeded"):i===200||i===202?(i=i===200?!0:!1,console.log("Request",n,"succeeded, result:",i)):console.warn("Request",n,"failed:",i);typeof r=="function"&&r(i)});i.send(n+t)}function b(){for(var n=a;n--;)e[n]=o[n]=0}var t={};t.events=defineEvents("connected","disconnected","readytogo","registered","notregistered","bandwidth","conference","lineselected","dnd","mute","linestate","incomingcall","ringing","displayname","calling","callconnected","calldisconnected","vumeter");Object.defineProperties(t,{domain:{get:function(){return s}},extension:{get:function(){return h}},lines:{value:[]},isConnected:{get:function(){return i&&i.isOpen}},isRegistered:{get:function(){return v}},inDND:{get:function(){return t.lines[0].inDND&&t.lines[1].inDND}},isMuted:{get:function(){return c}},inConference:{get:function(){return l}},selectedLine:{get:function(){return u}}});t.initialize=function(){t.initialize=function(){};t.lines.push(new n.Line(0,r));t.lines.push(new n.Line(1,r));b()};t.connect=function(n){var r=k;n&&n.service&&(r=n.service);i&&i.close();i=Ifm.Net.WebSocket.create(r,"isp");i.events.closed=function(n,r){t.events.disconnected.raise(r);i=null};i.events.open=function(n,i){t.events.connected.raise(i)};i.events.receive=function(n,t){t.type===Ifm.Net.WebSocket.MessageType.TEXT&&p(t.message)};i.connect()};t.disconnect=function(){i&&i.close()};t.register=function(n,t,i){r("#register","|"+n+"|"+t,i)};t.unregister=function(n){r("#unregister","",n)};t.setBandwidth=function(n,t){r("#setbandwidth","|"+n,t)};t.selectLine=function(n,t){r("#selectline","|"+n,t)};t.canConference=function(n){if(n&&!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");r("#canconference","",n)};t.enterConference=function(n){r("#enterconference","",n)};t.leaveConference=function(n){r("#leaveconference","",n)};t.toggleConference=function(n){l?t.leaveConference(n):t.canConference(function(i){i&&t.enterConference(n)})};t.setDND=function(n,i){t.lines[0].setDND(n,i);t.lines[1].setDND(n)};t.canAnswer=function(n){t.lines[u].canAnswer(n)};t.answer=function(n){t.lines[u].answer(n)};t.canDial=function(n){t.lines[u].canDial(n)};t.dial=function(n,i){t.lines[u].dial(n,i)};t.canSendDigits=function(n){t.lines[u].canSendDigits(n)};t.sendDigits=function(n,i){t.lines[u].sendDigits(n,i)};t.canDrop=function(n){t.lines[u].canDrop(n)};t.drop=function(n){t.lines[u].drop(n)};t.setMute=function(n,t){r("#setmute","|"+n,t)};t.toggleMic=function(n){r("#setmute","|"+!c,n)};t.soundcheck=function(n){r("#soundcheck","",n)};t.stopSoundcheck=function(n){r("#stopsoundcheck","",n)};var k="ws://localhost:6080/",i,f=[],a=8,e=new Array(a),o=new Array(a),s=null,h=null,v=!1,c=!1,l=!1,u=0,y=2;return t}()})(),function(){var n=namespace("Ifm.SoftPhone");n.LineStates={Idle:"Idle",Calling:"Calling",IncomingCall:"IncomingCall",Talking:"Talking"};n.Line=function(n,t){var i={},r,u,f;return Object.defineProperties(i,{index:{value:n},isSelected:{get:function(){return selectedLine===n}},inDND:{get:function(){return r}},isMuted:{get:function(){return Ifm.SoftPhone.instance.isMuted}},state:{get:function(){return u}},stateTime:{get:function(){return f}}}),i.setDND=function(i,r){t("#setdnd","|"+n+"|"+i,r)},i.canAnswer=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#cananswer","|"+n,i)},i.answer=function(i){t("#answer","|"+n,i)},i.canDial=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#candial","|"+n,i)},i.dial=function(i,r){t("#dial","|"+n+"|"+i,r)},i.canSendDigits=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#cansenddigits","|"+n,i)},i.sendDigits=function(i,r){t("#senddigits","|"+n+"|"+i,r)},i.canDrop=function(i){if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t("#candrop","|"+n,i)},i.drop=function(i){t("#drop","|"+n,i)},i._update=function(t){u=t[2];f=Number(t[3]);Ifm.SoftPhone.instance.events.linestate.raise({line:n,state:u,stateTime:f})},i._updateDND=function(t){r=t;Ifm.SoftPhone.instance.events.dnd.raise({line:n,inDND:r})},i}}(),function(){var n=namespace("Ifm.PhoneBar.Media.Spc");n.instance=function(){function h(){jQuery(n.PickupButton).click(function(){r.answer()});jQuery(n.HangupButton).click(function(){r.drop()});jQuery(n.ManualTransferButton).click(function(){r.dial("!,"+jQuery(n.NumberInput).val())});jQuery(n.FlashButton).click(function(){r.dial("!")});jQuery(n.Line1Button).click(function(){r.selectLine(0)});jQuery(n.Line2Button).click(function(){r.selectLine(1)});jQuery(n.EnterConferenceButton).click(function(){r.enterConference()});jQuery(n.LeaveConferenceButton).click(function(){r.leaveConference()});jQuery(n.MicrophoneOffButton).click(function(){r.mute()});jQuery(n.MicrophoneOnButton).click(function(){r.unmute()});jQuery(n.DialPadDigit0Button).click(function(){r.digits("0")});jQuery(n.DialPadDigit1Button).click(function(){r.digits("1")});jQuery(n.DialPadDigit2Button).click(function(){r.digits("2")});jQuery(n.DialPadDigit3Button).click(function(){r.digits("3")});jQuery(n.DialPadDigit4Button).click(function(){r.digits("4")});jQuery(n.DialPadDigit5Button).click(function(){r.digits("5")});jQuery(n.DialPadDigit6Button).click(function(){r.digits("6")});jQuery(n.DialPadDigit7Button).click(function(){r.digits("7")});jQuery(n.DialPadDigit8Button).click(function(){r.digits("8")});jQuery(n.DialPadDigit9Button).click(function(){r.digits("9")});jQuery(n.DialPadHashButton).click(function(){r.digits("#")});jQuery(n.DialPadStarButton).click(function(){r.digits("*")})}function c(){t.events.connected=function(){i.log("PhoneBar.Media.Spc","Debug","Connected to service");jQuery(n.PhoneStateText).html("").removeClass("blink");f(!0)};t.events.disconnected=function(u){i.log("PhoneBar.Media.Spc","Debug",u.reason||"Disconnected");u.clean||(jQuery(n.PhoneStateText).html(o.PhoneNotConnected).addClass("blink"),setTimeout(function(){t.isConnected||i.currentState===Ifm.PhoneBar.States.NotLoggedIn||r.connect()},1e4));f(!1)};t.events.readytogo=function(){i.log("PhoneBar.Media.Spc","Debug","Device ready to receive commands");r.register()};t.events.registered=function(t){i.log("PhoneBar.Media.Spc","Debug","SoftPhone registered to ",t.domain,t.extension);jQuery(n.PhoneStateText).html("").removeClass("blink")};t.events.notregistered=function(){i.log("PhoneBar.Media.Spc","Debug","SoftPhone not registered");setTimeout(function(){t.isRegistered||i.currentState===Ifm.PhoneBar.States.NotLoggedIn||(r.register(),setTimeout(function(){t.isRegistered||i.currentState===Ifm.PhoneBar.States.NotLoggedIn||jQuery(n.PhoneStateText).html(o.PhoneNotRegistered).addClass("blink")},5e3))},5e3)};t.events.bandwidth=function(n){i.log("PhoneBar.Media.Spc","Debug","Bandwidth set to ",n.bandwidth)};t.events.conference=function(n){i.log("PhoneBar.Media.Spc","Debug","Lines are",n.inConference?"in":"not in","conference");s(n.inConference)};t.events.lineselected=function(t){i.log("PhoneBar.Media.Spc","Debug","Line",t.line,"selected");var r=t.line===1?n.Line2Button:n.Line1Button,u=t.line===1?n.Line1Button:n.Line2Button;jQuery(u).removeClass("selected");jQuery(r).addClass("selected");e()};t.events.dnd=function(n){i.log("PhoneBar.Media.Spc","Debug","DND changed for line ",n.line,"; DND is",n.inDND?"ON":"OFF")};t.events.linestate=function(r){var f,u;i.log("PhoneBar.Media.Spc","Debug","Line",r.line,"changed state:",r.state);f=Ifm.SoftPhone.LineStates;r.line===t.selectedLine&&e();u=r.line===1?n.Line2Button:n.Line1Button;switch(r.state){case f.Idle:jQuery(u).removeClass("highlight blink");break;case f.Talking:jQuery(u).addClass("highlight").removeClass("blink");break;default:jQuery(u).addClass("highlight blink")}s(t.inConference)};t.events.incomingcall=function(n){i.log("PhoneBar.Media.Spc","Debug","Incoming call on line",n.line)};t.events.ringing=function(n){if(i.log("PhoneBar.Media.Spc","Debug","Line",n.line,"is ringing;",n.rings,"ring(s)"),i.options.autoAnswerPhone()){var t=0,u=a();t=u===null?3:u.callId<32768?2:1;t<=i.options.autoAnswerPhone()&&n.rings>i.options.autoAnswerRings()&&(i.log("PhoneBar.Media.Spc","Debug","Attempting autoanswer on line",n.line),r.answer())}};t.events.mute=function(t){i.log("PhoneBar.Media.Spc","Debug","Microphone",t.isMuted?"ON":"OFF");t.isMuted?(jQuery(n.MicrophoneOffButton).hide(),jQuery(n.MicrophoneOnButton).show()):(jQuery(n.MicrophoneOnButton).hide(),jQuery(n.MicrophoneOffButton).show())};t.events.displayname=function(n){i.log("PhoneBar.Media.Spc","Debug","Got displayname",n.displayName,"for incoming call on line",n.line)};t.events.calling=function(n){i.log("PhoneBar.Media.Spc","Debug","Call on line",n.line,"in progress")};t.events.callconnected=function(n){i.log("PhoneBar.Media.Spc","Debug","Call connected on line",n.line)};t.events.calldisconnected=function(n){i.log("PhoneBar.Media.Spc","Debug","Call disconnected on line",n.line,"wasByed:",n.wasByed,"wasCanceled:",n.wasCanceled,"sipCode:",n.sipCode,"sipCause:",n.sipCause)};t.events.vumeter=function(t){jQuery(n.SpeakersVUMeter).val(t.speakers);jQuery(n.MicrophoneVUMeter).val(t.microphone)}}function f(t){jQuery('[class^="phonebar-phone"]').show();jQuery(n.PhoneDialPad+", "+n.HideDialPadButton).hide();jQuery(n.ShowDialPadButton).disable();jQuery(n.PickupButton+", "+n.LeaveConferenceButton).hide().disable();jQuery(n.HangupButton+", "+n.FlashButton+", "+n.ManualTransferButton).disable();jQuery(n.MicrophoneOnButton).hide().enabled(t);jQuery(n.MicrophoneOffButton+", "+n.Line1Button+", "+n.Line2Button+", "+n.EnterConferenceButton).enabled(t);t?(e(),jQuery(n.ShowDialPadButton).enable()):(jQuery(n.Line1Button+", "+n.Line2Button).removeClass("selected"),jQuery(n.PhoneDialPad+", "+n.HideDialPadButton).hide(),jQuery(n.HideDialPadButton+", "+n.ShowDialPadButton).disable(),jQuery('[class^="phonebar-phone-key"]').disable())}function e(){var i=Ifm.SoftPhone.LineStates,r=t.lines[t.selectedLine];switch(r.state){case i.IncomingCall:jQuery(n.HangupButton).hide().disable();jQuery(n.PickupButton).show().enable();break;case i.Calling:case i.Talking:jQuery(n.PickupButton).hide().disable();jQuery(n.HangupButton).show().enable();break;default:jQuery(n.PickupButton).hide().disable();jQuery(n.HangupButton).show().disable()}jQuery(n.FlashButton).enabled(r.state===i.Talking&&!t.inConference);r.state===i.Talking?jQuery('[class^="phonebar-phone-key"]').enable():jQuery('[class^="phonebar-phone-key"]').disable()}function s(t){t?(jQuery(n.EnterConferenceButton).hide().disable(),jQuery(n.LeaveConferenceButton).show().enable()):(jQuery(n.LeaveConferenceButton).hide().disable(),jQuery(n.EnterConferenceButton).show().disable(),l()&&jQuery(n.EnterConferenceButton).enable())}function l(){var n=Ifm.SoftPhone.LineStates,i=t.lines[0],r=t.lines[1];return i.state===n.Talking&&r.state===n.Talking}function a(){return i.calls(function(n){return n.mediatype===Ifm.PhoneBar.Mediatypes.Voice})[0]||null}var r={},i,t,u,n,o;return r.initialize=function(e,s,l){r.initialize=function(){};i=e;u=s;t=Ifm.SoftPhone.instance;n=Ifm.PhoneBar.UI.Elements;o=Ifm.PhoneBar.Strings[i.language()];r.softphone=t;t.initialize();f(!1);c();l&&l.useDefaultUI&&h()},r.connect=function(){var n;n=u.service?u:{service:i.connection._getConnection().getAddress()};t.connect(n)},r.disconnect=function(){t.disconnect()},r.register=function(){var n=u.domain,r=i.agent.extension;if(t.isRegistered&&t.domain===n&&t.extension===r){i.log("PhoneBar.Media.Spc","Info","SoftPhone already registered");return}n?r?(i.log("PhoneBar.Media.Spc","Info","Registering SoftPhone to",n,r),t.register(n,r)):i.log("PhoneBar.Media.Spc","Warn","Can't register without an extension specified"):i.log("PhoneBar.Media.Spc","Warn","Can't register without a domain specified")},r.unregister=function(){i.log("PhoneBar.Media.Spc","Debug","Unregistering SoftPhone")},r.selectLine=function(n){i.log("PhoneBar.Media.Spc","Debug","Selecting line",n);t.selectLine(n)},r.answer=function(){i.log("PhoneBar.Media.Spc","Debug","Answering on line",t.selectedLine);t.answer()},r.dial=function(n){n===undefined&&(n=jQuery(el.NumberInput).val());var r=Ifm.SoftPhone.LineStates,u=t.lines[t.selectedLine];u.state===r.IncomingCall?i.log("PhoneBar.Media.Spc","Info","Can't dial, incoming call on line",t.selectedLine):u.state===r.Idle?(i.log("PhoneBar.Media.Spc","Debug","Dialing number",n,"on line",t.selectedLine),t.dial(n)):(i.log("PhoneBar.Media.Spc","Debug","Dialing digits",n,"on line",t.selectedLine),t.sendDigits(n))},r.digits=function(n){if(n!==undefined){var r=Ifm.SoftPhone.LineStates,u=t.lines[t.selectedLine];u.state===r.Talking&&(i.log("PhoneBar.Media.Spc","Debug","Sending digits",n,"on line",t.selectedLine),t.sendDigits(n))}},r.drop=function(){i.log("PhoneBar.Media.Spc","Debug","Dropping on line",t.selectedLine);t.drop()},r.enterConference=function(){i.log("PhoneBar.Media.Spc","Debug","Entering conference");t.enterConference()},r.leaveConference=function(){i.log("PhoneBar.Media.Spc","Debug","Leaving conference");t.leaveConference()},r.mute=function(){i.log("PhoneBar.Media.Spc","Debug","Muting microphone");t.setMute(!0)},r.unmute=function(){i.log("PhoneBar.Media.Spc","Debug","Unmuting microphone");t.setMute(!1)},r}()}();