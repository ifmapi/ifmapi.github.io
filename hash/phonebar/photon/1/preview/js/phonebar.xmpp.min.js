
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";function buildCandy(jQueryCandyInstance=jQuery){var Candy=function(self,$){return self.about={name:"Candy",version:"1.10.0"},self.init=function(service,options,chatContainer="#candy"){options.viewClass||(options.viewClass=self.View);options.viewClass.init($(chatContainer),options.view);self.Core.init(service,options.core)},self}(Candy||{},jQueryCandyInstance);Candy.Core=function(self,Strophe,$){var _connection=null,_service=null,_user=null,_rooms={},_anonymousConnection=!1,_status,_options={autojoin:undefined,disconnectWithoutTabs:!0,debug:!1,disableWindowUnload:!1,presencePriority:1,resource:Candy.about.name},_addNamespace=function(name,value){Strophe.addNamespace(name,value)},_addNamespaces=function(){_addNamespace("PRIVATE","jabber:iq:private");_addNamespace("BOOKMARKS","storage:bookmarks");_addNamespace("PRIVACY","jabber:iq:privacy");_addNamespace("DELAY","jabber:x:delay");_addNamespace("PUBSUB","http://jabber.org/protocol/pubsub")},_getEscapedJidFromJid=function(jid){var node=Strophe.getNodeFromJid(jid),domain=Strophe.getDomainFromJid(jid);return node?Strophe.escapeNode(node)+"@"+domain:domain},_clearCache=function(){var jid=Candy.Core.getConnection().jid;jid&&window.sessionStorage.removeItem("candy-cache-"+jid)},_updateCache=function(){var jid=Candy.Core.getConnection().jid;jid&&_user&&window.sessionStorage.setItem("candy-cache-"+jid,JSON.stringify({nick:_user.getNick(),rooms:_rooms}))};return self.init=function(service,options){_service=service;$.extend(!0,_options,options);_options.debug&&(self.debug=_options.debug.toString().indexOf("verbose")>-1?function(){var args=[];args.push("[Debug]");args.push("[Candy]");Array.prototype.push.apply(args,arguments);console.debug.apply(console,args)}:function(){},self.xml=_options.debug.toString().indexOf("xml")>-1?function(info,data){data=$.parseXML(data);info?console.debug(info,data):console.debug(data)}:function(){},self.log=function(){var args=[];args.push("[Info]");args.push("[Candy]");Array.prototype.push.apply(args,arguments);console.log.apply(console,args)},Strophe.log=function(level){var level_name,console_level,args;switch(level){case Strophe.LogLevel.DEBUG:if(_options.debug.toString().indexOf("http")>=0)level_name="Debug",console_level="debug";else return;break;case Strophe.LogLevel.INFO:level_name="Info";console_level="log";break;case Strophe.LogLevel.WARN:level_name="WARN";console_level="warn";break;case Strophe.LogLevel.ERROR:level_name="ERROR";console_level="error";break;case Strophe.LogLevel.FATAL:level_name="FATAL";console_level="error"}args=Array.prototype.slice.call(arguments,1);args.unshift("[Strophe]","["+level_name+"]");try{console[console_level].apply(console,args)}catch(error){}},self.debug("[Init] Debugging enabled"));_addNamespaces();_connection=new Strophe.Connection(_service,{keepalive:!0,mechanisms:[Strophe.SASLAnonymous]});_connection.rawInput=self.rawInput.bind(self);_connection.rawOutput=self.rawOutput.bind(self);_connection.caps.node="https://candy-chat.github.io/candy/";_options.disableWindowUnload||(window.onbeforeunload=self.onWindowUnload)},self.registerEventHandlers=function(){self.addHandler(self.Event.Jabber.Version,Strophe.NS.VERSION,"iq");self.addHandler(self.Event.Jabber.Presence,null,"presence");self.addHandler(self.Event.Jabber.Message,null,"message");self.addHandler(self.Event.Jabber.Bookmarks,Strophe.NS.PRIVATE,"iq");self.addHandler(self.Event.Jabber.Room.Disco,Strophe.NS.DISCO_INFO,"iq","result")},self.connect=function(jidOrHost,password,nick){var session,cache,roomJid,room;if(_connection.reset(),self.registerEventHandlers(),$(Candy).triggerHandler("candy:core.before-connect",{connection:_connection}),_connection.isRestoreSupported()){if(_connection.isRestorable(null,90)){this.debug("Restoring session");session=_connection.restore(null,Candy.Core.Event.Strophe.Connect);this.debug("Restoring cache");try{if(cache=JSON.parse(window.sessionStorage.getItem("candy-cache-"+session.jid)),typeof cache!=typeof undefined&&cache!==null){_user=new self.ChatUser(session.jid,cache.nick||nick||Strophe.getNodeFromJid(session.jid));for(roomJid in cache.rooms)room=new Candy.Core.ChatRoom(roomJid),room.setUser(Candy.Core.getUser()),_rooms[roomJid]=room,Candy.Core.Action.Jabber.Room.Disco(roomJid),Candies.getRoomHistory(roomJid)}else this.log("No restorable cache")}catch(e){this.log("Invalid cache content");this.log(e);_clearCache()}return}this.log("No restorable session");_clearCache()}else this.debug("Sessions not restorable in this configuration");_anonymousConnection=_anonymousConnection?!0:jidOrHost&&jidOrHost.indexOf("@")<0;jidOrHost&&password?(_connection.connect(_getEscapedJidFromJid(jidOrHost)+"/"+_options.resource,password,Candy.Core.Event.Strophe.Connect),_user=nick?new self.ChatUser(jidOrHost,nick):new self.ChatUser(jidOrHost,Strophe.getNodeFromJid(jidOrHost))):jidOrHost&&nick?(_connection.connect(_getEscapedJidFromJid(jidOrHost)+"/"+_options.resource,null,Candy.Core.Event.Strophe.Connect),_user=new self.ChatUser(null,nick)):jidOrHost?Candy.Core.Event.Login(jidOrHost):Candy.Core.Event.Login()},self.attach=function(jid,sid,rid){_user=new self.ChatUser(jid,Strophe.getNodeFromJid(jid));self.registerEventHandlers();_connection.attach(jid,sid,rid,Candy.Core.Event.Strophe.Connect)},self.disconnect=function(){_connection.connected&&(_clearCache(),$.each(self.getRooms(),function(){Candy.Core.Action.Jabber.Room.Leave(this.getJid())}),_connection.disconnect())},self.addHandler=function(handler,ns,name,type,id,from,options){return _connection.addHandler(handler,ns,name,type,id,from,options)},self.getUser=function(){return _user},self.setUser=function(user){_user=user;_updateCache()},self.getConnection=function(){return _connection},self.removeRoom=function(roomJid){delete _rooms[roomJid]},self.getRooms=function(){return _rooms},self.getStropheStatus=function(){return _status},self.setStropheStatus=function(status){_status=status},self.isAnonymousConnection=function(){return _anonymousConnection},self.getOptions=function(){return _options},self.getRoom=function(roomJid){return _rooms[roomJid]?_rooms[roomJid]:null},self.onWindowUnload=function(){return;var retry},self.rawInput=function(data){this.xml("RECV:",data)},self.rawOutput=function(data){this.xml("SENT:",data)},self.clearCache=function(){_clearCache()},self.updateCache=function(){_updateCache()},self.debug=function(){},self.log=function(){},self.xml=function(){},self}(Candy.Core||{},Strophe,jQueryCandyInstance);Candy.View=function(self,$){var _current={container:null,roomJid:null},_options={language:"en",assets:"res/",messages:{limit:2e3,remove:500},crop:{message:{nickname:15,body:1e3},roster:{nickname:15}},enableXHTML:!1},_setupTranslation=function(language){$.i18n.load(self.Translation[language])},_registerObservers=function(){$(Candy).on("candy:core.chat.connection",self.Observer.Chat.Connection);$(Candy).on("candy:core.chat.message",self.Observer.Chat.Message);$(Candy).on("candy:core.login",self.Observer.Login);$(Candy).on("candy:core.autojoin-missing",self.Observer.AutojoinMissing);$(Candy).on("candy:core.presence",self.Observer.Presence.update);$(Candy).on("candy:core.presence.leave",self.Observer.Presence.update);$(Candy).on("candy:core.presence.room",self.Observer.Presence.update);$(Candy).on("candy:core.presence.error",self.Observer.PresenceError);$(Candy).on("candy:core.message",self.Observer.Message)},_registerWindowHandlers=function(){Candy.Util.getIeVersion()<9?$(document).focusin(Candy.View.Pane.Window.onFocus).focusout(Candy.View.Pane.Window.onBlur):$(window).focus(Candy.View.Pane.Window.onFocus).blur(Candy.View.Pane.Window.onBlur);$(window).resize(Candy.View.Pane.Chat.fitTabs)},_initToolbar=function(){self.Pane.Chat.Toolbar.init()},_delegateTooltips=function(){$("body").delegate("li[data-tooltip]","mouseenter",Candy.View.Pane.Chat.Tooltip.show)};return self.init=function(container,options){options.resources&&(options.assets=options.resources,delete options.resources);$.extend(!0,_options,options);_setupTranslation(_options.language);Candy.Util.Parser.setEmoticonPath("img/emoticons/");_current.container=container;_current.container.html(Mustache.to_html(Candy.View.Template.Chat.pane,{tooltipEmoticons:$.i18n._("tooltipEmoticons"),tooltipSound:$.i18n._("tooltipSound"),tooltipAutoscroll:$.i18n._("tooltipAutoscroll"),tooltipStatusmessage:$.i18n._("tooltipStatusmessage"),tooltipAdministration:$.i18n._("tooltipAdministration"),tooltipUsercount:$.i18n._("tooltipUsercount")},{tabs:Candy.View.Template.Chat.tabs,rooms:Candy.View.Template.Chat.rooms,modal:Candy.View.Template.Chat.modal,toolbar:Candy.View.Template.Chat.toolbar}));_registerWindowHandlers();_initToolbar();_registerObservers();_delegateTooltips()},self.getCurrent=function(){return _current},self.getOptions=function(){return _options},self}(Candy.View||{},jQueryCandyInstance);Candy.Util=function(self,$){self.jidToId=function(jid){return MD5.hexdigest(jid)};self.escapeJid=function(jid){var node=Strophe.escapeNode(Strophe.getNodeFromJid(jid)),domain=Strophe.getDomainFromJid(jid),resource=Strophe.getResourceFromJid(jid);return jid=node+"@"+domain,resource&&(jid+="/"+resource),jid};self.unescapeJid=function(jid){var node=Strophe.unescapeNode(Strophe.getNodeFromJid(jid)),domain=Strophe.getDomainFromJid(jid),resource=Strophe.getResourceFromJid(jid);return jid=node+"@"+domain,resource&&(jid+="/"+resource),jid};self.crop=function(str,len){return str.length>len&&(str=str.substr(0,len-3)+"..."),str};self.getDisplayName=function(nick){var name=Strophe.unescapeNode(nick);return name.lastIndexOf("_")>0?name.substring(0,name.lastIndexOf("_")):name};self.parseAndCropXhtml=function(str,len){return $("<div/>").append(self.createHtml($(str).get(0),len)).html()};self.setCookie=function(name,value,lifetime_days){var exp=new Date;exp.setDate(exp.getDate()+lifetime_days);document.cookie=name+"="+value+";expires="+exp.toUTCString()+";path=/"};self.cookieExists=function(name){return document.cookie.indexOf(name)>-1};self.getCookie=function(name){if(document.cookie){var regex=new RegExp(escape(name)+"=([^;]*)","gm"),matches=regex.exec(document.cookie);if(matches)return matches[1]}};self.deleteCookie=function(name){document.cookie=name+"=;expires=Thu, 01-Jan-70 00:00:01 GMT;path=/"};self.getPosLeftAccordingToWindowBounds=function(elem,pos){var windowWidth=$(document).width(),elemWidth=elem.outerWidth(),marginDiff=elemWidth-elem.outerWidth(!0),backgroundPositionAlignment="left",parentOffset=$(document).find("#candy").length>0?$("#candy").offset().left:0;return pos+elemWidth>=windowWidth&&(pos-=elemWidth-marginDiff,backgroundPositionAlignment="right"),{px:pos-parentOffset,backgroundPositionAlignment:backgroundPositionAlignment}};self.getPosTopAccordingToWindowBounds=function(elem,pos){var windowHeight=$(document).height(),elemHeight=elem.outerHeight(),marginDiff=elemHeight-elem.outerHeight(!0),backgroundPositionAlignment="top",parentOffset=$(document).find("#candy").length>0?$("#candy").offset().top:0;return pos+elemHeight>=windowHeight&&(pos-=elemHeight-marginDiff,backgroundPositionAlignment="bottom"),{px:pos-parentOffset,backgroundPositionAlignment:backgroundPositionAlignment}};self.localizedTime=function(dateTime){if(dateTime===undefined)return undefined;var date=self.iso8601toDate(dateTime);return date.toDateString()===(new Date).toDateString()?date.format($.i18n._("timeFormat")):date.format($.i18n._("dateFormat"))};self.iso8601toDate=function(date){var timestamp=Date.parse(date),struct,minutesOffset;if(isNaN(timestamp)){if(struct=/^(\d{4}|[+\-]\d{6})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?))?/.exec(date),struct)return minutesOffset=0,struct[8]!=="Z"&&(minutesOffset=+struct[10]*60+ +struct[11],struct[9]==="+"&&(minutesOffset=-minutesOffset)),minutesOffset-=(new Date).getTimezoneOffset(),new Date(+struct[1],+struct[2]-1,+struct[3],+struct[4],+struct[5]+minutesOffset,+struct[6],struct[7]?+struct[7].substr(0,3):0);timestamp=Date.parse(date.replace(/^(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")+"Z")}return new Date(timestamp)};self.isEmptyObject=function(obj){for(var prop in obj)if(obj.hasOwnProperty(prop))return!1;return!0};self.forceRedraw=function(elem){elem.css({display:"none"});setTimeout(function(){this.css({display:"block"})}.bind(elem),1)};var ie=function(){for(var undef,v=3,div=document.createElement("div"),all=div.getElementsByTagName("i");div.innerHTML="<!--[if gt IE "+ ++v+"]><i><\/i><![endif]-->",all[0];);return v>4?v:undef}();return self.getIeVersion=function(){return ie},self.Parser={_emoticonPath:"",setEmoticonPath:function(path){Candy.View.getOptions().assets&&(this._emoticonPath=Candy.View.getOptions().assets+path)},emoticons:[{plain:":)",regex:/((\s):-?\)|:-?\)(\s|$))/gm,image:"Smiling.png"},{plain:";)",regex:/((\s);-?\)|;-?\)(\s|$))/gm,image:"Winking.png"},{plain:":D",regex:/((\s):-?D|:-?D(\s|$))/gm,image:"Grinning.png"},{plain:"XD",regex:/((\s)XD|XD(\s|$))/gm,image:"Laughing.png"},{plain:":(",regex:/((\s):-?\(|:-?\((\s|$))/gm,image:"Unhappy.png"},{plain:"^^",regex:/((\s)\^\^|\^\^(\s|$))/gm,image:"Happy.png"},{plain:":P",regex:/((\s):-?P|:-?P(\s|$))/igm,image:"Tease.png"},{plain:";P",regex:/((\s);-?P|;-?P(\s|$))/igm,image:"Tongue_Out_Winking.png"},{plain:":S",regex:/((\s):-?S|:-?S(\s|$))/igm,image:"Confused.png"},{plain:":/",regex:/((\s):-?\/|:-?\/(\s|$))/gm,image:"Uncertain.png"},{plain:"8)",regex:/((\s)8-?\)|8-?\)(\s|$))/gm,image:"Cool.png"},{plain:":OK:",regex:/((\s):OK:|:OK:(\s|$))/gm,image:"Thumb_Up.png"},{plain:"oO",regex:/((\s)oO|oO(\s|$))/gm,image:"Huh.png"},{plain:":x",regex:/((\s):x|:x(\s|$))/gm,image:"Lips_Sealed.png"},{plain:":666:",regex:/((\s):666:|:666:(\s|$))/gm,image:"Devil.png"},{plain:"<3",regex:/((\s)&lt;3|&lt;3(\s|$))/gm,image:"Heart.png"}],emotify:function(text){if(!Candy.View.getOptions().assets)return text;for(var i=this.emoticons.length-1;i>=0;i--)text=text.replace(this.emoticons[i].regex,'$2<img class="emoticon" alt="$1" src="'+this._emoticonPath+this.emoticons[i].image+'" />$3');return text},linkify:function(text){return text=text.replace(/(^|[^\/])(www\.[^\.]+\.[\S]+(\b|$))/gi,"$1http://$2"),text.replace(/(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/ig,'<a href="$1" target="_blank">$1<\/a>')},escape:function(text){return $("<div/>").text(text).html()},nl2br:function(text){return text.replace(/\r\n|\r|\n/g,"<br />")},all:function(text){return text&&(text=this.escape(text),text=this.linkify(text),text=this.emotify(text),text=this.nl2br(text)),text}},self.createHtml=function(elem,maxLength,currentLength){var i,el,j,tag,attribute,value,css,cssAttrs,attr,cssName,cssValue,text;if(currentLength=currentLength||0,elem.nodeType===Strophe.ElementType.NORMAL)if(tag=elem.nodeName.toLowerCase(),Strophe.XHTML.validTag(tag))try{for(el=$("<"+tag+"/>"),i=0;i<Strophe.XHTML.attributes[tag].length;i++)if(attribute=Strophe.XHTML.attributes[tag][i],value=elem.getAttribute(attribute),typeof value!="undefined"&&value!==null&&value!==""&&value!==!1&&value!==0)if(attribute==="style"&&typeof value=="object"&&typeof value.cssText!="undefined"&&(value=value.cssText),attribute==="style"){for(css=[],cssAttrs=value.split(";"),j=0;j<cssAttrs.length;j++)attr=cssAttrs[j].split(":"),cssName=attr[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),Strophe.XHTML.validCSS(cssName)&&(cssValue=attr[1].replace(/^\s*/,"").replace(/\s*$/,""),css.push(cssName+": "+cssValue));css.length>0&&(value=css.join("; "),el.attr(attribute,value))}else el.attr(attribute,value);for(i=0;i<elem.childNodes.length;i++)el.append(self.createHtml(elem.childNodes[i],maxLength,currentLength))}catch(e){Candy.Core.log("[Util:createHtml] Error while parsing XHTML:");Candy.Core.log(e);el=Strophe.xmlTextNode("")}else for(el=Strophe.xmlGenerator().createDocumentFragment(),i=0;i<elem.childNodes.length;i++)el.appendChild(self.createHtml(elem.childNodes[i],maxLength,currentLength));else if(elem.nodeType===Strophe.ElementType.FRAGMENT)for(el=Strophe.xmlGenerator().createDocumentFragment(),i=0;i<elem.childNodes.length;i++)el.appendChild(self.createHtml(elem.childNodes[i],maxLength,currentLength));else elem.nodeType===Strophe.ElementType.TEXT&&(text=elem.nodeValue,currentLength+=text.length,maxLength&&currentLength>maxLength&&(text=text.substring(0,maxLength)),text=Candy.Util.Parser.all(text),el=$.parseHTML(text));return el},self}(Candy.Util||{},jQueryCandyInstance);Candy.Core.Action=function(self,Strophe,$){return self.Jabber={Version:function(msg){Candy.Core.getConnection().sendIQ($iq({type:"result",to:Candy.Util.escapeJid(msg.attr("from")),from:Candy.Util.escapeJid(msg.attr("to")),id:msg.attr("id")}).c("query",{name:Candy.about.name,version:Candy.about.version,os:navigator.userAgent}))},SetNickname:function(nickname,rooms){rooms=rooms instanceof Array?rooms:Candy.Core.getRooms();var roomNick,presence,conn=Candy.Core.getConnection();$.each(rooms,function(roomJid){roomNick=Candy.Util.escapeJid(roomJid+"/"+nickname);presence=$pres({to:roomNick,from:conn.jid,id:"pres:"+conn.getUniqueId()});Candy.Core.getConnection().send(presence)})},Roster:function(){Candy.Core.getConnection().sendIQ($iq({type:"get",xmlns:Strophe.NS.CLIENT}).c("query",{xmlns:Strophe.NS.ROSTER}).tree())},Presence:function(attr,el){var conn=Candy.Core.getConnection(),pres;attr=attr||{};attr.id||(attr.id="pres:"+conn.getUniqueId());pres=$pres(attr).c("priority").t(Candy.Core.getOptions().presencePriority.toString()).up().c("c",conn.caps.generateCapsAttrs()).up();el&&pres.node.appendChild(el.node);conn.send(pres.tree())},Services:function(){Candy.Core.getConnection().sendIQ($iq({type:"get",xmlns:Strophe.NS.CLIENT}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}).tree())},Autojoin:function(){if(Candy.Core.getOptions().autojoin===!0){Candy.Core.getConnection().sendIQ($iq({type:"get",xmlns:Strophe.NS.CLIENT}).c("query",{xmlns:Strophe.NS.PRIVATE}).c("storage",{xmlns:Strophe.NS.BOOKMARKS}).tree());var pubsubBookmarkRequest=Candy.Core.getConnection().getUniqueId("pubsub");Candy.Core.addHandler(Candy.Core.Event.Jabber.Bookmarks,Strophe.NS.PUBSUB,"iq","result",pubsubBookmarkRequest);Candy.Core.getConnection().sendIQ($iq({type:"get",id:pubsubBookmarkRequest}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("items",{node:Strophe.NS.BOOKMARKS}).tree())}else $.isArray(Candy.Core.getOptions().autojoin)?$.each(Candy.Core.getOptions().autojoin,function(){self.Jabber.Room.Join.apply(null,this.valueOf().split(":",2))}):$(Candy).triggerHandler("candy:core.autojoin-missing")},ResetIgnoreList:function(){Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:Strophe.NS.PRIVACY}).c("list",{name:"ignore"}).c("item",{action:"allow",order:"0"}).tree())},RemoveIgnoreList:function(){Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:Strophe.NS.PRIVACY}).c("list",{name:"ignore"}).tree())},GetIgnoreList:function(){var iq=$iq({type:"get",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:Strophe.NS.PRIVACY}).c("list",{name:"ignore"}).tree(),iqId=Candy.Core.getConnection().sendIQ(iq);Candy.Core.addHandler(Candy.Core.Event.Jabber.PrivacyList,null,"iq",null,iqId)},SetIgnoreListActive:function(){Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid()}).c("query",{xmlns:Strophe.NS.PRIVACY}).c("active",{name:"ignore"}).tree())},GetJidIfAnonymous:function(){Candy.Core.getUser().getJid()||(Candy.Core.debug("[Jabber] Anonymous login"),Candy.Core.getUser().data.jid=Candy.Core.getConnection().jid)},Room:{Join:function(roomJid,password){self.Jabber.Room.Disco(roomJid);roomJid=Candy.Util.escapeJid(roomJid);var conn=Candy.Core.getConnection(),roomNick=roomJid+"/"+Candy.Core.getUser().getNick(),pres=$pres({to:roomNick,id:"pres:"+conn.getUniqueId()}).c("x",{xmlns:Strophe.NS.MUC});password&&pres.c("password").t(password);pres.up().c("c",conn.caps.generateCapsAttrs());conn.send(pres.tree())},Leave:function(roomJid){var room=Candy.Core.getRoom(roomJid),user;room&&(user=room.getUser(),user&&(roomJid=Candy.Util.escapeJid(roomJid),Candy.Core.getConnection().muc.leave(roomJid,user.getNick(),function(){})))},Disco:function(roomJid){Candy.Core.getConnection().sendIQ($iq({type:"get",from:Candy.Core.getUser().getEscapedJid(),to:Candy.Util.escapeJid(roomJid)}).c("query",{xmlns:Strophe.NS.DISCO_INFO}).tree())},Message:function(roomJid,msg,type,xhtmlMsg){if(msg=$.trim(msg),msg==="")return!1;var nick=null;return type==="chat"&&(nick=Strophe.getResourceFromJid(roomJid),roomJid=Strophe.getBareJidFromJid(roomJid)),Candy.Core.getConnection().muc.message(roomJid,nick,msg,xhtmlMsg,type),!0},Invite:function(roomJid,invitees,reason,password){reason=$.trim(reason);var message=$msg({to:roomJid}),x=message.c("x",{xmlns:Strophe.NS.MUC_USER});$.each(invitees,function(i,invitee){invitee=Strophe.getBareJidFromJid(invitee);x.c("invite",{to:invitee});typeof reason!="undefined"&&reason!==""&&x.c("reason",reason)});typeof password!="undefined"&&password!==""&&x.c("password",password);Candy.Core.getConnection().send(message)},IgnoreUnignore:function(userJid){Candy.Core.getUser().addToOrRemoveFromPrivacyList("ignore",userJid);Candy.Core.Action.Jabber.Room.UpdatePrivacyList()},UpdatePrivacyList:function(){var currentUser=Candy.Core.getUser(),iq=$iq({type:"set",from:currentUser.getEscapedJid()}).c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"ignore"}),privacyList=currentUser.getPrivacyList("ignore");privacyList.length>0?$.each(privacyList,function(index,jid){iq.c("item",{type:"jid",value:Candy.Util.escapeJid(jid),action:"deny",order:index}).c("message").up().up()}):iq.c("item",{action:"allow",order:"0"});Candy.Core.getConnection().sendIQ(iq.tree())},Admin:{UserAction:function(roomJid,userJid,type,reason){roomJid=Candy.Util.escapeJid(roomJid);userJid=Candy.Util.escapeJid(userJid);var itemObj={nick:Strophe.getResourceFromJid(userJid)};switch(type){case"kick":itemObj.role="none";break;case"ban":itemObj.affiliation="outcast";break;default:return!1}return Candy.Core.getConnection().sendIQ($iq({type:"set",from:Candy.Core.getUser().getEscapedJid(),to:roomJid}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).c("item",itemObj).c("reason").t(reason).tree()),!0},SetSubject:function(roomJid,subject){Candy.Core.getConnection().muc.setTopic(Candy.Util.escapeJid(roomJid),subject)}}}},self}(Candy.Core.Action||{},Strophe,jQueryCandyInstance);Candy.Core.ChatRoom=function(roomJid){this.room={jid:roomJid,name:Strophe.getNodeFromJid(roomJid)};this.user=null;this.roster=new Candy.Core.ChatRoster;this.setUser=function(user){this.user=user;Candy.Core.updateCache()};this.getUser=function(){return this.user};this.getJid=function(){return this.room.jid};this.setName=function(name){this.room.name=name;Candy.Core.updateCache()};this.getName=function(){return this.room.name};this.setRoster=function(roster){this.roster=roster;Candy.Core.updateCache()};this.getRoster=function(){return this.roster}};Candy.Core.ChatRoster=function(){this.items={};this.add=function(user){this.items[user.getJid()]=user};this.remove=function(jid){delete this.items[jid]};this.get=function(jid){return this.items[jid]};this.getAll=function(){return this.items}};Candy.Core.ChatUser=function(jid,nick,affiliation,role){this.ROLE_MODERATOR="moderator";this.AFFILIATION_OWNER="owner";this.data={jid:jid,nick:Strophe.unescapeNode(nick),affiliation:affiliation,role:role,privacyLists:{},customData:{},previousNick:undefined};this.getJid=function(){if(this.data.jid)return Candy.Util.unescapeJid(this.data.jid)};this.getEscapedJid=function(){return Candy.Util.escapeJid(this.data.jid)};this.setJid=function(jid){this.data.jid=jid};this.getNick=function(display){var name=Strophe.unescapeNode(this.data.nick);return display&&name.lastIndexOf("_")>0?name.substring(0,name.lastIndexOf("_")):name};this.setNick=function(nick){this.data.nick=nick};this.getRole=function(){return this.data.role};this.setRole=function(role){this.data.role=role};this.setAffiliation=function(affiliation){this.data.affiliation=affiliation};this.getAffiliation=function(){return this.data.affiliation};this.isModerator=function(){return this.getRole()===this.ROLE_MODERATOR||this.getAffiliation()===this.AFFILIATION_OWNER};this.addToOrRemoveFromPrivacyList=function(list,jid){this.data.privacyLists[list]||(this.data.privacyLists[list]=[]);var index=-1;return(index=this.data.privacyLists[list].indexOf(jid))!==-1?this.data.privacyLists[list].splice(index,1):this.data.privacyLists[list].push(jid),this.data.privacyLists[list]};this.getPrivacyList=function(list){return this.data.privacyLists[list]||(this.data.privacyLists[list]=[]),this.data.privacyLists[list]};this.setPrivacyLists=function(lists){this.data.privacyLists=lists};this.isInPrivacyList=function(list,jid){return this.data.privacyLists[list]?this.data.privacyLists[list].indexOf(jid)!==-1:!1};this.setCustomData=function(data){this.data.customData=data};this.getCustomData=function(){return this.data.customData};this.setPreviousNick=function(previousNick){this.data.previousNick=previousNick};this.getPreviousNick=function(){return this.data.previousNick}};Candy.Core.Event=function(self,Strophe,$){return self.Login=function(presetJid){$(Candy).triggerHandler("candy:core.login",{presetJid:presetJid})},self.Strophe={Connect:function(status){Candy.Core.setStropheStatus(status);switch(status){case Strophe.Status.CONNECTED:Candy.Core.log("[Connection] Connected");Candy.Core.Action.Jabber.GetJidIfAnonymous();Candy.Core.updateCache();case Strophe.Status.ATTACHED:Candy.Core.log("[Connection] Attached");Candy.Core.Action.Jabber.Presence();break;case Strophe.Status.DISCONNECTED:Candy.Core.log("[Connection] Disconnected");break;case Strophe.Status.AUTHFAIL:Candy.Core.log("[Connection] Authentication failed");Candy.Core.clearCache();break;case Strophe.Status.CONNECTING:Candy.Core.log("[Connection] Connecting");break;case Strophe.Status.DISCONNECTING:Candy.Core.log("[Connection] Disconnecting");Candy.Core.clearCache();break;case Strophe.Status.AUTHENTICATING:Candy.Core.log("[Connection] Authenticating");break;case Strophe.Status.ERROR:case Strophe.Status.CONNFAIL:Candy.Core.log("[Connection] Failed ("+status+")");Candy.Core.clearCache();break;default:Candy.Core.log("[Connection] What?!");Candy.Core.clearCache()}$(Candy).triggerHandler("candy:core.chat.connection",{status:status})}},self.Jabber={Version:function(msg){return Candy.Core.debug("[Jabber] Version"),Candy.Core.Action.Jabber.Version($(msg)),!0},Presence:function(msg){return Candy.Core.debug("[Jabber] Presence"),msg=$(msg),msg.children('x[xmlns^="'+Strophe.NS.MUC+'"]').length>0?msg.attr("type")==="error"?self.Jabber.Room.PresenceError(msg):self.Jabber.Room.Presence(msg):$(Candy).triggerHandler("candy:core.presence",{from:msg.attr("from"),stanza:msg}),!0},Bookmarks:function(msg){return Candy.Core.debug("[Jabber] Bookmarks"),$("conference",msg).each(function(){var item=$(this);item.attr("autojoin")&&Candy.Core.Action.Jabber.Room.Join(item.attr("jid"))}),!0},PrivacyList:function(msg){Candy.Core.debug("[Jabber] PrivacyList");var currentUser=Candy.Core.getUser();return(msg=$(msg),msg.attr("type")==="result")?($('list[name="ignore"] item',msg).each(function(){var item=$(this);item.attr("action")==="deny"&&currentUser.addToOrRemoveFromPrivacyList("ignore",item.attr("value"))}),Candy.Core.Action.Jabber.SetIgnoreListActive(),!1):self.Jabber.PrivacyListError(msg)},PrivacyListError:function(msg){return $('error[code="503"][type="cancel"] service-unavailable',msg)?!1:(Candy.Core.log("[Jabber] PrivacyListError"),$('error[code="404"][type="cancel"] item-not-found',msg)&&(Candy.Core.Action.Jabber.ResetIgnoreList(),Candy.Core.Action.Jabber.SetIgnoreListActive()),!1)},Message:function(msg){var mediatedInvite,directInvite;Candy.Core.debug("[Jabber] Message");msg=$(msg);var fromJid=msg.attr("from"),type=msg.attr("type")||"undefined",toJid=msg.attr("to");if(type==="normal"||type==="undefined"){if(mediatedInvite=msg.find("invite"),directInvite=msg.find('x[xmlns="jabber:x:conference"]'),mediatedInvite.length>0){var passwordNode=msg.find("password"),password=null,continueNode=mediatedInvite.find("continue"),continuedThread=null;passwordNode&&(password=passwordNode.text());continueNode&&(continuedThread=continueNode.attr("thread"));$(Candy).triggerHandler("candy:core:chat:invite",{roomJid:fromJid,from:mediatedInvite.attr("from")||"undefined",reason:mediatedInvite.find("reason")||"",password:password,continuedThread:continuedThread,inviteType:"MediatedInvite"})}return directInvite.length>0&&$(Candy).triggerHandler("candy:core:chat:invite",{roomJid:directInvite.attr("jid"),from:fromJid,reason:directInvite.attr("reason")||"",password:directInvite.attr("password"),continuedThread:directInvite.attr("thread"),inviteType:"DirectInvite"}),$(Candy).triggerHandler("candy:core:chat:message:normal",{type:type||"normal",message:msg}),!0}return type!=="groupchat"&&type!=="chat"&&type!=="error"&&type!=="headline"?($(Candy).triggerHandler("candy:core:chat:message:other",{type:type,message:msg}),!0):(fromJid!==Strophe.getDomainFromJid(fromJid)&&(type==="groupchat"||type==="chat"||type==="error")?self.Jabber.Room.Message(msg):toJid||fromJid!==Strophe.getDomainFromJid(fromJid)?toJid&&fromJid===Strophe.getDomainFromJid(fromJid)&&$(Candy).triggerHandler("candy:core.chat.message.server",{type:type||"message",subject:msg.children("subject").text(),message:msg.children("body").text()}):$(Candy).triggerHandler("candy:core.chat.message.admin",{type:type||"message",message:msg.children("body").text()}),!0)},Room:{Leave:function(msg){var from,roomJid,code,user;if(Candy.Core.debug("[Jabber:Room] Leave"),msg=$(msg),from=Candy.Util.unescapeJid(msg.attr("from")),roomJid=Strophe.getBareJidFromJid(from),!Candy.Core.getRoom(roomJid))return!0;var roomName=Candy.Core.getRoom(roomJid).getName(),item=msg.find("item"),type="leave",reason,actor;return delete Candy.Core.getRooms()[roomJid],Candy.Core.updateCache(),item.attr("role")==="none"&&(code=msg.find("status").attr("code"),code==="307"?type="kick":code==="301"&&(type="ban"),reason=item.find("reason").text(),actor=item.find("actor").attr("jid")),user=new Candy.Core.ChatUser(from,Strophe.getResourceFromJid(from),item.attr("affiliation"),item.attr("role")),$(Candy).triggerHandler("candy:core.presence.leave",{roomJid:roomJid,roomName:roomName,type:type,reason:reason,actor:actor,user:user}),!0},Disco:function(msg){var roomJid,identity,roomName,room;return(Candy.Core.debug("[Jabber:Room] Disco"),msg=$(msg),!msg.find('identity[category="conference"]').length)?!0:(roomJid=Strophe.getBareJidFromJid(Candy.Util.unescapeJid(msg.attr("from"))),Candy.Core.getRooms()[roomJid]||(Candy.Core.getRooms()[roomJid]=new Candy.Core.ChatRoom(roomJid)),identity=msg.find("identity"),identity.length&&(roomName=identity.attr("name"),room=Candy.Core.getRoom(roomJid),room.getName()===null&&room.setName(Strophe.unescapeNode(roomName))),Candy.Core.updateCache(),!0)},Presence:function(msg){var i,l,$status,code,room,currentUser,roster,action,user,nick,item,role,affiliation;Candy.Core.debug("[Jabber:Room] Presence");var from=Candy.Util.unescapeJid(msg.attr("from")),roomJid=Strophe.getBareJidFromJid(from),presenceType=msg.attr("type"),status=msg.find("status"),nickAssign=!1,nickChange=!1;if(status.length)for(i=0,l=status.length;i<l;i++)$status=$(status[i]),code=$status.attr("code"),code==="303"?nickChange=!0:code==="210"&&(nickAssign=!0);return(room=Candy.Core.getRoom(roomJid),room||(Candy.Core.getRooms()[roomJid]=new Candy.Core.ChatRoom(roomJid),room=Candy.Core.getRoom(roomJid)),currentUser=room.getUser()?room.getUser():Candy.Core.getUser(),Strophe.getResourceFromJid(from)===currentUser.getNick()&&presenceType==="unavailable"&&nickChange===!1)?(self.Jabber.Room.Leave(msg),!0):(roster=room.getRoster(),item=msg.find("item"),presenceType!=="unavailable"?roster.get(from)?(user=roster.get(from),role=item.attr("role"),affiliation=item.attr("affiliation"),user.setRole(role),user.setAffiliation(affiliation),action="join"):(nick=Strophe.getResourceFromJid(from),user=new Candy.Core.ChatUser(from,nick,item.attr("affiliation"),item.attr("role")),room.getUser()===null&&(Candy.Core.getUser().getNick()===nick||nickAssign)&&(room.setUser(user),currentUser=user),roster.add(user),action="join"):(user=roster.get(from),roster.remove(from),nickChange?(nick=item.attr("nick"),action="nickchange",user.setPreviousNick(user.getNick()),user.setNick(nick),user.setJid(Strophe.getBareJidFromJid(from)+"/"+nick),roster.add(user)):(action="leave",item.attr("role")==="none"&&(msg.find("status").attr("code")==="307"?action="kick":msg.find("status").attr("code")==="301"&&(action="ban")))),$(Candy).triggerHandler("candy:core.presence.room",{roomJid:roomJid,roomName:room.getName(),user:user,action:action,currentUser:currentUser}),Candy.Core.updateCache(),!0)},PresenceError:function(msg){Candy.Core.log("[Jabber:Room] Presence Error");var from=Candy.Util.unescapeJid(msg.attr("from")),roomJid=Strophe.getBareJidFromJid(from),room=Candy.Core.getRooms()[roomJid],roomName=room&&room.getName()||null;return Candy.Core.removeRoom(roomJid),room=undefined,$(Candy).triggerHandler("candy:core.presence.error",{msg:msg,type:msg.children("error").children()[0].tagName.toLowerCase(),roomJid:roomJid,roomName:roomName}),!0},Message:function(msg){var roomJid,message,name,error,from,chatstate,bareRoomJid,isNoConferenceRoomJid,resource,a,i,xhtmlChild,xhtmlMessage,delay,timestamp;if(Candy.Core.debug("[Jabber:Room] Message"),msg.children("subject").length>0&&msg.children("subject").text().length>0&&msg.attr("type")==="groupchat")roomJid=Candy.Util.unescapeJid(Strophe.getBareJidFromJid(msg.attr("from"))),message={name:Strophe.getNodeFromJid(roomJid),body:msg.children("subject").text(),type:"subject"};else if(msg.attr("type")==="error")error=msg.children("error"),error.children("text").length>0&&(roomJid=msg.attr("from"),message={type:"info",body:error.children("text").text()});else{if(msg.children("composing").length>0||msg.children("inactive").length>0||msg.children("paused").length>0||msg.children("gone").length>0)return from=Candy.Util.unescapeJid(msg.attr("from")),roomJid=Strophe.getBareJidFromJid(from),name=Strophe.getResourceFromJid(from),msg.children("active").length>0?chatstate="active":msg.children("composing").length>0?chatstate="composing":msg.children("paused").length>0?chatstate="paused":msg.children("inactive").length>0?chatstate="inactive":msg.children("gone").length>0&&(chatstate="gone"),$(Candy).triggerHandler("candy:core.message.chatstate",{name:name,displayName:Candy.Util.getDisplayName(name),roomJid:roomJid,chatstate:chatstate}),!0;if(msg.children("body").length>=0){if(msg.attr("type")==="chat"||msg.attr("type")==="normal")roomJid=Candy.Util.unescapeJid(msg.attr("from")),bareRoomJid=Strophe.getBareJidFromJid(roomJid),isNoConferenceRoomJid=!Candy.Core.getRoom(bareRoomJid),name=isNoConferenceRoomJid?Strophe.getNodeFromJid(roomJid):Strophe.getResourceFromJid(roomJid),message={name:name,body:msg.children("body").text(),type:msg.attr("type"),isNoConferenceRoomJid:isNoConferenceRoomJid};else if(roomJid=Candy.Util.unescapeJid(Strophe.getBareJidFromJid(msg.attr("from"))),resource=Strophe.getResourceFromJid(msg.attr("from")),resource)resource=Strophe.unescapeNode(resource),message={name:resource,body:msg.children("body").text(),type:msg.attr("type")};else{if(!Candy.View.Pane.Chat.rooms[msg.attr("from")])return!0;message={name:"",body:msg.children("body").text(),type:"info"}}for(a=[],i=0;i<msg[0].attributes.length;i++)a.push(msg[0].attributes[i]);for(message.attributes={},i=0;i<a.length;i++)message.attributes[a[i].name]=a[i].value;xhtmlChild=msg.children('html[xmlns="'+Strophe.NS.XHTML_IM+'"]');Candy.View.getOptions().enableXHTML===!0&&xhtmlChild.length>0&&(xhtmlMessage=xhtmlChild.children('body[xmlns="'+Strophe.NS.XHTML+'"]').first().html(),message.xhtmlMessage=xhtmlMessage)}else return!0}return delay=msg.children("delay")?msg.children("delay"):msg.children('x[xmlns="'+Strophe.NS.DELAY+'"]'),timestamp=delay!==undefined?delay.attr("stamp"):null,$(Candy).triggerHandler("candy:core.message",{roomJid:roomJid,message:message,timestamp:timestamp}),!0}}},self}(Candy.Core.Event||{},Strophe,jQueryCandyInstance);Candy.View.Observer=function(self,$){var _showConnectedMessageModal=!0;return self.Chat={Connection:function(event,args){var eventName="candy:view.connection.status-"+args.status,presetJid;if($(Candy).triggerHandler(eventName)===!1)return!1;switch(args.status){case Strophe.Status.CONNECTING:case Strophe.Status.AUTHENTICATING:Candy.View.Pane.Chat.Modal.show($.i18n._("statusConnecting"),!1,!0);break;case Strophe.Status.ATTACHED:case Strophe.Status.CONNECTED:_showConnectedMessageModal===!0&&(Candy.View.Pane.Chat.Modal.show($.i18n._("statusConnected")),Candy.View.Pane.Chat.Modal.hide());break;case Strophe.Status.DISCONNECTING:Candy.View.Pane.Chat.Modal.show($.i18n._("statusDisconnecting"),!1,!0);break;case Strophe.Status.DISCONNECTED:presetJid=Candy.Core.isAnonymousConnection()?Strophe.getDomainFromJid(Candy.Core.getUser().getJid()):null;Candy.View.Pane.Chat.Modal.showLoginForm($.i18n._("statusDisconnected"),presetJid);break;case Strophe.Status.AUTHFAIL:Candy.View.Pane.Chat.Modal.showLoginForm($.i18n._("statusAuthfail"));break;default:Candy.View.Pane.Chat.Modal.show($.i18n._("status",args.status))}},Message:function(event,args){if(args.type==="message")Candy.View.Pane.Chat.adminMessage(args.subject||"",args.message);else if(args.type==="chat"||args.type==="groupchat")Candy.View.Pane.Chat.onInfoMessage(Candy.View.getCurrent().roomJid,args.subject||"",args.message)}},self.Presence={update:function(event,args){if(args.type==="leave"||args.type==="kick"||args.type==="ban"){var evtData={type:args.type,reason:args.reason,roomJid:args.roomJid,user:args.user};$(Candy).triggerHandler("candy:view.presence",[evtData])}else if(args.roomJid){if(!args.user)return!1;if(args.roomJid=Candy.Util.unescapeJid(args.roomJid),!Candy.View.Pane.Chat.rooms[args.roomJid]){if(Candy.View.Pane.Room.init(args.roomJid,args.roomName)===!1)return!1;$("#chat-rooms").children().length===1&&Candy.View.Pane.Room.show(args.roomJid)}Candy.View.Pane.Roster.update(args.roomJid,args.user,args.action,args.currentUser);Candy.View.Pane.Chat.rooms[args.user.getJid()]&&args.action!=="nickchange"&&(Candy.View.Pane.Roster.update(args.user.getJid(),args.user,args.action,args.currentUser),Candy.View.Pane.PrivateRoom.setStatus(args.user.getJid(),args.action))}},notifyPrivateChats:function(user,type){Candy.Core.log("[View:Observer] notify Private Chats");for(var roomJid in Candy.View.Pane.Chat.rooms)Candy.View.Pane.Chat.rooms.hasOwnProperty(roomJid)&&Candy.View.Pane.Room.getUser(roomJid)&&user.getJid()===Candy.View.Pane.Room.getUser(roomJid).getJid()&&(Candy.View.Pane.Roster.update(roomJid,user,type,user),Candy.View.Pane.PrivateRoom.setStatus(roomJid,type))}},self.PresenceError=function(obj,args){switch(args.type){case"not-authorized":var message;args.msg.children("x").children("password").length>0&&(message=$.i18n._("passwordEnteredInvalid",[args.roomName]));Candy.View.Pane.Chat.Modal.showEnterPasswordForm(args.roomJid,args.roomName,message);break;case"conflict":Candy.View.Pane.Chat.Modal.showNicknameConflictForm(args.roomJid);break;case"registration-required":Candy.View.Pane.Chat.Modal.showError("errorMembersOnly",[args.roomName]);break;case"service-unavailable":Candy.View.Pane.Chat.Modal.showError("errorMaxOccupantsReached",[args.roomName])}},self.Message=function(event,args){Candy.View.Pane.Chat.rooms[args.roomJid]||(Candy.View.Pane.Room.init(args.roomJid,args.message.name),Candy.View.Pane.Room.setUser(args.roomJid,Candy.Core.getUser()),Candy.View.Pane.Room.show(args.roomJid));args.message.type==="subject"?Candy.View.Pane.Room.setSubject(args.roomJid,args.message.body):args.message.type==="info"?Candy.View.Pane.Chat.infoMessage(args.roomJid,args.message.body):(args.message.type!=="chat"||Candy.View.Pane.Chat.rooms[args.roomJid]||Candy.View.Pane.PrivateRoom.open(args.roomJid,args.message.name,!1,args.message.isNoConferenceRoomJid),Candy.View.Pane.Message.show(args.roomJid,args.message.name,args.message.body,args.message.xhtmlMessage,args.timestamp,args.message.attributes))},self.Login=function(event,args){Candy.View.Pane.Chat.Modal.showLoginForm(null,args.presetJid)},self.AutojoinMissing=function(){_showConnectedMessageModal=!1;Candy.View.Pane.Chat.Modal.showError("errorAutojoinMissing")},self}(Candy.View.Observer||{},jQueryCandyInstance);Candy.View.Pane=function(self,$){return self.Window={_hasFocus:!0,_plainTitle:document.title,_unreadMessagesCount:0,autoscroll:!0,hasFocus:function(){return self.Window._hasFocus},increaseUnreadMessages:function(){self.Window.renderUnreadMessages(++self.Window._unreadMessagesCount)},reduceUnreadMessages:function(num){self.Window._unreadMessagesCount-=num;self.Window._unreadMessagesCount<=0?self.Window.clearUnreadMessages():self.Window.renderUnreadMessages(self.Window._unreadMessagesCount)},clearUnreadMessages:function(){self.Window._unreadMessagesCount=0;document.title=self.Window._plainTitle},renderUnreadMessages:function(count){document.title=Candy.View.Template.Window.unreadmessages.replace("{{count}}",count).replace("{{title}}",self.Window._plainTitle)},onFocus:function(){self.Window._hasFocus=!0;Candy.View.getCurrent().roomJid&&(self.Room.setFocusToForm(Candy.View.getCurrent().roomJid),self.Chat.clearUnreadMessages(Candy.View.getCurrent().roomJid))},onBlur:function(){self.Window._hasFocus=!1}},self.Chat={rooms:[],addTab:function(roomJid,roomName,roomType){var roomId=Candy.Util.jidToId(roomJid),html=Mustache.to_html(Candy.View.Template.Chat.tab,{roomJid:roomJid,roomId:roomId,name:roomName||Strophe.getNodeFromJid(roomJid),privateUserChat:function(){return roomType==="chat"},roomType:roomType}),tab=$(html).appendTo("#chat-tabs");tab.click(self.Chat.tabClick);$("a.close",tab).click(self.Chat.tabClose);self.Chat.clearUnreadMessages(roomJid);self.Chat.fitTabs()},getTab:function(roomJid){return $("#chat-tabs").children('li[data-roomjid="'+roomJid+'"]')},removeTab:function(roomJid){self.Chat.getTab(roomJid).remove();self.Chat.fitTabs()},setActiveTab:function(roomJid){$("#chat-tabs").children().each(function(){var tab=$(this);tab.attr("data-roomjid")===roomJid?tab.addClass("active"):tab.removeClass("active")})},increaseUnreadMessages:function(roomJid){var unreadElem=this.getTab(roomJid).find(".unread");unreadElem.show().text(unreadElem.text()!==""?parseInt(unreadElem.text(),10)+1:1);self.Chat.rooms[roomJid].type==="chat"&&self.Window.increaseUnreadMessages()},clearUnreadMessages:function(roomJid){var unreadElem=self.Chat.getTab(roomJid).find(".unread");self.Window.reduceUnreadMessages(unreadElem.text());unreadElem.hide().text("")},tabClick:function(e){var currentRoomJid=Candy.View.getCurrent().roomJid;self.Chat.rooms[currentRoomJid].scrollPosition=self.Room.getPane(currentRoomJid,".message-pane-wrapper").scrollTop();self.Room.show($(this).attr("data-roomjid"));e.preventDefault()},tabClose:function(){var roomJid=$(this).parent().attr("data-roomjid");return self.Chat.rooms[roomJid].type==="chat"?self.Room.close(roomJid):Candy.Core.Action.Jabber.Room.Leave(roomJid),!1},allTabsClosed:function(){self.Chat.Toolbar.hide();Candy.Core.getOptions().disconnectWithoutTabs&&Candy.Core.disconnect()},fitTabs:function(){var availableWidth=$("#chat-tabs").innerWidth(),tabsWidth=0,tabs=$("#chat-tabs").children(),tabDiffToRealWidth,tabWidth;tabs.each(function(){tabsWidth+=$(this).css({width:"auto",overflow:"visible"}).outerWidth(!0)});tabsWidth>availableWidth&&(tabDiffToRealWidth=tabs.outerWidth(!0)-tabs.width(),tabWidth=Math.floor(availableWidth/tabs.length)-tabDiffToRealWidth,tabs.css({width:tabWidth,overflow:"hidden"}))},adminMessage:function(subject,message){if(Candy.View.getCurrent().roomJid){var html=Mustache.to_html(Candy.View.Template.Chat.adminMessage,{subject:subject,message:message,sender:$.i18n._("administratorMessageSubject"),time:Candy.Util.localizedTime((new Date).toGMTString())});$("#chat-rooms").children().each(function(){self.Room.appendToMessagePane($(this).attr("data-roomjid"),html)});$(Candy).triggerHandler("candy:view.chat.admin-message",{subject:subject,message:message})}},infoMessage:function(roomJid,subject,message){self.Chat.onInfoMessage(roomJid,subject,message)},onInfoMessage:function(roomJid,subject,message){if(Candy.View.Pane.Room.getPane(roomJid)){var html=Mustache.to_html(Candy.View.Template.Chat.infoMessage,{subject:subject,message:$.i18n._(message),time:Candy.Util.localizedTime((new Date).toGMTString())});self.Room.appendToMessagePane(roomJid,html)}},Toolbar:{_supportsNativeAudio:null,init:function(){$("#emoticons-icon").click(function(e){self.Chat.Context.showEmoticonsMenu(e.currentTarget);e.stopPropagation()});$("#chat-autoscroll-control").click(self.Chat.Toolbar.onAutoscrollControlClick);try{if(!!document.createElement("audio").canPlayType){var a=document.createElement("audio");a.canPlayType("audio/mpeg;").replace(/no/,"")?self.Chat.Toolbar._supportsNativeAudio="mp3":a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")?self.Chat.Toolbar._supportsNativeAudio="ogg":!a.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,"")||(self.Chat.Toolbar._supportsNativeAudio="m4a")}}catch(e){Candy.Core.log("[View:Pane:Toolbar] init error:");Candy.Core.log(e)}$("#chat-sound-control").click(self.Chat.Toolbar.onSoundControlClick);Candy.Util.cookieExists("candy-nosound")&&$("#chat-sound-control").click();$("#chat-statusmessage-control").click(self.Chat.Toolbar.onStatusMessageControlClick);Candy.Util.cookieExists("candy-nostatusmessages")&&$("#chat-statusmessage-control").click()},show:function(){$("#chat-toolbar").show()},hide:function(){$("#chat-toolbar").hide()},update:function(roomJid){var context=$("#chat-toolbar").find(".context"),me=self.Room.getUser(roomJid);me&&me.isModerator()?context.show().click(function(e){self.Chat.Context.show(e.currentTarget,roomJid);e.stopPropagation()}):context.hide();self.Chat.Toolbar.updateUsercount(self.Chat.rooms[roomJid].usercount)},playSound:function(resource){self.Chat.Toolbar.onPlaySound(resource)},onPlaySound:function(resource){if(Candy.View.getOptions().assets){var filename=resource||"new_message";try{self.Chat.Toolbar._supportsNativeAudio!==null?new Audio(Candy.View.getOptions().assets+"sfx/"+filename+"."+self.Chat.Toolbar._supportsNativeAudio).play():($("#chat-sound-control bgsound").remove(),$("<bgsound/>").attr({src:Candy.View.getOptions().assets+"sfx/"+filename+".mp3",loop:1,autostart:!0}).appendTo("#chat-sound-control"))}catch(e){Candy.Core.log("[View:Pane:Toolbar] onPlaySound error:");Candy.Core.log(e)}}},onSoundControlClick:function(){var control=$("#chat-sound-control");control.hasClass("checked")?(self.Chat.Toolbar.playSound=function(){},Candy.Util.setCookie("candy-nosound","1",365)):(self.Chat.Toolbar.playSound=function(resource){self.Chat.Toolbar.onPlaySound(resource)},Candy.Util.deleteCookie("candy-nosound"),self.Chat.Toolbar.playSound("toggle_on"));control.toggleClass("checked")},onAutoscrollControlClick:function(){var control=$("#chat-autoscroll-control");control.hasClass("checked")?(self.Room.scrollToBottom=function(roomJid){self.Room.onScrollToStoredPosition(roomJid)},self.Window.autoscroll=!1):(self.Room.scrollToBottom=function(roomJid){self.Room.onScrollToBottom(roomJid)},self.Room.scrollToBottom(Candy.View.getCurrent().roomJid),self.Window.autoscroll=!0);control.toggleClass("checked")},onStatusMessageControlClick:function(){var control=$("#chat-statusmessage-control");control.hasClass("checked")?(self.Chat.infoMessage=function(){},Candy.Util.setCookie("candy-nostatusmessages","1",365)):(self.Chat.infoMessage=function(roomJid,subject,message){self.Chat.onInfoMessage(roomJid,subject,message)},Candy.Util.deleteCookie("candy-nostatusmessages"));control.toggleClass("checked")},updateUsercount:function(count){$("#chat-usercount").text(count)}},Modal:{show:function(html,showCloseControl,showSpinner){showCloseControl?self.Chat.Modal.showCloseControl():self.Chat.Modal.hideCloseControl();showSpinner?self.Chat.Modal.showSpinner():self.Chat.Modal.hideSpinner();$("#chat-modal").stop(!1,!0);$("#chat-modal-body").html(html);$("#chat-modal").fadeIn("fast");$("#chat-modal-overlay").show()},hide:function(callback){$("#chat-modal").fadeOut("fast",function(){$("#chat-modal-body").text("");$("#chat-modal-overlay").hide()});$(document).keydown(function(e){e.which===27&&e.preventDefault()});callback&&callback()},showSpinner:function(){$("#chat-modal-spinner").show()},hideSpinner:function(){$("#chat-modal-spinner").hide()},showCloseControl:function(){$("#admin-message-cancel").show().click(function(e){self.Chat.Modal.hide();e.preventDefault()});$(document).keydown(function(e){e.which===27&&(self.Chat.Modal.hide(),e.preventDefault())})},hideCloseControl:function(){$("#admin-message-cancel").hide().click(function(){})},showLoginForm:function(message,presetJid){self.Chat.Modal.show((message?message:"")+Mustache.to_html(Candy.View.Template.Login.form,{_labelNickname:$.i18n._("labelNickname"),_labelUsername:$.i18n._("labelUsername"),_labelPassword:$.i18n._("labelPassword"),_loginSubmit:$.i18n._("loginSubmit"),displayPassword:!Candy.Core.isAnonymousConnection(),displayUsername:!presetJid,displayNickname:Candy.Core.isAnonymousConnection(),presetJid:presetJid?presetJid:!1}));$("#login-form").children(":input:first").focus();$("#login-form").submit(function(){var username=$("#username").val(),password=$("#password").val(),jid;return Candy.Core.isAnonymousConnection()?Candy.Core.connect(presetJid,null,username):(jid=Candy.Core.getUser()&&username.indexOf("@")<0?username+"@"+Strophe.getDomainFromJid(Candy.Core.getUser().getJid()):username,jid.indexOf("@")<0&&!Candy.Core.getUser()?Candy.View.Pane.Chat.Modal.showLoginForm($.i18n._("loginInvalid")):Candy.Core.connect(jid,password)),!1})},showEnterPasswordForm:function(roomJid,roomName,message){self.Chat.Modal.show(Mustache.to_html(Candy.View.Template.PresenceError.enterPasswordForm,{roomName:roomName,_labelPassword:$.i18n._("labelPassword"),_label:message?message:$.i18n._("enterRoomPassword",[roomName]),_joinSubmit:$.i18n._("enterRoomPasswordSubmit")}),!0);$("#password").focus();$("#enter-password-form").submit(function(){var password=$("#password").val();return self.Chat.Modal.hide(function(){Candy.Core.Action.Jabber.Room.Join(roomJid,password)}),!1})},showNicknameConflictForm:function(roomJid){self.Chat.Modal.show(Mustache.to_html(Candy.View.Template.PresenceError.nicknameConflictForm,{_labelNickname:$.i18n._("labelNickname"),_label:$.i18n._("nicknameConflict"),_loginSubmit:$.i18n._("loginSubmit")}));$("#nickname").focus();$("#nickname-conflict-form").submit(function(){var nickname=$("#nickname").val();return self.Chat.Modal.hide(function(){Candy.Core.getUser().data.nick=nickname;Candy.Core.Action.Jabber.Room.Join(roomJid)}),!1})},showError:function(message,replacements){self.Chat.Modal.show(Mustache.to_html(Candy.View.Template.PresenceError.displayError,{_error:$.i18n._(message,replacements)}),!0)}},Tooltip:{show:function(event,content){var tooltip=$("#tooltip"),target=$(event.currentTarget),html;content||(content=target.attr("data-tooltip"));tooltip.length===0&&(html=Mustache.to_html(Candy.View.Template.Chat.tooltip),$("#chat-pane").append(html),tooltip=$("#tooltip"));$("#context-menu").hide();tooltip.stop(!1,!0);tooltip.children("div").html(content);var pos=target.offset(),posLeft=Candy.Util.getPosLeftAccordingToWindowBounds(tooltip,pos.left),posTop=Candy.Util.getPosTopAccordingToWindowBounds(tooltip,pos.top);tooltip.css({left:posLeft.px,top:posTop.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(posLeft.backgroundPositionAlignment+"-"+posTop.backgroundPositionAlignment).fadeIn("fast");target.mouseleave(function(event){event.stopPropagation();$("#tooltip").stop(!1,!0).fadeOut("fast",function(){$(this).css({top:0,left:0})})})}},Context:{init:function(){if($("#context-menu").length===0){var html=Mustache.to_html(Candy.View.Template.Chat.Context.menu);$("#chat-pane").append(html);$("#context-menu").mouseleave(function(){$(this).fadeOut("fast")})}},show:function(elem,roomJid,user){var menulinks,id,clickHandler,link,html;elem=$(elem);var roomId=self.Chat.rooms[roomJid].id,menu=$("#context-menu"),links=$("ul li",menu);$("#tooltip").hide();user||(user=Candy.Core.getUser());links.remove();menulinks=this.getMenuLinks(roomJid,user,elem);clickHandler=function(roomJid,user){return function(event){event.data.callback(event,roomJid,user);$("#context-menu").hide()}};for(id in menulinks)menulinks.hasOwnProperty(id)&&(link=menulinks[id],html=Mustache.to_html(Candy.View.Template.Chat.Context.menulinks,{roomId:roomId,"class":link["class"],id:id,label:link.label}),$("ul",menu).append(html),$("#context-menu-"+id).bind("click",link,clickHandler(roomJid,user)));if(id){var pos=elem.offset(),posLeft=Candy.Util.getPosLeftAccordingToWindowBounds(menu,pos.left),posTop=Candy.Util.getPosTopAccordingToWindowBounds(menu,pos.top);return menu.css({left:posLeft.px,top:posTop.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(posLeft.backgroundPositionAlignment+"-"+posTop.backgroundPositionAlignment).fadeIn("fast"),$(Candy).triggerHandler("candy:view.roster.after-context-menu",{roomJid:roomJid,user:user,element:menu}),!0}},getMenuLinks:function(roomJid,user,elem){var menulinks,id,evtData={roomJid:roomJid,user:user,elem:elem,menulinks:this.initialMenuLinks(elem)};$(Candy).triggerHandler("candy:view.roster.context-menu",evtData);menulinks=evtData.menulinks;for(id in menulinks)menulinks.hasOwnProperty(id)&&menulinks[id].requiredPermission!==undefined&&!menulinks[id].requiredPermission(user,self.Room.getUser(roomJid),elem)&&delete menulinks[id];return menulinks},initialMenuLinks:function(){return{"private":{requiredPermission:function(user,me){return me.getNick()!==user.getNick()&&Candy.Core.getRoom(Candy.View.getCurrent().roomJid)&&!Candy.Core.getUser().isInPrivacyList("ignore",user.getJid())},"class":"private",label:$.i18n._("privateActionLabel"),callback:function(e,roomJid,user){$("#user-"+Candy.Util.jidToId(roomJid)+"-"+Candy.Util.jidToId(user.getJid())).click()}},ignore:{requiredPermission:function(user,me){return me.getNick()!==user.getNick()&&!Candy.Core.getUser().isInPrivacyList("ignore",user.getJid())},"class":"ignore",label:$.i18n._("ignoreActionLabel"),callback:function(e,roomJid,user){Candy.View.Pane.Room.ignoreUser(roomJid,user.getJid())}},unignore:{requiredPermission:function(user,me){return me.getNick()!==user.getNick()&&Candy.Core.getUser().isInPrivacyList("ignore",user.getJid())},"class":"unignore",label:$.i18n._("unignoreActionLabel"),callback:function(e,roomJid,user){Candy.View.Pane.Room.unignoreUser(roomJid,user.getJid())}},kick:{requiredPermission:function(user,me){return me.getNick()!==user.getNick()&&me.isModerator()&&!user.isModerator()},"class":"kick",label:$.i18n._("kickActionLabel"),callback:function(e,roomJid,user){self.Chat.Modal.show(Mustache.to_html(Candy.View.Template.Chat.Context.contextModalForm,{_label:$.i18n._("reason"),_submit:$.i18n._("kickActionLabel")}),!0);$("#context-modal-field").focus();$("#context-modal-form").submit(function(){return Candy.Core.Action.Jabber.Room.Admin.UserAction(roomJid,user.getJid(),"kick",$("#context-modal-field").val()),self.Chat.Modal.hide(),!1})}},ban:{requiredPermission:function(user,me){return me.getNick()!==user.getNick()&&me.isModerator()&&!user.isModerator()},"class":"ban",label:$.i18n._("banActionLabel"),callback:function(e,roomJid,user){self.Chat.Modal.show(Mustache.to_html(Candy.View.Template.Chat.Context.contextModalForm,{_label:$.i18n._("reason"),_submit:$.i18n._("banActionLabel")}),!0);$("#context-modal-field").focus();$("#context-modal-form").submit(function(){return Candy.Core.Action.Jabber.Room.Admin.UserAction(roomJid,user.getJid(),"ban",$("#context-modal-field").val()),self.Chat.Modal.hide(),!1})}},subject:{requiredPermission:function(user,me){return me.getNick()===user.getNick()&&me.isModerator()},"class":"subject",label:$.i18n._("setSubjectActionLabel"),callback:function(e,roomJid){self.Chat.Modal.show(Mustache.to_html(Candy.View.Template.Chat.Context.contextModalForm,{_label:$.i18n._("subject"),_submit:$.i18n._("setSubjectActionLabel")}),!0);$("#context-modal-field").focus();$("#context-modal-form").submit(function(e){Candy.Core.Action.Jabber.Room.Admin.SetSubject(roomJid,$("#context-modal-field").val());self.Chat.Modal.hide();e.preventDefault()})}}}},showEmoticonsMenu:function(elem){var posLeft,posTop;elem=$(elem);var pos=elem.offset(),menu=$("#context-menu"),content=$("ul",menu),emoticons="",i;for($("#tooltip").hide(),i=Candy.Util.Parser.emoticons.length-1;i>=0;i--)emoticons='<img src="'+Candy.Util.Parser._emoticonPath+Candy.Util.Parser.emoticons[i].image+'" alt="'+Candy.Util.Parser.emoticons[i].plain+'" />'+emoticons;return content.html('<li class="emoticons">'+emoticons+"<\/li>"),content.find("img").click(function(){var input=Candy.View.Pane.Room.getPane(Candy.View.getCurrent().roomJid,".message-form").children(".field"),value=input.val(),emoticon=$(this).attr("alt")+" ";input.val(value?value+" "+emoticon:emoticon).focus()}),posLeft=Candy.Util.getPosLeftAccordingToWindowBounds(menu,pos.left),posTop=Candy.Util.getPosTopAccordingToWindowBounds(menu,pos.top),menu.css({left:posLeft.px,top:posTop.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(posLeft.backgroundPositionAlignment+"-"+posTop.backgroundPositionAlignment).fadeIn("fast"),!0}}},self.Room={init:function(roomJid,roomName,roomType){var evtData,roomId;return(roomType=roomType||"groupchat",roomJid=Candy.Util.unescapeJid(roomJid),evtData={roomJid:roomJid,type:roomType},$(Candy).triggerHandler("candy:view.room.before-add",evtData)===!1)?!1:(Candy.Util.isEmptyObject(self.Chat.rooms)&&self.Chat.Toolbar.show(),roomId=Candy.Util.jidToId(roomJid),self.Chat.rooms[roomJid]={id:roomId,usercount:0,name:roomName,type:roomType,messageCount:0,scrollPosition:-1},$("#chat-rooms").append(Mustache.to_html(Candy.View.Template.Room.pane,{roomId:roomId,roomJid:roomJid,roomType:roomType,form:{_messageSubmit:$.i18n._("messageSubmit")},roster:{_userOnline:$.i18n._("userOnline")}},{roster:Candy.View.Template.Roster.pane,messages:Mustache.to_html(Candy.View.Template.Message.pane,{},{header:Candy.View.Template.Message.header}),form:Candy.View.Template.Room.form})),self.Chat.addTab(roomJid,roomName,roomType),self.Room.getPane(roomJid,".message-form").submit(self.Message.submit),evtData.element=self.Room.getPane(roomJid),$(Candy).triggerHandler("candy:view.room.after-add",evtData),self.Chat.Toolbar.playSound("new_chat"),roomId)},show:function(roomJid){var roomId=self.Chat.rooms[roomJid].id,evtData;$(".room-pane").each(function(){var elem=$(this);evtData={roomJid:elem.attr("data-roomjid"),element:elem};elem.attr("id")==="chat-room-"+roomId?(elem.show(),Candy.View.getCurrent().roomJid=roomJid,self.Chat.setActiveTab(roomJid),self.Chat.Toolbar.update(roomJid),self.Chat.clearUnreadMessages(roomJid),self.Room.setFocusToForm(roomJid),self.Room.scrollToBottom(roomJid),$(Candy).triggerHandler("candy:view.room.after-show",evtData)):elem.is(":visible")&&(elem.hide(),$(Candy).triggerHandler("candy:view.room.after-hide",evtData))})},setSubject:function(roomJid,subject){subject=Candy.Util.Parser.linkify(Candy.Util.Parser.escape(subject));var html=Mustache.to_html(Candy.View.Template.Room.subject,{subject:subject,roomName:self.Chat.rooms[roomJid].name,_roomSubject:$.i18n._("roomSubject"),time:Candy.Util.localizedTime((new Date).toGMTString())});self.Room.appendToMessagePane(roomJid,html);$(Candy).triggerHandler("candy:view.room.after-subject-change",{roomJid:roomJid,element:self.Room.getPane(roomJid),subject:subject})},close:function(roomJid){self.Chat.removeTab(roomJid);self.Window.clearUnreadMessages();self.Room.getPane(roomJid).remove();var openRooms=$("#chat-rooms").children();Candy.View.getCurrent().roomJid===roomJid&&(Candy.View.getCurrent().roomJid=null,openRooms.length===0?self.Chat.allTabsClosed():self.Room.show(openRooms.last().attr("data-roomjid")));delete self.Chat.rooms[roomJid];$(Candy).triggerHandler("candy:view.room.after-close",{roomJid:roomJid})},insertInMessagePane:function(roomJid,html,id,seqId){var inserted=!1,pane=self.Room.getPane(roomJid,".message-pane");pane.children('li[data-id="'+id+'"]').length>0||(pane.children().each(function(){var msg=$(this);if(Number(seqId)<Number(msg.attr("data-seqid")))return msg.before(html),inserted=!0,!1}),inserted||self.Room.getPane(roomJid,".message-pane").append(html))},appendToMessagePane:function(roomJid,html){self.Room.getPane(roomJid,".message-pane").append(html);self.Chat.rooms[roomJid].messageCount++;self.Room.sliceMessagePane(roomJid);Candy.View.getCurrent().roomJid===roomJid&&self.Room.scrollToBottom(roomJid)},sliceMessagePane:function(roomJid){if(self.Window.autoscroll){var options=Candy.View.getOptions().messages;self.Chat.rooms[roomJid].messageCount>options.limit&&(self.Room.getPane(roomJid,".message-pane").children().slice(0,options.remove).remove(),self.Chat.rooms[roomJid].messageCount-=options.remove)}},scrollToBottom:function(roomJid){self.Room.onScrollToBottom(roomJid)},onScrollToBottom:function(roomJid){var messagePane=self.Room.getPane(roomJid,".message-pane-wrapper");messagePane.scrollTop(messagePane.prop("scrollHeight"))},onScrollToStoredPosition:function(roomJid){if(self.Chat.rooms[roomJid].scrollPosition>-1){var messagePane=self.Room.getPane(roomJid,".message-pane-wrapper");messagePane.scrollTop(self.Chat.rooms[roomJid].scrollPosition);self.Chat.rooms[roomJid].scrollPosition=-1}},setFocusToForm:function(roomJid){var pane=self.Room.getPane(roomJid,".message-form");if(pane)try{pane.children(".field")[0].focus()}catch(e){}},setUser:function(roomJid,user){self.Chat.rooms[roomJid].user=user;var roomPane=self.Room.getPane(roomJid),chatPane=$("#chat-pane");roomPane.attr("data-userjid",user.getJid());user.isModerator()?(user.getRole()===user.ROLE_MODERATOR&&chatPane.addClass("role-moderator"),user.getAffiliation()===user.AFFILIATION_OWNER&&chatPane.addClass("affiliation-owner")):chatPane.removeClass("role-moderator affiliation-owner");self.Chat.Context.init()},getUser:function(roomJid){return self.Chat.rooms[roomJid].user},ignoreUser:function(roomJid,userJid){Candy.Core.Action.Jabber.Room.IgnoreUnignore(userJid);Candy.View.Pane.Room.addIgnoreIcon(roomJid,userJid)},unignoreUser:function(roomJid,userJid){Candy.Core.Action.Jabber.Room.IgnoreUnignore(userJid);Candy.View.Pane.Room.removeIgnoreIcon(roomJid,userJid)},addIgnoreIcon:function(roomJid,userJid){Candy.View.Pane.Chat.rooms[userJid]&&$("#user-"+Candy.View.Pane.Chat.rooms[userJid].id+"-"+Candy.Util.jidToId(userJid)).addClass("status-ignored");Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(roomJid)]&&$("#user-"+Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(roomJid)].id+"-"+Candy.Util.jidToId(userJid)).addClass("status-ignored")},removeIgnoreIcon:function(roomJid,userJid){Candy.View.Pane.Chat.rooms[userJid]&&$("#user-"+Candy.View.Pane.Chat.rooms[userJid].id+"-"+Candy.Util.jidToId(userJid)).removeClass("status-ignored");Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(roomJid)]&&$("#user-"+Candy.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(roomJid)].id+"-"+Candy.Util.jidToId(userJid)).removeClass("status-ignored")},getPane:function(roomJid,subPane){if(self.Chat.rooms[roomJid])return subPane?self.Chat.rooms[roomJid]["pane-"+subPane]?self.Chat.rooms[roomJid]["pane-"+subPane]:(self.Chat.rooms[roomJid]["pane-"+subPane]=$("#chat-room-"+self.Chat.rooms[roomJid].id).find(subPane),self.Chat.rooms[roomJid]["pane-"+subPane]):$("#chat-room-"+self.Chat.rooms[roomJid].id)},changeDataUserJidIfUserIsMe:function(roomId,user){if(user.getNick()===Candy.Core.getUser().getNick()){var roomElement=$("#chat-room-"+roomId);roomElement.attr("data-userjid",Strophe.getBareJidFromJid(roomElement.attr("data-userjid"))+"/"+user.getNick())}}},self.PrivateRoom={open:function(roomJid,roomName,switchToRoom,isNoConferenceRoomJid){var user=isNoConferenceRoomJid?Candy.Core.getUser():self.Room.getUser(Strophe.getBareJidFromJid(roomJid)),evtData={roomJid:roomJid,roomName:roomName,type:"chat"};if($(Candy).triggerHandler("candy:view.private-room.before-open",evtData)===!1||Candy.Core.getUser().isInPrivacyList("ignore",roomJid)||!self.Chat.rooms[roomJid]&&self.Room.init(roomJid,roomName,"chat")===!1)return!1;switchToRoom&&self.Room.show(roomJid);self.Roster.update(roomJid,new Candy.Core.ChatUser(roomJid,roomName),"join",user);self.Roster.update(roomJid,user,"join",user);self.PrivateRoom.setStatus(roomJid,"join");isNoConferenceRoomJid&&self.Chat.infoMessage(roomJid,$.i18n._("presenceUnknownWarningSubject"),$.i18n._("presenceUnknownWarning"));evtData.element=self.Room.getPane(roomJid);$(Candy).triggerHandler("candy:view.private-room.after-open",evtData)},setStatus:function(roomJid,status){var messageForm=self.Room.getPane(roomJid,".message-form");status==="join"?(self.Chat.getTab(roomJid).addClass("online").removeClass("offline"),messageForm.children(".field").removeAttr("disabled"),messageForm.children(".submit").removeAttr("disabled"),self.Chat.getTab(roomJid)):status==="leave"&&(self.Chat.getTab(roomJid).addClass("offline").removeClass("online"),messageForm.children(".field").attr("disabled",!0),messageForm.children(".submit").attr("disabled",!0))},changeNick:function(roomJid,user){Candy.Core.log("[View:Pane:PrivateRoom] changeNick");var previousPrivateRoomJid=roomJid+"/"+user.getPreviousNick(),newPrivateRoomJid=roomJid+"/"+user.getNick(),previousPrivateRoomId=Candy.Util.jidToId(previousPrivateRoomJid),newPrivateRoomId=Candy.Util.jidToId(newPrivateRoomJid),room=self.Chat.rooms[previousPrivateRoomJid],roomElement,roomTabElement;self.Chat.rooms[newPrivateRoomJid]&&self.Room.close(newPrivateRoomJid);room?(room.name=user.getNick(!0),room.id=newPrivateRoomId,self.Chat.rooms[newPrivateRoomJid]=room,delete self.Chat.rooms[previousPrivateRoomJid],roomElement=$("#chat-room-"+previousPrivateRoomId),roomElement&&(roomElement.attr("data-roomjid",newPrivateRoomJid),roomElement.attr("id","chat-room-"+newPrivateRoomId),roomTabElement=$('#chat-tabs li[data-roomjid="'+previousPrivateRoomJid+'"]'),roomTabElement.attr("data-roomjid",newPrivateRoomJid),roomTabElement.children("a.label").text("@"+user.getNick(!0)),Candy.View.getCurrent().roomJid===previousPrivateRoomJid&&(Candy.View.getCurrent().roomJid=newPrivateRoomJid))):(roomElement=$('.room-pane.roomtype-chat[data-userjid="'+previousPrivateRoomJid+'"]'),roomElement.length&&(previousPrivateRoomId=Candy.Util.jidToId(roomElement.attr("data-roomjid")),roomElement.attr("data-userjid",newPrivateRoomJid)));roomElement&&roomElement.length&&self.Roster.changeNick(previousPrivateRoomId,user)}},self.Roster={update:function(roomJid,user,action,currentUser){var html,userInserted,rosterPane,userSortCompare,infoMessage;Candy.Core.log("[View:Pane:Roster] "+action);var roomId=self.Chat.rooms[roomJid].id,userId=Candy.Util.jidToId(user.getJid()),usercountDiff=-1,userElem=$("#user-"+roomId+"-"+userId),evtData={roomJid:roomJid,user:user,action:action,element:userElem};if($(Candy).triggerHandler("candy:view.roster.before-update",evtData),action==="join")usercountDiff=1,html=Mustache.to_html(Candy.View.Template.Roster.user,{roomId:roomId,userId:userId,userJid:user.getJid(),nick:user.getNick(),displayNick:Candy.Util.crop(user.getNick(!0),Candy.View.getOptions().crop.roster.nickname),role:user.getRole(),affiliation:user.getAffiliation(),me:currentUser!==undefined&&user.getNick()===currentUser.getNick(),tooltipRole:$.i18n._("tooltipRole"),tooltipIgnored:$.i18n._("tooltipIgnored")}),userElem.length<1?(userInserted=!1,rosterPane=self.Room.getPane(roomJid,".roster-pane"),rosterPane.children().length>0&&(userSortCompare=user.getNick().toUpperCase(),rosterPane.children().each(function(){var elem=$(this);return elem.attr("data-nick").toUpperCase()>userSortCompare?(elem.before(html),userInserted=!0,!1):!0})),userInserted||rosterPane.append(html),self.Roster.showJoinAnimation(user,userId,roomId,roomJid,currentUser),self.Roster.showJoinMessage(user,userId,roomId,roomJid,currentUser)):(usercountDiff=0,userElem.replaceWith(html),$("#user-"+roomId+"-"+userId).css({opacity:1}).show(),currentUser!==undefined&&user.getNick()===currentUser.getNick()&&self.Room.getUser(roomJid)&&self.Chat.Toolbar.update(roomJid)),currentUser!==undefined&&currentUser.getNick()===user.getNick()?self.Room.setUser(roomJid,user):$("#user-"+roomId+"-"+userId).click(self.Roster.userClick),$("#user-"+roomId+"-"+userId+" .context").click(function(e){self.Chat.Context.show(e.currentTarget,roomJid,user);e.stopPropagation()}),currentUser!==undefined&&currentUser.isInPrivacyList("ignore",user.getJid())&&Candy.View.Pane.Room.addIgnoreIcon(roomJid,user.getJid());else if(action==="leave"||action==="kick"||action==="ban")if(self.Roster.leaveAnimation("user-"+roomId+"-"+userId),self.Chat.rooms[roomJid].type==="chat")self.Chat.onInfoMessage(roomJid,$.i18n._("userLeftRoom",[user.getNick(!0)]));else self.Chat.infoMessage(roomJid,$.i18n._("userLeftRoom",[user.getNick(!0)]));else if(action==="nickchange"){usercountDiff=0;self.Roster.changeNick(roomId,user);self.Room.changeDataUserJidIfUserIsMe(roomId,user);self.PrivateRoom.changeNick(roomJid,user);infoMessage=$.i18n._("userChangedNick",[user.getPreviousNick(),user.getNick(!0)]);self.Chat.onInfoMessage(roomJid,infoMessage)}Candy.View.Pane.Chat.rooms[roomJid].usercount+=usercountDiff;roomJid===Candy.View.getCurrent().roomJid&&Candy.View.Pane.Chat.Toolbar.updateUsercount(Candy.View.Pane.Chat.rooms[roomJid].usercount);evtData.element=$("#user-"+roomId+"-"+userId);$(Candy).triggerHandler("candy:view.roster.after-update",evtData)},userClick:function(){var elem=$(this);self.PrivateRoom.open(elem.attr("data-jid"),elem.attr("data-nick"),!0)},showJoinAnimation:function(user,userId,roomId){var rosterUserId="user-"+roomId+"-"+userId,$rosterUserElem=$("#"+rosterUserId);user.getPreviousNick()&&$rosterUserElem&&$rosterUserElem.is(":visible")!==!1||self.Roster.joinAnimation(rosterUserId)},showJoinMessage:function(user,userId,roomId,roomJid,currentUser){if(!user.getPreviousNick()&&currentUser!==undefined&&user.getNick()!==currentUser.getNick()&&!user.isModerator())self.Chat.onInfoMessage(roomJid,$.i18n._("userJoinedRoom",[user.getNick(!0)]))},joinAnimation:function(elementId){$("#"+elementId).stop(!0).slideDown("normal",function(){$(this).animate({opacity:1})})},leaveAnimation:function(elementId){$("#"+elementId).stop(!0).attr("id","#"+elementId+"-leaving").animate({opacity:0},{complete:function(){$(this).slideUp("normal",function(){$(this).remove()})}})},changeNick:function(roomId,user){Candy.Core.log("[View:Pane:Roster] changeNick");var previousUserJid=Strophe.getBareJidFromJid(user.getJid())+"/"+user.getPreviousNick(),elementId="user-"+roomId+"-"+Candy.Util.jidToId(previousUserJid),el=$("#"+elementId);el.attr("data-nick",user.getNick());el.attr("data-jid",user.getJid());el.children("div.label").text(user.getNick());el.attr("id","user-"+roomId+"-"+Candy.Util.jidToId(user.getJid()))}},self.Message={submit:function(event){var roomJid=Candy.View.getCurrent().roomJid,roomType=Candy.View.Pane.Chat.rooms[roomJid].type,message=$(this).children(".field").val().substring(0,Candy.View.getOptions().crop.message.body),xhtmlMessage,evtData={roomJid:roomJid,message:message,xhtmlMessage:xhtmlMessage};if($(Candy).triggerHandler("candy:view.message.before-send",evtData)===!1){event.preventDefault();return}message=evtData.message;xhtmlMessage=evtData.xhtmlMessage;Candy.Core.Action.Jabber.Room.Message(roomJid,message,roomType,xhtmlMessage);roomType==="chat"&&message&&self.Message.show(roomJid,self.Room.getUser(roomJid).getNick(!0),message);$(this).children(".field").val("").trigger("change").focus();event.preventDefault()},show:function(roomJid,name,message,xhtmlMessage,timestamp,attributes){var raw=message,isHistoryMessage,evtData,html,elem;if(message=Candy.Util.Parser.all(message.substring(0,Candy.View.getOptions().crop.message.body)),xhtmlMessage&&(xhtmlMessage=Candy.Util.parseAndCropXhtml(xhtmlMessage,Candy.View.getOptions().crop.message.body)),isHistoryMessage=!!timestamp,evtData={roomJid:roomJid,name:name,rawMessage:raw,attributes:attributes,message:message,xhtmlMessage:xhtmlMessage,history:isHistoryMessage},$(Candy).triggerHandler("candy:view.message.before-show",evtData)!==!1){message=evtData.message;xhtmlMessage=evtData.xhtmlMessage;xhtmlMessage!==undefined&&xhtmlMessage.length>0&&(message=xhtmlMessage);var now=new Date,user=self.Room.getUser(roomJid),nick=user&&user.getNick(),renderEvtData={rawMessage:raw,attributes:attributes,template:Candy.View.Template.Message.item,templateData:{name:name,displayName:Candy.Util.getDisplayName(name),croppedDisplayName:Candy.Util.crop(Candy.Util.getDisplayName(name),Candy.View.getOptions().crop.message.nickname),message:message,time:Candy.Util.localizedTime(timestamp||now.toGMTString()),timestamp:timestamp||now.toISOString(),stamp:(timestamp&&new Date(timestamp)||now).valueOf(),id:attributes.id||"",seqId:attributes.seqId||0x8000000000000,roomJid:roomJid,sender:name===nick?"sender-is-me":"sender-is-other"},history:isHistoryMessage};$(Candy).triggerHandler("candy:view.message.before-render",renderEvtData)!==!1&&(html=Mustache.to_html(renderEvtData.template,renderEvtData.templateData),isHistoryMessage?self.Room.insertInMessagePane(roomJid,html,attributes.id,attributes.seqId):(self.Room.appendToMessagePane(roomJid,html),Candy.View.getCurrent().roomJid===roomJid&&self.Window.hasFocus()||(self.Chat.increaseUnreadMessages(roomJid),self.Chat.Toolbar.playSound("new_message"))),elem=self.Room.getPane(roomJid,".message-pane").children().last(),evtData.element=elem,$(Candy).triggerHandler("candy:view.message.after-show",evtData))}}},self}(Candy.View.Pane||{},jQueryCandyInstance);Candy.View.Template=function(self){return self.Window={unreadmessages:"({{count}}) {{title}}"},self.Chat={pane:'<div id="chat-pane">{{> tabs}}{{> toolbar}}{{> rooms}}<\/div>{{> modal}}',rooms:'<div id="chat-rooms" class="rooms"><\/div>',tabs:'<ul id="chat-tabs"><\/ul>',tab:'<li class="roomtype-{{roomType}}" data-roomjid="{{roomJid}}" data-roomtype="{{roomType}}"><a href="#" class="label">{{#privateUserChat}}@{{/privateUserChat}}{{name}}<\/a><small class="transfer"><\/small><small class="unread"><\/small><\/li>',modal:'<div id="chat-modal"><a id="admin-message-cancel" class="close" href="#">×<\/a><span id="chat-modal-body"><\/span><span id="chat-modal-spinner-wrapper"><div id="chat-modal-spinner" /><\/span><\/div><div id="chat-modal-overlay"><\/div>',adminMessage:'<li><small data-stamp="{{stamp}}">{{time}}<\/small><div class="adminmessage"><span class="label">{{sender}}<\/span><span class="spacer">▸<\/span><span class="message">{{subject}} {{message}}<\/span><\/div><\/li>',infoMessage:'<li><small data-stamp="{{stamp}}">{{time}}<\/small><div class="infomessage"><span class="spacer">•<\/span><span class="message">{{subject}} {{message}}<\/span><\/div><\/li>',stateMessage:'<li name="chat-state-message"><div class="statemessage">{{subject}} {{message}}<\/div><\/li>',toolbar:'<ul id="chat-toolbar"><li id="emoticons-icon" data-tooltip="{{tooltipEmoticons}}"><\/li><li id="chat-sound-control" class="checked" data-tooltip="{{tooltipSound}}"><\/li><li id="chat-autoscroll-control" class="checked" data-tooltip="{{tooltipAutoscroll}}"><\/li><li class="checked" id="chat-statusmessage-control" data-tooltip="{{tooltipStatusmessage}}"><\/li><li class="context" data-tooltip="{{tooltipAdministration}}"><\/li><li class="usercount" data-tooltip="{{tooltipUsercount}}"><span id="chat-usercount"><\/span><\/li><\/ul>',Context:{menu:'<div id="context-menu"><i class="arrow arrow-top"><\/i><ul><\/ul><i class="arrow arrow-bottom"><\/i><\/div>',menulinks:'<li class="{{class}}" id="context-menu-{{id}}">{{label}}<\/li>',contextModalForm:'<form action="#" id="context-modal-form"><label for="context-modal-label">{{_label}}<\/label><input type="text" name="contextModalField" id="context-modal-field" /><input type="submit" class="button" name="send" value="{{_submit}}" /><\/form>',adminMessageReason:'<a id="admin-message-cancel" class="close" href="#">×<\/a><p>{{_action}}<\/p>{{#reason}}<p>{{_reason}}<\/p>{{/reason}}'},tooltip:'<div id="tooltip"><i class="arrow arrow-top"><\/i><div><\/div><i class="arrow arrow-bottom"><\/i><\/div>'},self.Room={pane:'<div class="room-pane roomtype-{{roomType}}" id="chat-room-{{roomId}}" data-roomjid="{{roomJid}}" data-roomtype="{{roomType}}">{{> roster}}{{> messages}}{{> form}}<\/div>',subject:'<li><small data-stamp="{{stamp}}">{{time}}<\/small><div class="subject"><span class="label">{{roomName}}<\/span><span class="spacer">▸<\/span>{{_roomSubject}} {{{subject}}}<\/div><\/li>',form:'<div class="message-form-wrapper"><form method="post" class="message-form"><input name="message" class="field" type="text" aria-label="Message Form Text Field" autocomplete="off" maxlength="1000" /><input type="submit" class="submit" name="submit" value="{{_messageSubmit}}" /><\/form><\/div>'},self.Roster={pane:'<div class="roster-pane"><\/div>',user:'<div class="user role-{{role}} affiliation-{{affiliation}}{{#me}} me{{/me}}" id="user-{{roomId}}-{{userId}}" data-jid="{{userJid}}" data-nick="{{nick}}" data-role="{{role}}" data-affiliation="{{affiliation}}"><div class="label">{{displayNick}}<\/div><ul><li class="context" id="context-{{roomId}}-{{userId}}">&#x25BE;<\/li><li class="role role-{{role}} affiliation-{{affiliation}}" data-tooltip="{{tooltipRole}}"><\/li><li class="ignore" data-tooltip="{{tooltipIgnored}}"><\/li><\/ul><\/div>'},self.Message={pane:'{{> header}}<div class="message-pane-wrapper"><ul class="message-pane"><\/ul><\/div>',item:'<li class="{{sender}}" data-id="{{id}}" data-seqid="{{seqId}}"><small data-stamp="{{stamp}}">{{time}}<\/small><div><a class="label name" href="#">{{croppedDisplayName}}<\/a><span class="spacer">▸<\/span><span class="message">{{{message}}}<\/span><\/div><\/li>',header:'<div id="header"><\/div>'},self.Login={form:'<form method="post" id="login-form" class="login-form">{{#displayNickname}}<label for="username">{{_labelNickname}}<\/label><input type="text" id="username" name="username"/>{{/displayNickname}}{{#displayUsername}}<label for="username">{{_labelUsername}}<\/label><input type="text" id="username" name="username"/>{{/displayUsername}}{{#presetJid}}<input type="hidden" id="username" name="username" value="{{presetJid}}"/>{{/presetJid}}{{#displayPassword}}<label for="password">{{_labelPassword}}<\/label><input type="password" id="password" name="password" />{{/displayPassword}}<input type="submit" class="button" value="{{_loginSubmit}}" /><\/form>'},self.PresenceError={enterPasswordForm:'<strong>{{_label}}<\/strong><form method="post" id="enter-password-form" class="enter-password-form"><label for="password">{{_labelPassword}}<\/label><input type="password" id="password" name="password" /><input type="submit" class="button" value="{{_joinSubmit}}" /><\/form>',nicknameConflictForm:'<strong>{{_label}}<\/strong><form method="post" id="nickname-conflict-form" class="nickname-conflict-form"><label for="nickname">{{_labelNickname}}<\/label><input type="text" id="nickname" name="nickname" /><input type="submit" class="button" value="{{_loginSubmit}}" /><\/form>',displayError:"<strong>{{_error}}<\/strong>"},self}(Candy.View.Template||{});Candy.View.Translation={en:{status:"Status: %s",statusConnecting:"Connecting...",statusConnected:"Connected",statusDisconnecting:"Disconnecting...",statusDisconnected:"Disconnected",statusAuthfail:"Authentication failed",sessionRestored:"Session restored",roomSubject:"Subject:",messageSubmit:"Send",labelUsername:"Username:",labelNickname:"Nickname:",labelPassword:"Password:",loginSubmit:"Login",loginInvalid:"Invalid JID",reason:"Reason:",subject:"Subject:",reasonWas:"Reason was: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"You have been kicked from %2$s by %1$s",youHaveBeenKicked:"You have been kicked from %s",banActionLabel:"Ban",youHaveBeenBannedBy:"You have been banned from %1$s by %2$s",youHaveBeenBanned:"You have been banned from %s",privateActionLabel:"Private chat",ignoreActionLabel:"Ignore",unignoreActionLabel:"Unignore",setSubjectActionLabel:"Change Subject",administratorMessageSubject:"Administrator",userJoinedRoom:"%s joined the room.",userLeftRoom:"%s left the room.",userHasBeenKickedFromRoom:"%s has been kicked from the room.",userHasBeenBannedFromRoom:"%s has been banned from the room.",userChangedNick:"%1$s has changed his nickname to %2$s.",presenceUnknownWarningSubject:"Notice:",presenceUnknownWarning:"This user might be offline. We can't track his presence.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"You ignore this user",tooltipEmoticons:"Emoticons",tooltipSound:"Play sound for new messages",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Display status messages",tooltipAdministration:"Room Administration",tooltipUsercount:"Room Occupants",enterRoomPassword:'Room "%s" is password protected.',enterRoomPasswordSubmit:"Join room",passwordEnteredInvalid:'Invalid password for room "%s".',nicknameConflict:"Username already in use. Please choose another one.",errorMembersOnly:'You can\'t join room "%s": Insufficient rights.',errorMaxOccupantsReached:'You can\'t join room "%s": Too many occupants.',errorAutojoinMissing:"No autojoin parameter set in configuration. Please set one to continue.",antiSpamMessage:"Please do not spam. You have been blocked for a short-time."},de:{status:"Status: %s",statusConnecting:"Verbinden...",statusConnected:"Verbunden",statusDisconnecting:"Verbindung trennen...",statusDisconnected:"Verbindung getrennt",statusAuthfail:"Authentifizierung fehlgeschlagen",sessionRestored:"Session restored",roomSubject:"Thema:",messageSubmit:"Senden",labelUsername:"Benutzername:",labelNickname:"Spitzname:",labelPassword:"Passwort:",loginSubmit:"Anmelden",loginInvalid:"Ungültige JID",reason:"Begründung:",subject:"Titel:",reasonWas:"Begründung: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"Du wurdest soeben aus dem Raum %1$s gekickt (%2$s)",youHaveBeenKicked:"Du wurdest soeben aus dem Raum %s gekickt",banActionLabel:"Ban",youHaveBeenBannedBy:"Du wurdest soeben aus dem Raum %1$s verbannt (%2$s)",youHaveBeenBanned:"Du wurdest soeben aus dem Raum %s verbannt",privateActionLabel:"Privater Chat",ignoreActionLabel:"Ignorieren",unignoreActionLabel:"Nicht mehr ignorieren",setSubjectActionLabel:"Thema ändern",administratorMessageSubject:"Administrator",userJoinedRoom:"%s hat soeben den Raum betreten.",userLeftRoom:"%s hat soeben den Raum verlassen.",userHasBeenKickedFromRoom:"%s ist aus dem Raum gekickt worden.",userHasBeenBannedFromRoom:"%s ist aus dem Raum verbannt worden.",userChangedNick:"%1$s hat den Nicknamen zu %2$s geändert.",presenceUnknownWarningSubject:"Hinweis:",presenceUnknownWarning:"Dieser Benutzer könnte bereits abgemeldet sein. Wir können seine Anwesenheit nicht verfolgen.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Du ignorierst diesen Benutzer",tooltipEmoticons:"Smileys",tooltipSound:"Ton abspielen bei neuen Nachrichten",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Statusnachrichten anzeigen",tooltipAdministration:"Raum Administration",tooltipUsercount:"Anzahl Benutzer im Raum",enterRoomPassword:'Raum "%s" ist durch ein Passwort geschützt.',enterRoomPasswordSubmit:"Raum betreten",passwordEnteredInvalid:'Inkorrektes Passwort für Raum "%s".',nicknameConflict:"Der Benutzername wird bereits verwendet. Bitte wähle einen anderen.",errorMembersOnly:'Du kannst den Raum "%s" nicht betreten: Ungenügende Rechte.',errorMaxOccupantsReached:'Du kannst den Raum "%s" nicht betreten: Benutzerlimit erreicht.',errorAutojoinMissing:'Keine "autojoin" Konfiguration gefunden. Bitte setze eine konfiguration um fortzufahren.',antiSpamMessage:"Bitte nicht spammen. Du wurdest für eine kurze Zeit blockiert."},fr:{status:"Status: %s",statusConnecting:"Connexion…",statusConnected:"Connecté.",statusDisconnecting:"Déconnexion…",statusDisconnected:"Déconnecté.",statusAuthfail:"L'authentification a échoué",sessionRestored:"Session restored",roomSubject:"Sujet:",messageSubmit:"Envoyer",labelUsername:"Nom d'utilisateur:",labelPassword:"Mot de passe:",loginSubmit:"Connexion",loginInvalid:"JID invalide",reason:"Motif:",subject:"Titre:",reasonWas:"Motif: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"Vous avez été expulsé du salon %1$s (%2$s)",youHaveBeenKicked:"Vous avez été expulsé du salon %s",banActionLabel:"Ban",youHaveBeenBannedBy:"Vous avez été banni du salon %1$s (%2$s)",youHaveBeenBanned:"Vous avez été banni du salon %s",privateActionLabel:"Chat privé",ignoreActionLabel:"Ignorer",unignoreActionLabel:"Ne plus ignorer",setSubjectActionLabel:"Changer le sujet",administratorMessageSubject:"Administrateur",userJoinedRoom:"%s vient d'entrer dans le salon.",userLeftRoom:"%s vient de quitter le salon.",userHasBeenKickedFromRoom:"%s a été expulsé du salon.",userHasBeenBannedFromRoom:"%s a été banni du salon.",presenceUnknownWarningSubject:"Note:",presenceUnknownWarning:"Cet utilisateur n'est malheureusement plus connecté, le message ne sera pas envoyé.",dateFormat:"dd/mm/yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Modérateur",tooltipIgnored:"Vous ignorez cette personne",tooltipEmoticons:"Smileys",tooltipSound:"Jouer un son lors de la réception de nouveaux messages",tooltipAutoscroll:"Défilement automatique",tooltipStatusmessage:"Messages d'état",tooltipAdministration:"Administration du salon",tooltipUsercount:"Nombre d'utilisateurs dans le salon",enterRoomPassword:'Le salon "%s" est protégé par un mot de passe.',enterRoomPasswordSubmit:"Entrer dans le salon",passwordEnteredInvalid:'Le mot de passe pour le salon "%s" est invalide.',nicknameConflict:"Le nom d'utilisateur est déjà utilisé. Veuillez en choisir un autre.",errorMembersOnly:'Vous ne pouvez pas entrer dans le salon "%s": droits insuffisants.',errorMaxOccupantsReached:'Vous ne pouvez pas entrer dans le salon "%s": Limite d\'utilisateur atteint.',antiSpamMessage:"Merci de ne pas envoyer de spam. Vous avez été bloqué pendant une courte période.."},nl:{status:"Status: %s",statusConnecting:"Verbinding maken...",statusConnected:"Verbinding is gereed",statusDisconnecting:"Verbinding verbreken...",statusDisconnected:"Verbinding is verbroken",statusAuthfail:"Authenticatie is mislukt",sessionRestored:"Session restored",roomSubject:"Onderwerp:",messageSubmit:"Verstuur",labelUsername:"Gebruikersnaam:",labelPassword:"Wachtwoord:",loginSubmit:"Inloggen",loginInvalid:"JID is onjuist",reason:"Reden:",subject:"Onderwerp:",reasonWas:"De reden was: %s.",kickActionLabel:"Verwijderen",youHaveBeenKickedBy:"Je bent verwijderd van %1$s door %2$s",youHaveBeenKicked:"Je bent verwijderd van %s",banActionLabel:"Blokkeren",youHaveBeenBannedBy:"Je bent geblokkeerd van %1$s door %2$s",youHaveBeenBanned:"Je bent geblokkeerd van %s",privateActionLabel:"Prive gesprek",ignoreActionLabel:"Negeren",unignoreActionLabel:"Niet negeren",setSubjectActionLabel:"Onderwerp wijzigen",administratorMessageSubject:"Beheerder",userJoinedRoom:"%s komt de chat binnen.",userLeftRoom:"%s heeft de chat verlaten.",userHasBeenKickedFromRoom:"%s is verwijderd.",userHasBeenBannedFromRoom:"%s is geblokkeerd.",presenceUnknownWarningSubject:"Mededeling:",presenceUnknownWarning:"Deze gebruiker is waarschijnlijk offline, we kunnen zijn/haar aanwezigheid niet vaststellen.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Je negeert deze gebruiker",tooltipEmoticons:"Emotie-iconen",tooltipSound:"Speel een geluid af bij nieuwe berichten.",tooltipAutoscroll:"Automatisch scrollen",tooltipStatusmessage:"Statusberichten weergeven",tooltipAdministration:"Instellingen",tooltipUsercount:"Gebruikers",enterRoomPassword:'De Chatroom "%s" is met een wachtwoord beveiligd.',enterRoomPasswordSubmit:"Ga naar Chatroom",passwordEnteredInvalid:'Het wachtwoord voor de Chatroom "%s" is onjuist.',nicknameConflict:"De gebruikersnaam is reeds in gebruik. Probeer a.u.b. een andere gebruikersnaam.",errorMembersOnly:'Je kunt niet deelnemen aan de Chatroom "%s": Je hebt onvoldoende rechten.',errorMaxOccupantsReached:'Je kunt niet deelnemen aan de Chatroom "%s": Het maximum aantal gebruikers is bereikt.',antiSpamMessage:"Het is niet toegestaan om veel berichten naar de server te versturen. Je bent voor een korte periode geblokkeerd."},es:{status:"Estado: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desconectando...",statusDisconnected:"Desconectado",statusAuthfail:"Falló la autenticación",sessionRestored:"Session restored",roomSubject:"Asunto:",messageSubmit:"Enviar",labelUsername:"Usuario:",labelPassword:"Clave:",loginSubmit:"Entrar",loginInvalid:"JID no válido",reason:"Razón:",subject:"Asunto:",reasonWas:"La razón fue: %s.",kickActionLabel:"Expulsar",youHaveBeenKickedBy:"Has sido expulsado de %1$s por %2$s",youHaveBeenKicked:"Has sido expulsado de %s",banActionLabel:"Prohibir",youHaveBeenBannedBy:"Has sido expulsado permanentemente de %1$s por %2$s",youHaveBeenBanned:"Has sido expulsado permanentemente de %s",privateActionLabel:"Chat privado",ignoreActionLabel:"Ignorar",unignoreActionLabel:"No ignorar",setSubjectActionLabel:"Cambiar asunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s se ha unido a la sala.",userLeftRoom:"%s ha dejado la sala.",userHasBeenKickedFromRoom:"%s ha sido expulsado de la sala.",userHasBeenBannedFromRoom:"%s ha sido expulsado permanentemente de la sala.",presenceUnknownWarningSubject:"Atención:",presenceUnknownWarning:"Éste usuario podría estar desconectado..",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Ignoras a éste usuario",tooltipEmoticons:"Emoticonos",tooltipSound:"Reproducir un sonido para nuevos mensajes",tooltipAutoscroll:"Desplazamiento automático",tooltipStatusmessage:"Mostrar mensajes de estado",tooltipAdministration:"Administración de la sala",tooltipUsercount:"Usuarios en la sala",enterRoomPassword:'La sala "%s" está protegida mediante contraseña.',enterRoomPasswordSubmit:"Unirse a la sala",passwordEnteredInvalid:'Contraseña incorrecta para la sala "%s".',nicknameConflict:"El nombre de usuario ya está siendo utilizado. Por favor elija otro.",errorMembersOnly:'No se puede unir a la sala "%s": no tiene privilegios suficientes.',errorMaxOccupantsReached:'No se puede unir a la sala "%s": demasiados participantes.',antiSpamMessage:"Por favor, no hagas spam. Has sido bloqueado temporalmente."},cn:{status:"状态: %s",statusConnecting:"连接中...",statusConnected:"已连接",statusDisconnecting:"断开连接中...",statusDisconnected:"已断开连接",statusAuthfail:"认证失败",sessionRestored:"Session restored",roomSubject:"主题:",messageSubmit:"发送",labelUsername:"用户名:",labelPassword:"密码:",loginSubmit:"登录",loginInvalid:"用户名不合法",reason:"原因:",subject:"主题:",reasonWas:"原因是: %s.",kickActionLabel:"踢除",youHaveBeenKickedBy:"你在 %1$s 被管理者 %2$s 请出房间",banActionLabel:"禁言",youHaveBeenBannedBy:"你在 %1$s 被管理者 %2$s 禁言",privateActionLabel:"单独对话",ignoreActionLabel:"忽略",unignoreActionLabel:"不忽略",setSubjectActionLabel:"变更主题",administratorMessageSubject:"管理员",userJoinedRoom:"%s 加入房间",userLeftRoom:"%s 离开房间",userHasBeenKickedFromRoom:"%s 被请出这个房间",userHasBeenBannedFromRoom:"%s 被管理者禁言",presenceUnknownWarningSubject:"注意:",presenceUnknownWarning:"这个会员可能已经下线，不能追踪到他的连接信息",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"管理",tooltipIgnored:"你忽略了这个会员",tooltipEmoticons:"表情",tooltipSound:"新消息发音",tooltipAutoscroll:"滚动条",tooltipStatusmessage:"禁用状态消息",tooltipAdministration:"房间管理",tooltipUsercount:"房间占有者",enterRoomPassword:'登录房间 "%s" 需要密码.',enterRoomPasswordSubmit:"加入房间",passwordEnteredInvalid:'登录房间 "%s" 的密码不正确',nicknameConflict:"用户名已经存在，请另选一个",errorMembersOnly:'您的权限不够，不能登录房间 "%s" ',errorMaxOccupantsReached:'房间 "%s" 的人数已达上限，您不能登录',antiSpamMessage:"因为您在短时间内发送过多的消息 服务器要阻止您一小段时间。"},ja:{status:"ステータス: %s",statusConnecting:"接続中…",statusConnected:"接続されました",statusDisconnecting:"ディスコネクト中…",statusDisconnected:"ディスコネクトされました",statusAuthfail:"認証に失敗しました",sessionRestored:"Session restored",roomSubject:"トピック：",messageSubmit:"送信",labelUsername:"ユーザーネーム：",labelPassword:"パスワード：",loginSubmit:"ログイン",loginInvalid:"ユーザーネームが正しくありません",reason:"理由：",subject:"トピック：",reasonWas:"理由: %s。",kickActionLabel:"キック",youHaveBeenKickedBy:"あなたは%2$sにより%1$sからキックされました。",youHaveBeenKicked:"あなたは%sからキックされました。",banActionLabel:"アカウントバン",youHaveBeenBannedBy:"あなたは%2$sにより%1$sからアカウントバンされました。",youHaveBeenBanned:"あなたは%sからアカウントバンされました。",privateActionLabel:"プライベートメッセージ",ignoreActionLabel:"無視する",unignoreActionLabel:"無視をやめる",setSubjectActionLabel:"トピックを変える",administratorMessageSubject:"管理者",userJoinedRoom:"%sは入室しました。",userLeftRoom:"%sは退室しました。",userHasBeenKickedFromRoom:"%sは部屋からキックされました。",userHasBeenBannedFromRoom:"%sは部屋からアカウントバンされました。",presenceUnknownWarningSubject:"忠告：",presenceUnknownWarning:"このユーザーのステータスは不明です。",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"モデレーター",tooltipIgnored:"このユーザーを無視設定にしている",tooltipEmoticons:"絵文字",tooltipSound:"新しいメッセージが届くたびに音を鳴らす",tooltipAutoscroll:"オートスクロール",tooltipStatusmessage:"ステータスメッセージを表示",tooltipAdministration:"部屋の管理",tooltipUsercount:"この部屋の参加者の数",enterRoomPassword:'"%s"の部屋に入るにはパスワードが必要です。',enterRoomPasswordSubmit:"部屋に入る",passwordEnteredInvalid:'"%s"のパスワードと異なるパスワードを入力しました。',nicknameConflict:"このユーザーネームはすでに利用されているため、別のユーザーネームを選んでください。",errorMembersOnly:'"%s"の部屋に入ることができません: 利用権限を満たしていません。',errorMaxOccupantsReached:'"%s"の部屋に入ることができません: 参加者の数はすでに上限に達しました。',antiSpamMessage:"スパムなどの行為はやめてください。あなたは一時的にブロックされました。"},sv:{status:"Status: %s",statusConnecting:"Ansluter...",statusConnected:"Ansluten",statusDisconnecting:"Kopplar från...",statusDisconnected:"Frånkopplad",statusAuthfail:"Autentisering misslyckades",sessionRestored:"Session restored",roomSubject:"Ämne:",messageSubmit:"Skicka",labelUsername:"Användarnamn:",labelPassword:"Lösenord:",loginSubmit:"Logga in",loginInvalid:"Ogiltigt JID",reason:"Anledning:",subject:"Ämne:",reasonWas:"Anledningen var: %s.",kickActionLabel:"Sparka ut",youHaveBeenKickedBy:"Du har blivit utsparkad från %2$s av %1$s",youHaveBeenKicked:"Du har blivit utsparkad från %s",banActionLabel:"Bannlys",youHaveBeenBannedBy:"Du har blivit bannlyst från %1$s av %2$s",youHaveBeenBanned:"Du har blivit bannlyst från %s",privateActionLabel:"Privat chatt",ignoreActionLabel:"Blockera",unignoreActionLabel:"Avblockera",setSubjectActionLabel:"Ändra ämne",administratorMessageSubject:"Administratör",userJoinedRoom:"%s kom in i rummet.",userLeftRoom:"%s har lämnat rummet.",userHasBeenKickedFromRoom:"%s har blivit utsparkad ur rummet.",userHasBeenBannedFromRoom:"%s har blivit bannlyst från rummet.",presenceUnknownWarningSubject:"Notera:",presenceUnknownWarning:"Denna användare kan vara offline. Vi kan inte följa dennes närvaro.",dateFormat:"yyyy-mm-dd",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Du blockerar denna användare",tooltipEmoticons:"Smilies",tooltipSound:"Spela upp ett ljud vid nytt meddelande",tooltipAutoscroll:"Autoskrolla",tooltipStatusmessage:"Visa statusmeddelanden",tooltipAdministration:"Rumadministrering",tooltipUsercount:"Antal användare i rummet",enterRoomPassword:'Rummet "%s" är lösenordsskyddat.',enterRoomPasswordSubmit:"Anslut till rum",passwordEnteredInvalid:'Ogiltigt lösenord för rummet "%s".',nicknameConflict:"Upptaget användarnamn. Var god välj ett annat.",errorMembersOnly:'Du kan inte ansluta till rummet "%s": Otillräckliga rättigheter.',errorMaxOccupantsReached:'Du kan inte ansluta till rummet "%s": Rummet är fullt.',antiSpamMessage:"Var god avstå från att spamma. Du har blivit blockerad för en kort stund."},it:{status:"Stato: %s",statusConnecting:"Connessione...",statusConnected:"Connessione",statusDisconnecting:"Disconnessione...",statusDisconnected:"Disconnesso",statusAuthfail:"Autenticazione fallita",sessionRestored:"Sessione ristabilita",roomSubject:"Oggetto:",messageSubmit:"Invia",labelUsername:"Nome utente:",labelPassword:"Password:",loginSubmit:"Login",loginInvalid:"JID non valido",reason:"Ragione:",subject:"Oggetto:",reasonWas:"Ragione precedente: %s.",kickActionLabel:"Espelli",youHaveBeenKickedBy:"Sei stato espulso da %2$s da %1$s",youHaveBeenKicked:"Sei stato espulso da %s",banActionLabel:"Escluso",youHaveBeenBannedBy:"Sei stato escluso da %1$s da %2$s",youHaveBeenBanned:"Sei stato escluso da %s",privateActionLabel:"Stanza privata",ignoreActionLabel:"Ignora",unignoreActionLabel:"Non ignorare",setSubjectActionLabel:"Cambia oggetto",administratorMessageSubject:"Amministratore",userJoinedRoom:"%s si è unito alla stanza.",userLeftRoom:"%s ha lasciato la stanza.",userHasBeenKickedFromRoom:"%s è stato espulso dalla stanza.",userHasBeenBannedFromRoom:"%s è stato escluso dalla stanza.",presenceUnknownWarningSubject:"Nota:",presenceUnknownWarning:"Questo utente potrebbe essere offline. Non possiamo tracciare la sua presenza.",dateFormat:"dd/mm/yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderatore",tooltipIgnored:"Stai ignorando questo utente",tooltipEmoticons:"Emoticons",tooltipSound:"Riproduci un suono quando arrivano messaggi",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Mostra messaggi di stato",tooltipAdministration:"Amministrazione stanza",tooltipUsercount:"Partecipanti alla stanza",enterRoomPassword:'La stanza "%s" è protetta da password.',enterRoomPasswordSubmit:"Unisciti alla stanza",passwordEnteredInvalid:'Password non valida per la stanza "%s".',nicknameConflict:"Nome utente già in uso. Scegline un altro.",errorMembersOnly:'Non puoi unirti alla stanza "%s": Permessi insufficienti.',errorMaxOccupantsReached:'Non puoi unirti alla stanza "%s": Troppi partecipanti.',antiSpamMessage:"Per favore non scrivere messaggi pubblicitari. Sei stato bloccato per un po' di tempo."},pt:{status:"Status: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desligando...",statusDisconnected:"Desligado",statusAuthfail:"Falha na autenticação",sessionRestored:"Session restored",roomSubject:"Assunto:",messageSubmit:"Enviar",labelUsername:"Usuário:",labelPassword:"Senha:",loginSubmit:"Entrar",loginInvalid:"JID inválido",reason:"Motivo:",subject:"Assunto:",reasonWas:"O motivo foi: %s.",kickActionLabel:"Excluir",youHaveBeenKickedBy:"Você foi excluido de %1$s por %2$s",youHaveBeenKicked:"Você foi excluido de %s",banActionLabel:"Bloquear",youHaveBeenBannedBy:"Você foi excluido permanentemente de %1$s por %2$s",youHaveBeenBanned:"Você foi excluido permanentemente de %s",privateActionLabel:"Bate-papo privado",ignoreActionLabel:"Ignorar",unignoreActionLabel:"Não ignorar",setSubjectActionLabel:"Trocar Assunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s entrou na sala.",userLeftRoom:"%s saiu da sala.",userHasBeenKickedFromRoom:"%s foi excluido da sala.",userHasBeenBannedFromRoom:"%s foi excluido permanentemente da sala.",presenceUnknownWarning:"Este usuário pode estar desconectado. Não é possível determinar o status.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Você ignora este usuário",tooltipEmoticons:"Emoticons",tooltipSound:"Reproduzir o som para novas mensagens",tooltipAutoscroll:"Deslocamento automático",tooltipStatusmessage:"Mostrar mensagens de status",tooltipAdministration:"Administração da sala",tooltipUsercount:"Usuários na sala",enterRoomPassword:'A sala "%s" é protegida por senha.',enterRoomPasswordSubmit:"Junte-se à sala",passwordEnteredInvalid:'Senha incorreta para a sala "%s".',nicknameConflict:"O nome de usuário já está em uso. Por favor, escolha outro.",errorMembersOnly:'Você não pode participar da sala "%s":  privilégios insuficientes.',errorMaxOccupantsReached:'Você não pode participar da sala "%s": muitos participantes.',antiSpamMessage:"Por favor, não envie spam. Você foi bloqueado temporariamente."},pt_br:{status:"Estado: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desconectando...",statusDisconnected:"Desconectado",statusAuthfail:"Autenticação falhou",sessionRestored:"Session restored",roomSubject:"Assunto:",messageSubmit:"Enviar",labelUsername:"Usuário:",labelPassword:"Senha:",loginSubmit:"Entrar",loginInvalid:"JID inválido",reason:"Motivo:",subject:"Assunto:",reasonWas:"Motivo foi: %s.",kickActionLabel:"Derrubar",youHaveBeenKickedBy:"Você foi derrubado de %2$s por %1$s",youHaveBeenKicked:"Você foi derrubado de %s",banActionLabel:"Banir",youHaveBeenBannedBy:"Você foi banido de %1$s por %2$s",youHaveBeenBanned:"Você foi banido de %s",privateActionLabel:"Conversa privada",ignoreActionLabel:"Ignorar",unignoreActionLabel:"Não ignorar",setSubjectActionLabel:"Mudar Assunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s entrou na sala.",userLeftRoom:"%s saiu da sala.",userHasBeenKickedFromRoom:"%s foi derrubado da sala.",userHasBeenBannedFromRoom:"%s foi banido da sala.",presenceUnknownWarningSubject:"Aviso:",presenceUnknownWarning:"Este usuário pode estar desconectado.. Não conseguimos rastrear sua presença..",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Você ignora este usuário",tooltipEmoticons:"Emoticons",tooltipSound:"Tocar som para novas mensagens",tooltipAutoscroll:"Auto-rolagem",tooltipStatusmessage:"Exibir mensagens de estados",tooltipAdministration:"Administração de Sala",tooltipUsercount:"Participantes da Sala",enterRoomPassword:'Sala "%s" é protegida por senha.',enterRoomPasswordSubmit:"Entrar na sala",passwordEnteredInvalid:'Senha inváida para sala "%s".',nicknameConflict:"Nome de usuário já em uso. Por favor escolha outro.",errorMembersOnly:'Você não pode entrar na sala "%s": privilégios insuficientes.',errorMaxOccupantsReached:'Você não pode entrar na sala "%s": máximo de participantes atingido.',antiSpamMessage:"Por favor, não faça spam. Você foi bloqueado temporariamente."},ru:{status:"Статус: %s",statusConnecting:"Подключение...",statusConnected:"Подключено",statusDisconnecting:"Отключение...",statusDisconnected:"Отключено",statusAuthfail:"Неверный логин",sessionRestored:"Session restored",roomSubject:"Топик:",messageSubmit:"Послать",labelUsername:"Имя:",labelPassword:"Пароль:",loginSubmit:"Логин",loginInvalid:"Неверный JID",reason:"Причина:",subject:"Топик:",reasonWas:"Причина была: %s.",kickActionLabel:"Выбросить",youHaveBeenKickedBy:"Пользователь %1$s выбросил вас из чата %2$s",youHaveBeenKicked:"Вас выбросили из чата %s",banActionLabel:"Запретить доступ",youHaveBeenBannedBy:"Пользователь %1$s запретил вам доступ в чат %2$s",youHaveBeenBanned:"Вам запретили доступ в чат %s",privateActionLabel:"Один-на-один чат",ignoreActionLabel:"Игнорировать",unignoreActionLabel:"Отменить игнорирование",setSubjectActionLabel:"Изменить топик",administratorMessageSubject:"Администратор",userJoinedRoom:"%s вошёл в чат.",userLeftRoom:"%s вышел из чата.",userHasBeenKickedFromRoom:"%s выброшен из чата.",userHasBeenBannedFromRoom:"%s запрещён доступ в чат.",presenceUnknownWarningSubject:"Уведомление:",presenceUnknownWarning:"Этот пользователь вероятнее всего оффлайн.",dateFormat:"mm.dd.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Модератор",tooltipIgnored:"Вы игнорируете этого пользователя.",tooltipEmoticons:"Смайлики",tooltipSound:"Озвучивать новое сообщение",tooltipAutoscroll:"Авто-прокручивание",tooltipStatusmessage:"Показывать статус сообщения",tooltipAdministration:"Администрирование чат комнаты",tooltipUsercount:"Участники чата",enterRoomPassword:'Чат комната "%s" защищена паролем.',enterRoomPasswordSubmit:"Войти в чат",passwordEnteredInvalid:'Неверный пароль для комнаты "%s".',nicknameConflict:"Это имя уже используется. Пожалуйста выберите другое имя.",errorMembersOnly:'Вы не можете войти в чат "%s": Недостаточно прав доступа.',errorMaxOccupantsReached:'Вы не можете войти в чат "%s": Слишком много участников.',antiSpamMessage:"Пожалуйста не рассылайте спам. Вас заблокировали на короткое время."},ca:{status:"Estat: %s",statusConnecting:"Connectant...",statusConnected:"Connectat",statusDisconnecting:"Desconnectant...",statusDisconnected:"Desconnectat",statusAuthfail:"Ha fallat la autenticació",sessionRestored:"Session restored",roomSubject:"Assumpte:",messageSubmit:"Enviar",labelUsername:"Usuari:",labelPassword:"Clau:",loginSubmit:"Entrar",loginInvalid:"JID no vàlid",reason:"Raó:",subject:"Assumpte:",reasonWas:"La raó ha estat: %s.",kickActionLabel:"Expulsar",youHaveBeenKickedBy:"Has estat expulsat de %1$s per %2$s",youHaveBeenKicked:"Has estat expulsat de %s",banActionLabel:"Prohibir",youHaveBeenBannedBy:"Has estat expulsat permanentment de %1$s per %2$s",youHaveBeenBanned:"Has estat expulsat permanentment de %s",privateActionLabel:"Xat privat",ignoreActionLabel:"Ignorar",unignoreActionLabel:"No ignorar",setSubjectActionLabel:"Canviar assumpte",administratorMessageSubject:"Administrador",userJoinedRoom:"%s ha entrat a la sala.",userLeftRoom:"%s ha deixat la sala.",userHasBeenKickedFromRoom:"%s ha estat expulsat de la sala.",userHasBeenBannedFromRoom:"%s ha estat expulsat permanentment de la sala.",presenceUnknownWarningSubject:"Atenció:",presenceUnknownWarning:"Aquest usuari podria estar desconnectat ...",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Estàs ignorant aquest usuari",tooltipEmoticons:"Emoticones",tooltipSound:"Reproduir un so per a nous missatges",tooltipAutoscroll:"Desplaçament automàtic",tooltipStatusmessage:"Mostrar missatges d'estat",tooltipAdministration:"Administració de la sala",tooltipUsercount:"Usuaris dins la sala",enterRoomPassword:'La sala "%s" està protegida amb contrasenya.',enterRoomPasswordSubmit:"Entrar a la sala",passwordEnteredInvalid:'Contrasenya incorrecta per a la sala "%s".',nicknameConflict:"El nom d'usuari ja s'està utilitzant. Si us plau, escolleix-ne un altre.",errorMembersOnly:'No pots unir-te a la sala "%s": no tens prous privilegis.',errorMaxOccupantsReached:'No pots unir-te a la sala "%s": hi ha masses participants.',antiSpamMessage:"Si us plau, no facis spam. Has estat bloquejat temporalment."}};window.Candy=Candy}function buildCandies(){if(!window.Candy)throw Ifm.Diagnostics.Errors.miss("Candy");Candy.View.Translation.en.labelNickname="Your name:";Candy.View.Translation.en.loginSubmit="Enter chat";Candy.View.Translation.en.userJoinedRoom="%s has entered the conversation.";Candy.View.Translation.en.userLeftRoom="%s has left the conversation.";Candy.View.Translation.it.labelNickname="Il tuo nome:";Candy.View.Translation.it.loginSubmit="Entra in chat";Candy.View.Translation.it.userJoinedRoom="%s è entrato nella conversazione.";Candy.View.Translation.it.userLeftRoom="%s ha lasciato la conversazione.";var baseInfoMessage=Candy.View.Pane.Chat.onInfoMessage;Candy.View.Pane.Chat.onInfoMessage=function(roomJid,subject,message){if(Candy.View.Pane.Room.getPane(roomJid)){var lastmessage=Candy.View.Pane.Room.getPane(roomJid,".message-pane").children().last().text();lastmessage.indexOf(subject)<0&&lastmessage.indexOf(message)<0&&baseInfoMessage(roomJid,subject,message)}};Candy.Core.isConnected=function(){return Candy.Core.getConnection().connected};Candy.Core.getUsername=function(){return Candy.Core.getUser().getNick()};Candy.Core.getRoomUserByName=function(roomJid,name){var room=Candy.Core.getRoom(roomJid),users,i;if(room){users=room.roster.getAll();for(i in users)if(Strophe.getResourceFromJid(users[i].getJid())===name)return users[i]}return null};Candy.Core.available=function(target){var presence=$pres({from:Candy.Core.getConnection().jid,to:target});Ifm.Diagnostics.Debug.print("[Candy] [Extensions] sending availability to",target);Candy.Core.getConnection().send(presence)};Candy.Core.subscribe=function(target,presencenick,presencestatus){var id="pres:"+Candy.Core.getConnection().getUniqueId(),presence=$pres({from:Candy.Core.getConnection().jid,to:target,id:id,type:"subscribe"});presencenick&&presence.c("nick",{xmlns:"http://jabber.org/protocol/nick"},presencenick);presencestatus&&presence.c("status",{},presencestatus);Ifm.Diagnostics.Debug.print("[Candy] [Extensions] requesting subscription to",target,"(id",id,")",presencenick?"as "+presencenick:"");Candy.Core.getConnection().send(presence)};Candy.Core.subscribed=function(target,replyid){var id=replyid||"pres:"+Candy.Core.getConnection().getUniqueId(),presence=$pres({from:Candy.Core.getConnection().jid,to:target,id:id,type:"subscribed"});Ifm.Diagnostics.Debug.print("[Candy] [Extensions] replying subscription to",target,"(id",id,")");Candy.Core.getConnection().send(presence)};Candy.Core.notifystate=function(roomJid,state){var msg=$msg({from:Candy.Core.getConnection().jid,to:roomJid,type:"groupchat"}).c(state,{xmlns:"http://jabber.org/protocol/chatstates"});Ifm.Diagnostics.Debug.print("[Candy] [Extensions] sending",state,"notification");Candy.Core.getConnection().send(msg)};Candy.View.deletenotification=function(roomJid){var pane=Candy.View.Pane.Room.getPane(roomJid),messages,data;pane&&(messages=Candy.View.Pane.Room.getPane(roomJid,".message-pane"),data=pane.data(),data.resetnotificationtmr&&(clearTimeout(data.resetnotificationtmr),data.resetnotificationtmr=0),messages.find("[name=chat-state-message]").remove())};Candy.View.movenotification=function(roomJid){if(Candy.View.Pane.Room.getPane(roomJid)){var messages=Candy.View.Pane.Room.getPane(roomJid,".message-pane"),notification=messages.find("[name=chat-state-message]");notification.length&&messages.append(notification)}};Candy.View.updatenotification=function(roomJid,displayName,state,message){var pane,html;Candy.View.deletenotification(roomJid);pane=Candy.View.Pane.Room.getPane(roomJid);pane&&(html=Mustache.to_html(Candy.View.Template.Chat.stateMessage,{subject:displayName,message:message}),Candy.View.Pane.Room.appendToMessagePane(roomJid,html),pane.data({resetnotificationtmr:setTimeout(function(){Candy.View.deletenotification(roomJid)},1e4)}))};window.Candies=window.Candies||{};Candies.appendToMessagePane=function(roomJid,message,sentFromHere,name){name=name||"";var now=new Date,template=Candy.View.Template.Message.item,templateData={name:name,displayName:Candy.Util.getDisplayName(name),croppedDisplayName:Candy.Util.crop(Candy.Util.getDisplayName(name),Candy.View.getOptions().crop.message.nickname),message:message,time:Candy.Util.localizedTime(now.toGMTString()),timestamp:now.toISOString(),stamp:now.valueOf(),id:"",seqId:0x8000000000000,roomJid:roomJid,sender:sentFromHere?"sender-is-me":"sender-is-other"},html=Mustache.to_html(template,templateData);Candy.View.Pane.Room.appendToMessagePane(roomJid,html)};Candies.send=function(roomJid,message){Candy.Core.Action.Jabber.Room.Message(roomJid,message.toString())};Candies.sysMessage=function(roomJid,type){for(var msg=new Ifm.Messaging.FStringMessageWriter(type),i=2;i<arguments.length;i++)msg.add(arguments[i]);Candies.send(roomJid,msg.end())};Candies.getRoomHistory=function(roomJid){Candy.Core.debug("Getting messages of room "+roomJid);var seqId=0;Candy.Core.getConnection().mam.query(roomJid,{onMessage:function(message){seqId+=1;var msg=$(message),originalMsg=msg.find("forwarded message"),from=Candy.Util.unescapeJid(originalMsg.attr("from")),name=Strophe.getResourceFromJid(from),nom={roomJid:roomJid,message:{name:name,body:originalMsg.children("body").text(),type:originalMsg.attr("type"),attributes:{xmlns:originalMsg.attr("xmlns"),to:msg.attr("to"),type:originalMsg.attr("type"),id:originalMsg.attr("id"),from:from,seqId:seqId}},timestamp:msg.find("forwarded delay").attr("stamp")};return Candy.View.Observer.Message(null,nom),!0},onComplete:function(response){Candy.Core.debug("[MAM] Response "+response);Candy.Core.debug("Got all messages of room "+roomJid);seqId===0&&Candies.sysMessage(roomJid,"CONTINUITY");Candy.View.Pane.Chat.onInfoMessage(roomJid,$.i18n._("sessionRestored"));Candy.View.Pane.Room.scrollToBottom(roomJid)}})}}var Occupant,RoomConfig,XmppRoom,__bind,Mustache,dateFormat,Candy;namespace("Ifm.Net").WebSocket=function(){function getCloseReason(code){switch(code){case"403":return": no destination for protocol";case"500":return": client-gateway protocol error";case"502":return": gateway-server protocol error";case"503":return": no destination reachable";default:return""}}var factory={},id;return factory.ErrorReasons={Failed:"Connection failed",Lost:"Connection lost",Refused:"Connection refused"},factory.MessageType={BINARY:"Binary",OBJECT:"Object",TEXT:"Text"},factory.isSupported=function(){return global&&global.Ifm&&global.WebSocket?!0:!1},factory.create=function(url,protocol){var instance,ws,wasOpen;if(!factory.isSupported())throw Ifm.Diagnostics.Errors.notsup("WebSocket");if(!Ifm.Type.isString(url))throw Ifm.Diagnostics.Errors.arg("url");return instance={},instance.events=defineEvents("connecting","open","closing","closed","error","receive"),instance.id=function(){return id+=1}(),instance.connect=function(){function open(){wasOpen||(console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",id,url,protocol,"onopen"),wasOpen=!0,instance.events.open.raise(instance,{}))}if(!ws||!(ws.readyState<WebSocket.CLOSING)){instance.events.connecting.raise(instance,{});try{ws=protocol?new WebSocket(url,protocol):new WebSocket(url)}catch(err){instance.events.error.raise(instance,{error:err});instance.events.closed.raise(instance,{clean:!1,reason:Ifm.Net.WebSocket.ErrorReasons.Failed});return}ws.onmessage=function(e){var s,o;if(Ifm.Type.isString(e.data)){if(s=e.data,s.startsWith("#close")){var parts=s.split("|"),code=parts.length>1?parts[1]:"0",reason=code+getCloseReason(code);console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s (%s)",id,url,protocol,"close notification",reason);return}if(open(),s.startsWith("{")&&s.endsWith("}")){o=null;try{o=JSON.parse(s)}catch(err){}if(o!==null){instance.events.receive.raise(instance,{type:factory.MessageType.OBJECT,message:o});return}}instance.events.receive.raise(instance,{type:factory.MessageType.TEXT,message:s})}else open(),instance.events.receive.raise(instance,{type:factory.MessageType.BINARY,message:e.data})};ws.onclose=function(e){console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s (code: %d)",id,url,protocol,"onclose",e.code);instance.events.closed.raise(instance,{clean:e.wasClean,reason:e.wasClean?"":wasOpen?Ifm.Net.WebSocket.ErrorReasons.Lost:Ifm.Net.WebSocket.ErrorReasons.Refused});wasOpen=!1;ws=null};ws.onerror=function(e){instance.events.error.raise(instance,e)}}},instance.close=function(){(console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",id,url,protocol,"close"),ws&&ws.readyState!==WebSocket.CLOSED)&&(instance.events.closing.raise(instance,{}),ws.close())},instance.send=function(message){if(!ws||ws.readyState!==WebSocket.OPEN)throw Ifm.Diagnostics.Errors.op("WebSocket not open");ws.send(message)},Object.defineProperties(instance,{isOpen:{get:function(){return instance.state===WebSocket.OPEN}},state:{get:function(){return ws?ws.readyState:WebSocket.CLOSED}}}),ws=null,wasOpen=!1,instance},id=0,factory}();namespace("Ifm.Net").Peer=function(){var factory={};return factory.isSupported=function(){return Ifm&&Ifm.Net&&Ifm.Net.WebSocket&&Ifm.Net.WebSocket.isSupported()?!0:!1},factory.query=function(url,protocol,query,callback){factory.create(url,protocol,function(peer){peer?peer.query(query,function(response){callback(response);peer.close()}):callback(null)})},factory.create=function(url,protocol,callback){function resetEvents(){ws.events.closed.removeAllHandlers();ws.events.receive.removeAllHandlers()}var instance,ws;if(!factory.isSupported())throw Ifm.Diagnostics.Errors.notsup("Peer");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");return instance={},instance.query=function(query,callback){if(!Ifm.Type.isString(query))throw Ifm.Diagnostics.Errors.arg("query");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");resetEvents();ws.events.closed=function(){resetEvents();callback(null)};ws.events.receive=function(ws,e){resetEvents();callback(e)};ws.isOpen?ws.send(query):callback(null)},instance.receive=function(callback){if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");resetEvents();ws.events.closed=function(){callback(null)};ws.events.receive=function(ws,e){callback(e)}},instance.send=function(message){ws.isOpen&&ws.send(message)},instance.close=function(){resetEvents();ws.close()},ws=Ifm.Net.WebSocket.create(url,protocol),ws.events.closed=function(){resetEvents();callback(null)},ws.events.receive=function(ws,e){if(resetEvents(),e.type===Ifm.Net.WebSocket.MessageType.TEXT){var parts=e.message.split("|");switch(parts[0]){case"#ready":callback(instance);return;case"#close":console.warn(parts[1]||"Forcibly closed by server");ws.close();callback(null);return}}console.warn("[Ifm.Net.Services.Peer] Unexpected message from server",e.message);ws.close();callback(null)},ws.connect(),instance},factory}();namespace("Ifm.Net").TimeProvider=function(){function TimeProvider(urls){if(!(this instanceof TimeProvider))throw Ifm.Diagnostics.Errors.ctor("TimeProvider");if(!Ifm.Net.WebSocket)throw Ifm.Diagnostics.Errors.miss("Ifm.Net.WebSocket");if(!urls||Ifm.Type.isArray(urls)&&urls.length===0)throw Ifm.Diagnostics.Errors.arg("urls");urls=Ifm.Type.isArray(urls)?urls:[urls];setTimeout(_connect.bind(this,urls,0))}function _connect(urls,index){var url=index<urls.length?urls[index]:urls[index=0],ws,self;if(url.startsWith("*")){console.debug(THIS+" Skipping unsupported url: "+url);urls.splice(index,1);urls.length>0?_connectNext.call(this,urls,index):console.debug(THIS+" No valid url to connect to, using native timers");return}console.debug(THIS+" Connecting to "+url);ws=Ifm.Net.WebSocket.create(url,"itp");this._ws=ws;self=this;ws.events.open=function(){console.debug(THIS+" Connected, using remote timers")};ws.events.closed=function(ws,e){console.debug(THIS+" "+(e.reason||"Disconnected"));_disconnectAllTimers.call(self);_connectNext.call(self,urls,index+1)};ws.events.receive=function(ws,e){console.assert(e.type===Ifm.Net.WebSocket.MessageType.TEXT);_receive.call(self,e.message)};ws.connect()}function _connectNext(urls,index){this._closed||setTimeout(_connect.bind(this,urls,index+1),5e3)}function _createTimer(type,delay,fn,argArray){var id=getNextId(),nativeFn;return timers[id]={callback:fn.bind.apply(fn,[window].concat(argArray)),type:type,delay:delay,owner:this},this._ws&&this._ws.isOpen?_send.call(this,COMMAND_SET,id,type,delay>0?delay:0):(nativeFn=type===TYPE_TIMEOUT?setTimeout:setInterval,timers[id].nativeId=nativeFn(_tickTimer.bind(this,id),delay)),id}function _disconnectAllTimers(){for(var id in timers)timers[id].nativeId||timers[id].owner!==this||(timers[id].type===TYPE_TIMEOUT?(console.debug(THIS+" Invoking immediate tick for timer "+id),_tickTimer.call(this,id)):timers[id].type===TYPE_INTERVAL&&(console.debug(THIS+" Converting remote to native timer "+id),timers[id].nativeId=setInterval(timers[id].callback,timers[id].delay)))}function _removeTimer(id){id&&id in timers&&(timers[id].nativeId?clearTimeout(timers[id].nativeId):_send.call(this,COMMAND_CLEAR,id),delete timers[id])}function _receive(message){var parts=message.split(MSG_SEP),event,id;console.assert(parts[0].startsWith(MSG_HDR));event=parts[0].substr(1);event===EVENT_TICK&&(id=Number(parts[1]),_tickTimer.call(this,id))}function _send(action,id,type,delay){var args=[action,id],message;type!==undefined&&args.push(type);delay!==undefined&&args.push(delay);message=MSG_HDR+args.join(MSG_SEP);this._ws.send(message)}function _tickTimer(id){if(id&&id in timers){var timer=timers[id];timer.callback();timer.type===TYPE_TIMEOUT&&delete timers[id]}}function skip(num,items){return items.length>num?Array.prototype.splice.call(items,num):[]}function getNextId(){return nextId+=1}var I;TimeProvider.getDefault=function(){if(Ifm.Net.timeProvider instanceof TimeProvider)return Ifm.Net.timeProvider;if(TimeProvider.settings){var urls=TimeProvider.settings.service;if(urls)return Ifm.Net.timeProvider=new TimeProvider(urls),Ifm.Net.timeProvider}return window};I=TimeProvider.prototype;I.close=function(){this._closed=!0;this._ws.close()};I.clearInterval=function(id){_removeTimer.call(this,id)};I.clearTimeout=function(id){_removeTimer.call(this,id)};I.setInterval=function(fn,delay,args){if(!Ifm.Type.isFunction(fn))throw Ifm.Diagnostics.Errors.func("fn");return args=skip(2,arguments),_createTimer.call(this,TYPE_INTERVAL,delay,fn,args)};I.setTimeout=function(fn,delay,args){if(!Ifm.Type.isFunction(fn))throw Ifm.Diagnostics.Errors.func("fn");return args=skip(2,arguments),_createTimer.call(this,TYPE_TIMEOUT,delay,fn,args)};var THIS="[Ifm.Net.TimeProvider]",COMMAND_CLEAR="clear",COMMAND_SET="set",EVENT_TICK="tick",TYPE_INTERVAL="0",TYPE_TIMEOUT="1",MSG_HDR="#",MSG_SEP="|",nextId=0,timers={};return TimeProvider}();namespace("Ifm.Net.Services").FileTransfer=function(){var factory={};factory.ErrorReasons={Unavailable:"Service unavailable",RequestRefused:"Request refused",InvalidToken:"Invalid token",FileCorrupted:"File corrupted",FileReadError:"File read error",SecurityError:"Security error: {err}"};factory.isSupported=function(){return global&&global.Ifm&&Ifm.Net.Peer&&Ifm.Net.Peer.isSupported()&&global.File&&global.FileList&&global.FileReader&&global.Blob?!0:!1};factory.create=function(url){if(!factory.isSupported())throw Ifm.Diagnostics.Errors.notsup("FileTransfer");var instance={};return instance.events=defineEvents("waiting","started","progress","finished","canceled","error"),instance.id=function(){return id+=1}(),instance.isSender=undefined,instance.enabled=function(callback){if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");Ifm.Net.Peer.query(url,protocol,"#enabled",function(e){callback(e&&e.message||!1)})},instance.receive=function(token){if(!Ifm.Type.isString(token))throw Ifm.Diagnostics.Errors.arg("token");if(instance.isSender!==undefined)throw Ifm.Diagnostics.Errors.op("FileTransfer instance already in use");instance.isSender=!1;var BIN=Ifm.Net.WebSocket.MessageType.BINARY,OBJ=Ifm.Net.WebSocket.MessageType.OBJECT,TXT=Ifm.Net.WebSocket.MessageType.TEXT,errors=Ifm.Net.Services.FileTransfer.ErrorReasons,blobs=[],name,size,type;Ifm.Net.Peer.create(url,protocol,function(peer){if(!peer){instance.events.error.raise(instance,{reason:errors.Unavailable});return}instance.accept=function(){instance.accept=function(){};peer.send("#start")};instance.cancel=function(){instance.cancel=function(){};peer.send("#cancel");peer.close();instance.events.canceled.raise(instance,{})};peer.receive(function(e){var parts,blob;if(!e){instance.events.error.raise(instance,{reason:errors.RequestRefused});return}if(e.type===TXT){parts=e.message.split("|");switch(parts[0]){case"#invalidtoken":peer.close();instance.events.error.raise(instance,{reason:errors.InvalidToken});break;case"#cancel":instance.cancel();break;case"#paired":instance.events.waiting.raise(instance,{token:token});break;case"#info":name=parts[1];size=Number(parts[2]);type=parts[3];instance.events.started.raise(instance,{});break;case"#finished":if(instance.cancel=function(){},peer.close(),blob=new Blob(blobs,{type:type}),blob.size!==size){instance.events.error.raise(instance,{reason:errors.FileCorrupted});return}instance.events.finished.raise(instance,{fileBlob:blob,openOrSaveFunc:function(){if(Ifm.Type.isFunction(window.navigator.msSaveOrOpenBlob))window.navigator.msSaveOrOpenBlob(blob,name);else{var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=name;a.target="_blank";a.style.cssText="display:none!important;";document.body.appendChild(a);a.click();document.body.removeChild(a)}return!1}});break;default:console.warn("[Ifm.Net.Services.FileTransfer] %s Unexpected message: %s","receive()",e.message)}}else e.type===BIN&&(blobs.push(e.message),instance.events.progress.raise(instance,{percentage:Math.ceil(blobs.length*chunkSize*100/size)}))});peer.send("#receive|"+token)})},instance.transfer=function(file){if(!(file instanceof File))throw Ifm.Diagnostics.Errors.arg("file");if(instance.isSender!==undefined)throw Ifm.Diagnostics.Errors.op("FileTransfer instance already in use");instance.isSender=!0;var BIN=Ifm.Net.WebSocket.MessageType.BINARY,OBJ=Ifm.Net.WebSocket.MessageType.OBJECT,TXT=Ifm.Net.WebSocket.MessageType.TEXT,errors=Ifm.Net.Services.FileTransfer.ErrorReasons,offset=0,iscanceled=!1;Ifm.Net.Peer.create(url,protocol,function(peer){if(!peer){instance.events.error.raise(instance,{reason:errors.Unavailable});return}instance.cancel=function(){instance.cancel=function(){};iscanceled=!0;reader&&(reader.onloadend=function(){},reader.onerror=function(){},reader.abort(),reader=null);peer.send("#cancel");peer.close();instance.events.canceled.raise(instance,{})};var reader=new FileReader;reader.onloadend=function(){var end,blob;iscanceled||reader.readyState===FileReader.DONE&&(peer.send(reader.result),offset+=chunkSize,end=offset+Math.min(chunkSize,file.size-offset),offset<file.size?(instance.events.progress.raise(instance,{percentage:Math.ceil(offset*100/file.size)}),blob=file.slice(offset,end),reader.readAsArrayBuffer(blob)):(instance.cancel=function(){},peer.send("#finished"),peer.close(),instance.events.finished.raise(instance,{fileBlob:file,openOrSaveFunc:null})))};reader.onerror=function(){peer.close();instance.events.error.raise(instance,{reason:errors.FileReadError})};peer.receive(function(e){var parts,blob;if(!e){instance.events.error.raise(instance,{reason:errors.RequestRefused});return}if(e.type===TXT){parts=e.message.split("|");switch(parts[0]){case"#denied":peer.close();instance.events.error.raise(instance,{reason:errors.SecurityError.replace("{err}",parts[1])});break;case"#cancel":instance.cancel();break;case"#token":instance.events.waiting.raise(instance,{token:parts[1]});break;case"#paired":break;case"#start":peer.send("#info|"+file.name+"|"+file.size+"|"+file.type);instance.events.started.raise(instance,{});blob=file.slice(offset,Math.min(chunkSize,file.size));reader.readAsArrayBuffer(blob);break;default:console.warn("[Ifm.Net.Services.FileTransfer] %s Unexpected message: %s","transfer()",e.message)}}});peer.send("#transfer|"+file.name+"|"+file.size+"|"+file.type)})},instance.accept=function(){},instance.cancel=function(){},instance};var protocol="ift",chunkSize=32768,id=0;return factory}();
/*!
 * IFM Strophe bundle 1.3.0-3823
 * Copyright (c) IFM Infomaster. All rights reserved.
 */
(function(callback){if(function(root,factory){typeof define=="function"&&define.amd?define("strophe-base64",function(){return factory()}):root.Base64=factory()}(globalThis,function(){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(input){var output="",chr1,chr2,chr3,enc1,enc2,enc3,enc4,i=0;do chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(chr1&3)<<4|chr2>>4,enc3=(chr2&15)<<2|chr3>>6,enc4=chr3&63,isNaN(chr2)?(enc2=(chr1&3)<<4,enc3=enc4=64):isNaN(chr3)&&(enc4=64),output=output+keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4);while(i<input.length);return output},decode:function(input){var output="",chr1,chr2,chr3,enc1,enc2,enc3,enc4,i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do enc1=keyStr.indexOf(input.charAt(i++)),enc2=keyStr.indexOf(input.charAt(i++)),enc3=keyStr.indexOf(input.charAt(i++)),enc4=keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(enc2&15)<<4|enc3>>2,chr3=(enc3&3)<<6|enc4,output=output+String.fromCharCode(chr1),enc3!=64&&(output=output+String.fromCharCode(chr2)),enc4!=64&&(output=output+String.fromCharCode(chr3));while(i<input.length);return output}}}),function(root,factory){typeof define=="function"&&define.amd?define("strophe-sha1",function(){return factory()}):root.SHA1=factory()}(globalThis,function(){function core_sha1(x,len){x[len>>5]|=128<<24-len%32;x[(len+64>>9<<4)+15]=len;for(var w=new Array(80),a=1732584193,b=-271733879,c=-1732584194,d=271733878,e=-1009589776,j,t,olda,oldb,oldc,oldd,olde,i=0;i<x.length;i+=16){for(olda=a,oldb=b,oldc=c,oldd=d,olde=e,j=0;j<80;j++)w[j]=j<16?x[i+j]:rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1),t=safe_add(safe_add(rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j))),e=d,d=c,c=rol(b,30),b=a,a=t;a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);e=safe_add(e,olde)}return[a,b,c,d,e]}function sha1_ft(t,b,c,d){return t<20?b&c|~b&d:t<40?b^c^d:t<60?b&c|b&d|c&d:b^c^d}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function core_hmac_sha1(key,data){var bkey=str2binb(key),ipad,opad,i,hash;for(bkey.length>16&&(bkey=core_sha1(bkey,key.length*8)),ipad=new Array(16),opad=new Array(16),i=0;i<16;i++)ipad[i]=bkey[i]^909522486,opad[i]=bkey[i]^1549556828;return hash=core_sha1(ipad.concat(str2binb(data)),512+data.length*8),core_sha1(opad.concat(hash),672)}function safe_add(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function rol(num,cnt){return num<<cnt|num>>>32-cnt}function str2binb(str){for(var bin=[],i=0;i<str.length*8;i+=8)bin[i>>5]|=(str.charCodeAt(i/8)&255)<<24-i%32;return bin}function binb2str(bin){for(var str="",i=0;i<bin.length*32;i+=8)str+=String.fromCharCode(bin[i>>5]>>>24-i%32&255);return str}function binb2b64(binarray){for(var str="",triplet,j,i=0;i<binarray.length*4;i+=3)for(triplet=(binarray[i>>2]>>8*(3-i%4)&255)<<16|(binarray[i+1>>2]>>8*(3-(i+1)%4)&255)<<8|binarray[i+2>>2]>>8*(3-(i+2)%4)&255,j=0;j<4;j++)str+=i*8+j*6>binarray.length*32?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(triplet>>6*(3-j)&63);return str}return{b64_hmac_sha1:function(key,data){return binb2b64(core_hmac_sha1(key,data))},b64_sha1:function(s){return binb2b64(core_sha1(str2binb(s),s.length*8))},binb2str:binb2str,core_hmac_sha1:core_hmac_sha1,str_hmac_sha1:function(key,data){return binb2str(core_hmac_sha1(key,data))},str_sha1:function(s){return binb2str(core_sha1(str2binb(s),s.length*8))}}}),function(root,factory){typeof define=="function"&&define.amd?define("strophe-md5",function(){return factory()}):root.MD5=factory()}(globalThis,function(){var safe_add=function(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535},bit_rol=function(num,cnt){return num<<cnt|num>>>32-cnt},str2binl=function(str){for(var bin=[],i=0;i<str.length*8;i+=8)bin[i>>5]|=(str.charCodeAt(i/8)&255)<<i%32;return bin},binl2str=function(bin){for(var str="",i=0;i<bin.length*32;i+=8)str+=String.fromCharCode(bin[i>>5]>>>i%32&255);return str},binl2hex=function(binarray){for(var hex_tab="0123456789abcdef",str="",i=0;i<binarray.length*4;i++)str+=hex_tab.charAt(binarray[i>>2]>>i%4*8+4&15)+hex_tab.charAt(binarray[i>>2]>>i%4*8&15);return str},md5_cmn=function(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)},md5_ff=function(a,b,c,d,x,s,t){return md5_cmn(b&c|~b&d,a,b,x,s,t)},md5_gg=function(a,b,c,d,x,s,t){return md5_cmn(b&d|c&~d,a,b,x,s,t)},md5_hh=function(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)},md5_ii=function(a,b,c,d,x,s,t){return md5_cmn(c^(b|~d),a,b,x,s,t)},core_md5=function(x,len){var i;x[len>>5]|=128<<len%32;x[(len+64>>>9<<4)+14]=len;var a=1732584193,b=-271733879,c=-1732584194,d=271733878,olda,oldb,oldc,oldd;for(i=0;i<x.length;i+=16)olda=a,oldb=b,oldc=c,oldd=d,a=md5_ff(a,b,c,d,x[i+0],7,-680876936),d=md5_ff(d,a,b,c,x[i+1],12,-389564586),c=md5_ff(c,d,a,b,x[i+2],17,606105819),b=md5_ff(b,c,d,a,x[i+3],22,-1044525330),a=md5_ff(a,b,c,d,x[i+4],7,-176418897),d=md5_ff(d,a,b,c,x[i+5],12,1200080426),c=md5_ff(c,d,a,b,x[i+6],17,-1473231341),b=md5_ff(b,c,d,a,x[i+7],22,-45705983),a=md5_ff(a,b,c,d,x[i+8],7,1770035416),d=md5_ff(d,a,b,c,x[i+9],12,-1958414417),c=md5_ff(c,d,a,b,x[i+10],17,-42063),b=md5_ff(b,c,d,a,x[i+11],22,-1990404162),a=md5_ff(a,b,c,d,x[i+12],7,1804603682),d=md5_ff(d,a,b,c,x[i+13],12,-40341101),c=md5_ff(c,d,a,b,x[i+14],17,-1502002290),b=md5_ff(b,c,d,a,x[i+15],22,1236535329),a=md5_gg(a,b,c,d,x[i+1],5,-165796510),d=md5_gg(d,a,b,c,x[i+6],9,-1069501632),c=md5_gg(c,d,a,b,x[i+11],14,643717713),b=md5_gg(b,c,d,a,x[i+0],20,-373897302),a=md5_gg(a,b,c,d,x[i+5],5,-701558691),d=md5_gg(d,a,b,c,x[i+10],9,38016083),c=md5_gg(c,d,a,b,x[i+15],14,-660478335),b=md5_gg(b,c,d,a,x[i+4],20,-405537848),a=md5_gg(a,b,c,d,x[i+9],5,568446438),d=md5_gg(d,a,b,c,x[i+14],9,-1019803690),c=md5_gg(c,d,a,b,x[i+3],14,-187363961),b=md5_gg(b,c,d,a,x[i+8],20,1163531501),a=md5_gg(a,b,c,d,x[i+13],5,-1444681467),d=md5_gg(d,a,b,c,x[i+2],9,-51403784),c=md5_gg(c,d,a,b,x[i+7],14,1735328473),b=md5_gg(b,c,d,a,x[i+12],20,-1926607734),a=md5_hh(a,b,c,d,x[i+5],4,-378558),d=md5_hh(d,a,b,c,x[i+8],11,-2022574463),c=md5_hh(c,d,a,b,x[i+11],16,1839030562),b=md5_hh(b,c,d,a,x[i+14],23,-35309556),a=md5_hh(a,b,c,d,x[i+1],4,-1530992060),d=md5_hh(d,a,b,c,x[i+4],11,1272893353),c=md5_hh(c,d,a,b,x[i+7],16,-155497632),b=md5_hh(b,c,d,a,x[i+10],23,-1094730640),a=md5_hh(a,b,c,d,x[i+13],4,681279174),d=md5_hh(d,a,b,c,x[i+0],11,-358537222),c=md5_hh(c,d,a,b,x[i+3],16,-722521979),b=md5_hh(b,c,d,a,x[i+6],23,76029189),a=md5_hh(a,b,c,d,x[i+9],4,-640364487),d=md5_hh(d,a,b,c,x[i+12],11,-421815835),c=md5_hh(c,d,a,b,x[i+15],16,530742520),b=md5_hh(b,c,d,a,x[i+2],23,-995338651),a=md5_ii(a,b,c,d,x[i+0],6,-198630844),d=md5_ii(d,a,b,c,x[i+7],10,1126891415),c=md5_ii(c,d,a,b,x[i+14],15,-1416354905),b=md5_ii(b,c,d,a,x[i+5],21,-57434055),a=md5_ii(a,b,c,d,x[i+12],6,1700485571),d=md5_ii(d,a,b,c,x[i+3],10,-1894986606),c=md5_ii(c,d,a,b,x[i+10],15,-1051523),b=md5_ii(b,c,d,a,x[i+1],21,-2054922799),a=md5_ii(a,b,c,d,x[i+8],6,1873313359),d=md5_ii(d,a,b,c,x[i+15],10,-30611744),c=md5_ii(c,d,a,b,x[i+6],15,-1560198380),b=md5_ii(b,c,d,a,x[i+13],21,1309151649),a=md5_ii(a,b,c,d,x[i+4],6,-145523070),d=md5_ii(d,a,b,c,x[i+11],10,-1120210379),c=md5_ii(c,d,a,b,x[i+2],15,718787259),b=md5_ii(b,c,d,a,x[i+9],21,-343485551),a=safe_add(a,olda),b=safe_add(b,oldb),c=safe_add(c,oldc),d=safe_add(d,oldd);return[a,b,c,d]};return{hexdigest:function(s){return binl2hex(core_md5(str2binl(s),s.length*8))},hash:function(s){return binl2str(core_md5(str2binl(s),s.length*8))}}}),function(root,factory){typeof define=="function"&&define.amd?define("strophe-utils",function(){return factory()}):root.stropheUtils=factory()}(globalThis,function(){return{utf16to8:function(str){for(var c,out="",len=str.length,i=0;i<len;i++)c=str.charCodeAt(i),c>=0&&c<=127?out+=str.charAt(i):c>2047?(out+=String.fromCharCode(224|c>>12&15),out+=String.fromCharCode(128|c>>6&63),out+=String.fromCharCode(128|c>>0&63)):(out+=String.fromCharCode(192|c>>6&31),out+=String.fromCharCode(128|c>>0&63));return out},addCookies:function(cookies){var cookieName,cookieObj,isObj,cookieValue,expires,domain,path;for(cookieName in cookies||{})expires="",domain="",path="",cookieObj=cookies[cookieName],isObj=typeof cookieObj=="object",cookieValue=escape(unescape(isObj?cookieObj.value:cookieObj)),isObj&&(expires=cookieObj.expires?";expires="+cookieObj.expires:"",domain=cookieObj.domain?";domain="+cookieObj.domain:"",path=cookieObj.path?";path="+cookieObj.path:""),document.cookie=cookieName+"="+cookieValue+expires+domain+path}}}),function(root,factory){if(typeof define=="function"&&define.amd)define("strophe-polyfill",[],function(){return factory()});else return factory()}(globalThis,function(){Function.prototype.bind||(Function.prototype.bind=function(obj){var func=this,_slice=Array.prototype.slice,_concat=Array.prototype.concat,_args=_slice.call(arguments,1);return function(){return func.apply(obj?obj:this,_concat.call(_args,_slice.call(arguments,0)))}});Array.isArray||(Array.isArray=function(arg){return Object.prototype.toString.call(arg)==="[object Array]"});Array.prototype.indexOf||(Array.prototype.indexOf=function(elt){var len=this.length,from=Number(arguments[1])||0;for(from=from<0?Math.ceil(from):Math.floor(from),from<0&&(from+=len);from<len;from++)if(from in this&&this[from]===elt)return from;return-1})}),Array.prototype.forEach||(Array.prototype.forEach=function(callback,thisArg){var T,k,O,len,kValue;if(this===null)throw new TypeError(" this is null or not defined");if(O=Object(this),len=O.length>>>0,typeof callback!="function")throw new TypeError(callback+" is not a function");for(arguments.length>1&&(T=thisArg),k=0;k<len;)k in O&&(kValue=O[k],callback.call(T,kValue,k,O)),k++}),function(root,factory){if(typeof define=="function"&&define.amd)define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils","strophe-polyfill"],function(){return factory.apply(this,arguments)});else{var o=factory(root.SHA1,root.Base64,root.MD5,root.stropheUtils);window.Strophe=o.Strophe;window.$build=o.$build;window.$iq=o.$iq;window.$msg=o.$msg;window.$pres=o.$pres;window.SHA1=o.SHA1;window.Base64=o.Base64;window.MD5=o.MD5;window.b64_hmac_sha1=o.SHA1.b64_hmac_sha1;window.b64_sha1=o.SHA1.b64_sha1;window.str_hmac_sha1=o.SHA1.str_hmac_sha1;window.str_sha1=o.SHA1.str_sha1}}(globalThis,function(SHA1,Base64,MD5,utils){function $build(name,attrs){return new Strophe.Builder(name,attrs)}function $msg(attrs){return new Strophe.Builder("message",attrs)}function $iq(attrs){return new Strophe.Builder("iq",attrs)}function $pres(attrs){return new Strophe.Builder("presence",attrs)}var Strophe;return Strophe={VERSION:"1.2.9",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(tag){for(var i=0;i<Strophe.XHTML.tags.length;i++)if(tag==Strophe.XHTML.tags[i])return!0;return!1},validAttribute:function(tag,attribute){if(typeof Strophe.XHTML.attributes[tag]!="undefined"&&Strophe.XHTML.attributes[tag].length>0)for(var i=0;i<Strophe.XHTML.attributes[tag].length;i++)if(attribute==Strophe.XHTML.attributes[tag][i])return!0;return!1},validCSS:function(style){for(var i=0;i<Strophe.XHTML.css.length;i++)if(style==Strophe.XHTML.css[i])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(name,value){Strophe.NS[name]=value},forEachChild:function(elem,elemName,func){for(var childNode,i=0;i<elem.childNodes.length;i++)childNode=elem.childNodes[i],childNode.nodeType==Strophe.ElementType.NORMAL&&(!elemName||this.isTagEqual(childNode,elemName))&&func(childNode)},isTagEqual:function(el,name){return el.tagName==name},_xmlGenerator:null,_makeGenerator:function(){var doc;return document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(doc=this._getIEXmlDom(),doc.appendChild(doc.createElement("strophe"))):doc=document.implementation.createDocument("jabber:client","strophe",null),doc},xmlGenerator:function(){return Strophe._xmlGenerator||(Strophe._xmlGenerator=Strophe._makeGenerator()),Strophe._xmlGenerator},_getIEXmlDom:function(){for(var doc=null,docStrings=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],d=0;d<docStrings.length;d++)if(doc===null)try{doc=new ActiveXObject(docStrings[d])}catch(e){doc=null}else break;return doc},xmlElement:function(name){var node,a,i,k,arg,attr;if(!name)return null;for(node=Strophe.xmlGenerator().createElement(name),a=1;a<arguments.length;a++)if(arg=arguments[a],arg)if(typeof arg=="string"||typeof arg=="number")node.appendChild(Strophe.xmlTextNode(arg));else if(typeof arg=="object"&&typeof arg.sort=="function")for(i=0;i<arg.length;i++)attr=arg[i],typeof attr=="object"&&typeof attr.sort=="function"&&attr[1]!==undefined&&attr[1]!==null&&node.setAttribute(attr[0],attr[1]);else if(typeof arg=="object")for(k in arg)arg.hasOwnProperty(k)&&arg[k]!==undefined&&arg[k]!==null&&node.setAttribute(k,arg[k]);return node},xmlescape:function(text){return text=text.replace(/\&/g,"&amp;"),text=text.replace(/</g,"&lt;"),text=text.replace(/>/g,"&gt;"),text=text.replace(/'/g,"&apos;"),text.replace(/"/g,"&quot;")},xmlunescape:function(text){return text=text.replace(/\&amp;/g,"&"),text=text.replace(/&lt;/g,"<"),text=text.replace(/&gt;/g,">"),text=text.replace(/&apos;/g,"'"),text.replace(/&quot;/g,'"')},xmlTextNode:function(text){return Strophe.xmlGenerator().createTextNode(text)},xmlHtmlNode:function(html){var node,parser;return window.DOMParser?(parser=new DOMParser,node=parser.parseFromString(html,"text/xml")):(node=new ActiveXObject("Microsoft.XMLDOM"),node.async="false",node.loadXML(html)),node},getText:function(elem){var str,i;if(!elem)return null;for(str="",elem.childNodes.length===0&&elem.nodeType==Strophe.ElementType.TEXT&&(str+=elem.nodeValue),i=0;i<elem.childNodes.length;i++)elem.childNodes[i].nodeType==Strophe.ElementType.TEXT&&(str+=elem.childNodes[i].nodeValue);return Strophe.xmlescape(str)},copyElement:function(elem){var i,el;if(elem.nodeType==Strophe.ElementType.NORMAL){for(el=Strophe.xmlElement(elem.tagName),i=0;i<elem.attributes.length;i++)el.setAttribute(elem.attributes[i].nodeName,elem.attributes[i].value);for(i=0;i<elem.childNodes.length;i++)el.appendChild(Strophe.copyElement(elem.childNodes[i]))}else elem.nodeType==Strophe.ElementType.TEXT&&(el=Strophe.xmlGenerator().createTextNode(elem.nodeValue));return el},createHtml:function(elem){var i,el,j,tag,attribute,value,css,cssAttrs,attr,cssName,cssValue;if(elem.nodeType==Strophe.ElementType.NORMAL)if(tag=elem.nodeName.toLowerCase(),Strophe.XHTML.validTag(tag))try{for(el=Strophe.xmlElement(tag),i=0;i<Strophe.XHTML.attributes[tag].length;i++)if(attribute=Strophe.XHTML.attributes[tag][i],value=elem.getAttribute(attribute),typeof value!="undefined"&&value!==null&&value!==""&&value!==!1&&value!==0)if(attribute=="style"&&typeof value=="object"&&typeof value.cssText!="undefined"&&(value=value.cssText),attribute=="style"){for(css=[],cssAttrs=value.split(";"),j=0;j<cssAttrs.length;j++)attr=cssAttrs[j].split(":"),cssName=attr[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),Strophe.XHTML.validCSS(cssName)&&(cssValue=attr[1].replace(/^\s*/,"").replace(/\s*$/,""),css.push(cssName+": "+cssValue));css.length>0&&(value=css.join("; "),el.setAttribute(attribute,value))}else el.setAttribute(attribute,value);for(i=0;i<elem.childNodes.length;i++)el.appendChild(Strophe.createHtml(elem.childNodes[i]))}catch(e){el=Strophe.xmlTextNode("")}else for(el=Strophe.xmlGenerator().createDocumentFragment(),i=0;i<elem.childNodes.length;i++)el.appendChild(Strophe.createHtml(elem.childNodes[i]));else if(elem.nodeType==Strophe.ElementType.FRAGMENT)for(el=Strophe.xmlGenerator().createDocumentFragment(),i=0;i<elem.childNodes.length;i++)el.appendChild(Strophe.createHtml(elem.childNodes[i]));else elem.nodeType==Strophe.ElementType.TEXT&&(el=Strophe.xmlTextNode(elem.nodeValue));return el},escapeNode:function(node){return typeof node!="string"?node:node.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(node){return typeof node!="string"?node:node.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(jid){return jid.indexOf("@")<0?null:jid.split("@")[0]},getDomainFromJid:function(jid){var bare=Strophe.getBareJidFromJid(jid),parts;return bare.indexOf("@")<0?bare:(parts=bare.split("@"),parts.splice(0,1),parts.join("@"))},getResourceFromJid:function(jid){var s=jid.split("/");return s.length<2?null:(s.splice(0,1),s.join("/"))},getBareJidFromJid:function(jid){return jid?jid.split("/")[0]:null},_handleError:function(e){typeof e.stack!="undefined"&&Strophe.fatal(e.stack);e.sourceURL?Strophe.fatal("error: "+this.handler+" "+e.sourceURL+":"+e.line+" - "+e.name+": "+e.message):e.fileName?Strophe.fatal("error: "+this.handler+" "+e.fileName+":"+e.lineNumber+" - "+e.name+": "+e.message):Strophe.fatal("error: "+e.message)},log:function(){return},debug:function(msg){this.log(this.LogLevel.DEBUG,msg)},info:function(msg){this.log(this.LogLevel.INFO,msg)},warn:function(msg){this.log(this.LogLevel.WARN,msg)},error:function(msg){this.log(this.LogLevel.ERROR,msg)},fatal:function(msg){this.log(this.LogLevel.FATAL,msg)},serialize:function(elem){var result,nodeName,i,child;if(!elem)return null;for(typeof elem.tree=="function"&&(elem=elem.tree()),nodeName=elem.nodeName,elem.getAttribute("_realname")&&(nodeName=elem.getAttribute("_realname")),result="<"+nodeName,i=0;i<elem.attributes.length;i++)elem.attributes[i].nodeName!="_realname"&&(result+=" "+elem.attributes[i].nodeName+"='"+Strophe.xmlescape(elem.attributes[i].value)+"'");if(elem.childNodes.length>0){for(result+=">",i=0;i<elem.childNodes.length;i++){child=elem.childNodes[i];switch(child.nodeType){case Strophe.ElementType.NORMAL:result+=Strophe.serialize(child);break;case Strophe.ElementType.TEXT:result+=Strophe.xmlescape(child.nodeValue);break;case Strophe.ElementType.CDATA:result+="<![CDATA["+child.nodeValue+"]\]>"}}result+="<\/"+nodeName+">"}else result+="/>";return result},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(name,ptype){Strophe._connectionPlugins[name]=ptype}},Strophe.Builder=function(name,attrs){(name=="presence"||name=="message"||name=="iq")&&(attrs&&!attrs.xmlns?attrs.xmlns=Strophe.NS.CLIENT:attrs||(attrs={xmlns:Strophe.NS.CLIENT}));this.nodeTree=Strophe.xmlElement(name,attrs);this.node=this.nodeTree},Strophe.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return Strophe.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(moreattrs){for(var k in moreattrs)moreattrs.hasOwnProperty(k)&&(moreattrs[k]===undefined?this.node.removeAttribute(k):this.node.setAttribute(k,moreattrs[k]));return this},c:function(name,attrs,text){var child=Strophe.xmlElement(name,attrs,text);return this.node.appendChild(child),typeof text!="string"&&typeof text!="number"&&(this.node=child),this},cnode:function(elem){var impNode,xmlGen=Strophe.xmlGenerator(),newElem;try{impNode=xmlGen.importNode!==undefined}catch(e){impNode=!1}return newElem=impNode?xmlGen.importNode(elem,!0):Strophe.copyElement(elem),this.node.appendChild(newElem),this.node=newElem,this},t:function(text){var child=Strophe.xmlTextNode(text);return this.node.appendChild(child),this},h:function(html){var fragment=document.createElement("body"),xhtml;for(fragment.innerHTML=html,xhtml=Strophe.createHtml(fragment);xhtml.childNodes.length>0;)this.node.appendChild(xhtml.childNodes[0]);return this}},Strophe.Handler=function(handler,ns,name,type,id,from,options){this.handler=handler;this.ns=ns;this.name=name;this.type=type;this.id=id;this.options=options||{matchBareFromJid:!1,ignoreNamespaceFragment:!1};this.options.matchBare&&(Strophe.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare);this.from=this.options.matchBareFromJid?from?Strophe.getBareJidFromJid(from):null:from;this.user=!0},Strophe.Handler.prototype={getNamespace:function(elem){var elNamespace=elem.getAttribute("xmlns");return elNamespace&&this.options.ignoreNamespaceFragment&&(elNamespace=elNamespace.split("#")[0]),elNamespace},namespaceMatch:function(elem){var nsMatch=!1,that;if(this.ns)that=this,Strophe.forEachChild(elem,null,function(elem){that.getNamespace(elem)===that.ns&&(nsMatch=!0)}),nsMatch=nsMatch||this.getNamespace(elem)===this.ns;else return!0;return nsMatch},isMatch:function(elem){var from=elem.getAttribute("from"),elem_type;return(this.options.matchBareFromJid&&(from=Strophe.getBareJidFromJid(from)),elem_type=elem.getAttribute("type"),this.namespaceMatch(elem)&&(!this.name||Strophe.isTagEqual(elem,this.name))&&(!this.type||(Array.isArray(this.type)?this.type.indexOf(elem_type)!=-1:elem_type==this.type))&&(!this.id||elem.getAttribute("id")==this.id)&&(!this.from||from==this.from))?!0:!1},run:function(elem){var result=null;try{result=this.handler(elem)}catch(e){Strophe._handleError(e);throw e;}return result},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},Strophe.TimedHandler=function(period,handler){this.period=period;this.handler=handler;this.lastCalled=(new Date).getTime();this.user=!0},Strophe.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},Strophe.Connection=function(service,options){var proto,k,ptype,F;this.service=service;this.options=options||{};proto=this.options.protocol||"";this._proto=service.indexOf("ws:")===0||service.indexOf("wss:")===0||proto.indexOf("ws")===0?new Strophe.Websocket(this):new Strophe.Bosh(this);this._timeProvider=Strophe.timeProvider||window;this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=!1;this.do_bind=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.protocolErrorHandlers={HTTP:{},websocket:{}};this._idleTimeout=null;this._disconnectTimeout=null;this.authenticated=!1;this.connected=!1;this.disconnecting=!1;this.do_authentication=!0;this.paused=!1;this.restored=!1;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=this._timeProvider.setTimeout(function(){this._onIdle()}.bind(this),100);utils.addCookies(this.options.cookies);this.registerSASLMechanisms(this.options.mechanisms);for(k in Strophe._connectionPlugins)Strophe._connectionPlugins.hasOwnProperty(k)&&(ptype=Strophe._connectionPlugins[k],F=function(){},F.prototype=ptype,this[k]=new F,this[k].init(this))},Strophe.Connection.prototype={reset:function(){this.jid&&(this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(suffix){var partid=Strophe.getNodeFromJid(this.jid),partri=(Math.floor(Math.random()*4026531840)+268435456).toString(16);return typeof suffix=="string"||typeof suffix=="number"?++this._uniqueId+":"+partid+"-"+partri+":"+suffix:++this._uniqueId+":"+partid+"-"+partri},addProtocolErrorHandler:function(protocol,status_code,callback){this.protocolErrorHandlers[protocol][status_code]=callback},connect:function(jid,pass,callback,wait,hold,route,authcid){this.jid=jid;this.authzid=Strophe.getBareJidFromJid(this.jid);this.authcid=authcid||Strophe.getNodeFromJid(this.jid);this.pass=pass;this.servtype="xmpp";this.connect_callback=callback;this.disconnecting=!1;this.connected=!1;this.authenticated=!1;this.restored=!1;this.domain=Strophe.getDomainFromJid(this.jid);this._changeConnectStatus(Strophe.Status.CONNECTING,null);this._proto._connect(wait,hold,route)},attach:function(jid,sid,rid,callback,wait,hold,wind){if(this._proto instanceof Strophe.Bosh)this._proto._attach(jid,sid,rid,callback,wait,hold,wind);else throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};},isRestoreSupported:function(){return this._sessionCachingSupported()},isRestorable:function(jid,maxAge){if(this._sessionCachingSupported()){var session=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(this._proto._isRestorable(session,jid))return typeof maxAge==typeof undefined?!0:typeof session.cts!=typeof undefined&&Date.now()-Number(session.cts)<maxAge*1e3}return!1},restore:function(jid,callback,wait,hold,wind){if(this._sessionCachingSupported())return this._proto._restore(jid,callback,wait,hold,wind);throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};},_sessionCachingSupported:function(){if(this._proto instanceof Strophe.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_");window.sessionStorage.removeItem("_strophe_")}catch(e){return!1}return!0}return!1},xmlInput:function(){return},xmlOutput:function(){return},rawInput:function(){return},rawOutput:function(){return},nextValidRid:function(){return},send:function(elem){if(elem!==null){if(typeof elem.sort=="function")for(var i=0;i<elem.length;i++)this._queueData(elem[i]);else typeof elem.tree=="function"?this._queueData(elem.tree()):this._queueData(elem);this._proto._send()}},flush:function(){this._timeProvider.clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(elem,callback,errback,timeout){var timeoutHandler=null,that=this,id;typeof elem.tree=="function"&&(elem=elem.tree());id=elem.getAttribute("id");id||(id=this.getUniqueId("sendIQ"),elem.setAttribute("id",id));var expectedFrom=elem.getAttribute("to"),fulljid=this.jid,handler=this.addHandler(function(stanza){var acceptable,from,iqtype;if(timeoutHandler&&that.deleteTimedHandler(timeoutHandler),acceptable=!1,from=stanza.getAttribute("from"),from!==expectedFrom&&(expectedFrom||from!==Strophe.getBareJidFromJid(fulljid)&&from!==Strophe.getDomainFromJid(fulljid)&&from!==fulljid)||(acceptable=!0),!acceptable)throw{name:"StropheError",message:"Got answer to IQ from wrong jid:"+from+"\nExpected jid: "+expectedFrom};if(iqtype=stanza.getAttribute("type"),iqtype=="result")callback&&callback(stanza);else if(iqtype=="error")errback&&errback(stanza);else throw{name:"StropheError",message:"Got bad IQ type of "+iqtype};},null,"iq",["error","result"],id);return timeout&&(timeoutHandler=this.addTimedHandler(timeout,function(){return that.deleteHandler(handler),errback&&errback(null),!1})),this.send(elem),id},_queueData:function(element){if(element===null||!element.tagName||!element.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(element)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=this._timeProvider.setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(period,handler){var thand=new Strophe.TimedHandler(period,handler);return this.addTimeds.push(thand),thand},deleteTimedHandler:function(handRef){this.removeTimeds.push(handRef)},addHandler:function(handler,ns,name,type,id,from,options){var hand=new Strophe.Handler(handler,ns,name,type,id,from,options);return this.addHandlers.push(hand),hand},deleteHandler:function(handRef){this.removeHandlers.push(handRef);var i=this.addHandlers.indexOf(handRef);i>=0&&this.addHandlers.splice(i,1)},registerSASLMechanisms:function(mechanisms){this.mechanisms={};mechanisms=mechanisms||[Strophe.SASLAnonymous,Strophe.SASLExternal,Strophe.SASLMD5,Strophe.SASLOAuthBearer,Strophe.SASLPlain,Strophe.SASLSHA1];mechanisms.forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(mechanism){this.mechanisms[mechanism.prototype.name]=mechanism},disconnect:function(reason){if(this._changeConnectStatus(Strophe.Status.DISCONNECTING,reason),Strophe.info("Disconnect was called because: "+reason),this.connected){var pres=!1;this.disconnecting=!0;this.authenticated&&(pres=$pres({xmlns:Strophe.NS.CLIENT,type:"unavailable"}));this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this));this._proto._disconnect(pres)}else Strophe.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests()},_changeConnectStatus:function(status,condition){var k,plugin;for(k in Strophe._connectionPlugins)if(Strophe._connectionPlugins.hasOwnProperty(k)&&(plugin=this[k],plugin.statusChanged))try{plugin.statusChanged(status,condition)}catch(err){Strophe.error(""+k+" plugin caused an exception changing status: "+err)}if(this.connect_callback)try{this.connect_callback(status,condition)}catch(e){Strophe._handleError(e);Strophe.error("User connection callback caused an exception: "+e)}},_doDisconnect:function(condition){typeof this._idleTimeout=="number"&&this._timeProvider.clearTimeout(this._idleTimeout);this._disconnectTimeout!==null&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);Strophe.debug("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=!1;this.disconnecting=!1;this.restored=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(Strophe.Status.DISCONNECTED,condition);this.connected=!1},_dataRecv:function(req,raw){var elem=this._proto._reqToData(req),i,hand,type,cond,conflict,that;if(elem!==null){for(this.xmlInput!==Strophe.Connection.prototype.xmlInput&&(elem.nodeName===this._proto.strip&&elem.childNodes.length?this.xmlInput(elem.childNodes[0]):this.xmlInput(elem)),this.rawInput!==Strophe.Connection.prototype.rawInput&&(raw?this.rawInput(raw):this.rawInput(Strophe.serialize(elem)));this.removeHandlers.length>0;)hand=this.removeHandlers.pop(),i=this.handlers.indexOf(hand),i>=0&&this.handlers.splice(i,1);while(this.addHandlers.length>0)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return}if(type=elem.getAttribute("type"),type!==null&&type=="terminate"){if(this.disconnecting)return;cond=elem.getAttribute("condition");conflict=elem.getElementsByTagName("conflict");cond!==null?(cond=="remote-stream-error"&&conflict.length>0&&(cond="conflict"),this._changeConnectStatus(Strophe.Status.CONNFAIL,cond)):this._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown");this._doDisconnect(cond);return}that=this;Strophe.forEachChild(elem,null,function(child){var i,newList,hand;for(newList=that.handlers,that.handlers=[],i=0;i<newList.length;i++){hand=newList[i];try{hand.isMatch(child)&&(that.authenticated||!hand.user)?hand.run(child)&&that.handlers.push(hand):that.handlers.push(hand)}catch(e){Strophe.warn("Removing Strophe handlers due to uncaught exception: "+e.message)}}})}},mechanisms:{},_connect_cb:function(req,_callback,raw){var bodyWrap,conncheck,hasFeatures,matched,i,mech,mechanisms;Strophe.debug("_connect_cb was called");this.connected=!0;try{bodyWrap=this._proto._reqToData(req)}catch(e){if(e!="badformat")throw e;this._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(bodyWrap&&(this.xmlInput!==Strophe.Connection.prototype.xmlInput&&(bodyWrap.nodeName===this._proto.strip&&bodyWrap.childNodes.length?this.xmlInput(bodyWrap.childNodes[0]):this.xmlInput(bodyWrap)),this.rawInput!==Strophe.Connection.prototype.rawInput&&(raw?this.rawInput(raw):this.rawInput(Strophe.serialize(bodyWrap))),conncheck=this._proto._connect_cb(bodyWrap),conncheck!==Strophe.Status.CONNFAIL)){if(hasFeatures=bodyWrap.getElementsByTagNameNS?bodyWrap.getElementsByTagNameNS(Strophe.NS.STREAM,"features").length>0:bodyWrap.getElementsByTagName("stream:features").length>0||bodyWrap.getElementsByTagName("features").length>0,!hasFeatures){this._proto._no_auth_received(_callback);return}if(matched=[],mechanisms=bodyWrap.getElementsByTagName("mechanism"),mechanisms.length>0)for(i=0;i<mechanisms.length;i++)mech=Strophe.getText(mechanisms[i]),this.mechanisms[mech]&&matched.push(this.mechanisms[mech]);if(matched.length===0&&bodyWrap.getElementsByTagName("auth").length===0){this._proto._no_auth_received(_callback);return}this.do_authentication!==!1&&this.authenticate(matched)}},sortMechanismsByPriority:function(mechanisms){for(var j,higher,swap,i=0;i<mechanisms.length-1;++i){for(higher=i,j=i+1;j<mechanisms.length;++j)mechanisms[j].prototype.priority>mechanisms[higher].prototype.priority&&(higher=j);higher!=i&&(swap=mechanisms[i],mechanisms[i]=mechanisms[higher],mechanisms[higher]=swap)}return mechanisms},_attemptSASLAuth:function(mechanisms){var i,mechanism_found,request_auth_exchange,response;for(mechanisms=this.sortMechanismsByPriority(mechanisms||[]),i=0,mechanism_found=!1,i=0;i<mechanisms.length;++i)if(mechanisms[i].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new mechanisms[i];this._sasl_mechanism.onStart(this);request_auth_exchange=$build("auth",{xmlns:Strophe.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(response=this._sasl_mechanism.onChallenge(this,null),request_auth_exchange.t(Base64.encode(response)));this.send(request_auth_exchange.tree());mechanism_found=!0;break}return mechanism_found},_attemptLegacyAuth:function(){Strophe.getNodeFromJid(this.jid)===null?(this._changeConnectStatus(Strophe.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send($iq({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(this.jid)).tree()))},authenticate:function(matched){this._attemptSASLAuth(matched)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(elem){var challenge=Base64.decode(Strophe.getText(elem)),response=this._sasl_mechanism.onChallenge(this,challenge),stanza=$build("response",{xmlns:Strophe.NS.SASL});return response!==""&&stanza.t(Base64.encode(response)),this.send(stanza.tree()),!0},_auth1_cb:function(){var iq=$iq({type:"set",id:"_auth_2"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return Strophe.getResourceFromJid(this.jid)||(this.jid=Strophe.getBareJidFromJid(this.jid)+"/strophe"),iq.up().c("resource",{}).t(Strophe.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(iq.tree()),!1},_sasl_success_cb:function(elem){var streamfeature_handlers,wrapper;if(this._sasl_data["server-signature"]){var serverSignature,success=Base64.decode(Strophe.getText(elem)),matches=success.match(/([a-z]+)=([^,]+)(,|$)/);if(matches[1]=="v"&&(serverSignature=matches[2]),serverSignature!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}return Strophe.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),streamfeature_handlers=[],wrapper=function(handlers,elem){while(handlers.length)this.deleteHandler(handlers.pop());return this._sasl_auth1_cb.bind(this)(elem),!1},streamfeature_handlers.push(this._addSysHandler(function(elem){wrapper.bind(this)(streamfeature_handlers,elem)}.bind(this),null,"stream:features",null,null)),streamfeature_handlers.push(this._addSysHandler(function(elem){wrapper.bind(this)(streamfeature_handlers,elem)}.bind(this),Strophe.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(elem){var i,child,resource;for(this.features=elem,i=0;i<elem.childNodes.length;i++)child=elem.childNodes[i],child.nodeName=="bind"&&(this.do_bind=!0),child.nodeName=="session"&&(this.do_session=!0);if(this.do_bind)this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),resource=Strophe.getResourceFromJid(this.jid),resource?this.send($iq({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:Strophe.NS.BIND}).c("resource",{}).t(resource).tree()):this.send($iq({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:Strophe.NS.BIND}).tree());else return this._changeConnectStatus(Strophe.Status.AUTHFAIL,null),!1;return!1},_sasl_bind_cb:function(elem){var conflict,condition,bind,jidNode;if(elem.getAttribute("type")=="error")return Strophe.info("SASL binding failed."),conflict=elem.getElementsByTagName("conflict"),conflict.length>0&&(condition="conflict"),this._changeConnectStatus(Strophe.Status.AUTHFAIL,condition),!1;if(bind=elem.getElementsByTagName("bind"),bind.length>0)jidNode=bind[0].getElementsByTagName("jid"),jidNode.length>0&&(this.jid=Strophe.getText(jidNode[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send($iq({type:"set",id:"_session_auth_2"}).c("session",{xmlns:Strophe.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(Strophe.Status.CONNECTED,null)));else return Strophe.info("SASL binding failed."),this._changeConnectStatus(Strophe.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(elem){if(elem.getAttribute("type")=="result")this.authenticated=!0,this._changeConnectStatus(Strophe.Status.CONNECTED,null);else if(elem.getAttribute("type")=="error")return Strophe.info("Session creation failed."),this._changeConnectStatus(Strophe.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(Strophe.Status.AUTHFAIL,null),!1},_auth2_cb:function(elem){return elem.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(Strophe.Status.CONNECTED,null)):elem.getAttribute("type")=="error"&&(this._changeConnectStatus(Strophe.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(period,handler){var thand=new Strophe.TimedHandler(period,handler);return thand.user=!1,this.addTimeds.push(thand),thand},_addSysHandler:function(handler,ns,name,type,id){var hand=new Strophe.Handler(handler,ns,name,type,id);return hand.user=!1,this.addHandlers.push(hand),hand},_onDisconnectTimeout:function(){return Strophe.info("_onDisconnectTimeout was called"),this._changeConnectStatus(Strophe.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var i,thand,since,newList,now;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());while(this.removeTimeds.length>0)thand=this.removeTimeds.pop(),i=this.timedHandlers.indexOf(thand),i>=0&&this.timedHandlers.splice(i,1);for(now=(new Date).getTime(),newList=[],i=0;i<this.timedHandlers.length;i++)thand=this.timedHandlers[i],(this.authenticated||!thand.user)&&(since=thand.lastCalled+thand.period,since-now<=0?thand.run()&&newList.push(thand):newList.push(thand));this.timedHandlers=newList;this._timeProvider.clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=this._timeProvider.setTimeout(function(){this._onIdle()}.bind(this),100))}},Strophe.SASLMechanism=function(name,isClientFirst,priority){this.name=name;this.isClientFirst=isClientFirst;this.priority=priority},Strophe.SASLMechanism.prototype={test:function(){return!0},onStart:function(connection){this._connection=connection},onChallenge:function(){throw new Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},Strophe.SASLAnonymous=function(){},Strophe.SASLAnonymous.prototype=new Strophe.SASLMechanism("ANONYMOUS",!1,10),Strophe.SASLAnonymous.prototype.test=function(connection){return connection.authcid===null},Strophe.SASLPlain=function(){},Strophe.SASLPlain.prototype=new Strophe.SASLMechanism("PLAIN",!0,20),Strophe.SASLPlain.prototype.test=function(connection){return connection.authcid!==null},Strophe.SASLPlain.prototype.onChallenge=function(connection){var auth_str=connection.authzid;return auth_str=auth_str+"\x00",auth_str=auth_str+connection.authcid,auth_str=auth_str+"\x00",auth_str=auth_str+connection.pass,utils.utf16to8(auth_str)},Strophe.SASLSHA1=function(){},Strophe.SASLSHA1.prototype=new Strophe.SASLMechanism("SCRAM-SHA-1",!0,40),Strophe.SASLSHA1.prototype.test=function(connection){return connection.authcid!==null},Strophe.SASLSHA1.prototype.onChallenge=function(connection,challenge,test_cnonce){var cnonce=test_cnonce||MD5.hexdigest(Math.random()*1234567890),auth_str="n="+utils.utf16to8(connection.authcid);return auth_str+=",r=",auth_str+=cnonce,connection._sasl_data.cnonce=cnonce,connection._sasl_data["client-first-message-bare"]=auth_str,auth_str="n,,"+auth_str,this.onChallenge=function(connection,challenge){for(var nonce,salt,iter,Hi,U,U_old,i,k,pass,clientKey,serverKey,clientSignature,responseText="c=biws,",authMessage=connection._sasl_data["client-first-message-bare"]+","+challenge+",",cnonce=connection._sasl_data.cnonce,attribMatch=/([a-z]+)=([^,]+)(,|$)/,matches;challenge.match(attribMatch);){matches=challenge.match(attribMatch);challenge=challenge.replace(matches[0],"");switch(matches[1]){case"r":nonce=matches[2];break;case"s":salt=matches[2];break;case"i":iter=matches[2]}}if(nonce.substr(0,cnonce.length)!==cnonce)return connection._sasl_data={},connection._sasl_failure_cb();for(responseText+="r="+nonce,authMessage+=responseText,salt=Base64.decode(salt),salt+="\x00\x00\x00\x01",pass=utils.utf16to8(connection.pass),Hi=U_old=SHA1.core_hmac_sha1(pass,salt),i=1;i<iter;i++){for(U=SHA1.core_hmac_sha1(pass,SHA1.binb2str(U_old)),k=0;k<5;k++)Hi[k]^=U[k];U_old=U}for(Hi=SHA1.binb2str(Hi),clientKey=SHA1.core_hmac_sha1(Hi,"Client Key"),serverKey=SHA1.str_hmac_sha1(Hi,"Server Key"),clientSignature=SHA1.core_hmac_sha1(SHA1.str_sha1(SHA1.binb2str(clientKey)),authMessage),connection._sasl_data["server-signature"]=SHA1.b64_hmac_sha1(serverKey,authMessage),k=0;k<5;k++)clientKey[k]^=clientSignature[k];return responseText+(",p="+Base64.encode(SHA1.binb2str(clientKey)))}.bind(this),auth_str},Strophe.SASLMD5=function(){},Strophe.SASLMD5.prototype=new Strophe.SASLMechanism("DIGEST-MD5",!1,30),Strophe.SASLMD5.prototype.test=function(connection){return connection.authcid!==null},Strophe.SASLMD5.prototype._quote=function(str){return'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},Strophe.SASLMD5.prototype.onChallenge=function(connection,challenge,test_cnonce){for(var attribMatch=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,cnonce=test_cnonce||MD5.hexdigest(""+Math.random()*1234567890),realm="",host=null,nonce="",qop="",matches,digest_uri;challenge.match(attribMatch);){matches=challenge.match(attribMatch);challenge=challenge.replace(matches[0],"");matches[2]=matches[2].replace(/^"(.+)"$/,"$1");switch(matches[1]){case"realm":realm=matches[2];break;case"nonce":nonce=matches[2];break;case"qop":qop=matches[2];break;case"host":host=matches[2]}}digest_uri=connection.servtype+"/"+connection.domain;host!==null&&(digest_uri=digest_uri+"/"+host);var cred=utils.utf16to8(connection.authcid+":"+realm+":"+this._connection.pass),A1=MD5.hash(cred)+":"+nonce+":"+cnonce,A2="AUTHENTICATE:"+digest_uri,responseText="";return responseText+="charset=utf-8,",responseText+="username="+this._quote(utils.utf16to8(connection.authcid))+",",responseText+="realm="+this._quote(realm)+",",responseText+="nonce="+this._quote(nonce)+",",responseText+="nc=00000001,",responseText+="cnonce="+this._quote(cnonce)+",",responseText+="digest-uri="+this._quote(digest_uri)+",",responseText+="response="+MD5.hexdigest(MD5.hexdigest(A1)+":"+nonce+":00000001:"+cnonce+":auth:"+MD5.hexdigest(A2))+",",responseText+="qop=auth",this.onChallenge=function(){return""},responseText},Strophe.SASLOAuthBearer=function(){},Strophe.SASLOAuthBearer.prototype=new Strophe.SASLMechanism("OAUTHBEARER",!0,50),Strophe.SASLOAuthBearer.prototype.test=function(connection){return connection.authcid!==null},Strophe.SASLOAuthBearer.prototype.onChallenge=function(connection){var auth_str="n,a=";return auth_str=auth_str+connection.authzid,auth_str=auth_str+",",auth_str=auth_str+"\x01",auth_str=auth_str+"auth=Bearer ",auth_str=auth_str+connection.pass,auth_str=auth_str+"\x01",auth_str=auth_str+"\x01",utils.utf16to8(auth_str)},Strophe.SASLExternal=function(){},Strophe.SASLExternal.prototype=new Strophe.SASLMechanism("EXTERNAL",!0,60),Strophe.SASLExternal.prototype.onChallenge=function(connection){return connection.authcid===connection.authzid?"":connection.authzid},{Strophe:Strophe,$build:$build,$msg:$msg,$iq:$iq,$pres:$pres,SHA1:SHA1,Base64:Base64,MD5:MD5}}),function(root,factory){if(typeof define=="function"&&define.amd)define("strophe-bosh",["strophe-core"],function(core){return factory(core.Strophe,core.$build)});else return factory(Strophe,$build)}(globalThis,function(Strophe,$build){return Strophe.Request=function(elem,func,rid,sends){this.id=++Strophe._requestId;this.xmlData=elem;this.data=Strophe.serialize(elem);this.origFunc=func;this.func=func;this.rid=rid;this.date=NaN;this.sends=sends||0;this.abort=!1;this.dead=null;this.age=function(){if(!this.date)return 0;var now=new Date;return(now-this.date)/1e3};this.timeDead=function(){if(!this.dead)return 0;var now=new Date;return(now-this.dead)/1e3};this.xhr=this._newXHR()},Strophe.Request.prototype={getResponse:function(){var node=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(node=this.xhr.responseXML.documentElement,node.tagName=="parsererror"){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML));throw"parsererror";}}else if(this.xhr.responseText){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);throw"badformat";}return node},_newXHR:function(){var xhr=null;return window.XMLHttpRequest?(xhr=new XMLHttpRequest,xhr.overrideMimeType&&xhr.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(xhr=new ActiveXObject("Microsoft.XMLHTTP")),xhr.onreadystatechange=this.func.bind(null,this),xhr}},Strophe.Bosh=function(connection){this._conn=connection;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this._requests=[]},Strophe.Bosh.prototype={strip:null,_buildBody:function(){var bodyWrap=$build("body",{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});return this.sid!==null&&bodyWrap.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),bodyWrap},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.errors=0;this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_connect:function(wait,hold,route){var body,_connect_cb;this.wait=wait||this.wait;this.hold=hold||this.hold;this.errors=0;body=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});route&&body.attrs({route:route});_connect_cb=this._conn._connect_cb;this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,_connect_cb.bind(this._conn)),body.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(jid,sid,rid,callback,wait,hold,wind){this._conn.jid=jid;this.sid=sid;this.rid=rid;this._conn.connect_callback=callback;this._conn.domain=Strophe.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=wait||this.wait;this.hold=hold||this.hold;this.window=wind||this.window;this._conn._changeConnectStatus(Strophe.Status.ATTACHED,null)},_isRestorable:function(session,jid){return typeof session!="undefined"&&session!==null&&session.rid&&session.sid&&session.jid&&(typeof jid=="undefined"||jid===null||Strophe.getBareJidFromJid(session.jid)===Strophe.getBareJidFromJid(jid))},_restore:function(jid,callback,wait,hold,wind){var session=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(this._isRestorable(session,jid))return this._conn.restored=!0,this._attach(session.jid,session.sid,session.rid,callback,wait,hold,wind),session;throw{name:"StropheSessionError",message:"_restore: no restorable session."};},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid,cts:Date.now()})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(bodyWrap){var typ=bodyWrap.getAttribute("type"),cond,conflict,wind,hold,wait;if(typ!==null&&typ=="terminate")return cond=bodyWrap.getAttribute("condition"),Strophe.error("BOSH-Connection failed: "+cond),conflict=bodyWrap.getElementsByTagName("conflict"),cond!==null?(cond=="remote-stream-error"&&conflict.length>0&&(cond="conflict"),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,cond)):this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(cond),Strophe.Status.CONNFAIL;this.sid||(this.sid=bodyWrap.getAttribute("sid"));wind=bodyWrap.getAttribute("requests");wind&&(this.window=parseInt(wind,10));hold=bodyWrap.getAttribute("hold");hold&&(this.hold=parseInt(hold,10));wait=bodyWrap.getAttribute("wait");wait&&(this.wait=parseInt(wait,10))},_disconnect:function(pres){this._sendTerminate(pres)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295);this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return this._requests.length===0},_callProtocolErrorHandlers:function(req){var reqStatus=this._getRequestStatus(req),err_callback;err_callback=this._conn.protocolErrorHandlers.HTTP[reqStatus];err_callback&&err_callback.call(this,reqStatus)},_hitError:function(reqStatus){this.errors++;Strophe.warn("request errored, status: "+reqStatus+", number of errors: "+this.errors);this.errors>4&&this._conn._onDisconnectTimeout()},_no_auth_received:function(_callback){_callback=_callback?_callback.bind(this._conn):this._conn._connect_cb.bind(this._conn);var body=this._buildBody();this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,_callback.bind(this._conn)),body.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var req;this._requests.length>0;)req=this._requests.pop(),req.abort=!0,req.xhr.abort(),req.xhr.onreadystatechange=function(){}},_onIdle:function(){var data=this._conn._data,body,i,time_elapsed;if(this._conn.authenticated&&this._requests.length===0&&data.length===0&&!this._conn.disconnecting&&(Strophe.debug("no requests during idle cycle, sending blank request"),data.push(null)),!this._conn.paused){if(this._requests.length<2&&data.length>0){for(body=this._buildBody(),i=0;i<data.length;i++)data[i]!==null&&(data[i]==="restart"?body.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH}):body.cnode(data[i]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),body.tree().getAttribute("rid")));this._throttledRequestHandler()}this._requests.length>0&&(time_elapsed=this._requests[0].age(),this._requests[0].dead!==null&&this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait)&&(Strophe.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}},_getRequestStatus:function(req,def){var reqStatus;if(req.xhr.readyState==4)try{reqStatus=req.xhr.status}catch(e){Strophe.error("Caught an error while retrieving a request's status, reqStatus: "+reqStatus)}return typeof reqStatus=="undefined"&&(reqStatus=typeof def=="number"?def:0),reqStatus},_onRequestStateChange:function(func,req){var reqStatus,reqIs0,reqIs1;if(Strophe.debug("request id "+req.id+"."+req.sends+" state changed to "+req.xhr.readyState),req.abort){req.abort=!1;return}if(req.xhr.readyState===4){if(reqStatus=this._getRequestStatus(req),this.disconnecting&&reqStatus>=400){this._hitError(reqStatus);this._callProtocolErrorHandlers(req);return}(reqStatus>0&&reqStatus<500||req.sends>5)&&(this._removeRequest(req),Strophe.debug("request id "+req.id+" should now be removed"));reqStatus==200?(reqIs0=this._requests[0]==req,reqIs1=this._requests[1]==req,(reqIs1||reqIs0&&this._requests.length>0&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(req.rid)+1),Strophe.debug("request id "+req.id+"."+req.sends+" got 200"),func(req),this.errors=0):reqStatus===0||reqStatus>=400&&reqStatus<600||reqStatus>=12e3?(Strophe.error("request id "+req.id+"."+req.sends+" error "+reqStatus+" happened"),this._hitError(reqStatus),this._callProtocolErrorHandlers(req),reqStatus>=400&&reqStatus<500&&(this._conn._changeConnectStatus(Strophe.Status.DISCONNECTING,null),this._conn._doDisconnect())):Strophe.error("request id "+req.id+"."+req.sends+" error "+reqStatus+" happened");(!(reqStatus>0&&reqStatus<500)||req.sends>5)&&this._throttledRequestHandler()}},_processRequest:function(i){var self=this,req=this._requests[i],reqStatus=this._getRequestStatus(req,-1),contentType,sendFunc,backoff;if(req.sends>this._conn.maxRetries){this._conn._onDisconnectTimeout();return}var time_elapsed=req.age(),primaryTimeout=!isNaN(time_elapsed)&&time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait),secondaryTimeout=req.dead!==null&&req.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait),requestCompletedWithServerError=req.xhr.readyState==4&&(reqStatus<1||reqStatus>=500);if((primaryTimeout||secondaryTimeout||requestCompletedWithServerError)&&(secondaryTimeout&&Strophe.error("Request "+this._requests[i].id+" timed out (secondary), restarting"),req.abort=!0,req.xhr.abort(),req.xhr.onreadystatechange=function(){},this._requests[i]=new Strophe.Request(req.xmlData,req.origFunc,req.rid,req.sends),req=this._requests[i]),req.xhr.readyState===0){Strophe.debug("request id "+req.id+"."+req.sends+" posting");try{contentType=this._conn.options.contentType||"text/xml; charset=utf-8";req.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0);typeof req.xhr.setRequestHeader!="undefined"&&req.xhr.setRequestHeader("Content-Type",contentType);this._conn.options.withCredentials&&(req.xhr.withCredentials=!0)}catch(e2){Strophe.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-service");this._conn.disconnect();return}sendFunc=function(){var headers,header;if(req.date=new Date,self._conn.options.customHeaders){headers=self._conn.options.customHeaders;for(header in headers)headers.hasOwnProperty(header)&&req.xhr.setRequestHeader(header,headers[header])}req.xhr.send(req.data)};req.sends>1?(backoff=Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(req.sends,3))*1e3,this._conn._timeProvider.setTimeout(function(){sendFunc()},backoff)):sendFunc();req.sends++;this._conn.xmlOutput!==Strophe.Connection.prototype.xmlOutput&&(req.xmlData.nodeName===this.strip&&req.xmlData.childNodes.length?this._conn.xmlOutput(req.xmlData.childNodes[0]):this._conn.xmlOutput(req.xmlData));this._conn.rawOutput!==Strophe.Connection.prototype.rawOutput&&this._conn.rawOutput(req.data)}else Strophe.debug("_processRequest: "+(i===0?"first":"second")+" request has readyState of "+req.xhr.readyState)},_removeRequest:function(req){Strophe.debug("removing request");for(var i=this._requests.length-1;i>=0;i--)req==this._requests[i]&&this._requests.splice(i,1);req.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(i){var req=this._requests[i];req.dead===null&&(req.dead=new Date);this._processRequest(i)},_reqToData:function(req){try{return req.getResponse()}catch(e){if(e!="parsererror")throw e;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(pres){var body,req;Strophe.debug("_sendTerminate was called");body=this._buildBody().attrs({type:"terminate"});pres&&body.cnode(pres.tree());req=new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),body.tree().getAttribute("rid"));this._requests.push(req);this._throttledRequestHandler()},_send:function(){this._conn._timeProvider.clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=this._conn._timeProvider.setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();this._conn._timeProvider.clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){(this._requests?Strophe.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):Strophe.debug("_throttledRequestHandler called with undefined requests"),this._requests&&this._requests.length!==0)&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},Strophe}),function(root,factory){if(typeof define=="function"&&define.amd)define("strophe-websocket",["strophe-core"],function(core){return factory(core.Strophe,core.$build)});else return factory(Strophe,$build)}(globalThis,function(Strophe,$build){return Strophe.Websocket=function(connection){var service,new_service;this._conn=connection;this.strip="wrapper";service=connection.service;service.indexOf("ws:")!==0&&service.indexOf("wss:")!==0&&(new_service="",new_service+=connection.options.protocol==="ws"&&window.location.protocol!=="https:"?"ws":"wss",new_service+="://"+window.location.host,new_service+=service.indexOf("/")!==0?window.location.pathname+service:service,connection.service=new_service)},Strophe.Websocket.prototype={_buildStream:function(){return $build("open",{xmlns:Strophe.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(bodyWrap,connectstatus){var errors,i,e,errorString;if(errors=bodyWrap.getElementsByTagNameNS?bodyWrap.getElementsByTagNameNS(Strophe.NS.STREAM,"error"):bodyWrap.getElementsByTagName("stream:error"),errors.length===0)return!1;var error=errors[0],condition="",text="";for(i=0;i<error.childNodes.length;i++){if(e=error.childNodes[i],e.getAttribute("xmlns")!=="urn:ietf:params:xml:ns:xmpp-streams")break;e.nodeName==="text"?text=e.textContent:condition=e.nodeName}return errorString="WebSocket stream error: ",errorString+=condition?condition:"unknown",text&&(errorString+=" - "+condition),Strophe.error(errorString),this._conn._changeConnectStatus(connectstatus,condition),this._conn._doDisconnect(),!0},_reset:function(){return},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(bodyWrap){var error=this._check_streamerror(bodyWrap,Strophe.Status.CONNFAIL);if(error)return Strophe.Status.CONNFAIL},_handleStreamStart:function(message){var error=!1,ns=message.getAttribute("xmlns"),ver;return(typeof ns!="string"?error="Missing xmlns in <open />":ns!==Strophe.NS.FRAMING&&(error="Wrong xmlns in <open />: "+ns),ver=message.getAttribute("version"),typeof ver!="string"?error="Missing version in <open />":ver!=="1.0"&&(error="Wrong version in <open />: "+ver),error)?(this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,error),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(message){var data,streamStart,see_uri,string,elem;if(message.data.indexOf("<open ")===0||message.data.indexOf("<?xml")===0){if(data=message.data.replace(/^(<\?.*?\?>\s*)*/,""),data==="")return;streamStart=(new DOMParser).parseFromString(data,"text/xml").documentElement;this._conn.xmlInput(streamStart);this._conn.rawInput(message.data);this._handleStreamStart(streamStart)&&this._connect_cb(streamStart)}else message.data.indexOf("<close ")===0?(this._conn.rawInput(message.data),this._conn.xmlInput(message),see_uri=message.getAttribute("see-other-uri"),see_uri?(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=see_uri,this._connect()):(this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(string=this._streamWrap(message.data),elem=(new DOMParser).parseFromString(string,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(elem,null,message.data))},_disconnect:function(pres){var close,closeString;if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){pres&&this._conn.send(pres);close=$build("close",{xmlns:Strophe.NS.FRAMING});this._conn.xmlOutput(close);closeString=Strophe.serialize(close);this._conn.rawOutput(closeString);try{this.socket.send(closeString)}catch(e){Strophe.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){Strophe.debug("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(stanza){return"<wrapper>"+stanza+"<\/wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(e){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(Strophe.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):Strophe.info("Websocket closed")},_no_auth_received:function(_callback){Strophe.error("Server did not send any auth methods");this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Server did not send any auth methods");_callback&&(_callback=_callback.bind(this._conn),_callback());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(error){Strophe.error("Websocket error "+error);this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()},_onIdle:function(){var data=this._conn._data,i,stanza,rawStanza;if(data.length>0&&!this._conn.paused){for(i=0;i<data.length;i++)data[i]!==null&&(stanza=data[i]==="restart"?this._buildStream().tree():data[i],rawStanza=Strophe.serialize(stanza),this._conn.xmlOutput(stanza),this._conn.rawOutput(rawStanza),this.socket.send(rawStanza));this._conn._data=[]}},_onMessage:function(message){var elem,data,close='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(message.data===close){this._conn.rawInput(close);this._conn.xmlInput(message);this._conn.disconnecting||this._conn._doDisconnect();return}if(message.data.search("<open ")===0){if(elem=(new DOMParser).parseFromString(message.data,"text/xml").documentElement,!this._handleStreamStart(elem))return}else data=this._streamWrap(message.data),elem=(new DOMParser).parseFromString(data,"text/xml").documentElement;if(!this._check_streamerror(elem,Strophe.Status.ERROR)){if(this._conn.disconnecting&&elem.firstChild.nodeName==="presence"&&elem.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(elem);this._conn.rawInput(Strophe.serialize(elem));return}this._conn._dataRecv(elem,message.data)}},_onOpen:function(){var start,startString;Strophe.info("Websocket open");start=this._buildStream();this._conn.xmlOutput(start.tree());startString=Strophe.serialize(start);this._conn.rawOutput(startString);this.socket.send(startString)},_reqToData:function(stanza){return stanza},_send:function(){this._conn.flush()},_sendRestart:function(){this._conn._timeProvider.clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}},Strophe}),function(){typeof define=="function"&&define.amd&&define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(wrapper){return wrapper})}(this),callback)if(typeof define=="function"&&define.amd){var n_callback=callback;typeof requirejs=="function"?requirejs(["strophe"],function(o){n_callback(o.Strophe,o.$build,o.$msg,o.$iq,o.$pres)}):require(["strophe"],function(o){n_callback(o.Strophe,o.$build,o.$msg,o.$iq,o.$pres)})}else return callback(Strophe,$build,$msg,$iq,$pres)})(function(Strophe,build,msg,iq,pres){window.Strophe=Strophe;window.$build=build;window.$msg=msg;window.$iq=iq;window.$pres=pres});__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(conn){return this._connection=conn,this._muc_handler=null,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user"),Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(room,nick,msg_handler_cb,pres_handler_cb,roster_cb,password,history_attrs){var msg,room_nick,_ref,_this=this;return room_nick=this.test_append_nick(room,nick),msg=$pres({from:this._connection.jid,to:room_nick}).c("x",{xmlns:Strophe.NS.MUC}),history_attrs!=null&&(msg=msg.c("history",history_attrs)),password!=null&&msg.cnode(Strophe.xmlElement("password",[],password)),(_ref=this._muc_handler)==null&&(this._muc_handler=this._connection.addHandler(function(stanza){var from,handler,handlers,id,roomname,x,xmlns,xquery,_i,_len;if((from=stanza.getAttribute("from"),!from)||(roomname=from.split("/")[0],!_this.rooms[roomname]))return!0;if(room=_this.rooms[roomname],handlers={},stanza.nodeName==="message")handlers=room._message_handlers;else if(stanza.nodeName==="presence"&&(xquery=stanza.getElementsByTagName("x"),xquery.length>0))for(_i=0,_len=xquery.length;_i<_len;_i++)if(x=xquery[_i],xmlns=x.getAttribute("xmlns"),xmlns&&xmlns.match(Strophe.NS.MUC)){handlers=room._presence_handlers;break}for(id in handlers)handler=handlers[id],handler(stanza,room)||delete handlers[id];return!0})),this.rooms.hasOwnProperty(room)||(this.rooms[room]=new XmppRoom(this,room,nick,password),this.roomNames.push(room)),pres_handler_cb&&this.rooms[room].addHandler("presence",pres_handler_cb),msg_handler_cb&&this.rooms[room].addHandler("message",msg_handler_cb),roster_cb&&this.rooms[room].addHandler("roster",roster_cb),this._connection.send(msg)},leave:function(room,nick,handler_cb,exit_msg){var id,presence,presenceid,room_nick;return id=this.roomNames.indexOf(room),delete this.rooms[room],id>=0&&(this.roomNames.splice(id,1),this.roomNames.length===0&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null)),room_nick=this.test_append_nick(room,nick),presenceid=this._connection.getUniqueId(),presence=$pres({type:"unavailable",id:presenceid,from:this._connection.jid,to:room_nick}),exit_msg!=null&&presence.c("status",exit_msg),handler_cb!=null&&this._connection.addHandler(handler_cb,null,"presence",null,presenceid),this._connection.send(presence),presenceid},message:function(room,nick,message,html_message,type){var msg,msgid,parent,room_nick;return room_nick=this.test_append_nick(room,nick),type=type||(nick!=null?"chat":"groupchat"),msgid=this._connection.getUniqueId(),msg=$msg({to:room_nick,from:this._connection.jid,type:type,id:msgid}).c("body",{xmlns:Strophe.NS.CLIENT}).t(message),msg.up(),html_message!=null&&(msg.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).t(html_message),msg.node.childNodes.length===0?(parent=msg.node.parentNode,msg.up().up(),msg.node.removeChild(parent)):msg.up().up()),msg.c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(msg),msgid},groupchat:function(room,message,html_message){return this.message(room,null,message,html_message)},invite:function(room,receiver,reason){var invitation,msgid;return msgid=this._connection.getUniqueId(),invitation=$msg({from:this._connection.jid,to:room,id:msgid}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:receiver}),reason!=null&&invitation.c("reason",reason),this._connection.send(invitation),msgid},directInvite:function(room,receiver,reason,password){var attrs,invitation,msgid;return msgid=this._connection.getUniqueId(),attrs={xmlns:"jabber:x:conference",jid:room},reason!=null&&(attrs.reason=reason),password!=null&&(attrs.password=password),invitation=$msg({from:this._connection.jid,to:receiver,id:msgid}).c("x",attrs),this._connection.send(invitation),msgid},queryOccupants:function(room,success_cb,error_cb){var attrs,info;return attrs={xmlns:Strophe.NS.DISCO_ITEMS},info=$iq({from:this._connection.jid,to:room,type:"get"}).c("query",attrs),this._connection.sendIQ(info,success_cb,error_cb)},configure:function(room,handler_cb,error_cb){var config,stanza;return config=$iq({to:room,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),stanza=config.tree(),this._connection.sendIQ(stanza,handler_cb,error_cb)},cancelConfigure:function(room){var config,stanza;return config=$iq({to:room,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}),stanza=config.tree(),this._connection.sendIQ(stanza)},saveConfiguration:function(room,config,success_cb,error_cb){var conf,iq,stanza,_i,_len;if(iq=$iq({to:room,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),config instanceof Form)config.type="submit",iq.cnode(config.toXML());else for(iq.c("x",{xmlns:"jabber:x:data",type:"submit"}),_i=0,_len=config.length;_i<_len;_i++)conf=config[_i],iq.cnode(conf).up();return stanza=iq.tree(),this._connection.sendIQ(stanza,success_cb,error_cb)},createInstantRoom:function(room,success_cb,error_cb){var roomiq;return roomiq=$iq({to:room,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this._connection.sendIQ(roomiq.tree(),success_cb,error_cb)},setTopic:function(room,topic){var msg;return msg=$msg({to:room,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(topic),this._connection.send(msg.tree())},_modifyPrivilege:function(room,item,reason,handler_cb,error_cb){var iq;return iq=$iq({to:room,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(item.node),reason!=null&&iq.c("reason",reason),this._connection.sendIQ(iq.tree(),handler_cb,error_cb)},modifyRole:function(room,nick,role,reason,handler_cb,error_cb){var item;return item=$build("item",{nick:nick,role:role}),this._modifyPrivilege(room,item,reason,handler_cb,error_cb)},kick:function(room,nick,reason,handler_cb,error_cb){return this.modifyRole(room,nick,"none",reason,handler_cb,error_cb)},voice:function(room,nick,reason,handler_cb,error_cb){return this.modifyRole(room,nick,"participant",reason,handler_cb,error_cb)},mute:function(room,nick,reason,handler_cb,error_cb){return this.modifyRole(room,nick,"visitor",reason,handler_cb,error_cb)},op:function(room,nick,reason,handler_cb,error_cb){return this.modifyRole(room,nick,"moderator",reason,handler_cb,error_cb)},deop:function(room,nick,reason,handler_cb,error_cb){return this.modifyRole(room,nick,"participant",reason,handler_cb,error_cb)},modifyAffiliation:function(room,jid,affiliation,reason,handler_cb,error_cb){var item;return item=$build("item",{jid:jid,affiliation:affiliation}),this._modifyPrivilege(room,item,reason,handler_cb,error_cb)},ban:function(room,jid,reason,handler_cb,error_cb){return this.modifyAffiliation(room,jid,"outcast",reason,handler_cb,error_cb)},member:function(room,jid,reason,handler_cb,error_cb){return this.modifyAffiliation(room,jid,"member",reason,handler_cb,error_cb)},revoke:function(room,jid,reason,handler_cb,error_cb){return this.modifyAffiliation(room,jid,"none",reason,handler_cb,error_cb)},owner:function(room,jid,reason,handler_cb,error_cb){return this.modifyAffiliation(room,jid,"owner",reason,handler_cb,error_cb)},admin:function(room,jid,reason,handler_cb,error_cb){return this.modifyAffiliation(room,jid,"admin",reason,handler_cb,error_cb)},changeNick:function(room,user){var presence,room_nick;return room_nick=this.test_append_nick(room,user),presence=$pres({from:this._connection.jid,to:room_nick,id:this._connection.getUniqueId()}),this._connection.send(presence.tree())},setStatus:function(room,user,show,status){var presence,room_nick;return room_nick=this.test_append_nick(room,user),presence=$pres({from:this._connection.jid,to:room_nick}),show!=null&&presence.c("show",show).up(),status!=null&&presence.c("status",status),this._connection.send(presence.tree())},listRooms:function(server,handle_cb,error_cb){var iq;return iq=$iq({to:server,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),this._connection.sendIQ(iq,handle_cb,error_cb)},test_append_nick:function(room,nick){return room+(nick!=null?"/"+Strophe.escapeNode(nick):"")}});XmppRoom=function(){function XmppRoom(client,name,nick,password){this.client=client;this.name=name;this.nick=nick;this.password=password;this._roomRosterHandler=__bind(this._roomRosterHandler,this);this._addOccupant=__bind(this._addOccupant,this);this.roster={};this._message_handlers={};this._presence_handlers={};this._roster_handlers={};this._handler_ids=0;client.muc&&(this.client=client.muc);this.name=Strophe.getBareJidFromJid(name);this.addHandler("presence",this._roomRosterHandler)}return XmppRoom.prototype.join=function(msg_handler_cb,pres_handler_cb,roster_cb){return this.client.join(this.name,this.nick,msg_handler_cb,pres_handler_cb,roster_cb,this.password)},XmppRoom.prototype.leave=function(handler_cb,message){return this.client.leave(this.name,this.nick,handler_cb,message),delete this.client.rooms[this.name]},XmppRoom.prototype.message=function(nick,message,html_message,type){return this.client.message(this.name,nick,message,html_message,type)},XmppRoom.prototype.groupchat=function(message,html_message){return this.client.groupchat(this.name,message,html_message)},XmppRoom.prototype.invite=function(receiver,reason){return this.client.invite(this.name,receiver,reason)},XmppRoom.prototype.directInvite=function(receiver,reason){return this.client.directInvite(this.name,receiver,reason,this.password)},XmppRoom.prototype.configure=function(handler_cb){return this.client.configure(this.name,handler_cb)},XmppRoom.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)},XmppRoom.prototype.saveConfiguration=function(config){return this.client.saveConfiguration(this.name,config)},XmppRoom.prototype.queryOccupants=function(success_cb,error_cb){return this.client.queryOccupants(this.name,success_cb,error_cb)},XmppRoom.prototype.setTopic=function(topic){return this.client.setTopic(this.name,topic)},XmppRoom.prototype.modifyRole=function(nick,role,reason,success_cb,error_cb){return this.client.modifyRole(this.name,nick,role,reason,success_cb,error_cb)},XmppRoom.prototype.kick=function(nick,reason,handler_cb,error_cb){return this.client.kick(this.name,nick,reason,handler_cb,error_cb)},XmppRoom.prototype.voice=function(nick,reason,handler_cb,error_cb){return this.client.voice(this.name,nick,reason,handler_cb,error_cb)},XmppRoom.prototype.mute=function(nick,reason,handler_cb,error_cb){return this.client.mute(this.name,nick,reason,handler_cb,error_cb)},XmppRoom.prototype.op=function(nick,reason,handler_cb,error_cb){return this.client.op(this.name,nick,reason,handler_cb,error_cb)},XmppRoom.prototype.deop=function(nick,reason,handler_cb,error_cb){return this.client.deop(this.name,nick,reason,handler_cb,error_cb)},XmppRoom.prototype.modifyAffiliation=function(jid,affiliation,reason,success_cb,error_cb){return this.client.modifyAffiliation(this.name,jid,affiliation,reason,success_cb,error_cb)},XmppRoom.prototype.ban=function(jid,reason,handler_cb,error_cb){return this.client.ban(this.name,jid,reason,handler_cb,error_cb)},XmppRoom.prototype.member=function(jid,reason,handler_cb,error_cb){return this.client.member(this.name,jid,reason,handler_cb,error_cb)},XmppRoom.prototype.revoke=function(jid,reason,handler_cb,error_cb){return this.client.revoke(this.name,jid,reason,handler_cb,error_cb)},XmppRoom.prototype.owner=function(jid,reason,handler_cb,error_cb){return this.client.owner(this.name,jid,reason,handler_cb,error_cb)},XmppRoom.prototype.admin=function(jid,reason,handler_cb,error_cb){return this.client.admin(this.name,jid,reason,handler_cb,error_cb)},XmppRoom.prototype.changeNick=function(nick){return this.nick=nick,this.client.changeNick(this.name,nick)},XmppRoom.prototype.setStatus=function(show,status){return this.client.setStatus(this.name,this.nick,show,status)},XmppRoom.prototype.addHandler=function(handler_type,handler){var id=this._handler_ids++;switch(handler_type){case"presence":this._presence_handlers[id]=handler;break;case"message":this._message_handlers[id]=handler;break;case"roster":this._roster_handlers[id]=handler;break;default:return this._handler_ids--,null}return id},XmppRoom.prototype.removeHandler=function(id){return delete this._presence_handlers[id],delete this._message_handlers[id],delete this._roster_handlers[id]},XmppRoom.prototype._addOccupant=function(data){var occ;return occ=new Occupant(data,this),this.roster[occ.nick]=occ,occ},XmppRoom.prototype._roomRosterHandler=function(pres){var data,handler,id,newnick,nick,_ref;data=XmppRoom._parsePresence(pres);nick=data.nick;newnick=data.newnick||null;switch(data.type){case"error":return;case"unavailable":newnick&&(data.nick=newnick,this.roster[nick]&&this.roster[newnick]&&(this.roster[nick].update(this.roster[newnick]),this.roster[newnick]=this.roster[nick]),this.roster[nick]&&!this.roster[newnick]&&(this.roster[newnick]=this.roster[nick].update(data)));delete this.roster[nick];break;default:this.roster[nick]?this.roster[nick].update(data):this._addOccupant(data)}_ref=this._roster_handlers;for(id in _ref)handler=_ref[id],handler(this.roster,this)||delete this._roster_handlers[id];return!0},XmppRoom._parsePresence=function(pres){var a,c,c2,data,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;for(data={},a=pres.attributes,data.nick=Strophe.getResourceFromJid(a.from.textContent),data.type=((_ref=a.type)!=null?_ref.textContent:void 0)||null,data.states=[],_ref1=pres.childNodes,_i=0,_len=_ref1.length;_i<_len;_i++){c=_ref1[_i];switch(c.nodeName){case"status":data.status=c.textContent||null;break;case"show":data.show=c.textContent||null;break;case"x":if(a=c.attributes,((_ref2=a.xmlns)!=null?_ref2.textContent:void 0)===Strophe.NS.MUC_USER)for(_ref3=c.childNodes,_j=0,_len1=_ref3.length;_j<_len1;_j++){c2=_ref3[_j];switch(c2.nodeName){case"item":a=c2.attributes;data.affiliation=((_ref4=a.affiliation)!=null?_ref4.textContent:void 0)||null;data.role=((_ref5=a.role)!=null?_ref5.textContent:void 0)||null;data.jid=((_ref6=a.jid)!=null?_ref6.textContent:void 0)||null;data.newnick=((_ref7=a.nick)!=null?_ref7.textContent:void 0)||null;break;case"status":c2.attributes.code&&data.states.push(c2.attributes.code.textContent)}}}}return data},XmppRoom}();RoomConfig=function(){function RoomConfig(info){this.parse=__bind(this.parse,this);info!=null&&this.parse(info)}return RoomConfig.prototype.parse=function(result){var attr,attrs,child,field,identity,query,_i,_j,_k,_len,_len1,_len2,_ref;for(query=result.getElementsByTagName("query")[0].childNodes,this.identities=[],this.features=[],this.x=[],_i=0,_len=query.length;_i<_len;_i++){child=query[_i];attrs=child.attributes;switch(child.nodeName){case"identity":for(identity={},_j=0,_len1=attrs.length;_j<_len1;_j++)attr=attrs[_j],identity[attr.name]=attr.textContent;this.identities.push(identity);break;case"feature":this.features.push(attrs["var"].textContent);break;case"x":if(attrs=child.childNodes[0].attributes,!1)break;for(_ref=child.childNodes,_k=0,_len2=_ref.length;_k<_len2;_k++)(field=_ref[_k],field.attributes.type)||(attrs=field.attributes,this.x.push({"var":attrs["var"].textContent,label:attrs.label.textContent||"",value:field.firstChild.textContent||""}))}}return{identities:this.identities,features:this.features,x:this.x}},RoomConfig}();Occupant=function(){function Occupant(data,room){this.room=room;this.update=__bind(this.update,this);this.admin=__bind(this.admin,this);this.owner=__bind(this.owner,this);this.revoke=__bind(this.revoke,this);this.member=__bind(this.member,this);this.ban=__bind(this.ban,this);this.modifyAffiliation=__bind(this.modifyAffiliation,this);this.deop=__bind(this.deop,this);this.op=__bind(this.op,this);this.mute=__bind(this.mute,this);this.voice=__bind(this.voice,this);this.kick=__bind(this.kick,this);this.modifyRole=__bind(this.modifyRole,this);this.update(data)}return Occupant.prototype.modifyRole=function(role,reason,success_cb,error_cb){return this.room.modifyRole(this.nick,role,reason,success_cb,error_cb)},Occupant.prototype.kick=function(reason,handler_cb,error_cb){return this.room.kick(this.nick,reason,handler_cb,error_cb)},Occupant.prototype.voice=function(reason,handler_cb,error_cb){return this.room.voice(this.nick,reason,handler_cb,error_cb)},Occupant.prototype.mute=function(reason,handler_cb,error_cb){return this.room.mute(this.nick,reason,handler_cb,error_cb)},Occupant.prototype.op=function(reason,handler_cb,error_cb){return this.room.op(this.nick,reason,handler_cb,error_cb)},Occupant.prototype.deop=function(reason,handler_cb,error_cb){return this.room.deop(this.nick,reason,handler_cb,error_cb)},Occupant.prototype.modifyAffiliation=function(affiliation,reason,success_cb,error_cb){return this.room.modifyAffiliation(this.jid,affiliation,reason,success_cb,error_cb)},Occupant.prototype.ban=function(reason,handler_cb,error_cb){return this.room.ban(this.jid,reason,handler_cb,error_cb)},Occupant.prototype.member=function(reason,handler_cb,error_cb){return this.room.member(this.jid,reason,handler_cb,error_cb)},Occupant.prototype.revoke=function(reason,handler_cb,error_cb){return this.room.revoke(this.jid,reason,handler_cb,error_cb)},Occupant.prototype.owner=function(reason,handler_cb,error_cb){return this.room.owner(this.jid,reason,handler_cb,error_cb)},Occupant.prototype.admin=function(reason,handler_cb,error_cb){return this.room.admin(this.jid,reason,handler_cb,error_cb)},Occupant.prototype.update=function(data){return this.nick=data.nick||null,this.affiliation=data.affiliation||null,this.role=data.role||null,this.jid=data.jid||null,this.status=data.status||null,this.show=data.show||null,this},Occupant}();Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(conn){this._connection=conn;this._identities=[];this._features=[];this._items=[];conn.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);conn.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(category,type,name,lang){typeof name=="undefined"&&(name="");typeof lang=="undefined"&&(lang="");for(var i=0;i<this._identities.length;i++)if(this._identities[i].category==category&&this._identities[i].type==type&&this._identities[i].name==name&&this._identities[i].lang==lang)return!1;return this._identities.push({category:category,type:type,name:name,lang:lang}),!0},addFeature:function(var_name){for(var i=0;i<this._features.length;i++)if(this._features[i]==var_name)return!1;return this._features.push(var_name),!0},removeFeature:function(var_name){for(var i=0;i<this._features.length;i++)if(this._features[i]===var_name)return this._features.splice(i,1),!0;return!1},addItem:function(jid,name,node,call_back){return node&&!call_back?!1:(this._items.push({jid:jid,name:name,node:node,call_back:call_back}),!0)},info:function(jid,node,success,error,timeout){var attrs={xmlns:Strophe.NS.DISCO_INFO},info;node&&(attrs.node=node);info=$iq({from:this._connection.jid,to:jid,type:"get"}).c("query",attrs);this._connection.sendIQ(info,success,error,timeout)},items:function(jid,node,success,error,timeout){var attrs={xmlns:Strophe.NS.DISCO_ITEMS},items;node&&(attrs.node=node);items=$iq({from:this._connection.jid,to:jid,type:"get"}).c("query",attrs);this._connection.sendIQ(items,success,error,timeout)},_buildIQResult:function(stanza,query_attrs){var id=stanza.getAttribute("id"),from=stanza.getAttribute("from"),iqresult=$iq({type:"result",id:id});return from!==null&&iqresult.attrs({to:from}),iqresult.c("query",query_attrs)},_onDiscoInfo:function(stanza){var node=stanza.getElementsByTagName("query")[0].getAttribute("node"),attrs={xmlns:Strophe.NS.DISCO_INFO},i,iqresult;for(node&&(attrs.node=node),iqresult=this._buildIQResult(stanza,attrs),i=0;i<this._identities.length;i++)attrs={category:this._identities[i].category,type:this._identities[i].type},this._identities[i].name&&(attrs.name=this._identities[i].name),this._identities[i].lang&&(attrs["xml:lang"]=this._identities[i].lang),iqresult.c("identity",attrs).up();for(i=0;i<this._features.length;i++)iqresult.c("feature",{"var":this._features[i]}).up();return this._connection.send(iqresult.tree()),!0},_onDiscoItems:function(stanza){var query_attrs={xmlns:Strophe.NS.DISCO_ITEMS},node=stanza.getElementsByTagName("query")[0].getAttribute("node"),items,i,iqresult,attrs;if(node){for(query_attrs.node=node,items=[],i=0;i<this._items.length;i++)if(this._items[i].node==node){items=this._items[i].call_back(stanza);break}}else items=this._items;for(iqresult=this._buildIQResult(stanza,query_attrs),i=0;i<items.length;i++)attrs={jid:items[i].jid},items[i].name&&(attrs.name=items[i].name),items[i].node&&(attrs.node=items[i].node),iqresult.c("item",attrs).up();return this._connection.send(iqresult.tree()),!0}});Strophe.addConnectionPlugin("caps",{HASH:"sha-1",node:"http://strophe.im/strophejs/",_ver:"",_connection:null,_knownCapabilities:{},_jidVerIndex:{},init:function(conn){if(this._connection=conn,Strophe.addNamespace("CAPS","http://jabber.org/protocol/caps"),!this._connection.disco)throw"Caps plugin requires the disco plugin to be installed.";this._connection.disco.addFeature(Strophe.NS.CAPS);this._connection.addHandler(this._delegateCapabilities.bind(this),Strophe.NS.CAPS)},generateCapsAttrs:function(){return{xmlns:Strophe.NS.CAPS,hash:this.HASH,node:this.node,ver:this.generateVer()}},generateVer:function(){var curIdent,i;if(this._ver!=="")return this._ver;var ver="",identities=this._connection.disco._identities.sort(this._sortIdentities),identitiesLen=identities.length,features=this._connection.disco._features.sort(),featuresLen=features.length;for(i=0;i<identitiesLen;i++)curIdent=identities[i],ver+=curIdent.category+"/"+curIdent.type+"/"+curIdent.lang+"/"+curIdent.name+"<";for(i=0;i<featuresLen;i++)ver+=features[i]+"<";return this._ver=b64_sha1(ver),this._ver},getCapabilitiesByJid:function(jid){return this._jidVerIndex[jid]?this._knownCapabilities[this._jidVerIndex[jid]]:null},_delegateCapabilities:function(stanza){var from=stanza.getAttribute("from"),c=stanza.getElementsByTagName("c")[0],ver=c.getAttribute("ver"),node=c.getAttribute("node");if(this._knownCapabilities[ver])this._jidVerIndex[from]=ver;else return this._requestCapabilities(from,node,ver);return this._jidVerIndex[from]&&!this._jidVerIndex[from]===ver||(this._jidVerIndex[from]=ver),!0},_requestCapabilities:function(to,node,ver){if(to!==this._connection.jid){var id=this._connection.disco.info(to,node+"#"+ver);this._connection.addHandler(this._handleDiscoInfoReply.bind(this),Strophe.NS.DISCO_INFO,"iq","result",id,to)}return!0},_handleDiscoInfoReply:function(stanza){var query=stanza.getElementsByTagName("query")[0],node=query.getAttribute("node").split("#"),ver=node[1],from=stanza.getAttribute("from"),childNodes,childNodesLen,i;if(this._knownCapabilities[ver])this._jidVerIndex[from]&&!this._jidVerIndex[from]===ver||(this._jidVerIndex[from]=ver);else{for(childNodes=query.childNodes,childNodesLen=childNodes.length,this._knownCapabilities[ver]=[],i=0;i<childNodesLen;i++)node=childNodes[i],this._knownCapabilities[ver].push({name:node.nodeName,attributes:node.attributes});this._jidVerIndex[from]=ver}return!1},_sortIdentities:function(a,b){return a.category>b.category?1:a.category<b.category?-1:a.type>b.type?1:a.type<b.type?-1:a.lang>b.lang?1:a.lang<b.lang?-1:0}}),function(root,factory){typeof define=="function"&&define.amd?define("strophe.rsm",["strophe"],function(Strophe){return factory(Strophe.Strophe,Strophe.$build,Strophe.$iq,Strophe.$msg,Strophe.$pres),Strophe}):factory(root.Strophe,root.$build,root.$iq,root.$msg,root.$pres)}(this,function(Strophe,$build){Strophe.addNamespace("RSM","http://jabber.org/protocol/rsm");Strophe.RSM=function(options){var ii,attrib;if(this.attribs=["max","first","last","after","before","index","count"],typeof options.xml!="undefined")this.fromXMLElement(options.xml);else for(ii=0;ii<this.attribs.length;ii++)attrib=this.attribs[ii],this[attrib]=options[attrib]};Strophe.RSM.prototype={toXML:function(){for(var attrib,xml=$build("set",{xmlns:Strophe.NS.RSM}),ii=0;ii<this.attribs.length;ii++)attrib=this.attribs[ii],typeof this[attrib]!="undefined"&&(xml=xml.c(attrib).t(this[attrib].toString()).up());return xml.tree()},next:function(max){return new Strophe.RSM({max:max,after:this.last})},previous:function(max){return new Strophe.RSM({max:max,before:this.first})},fromXMLElement:function(xmlElement){for(var attrib,elem,ii=0;ii<this.attribs.length;ii++)attrib=this.attribs[ii],elem=xmlElement.getElementsByTagName(attrib)[0],typeof elem!="undefined"&&elem!==null&&(this[attrib]=Strophe.getText(elem),attrib=="first"&&(this.index=elem.getAttribute("index")))}}}),function(){Strophe.addConnectionPlugin("mam",{_c:null,_p:["with","start","end"],init:function(conn){this._c=conn;Strophe.addNamespace("MAM","urn:xmpp:mam:2")},query:function(jid,options){var _p=this._p,attr={type:"set",to:jid},mamAttr,iq,i,pn,p,onMessage,onComplete,_c,handler;for(options=options||{},mamAttr={xmlns:Strophe.NS.MAM},!options.queryid||(mamAttr.queryid=options.queryid,delete options.queryid),iq=$iq(attr).c("query",mamAttr).c("x",{xmlns:"jabber:x:data",type:"submit"}),iq.c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value").t(Strophe.NS.MAM).up().up(),i=0;i<this._p.length;i++)pn=_p[i],p=options[pn],delete options[pn],!p||iq.c("field",{"var":pn}).c("value").t(p).up().up();return iq.up(),onMessage=options.onMessage,delete options.onMessage,onComplete=options.onComplete,delete options.onComplete,iq.cnode(new Strophe.RSM(options).toXML()),_c=this._c,handler=_c.addHandler(onMessage,Strophe.NS.MAM,"message",null),this._c.sendIQ(iq,function(){_c.deleteHandler(handler);onComplete.apply(this,arguments)})}})}();Mustache=function(){var Renderer=function(){};return Renderer.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},context:{},render:function(template,context,partials,in_recursion){if(in_recursion||(this.context=context,this.buffer=[]),!this.includes("",template)){if(in_recursion)return template;this.send(template);return}template=this.render_pragmas(template);var html=this.render_section(template,context,partials);if(in_recursion)return this.render_tags(html,context,partials,in_recursion);this.render_tags(html,context,partials,in_recursion)},send:function(line){line!=""&&this.buffer.push(line)},render_pragmas:function(template){if(!this.includes("%",template))return template;var that=this,regex=new RegExp(this.otag+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+this.ctag);return template.replace(regex,function(match,pragma,options){if(!that.pragmas_implemented[pragma])throw{message:"This implementation of mustache doesn't understand the '"+pragma+"' pragma"};if(that.pragmas[pragma]={},options){var opts=options.split("=");that.pragmas[pragma][opts[0]]=opts[1]}return""})},render_partial:function(name,context,partials){if(name=this.trim(name),!partials||partials[name]===undefined)throw{message:"unknown_partial '"+name+"'"};return typeof context[name]!="object"?this.render(partials[name],context,partials,!0):this.render(partials[name],context[name],partials,!0)},render_section:function(template,context,partials){if(!this.includes("#",template)&&!this.includes("^",template))return template;var that=this,regex=new RegExp(this.otag+"(\\^|\\#)\\s*(.+)\\s*"+this.ctag+"\n*([\\s\\S]+?)"+this.otag+"\\/\\s*\\2\\s*"+this.ctag+"\\s*","mg");return template.replace(regex,function(match,type,name,content){var value=that.find(name,context);return type=="^"?!value||that.is_array(value)&&value.length===0?that.render(content,context,partials,!0):"":type=="#"?that.is_array(value)?that.map(value,function(row){return that.render(content,that.create_context(row),partials,!0)}).join(""):that.is_object(value)?that.render(content,that.create_context(value),partials,!0):typeof value=="function"?value.call(context,content,function(text){return that.render(text,context,partials,!0)}):value?that.render(content,context,partials,!0):"":void 0})},render_tags:function(template,context,partials,in_recursion){for(var that=this,new_regex=function(){return new RegExp(that.otag+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+that.ctag+"+","g")},regex=new_regex(),tag_replace_callback=function(match,operator,name){switch(operator){case"!":return"";case"=":return that.set_delimiters(name),regex=new_regex(),"";case">":return that.render_partial(name,context,partials);case"{":return that.find(name,context);default:return that.escape(that.find(name,context))}},lines=template.split("\n"),i=0;i<lines.length;i++)lines[i]=lines[i].replace(regex,tag_replace_callback,this),in_recursion||this.send(lines[i]);if(in_recursion)return lines.join("\n")},set_delimiters:function(delimiters){var dels=delimiters.split(" ");this.otag=this.escape_regex(dels[0]);this.ctag=this.escape_regex(dels[1])},escape_regex:function(text){if(!arguments.callee.sRE)arguments.callee.sRE=new RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g");return text.replace(arguments.callee.sRE,"\\$1")},find:function(name,context){function is_kinda_truthy(bool){return bool===!1||bool===0||bool}name=this.trim(name);var value;return(is_kinda_truthy(context[name])?value=context[name]:is_kinda_truthy(this.context[name])&&(value=this.context[name]),typeof value=="function")?value.apply(context):value!==undefined?value:""},includes:function(needle,haystack){return haystack.indexOf(this.otag+needle)!=-1},escape:function(s){return s=String(s===null?"":s),s.replace(/&(?!\w+;)|["<>\\]/g,function(s){switch(s){case"&":return"&amp;";case"\\":return"\\\\";case'"':return'"';case"<":return"&lt;";case">":return"&gt;";default:return s}})},create_context:function(_context){var iterator,ctx;return this.is_object(_context)?_context:(iterator=".",this.pragmas["IMPLICIT-ITERATOR"]&&(iterator=this.pragmas["IMPLICIT-ITERATOR"].iterator),ctx={},ctx[iterator]=_context,ctx)},is_object:function(a){return a&&typeof a=="object"},is_array:function(a){return Object.prototype.toString.call(a)==="[object Array]"},trim:function(s){return s.replace(/^\s*|\s*$/g,"")},map:function(array,fn){var r,l,i;if(typeof array.map=="function")return array.map(fn);for(r=[],l=array.length,i=0;i<l;i++)r.push(fn(array[i]));return r}},{name:"mustache.js",version:"0.3.0",to_html:function(template,view,partials,send_fun){var renderer=new Renderer;return send_fun&&(renderer.send=send_fun),renderer.render(template,view,partials),send_fun?void 0:renderer.buffer.join("\n")}}}(),function($){var __slice=Array.prototype.slice,i18n={dict:null,missingPattern:null,load:function(i18nDict,missingPattern){this.dict!==null?$.extend(this.dict,i18nDict):this.dict=i18nDict;missingPattern&&(this.missingPattern=missingPattern)},unload:function(){this.dict=null;this.missingPattern=null},_:function(str){var dict=this.dict,args;if(dict&&dict.hasOwnProperty(str))str=dict[str];else if(this.missingPattern!==null)return this.printf(this.missingPattern,str);return args=__slice.call(arguments),args[0]=str,this.printf.apply(this,args)},printf:function(str,args){return arguments.length<2?str:(args=$.isArray(args)?args:__slice.call(arguments,1),str.replace(/([^%]|^)%(?:(\d+)\$)?s/g,function(p0,p,position){return position?p+args[parseInt(position)-1]:p+args.shift()}).replace(/%%s/g,"%s"))}};$.fn._t=function(){return $(this).html(i18n._.apply(i18n,arguments))};$.i18n=i18n}(jQuery);dateFormat=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){for(val=String(val),len=len||2;val.length<len;)val="0"+val;return val};return function(date,mask,utc){var dF=dateFormat;if(arguments.length!=1||Object.prototype.toString.call(date)!="[object String]"||/\d/.test(date)||(mask=date,date=undefined),date=date?new Date(date):new Date,isNaN(date))throw SyntaxError("invalid date");mask=String(dF.masks[mask]||mask||dF.masks["default"]);mask.slice(0,4)=="UTC:"&&(mask=mask.slice(4),utc=!0);var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:dF.i18n.dayNames[D],dddd:dF.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:dF.i18n.monthNames[m],mmmm:dF.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:H<12?"a":"p",tt:H<12?"am":"pm",T:H<12?"A":"P",TT:H<12?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(mask,utc){return dateFormat(this,mask,utc)};
/*!
 * IFM Candy bundle 1.3.1-0
 * Copyright (c) IFM Infomaster. All rights reserved.
 */
Candy={};namespace("Ifm.Chat.Extras.FileTransfer",function(){this.transferFile=function(roomJid,ft,file,strings){if(!file||!file.name||file.size===undefined||!file.type===undefined){Ifm.Diagnostics.Debug.print("Invalid argument file");return}var isSender=file.token?!1:!0,usize;usize=file.size>=1073741824?Math.round(file.size/1073741824)+" GB":file.size>=1048576?Math.round(file.size/1048576)+" MB":file.size>=1024?Math.round(file.size/1024)+" KB":file.size>1?file.size+" bytes":file.size===1?"1 byte":"0 bytes";ft.events.waiting=function(ft,e){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),tm,tab,ve;if(!data){ft.cancel();return}isSender&&(tm=new Ifm.Messaging.FStringMessageWriter("FTTOKEN"),tm.add(e.token).add(file.name).add(file.size).add(file.type).end(),Candies.send(roomJid,tm));var viewElementId="ft-item-"+ft.id,viewElementHtml="<span id='"+viewElementId+"'> <span class='filetransfer-title'> "+strings.FileTransfer.TransferTitle+" <\/span> <span class='filetransfer-file'> <b>"+file.name+"<\/b> <\/span> <span class='filetransfer-status'> "+strings.FileTransfer.Waiting+" <\/span> <a class='filetransfer-accept' href='#'> "+strings.FileTransfer.Accept+" <\/a> <a class='filetransfer-cancel' href='#'> "+strings.FileTransfer.Cancel+" <\/a> <\/span>",template=Candy.View.Template.FileTransfer.item,templateData={view:viewElementHtml,time:Candy.Util.localizedTime((new Date).toGMTString())},html=Mustache.to_html(template,templateData);Candy.View.Pane.Room.appendToMessagePane(roomJid,html);tab=Candy.View.Pane.Chat.getTab(roomJid);tab.find(".transfer").show();ve=$("#"+viewElementId);data.filetransfers[ft.id]={filetransfer:ft,viewelement:ve};ve.find(".filetransfer-cancel").click(function(){return ft.cancel(),!1});isSender?ve.find(".filetransfer-accept").remove():(ve.find(".filetransfer-status").text(usize),ve.find(".filetransfer-accept").click(function(){return ft.accept(),ve.find(".filetransfer-accept").remove(),!1}))};ft.events.started=function(ft){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),ve,tab;data&&(ve=data.filetransfers[ft.id].viewelement,isSender?ve.find(".filetransfer-status").text(strings.FileTransfer.Sending):ve.find(".filetransfer-status").text(strings.FileTransfer.Receiving),tab=Candy.View.Pane.Chat.getTab(roomJid),tab.find(".transfer").hide())};ft.events.progress=function(ft,e){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),ve;data&&(ve=data.filetransfers[ft.id].viewelement,ve.find(".filetransfer-status").text(e.percentage+"%"))};ft.events.finished=function(ft,e){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),ve;data&&(ve=data.filetransfers[ft.id].viewelement,ve.find(".filetransfer-cancel").remove(),isSender?(ve.find(".filetransfer-status").text(strings.FileTransfer.Sent),Candies.send(roomJid,strings.FileTransfer.TransferTitle+" "+file.name+" "+usize+" "+strings.FileTransfer.Complete)):(ve.find(".filetransfer-status").text(strings.FileTransfer.Received),ve.append($("<a>",{"class":"filetransfer-open",click:e.openOrSaveFunc,href:"#",text:strings.FileTransfer.Open}))),Ifm.Chat.Extras.MediaPreview.generateThumbnail(roomJid,file.name,e.fileBlob,isSender))};ft.events.canceled=function(ft){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),ve,tab;data&&(ve=data.filetransfers[ft.id].viewelement,ve.find(".filetransfer-status").text(strings.FileTransfer.Canceled),ve.find(".filetransfer-cancel").remove(),isSender||ve.find(".filetransfer-accept").remove(),tab=Candy.View.Pane.Chat.getTab(roomJid),tab.find(".transfer").hide())};ft.events.error=function(ft,e){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),ve,tab;data&&(Candy.View.Pane.Chat.Modal.showError("File Transfer: "+e.reason),data.filetransfers[ft.id]&&(ve=data.filetransfers[ft.id].viewelement,ve.find(".filetransfer-status").text(strings.FileTransfer.Error),ve.find(".filetransfer-cancel").remove(),isSender||ve.find(".filetransfer-accept").remove(),tab=Candy.View.Pane.Chat.getTab(roomJid),tab.find(".transfer").hide()))};isSender?ft.transfer(file):ft.receive(file.token)}});namespace("Ifm.Chat.Extras.MediaPreview",function(){function display(roomJid,html,isSender){Candies.appendToMessagePane(roomJid,html,isSender)}function displayImageModalOnClick(id){var img=document.getElementById(id),modalImg;img&&(modalImg=getModalImage(),modalImg.src=img.src,modalImg.alt=img.alt)}function getModalImage(){var modal=document.getElementById(ModalId),modalImg,close;if(modal)modalImg=document.getElementById(ModalImgId);else{modal=document.createElement("div");modal.id=ModalId;modalImg=document.createElement("img");modalImg.id=ModalImgId;modal.appendChild(modalImg);document.body.appendChild(modal);close=function(){modal.style.display="none";modalImg.src="";modalImg.alt=""};modal.onclick=function(){close()};$("body").on("keydown",function(e){e.which!==27||modal.style.display||close()})}return modal.style.display="",modalImg}this.generateThumbnail=function(roomJid,filename,fileBlob,isSender){var url,type,id;this.isTypeSupported(fileBlob)&&(url=URL.createObjectURL(fileBlob),type=fileBlob.type,type.startsWith("image/")?(id="media-preview-thumbnail-"+(+new Date).toString(36),display(roomJid,'<img id="'+id+'" class="media-preview-thumbnail" src="'+url+'" alt="'+filename+'">',isSender),document.getElementById(id).onclick=function(){displayImageModalOnClick(id)}):type.startsWith("audio/")?display(roomJid,'<audio class="media-preview-player" controls><source src="'+url+'" type="'+fileBlob.type+'"><\/audio>',isSender):type.startsWith("video/")&&display(roomJid,'<video class="media-preview-player" controls><source src="'+url+'" type="'+fileBlob.type+'"><\/video>',isSender))};this.isTypeSupported=function(fileBlob){var type=fileBlob.type;return type.startsWith("image/")||type.startsWith("audio/")||type.startsWith("video/")};var ModalId="media-preview-modal-div",ModalImgId="media-preview-modal-img"});namespace("Ifm.Chat.Extras.UrlPreview",function(){function generate(authKey,url){return new Promise(function(resolve){$.ajax({url:"https://api.linkpreview.net?key="+authKey+"&q="+url,success:function(result){if(!result.title&&!result.description||!result.image){Ifm.Diagnostics.Debug.print("[Candy] [UrlPreview] preview not available for",url);return}var html='<div class="message-url-preview-container"><h1 class="message-url-preview-title">'+result.title+'<\/h1><h2 class="message-url-preview-subtitle">'+result.description+'<\/h2><img class="message-url-preview-img" src="'+result.image+'" alt="'+result.title+'"><\/div>';resolve({url:url,html:html})},error:function(error){Ifm.Diagnostics.Debug.print("[Candy] [UrlPreview] review service returned an error:",error.statusText)}})})}function replace(containerId,url,html){var containerElement=document.getElementById(containerId);if(containerElement){var newLinkElement='<a class="message-url" href="'+url+'" target="_blank">'+html+"<\/a>",validREUrl=url.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1").replace(/&(?!amp;)/g,"&amp;"),oldLinkRE=new RegExp("<a[^>]*href\\s*=\\s*['\"`]"+validREUrl+"['\"`].*?>.*?<\\/a\\s*>","gi");containerElement.innerHTML.match(oldLinkRE)&&(containerElement.innerHTML=containerElement.innerHTML.replace(oldLinkRE,newLinkElement))}}this.findAndGenerate=function(roomJid,message){var authKey=this.settings&&this.settings.authKey,linkRE,originalMessage,containerId,match;if(authKey&&(linkRE=/<a[^>]*href\s*=\s*['"`]((?!javascript)[^\s#'"`]+?)['"`].*?>.*?<\/a\s*>/gi,linkRE.test(message))){for(linkRE.lastIndex=0,originalMessage=message,containerId="message-url-preview-"+(+new Date).toString(36),message='<span id="'+containerId+'">'+originalMessage+"<\/span>";(match=linkRE.exec(originalMessage))!==null;)generate(authKey,match[1]).then(function(result){replace(containerId,result.url,result.html)});Candy.View.Pane.Room.scrollToBottom(roomJid)}return message}}),function(){var ns=namespace("Ifm.PhoneBar.Media"),self;ns.Xmpp={events:defineEvents("initialized","reachable","unreachable","newcall","newmessage","callclosed","filetransfer","showtransferform")};ns.Xmpp.instance=function(){function setupCandy(jQueryInstance){var candybox,defaultUnloadHandler;buildCandy(jQueryInstance);buildCandies();Ifm.Net.TimeProvider.settings&&!Ifm.Net.TimeProvider.settings.service&&(Ifm.Net.TimeProvider.settings.service=_phonebar.config.service);Strophe.timeProvider=Ifm.Net.TimeProvider.getDefault();document.getElementById("candy")||(candybox=document.createElement("div"),candybox.id="candy",candybox.style.display="none",document.body.appendChild(candybox));config.theme?(config.theme.endsWith("/")||(config.theme+="/"),jQueryInstance("head").append('<link rel="stylesheet" href="'+config.theme+'default.css" />')):document.getElementById("candy").style.display="none";Candy.init(config.service,{core:{debug:config.debug,autojoin:[],disconnectWithoutTabs:!1},view:{assets:config.theme,language:config.language}});Candy.View.getOptions().crop.message.body=1e6;strings=Ifm.Chat.Strings[config.language]||Ifm.Chat.Strings.it;defaultUnloadHandler=window.onbeforeunload;window.addEventListener?(window.addEventListener("pagehide",defaultUnloadHandler),window.addEventListener("unload",defaultUnloadHandler)):window.attachEvent("onunload",defaultUnloadHandler);window.onbeforeunload=null;Candy.View.Template.FileTransfer={item:'<li><small>{{time}}<\/small><div class="filetransfer"><span class="spacer">•<\/span><span class="message">{{{view}}}<\/span><\/div><\/li>'};Candy.View.Template.Message.header='<div class="header-wrapper"><span class="chatstatus-text header-text"><\/span><span timerid="" class="chatduration-text header-text"><\/span><button class="header-button hangup-button"><\/button><button class="header-button chattransfer-button"><\/button><button class="header-button chatclosetab-button" style="display:none;"><\/button><\/div>';jQueryInstance(Candy).on("candy:core.chat.connection",function(evt,args){switch(args.status){case Strophe.Status.CONNECTING:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Connecting to XMPP server");break;case Strophe.Status.ATTACHED:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Connection restored with XMPP server");restoreSessionData();break;case Strophe.Status.CONNECTED:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Connected to XMPP server");setTimeout(function(){config.mediatypes&Ifm.PhoneBar.Mediatypes.NearRealTime&&(Candy.Core.subscribe(config.getPresence_nrt(),config.getAgentPre(),config.presence),Candy.Core.subscribe(config.getDomain_nrt()),Candy.Core.subscribe(config.getAdmin_nrt()));config.mediatypes&Ifm.PhoneBar.Mediatypes.StoreAndForward&&(Candy.Core.subscribe(config.getPresence_saf(),config.getAgentPre(),config.presence),Candy.Core.subscribe(config.getDomain_saf()),Candy.Core.subscribe(config.getAdmin_saf()))},100);break;case Strophe.Status.DISCONNECTING:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Disconnecting from XMPP server");break;case Strophe.Status.DISCONNECTED:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Disconnected from XMPP server");Candy.Core.keepconnected?setTimeout(function(){Candy.Core.connect(config.server,null,config.getUsername())},200):events.unreachable.raise(_phonebar,{reason:null});break;case Strophe.Status.CONNFAIL:case Strophe.Status.AUTHFAIL:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Connection with XMPP server failed",args.status);events.unreachable.raise(_phonebar,{reason:"Connection with XMPP server failed"});break;default:_phonebar.log("PhoneBar.Media.Xmpp","Debug","Connection with XMPP server in status",args.status)}});jQueryInstance(Candy).on("candy:view.connection.status-6",function(){Candy.View.Pane.Chat.Modal.hide();for(var roomJid in _activeRooms)cancelAllFileTransfers(roomJid),Candy.View.Pane.Room.close(roomJid);return _activeCalls={},_activeRooms={},updateSessionData(),!1});jQueryInstance(Candy).on("candy:view.connection.status-7",function(){return Candy.View.Pane.Chat.Modal.hide(),!1});jQueryInstance(Candy).on("candy:core.presence",function(evt,args){var msg=args.stanza,from=msg.attr("from"),id=msg.attr("id"),type=msg.attr("type")||"available";_phonebar.log("PhoneBar.Media.Xmpp","Debug","Got",type,"message from",from,"(id",id||"none",")");switch(type){case"subscribe":Candy.Core.subscribed(from,id);break;case"subscribed":Candy.Core.available(from);from.startsWith(config.presence)&&events.reachable.raise(_phonebar,{})}});jQueryInstance(Candy).on("candy:core:chat:invite",function(evt,args){var type,roomJid;(args.inviteType===undefined||args.inviteType==="DirectInvite")&&(type=args.inviteType||"Invite",_phonebar.log("PhoneBar.Media.Xmpp","Debug","Got",type,"message from",args.roomJid),roomJid=Candy.Util.unescapeJid(args.roomJid),Candy.Core.Action.Jabber.Room.Join(roomJid,null))});jQueryInstance(Candy).on("candy:core.message.chatstate",function(evt,args){args.chatstate&&args.name!==Candy.Core.getUsername()&&(args.chatstate==="composing"?Candy.View.updatenotification(args.roomJid,args.displayName,args.chatstate,strings.ChatStateComposing):Candy.View.deletenotification(args.roomJid))});jQueryInstance(Candy).on("candy:view.room.before-add",function(evt,args){var roomJid=args.roomJid,callId,callGuid=roomJid.substr(1,36).toUpperCase(),matched;if(!_activeRooms[roomJid]||!_activeCalls[_activeRooms[roomJid]]){_phonebar.log("PhoneBar.Media.Xmpp","Debug","Matching conversation");matched=!1;for(callId in _activeCalls)if(callGuid===_activeCalls[callId].callGuid){_activeCalls[callId].roomJid=roomJid;_activeRooms[roomJid]=Number(callId);updateSessionData();matched=!0;break}if(!matched)return _phonebar.log("PhoneBar.Media.Xmpp","Debug","Unable to match, no active call for this conversation"),!1}});jQueryInstance(Candy).on("candy:view.room.after-add",function(evt,args){var roomJid=args.roomJid,callId=_activeRooms[roomJid],pane,button,status,startDate,messageList,messageText;Candy.View.Pane.Chat.getTab(roomJid).find(".label").html(_activeCalls[callId].campaignName);pane=Candy.View.Pane.Room.getPane(roomJid);button=pane.find(".hangup-button");button.click(function(){self.close(callId)});button=pane.find(".chatclosetab-button");button.click(function(){self.ready(callId)});button=pane.find(".chattransfer-button");config.showtransfer?button.click(function(){self.showTransferDialog(callId)}):button.hide();status=pane.find(".chatstatus-text");status.text(strings.ChatStateTalking);var myTimerId=setInterval(function(){var endDate=new Date,timeDiff=Math.abs(startDate-endDate),hh=Math.floor(timeDiff/36e5),mm,ss;hh<10&&(hh="0"+hh);timeDiff-=hh*36e5;mm=Math.floor(timeDiff/6e4);mm<10&&(mm="0"+mm);timeDiff-=mm*6e4;ss=Math.floor(timeDiff/1e3);ss<10&&(ss="0"+ss);timer.text(hh+":"+mm+":"+ss)},1e3),timer=pane.find(".chatduration-text"),data=timer.data();data.timerid=myTimerId;startDate=new Date;timer.text("00:00:00");messageList=pane.find(".message-pane-wrapper")[0];messageText=pane.find("[name=message]")[0];data=pane.data();data.filetransfers={};Candy.View.Pane.Chat.fitTabs();messageText.onchange=messageText.oninput=function(){messageText.value===""?(Candy.Core.notifystate(roomJid,"paused"),data.lastnotificationsent=0):(!data.lastnotificationsent||dT()-data.lastnotificationsent>5e3)&&(Candy.Core.notifystate(roomJid,"composing"),data.lastnotificationsent=dT())};messageList.ondragover=messageText.ondragover=function(evt){evt||(evt=window.event);evt&&evt.preventDefault()};messageList.ondrop=messageText.ondrop=function(evt){var text,files;if((evt||(evt=window.event),evt&&evt.preventDefault(),Candy.Core.isConnected())&&_activeCalls[callId]!==undefined&&!_activeCalls[callId].terminated&&evt.source!==messageList&&evt.source!==messageText){if(text=evt.dataTransfer.getData("text"),text){messageText.value=text;messageText.select();return}if(files=evt.dataTransfer.files,files&&files.length>0){doFileTransfer(roomJid,files[0]);return}}}});jQueryInstance(Candy).on("candy:view.pane.roster.after-update",function(evt,args){var roomJid=args.roomJid,callId=_activeRooms[roomJid],user,username;if(args.action==="join"){if(callId===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Debug","Discarding unmatched conversation notification");return}_activeCalls[callId].externalPartyUserName||(user=args.user,username=user.getNick(),user.getRole()!==user.ROLE_MODERATOR&&username!==Candy.Core.getUsername()&&(_activeCalls[callId].externalPartyUserName=username,_activeCalls[callId].externalPartyDisplayName=user.getNick(!0),updateSessionData(),events.newcall.raise(_phonebar,{callId:callId})))}else Candy.View.deletenotification(roomJid)});jQueryInstance(Candy).on("candy:view.message.before-show",function(evt,args){var message,file;if(args.message.startsWith("*begin*"))return args.history||args.name===Candy.Core.getUsername()||(message=new Ifm.Messaging.FStringMessageReader(args.message),message.type==="FTTOKEN"?(file={token:message.data[0],name:message.data[1],size:Number(message.data[2]),type:message.data[3]},doFileTransfer(args.roomJid,file)):message.type==="FTUNSUP"&&(cancelAllFileTransfers(args.roomJid),Candy.View.Pane.Chat.Modal.showError(strings.FileTransfer.NotAvailOther))),!1});jQueryInstance(Candy).on("candy:view.message.before-render",function(evt,args){var data=args.templateData,callId=_activeRooms[data.roomJid],sender=data.displayName,senderIsBot=sender.startsWith("Synthetic"),sentFromHere=data.name!==_activeCalls[callId].externalPartyUserName,e;return senderIsBot&&strings.BotNickname&&(data.displayName=strings.BotNickname,data.croppedDisplayName=Candy.Util.crop(data.displayName,Candy.View.getOptions().crop.message.nickname)),e={callId:callId,displayName:data.displayName,sender:sender,senderIsBot:senderIsBot,sentFromHere:sentFromHere,rawMessage:args.rawMessage,message:data.message,time:data.time,timestamp:data.timestamp,history:args.history,attributes:args.attributes},data.sender=e.sentFromHere?"sender-is-me":"sender-is-other",senderIsBot&&(data.sender+=" sender-is-bot"),events.newmessage.raise(_phonebar,e),e.displayName&&e.displayName!==data.displayName&&(data.displayName=e.displayName,data.croppedDisplayName=Candy.Util.crop(data.displayName,Candy.View.getOptions().crop.message.nickname)),data.message=Ifm.Chat.Extras.UrlPreview.findAndGenerate(args.templateData.roomJid,e.message),data.message?void 0:!1});jQueryInstance(Candy).on("candy:view.message.after-show",function(evt,args){if(args.name!==Candy.Core.getUsername()){var e=args.element;e.addClass("new-message-highlight");setTimeout(function(){e.removeClass("new-message-highlight")},4e3);Candy.View.movenotification(args.roomJid)}});jQueryInstance(Candy).on("candy:view.presence",function(evt,args){var roomJid=args.roomJid,callId=_activeRooms[roomJid],transferred=_activeCalls[callId]&&_activeCalls[callId].transferred,pane=Candy.View.Pane.Room.getPane(roomJid),timer,data,status;Candy.View.deletenotification(roomJid);cancelAllFileTransfers(roomJid);transferred?Candy.View.Pane.Room.close(roomJid):pane&&(Candy.View.Pane.Chat.getTab(roomJid).addClass("closed"),pane.find(".message-form-wrapper").css({visibility:"hidden"}),pane.find(".message-pane-wrapper").css({opacity:".80"}),pane.find(".hangup-button").hide(),pane.find(".chattransfer-button").hide(),pane.find(".chatclosetab-button").show(),timer=pane.find(".chatduration-text"),data=timer.data(),clearInterval(data.timerid),status=pane.find(".chatstatus-text"),status.text(strings.ChatStateClosed));_activeCalls[callId]&&_activeCalls[callId].callClosed!==!0&&(events.callclosed.raise(_phonebar,{callId:callId}),_activeCalls[callId].callClosed=!0,updateSessionData())});jQueryInstance(Candy).on("candy:view.room.after-close",function(evt,args){var roomJid=args.roomJid,callId=_activeRooms[roomJid];_activeCalls[callId]&&_activeCalls[callId].callClosed!==!0&&(events.callclosed.raise(_phonebar,{callId:callId}),_activeCalls[callId].callClosed=!0);delete _activeCalls[callId];delete _activeRooms[roomJid];updateSessionData()})}function restoreSessionData(){var data=window.sessionStorage.getItem("chat-session-calls");data&&(_activeCalls=JSON.parse(data));data=window.sessionStorage.getItem("chat-session-rooms");data&&(_activeRooms=JSON.parse(data))}function updateSessionData(){window.sessionStorage.setItem("chat-session-calls",JSON.stringify(_activeCalls));window.sessionStorage.setItem("chat-session-rooms",JSON.stringify(_activeRooms))}function doFileTransfer(roomJid,file){var callId,um,ft;if(roomJid===undefined||_activeRooms[roomJid]===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Debug","Invalid conversation");return}if(callId=_activeRooms[roomJid],_activeCalls[callId].mediatype!==Ifm.PhoneBar.Mediatypes.NearRealTime){Ifm.Diagnostics.Debug.print("Unsupported mediatype of call",callId);return}if(!Ifm.Net.Services.FileTransfer.isSupported()||!config.ftservice){isSender?Candy.View.Pane.Chat.Modal.showError(strings.FileTransfer.NotAvailable):(um=new Ifm.Messaging.FStringMessageWriter("FTUNSUP").end(),Candies.send(roomJid,um));return}ft=Ifm.Net.Services.FileTransfer.create(config.ftservice);Ifm.Chat.Extras.FileTransfer.transferFile(roomJid,ft,file,strings);events.filetransfer.raise(_phonebar,{callId:_activeRooms[roomJid],file:file,filetransfer:ft})}function cancelAllFileTransfers(roomJid){var pane=Candy.View.Pane.Room.getPane(roomJid),data=pane&&pane.data(),id;if(data&&data.filetransfers)for(id in data.filetransfers)data.filetransfers[id].filetransfer.cancel(),delete data.filetransfers[id]}function hangup(callId,close){if(callId&&_activeCalls[callId]){var roomJid=_activeCalls[callId].roomJid;roomJid&&_activeRooms[roomJid]&&(Candy.Core.Action.Jabber.Room.Leave(roomJid),close&&Candy.View.Pane.Room.getPane(roomJid)&&(cancelAllFileTransfers(roomJid),Candy.View.Pane.Room.close(roomJid)))}}function onAssignment(phonebar,e){(e.mediatype===Ifm.PhoneBar.Mediatypes.NearRealTime||e.mediatype===Ifm.PhoneBar.Mediatypes.StoreAndForward)&&(phonebar.log("PhoneBar.Media.Xmpp","Debug","Assignment event"),_activeCalls[e.callId]=e,updateSessionData())}function onCallFailure(phonebar,e){_activeCalls[e.callId]&&(phonebar.log("PhoneBar.Media.Xmpp","Debug","CallFailure event"),hangup(e.callId,!0))}if(!window.jQuery)throw Ifm.Diagnostics.Errors.miss("jQuery");if(!window.Strophe)throw Ifm.Diagnostics.Errors.miss("Candy/Libs");if(!window.Candy)throw Ifm.Diagnostics.Errors.miss("Candy");var _phonebar=null,PhoneBar=null,_activeCalls={},_activeRooms={},_isInitialized=!1,strings,events=Ifm.PhoneBar.Media.Xmpp.events,config={mediatypes:0,service:"",server:"",ftservice:"",nickname:"",theme:"assets/xmpp/",language:"it",domain_nrt:"xmpp-nrt",domain_saf:"xmpp-saf",admin_nrt:"lxadmin-nrt",admin_saf:"lxadmin-saf",presence:"login",debug:!1,showtransfer:!0,areValidMediatypes:function(){var mediatypes=Ifm.Type.isNumber(this.mediatypes)?this.mediatypes:parseInt(this.mediatypes);return isFinite(mediatypes)&&mediatypes==Ifm.PhoneBar.Mediatypes.NearRealTime||mediatypes==Ifm.PhoneBar.Mediatypes.StoreAndForward||mediatypes==Ifm.PhoneBar.Mediatypes.NearRealTime+Ifm.PhoneBar.Mediatypes.StoreAndForward?!0:!1},getAdmin_nrt:function(){return this.admin_nrt+"@"+this.server},getAdmin_saf:function(){return this.admin_saf+"@"+this.server},getDomain_nrt:function(){return this.domain_nrt+"."+this.server},getDomain_saf:function(){return this.domain_saf+"."+this.server},getPresence_nrt:function(){return this.presence+"@"+this.domain_nrt+"."+this.server},getPresence_saf:function(){return this.presence+"@"+this.domain_saf+"."+this.server},getAgentPre:function(){return"Agent_"+this.extension},getUsername:function(){return(this.displayname||"Agent")+"_"+this.extension}};return{isConnected:function(){return Candy.Core.isConnected()},activeCalls:function(){throw new Error("Obsolete. Use Ifm.PhoneBar.instance.calls() instead.");},getCall:function(){throw new Error("Obsolete. Use Ifm.PhoneBar.instance.calls() instead.");},initialize:function(pb,conf,PhoneBarNS){function customOrDefault(propertyName){return conf.hasOwnProperty(propertyName)?conf[propertyName]:config[propertyName]}function customOrError(propertyName){if(!conf[propertyName])throw Error("Invalid configuration, argument '"+propertyName+"' is missing.");return conf[propertyName]}function init(jQueryInstance){_isInitialized||(setupCandy(jQueryInstance),_isInitialized=!0);events.initialized.raise(_phonebar,{})}if(!pb)throw Ifm.Diagnostics.Errors.arg("pb");if(_phonebar=pb,PhoneBar=PhoneBarNS||Ifm.PhoneBar,!conf)throw Error("Invalid configuration.");if(config.service=customOrError("service"),config.server=customOrError("server"),config.mediatypes=customOrError("mediatypes"),config.ftservice=customOrDefault("ftservice"),config.nickname=customOrDefault("nickname"),config.theme=customOrDefault("theme"),config.language=customOrDefault("language"),config.domain_nrt=customOrDefault("domain_nrt"),config.domain_saf=customOrDefault("domain_saf"),config.admin_nrt=customOrDefault("admin_nrt"),config.admin_saf=customOrDefault("admin_saf"),config.presence=customOrDefault("presence"),config.debug=customOrDefault("debug"),config.showtransfer=customOrDefault("showtransfer"),!config.areValidMediatypes())throw Error("Invalid mediatype(s).");if(config.mediatypes=+config.mediatypes,PhoneBar.events.assignment.addHandler(onAssignment),PhoneBar.events.callfailure.addHandler(onCallFailure),Ifm.Photon&&Ifm.Photon.app.isHosted){const newWindow=Ifm.Dom.Photon.Cards.show('<div id="candy"><\/div>',"chat-window",!0,null,0,"Chat",{left:screen.availWidth-470,top:200,width:450,height:450,minimizeOnClose:!0,showInTaskbar:!0});newWindow&&Ifm.Dom.whenWindowNavigates(newWindow,"popup.html",function(){newWindow.jQuery.i18n=jQuery.i18n;init(newWindow.jQuery)})}else init(jQuery)},terminate:function(){if(this.isConnected())throw Ifm.Diagnostics.Errors.op("must be disconnected");PhoneBar.events.assignment.removeHandler(onAssignment);PhoneBar.events.callfailure.removeHandler(onCallFailure)},connect:function(){var newext=_phonebar.agent.extension,newfirstname=_phonebar.agent.firstName,newlastname=_phonebar.agent.lastName,oldext,oldname,olddisplayname,wasConnected;if(!newext){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Can't connect without an extension specified");Candy.Core.keepconnected=!1;Candy.Core.disconnect();return}oldext=config.extension||null;config.extension=newext;oldname=config.firstname||null;config.firstname=newfirstname;olddisplayname=config.displayname||null;config.displayname=config.nickname||config.firstname;wasConnected=Candy.Core.isConnected();(newext!==oldext||config.displayname!==olddisplayname)&&wasConnected&&(Candy.Core.keepconnected=!0,Candy.Core.disconnect());wasConnected||(_phonebar.log("PhoneBar.Media.Xmpp","Debug","Connecting as",config.displayname),Candy.Core.keepconnected=!0,Candy.Core.connect(config.server,null,config.getUsername()))},disconnect:function(){if(this.isConnected()){for(var roomJid in _activeRooms)Candy.Core.Action.Jabber.Room.Leave(roomJid);setTimeout(function(){var attempt=0,check=setInterval(function(){var calls=Ifm.Enum.getLength(_activeRooms),roomJid;if(calls>0&&++attempt<10){_phonebar.log("PhoneBar.Media.Xmpp","Debug","Waiting for calls to close:",calls,"remaining");return}clearInterval(check);for(roomJid in _activeRooms)cancelAllFileTransfers(roomJid),Candy.View.Pane.Room.getPane(roomJid)&&Candy.View.Pane.Room.close(roomJid);Candy.Core.keepconnected=!1;Candy.Core.disconnect()},100)},100)}},handled:function(callId){return this.sendSysMessage(callId,"HANDLED")?(_activeCalls[callId].handled=!0,updateSessionData(),!0):!1},send:function(callId,message){if(!this.isConnected())return _phonebar.log("PhoneBar.Media.Xmpp","Warn","Cannot send messages while disconnected from XMPP server"),!1;if(_activeCalls[callId]===undefined||_activeCalls[callId].terminated)return _phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId),!1;var roomJid=_activeCalls[callId].roomJid;return roomJid===undefined?(_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId),!1):(Candies.send(roomJid,message),!0)},sendCallInfo:function(callId,data){var msg=new Ifm.Messaging.FStringMessageWriter("CALLINFO");for(var i in data)msg.add(i+":"+data[i]);return this.send(callId,msg.end().toString())},sendSysMessage:function(callId,type){for(var msg=new Ifm.Messaging.FStringMessageWriter(type),i=2;i<arguments.length;i++)msg.add(arguments[i]);return this.send(callId,msg.end().toString())},showTransferDialog:function(callId){try{Ifm.PhoneBar.UI.Commands.showTransferForm(callId)}catch(err){}events.showtransferform.raise(_phonebar,{callId:callId})},close:function(callId){if(this.isConnected()){if(_activeCalls[callId]===undefined||_activeCalls[callId].terminated){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}var roomJid=_activeCalls[callId].roomJid;if(roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}Candy.Core.Action.Jabber.Room.Leave(roomJid)}},ready:function(callId){if(_phonebar.calls(callId)&&_phonebar.calls(callId).postcall&&_phonebar.ready(callId),Candy.Core.isConnected()){if(_activeCalls[callId]===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}if(!_activeCalls[callId].terminated){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Call not yet terminated",callId);return}var roomJid=_activeCalls[callId].roomJid;if(roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}Candy.View.Pane.Room.getPane(roomJid)&&(cancelAllFileTransfers(roomJid),Candy.View.Pane.Room.close(roomJid))}},append:function(callId,html){console.warn("Obsolete. Use xmpp.conversation.append() instead");self.conversation.append(callId,html)},conversation:{append:function(callId,html){var roomJid;if(_activeCalls[callId]===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}if(roomJid=_activeCalls[callId].roomJid,roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}Candy.View.Pane.Chat.onInfoMessage(roomJid,"{{message}}");var pane=Candy.View.Pane.Room.getPane(roomJid),lastmessage=pane.find(".message-pane").children().last(),templatedhtml=lastmessage.html();lastmessage.html(templatedhtml.replace("{{message}}",html))},html:function(callId){var roomJid,pane;if(_activeCalls[callId]===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}if(roomJid=_activeCalls[callId].roomJid,roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}return pane=Candy.View.Pane.Room.getPane(roomJid),pane.find(".message-pane").html()},prepend:function(callId,html){var roomJid,pane;if(_activeCalls[callId]===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}if(roomJid=_activeCalls[callId].roomJid,roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}html&&(pane=Candy.View.Pane.Room.getPane(roomJid),pane.find(".message-pane").prepend(html))},select:function(callId){if(_activeCalls[callId]===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}var roomJid=_activeCalls[callId].roomJid;if(roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}Candy.View.Pane.Room.show(roomJid)}},queryFileTransfer:function(callback){if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");if(!Ifm.Net.Services.FileTransfer.isSupported()||!config.ftservice){callback(!1);return}var ft=Ifm.Net.Services.FileTransfer.create(config.ftservice);ft.enabled(callback)},requestFileTransfer:function(callId,file){var roomJid,i;if(_activeCalls[callId]===undefined||_activeCalls[callId].terminated){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",callId);return}if(_activeCalls[callId].mediatype!==Ifm.PhoneBar.Mediatypes.NearRealTime){Ifm.Diagnostics.Debug.print("Unsupported mediatype of call",callId);return}if(roomJid=_activeCalls[callId].roomJid,roomJid===undefined){_phonebar.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",callId);return}if(!file||!file.name||file.size===undefined||!file.type){i=document.createElement("input");i.type="file";i.style.cssText="display:none!important;";document.body.appendChild(i);i.click();document.body.removeChild(i);i.onchange=function(){i.files&&i.files.length>0&&doFileTransfer(roomJid,i.files[0])};return}}}}();self=ns.Xmpp.instance}();namespace("Ifm.Chat.Strings"),function(ns){ns.en={ChatStateComposing:"is writing...",ChatStateTalking:"Chatting",ChatStateClosed:"Chat terminated",BotNickname:"Synthetic",FileTransfer:{NotAvailable:"File transfer not available",NotAvailOther:"File transfer not available with this user",TransferTitle:"File",Complete:"transferred",Accept:"Accept",Cancel:"Cancel",Open:"Open",Waiting:"waiting",Canceled:"canceled",Error:"error",Receiving:"receiving",Sending:"sending",Received:"received",Sent:"sent"}};ns.it={ChatStateComposing:"sta scrivendo...",ChatStateTalking:"In conversazione",ChatStateClosed:"Conversazione chiusa",BotNickname:"Synthetic",FileTransfer:{NotAvailable:"Trasferimento file non disponibile",NotAvailOther:"Trasferimento file non disponibile con questo utente",TransferTitle:"File",Complete:"trasferito",Accept:"Accetta",Cancel:"Annulla",Open:"Apri",Waiting:"in attesa",Canceled:"annullato",Error:"errore",Receiving:"ricezione",Sending:"invio",Received:"ricevuto",Sent:"inviato"}}}(Ifm.Chat.Strings);