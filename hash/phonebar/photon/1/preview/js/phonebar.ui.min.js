
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";function __errhandler(a,b,c,d,e){if(arguments&&arguments.length){var message=e&&e.message?e.message:a||"Script error",source=b||(e?e.filename:"")||"",line=c||(e?e.lineno:"")||"",column=d||(e?e.colno:"")||"",stack=e&&e.stack?e.stack:source?[source,line,column].join(" "):"window.onerror";Ifm.Application.onerror(message,stack)}}namespace("Ifm"),function(){var scripts,i,matches;for(Ifm.version+="; Ifm.Dom.js/1.1.0",this.Application={frameworkPath:""},scripts=document.getElementsByTagName("script"),i=0;i<scripts.length;i++)if(matches=scripts[i].src.match(/(.*)Ifm\.Dom\.js/),matches&&matches.length===2){Ifm.Application.frameworkPath=matches[1];break}var readyNotified=!1,readyDelegates=[],readyCompleted=function(){if(!readyNotified&&(document.addEventListener||event.type==="load"||document.readyState==="complete")){Ifm.Dom.Strings.replaceAll("%");readyNotified=!0;for(var len=readyDelegates.length;len--;)readyDelegates[len]();readyDelegates=[]}};document.addEventListener?(document.addEventListener("DOMContentLoaded",readyCompleted,!1),window.addEventListener("load",readyCompleted,!1)):(document.attachEvent("onreadystatechange",readyCompleted),window.attachEvent("onload",readyCompleted));this.Application.abort=function(error,stack){var ehome=encodeURIComponent(window.location.href),eerror=encodeURIComponent(error||""),estack=encodeURIComponent(stack||""),s=sessionStorage,p="";s?(s.setItem("home",ehome),s.setItem("error",eerror),s.setItem("stack",estack),s.setItem("info",Ifm.version)):p="?home="+ehome+"&error="+eerror+"&stack="+estack+"&info="+Ifm.version;window.onerror=null;window.onbeforeunload=null;window.location.assign(this.frameworkPath+"blue.htm"+p)};this.Application.parameters=function(){var p={};return p.count=0,(window.location.search+window.location.hash).replace(/([^?&=]+)=([^&]*)?/g,function(match,key,val){key&&(p[key]=val||"",p.count++)}),p};this.Application.showBand=function(message,additional){var html="<div style='margin:16px;'><pre style='font-size:xx-large;'>"+(message||"")+"<\/pre><pre style='font-size:medium;'>"+(additional||"")+"<\/pre><\/div>";Ifm.Dom.Band.show(html)};this.Application.ready=function(onready){if(!Ifm.Type.isFunction(onready))throw new Error("Application.ready() -> Invalid ready handler function");if(readyNotified){setTimeout(onready);return}readyDelegates.push(onready)};this.Application.quit=function(onquit,oncancel){if(onquit&&!Ifm.Type.isFunction(onquit))throw new Error("Application.quit() -> Invalid quit handler function");if(oncancel&&!Ifm.Type.isFunction(oncancel))throw new Error("Application.quit() -> Invalid cancel handler function");window.onbeforeunload=function(){var userchoice=!1;return setTimeout(function(){setTimeout(function(){userchoice&&oncancel&&oncancel()},100)}),userchoice=onquit()}};this.Application.onerror=function(error,stack){Ifm.Diagnostics.Debug.enabled?Ifm.Diagnostics.Debug.fail(error,stack):Ifm.Application.abort(error,stack)}}.call(Ifm);namespace("Ifm.Dom"),function(){function isDocumentReady(document){if(!document||!document.URL||document.URL==="about:blank"||document.URL==="edge://newtab/"||document.URL==="chrome://newtab/")return!1;var state=document.readyState;return state==="interactive"||state==="complete"}this.isReady=function(document){return Ifm.Dom.isWindow(document)&&(document=document.document),isDocumentReady(document)};this.isWindow=function(obj){return obj.constructor.name==="Window"};this.whenReady=function(document,callback){if(Ifm.Dom.isWindow(document)&&(document=document.document),isDocumentReady(document))callback(document);else{var onReadyStateChange=function(){isDocumentReady(document)&&(document.removeEventListener("readystatechange",onReadyStateChange),callback(document))};document.addEventListener("readystatechange",onReadyStateChange)}};this.whenWindowNavigates=function(window,url,callback){var attempt=0,navigationtimer=setInterval(function(){window.location.href.toLowerCase().indexOf(url.toLowerCase())<0||!isDocumentReady(window.document)||++attempt<5||(clearInterval(navigationtimer),Ifm.Dom.whenReady(window,callback))},100)};this.Events={addHandler:window.addEventListener?function(element,type,handler){element.addEventListener(type,handler,!1)}:function(element,type,handler){element.attachEvent("on"+type,handler)},getEvent:function(e){return e||window.event},getTarget:function(e){var event=e||window.event;return event.target||event.srcElement},preventDefault:function(e){var event=e||window.event;event.preventDefault?event.preventDefault():event.returnValue=!1},removeHandler:window.removeEventListener?function(element,type,handler){element.removeEventListener(type,handler,!1)}:function(element,type,handler){element.detachEvent("on"+type,handler)},stopPropagation:function(e){var event=e||window.event;event.stopPropagation?event.stopPropagation():event.cancelBubble=!0},stop:function(e){var event=e||window.event;event.preventDefault&&event.preventDefault();event.stopImmediatePropagation&&event.stopImmediatePropagation();event.stopPropagation&&event.stopPropagation();event.stop&&event.stop();event.cancelBubble=!0;event.returnValue=!1}};this.Dialogs={_dialogs:[]};this.Dialogs.create=function(id,buttons,opts){if(!id||!Ifm.Type.isString(id))throw new Error("Dialogs.create() -> Invalid dialog object id: "+id);if(Ifm.Dom.Dialogs._dialogs[id])throw new Error("Dialogs.create() -> Dialog already created:"+id);var dialog=document.getElementById(id);if(!dialog)throw new Error("Dialogs.create() -> Dialog definition object not found in DOM: "+id);if(dialog.parentNode.removeChild(dialog),buttons&&!Ifm.Type.isArray(buttons))throw new Error("Dialogs.create() -> Invalid buttons array:"+buttons);Ifm.Dom.Dialogs._dialogs[id]={instance:dialog,buttons:buttons||null,options:{modal:(opts||{}).hasOwnProperty("modal")?opts.modal:!0,title:(opts||{}).hasOwnProperty("title")?opts.title:""},arguments:null,result:undefined}};this.Dialogs.show=function(id,title,beforeShow,onHide){var ref,dialog,buttons,dialogContainer,i,button,code;if(!id||!Ifm.Type.isString(id))throw new Error("Dialogs.show() -> Invalid dialog object id: "+id);if(ref=Ifm.Dom.Dialogs._dialogs[id],!ref)throw new Error("Dialogs.show() -> Dialog not created: "+id);if(beforeShow&&!Ifm.Type.isFunction(beforeShow))throw new Error("Dialogs.show() -> Invalid handler: beforeShow");if(onHide&&!Ifm.Type.isFunction(onHide))throw new Error("Dialogs.show() -> Invalid handler: onHide");if(!ref.shown){if(ref.shown=!0,ref.onhide=onHide||null,dialog=ref.instance.cloneNode(!0),buttons=ref.buttons,ref.options.modal&&Ifm.Dom.Fader.show(),dialogContainer=document.createElement("div"),dialogContainer.className="dialog",dialogContainer.style.zIndex="1100",dialogContainer.innerHTML='<div class="dialog-title">'+(title||ref.options.title||"")+'<\/div><div class="dialog-body"><\/div><div class="dialog-buttons"><\/div>',buttons&&buttons.length!==0||(dialogContainer.innerHTML+='<div class="dialog-close"><button class="dialog-close-button" onclick="Ifm.Dom.Dialogs.hide(&apos;'+id+'&apos;, 0);">r<\/button><\/div>'),document.body.appendChild(dialogContainer),ref.container=dialogContainer,dialogContainer.children[1].appendChild(dialog),buttons)for(i=0;i<buttons.length;i++)button=document.createElement("button"),code="Ifm.Dom.Dialogs._dialogs['"+id+"'].result = (function() { "+buttons[i].click+" })(); Ifm.Dom.Dialogs.hide('"+id+"', "+(i+1)+");",button.onclick=new Function(code),button.innerHTML=buttons[i].text,button.style.cssText=buttons[i].cssText,dialogContainer.children[2].appendChild(button);beforeShow&&beforeShow();Ifm.Dom.Strings.replaceAll("%%")}};this.Dialogs.hide=function(id,buttonindex){var ref,dialogContainer;if(!id||!Ifm.Type.isString(id))throw new Error("Dialogs.hide() -> Invalid dialog object id: "+id);if(ref=Ifm.Dom.Dialogs._dialogs[id],!ref)throw new Error("Dialogs.hide() -> Dialog not created: "+id);if(ref.shown){if(ref.onhide)ref.onhide(buttonindex);ref.shown=!1;dialogContainer=ref.container;dialogContainer.style.opacity="0";setTimeout(function(){document.body.removeChild(dialogContainer)},200);ref.options.modal&&Ifm.Dom.Fader.hide()}};this.Cards=function(){var cards={};return{show:function(html,id,dialog,fade,level){id||(id="card"+(+new Date).toString(16));var card;return cards[id]?card=cards[id].element:(card=document.createElement("div"),cards[id]={element:card,fade:!!fade},card.close=Ifm.Dom.Cards.close.bind(null,id),card.shake=Ifm.Dom.Cards.shake.bind(null,id),card.onclosed=null,fade&&Ifm.Dom.Fader.show(),card.style.zIndex="1100",document.body.appendChild(card),card.className="dialog level-"+(level&&/^[12345]$/.test(level)?level:"1"),dialog||setTimeout(()=>{var fader=document.getElementById("ifmjs_sys_fader")||document,oldfunc=fader.onclick;fader.onclick=function(e){fader.onclick=oldfunc;Ifm.Dom.Events.stop(e);Ifm.Dom.Cards.close(id)};card.onclick=fader.onclick},20)),html&&(card.innerHTML=html),card},showDialog:function(html,id,title,buttons,options={},onload){var htmlDialog=Ifm.Dom.Cards._createDialogBody(html,title),dialog=Ifm.Dom.Cards.show(htmlDialog,id,!0,!0);Ifm.Dom.Cards._createDialogButtons(dialog,dialog,buttons);Ifm.Type.isFunction(onload)&&onload(dialog,dialog)},shake:function(id){if(cards[id]){var card=cards[id].element,styleLeft=card.style.left,styleRight=card.style.right,curLeft=card.offsetLeft,f=function(i){var shakeX=10*(i%3-1);card.style.left=curLeft+shakeX+"px";card.style.right=curLeft-shakeX+"px";--i>0?setTimeout(f,20,i):(card.style.left=styleLeft,card.style.right=styleRight)};f(16)}},close:function(id){if(cards[id]){var card=cards[id].element;if(document.body.removeChild(card),cards[id].fade&&Ifm.Dom.Fader.hide(),Ifm.Type.isFunction(card.onclosed))card.onclosed(card);return delete cards[id],card}},get:function(id){return cards[id]||null},getBody:function(id){return cards[id]||null},isShown:function(id){return cards[id]?!0:!1},_createDialogBody:function(html,title){return`
                    <div class="dialog-title">${title}</div>
                    <div class="dialog-body">${html}</div>
                    <div class="dialog-buttons"></div>
                `},_createDialogButtons:function(dialog,dialogBody,buttons){var i,btn;if(dialogBody&&buttons&&buttons.length){const buttonContainer=dialogBody.lastElementChild;for(i=0;i<buttons.length;i++)btn=document.createElement("button"),btn.innerHTML=buttons[i].text||"[Button"+(i+1)+"]",btn.style.cssText=buttons[i].cssText,btn.onclick=function(fn){return Ifm.Type.isFunction(fn)?function(){buttonContainer.querySelectorAll("button").forEach(btn=>btn.disabled=!0);var result=!1;try{if(result=fn(dialog,dialogBody),result instanceof Promise)return result.then(function(resolved){resolved!==!1&&dialog.close()}),result.catch(function(err){console.warn("[Ifm.Dom.Cards] Error executing button action",err);dialog.shake()}),result.finally(function(){buttonContainer.querySelectorAll("button").forEach(btn=>btn.disabled=!1)}),!1}catch(err){console.warn("[Ifm.Dom.Cards] Error executing button action",err);dialog.shake()}buttonContainer.querySelectorAll("button").forEach(btn=>btn.disabled=!1);result!==!1&&dialog.close()}:function(){dialog.close()}}(buttons[i].click),buttonContainer.appendChild(btn)}}}}();this.Band={_bands:[]};this.Band.show=function(html){var band,fader,oldfunc;return Ifm.Dom.Fader.show(),band=document.createElement("div"),band.className="band",band.style.position="absolute",band.style.top="50%",band.style.marginTop="-80px",band.style.minHeight="160px",band.style.left="0px",band.style.width="100%",band.style.backgroundColor="#0066CC",band.style.color="white",band.style.overflow="hidden",band.style.zIndex="1200",fader=document.getElementById("ifmjs_sys_fader")||document,oldfunc=fader.onclick,fader.onclick=function(e){fader.onclick=oldfunc;Ifm.Dom.Events.stop(e);Ifm.Dom.Band.hide()},band.onclick=fader.onclick,band.innerHTML=html,document.body.appendChild(band),Ifm.Dom.Band._bands.push(band),Ifm.Dom.Band._bands.length>1&&(Ifm.Dom.Band._bands[Ifm.Dom.Band._bands.length-2].style.display="none"),band};this.Band.hide=function(){if(Ifm.Dom.Band._bands.length>0){var band=Ifm.Dom.Band._bands.pop(band);document.body.removeChild(band);Ifm.Dom.Fader.hide()}return Ifm.Dom.Band._bands.length>0&&(Ifm.Dom.Band._bands[Ifm.Dom.Band._bands.length-1].style.display=""),band};this.Fader={_faders:0};this.Fader.show=function(){var fader,pageLayout;return Ifm.Dom.Fader._faders++,Ifm.Dom.Fader._faders===1&&(fader=document.getElementById("ifmjs_sys_fader"),fader||(fader=document.createElement("div"),fader.id="ifmjs_sys_fader",fader.style.backgroundColor="#003366",fader.style.opacity="0.50",fader.style.position="absolute",fader.style.left="0",fader.style.top="0",fader.style.width="100%",fader.style.height="100%",fader.style.zIndex="1000",pageLayout=document.getElementById("page-layout"),pageLayout&&(pageLayout.className+=" fade-effect")),document.body.appendChild(fader)),Ifm.Dom.Fader._faders>0};this.Fader.hide=function(){var fader,pageLayout;return Ifm.Dom.Fader._faders--,Ifm.Dom.Fader._faders===0&&(fader=document.getElementById("ifmjs_sys_fader"),fader&&(document.body.removeChild(fader),pageLayout=document.getElementById("page-layout"),pageLayout&&(pageLayout.className=pageLayout.className.replace(" fade-effect","")))),Ifm.Dom.Fader._faders<=0};this.Menu=function(){if(!(this instanceof Ifm.Dom.Menu))throw Ifm.Diagnostics.Errors.ctor();var menuClassId="ifmjs_menu";return{constructor:Ifm.Dom.Menu,choose:function(items,callback){var options,i,item;if(!Ifm.Type.isArray(items))throw Ifm.Diagnostics.Errors.arg("items");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.arg("callback");for(options="",i=0;i<items.length,item=items[i];i++)item.visible!==!1&&(options+=item.label!=="-"?'<option value="{0}" {2}>{1}<\/option>'.format(item.value,item.label,item.disabled?"disabled":""):'<option value="" disabled><\/option>');var select='<div class="menu"><select style="width:100%;" size="{0}">{1}<\/select><\/div>'.format(items.length===1?2:items.length,options),card=Ifm.Dom.Cards.show(select,menuClassId),sele=card.children[0].children[0];sele.onclick=function(){callback(this.value)};sele.onkeydown=function(e){e=Ifm.Dom.Events.getEvent(e);e.which===13&&(Ifm.Dom.Cards.close(menuClassId),callback(this.value));e.which===27&&Ifm.Dom.Cards.close(menuClassId)};sele.focus()}}};this.Strings=function(){function parse(subchar,ref){if(Ifm.Type.isString(ref.nodeValue)&&ref.nodeValue.startsWith(subchar+"(")&&ref.nodeValue.endsWith(")"))try{ref.nodeValue=Function("return "+ref.nodeValue.slice(subchar.length+1,-1))()}catch(err){}}return{replaceAll:function(subchar){subchar||(subchar="%");Ifm.Dom.Walker.walk(document.body,function(node){if(node.nodeType===1)for(var i=0;i<node.attributes.length;i++)parse(subchar,node.attributes[i]);else node.nodeType===3&&parse(subchar,node)})}}}();this.Walker={};this.Walker.walk=function walk(node,func){for(func(node),node=node.firstChild;node;)walk(node,func),node=node.nextSibling}}.call(Ifm.Dom);namespace("Ifm.PhoneBar.UI").Templates={CampaignListCard:'<div class="phonebar-campaignlist-card-content"><table class="phonebar-campaignlist-card-table"><tbody>{body}<\/tbody><\/table><\/div>',CampaignListRow:"<tr><td>{name}<\/td><td>{boundness}<\/td><td>{state}<\/td><\/tr>",IncomingCallCard:'<div class="phonebar-incoming-call-card-content"><div class="phonebar-incoming-call-text">{incomingCallText}<\/div><div class="phonebar-incoming-call-number">{incomingCallNumber}<\/div><div class="phonebar-incoming-call-campaign">{campaignName}<\/div><\/div>',LoginDialog:'<fieldset class="phonebar-form"><div><label class="phonebar-form-label" for="firstnametxt">{firstNameLabel}<\/label><input class="phonebar-form-input" type="text" id="firstnametxt" value="{firstName}"><\/div><div><label class="phonebar-form-label" for="lastnametxt">{lastNameLabel}<\/label><input class="phonebar-form-input" type="text" id="lastnametxt" value="{lastName}"><\/div><div><label class="phonebar-form-label" for="passwordtxt">{passwordLabel}<\/label><input class="phonebar-form-input" type="password" id="passwordtxt" value="{password}"><\/div><div><label class="phonebar-form-label" for="extensiontxt">{extensionLabel}<\/label><input class="phonebar-form-input small right-aligned" type="text" id="extensiontxt" value="{extension}"><\/div><\/fieldset>',Login2Dialog:'<fieldset class="phonebar-form"><div><label class="phonebar-form-label" for="firstnametxt">{firstNameLabel}<\/label><input class="phonebar-form-input" type="text" id="firstnametxt" value="{firstName}"><\/div><div><label class="phonebar-form-label" for="lastnametxt">{lastNameLabel}<\/label><input class="phonebar-form-input" type="text" id="lastnametxt" value="{lastName}"><\/div><div><label class="phonebar-form-label" for="oldPasswordtxt">{oldPasswordLabel}<\/label><input class="phonebar-form-input" type="password" id="oldPasswordtxt" value="{oldPassword}"><\/div><div><label class="phonebar-form-label" for="newPasswordtxt">{newPasswordLabel}<\/label><input class="phonebar-form-input" type="password" id="newPasswordtxt" value="{newPassword}"><\/div><div><label class="phonebar-form-label" for="confirmPasswordtxt">{confirmPasswordLabel}<\/label><input class="phonebar-form-input" type="password" id="confirmPasswordtxt" value="{confirmPassword}"><\/div><div><label class="phonebar-form-label" for="extensiontxt">{extensionLabel}<\/label><input class="phonebar-form-input small right-aligned" type="text" id="extensiontxt" value="{extension}"><\/div><\/fieldset>',LoginOAuth2Dialog:'<fieldset class="phonebar-form"><div><label class="phonebar-form-label" for="usernametxt">{usernameLabel}<\/label><input class="phonebar-form-input large" type="text" id="usernametxt" value="{username}"><\/div><div><label class="phonebar-form-label" for="extensiontxt">{extensionLabel}<\/label><input class="phonebar-form-input small right-aligned" type="text" id="extensiontxt" value="{extension}"><\/div><\/fieldset>',MessageCard:'<div class="phonebar-message-{severity}"><i class="material-icons">{icon}<\/i> <span class="phonebar-message-title">{title}<\/span><\/div><div class="phonebar-message-text">{message}<\/div>',QueueInfoCard:'<div class="phonebar-queueinfo-card-content"><div><b>{number}<\/b> {queuedNumberText}<\/div><div><b>{maxTime}<\/b> {queuedMaxTimeText}<\/div><div><b>{avgTime}<\/b> {queuedAvgTimeText}<\/div><\/div>',SupervisorMessageCard:'<div class="phonebar-supervisor-message-{severity}"><i class="material-icons">{icon}<\/i> <span class="phonebar-supervisor-message-title">{title}<\/span><\/div><div class="phonebar-supervisor-message-text">{message}<\/div>',TransferCallCard:'<div class="phonebar-transfercall-card-content"><select class="phonebar-transfer-campaign-list"><\/select><select class="phonebar-transfer-agent-list" size="10"><\/select><label><input type="checkbox" class="phonebar-transfer-mandatory-check" checked>{mandatoryLabel}<\/label><\/div>',TransferCallAgentListItem:'<option firstName="{0}" lastName="{1}" agentState="{2}">{0} {1} {2}<\/option>',TransferCallCampaignListItem:'<option campaignName="{0}">{1}<\/option>'};Ifm.PhoneBar.UI.Commands=function(){function bindElements(){jQuery(el.LoginButton).click(function(){commands.login()});jQuery(el.LoginOrReadyButton).click(function(){commands.loginOrReady()});jQuery(el.ReadyButton).click(function(){commands.ready()});jQuery(el.PauseButton).click(function(){commands.pause()});jQuery(el.LogoutButton).click(function(){commands.logout()});jQuery(el.AbortCallButton).click(function(){commands.abortCall()});jQuery(el.CallButton).click(function(){commands.showMakeCallPopup()});jQuery(el.TransferButton).click(function(){commands.showTransferForm()});jQuery(el.CampaignListButton).click(function(){Ifm.Dom.Photon.Cards.isShown("campaignlist-card")?Ifm.Dom.Photon.Cards.close("campaignlist-card"):commands.showAssignedCampaignList()});jQuery(el.QueueInfoButton).click(function(){Ifm.Dom.Photon.Cards.isShown("queueinfo-card")?Ifm.Dom.Photon.Cards.close("queueinfo-card"):commands.showQueueInfo()});jQuery(el.PanicButton).click(function(){commands.panic()});jQuery(el.MainMenuButton).click(function(){commands.showMenu()});jQuery(el.NumberInput).on("input",function(){const q=jQuery(el.NumberInput);q.data("s")&&(q.data("n")==="1"&&(q.val(q.attr("title")),q.attr("title","")),q.removeData(["n","s"]))}).on("keydown",function(e){if(e.which===13)return jQuery(el.CallButton).enabled()&&jQuery(el.CallButton).click(),!1;if(e.ctrlKey&&e.keyCode===8||e.which===27){const phone=Ifm.PhoneBar.instance.media.phone,Phone=Ifm.PhoneBar.Media.Phone;return phone&&Phone&&Phone.events.lineselected.raise(this,{lineId:phone.selectedLineId}),!1}}).click(function(){const q=jQuery(el.NumberInput);if(q.data("s")){const t=q.attr("title");q.attr("title",q.val());q.val(t);q.data("n",q.data("n")==="0"?"1":"0")}});jQuery(el.StartRecordingButton).click(function(){commands.startRecording()});jQuery(el.StopRecordingButton).click(function(){commands.stopRecording()});jQuery(el.MuteRecordingButton).click(function(){commands.muteRecording()});jQuery(el.UnmuteRecordingButton).click(function(){commands.unmuteRecording()});jQuery(el.PhoneDialPad).disable().hide();jQuery(el.HideDialPadButton).disable().hide().click(function(){commands.hideDialpad()});jQuery(el.ShowDialPadButton).click(function(){commands.showDialpad()});jQuery(el.ToggleDialPadButton).click(function(){commands.toggleDialpad()});jQuery(el.PickupButton).click(function(){commands.answer()});jQuery(el.HangupButton).click(function(){commands.drop()});jQuery(el.ManualTransferButton).click(function(){commands.dial("!,"+commands.getInputNumber())});jQuery(el.FlashButton).click(function(){commands.dial("!")});jQuery(el.Line1Button).click(function(){commands.selectLine(0)});jQuery(el.Line2Button).click(function(){commands.selectLine(1)});jQuery(el.EnterConferenceButton).click(function(){commands.enterConference()});jQuery(el.LeaveConferenceButton).click(function(){commands.leaveConference()});jQuery(el.MicrophoneOffButton).click(function(){commands.mute()});jQuery(el.MicrophoneOnButton).click(function(){commands.unmute()});jQuery(el.DialPadDigit0Button).click(function(){commands.dtmf("0")});jQuery(el.DialPadDigit1Button).click(function(){commands.dtmf("1")});jQuery(el.DialPadDigit2Button).click(function(){commands.dtmf("2")});jQuery(el.DialPadDigit3Button).click(function(){commands.dtmf("3")});jQuery(el.DialPadDigit4Button).click(function(){commands.dtmf("4")});jQuery(el.DialPadDigit5Button).click(function(){commands.dtmf("5")});jQuery(el.DialPadDigit6Button).click(function(){commands.dtmf("6")});jQuery(el.DialPadDigit7Button).click(function(){commands.dtmf("7")});jQuery(el.DialPadDigit8Button).click(function(){commands.dtmf("8")});jQuery(el.DialPadDigit9Button).click(function(){commands.dtmf("9")});jQuery(el.DialPadHashButton).click(function(){commands.dtmf("#")});jQuery(el.DialPadStarButton).click(function(){commands.dtmf("*")})}function bindEvents(){Ifm.PhoneBar.events.alerting=function(phonebar,e){var call=phonebar.calls(e.callId),mediatype=call.mediatype;if(phonebar.options.popupIncomingCalls()&mediatype===mediatype){const display=mediatype===Ifm.PhoneBar.Mediatypes.Voice?call.displayName||call.displayNumber:" ";showIncomingCallPopup(display,call.campaignName)}};Ifm.PhoneBar.events.callfailure=function(phonebar,e){var strings=Ifm.PhoneBar.Strings[phonebar.language()];Ifm.Dom.Photon.Cards.close("incoming-call-card");e.cause<255&&commands.showMessage(e.description,"warning",strings.CallFailure)};Ifm.PhoneBar.events.pausebooked=function(){jQuery(el.PauseButton).addClass("blink")};Ifm.PhoneBar.events.pause=function(){jQuery(el.PauseButton).removeClass("blink")};Ifm.PhoneBar.events.statechanged=function(phonebar,e){var s=Ifm.PhoneBar.States;(e.previousState===s.Alerting||e.previousState===s.OtherCall)&&setTimeout(function(){Ifm.Dom.Photon.Cards.close("incoming-call-card")},3e3)};Ifm.PhoneBar.events.supervisormessage=function(phonebar,e){var strings=Ifm.PhoneBar.Strings[phonebar.language()],html=t.SupervisorMessageCard.replace("{severity}",["information","warning","critical"][e.severity]).replace("{icon}",["info","warning","error"][e.severity]).replace("{message}",e.message).replace("{title}",strings.SupervisorTitle);Ifm.Dom.Photon.Cards.show(html,undefined,!1,!1,0,strings.SupervisorTitle,{width:500,height:250,showInTaskbar:!0})};Ifm.PhoneBar.Media.Xmpp.events.newmessage=function(phonebar,e){var call=phonebar.calls(e.callId);call&&call.mediatype===Ifm.PhoneBar.Mediatypes.StoreAndForward&&(call.handled||phonebar.media.xmpp.handled(e.callId))}}function doOAuth2Login(dialog,dialogBody){const strings=Ifm.PhoneBar.Strings[phonebar.language()];return new Promise(function(resolve,reject){try{if(phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn){resolve();return}const usernametxt=dialogBody.querySelector("#usernametxt"),extensiontxt=dialogBody.querySelector("#extensiontxt");phonebar.agent.username=usernametxt.value;phonebar.agent.extension=extensiontxt.value;phonebar.agent.save();dialog.close();phonebar.getToken(function(token){phonebar.loginWithToken(token,extensiontxt.value,phonebar.agent.username,function(e){if(e.accepted)resolve();else{var cause;switch(e.failureCause){case 3:cause=strings.WrongCredentials;break;case 7:cause=strings.InvalidExtension;break;case 8:cause=strings.ExtensionInUse;break;case 9:case 10:cause=strings.TokenBasedLoginError;break;default:cause="Login error "+e.failureCause}commands.showMessage(cause,"warning");resolve(!1)}})})}catch(err){reject(err)}})}function doPhonesLogin(dialog,dialogBody){const strings=Ifm.PhoneBar.Strings[phonebar.language()];return new Promise(function(resolve,reject){try{if(phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn){resolve();return}const firstnametxt=dialogBody.querySelector("#firstnametxt"),lastnametxt=dialogBody.querySelector("#lastnametxt"),passwordtxt=dialogBody.querySelector("#passwordtxt"),extensiontxt=dialogBody.querySelector("#extensiontxt");phonebar.login(firstnametxt.value,lastnametxt.value,passwordtxt.value,extensiontxt.value,function(e){if(e.accepted)resolve();else if(e.failureCause===1)commands.showMessage(strings.AccountLockedOut,"error"),resolve(!1);else if(e.failureCause===2)dialog.close(),commands.showMessage(strings.PasswordExpired,"warning"),resolve(),commands.loginChangePassword();else{dialog.shake();var cause;switch(e.failureCause){case 0:cause=strings.UserOrExtensionTaken;break;case 3:cause=strings.WrongCredentials;break;case 7:cause=strings.InvalidExtension;break;case 8:cause=strings.ExtensionInUse;break;default:cause="Login error "+e.failureCause}commands.showMessage(cause,"warning");resolve(!1)}})}catch(err){reject(err)}})}function getAudioCall(){return phonebar.calls(function(call){return call.mediatype===Ifm.PhoneBar.Mediatypes.Voice})[0]||null}function getNotificationStyle(severity){switch(severity){case"information":case"warning":case"error":return severity[0].toUpperCase()+severity.substring(1);default:return"Notification"}}function getTransferAgents(dialogBody){var campaignList,campaignName;const strings=Ifm.PhoneBar.Strings[phonebar.language()];campaignList=dialogBody.querySelector(el.TransferCampaignList);campaignList&&campaignList.selectedIndex>=0&&(campaignName=campaignList[campaignList.selectedIndex].getAttribute("campaignName"),phonebar.getTransferAgentList(campaignName,function(e){for(var opts=t.TransferCallAgentListItem.format(strings.TransferAnybody),i=0,a;i<e.agents.length,a=e.agents[i];i++)opts+=t.TransferCallAgentListItem.format(a.firstName,a.lastName,a.state!==2?"("+strings.GenericBusyState+")":"");dialogBody.querySelector(el.TransferAgentList).innerHTML=opts}))}function showIncomingCallPopup(callingNumber,campaignName){const strings=Ifm.PhoneBar.Strings[phonebar.language()];var html=t.IncomingCallCard.replace("{incomingCallText}",strings.IncomingCallText).replace("{incomingCallNumber}",callingNumber||strings.UnknownCallingNumber).replace("{campaignName}",campaignName||"");Ifm.Dom.Photon.Cards.show(html,"incoming-call-card",!1,!1,0,strings.IncomingCallText,{width:600,height:207})}function transferCall(callId,dialogBody,callback){var call,campaignList,campaignName;const strings=Ifm.PhoneBar.Strings[phonebar.language()];if(call=callId?phonebar.calls(callId):getAudioCall(),call&&call.callId){campaignList=dialogBody.querySelector(el.TransferCampaignList);campaignName="";campaignList&&campaignList.selectedIndex>=0&&(campaignName=campaignList[campaignList.selectedIndex].getAttribute("campaignName"));var agentList=dialogBody.querySelector(el.TransferAgentList),firstName="",lastName="",mandatory=!1;agentList&&agentList.selectedIndex>0&&(firstName=agentList[agentList.selectedIndex].getAttribute("firstName"),lastName=agentList[agentList.selectedIndex].getAttribute("lastName"),mandatory=dialogBody.querySelector(el.TransferMandatoryCheck).checked);phonebar.transferCall(call.callId,campaignName,firstName,lastName,mandatory,undefined,callback)}}const phonebar=Ifm.PhoneBar.instance,commands={};commands.login=function(){var html;const strings=Ifm.PhoneBar.Strings[phonebar.language()];if(phonebar.currentState()===Ifm.PhoneBar.States.NotLoggedIn){if(phonebar.getPhoneBarConfiguration().useProvisioning){commands.provisioningAndLogin();return}phonebar.isOAuth2Enabled()?(html=t.LoginOAuth2Dialog.replace("{usernameLabel}",strings.LoginUsername).replace("{username}",phonebar.agent.username).replace("{extensionLabel}",strings.LoginExtension).replace("{extension}",phonebar.agent.extension),Ifm.Dom.Photon.Cards.showDialog(html,"login-dialog",strings.LoginOAuth2Title,[{text:strings.ButtonOK,click:doOAuth2Login},{text:strings.ButtonCancel}],{width:600,height:248})):(html=t.LoginDialog.replace("{firstNameLabel}",strings.LoginFirstName).replace("{lastNameLabel}",strings.LoginLastName).replace("{passwordLabel}",strings.LoginPassword).replace("{extensionLabel}",strings.LoginExtension).replace("{firstName}",phonebar.agent.firstName).replace("{lastName}",phonebar.agent.lastName).replace("{password}",phonebar.agent.password).replace("{extension}",phonebar.agent.extension),Ifm.Dom.Photon.Cards.showDialog(html,"login-dialog",strings.LoginTitle,[{text:strings.ButtonChangePassword,cssText:"margin-right:50px;",click:function(){commands.loginChangePassword()}},{text:strings.ButtonOK,click:doPhonesLogin},{text:strings.ButtonCancel}],{width:600,height:324}))}};commands.loginChangePassword=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];var html=t.Login2Dialog.replace("{firstNameLabel}",strings.LoginFirstName).replace("{lastNameLabel}",strings.LoginLastName).replace("{oldPasswordLabel}",strings.LoginOldPassword).replace("{newPasswordLabel}",strings.LoginNewPassword).replace("{confirmPasswordLabel}",strings.LoginConfirmPassword).replace("{extensionLabel}",strings.LoginExtension).replace("{firstName}",phonebar.agent.firstName).replace("{lastName}",phonebar.agent.lastName).replace("{oldPassword}","").replace("{newPassword}","").replace("{confirmPassword}","").replace("{extension}",phonebar.agent.extension);Ifm.Dom.Photon.Cards.showDialog(html,"login2-dialog",strings.LoginTitle,[{text:strings.ButtonOK,click:function(dialog,dialogBody){if(phonebar.currentState()===Ifm.PhoneBar.States.NotLoggedIn){const firstnametxt=dialogBody.querySelector("#firstnametxt"),lastnametxt=dialogBody.querySelector("#lastnametxt"),oldPasswordtxt=dialogBody.querySelector("#oldPasswordtxt"),newPasswordtxt=dialogBody.querySelector("#newPasswordtxt"),confirmPasswordtxt=dialogBody.querySelector("#confirmPasswordtxt"),extensiontxt=dialogBody.querySelector("#extensiontxt");return newPasswordtxt.value!==confirmPasswordtxt.value?(confirmPasswordtxt.focus(),commands.showMessage(strings.PasswordsDontMatch),!1):(phonebar.loginEx(firstnametxt.value,lastnametxt.value,oldPasswordtxt.value,newPasswordtxt.value,extensiontxt.value,function(e){if(e.accepted)dialog.close();else if(e.failureCause===1)dialog.close(),commands.showMessage(strings.AccountLockedOut,"error");else if(e.failureCause===4)newPasswordtxt.value=confirmPasswordtxt.value="",commands.showMessage(strings.InvalidNewPassword,"warning");else if(e.failureCause===5)dialog.close(),commands.login(),commands.showMessage(strings.CantChangePassword,"information");else{dialog.shake();var cause=e.failureCause===3?strings.WrongCredentials:strings.UserOrExtensionTaken;commands.showMessage(cause,"warning")}}),!1)}}},{text:strings.ButtonCancel}],{width:600,height:440})};commands.loginOrReady=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];phonebar.isLoggedIn()?commands.ready():commands.login()};commands.logout=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];phonebar.logout()};commands.pause=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];phonebar.getPauseReasons(function(e){var choices,i;if(e.reasons.length===0)phonebar.pause();else{for(e.reasons.unshift({text:strings.PauseGenericReason,value:0}),choices=[],i=0;i<e.reasons.length;i++)choices.push({label:e.reasons[i].text,value:e.reasons[i].id});Ifm.Dom.Photon.Menu.choose(choices,function(id){phonebar.pause(id)})}})};commands.ready=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];var activeCall=getAudioCall();activeCall&&activeCall.postcall?phonebar.ready(activeCall.callId):phonebar.ready()};commands.panic=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];phonebar.panic();var toolbars=el.MainToolbar+", "+el.PhoneToolbar;jQuery(toolbars).addClass("phonebar-panic-effect");setTimeout(function(){jQuery(toolbars).removeClass("phonebar-panic-effect")},2e3)};commands.showAssignedCampaignList=function(update){const strings=Ifm.PhoneBar.Strings[phonebar.language()];(!update||Ifm.Dom.Photon.Cards.isShown("campaignlist-card"))&&phonebar.getAssignedCampaignList(function(e){for(var html,card,rows="",i=0;i<e.campaigns.length;i++)rows+=t.CampaignListRow.replace("{name}",e.campaigns[i].name).replace("{boundness}",e.campaigns[i].boundness).replace("{state}",e.campaigns[i].active?"":"Stop");html=t.CampaignListCard.replace("{body}",rows);card=Ifm.Dom.Photon.Cards.show(html,"campaignlist-card",!0,!1,0,strings.AssignmentsTitle);setTimeout(commands.showAssignedCampaignList,5e3,!0);Ifm.Photon.app.isHosted||(card.onclick=function(){card.close()})})};commands.hideDialpad=function(){jQuery(el.PhoneDialPad+", "+el.HideDialPadButton).disable().hide();jQuery(el.ShowDialPadButton).enable().show()};commands.showDialpad=function(){jQuery(el.PhoneDialPad+", "+el.HideDialPadButton).enable().show();jQuery(el.ShowDialPadButton).disable().hide()};commands.toggleDialpad=function(){console.debug("Not implemented: commands.toggleDialpad()")};commands.showQueueInfo=function(update){const strings=Ifm.PhoneBar.Strings[phonebar.language()];(!update||Ifm.Dom.Photon.Cards.isShown("queueinfo-card"))&&phonebar.getQueueInfo("",function(e){var html=t.QueueInfoCard.replace("{number}",e.calls).replace("{queuedNumberText}",strings.queuedNumberText).replace("{maxTime}",e.maxTime||"--").replace("{queuedMaxTimeText}",strings.queuedMaxTimeText).replace("{avgTime}",e.avgTime||"--").replace("{queuedAvgTimeText}",strings.queuedAvgTimeText),card=Ifm.Dom.Photon.Cards.show(html,"queueinfo-card",!0,!1,0,strings.QueueInfoTitle,{left:screen.availWidth-180,top:100,width:130,height:100,toolWindow:!0});card.className+=" phonebar-queueinfo-card";setTimeout(commands.showQueueInfo,5e3,!0);Ifm.Photon.app.isHosted||(card.onclick=function(){card.close()})})};commands.abortCall=function(){phonebar.currentState()===Ifm.PhoneBar.States.WaitingOutbound&&phonebar.abortCall()};commands.getInputNumber=function(){const q=jQuery(el.NumberInput);return q.data("s")?q.data("n")==="0"?q.val():q.attr("title"):q.val()};commands.showMakeCallPopup=function(){const strings=Ifm.PhoneBar.Strings[phonebar.language()];if(commands.getInputNumber()){if(phonebar.media.phone&&phonebar.media.phone.selectedLineId>0){phonebar.media.phone.dial(commands.getInputNumber());return}phonebar.getOutboundCampaignList(function(e){var choices,i;if(phonebar.media.phone&&e.campaigns.push({name:strings.OutboundManualCall}),e.campaigns.length>0){for(choices=[],i=0;i<e.campaigns.length;i++)choices.push({label:e.campaigns[i].serviceName||e.campaigns[i].name,value:e.campaigns[i].name});Ifm.Dom.Photon.Menu.choose(choices,function(campaign){campaign!==null&&(campaign===strings.OutboundManualCall?phonebar.media.phone.dial(commands.getInputNumber()):phonebar.makeCall(commands.getInputNumber(),campaign,phonebar.options.callingNumber()||phonebar.agent.extension))})}})}};commands.showTransferForm=function(callId){var call,campaignName,html;const strings=Ifm.PhoneBar.Strings[phonebar.language()];campaignName="";callId?call=phonebar.calls(callId):(call=getAudioCall(),callId=call.callId);call?campaignName=call.campaignName:callId=0;html=t.TransferCallCard.replace("{mandatoryLabel}",strings.TransferMandatory);Ifm.Dom.Photon.Cards.showDialog(html,"transfercall-card",strings.TransferTitle,[{text:strings.ButtonRefresh,click:function(dialog,dialogBody){return getTransferAgents(dialogBody),!1}},{text:strings.ButtonTransfer,click:function(dialog,dialogBody){return transferCall(callId,dialogBody,function(e){e.accepted&&dialog.close()}),!1}},{text:strings.ButtonCancel}],{width:750,height:474},function(dialog,dialogBody){dialogBody.querySelector(".phonebar-transfer-campaign-list").addEventListener("input",function(){getTransferAgents(dialogBody)});phonebar.getTransferCampaignList(callId,function(e){for(var list=dialogBody.querySelector(el.TransferCampaignList),lastValue=list.value,opts1="",opts2="",servs=[],i=0,c=null;i<e.campaigns.length,c=e.campaigns[i];i++)campaignName.startsWith(c.serviceName+"/")?opts1+=t.TransferCallCampaignListItem.format(c.name,c.campaignName):servs[c.serviceName]||(opts2+=t.TransferCallCampaignListItem.format(c.name,c.serviceName),servs[c.serviceName]=!0);opts1&&(opts1='<optgroup label="'+strings.TransferCampaign+'">'+opts1+"<\/optgroup>");opts2&&(opts2='<optgroup label="'+strings.TransferService+'">'+opts2+"<\/optgroup>");list.innerHTML=opts1+opts2;lastValue&&(list.value=lastValue);getTransferAgents(dialogBody)})})};commands.startRecording=function(){const activeCall=getAudioCall();activeCall&&!activeCall.isRecording&&phonebar.startRecording(activeCall.callId)};commands.stopRecording=function(){const activeCall=getAudioCall();activeCall&&activeCall.isRecording&&phonebar.stopRecording(activeCall.callId)};commands.muteRecording=function(){const activeCall=getAudioCall();activeCall&&activeCall.isRecording&&phonebar.muteRecording(activeCall.callId,!0,!0)};commands.unmuteRecording=function(){const activeCall=getAudioCall();activeCall&&activeCall.isRecording&&phonebar.muteRecording(activeCall.callId,!1,!1)};commands.showMessage=function(content,severity,heading,hideAfter=false){const style=getNotificationStyle(severity);if(Ifm.Photon.app.isHosted)Ifm.Photon.app.host.showNotification({content,heading,style,hideAfter,position:"TopCenter"});else if(jQuery.toast)jQuery.toast({text:content,icon:severity,heading:heading,allowToastClose:!0,hideAfter,position:"top-center",loader:!1});else{var band=Ifm.Dom.Band.show(),html='<div class="phonebar-message" style="line-height:'+band.clientHeight+'px;">'+content+"<\/div>";band.innerHTML=html}};commands.answer=function(){var phone=Ifm.PhoneBar.instance.media.phone;phone.answer()};commands.dial=function(opt_number){var phone=Ifm.PhoneBar.instance.media.phone,number=opt_number!==undefined&&opt_number!==null?opt_number:commands.getInputNumber();phone.dial(number)};commands.dtmf=function(tones){var phone=Ifm.PhoneBar.instance.media.phone;phone.dtmf(tones)};commands.enterConference=function(){var phone=Ifm.PhoneBar.instance.media.phone;phone.enterConference()};commands.leaveConference=function(){var phone=Ifm.PhoneBar.instance.media.phone;phone.leaveConference()};commands.drop=function(){var phone=Ifm.PhoneBar.instance.media.phone;phone.drop()};commands.mute=function(){var phone=Ifm.PhoneBar.instance.media.phone;phone.mute()};commands.selectLine=function(lineId){var phone=Ifm.PhoneBar.instance.media.phone;phone.selectLine(lineId)};commands.unmute=function(){var phone=Ifm.PhoneBar.instance.media.phone;phone.unmute()};Ifm.PhoneBar.events.initialized=function(phonebar,e){(_uiInitialized||(bindElements(),bindEvents(),_uiInitialized=!0),e.options)&&phonebar.options.loginOnStart()&&setTimeout(function(){if(!phonebar.isRedirectedAfterOAuth2Signin())if(phonebar.isRedirectedAfterOAuth2Signout())commands.login();else if(phonebar.options.loginOnStart()===2){var a=phonebar.agent;phonebar.isOAuth2Enabled()&&a.extension?phonebar.getToken(function(token){phonebar.loginWithToken(token,a.extension,a.username,function(e){e.accepted||commands.login()})}):phonebar.options.rememberCredentials()===2&&a.firstName&&a.lastName&&a.extension?phonebar.login(a.firstName,a.lastName,a.password,a.extension,function(e){e.accepted||commands.login()}):commands.login()}else commands.login()})};var el=Ifm.PhoneBar.UI.Elements,t=Ifm.PhoneBar.UI.Templates,_uiInitialized=!1;return commands}();