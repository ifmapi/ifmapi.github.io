
//============================================================================

// Copyright (c) Base Digitale Platform. All rights reserved.

//============================================================================

"use strict";
function __errhandler(a, b, c, d, e) {
  if (!arguments || !arguments.length) {
    return
  }
  var message = e && e.message ? e.message : (a || "Script error");
  var source = b || (e ? e.filename : '') || '';
  var line = c || (e ? e.lineno : '') || '';
  var column = d || (e ? e.colno : '') || '';
  var stack = e && e.stack ? e.stack : (source ? [source, line, column].join(' ') : "window.onerror");
  Ifm.Application.onerror(message, stack)
}
namespace("Ifm");
(function() {
  Ifm.version += "; Ifm.Dom.js/1.1.3-5545";
  this.Application = {frameworkPath: ''};
  var scripts = document.getElementsByTagName("script");
  for (var i = 0; i < scripts.length; i++) {
    var matches = scripts[i].src.match(/(.*)Ifm\.Dom\.js/);
    if (matches && matches.length === 2) {
      Ifm.Application.frameworkPath = matches[1];
      break
    }
  }
  var readyNotified = false;
  var readyDelegates = [];
  var readyCompleted = function() {
      if (readyNotified)
        return;
      if (document.addEventListener || event.type === "load" || document.readyState === "complete") {
        Ifm.Dom.Strings.replaceAll('%');
        readyNotified = true;
        var len = readyDelegates.length;
        while (len--) {
          readyDelegates[len]()
        }
        readyDelegates = []
      }
    };
  if (document.addEventListener) {
    document.addEventListener("DOMContentLoaded", readyCompleted, false);
    window.addEventListener("load", readyCompleted, false)
  }
  else {
    document.attachEvent("onreadystatechange", readyCompleted);
    window.attachEvent("onload", readyCompleted)
  }
  this.Application.abort = function(error, stack) {
    var ehome = encodeURIComponent(window.location.href);
    var eerror = encodeURIComponent(error || '');
    var estack = encodeURIComponent(stack || '');
    var s = sessionStorage;
    var p = '';
    if (s) {
      s.setItem("home", ehome);
      s.setItem("error", eerror);
      s.setItem("stack", estack);
      s.setItem("info", Ifm.version)
    }
    else {
      p = "?home=" + ehome + "&error=" + eerror + "&stack=" + estack + "&info=" + Ifm.version
    }
    window.onerror = null;
    window.onbeforeunload = null;
    window.location.assign(this.frameworkPath + "blue.htm" + p)
  };
  this.Application.parameters = function() {
    var p = {};
    p.count = 0;
    (window.location.search + window.location.hash).replace(/([^?&=]+)=([^&]*)?/g, function(match, key, val) {
      if (key) {
        p[key] = val || '';
        p.count++
      }
    });
    return p
  };
  this.Application.showBand = function(message, additional) {
    var html = "<div style='margin:16px;'>" + "<pre style='font-size:xx-large;'>" + (message || '') + "</pre>" + "<pre style='font-size:medium;'>" + (additional || '') + "</pre>" + "</div>";
    Ifm.Dom.Band.show(html)
  };
  this.Application.ready = function(onready) {
    if (!Ifm.Type.isFunction(onready)) {
      throw new Error("Application.ready() -> Invalid ready handler function");
    }
    if (readyNotified) {
      setTimeout(onready);
      return
    }
    readyDelegates.push(onready)
  };
  this.Application.quit = function(onquit, oncancel) {
    if (onquit && !Ifm.Type.isFunction(onquit)) {
      throw new Error("Application.quit() -> Invalid quit handler function");
    }
    if (oncancel && !Ifm.Type.isFunction(oncancel)) {
      throw new Error("Application.quit() -> Invalid cancel handler function");
    }
    window.onbeforeunload = function() {
      var userchoice = false;
      setTimeout(function() {
        setTimeout(function() {
          if (userchoice && oncancel)
            oncancel()
        }, 100)
      });
      return userchoice = onquit()
    }
  };
  this.Application.onerror = function __onerror(error, stack) {
    if (Ifm.Diagnostics.Debug.enabled) {
      Ifm.Diagnostics.Debug.fail(error, stack)
    }
    else {
      debugger;
      Ifm.Application.abort(error, stack)
    }
  }
}).call(Ifm);
namespace("Ifm.Dom");
(function() {
  this.isReady = function(document) {
    if (Ifm.Dom.isWindow(document)) {
      document = document.document
    }
    return isDocumentReady(document)
  };
  this.isWindow = function(obj) {
    return obj.constructor.name === 'Window'
  };
  this.whenReady = function(document, callback) {
    if (Ifm.Dom.isWindow(document)) {
      document = document.document
    }
    if (isDocumentReady(document)) {
      callback(document)
    }
    else {
      var onReadyStateChange = function() {
          if (isDocumentReady(document)) {
            document.removeEventListener('readystatechange', onReadyStateChange);
            callback(document)
          }
        };
      document.addEventListener('readystatechange', onReadyStateChange)
    }
  };
  this.whenWindowNavigates = function(window, url, callback) {
    var attempt = 0;
    var navigationtimer = setInterval(function() {
        if (window.location.href.toLowerCase().indexOf(url.toLowerCase()) < 0 || !isDocumentReady(window.document)) {
          return
        }
        if (++attempt < 5)
          return;
        clearInterval(navigationtimer);
        Ifm.Dom.whenReady(window, callback)
      }, 100)
  };
  function isDocumentReady(document) {
    if (!document || !document.URL || document.URL === 'about:blank' || document.URL === 'edge://newtab/' || document.URL === 'chrome://newtab/') {
      return false
    }
    var state = document.readyState;
    return state === 'interactive' || state === 'complete'
  }
  this.Events = {
    addHandler: (window.addEventListener ? function(element, type, handler) {
      element.addEventListener(type, handler, false)
    } : function(element, type, handler) {
      element.attachEvent("on" + type, handler)
    }), getEvent: function(e) {
        return e || window.event
      }, getTarget: function(e) {
        var event = e || window.event;
        return event.target || event.srcElement
      }, preventDefault: function(e) {
        var event = e || window.event;
        if (event.preventDefault) {
          event.preventDefault()
        }
        else {
          event.returnValue = false
        }
      }, removeHandler: (window.removeEventListener ? function(element, type, handler) {
        element.removeEventListener(type, handler, false)
      } : function(element, type, handler) {
        element.detachEvent("on" + type, handler)
      }), stopPropagation: function(e) {
        var event = e || window.event;
        if (event.stopPropagation) {
          event.stopPropagation()
        }
        else {
          event.cancelBubble = true
        }
      }, stop: function(e) {
        var event = e || window.event;
        if (event.preventDefault) {
          event.preventDefault()
        }
        if (event.stopImmediatePropagation) {
          event.stopImmediatePropagation()
        }
        if (event.stopPropagation) {
          event.stopPropagation()
        }
        if (event.stop) {
          event.stop()
        }
        event.cancelBubble = true;
        event.returnValue = false
      }
  };
  this.Dialogs = {_dialogs: []};
  this.Dialogs.create = function(id, buttons, opts) {
    if (!id || !Ifm.Type.isString(id)) {
      throw new Error("Dialogs.create() -> Invalid dialog object id: " + id);
    }
    if (Ifm.Dom.Dialogs._dialogs[id]) {
      throw new Error("Dialogs.create() -> Dialog already created:" + id);
    }
    var dialog = document.getElementById(id);
    if (!dialog) {
      throw new Error("Dialogs.create() -> Dialog definition object not found in DOM: " + id);
    }
    dialog.parentNode.removeChild(dialog);
    if (buttons && !Ifm.Type.isArray(buttons)) {
      throw new Error("Dialogs.create() -> Invalid buttons array:" + buttons);
    }
    Ifm.Dom.Dialogs._dialogs[id] = {
      instance: dialog, buttons: buttons || null, options: {
          modal: (opts || {}).hasOwnProperty("modal") ? opts.modal : true, title: (opts || {}).hasOwnProperty("title") ? opts.title : ""
        }, arguments: null, result: undefined
    }
  };
  this.Dialogs.show = function(id, title, beforeShow, onHide) {
    if (!id || !Ifm.Type.isString(id)) {
      throw new Error("Dialogs.show() -> Invalid dialog object id: " + id);
    }
    var ref = Ifm.Dom.Dialogs._dialogs[id];
    if (!ref) {
      throw new Error("Dialogs.show() -> Dialog not created: " + id);
    }
    if (beforeShow && (!Ifm.Type.isFunction(beforeShow))) {
      throw new Error("Dialogs.show() -> Invalid handler: beforeShow");
    }
    if (onHide && (!Ifm.Type.isFunction(onHide))) {
      throw new Error("Dialogs.show() -> Invalid handler: onHide");
    }
    if (!ref.shown) {
      ref.shown = true;
      ref.onhide = onHide || null;
      var dialog = ref.instance.cloneNode(true);
      var buttons = ref.buttons;
      if (ref.options.modal) {
        Ifm.Dom.Fader.show()
      }
      var dialogContainer = document.createElement("div");
      dialogContainer.className = "dialog";
      dialogContainer.style.zIndex = "1100";
      dialogContainer.innerHTML = '' + '<div class="dialog-title">' + (title || ref.options.title || '') + '</div>' + '<div class="dialog-body"></div>' + '<div class="dialog-buttons"></div>';
      if (!buttons || buttons.length === 0) {
        dialogContainer.innerHTML += '<div class="dialog-close"><button class="dialog-close-button" onclick="Ifm.Dom.Dialogs.hide(&apos;' + id + '&apos;, 0);">r</button></div>'
      }
      document.body.appendChild(dialogContainer);
      ref.container = dialogContainer;
      dialogContainer.children[1].appendChild(dialog);
      if (buttons) {
        for (var i = 0; i < buttons.length; i++) {
          var button = document.createElement("button");
          var code = "Ifm.Dom.Dialogs._dialogs['" + id + "'].result = (function() { " + buttons[i].click + " })(); Ifm.Dom.Dialogs.hide('" + id + "', " + (i + 1) + ");";
          button.onclick = new Function(code);
          button.innerHTML = buttons[i].text;
          button.style.cssText = buttons[i].cssText;
          dialogContainer.children[2].appendChild(button)
        }
      }
      if (beforeShow) {
        beforeShow()
      }
      Ifm.Dom.Strings.replaceAll('%%')
    }
  };
  this.Dialogs.hide = function(id, buttonindex) {
    if (!id || !Ifm.Type.isString(id)) {
      throw new Error("Dialogs.hide() -> Invalid dialog object id: " + id);
    }
    var ref = Ifm.Dom.Dialogs._dialogs[id];
    if (!ref) {
      throw new Error("Dialogs.hide() -> Dialog not created: " + id);
    }
    if (ref.shown) {
      if (ref.onhide) {
        ref.onhide(buttonindex)
      }
      ref.shown = false;
      var dialogContainer = ref.container;
      dialogContainer.style.opacity = "0";
      setTimeout(function() {
        document.body.removeChild(dialogContainer)
      }, 200);
      if (ref.options.modal) {
        Ifm.Dom.Fader.hide()
      }
    }
  };
  this.Cards = (function() {
    var cards = {};
    return {
        show: function(html, id, dialog, fade, level, title, options = {}, onload) {
          if (!id)
            id = "card" + (+new Date).toString(16);
          var card;
          if (cards[id]) {
            card = cards[id].element
          }
          else {
            card = document.createElement("div");
            cards[id] = {
              element: card, fade: !!fade
            };
            card.close = Ifm.Dom.Cards.close.bind(null, id);
            card.shake = Ifm.Dom.Cards.shake.bind(null, id);
            card.onclosed = null;
            if (fade)
              Ifm.Dom.Fader.show();
            card.style.zIndex = "1100";
            document.body.appendChild(card);
            card.className = "dialog level-" + (level && /^[12345]$/.test(level) ? level : "1");
            if (!dialog)
              setTimeout(() =>  {
                  var fader = document.getElementById("ifmjs_sys_fader") || document;
                  var oldfunc = fader.onclick;
                  fader.onclick = function(e) {
                    fader.onclick = oldfunc;
                    Ifm.Dom.Events.stop(e);
                    Ifm.Dom.Cards.close(id)
                  };
                  card.onclick = fader.onclick
                }, 20)
          }
          if (html)
            card.innerHTML = html;
          if (options.width) {
            card.style.width = options.width + 'px';
            card.style.maxWidth = 'none'
          }
          if (options.height) {
            card.style.height = options.height + 'px';
            card.style.maxHeight = 'none'
          }
          if (Ifm.Type.isFunction(onload)) {
            onload(card, card)
          }
          return card
        }, showDialog: function(html, id, title, buttons, options = {}, onload) {
            const htmlDialog = Ifm.Dom.Cards._createDialogBody(html, title);
            const fade = !(options && (options.modal === false || options.modal === 0));
            const dialog = Ifm.Dom.Cards.show(htmlDialog, id, true, fade, 0, null, options);
            Ifm.Dom.Cards._createDialogButtons(dialog, dialog, buttons);
            if (Ifm.Type.isFunction(onload)) {
              onload(dialog, dialog)
            }
          }, shake: function(id) {
            if (!cards[id])
              return;
            var card = cards[id].element,
              styleLeft = card.style.left,
              styleRight = card.style.right,
              curLeft = card.offsetLeft;
            var f = function(i) {
                var shakeX = 10 * ((i % 3) - 1);
                card.style.left = curLeft + shakeX + "px";
                card.style.right = curLeft - shakeX + "px";
                if (--i > 0) {
                  setTimeout(f, 20, i)
                }
                else {
                  card.style.left = styleLeft;
                  card.style.right = styleRight
                }
              };
            f(16)
          }, close: function(id) {
            if (!cards[id])
              return;
            var card = cards[id].element;
            document.body.removeChild(card);
            if (cards[id].fade)
              Ifm.Dom.Fader.hide();
            if (Ifm.Type.isFunction(card.onclosed))
              card.onclosed(card);
            delete cards[id];
            return card
          }, get: function(id) {
            return cards[id] || null
          }, getBody: function(id) {
            return cards[id] || null
          }, isShown: function(id) {
            return cards[id] ? true : false
          }, _createDialogBody: function(html, title) {
            var htmlDialog = `
                    <div class="dialog-title">${title || ''}</div>
                    <div class="dialog-body">${html || ''}</div>
                    <div class="dialog-buttons"></div>
                `;
            return htmlDialog
          }, _createDialogButtons: function(dialog, dialogBody, buttons) {
            if (dialogBody && buttons && buttons.length) {
              const buttonContainer = dialogBody.lastElementChild;
              for (var i = 0; i < buttons.length; i++) {
                var btn = document.createElement("button");
                btn.innerHTML = buttons[i].text || "[Button" + (i + 1) + "]";
                btn.style.cssText = buttons[i].cssText;
                btn.onclick = (function(fn) {
                  if (Ifm.Type.isFunction(fn)) {
                    return function() {
                        buttonContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
                        var result = false;
                        try {
                          result = fn(dialog, dialogBody);
                          if (result instanceof Promise) {
                            result.then(function(resolved) {
                              if (resolved !== false) {
                                dialog.close()
                              }
                            });
                            result.catch(function(err) {
                              console.warn('[Ifm.Dom.Cards] Error executing async button action', err);
                              err && err.message && alert(err.message);
                              dialog.shake()
                            });
                            result.finally(function() {
                              buttonContainer.querySelectorAll('button').forEach(btn => btn.disabled = false)
                            });
                            return false
                          }
                        }
                        catch(err) {
                          console.warn('[Ifm.Dom.Cards] Error executing button action', err);
                          err && err.message && alert(err.message);
                          dialog.shake()
                        }
                        buttonContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        if (result !== false) {
                          dialog.close()
                        }
                      }
                  }
                  else {
                    return function() {
                        dialog.close()
                      }
                  }
                })(buttons[i].click);
                buttonContainer.appendChild(btn)
              }
            }
          }
      }
  })();
  this.Band = {_bands: []};
  this.Band.show = function(html) {
    Ifm.Dom.Fader.show();
    var band = document.createElement("div");
    band.className = "band";
    band.style.position = "absolute";
    band.style.top = "50%";
    band.style.marginTop = "-80px";
    band.style.minHeight = "160px";
    band.style.left = "0px";
    band.style.width = "100%";
    band.style.backgroundColor = "#0066CC";
    band.style.color = "white";
    band.style.overflow = "hidden";
    band.style.zIndex = "1200";
    var fader = document.getElementById("ifmjs_sys_fader") || document;
    var oldfunc = fader.onclick;
    fader.onclick = function(e) {
      fader.onclick = oldfunc;
      Ifm.Dom.Events.stop(e);
      Ifm.Dom.Band.hide()
    };
    band.onclick = fader.onclick;
    band.innerHTML = html;
    document.body.appendChild(band);
    Ifm.Dom.Band._bands.push(band);
    if (Ifm.Dom.Band._bands.length > 1) {
      Ifm.Dom.Band._bands[Ifm.Dom.Band._bands.length - 2].style.display = "none"
    }
    return band
  };
  this.Band.hide = function() {
    if (Ifm.Dom.Band._bands.length > 0) {
      var band = Ifm.Dom.Band._bands.pop(band);
      document.body.removeChild(band);
      Ifm.Dom.Fader.hide()
    }
    if (Ifm.Dom.Band._bands.length > 0) {
      Ifm.Dom.Band._bands[Ifm.Dom.Band._bands.length - 1].style.display = ''
    }
    return band
  };
  this.Fader = {_faders: 0};
  this.Fader.show = function() {
    Ifm.Dom.Fader._faders++;
    if (Ifm.Dom.Fader._faders === 1) {
      var fader = document.getElementById("ifmjs_sys_fader");
      if (!fader) {
        fader = document.createElement("div");
        fader.id = "ifmjs_sys_fader";
        fader.style.backgroundColor = "#003366";
        fader.style.opacity = "0.50";
        fader.style.position = "absolute";
        fader.style.left = "0";
        fader.style.top = "0";
        fader.style.width = "100%";
        fader.style.height = "100%";
        fader.style.zIndex = "1000";
        var pageLayout = document.getElementById("page-layout");
        if (pageLayout) {
          pageLayout.className += " fade-effect"
        }
      }
      document.body.appendChild(fader)
    }
    return Ifm.Dom.Fader._faders > 0
  };
  this.Fader.hide = function() {
    Ifm.Dom.Fader._faders--;
    if (Ifm.Dom.Fader._faders === 0) {
      var fader = document.getElementById("ifmjs_sys_fader");
      if (fader) {
        document.body.removeChild(fader);
        var pageLayout = document.getElementById("page-layout");
        if (pageLayout) {
          pageLayout.className = pageLayout.className.replace(" fade-effect", "")
        }
      }
    }
    return Ifm.Dom.Fader._faders <= 0
  };
  this.Menu = function() {
    if (!(this instanceof Ifm.Dom.Menu))
      throw Ifm.Diagnostics.Errors.ctor();
    var menuClassId = "ifmjs_menu";
    return {
        constructor: Ifm.Dom.Menu, choose: function(items, callback) {
            if (!Ifm.Type.isArray(items))
              throw Ifm.Diagnostics.Errors.arg("items");
            if (!Ifm.Type.isFunction(callback))
              throw Ifm.Diagnostics.Errors.arg("callback");
            var options = '';
            for (var i = 0, item; i < items.length, item = items[i]; i++) {
              if (item.visible !== false) {
                if (item.label !== '-') {
                  options += '<option value="{0}" {2}>{1}</option>'.format(item.value, item.label, item.disabled ? "disabled" : "")
                }
                else {
                  options += '<option value="" disabled></option>'
                }
              }
            }
            var select = '<div class="menu"><select style="width:100%;" size="{0}">{1}</select></div>'.format(items.length === 1 ? 2 : items.length, options);
            var card = Ifm.Dom.Cards.show(select, menuClassId),
              sele = card.children[0].children[0];
            sele.onclick = function() {
              callback(this.value)
            };
            sele.onkeydown = function(e) {
              e = Ifm.Dom.Events.getEvent(e);
              if (e.which === 13) {
                Ifm.Dom.Cards.close(menuClassId);
                callback(this.value)
              }
              if (e.which === 27) {
                Ifm.Dom.Cards.close(menuClassId)
              }
            };
            sele.focus()
          }
      }
  };
  this.Strings = (function() {
    function parse(subchar, ref) {
      if (Ifm.Type.isString(ref.nodeValue) && ref.nodeValue.startsWith(subchar + '(') && ref.nodeValue.endsWith(')')) {
        try {
          ref.nodeValue = (Function('return ' + ref.nodeValue.slice(subchar.length + 1, -1)))()
        }
        catch(err) {}
      }
    }
    return {replaceAll: function(subchar) {
          if (!subchar)
            subchar = '%';
          Ifm.Dom.Walker.walk(document.body, function(node) {
            if ((node.nodeType === 1)) {
              for (var i = 0; i < node.attributes.length; i++) {
                parse(subchar, node.attributes[i])
              }
            }
            else if (node.nodeType === 3) {
              parse(subchar, node)
            }
          })
        }}
  })();
  this.Walker = {};
  this.Walker.walk = function walk(node, func) {
    func(node);
    node = node.firstChild;
    while (node) {
      walk(node, func);
      node = node.nextSibling
    }
  }
}).call(Ifm.Dom);
;
namespace("Ifm.PhoneBar.UI").Templates = {
  AlertCard: '<div class="phonebar-alert-text">{text}</div>', CampaignListCard: '<div class="default-background scrollable">' + '<div class="phonebar-campaignlist-card-content">' + '<table class="phonebar-campaignlist-card-table"><tbody>{body}</tbody></table>' + '</div>' + '</div>', CampaignListRow: '<tr><td>{name}</td><td>{boundness}</td><td>{state}</td></tr>', IncomingCallCard: '<div class="phonebar-incoming-call-card-content">' + '<div class="phonebar-incoming-call-text">{incomingCallText}</div>' + '<div class="phonebar-incoming-call-number">{incomingCallNumber}</div>' + '<div class="phonebar-incoming-call-campaign">{campaignName}</div>' + '</div>', CallRegistryCard: '<div class="phonebar-callregistry-card-content">' + '<div class="phonebar-callregistry-card-tabs-container">' + '<button class="phonebar-callregistry-card-tab-button phonebar-callregistry-tab-activecalls" data-call-list="activecalls">{activeTabTitle}</button>' + '<button class="phonebar-callregistry-card-tab-button phonebar-callregistry-tab-managedcalls" data-call-list="managedcalls">{managedTabTitle}</button>' + '<button class="phonebar-callregistry-card-tab-button phonebar-callregistry-tab-failedcalls" data-call-list="failedcalls">{failedTabTitle}</button>' + '<button class="phonebar-callregistry-card-clear-button material-icons" disabled><span class="material-icons">delete</span></button>' + '</div>' + '<div class="phonebar-callregistry-card-tab-content">' + '{activeTabContent}' + '{managedTabContent}' + '{failedTabContent}' + '</div>' + '</div>', CallRegistryTabPane: '<div class="phonebar-callregistry-card-tab-pane phonebar-callregistry-{callList} hidden">' + '<table class="phonebar-callregistry-card-table">' + '<thead>' + '<tr>' + '<th>{mediatypeLabel}</th>' + '<th>{dateTimeLabel}</th>' + '<th>{campaignNameLabel}</th>' + '<th>{numberLabel}</th>' + '<th>{displayNameLabel}</th>' + '</tr>' + '</thead>' + '<tbody>{rows}</tbody>' + '</table>' + '</div>', CallRegistryRow: '<tr>' + '<td><span class="material-icons">{mediatypeIcons}</span></td>' + '<td>{dateTime}</td>' + '<td>{campaignName}</td>' + '<td>{number}</td>' + '<td>{displayName}</td>' + '</tr>', LoginDialog: '<fieldset class="phonebar-form">' + '<div>' + '<label class="phonebar-form-label" for="firstnametxt">{firstNameLabel}</label>' + '<input class="phonebar-form-input" type="text" id="firstnametxt" value="{firstName}">' + '</div><div>' + '<label class="phonebar-form-label" for="lastnametxt">{lastNameLabel}</label>' + '<input class="phonebar-form-input" type="text" id="lastnametxt" value="{lastName}">' + '</div><div>' + '<label class="phonebar-form-label" for="passwordtxt">{passwordLabel}</label>' + '<input class="phonebar-form-input" type="password" id="passwordtxt" value="{password}">' + '</div><div>' + '<label class="phonebar-form-label" for="extensiontxt">{extensionLabel}</label>' + '<input class="phonebar-form-input small right-aligned" type="text" id="extensiontxt" value="{extension}">' + '</div>' + '</fieldset>', Login2Dialog: '<fieldset class="phonebar-form">' + '<div>' + '<label class="phonebar-form-label" for="firstnametxt">{firstNameLabel}</label>' + '<input class="phonebar-form-input" type="text" id="firstnametxt" value="{firstName}">' + '</div><div>' + '<label class="phonebar-form-label" for="lastnametxt">{lastNameLabel}</label>' + '<input class="phonebar-form-input" type="text" id="lastnametxt" value="{lastName}">' + '</div><div>' + '<label class="phonebar-form-label" for="oldPasswordtxt">{oldPasswordLabel}</label>' + '<input class="phonebar-form-input" type="password" id="oldPasswordtxt" value="{oldPassword}">' + '</div><div>' + '<label class="phonebar-form-label" for="newPasswordtxt">{newPasswordLabel}</label>' + '<input class="phonebar-form-input" type="password" id="newPasswordtxt" value="{newPassword}">' + '</div><div>' + '<label class="phonebar-form-label" for="confirmPasswordtxt">{confirmPasswordLabel}</label>' + '<input class="phonebar-form-input" type="password" id="confirmPasswordtxt" value="{confirmPassword}">' + '</div><div>' + '<label class="phonebar-form-label" for="extensiontxt">{extensionLabel}</label>' + '<input class="phonebar-form-input small right-aligned" type="text" id="extensiontxt" value="{extension}">' + '</div>' + '</fieldset>', LoginOAuth2Dialog: '<fieldset class="phonebar-form">' + '<div>' + '<label class="phonebar-form-label" for="usernametxt">{usernameLabel}</label>' + '<input class="phonebar-form-input large" type="text" id="usernametxt" value="{username}">' + '</div><div>' + '<label class="phonebar-form-label" for="extensiontxt">{extensionLabel}</label>' + '<input class="phonebar-form-input small right-aligned" type="text" id="extensiontxt" value="{extension}">' + '</div>' + '</fieldset>', MessageCard: '<div class="phonebar-message-{severity}"><i class="material-icons">{icon}</i>' + ' <span class="phonebar-message-title">{title}</span></div>' + '<div class="phonebar-message-text">{message}</div>', QueueInfoCard: '<div class="phonebar-queueinfo-card-content">' + '<div><b>{number}</b> {queuedNumberText}</div>' + '<div><b>{maxTime}</b> {queuedMaxTimeText}</div>' + '<div><b>{avgTime}</b> {queuedAvgTimeText}</div>' + '</div>', SupervisorMessageCard: '<div class="phonebar-supervisor-message-{severity}"><i class="material-icons">{icon}</i>' + ' <span class="phonebar-supervisor-message-title">{title}</span></div>' + '<div class="phonebar-supervisor-message-text">{message}</div>', TransferCallCard: '<div class="phonebar-transfercall-card-content">' + '<select class="phonebar-transfer-campaign-list"></select>' + '<div class="phonebar-transfer-agent-list-search-box">' + '<input class="phonebar-form-input phonebar-transfer-agent-list-search-input" type="text" placeholder="{searchHelp}" value="">' + '</div>' + '<select class="phonebar-transfer-agent-list" size="10"></select>' + '<label><input type="checkbox" class="phonebar-transfer-mandatory-check" checked>{mandatoryLabel}</label>' + '</div>', TransferCallAgentListItem: '<option firstName="{0}" lastName="{1}" agentState="{2}">{0} {1} {2}</option>', TransferCallCampaignListItem: '<option campaignName="{0}" {2}>{1}</option>', SettingsCard: '<div class="phonebar-settings-card-content default-background scrollable">' + '<div class="phonebar-settings-card-body">{fields}</div>' + '</div>', SettingsFieldRow: '<div class="phonebar-settings-row">' + '<label class="phonebar-form-label {labelClass}" for="{inputElementId}">{label}</label>' + '<div class="phonebar-settings-input">{input}</div>' + '<div class="phonebar-settings-modified">{modified}</div>' + '<div class="phonebar-settings-revert">{revertButton}</div>' + '</div>'
};
Ifm.PhoneBar.UI.Commands = (function() {
  const phonebar = Ifm.PhoneBar.instance;
  const commands = {};
  commands.login = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    if (phonebar.currentState() !== Ifm.PhoneBar.States.NotLoggedIn) {
      return
    }
    if (phonebar.getPhoneBarConfiguration().useProvisioning) {
      commands.provisioningAndLogin();
      return
    }
    if (phonebar.isOAuth2Enabled()) {
      var html = t.LoginOAuth2Dialog.replace("{usernameLabel}", strings.LoginUsername).replace("{username}", phonebar.agent.username).replace("{extensionLabel}", strings.LoginExtension).replace("{extension}", phonebar.agent.extension);
      Ifm.Dom.Photon.Cards.showDialog(html, "login-dialog", strings.LoginOAuth2Title, [{
          text: strings.ButtonOK, click: doOAuth2Login
        }, {text: strings.ButtonCancel}], {
        width: 600, height: 248
      })
    }
    else {
      var html = t.LoginDialog.replace("{firstNameLabel}", strings.LoginFirstName).replace("{lastNameLabel}", strings.LoginLastName).replace("{passwordLabel}", strings.LoginPassword).replace("{extensionLabel}", strings.LoginExtension).replace("{firstName}", phonebar.agent.firstName).replace("{lastName}", phonebar.agent.lastName).replace("{password}", phonebar.agent.password).replace("{extension}", phonebar.agent.extension);
      Ifm.Dom.Photon.Cards.showDialog(html, "login-dialog", strings.LoginTitle, [{
          text: strings.ButtonChangePassword, cssText: "margin-right:50px;", click: function() {
              commands.loginChangePassword()
            }
        }, {
          text: strings.ButtonOK, click: doPhonesLogin
        }, {text: strings.ButtonCancel}], {
        width: 600, height: 324
      })
    }
  };
  commands.loginChangePassword = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    var html = t.Login2Dialog.replace("{firstNameLabel}", strings.LoginFirstName).replace("{lastNameLabel}", strings.LoginLastName).replace("{oldPasswordLabel}", strings.LoginOldPassword).replace("{newPasswordLabel}", strings.LoginNewPassword).replace("{confirmPasswordLabel}", strings.LoginConfirmPassword).replace("{extensionLabel}", strings.LoginExtension).replace("{firstName}", phonebar.agent.firstName).replace("{lastName}", phonebar.agent.lastName).replace("{oldPassword}", "").replace("{newPassword}", "").replace("{confirmPassword}", "").replace("{extension}", phonebar.agent.extension);
    Ifm.Dom.Photon.Cards.showDialog(html, "login2-dialog", strings.LoginTitle, [{
        text: strings.ButtonOK, click: function(dialog, dialogBody) {
            if (phonebar.currentState() !== Ifm.PhoneBar.States.NotLoggedIn) {
              return
            }
            const firstnametxt = dialogBody.querySelector('#firstnametxt');
            const lastnametxt = dialogBody.querySelector('#lastnametxt');
            const oldPasswordtxt = dialogBody.querySelector('#oldPasswordtxt');
            const newPasswordtxt = dialogBody.querySelector('#newPasswordtxt');
            const confirmPasswordtxt = dialogBody.querySelector('#confirmPasswordtxt');
            const extensiontxt = dialogBody.querySelector('#extensiontxt');
            if (newPasswordtxt.value !== confirmPasswordtxt.value) {
              confirmPasswordtxt.focus();
              commands.showMessage(strings.PasswordsDontMatch, 'error');
              return false
            }
            phonebar.loginEx(firstnametxt.value, lastnametxt.value, oldPasswordtxt.value, newPasswordtxt.value, extensiontxt.value, function(e) {
              if (e.accepted) {
                dialog.close()
              }
              else {
                if (e.failureCause === 1) {
                  dialog.close();
                  commands.showMessage(strings.AccountLockedOut, 'error')
                }
                else if (e.failureCause === 4) {
                  newPasswordtxt.value = confirmPasswordtxt.value = "";
                  commands.showMessage(strings.InvalidNewPassword, 'warning')
                }
                else if (e.failureCause === 5) {
                  dialog.close();
                  commands.login();
                  commands.showMessage(strings.CantChangePassword, 'information')
                }
                else {
                  dialog.shake();
                  var cause = e.failureCause === 3 ? strings.WrongCredentials : strings.UserOrExtensionTaken;
                  commands.showMessage(cause, 'warning')
                }
              }
            });
            return false
          }
      }, {text: strings.ButtonCancel}], {
      width: 600, height: 440
    })
  };
  commands.loginOrReady = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    if (!phonebar.isLoggedIn()) {
      Ifm.PhoneBar.UI.doOverridableButtonClick(el.LoginButton, commands.login)
    }
    else {
      Ifm.PhoneBar.UI.doOverridableButtonClick(el.ReadyButton, commands.ready)
    }
  };
  commands.logout = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    phonebar.logout()
  };
  commands.pause = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    phonebar.getPauseReasons(function(e) {
      if (e.reasons.length === 0) {
        phonebar.pause()
      }
      else {
        e.reasons.unshift({
          text: strings.PauseGenericReason, value: 0
        });
        var choices = [];
        for (var i = 0; i < e.reasons.length; i++) {
          choices.push({
            label: e.reasons[i].text, value: e.reasons[i].id
          })
        }
        Ifm.Dom.Photon.Menu.choose(choices, function(id) {
          phonebar.pause(id)
        })
      }
    })
  };
  commands.ready = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    var activeCall = getAudioCall();
    if (activeCall && activeCall.postcall) {
      phonebar.ready(activeCall.callId)
    }
    else {
      phonebar.ready()
    }
  };
  commands.panic = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    phonebar.panic();
    var toolbars = el.MainToolbar + ", " + el.PhoneToolbar;
    jQuery(toolbars).addClass("phonebar-panic-effect");
    setTimeout(function() {
      jQuery(toolbars).removeClass("phonebar-panic-effect")
    }, 2000)
  };
  commands.showAssignedCampaignList = function(update) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    if (update && !Ifm.Dom.Photon.Cards.isShown('campaignlist-card'))
      return;
    phonebar.getAssignedCampaignList(function(e) {
      var rows = "";
      for (var i = 0; i < e.campaigns.length; i++) {
        rows += t.CampaignListRow.replace("{name}", e.campaigns[i].name).replace("{boundness}", e.campaigns[i].boundness).replace("{state}", e.campaigns[i].active ? "" : "Stop")
      }
      var html = t.CampaignListCard.replace("{body}", rows);
      var card = Ifm.Dom.Photon.Cards.show(html, 'campaignlist-card', true, false, 0, strings.AssignmentsTitle);
      setTimeout(commands.showAssignedCampaignList, 5000, true);
      if (!Ifm.Photon.app.isHosted) {
        card.onclick = function() {
          card.close()
        }
      }
    })
  };
  commands.toggleAssignedCampaignList = function() {
    if (Ifm.Dom.Photon.Cards.isShown("campaignlist-card")) {
      Ifm.Dom.Photon.Cards.close("campaignlist-card")
    }
    else {
      commands.showAssignedCampaignList()
    }
  };
  commands.hideDialpad = function() {
    jQuery(el.PhoneDialPad + ", " + el.HideDialPadButton).disable().hide();
    jQuery(el.ShowDialPadButton).enable().show()
  };
  commands.showDialpad = function() {
    jQuery(el.PhoneDialPad + ", " + el.HideDialPadButton).enable().show();
    jQuery(el.ShowDialPadButton).disable().hide()
  };
  commands.toggleDialpad = function() {
    console.debug('Not implemented: commands.toggleDialpad()')
  };
  commands.showQueueInfo = function(update) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    if (update && !Ifm.Dom.Photon.Cards.isShown('queueinfo-card'))
      return;
    phonebar.getQueueInfo("", function(e) {
      var html = t.QueueInfoCard.replace("{number}", e.calls).replace("{queuedNumberText}", strings.QueuedNumberText).replace("{maxTime}", e.maxTime || "--").replace("{queuedMaxTimeText}", strings.QueuedMaxTimeText).replace("{avgTime}", e.avgTime || "--").replace("{queuedAvgTimeText}", strings.QueuedAvgTimeText);
      var card = Ifm.Dom.Photon.Cards.show(html, 'queueinfo-card', true, false, 0, strings.QueueInfoTitle, {
          left: screen.availWidth - 180, top: 100, width: 130, height: 100, toolWindow: true, topmost: true
        });
      card.className += " phonebar-queueinfo-card";
      setTimeout(commands.showQueueInfo, 5000, true);
      if (!Ifm.Photon.app.isHosted) {
        card.onclick = function() {
          card.close()
        }
      }
    })
  };
  commands.toggleQueueInfo = function() {
    if (Ifm.Dom.Photon.Cards.isShown("queueinfo-card")) {
      Ifm.Dom.Photon.Cards.close("queueinfo-card")
    }
    else {
      commands.showQueueInfo()
    }
  };
  commands.abortCall = function() {
    if (phonebar.currentState() === Ifm.PhoneBar.States.WaitingOutbound) {
      phonebar.abortCall()
    }
  };
  commands.getInputNumber = function() {
    const q = jQuery(el.NumberInput);
    if (q.data("s")) {
      return q.data("n") === "0" ? q.val() : q.attr("title")
    }
    return q.val()
  };
  commands.showMakeCallPopup = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    if (!commands.getInputNumber())
      return;
    if (phonebar.media.phone && phonebar.media.phone.selectedLineId > 0) {
      phonebar.media.phone.dial(commands.getInputNumber());
      return
    }
    phonebar.getOutboundCampaignList(function(e) {
      if (phonebar.media.phone && !phonebar.options.disableManualCall()) {
        e.campaigns.push({name: strings.OutboundManualCall})
      }
      if (e.campaigns.length > 0) {
        var choices = [];
        for (var i = 0; i < e.campaigns.length; i++) {
          choices.push({
            label: e.campaigns[i].serviceName || e.campaigns[i].name, value: e.campaigns[i].name
          })
        }
        Ifm.Dom.Photon.Menu.choose(choices, function(campaign) {
          if (campaign === null) {
            return
          }
          else if (campaign === strings.OutboundManualCall) {
            phonebar.media.phone.dial(commands.getInputNumber())
          }
          else {
            phonebar.makeCall(commands.getInputNumber(), campaign, phonebar.options.callingNumber() || phonebar.agent.extension)
          }
        })
      }
    })
  };
  commands.showTransferForm = function(callId) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    var campaignName = '';
    const call = callId ? phonebar.calls(callId) : getAudioCall();
    if (call) {
      callId = (call && call.callId) || 0;
      campaignName = call.campaignName
    }
    else {
      callId = 0
    }
    var html = t.TransferCallCard.replace("{mandatoryLabel}", strings.TransferMandatory).replace("{searchHelp}", strings.TransferSearchHelp);
    Ifm.Dom.Photon.Cards.showDialog(html, "transfercall-card", strings.TransferTitle, [{
        text: strings.ButtonRefresh, click: function(dialog, dialogBody) {
            getTransferAgents(dialogBody);
            return false
          }
      }, {
        text: strings.ButtonTransfer, click: function(dialog, dialogBody) {
            transferCall(callId, dialogBody, function(e) {
              if (e.accepted)
                dialog.close()
            });
            return false
          }
      }, {text: strings.ButtonCancel}], {
      width: 750, height: 522
    }, function(dialog, dialogBody) {
      dialogBody.querySelector('.phonebar-transfer-campaign-list').addEventListener('input', function() {
        getTransferAgents(dialogBody)
      });
      dialogBody.querySelector('.phonebar-transfer-agent-list-search-input').addEventListener('input', function() {
        filterTransferAgents(dialogBody)
      });
      phonebar.getTransferCampaignList(callId, function(e) {
        var list = dialogBody.querySelector(el.TransferCampaignList);
        var lastValue = list.value;
        var opts1 = "",
          opts2 = "",
          servs = [];
        for (var i = 0, c = null; i < e.campaigns.length, c = e.campaigns[i]; i++) {
          if (campaignName.startsWith(c.serviceName + '/')) {
            opts1 += t.TransferCallCampaignListItem.format(c.name, c.campaignName, (campaignName.endsWith('/' + c.campaignName) ? 'selected' : ''))
          }
          else {
            if (!servs[c.serviceName]) {
              opts2 += t.TransferCallCampaignListItem.format(c.name, c.serviceName, '');
              servs[c.serviceName] = true
            }
          }
        }
        if (opts1)
          opts1 = '<optgroup label="' + strings.TransferCampaign + '">' + opts1 + '</optgroup>';
        if (opts2)
          opts2 = '<optgroup label="' + strings.TransferService + '">' + opts2 + '</optgroup>';
        list.innerHTML = opts1 + opts2;
        if (lastValue)
          list.value = lastValue;
        getTransferAgents(dialogBody)
      })
    })
  };
  commands.startRecording = function() {
    const activeCall = getAudioCall();
    if (activeCall && !activeCall.isRecording) {
      phonebar.startRecording(activeCall.callId)
    }
  };
  commands.stopRecording = function() {
    const activeCall = getAudioCall();
    if (activeCall && activeCall.isRecording) {
      phonebar.stopRecording(activeCall.callId)
    }
  };
  commands.muteRecording = function() {
    const activeCall = getAudioCall();
    if (activeCall && activeCall.isRecording) {
      phonebar.muteRecording(activeCall.callId, true, true)
    }
  };
  commands.unmuteRecording = function() {
    const activeCall = getAudioCall();
    if (activeCall && activeCall.isRecording) {
      phonebar.muteRecording(activeCall.callId, false, false)
    }
  };
  commands.alert = function(content) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    const html = t.AlertCard.replace("{text}", content);
    if (Ifm.Photon.app.isHosted) {
      Ifm.Dom.Photon.Cards.showDialog(html, '', '', [{text: strings.ButtonOK}], {
        width: 600, height: 280, topmost: true, alert: true, glowColor: '#b3003c', glowWidth: 25
      })
    }
    else {
      commands.showMessage(content, 'warning')
    }
  };
  commands.showMessage = function(content, severity, heading, hideAfter = false) {
    if (Ifm.Photon.app.isHosted) {
      const style = getPhotonNotificationStyle(severity);
      Ifm.Photon.app.host.showNotification({
        content, heading, style, hideAfter, position: "TopCenter"
      })
    }
    else if (jQuery.toast) {
      const icon = getJQueryNotificationIcon(severity);
      jQuery.toast({
        text: content, heading: heading, icon, hideAfter, allowToastClose: true, position: 'top-center', loader: false
      })
    }
    else {
      var band = Ifm.Dom.Band.show();
      var html = '<div class="phonebar-message" ' + 'style="line-height:' + band.clientHeight + 'px;"' + '>' + content + '</div>';
      band.innerHTML = html
    }
  };
  commands.showCallRegistry = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    const activeTabPane = composeCallRegistryTabPane(phonebar.calls(), 'activecalls');
    const managedTabPane = composeCallRegistryTabPane(phonebar.callRegistry.getManagedCalls(), 'managedcalls');
    const failedTabPane = composeCallRegistryTabPane(phonebar.callRegistry.getFailedCalls(), 'failedcalls');
    const html = t.CallRegistryCard.replace("{activeTabTitle}", strings.CallRegistryActiveTabTitle).replace("{managedTabTitle}", strings.CallRegistryManagedTabTitle).replace("{failedTabTitle}", strings.CallRegistryFailedTabTitle).replace("{activeTabContent}", activeTabPane).replace("{managedTabContent}", managedTabPane).replace("{failedTabContent}", failedTabPane);
    Ifm.Dom.Photon.Cards.show(html, 'callregistry-card', true, false, 0, strings.CallRegistryTitle, {
      width: 600, height: 250, showInTaskbar: true
    }, function(dialog, dialogBody) {
      const tabButtons = dialogBody.querySelectorAll('.phonebar-callregistry-card-tab-button');
      const tabPanes = dialogBody.querySelectorAll('.phonebar-callregistry-card-tab-pane');
      function switchTab(tabButton) {
        for (const item of tabButtons) {
          item.classList.remove('selected')
        }
        for (const item of tabPanes) {
          item.classList.add('hidden')
        }
        tabButton.classList.add('selected');
        const callListName = tabButton.dataset.callList;
        localStorage.setItem('CallRegistryTab', callListName);
        const tabPane = dialogBody.querySelector('.phonebar-callregistry-' + callListName);
        tabPane.classList.remove('hidden')
      }
      for (const tabButton of tabButtons) {
        tabButton.onclick = function() {
          switchTab(tabButton)
        }
      }
      const clearButton = dialogBody.querySelector('.phonebar-callregistry-card-clear-button');
      clearButton.disabled = !phonebar.callRegistry.hasCalls();
      clearButton.onclick = function() {
        phonebar.callRegistry.clear();
        updateLists()
      };
      const lastSelectedTab = localStorage.getItem('CallRegistryTab') || 'activecalls';
      const lastSelectedTabButton = dialogBody.querySelector('.phonebar-callregistry-tab-' + lastSelectedTab);
      switchTab(lastSelectedTabButton || tabButtons[0]);
      function updateLists() {
        clearButton.disabled = !phonebar.callRegistry.hasCalls();
        tabPanes[0].querySelector('tbody').innerHTML = composeCallRegistryRows(phonebar.calls());
        tabPanes[1].querySelector('tbody').innerHTML = composeCallRegistryRows(phonebar.callRegistry.getManagedCalls());
        tabPanes[2].querySelector('tbody').innerHTML = composeCallRegistryRows(phonebar.callRegistry.getFailedCalls())
      }
      setInterval(updateLists, 2000)
    })
  };
  commands.toggleCallRegistry = function() {
    if (Ifm.Dom.Photon.Cards.isShown('callregistry-card')) {
      Ifm.Dom.Photon.Cards.close('callregistry-card')
    }
    else {
      commands.showCallRegistry()
    }
  };
  commands.showSettings = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    const originalSettings = phonebar.getOriginalConfiguration();
    const mergedProvisioning = phonebar.getConfiguration() || {};
    const metadata = originalSettings.Metadata || {};
    const sections = ['config', 'oauth2', 'softphoneconfig', 'webrtcconfig', 'xmppconfig'];
    const available = sections.filter(s =>  {
          if (s === 'oauth2') {
            return mergedProvisioning.config && (mergedProvisioning.config.enableOAuth2 !== undefined || mergedProvisioning.config.authorityUrl !== undefined)
          }
          return mergedProvisioning[s] !== undefined
        });
    buildSettingsDialog(strings.SettingsTitle, settingsUISchema, mergedProvisioning, originalSettings, metadata, available, strings)
  };
  commands.showOptions = function() {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    const originalSettings = phonebar.getOriginalConfiguration();
    const mergedProvisioning = phonebar.getConfiguration() || {};
    const metadata = originalSettings.Metadata || {};
    buildSettingsDialog(strings.OptionsTitle, optionsUISchema, mergedProvisioning, originalSettings, metadata, ['options'], strings)
  };
  commands.answer = function() {
    if (phonebar.currentState() !== Ifm.PhoneBar.States.NotLoggedIn) {
      const phone = Ifm.PhoneBar.instance.media.phone;
      phone.answer();
      Ifm.Dom.Photon.Cards.close("incoming-call-card")
    }
  };
  commands.dial = function(number) {
    var phone = Ifm.PhoneBar.instance.media.phone;
    var number = number !== undefined && number !== null ? number : commands.getInputNumber();
    phone.dial(number)
  };
  commands.flash = function() {
    commands.dial("!")
  };
  commands.flashAndDial = function(number) {
    commands.dial("!," + commands.getInputNumber())
  };
  commands.dtmf = function(tones) {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.dtmf(tones)
  };
  commands.enterConference = function() {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.enterConference()
  };
  commands.leaveConference = function() {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.leaveConference()
  };
  commands.drop = function() {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.drop()
  };
  commands.mute = function() {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.mute()
  };
  commands.selectLine = function(lineId) {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.selectLine(lineId)
  };
  commands.selectLine1 = function() {
    commands.selectLine(0)
  };
  commands.selectLine2 = function() {
    commands.selectLine(1)
  };
  commands.unmute = function() {
    var phone = Ifm.PhoneBar.instance.media.phone;
    phone.unmute()
  };
  Ifm.PhoneBar.events.initialized = function(phonebar, e) {
    if (!_uiInitialized) {
      bindOverridableButtons();
      bindElements();
      bindEvents();
      _uiInitialized = true
    }
    if (!e.options) {
      return
    }
    if (phonebar.options.loginOnStart()) {
      setTimeout(function() {
        if (phonebar.isRedirectedAfterOAuth2Signin()) {
          return
        }
        else if (phonebar.isRedirectedAfterOAuth2Signout()) {
          commands.login()
        }
        else if (phonebar.options.loginOnStart() === 2) {
          var a = phonebar.agent;
          if (phonebar.isOAuth2Enabled() && a.extension) {
            phonebar.getToken(function(token) {
              phonebar.loginWithToken(token, a.extension, a.username, function(e) {
                if (!e.accepted)
                  commands.login()
              })
            })
          }
          else if (phonebar.options.rememberCredentials() === 2 && a.firstName && a.lastName && a.extension) {
            phonebar.login(a.firstName, a.lastName, a.password, a.extension, function(e) {
              if (!e.accepted)
                commands.login()
            })
          }
          else {
            commands.login()
          }
        }
        else {
          commands.login()
        }
      })
    }
  };
  function bindOverridableButtons() {
    bindOverridableButton(el.LoginButton, commands.login);
    bindOverridableButton(el.ReadyButton, commands.ready);
    bindOverridableButton(el.PauseButton, commands.pause);
    bindOverridableButton(el.LogoutButton, commands.logout);
    bindOverridableButton(el.CallButton, commands.showMakeCallPopup, function() {
      return {
          lineId: Ifm.PhoneBar.instance.media.phone.selectedLineId, number: commands.getInputNumber()
        }
    });
    bindOverridableButton(el.AbortCallButton, commands.abortCall);
    bindOverridableButton(el.TransferButton, commands.showTransferForm);
    bindOverridableButton(el.CampaignListButton, commands.toggleAssignedCampaignList);
    bindOverridableButton(el.QueueInfoButton, commands.toggleQueueInfo);
    bindOverridableButton(el.StartRecordingButton, commands.startRecording);
    bindOverridableButton(el.StopRecordingButton, commands.stopRecording);
    bindOverridableButton(el.MuteRecordingButton, commands.muteRecording);
    bindOverridableButton(el.UnmuteRecordingButton, commands.unmuteRecording);
    bindOverridableButton(el.HangupButton, commands.drop);
    bindOverridableButton(el.PickupButton, commands.answer);
    bindOverridableButton(el.FlashButton, commands.flash);
    bindOverridableButton(el.ManualTransferButton, commands.flashAndDial, function() {
      return {number: commands.getInputNumber()}
    });
    bindOverridableButton(el.Line1Button, commands.selectLine1);
    bindOverridableButton(el.Line2Button, commands.selectLine2);
    bindOverridableButton(el.EnterConferenceButton, commands.enterConference);
    bindOverridableButton(el.LeaveConferenceButton, commands.leaveConference);
    bindOverridableButton(el.MicrophoneOffButton, commands.mute);
    bindOverridableButton(el.MicrophoneOnButton, commands.unmute)
  }
  function bindOverridableButton(selector, defaultAction, getParams) {
    jQuery(selector).click(function() {
      Ifm.PhoneBar.UI.doOverridableButtonClick(selector, defaultAction, getParams)
    })
  }
  function bindElements() {
    jQuery(el.LoginOrReadyButton).click(function() {
      commands.loginOrReady()
    });
    jQuery(el.PanicButton).click(function() {
      commands.panic()
    });
    jQuery(el.MainMenuButton).click(function() {
      commands.showMenu()
    });
    jQuery(el.NumberInput).on("input", function() {
      const q = jQuery(el.NumberInput);
      if (q.data("s")) {
        if (q.data("n") === "1") {
          q.val(q.attr("title"));
          q.attr("title", "")
        }
        ;
        q.removeData(["n", "s"])
      }
    }).on("keydown", function(e) {
      if (e.which === 13) {
        if (jQuery(el.CallButton).enabled())
          jQuery(el.CallButton).click();
        return false
      }
      if ((e.ctrlKey && e.keyCode === 8) || e.which === 27) {
        const phone = Ifm.PhoneBar.instance.media.phone;
        const Phone = Ifm.PhoneBar.Media.Phone;
        phone && Phone && Phone.events.lineselected.raise(this, {lineId: phone.selectedLineId});
        return false
      }
    }).click(function() {
      const q = jQuery(el.NumberInput);
      if (q.data("s")) {
        const t = q.attr("title");
        q.attr("title", q.val());
        q.val(t);
        q.data("n", q.data("n") === "0" ? "1" : "0")
      }
    });
    jQuery(el.PhoneDialPad).disable().hide();
    jQuery(el.HideDialPadButton).disable().hide().click(function() {
      commands.hideDialpad()
    });
    jQuery(el.ShowDialPadButton).click(function() {
      commands.showDialpad()
    });
    jQuery(el.ToggleDialPadButton).click(function() {
      commands.toggleDialpad()
    });
    jQuery(el.CallRegistryButton).click(function() {
      commands.toggleCallRegistry()
    });
    jQuery(el.SettingsButton).click(function() {
      commands.showSettings()
    });
    jQuery(el.OptionsButton).click(function() {
      commands.showOptions()
    });
    jQuery(el.DialPadDigit0Button).click(function() {
      commands.dtmf("0")
    });
    jQuery(el.DialPadDigit1Button).click(function() {
      commands.dtmf("1")
    });
    jQuery(el.DialPadDigit2Button).click(function() {
      commands.dtmf("2")
    });
    jQuery(el.DialPadDigit3Button).click(function() {
      commands.dtmf("3")
    });
    jQuery(el.DialPadDigit4Button).click(function() {
      commands.dtmf("4")
    });
    jQuery(el.DialPadDigit5Button).click(function() {
      commands.dtmf("5")
    });
    jQuery(el.DialPadDigit6Button).click(function() {
      commands.dtmf("6")
    });
    jQuery(el.DialPadDigit7Button).click(function() {
      commands.dtmf("7")
    });
    jQuery(el.DialPadDigit8Button).click(function() {
      commands.dtmf("8")
    });
    jQuery(el.DialPadDigit9Button).click(function() {
      commands.dtmf("9")
    });
    jQuery(el.DialPadHashButton).click(function() {
      commands.dtmf("#")
    });
    jQuery(el.DialPadStarButton).click(function() {
      commands.dtmf("*")
    })
  }
  function bindEvents() {
    addEventListener('keyup', onKeyUp);
    Ifm.PhoneBar.instance.connection.events.disconnected = function(_, e) {
      const phonebar = Ifm.PhoneBar.instance;
      const strings = Ifm.PhoneBar.Strings[phonebar.language()];
      if (e.lost) {
        commands.alert(strings.ConnectionLost)
      }
    };
    Ifm.PhoneBar.events.alerting = function(phonebar, e) {
      var call = phonebar.calls(e.callId),
        mediatype = call.mediatype,
        audioCall = mediatype === Ifm.PhoneBar.Mediatypes.Voice;
      if (phonebar.options.popupIncomingCalls() & mediatype === mediatype) {
        const display = audioCall ? call.displayName || call.displayNumber : ' ';
        showIncomingCallPopup(display, call.campaignName, audioCall)
      }
    };
    Ifm.PhoneBar.events.callfailure = function(phonebar, e) {
      var strings = Ifm.PhoneBar.Strings[phonebar.language()];
      Ifm.Dom.Photon.Cards.close("incoming-call-card");
      if (e.cause < 255) {
        commands.showMessage(e.description, "warning", strings.CallFailure)
      }
    };
    Ifm.PhoneBar.events.pausebooked = function(phonebar, e) {
      jQuery(el.PauseButton).addClass("blink")
    };
    Ifm.PhoneBar.events.pause = function(phonebar, e) {
      jQuery(el.PauseButton).removeClass("blink")
    };
    Ifm.PhoneBar.events.statechanged = function(phonebar, e) {
      var s = Ifm.PhoneBar.States;
      if (e.previousState === s.Alerting || e.previousState === s.OtherCall) {
        setTimeout(function() {
          Ifm.Dom.Photon.Cards.close("incoming-call-card")
        }, 5000)
      }
      if (e.previousState === s.Talking || e.currentState !== s.Talking) {
        Ifm.Dom.Photon.Cards.close("transfercall-card")
      }
      if (e.currentState === s.NotLoggedIn) {
        jQuery(el.PauseButton).removeClass("blink");
        jQuery(el.Line1Button + ', ' + el.Line2Button).removeClass("selected highlight blink")
      }
    };
    Ifm.PhoneBar.events.supervisormessage = function(phonebar, e) {
      var strings = Ifm.PhoneBar.Strings[phonebar.language()],
        severities = ["information", "warning", "critical"],
        icons = ["info", "warning", "error"];
      var html = t.SupervisorMessageCard.replace("{severity}", severities[e.severity]).replace("{icon}", icons[e.severity]).replace("{message}", e.message).replace("{title}", strings.SupervisorTitle);
      Ifm.Dom.Photon.Cards.show(html, undefined, false, false, 0, strings.SupervisorTitle, {
        width: 500, height: 250, showInTaskbar: true, topmost: true
      })
    };
    Ifm.PhoneBar.Media.Xmpp.events.newmessage = function(phonebar, e) {
      var call = phonebar.calls(e.callId);
      if (call && call.mediatype === Ifm.PhoneBar.Mediatypes.StoreAndForward) {
        if (!call.handled) {
          phonebar.media.xmpp.handled(e.callId)
        }
      }
    }
  }
  function onKeyUp(event) {
    function handleButton(buttonSelector) {
      if (jQuery(buttonSelector).enabled()) {
        jQuery(buttonSelector).click();
        event.preventDefault();
        return true
      }
    }
    if (event.ctrlKey) {
      switch (event.code) {
        case'F2':
          handleButton(el.LoginOrReadyButton);
          break;
        case'F3':
          handleButton(el.PauseButton);
          break;
        case'F4':
          handleButton(el.LogoutButton);
          break;
        case'F5':
          handleButton(el.CallButton);
          break;
        case'F6':
          handleButton(el.TransferButton);
          break;
        case'F7':
          handleButton(el.CampaignListButton);
          break;
        case'F8':
          handleButton(el.ManualTransferButton);
          break;
        case'F9':
          handleButton(el.PickupButton) || handleButton(el.HangupButton);
          break;
        case'F10':
        case'F11':
          handleButton(el.FlashButton);
          break;
        case'F12':
          handleButton(el.MainMenuButton);
          break;
        case'Digit1':
          handleButton(el.Line1Button);
          break;
        case'Digit2':
          handleButton(el.Line2Button);
          break;
        case'KeyF':
          handleButton(el.EnterConferenceButton) || handleButton(el.LeaveConferenceButton);
          break;
        case'KeyM':
          handleButton(el.MicrophoneOffButton) || handleButton(el.MicrophoneOnButton);
          break
      }
    }
  }
  function doOAuth2Login(dialog, dialogBody) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    return new Promise(function(resolve, reject) {
        try {
          if (phonebar.currentState() !== Ifm.PhoneBar.States.NotLoggedIn) {
            resolve();
            return
          }
          const usernametxt = dialogBody.querySelector('#usernametxt');
          const extensiontxt = dialogBody.querySelector('#extensiontxt');
          phonebar.agent.username = usernametxt.value;
          phonebar.agent.extension = extensiontxt.value;
          phonebar.agent.save();
          dialog.close();
          phonebar.getToken(function(token) {
            phonebar.loginWithToken(token, extensiontxt.value, phonebar.agent.username, function(e) {
              if (e.failed) {
                dialog.close();
                commands.showMessage(strings.ConnectionFailed, 'error');
                resolve()
              }
              else if (e.accepted) {
                resolve()
              }
              else {
                var cause;
                switch (e.failureCause) {
                  case 3:
                    cause = strings.WrongCredentials;
                    break;
                  case 7:
                    cause = strings.InvalidExtension;
                    break;
                  case 8:
                    cause = strings.ExtensionInUse;
                    break;
                  case 9:
                  case 10:
                    cause = strings.TokenBasedLoginError;
                    break;
                  default:
                    cause = "Login error " + e.failureCause;
                    break
                }
                commands.showMessage(cause, 'warning');
                resolve(false)
              }
            })
          })
        }
        catch(err) {
          reject(err)
        }
      })
  }
  function doPhonesLogin(dialog, dialogBody) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    return new Promise(function(resolve, reject) {
        try {
          if (phonebar.currentState() !== Ifm.PhoneBar.States.NotLoggedIn) {
            resolve();
            return
          }
          const firstnametxt = dialogBody.querySelector('#firstnametxt');
          const lastnametxt = dialogBody.querySelector('#lastnametxt');
          const passwordtxt = dialogBody.querySelector('#passwordtxt');
          const extensiontxt = dialogBody.querySelector('#extensiontxt');
          phonebar.login(firstnametxt.value, lastnametxt.value, passwordtxt.value, extensiontxt.value, function(e) {
            if (e.failed) {
              dialog.close();
              commands.showMessage(strings.ConnectionFailed, 'error');
              resolve()
            }
            else if (e.accepted) {
              resolve()
            }
            else if (e.failureCause === 1) {
              commands.showMessage(strings.AccountLockedOut, 'error');
              resolve(false)
            }
            else if (e.failureCause === 2) {
              dialog.close();
              commands.showMessage(strings.PasswordExpired, 'warning');
              resolve();
              commands.loginChangePassword()
            }
            else {
              dialog.shake();
              var cause;
              switch (e.failureCause) {
                case 0:
                  cause = strings.UserOrExtensionTaken;
                  break;
                case 3:
                  cause = strings.WrongCredentials;
                  break;
                case 7:
                  cause = strings.InvalidExtension;
                  break;
                case 8:
                  cause = strings.ExtensionInUse;
                  break;
                default:
                  cause = "Login error " + e.failureCause;
                  break
              }
              commands.showMessage(cause, 'warning');
              resolve(false)
            }
          })
        }
        catch(err) {
          reject(err)
        }
      })
  }
  function getAudioCall() {
    return phonebar.calls(function(call) {
        return call.mediatype === Ifm.PhoneBar.Mediatypes.Voice
      })[0] || null
  }
  function getCallIcons(call) {
    const icons = [];
    if (call.mediatype === Ifm.PhoneBar.Mediatypes.Voice) {
      icons.push('call')
    }
    else if (call.mediatype === Ifm.PhoneBar.Mediatypes.NearRealTime) {
      icons.push('chat')
    }
    else {
      icons.push('mail')
    }
    if (call.isRecording) {
      icons.push('voicemail')
    }
    if (call.postcall) {
      icons.push('task')
    }
    return icons.join(' ')
  }
  function getCallNumber(call) {
    if (call.mediatype === Ifm.PhoneBar.Mediatypes.Voice) {
      return call.displayNumber
    }
    else {
      return ''
    }
  }
  function getCallDisplayName(call) {
    return call.displayName === call.displayNumber ? '' : call.displayName || ''
  }
  function getCallDateTime(call) {
    const dt = new Date(call.timestamp);
    return dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString()
  }
  function composeCallRegistryRows(calls) {
    let rows = '';
    for (let call of calls) {
      rows += t.CallRegistryRow.replace("{mediatypeIcons}", getCallIcons(call)).replace("{dateTime}", getCallDateTime(call)).replace("{campaignName}", call.campaignName).replace("{number}", getCallNumber(call)).replace("{displayName}", getCallDisplayName(call))
    }
    return rows
  }
  function composeCallRegistryTabPane(calls, callListName) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    const rows = composeCallRegistryRows(calls);
    return t.CallRegistryTabPane.replace("{callList}", callListName).replace("{mediatypeLabel}", strings.CallRegistryMediatypeHead).replace("{dateTimeLabel}", strings.CallRegistryDateTimeHead).replace("{campaignNameLabel}", strings.CallRegistryCampaignHead).replace("{numberLabel}", strings.CallRegistryNumberHead).replace("{displayNameLabel}", strings.CallRegistryDisplayNameHead).replace("{rows}", rows)
  }
  function getJQueryNotificationIcon(severity) {
    severity = severity || '';
    switch (severity.toLowerCase()) {
      case'info':
      case'information':
        return 'info';
      case'warn':
      case'warning':
        return 'warning';
      case'error':
        return 'error';
      default:
        return ''
    }
  }
  function getPhotonNotificationStyle(severity) {
    severity = severity || '';
    switch (severity.toLowerCase()) {
      case'info':
      case'information':
        return 'Information';
      case'warn':
      case'warning':
        return 'Warning';
      case'error':
        return 'Error';
      default:
        return 'Notification'
    }
  }
  function filterTransferAgents(dialogBody) {
    const searchInput = dialogBody.querySelector('.phonebar-transfer-agent-list-search-input');
    const agentList = dialogBody.querySelector(el.TransferAgentList);
    const items = agentList.querySelectorAll('option');
    const filter = (searchInput.value || '').toUpperCase();
    for (const item of items) {
      let itemValue = (item.textContent || '').toUpperCase();
      const eol = itemValue.indexOf('(');
      if (eol > -1) {
        itemValue = itemValue.substring(0, eol).trim()
      }
      if (!filter || itemValue.indexOf(filter) > -1) {
        item.style.display = ""
      }
      else {
        item.style.display = "none"
      }
    }
  }
  function getTransferAgents(dialogBody) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    var campaignList = dialogBody.querySelector(el.TransferCampaignList);
    if (campaignList && campaignList.selectedIndex >= 0) {
      var campaignName = campaignList[campaignList.selectedIndex].getAttribute("campaignName");
      phonebar.getTransferAgentList(campaignName, function(e) {
        var opts = t.TransferCallAgentListItem.format(strings.TransferAnybody);
        for (var i = 0, a; i < e.agents.length, a = e.agents[i]; i++) {
          opts += t.TransferCallAgentListItem.format(a.firstName, a.lastName, a.state !== 2 ? "(" + strings.GenericBusyState + ")" : "")
        }
        dialogBody.querySelector(el.TransferAgentList).innerHTML = opts
      })
    }
  }
  function showIncomingCallPopup(callingNumber, campaignName, showAnswerButton) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    var html = t.IncomingCallCard.replace("{incomingCallText}", strings.IncomingCallText).replace("{incomingCallNumber}", callingNumber || strings.UnknownCallingNumber).replace("{campaignName}", campaignName || "");
    var height = 240;
    const buttons = [];
    if (showAnswerButton) {
      buttons.push({
        text: strings.ButtonAnswer, click: commands.answer
      });
      height = 280
    }
    Ifm.Dom.Photon.Cards.showDialog(html, "incoming-call-card", '', buttons, {
      width: 600, height, modal: false, topmost: true, alert: true, glowColor: '#7bf', glowWidth: 40, cornerRadius: 16
    })
  }
  function transferCall(callId, dialogBody, callback) {
    const strings = Ifm.PhoneBar.Strings[phonebar.language()];
    var call = callId ? phonebar.calls(callId) : getAudioCall();
    if (!call || !call.callId)
      return;
    var campaignList = dialogBody.querySelector(el.TransferCampaignList);
    var campaignName = "";
    if (campaignList && campaignList.selectedIndex >= 0) {
      campaignName = campaignList[campaignList.selectedIndex].getAttribute("campaignName")
    }
    var agentList = dialogBody.querySelector(el.TransferAgentList);
    var firstName = "",
      lastName = "",
      mandatory = false;
    if (agentList && agentList.selectedIndex > 0) {
      firstName = agentList[agentList.selectedIndex].getAttribute("firstName");
      lastName = agentList[agentList.selectedIndex].getAttribute("lastName");
      mandatory = dialogBody.querySelector(el.TransferMandatoryCheck).checked
    }
    phonebar.transferCall(call.callId, campaignName, firstName, lastName, mandatory, undefined, callback)
  }
  const LOCAL_CONFIG_KEY = 'PhoneBarLocalConfig';
  function readLocalOverrides() {
    try {
      return JSON.parse(localStorage.getItem(LOCAL_CONFIG_KEY) || '{}')
    }
    catch(e) {
      return {}
    }
  }
  function saveLocalOverrides(obj) {
    try {
      localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(obj))
    }
    catch(e) {
      console.warn('Could not save local overrides', e)
    }
  }
  function flatten(obj, sectionName, out, prefix) {
    out = out || [];
    prefix = prefix ? prefix + '.' : '';
    for (const k in obj) {
      if (!Object.prototype.hasOwnProperty.call(obj, k))
        continue;
      const v = obj[k];
      const path = prefix + k;
      if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
        flatten(v, sectionName, out, path)
      }
      else {
        out.push({
          section: sectionName, key: path, value: v
        })
      }
    }
    return out
  }
  function isFieldEditable(metadata, section, keyPath) {
    if (!metadata)
      return true;
    const sectionMeta = metadata[section];
    if (sectionMeta === false)
      return false;
    if (typeof sectionMeta === 'object') {
      const keys = keyPath.split('.');
      let node = sectionMeta;
      for (const k of keys) {
        if (node === undefined || node === null)
          return true;
        if (typeof node === 'boolean')
          return node;
        node = node[k]
      }
      return node === undefined ? true : node
    }
    return true
  }
  function buildInputForField(field, metadataNode, initialStr, renderNode) {
    let v = field.value;
    try {
      const tpl = (Ifm && Ifm.PhoneBar && Ifm.PhoneBar.ConfigTemplate) ? Ifm.PhoneBar.ConfigTemplate : null;
      if ((v === null || v === undefined) && tpl && tpl[field.section]) {
        const keyParts = field.key.split('.');
        let node = tpl[field.section];
        for (const p of keyParts) {
          if (!node || !Object.prototype.hasOwnProperty.call(node, p)) {
            node = undefined;
            break
          }
          node = node[p]
        }
        if (node !== undefined) {
          v = node
        }
      }
    }
    catch(e) {}
    const id = 'pb-' + field.section + '-' + field.key.replace(/\./g, '--');
    const editable = metadataNode !== false;
    if (metadataNode === false) {
      console.debug('[PhoneBar.UI] Field locked by metadata:', field.section, field.key, 'metadataNode:', metadataNode)
    }
    let inputHtml = '';
    const type = (v === null || v === undefined) ? 'string' : (Array.isArray(v) ? 'array' : typeof v);
    if (renderNode && renderNode.hidden) {
      return {
          id, html: '', modifiedLabel: '', editable: false, type: 'hidden', initialStr
        }
    }
    if (renderNode && renderNode.enum && Array.isArray(renderNode.enum)) {
      let opts = '';
      const strings = Ifm.PhoneBar && Ifm.PhoneBar.Strings ? Ifm.PhoneBar.Strings[phonebar.language()] : null;
      for (const opt of renderNode.enum) {
        const val = (typeof opt === 'object') ? opt.value : opt;
        const rawLbl = (typeof opt === 'object' && opt.label) ? opt.label : String(val);
        const keyCandidates = ['Setting_' + (field.section + '_' + field.key).replace(/\./g, '_') + String(val) + 'Label'];
        let lbl = rawLbl;
        if (strings) {
          for (const kc of keyCandidates) {
            if (strings[kc]) {
              lbl = strings[kc];
              break
            }
          }
        }
        const sel = (val === v) ? 'selected' : '';
        opts += `<option value="${Ifm.Dom.escape ? Ifm.Dom.escape(String(val)) : String(val)}" ${sel}>${Ifm.Dom.escape ? Ifm.Dom.escape(lbl) : lbl}</option>`
      }
      inputHtml = `<select id="${id}" ${editable ? '' : 'disabled'} data-type="enum" class="phonebar-form-input large">${opts}</select>`
    }
    else if (renderNode && renderNode.bitmask && Array.isArray(renderNode.bitmask)) {
      let combos = renderNode.combinations;
      if (!combos || !Array.isArray(combos)) {
        combos = [{
            value: 0, label: renderNode.noneLabel || 'none'
          }];
        for (const bit of renderNode.bitmask) {
          const val = typeof bit === 'object' ? bit.value : bit;
          const lbl = typeof bit === 'object' && bit.label ? bit.label : String(val);
          combos.push({
            value: val, label: lbl
          })
        }
      }
      let opts = '';
      const strings = Ifm.PhoneBar && Ifm.PhoneBar.Strings ? Ifm.PhoneBar.Strings[phonebar.language()] : null;
      for (const c of combos) {
        const val = c.value;
        const rawLbl = c.label || String(val);
        const keyCandidates = ['Setting_' + (field.section + '_' + field.key).replace(/\./g, '_') + String(val) + 'Label'];
        let lbl = rawLbl;
        if (strings) {
          for (const kc of keyCandidates) {
            if (strings[kc]) {
              lbl = strings[kc];
              break
            }
          }
        }
        const sel = (val === v) ? 'selected' : '';
        opts += `<option value="${Ifm.Dom.escape ? Ifm.Dom.escape(String(val)) : String(val)}" ${sel}>${Ifm.Dom.escape ? Ifm.Dom.escape(lbl) : lbl}</option>`
      }
      inputHtml = `<select id="${id}" ${editable ? '' : 'disabled'} data-type="bitmask" class="phonebar-form-input large">${opts}</select>`
    }
    else if (type === 'boolean') {
      inputHtml = `<input type="checkbox" id="${id}" ${v ? 'checked' : ''} ${editable ? '' : 'disabled'} data-type="boolean" class="phonebar-form-input large">`
    }
    else if (type === 'number') {
      inputHtml = `<input type="number" id="${id}" value="${v}" ${editable ? '' : 'disabled'} data-type="number" class="phonebar-form-input large">`
    }
    else if (type === 'array') {
      const csv = (v || []).join(', ');
      inputHtml = `<input type="text" id="${id}" ${editable ? '' : 'disabled'} data-type="array" rows="2" value="${Ifm.Dom.escape ? Ifm.Dom.escape(csv) : csv}" class="phonebar-form-input large">`
    }
    else {
      const valueEsc = v === undefined || v === null ? '' : String(v);
      inputHtml = `<input type="text" id="${id}" value="${Ifm.Dom.escape ? Ifm.Dom.escape(valueEsc) : valueEsc}" ${editable ? '' : 'disabled'} data-type="string" class="phonebar-form-input large">`
    }
    const modifiedLabel = '';
    const initialStrLocal = (v === undefined || v === null) ? '' : String(v);
    return {
        id, html: inputHtml, modifiedLabel, editable, type, initialStr: initialStrLocal
      }
  }
  function parseInputValue(el) {
    const dt = el.getAttribute('data-type') || 'string';
    if (dt === 'boolean')
      return el.checked;
    const val = el.value;
    if (dt === 'number') {
      const n = Number(val);
      return isNaN(n) ? val : n
    }
    if (dt === 'array') {
      if (!val)
        return [];
      return val.split(',').map(s => s.trim()).filter(s => s.length > 0)
    }
    if (dt === 'enum') {
      if (val === '')
        return '';
      const n = Number(val);
      return isNaN(n) ? val : n
    }
    if (dt === 'bitmask') {
      if (val === '')
        return 0;
      const n = Number(val);
      return isNaN(n) ? val : n
    }
    return val
  }
  function mergeProvisioningWithLocal(provisioning, localOverrides, metadata) {
    const merged = JSON.parse(JSON.stringify(provisioning || {}));
    function applyOverrides(obj, overrides, meta, pathPrefix) {
      for (const k in overrides) {
        if (!Object.prototype.hasOwnProperty.call(overrides, k))
          continue;
        const localVal = overrides[k];
        const p = pathPrefix ? (pathPrefix + '.' + k) : k;
        if (localVal !== null && typeof localVal === 'object' && !Array.isArray(localVal)) {
          if (!merged[k])
            merged[k] = {};
          applyOverrides(merged[k], localVal, meta && meta[k], p)
        }
        else {
          const topSection = p.split('.')[0];
          const keyPath = p.substring(topSection.length + 1);
          const editable = isFieldEditable(metadata, topSection, keyPath || '');
          if (editable) {
            let target = merged;
            const parts = p.split('.');
            for (let i = 0; i < parts.length - 1; i++) {
              if (!target[parts[i]])
                target[parts[i]] = {};
              target = target[parts[i]]
            }
            target[parts[parts.length - 1]] = localVal
          }
          else {}
        }
      }
    }
    applyOverrides(merged, localOverrides, metadata, '');
    return merged
  }
  function getSectionLabel(strings, section) {
    if (strings && strings['Section_' + section])
      return strings['Section_' + section];
    const lower = section.toLowerCase();
    if (strings && strings['Section_' + lower])
      return strings['Section_' + lower];
    try {
      const global = Ifm.PhoneBar.Strings[phonebar.language()] || {};
      if (global['Section_' + section])
        return global['Section_' + section];
      if (global['Section_' + lower])
        return global['Section_' + lower]
    }
    catch(e) {}
    switch (section) {
      case'config':
        return 'PhoneBar';
      case'oauth2':
        return 'OAuth2';
      case'softphoneconfig':
        return 'SPC';
      case'webrtcconfig':
        return 'WebRTC';
      case'xmppconfig':
        return 'XMPP';
      case'options':
        return 'Options';
      default:
        return section.replace(/([a-z0-9])([A-Z])/g, '$1 $2').replace(/_/g, ' ')
    }
  }
  function buildSettingsDialog(title, uiSchema, mergedConfig, originalConfig, metadata, sectionFilter, strings, onChange) {
    const localOverrides = readLocalOverrides();
    const originalProvisioning = originalConfig;
    console.debug('[PhoneBar.UI] buildSettingsDialog metadata:', JSON.stringify(metadata));
    const sections = {};
    const template = (Ifm && Ifm.PhoneBar && Ifm.PhoneBar.ConfigTemplate) ? Ifm.PhoneBar.ConfigTemplate : null;
    const virtualSections = {oauth2: 'config'};
    for (const section of sectionFilter) {
      const dataSection = virtualSections[section] || section;
      const obj = mergedConfig[dataSection] || {};
      const flattened = [];
      const uiOrder = (uiSchema && uiSchema[section] && Array.isArray(uiSchema[section]._order) && uiSchema[section]._order.length > 0) ? uiSchema[section]._order : null;
      if (uiOrder) {
        for (const keyPath of uiOrder) {
          const parts = keyPath.split('.');
          let val = obj;
          for (const p of parts) {
            if (val && Object.prototype.hasOwnProperty.call(val, p))
              val = val[p];
            else {
              val = undefined;
              break
            }
          }
          flattened.push({
            section: section, dataSection: dataSection, key: keyPath, value: val
          })
        }
      }
      else {
        flatten(obj, section, flattened, '')
      }
      sections[section] = flattened
    }
    let tabsHtml = '<div class="phonebar-settings-tabs">';
    let panesHtml = '<div class="phonebar-settings-panes">';
    let first = true;
    for (const section of sectionFilter) {
      const tabTitle = getSectionLabel(strings, section);
      const tabClass = first ? 'phonebar-settings-tab phonebar-settings-tab-active' : 'phonebar-settings-tab';
      tabsHtml += `<button class="${tabClass}" data-section="${section}">${tabTitle}</button>`;
      let fieldsHtml = '';
      for (const field of sections[section]) {
        const actualSection = field.dataSection || field.section;
        const metaSection = (metadata && Object.prototype.hasOwnProperty.call(metadata, actualSection)) ? metadata[actualSection] : null;
        let mdNode = null;
        if (metaSection && typeof metaSection === 'object') {
          const parts = field.key.split('.');
          mdNode = metaSection;
          for (const p of parts) {
            if (mdNode === false)
              break;
            if (!mdNode)
              break;
            mdNode = mdNode[p]
          }
        }
        else {
          mdNode = metaSection
        }
        if (mdNode === null || mdNode === undefined) {
          const extractedFromConfig = ['softphoneconfig', 'webrtcconfig', 'xmppconfig', 'oauth2'];
          if (extractedFromConfig.includes(field.section) && metadata && metadata.config === false) {
            mdNode = false
          }
        }
        const uiSection = uiSchema && uiSchema[field.section] ? uiSchema[field.section] : null;
        let uiNode = null;
        if (uiSection && typeof uiSection === 'object') {
          const parts2 = field.key.split('.');
          uiNode = uiSection;
          for (const p of parts2) {
            if (!uiNode)
              break;
            uiNode = uiNode[p]
          }
        }
        else {
          uiNode = uiSection
        }
        const initialStr = field.value === undefined || field.value === null ? '' : String(field.value);
        const input = buildInputForField(field, mdNode, initialStr, uiNode);
        if (input.type === 'hidden')
          continue;
        const label = (strings && strings['Setting_' + (field.section + '_' + field.key).replace(/\./g, '_')]) || (strings && strings['Setting_' + field.key.replace(/\./g, '_')]) || field.key;
        const help = (mdNode && mdNode.help) ? mdNode.help : '';
        const originalSec = originalProvisioning[field.section] || {};
        const parts = field.key.split('.');
        let originalVal = originalSec;
        for (const p of parts) {
          if (originalVal && Object.prototype.hasOwnProperty.call(originalVal, p)) {
            originalVal = originalVal[p]
          }
          else {
            originalVal = undefined;
            break
          }
        }
        let modifiedMarker = '';
        const isModified = JSON.stringify(field.value) !== JSON.stringify(originalVal);
        if (isModified) {
          const restoreLabel = (strings && strings.ButtonRestoreDefault) ? strings.ButtonRestoreDefault : 'Restore default';
          modifiedMarker = `<button type="button" class="phonebar-restore-default-button" data-target="${input.id}" title="${restoreLabel}" aria-label="${restoreLabel}" style="display:inline-flex;">` + `<i class="material-icons" aria-hidden="true">settings_backup_restore</i>` + `</button>`
        }
        let revertButton = '';
        if (input.editable) {
          const revertLabel = (strings && strings.ButtonRevert) ? strings.ButtonRevert : 'Revert';
          revertButton = `<button type="button" class="phonebar-revert-button" data-target="${input.id}" title="${revertLabel}" aria-label="${revertLabel}" disabled>` + `<i class="material-icons" aria-hidden="true">undo</i>` + `</button>`
        }
        const rowHtml = t.SettingsFieldRow.replace('{labelClass}', sectionFilter.length > 1 ? 'phonebar-settings-label' : 'phonebar-settings-label-large').replace('{label}', label).replace('{inputElementId}', input.id).replace('{input}', input.html).replace('{revertButton}', revertButton).replace('{help}', help).replace('{modified}', modifiedMarker);
        fieldsHtml += `<div class="phonebar-settings-row-wrapper" data-section="${field.section}" data-key="${field.key}">${rowHtml}</div>`
      }
      const paneClass = first ? 'phonebar-settings-pane phonebar-settings-pane-active' : 'phonebar-settings-pane';
      panesHtml += `<div class="${paneClass}" data-section="${section}">${fieldsHtml}</div>`;
      first = false
    }
    tabsHtml += '</div>';
    panesHtml += '</div>';
    const innerFields = '<div class="phonebar-settings-right">' + `<fieldset class="phonebar-form">${panesHtml}</fieldset>` + '</div>';
    let innerTabs = '';
    if (sectionFilter.length > 1) {
      innerTabs = `<div class="phonebar-settings-left">${tabsHtml}</div>`
    }
    const outerFields = '<div class="phonebar-settings-tabbed-card">' + innerTabs + innerFields + '</div>';
    const cardHtml = t.SettingsCard.replace('{fields}', outerFields);
    let initialValues = {};
    let originalValues = {};
    const buttons = [{
          text: strings.ButtonSave || 'Save', cssText: 'margin-right:10px;', click: function(dialogRef, dialogBodyRef) {
              const inputs = dialogBodyRef.querySelectorAll('[id^="pb-"]');
              const overrides = {};
              const virtualSectionMap = {oauth2: 'config'};
              for (const inputEl of inputs) {
                const parts = inputEl.id.substr(3).split('-');
                let section = parts.shift();
                section = virtualSectionMap[section] || section;
                const keyPath = parts.join('-').replace(/--/g, '.');
                const value = parseInputValue(inputEl);
                if (!overrides[section])
                  overrides[section] = {};
                let target = overrides[section];
                const keys = keyPath.split('.');
                for (let i = 0; i < keys.length - 1; i++) {
                  if (!target[keys[i]])
                    target[keys[i]] = {};
                  target = target[keys[i]]
                }
                target[keys[keys.length - 1]] = value
              }
              if (phonebar.currentState() !== Ifm.PhoneBar.States.NotLoggedIn) {
                commands.showMessage(strings.ConfigCantSaveWhileLoggedIn || 'Cannot save while logged in', 'warning');
                return false
              }
              const prevOverrides = readLocalOverrides();
              const mergedOverrides = JSON.parse(JSON.stringify(prevOverrides || {}));
              function deepMerge(a, b) {
                for (const k in b) {
                  if (!Object.prototype.hasOwnProperty.call(b, k))
                    continue;
                  if (b[k] && typeof b[k] === 'object' && !Array.isArray(b[k])) {
                    if (!a[k])
                      a[k] = {};
                    deepMerge(a[k], b[k])
                  }
                  else {
                    a[k] = b[k]
                  }
                }
              }
              deepMerge(mergedOverrides, overrides);
              saveLocalOverrides(mergedOverrides);
              const originalProvisioning = phonebar.getOriginalConfiguration();
              try {
                Ifm.PhoneBar.instance.initialize(originalProvisioning);
                commands.showMessage(strings.ConfigurationSaveSuccess || 'Saved', 'information', undefined, 3000)
              }
              catch(err) {
                console.error(err);
                commands.showMessage((strings.ConfigurationSaveFailed || 'Save failed') + ': ' + err.message, 'error');
                return false
              }
            }
        }, {text: strings.ButtonCancel}];
    Ifm.Dom.Photon.Cards.showDialog(cardHtml, sectionFilter.join('-') + '-settings-dialog', title, buttons, {
      width: 840, height: 520
    }, function(dialogRef, dialogBodyRef) {
      const tabButtons = dialogBodyRef.querySelectorAll('.phonebar-settings-tab');
      const panes = dialogBodyRef.querySelectorAll('.phonebar-settings-pane');
      for (const tb of tabButtons) {
        tb.addEventListener('click', function() {
          for (const t of tabButtons)
            t.classList.remove('phonebar-settings-tab-active');
          for (const p of panes)
            p.classList.remove('phonebar-settings-pane-active');
          tb.classList.add('phonebar-settings-tab-active');
          const sec = tb.dataset.section;
          const pane = dialogBodyRef.querySelector('.phonebar-settings-pane[data-section="' + sec + '"]');
          if (pane)
            pane.classList.add('phonebar-settings-pane-active')
        })
      }
      const inputs = dialogBodyRef.querySelectorAll('[id^="pb-"]');
      initialValues = {};
      originalValues = {};
      const virtualSectionMap = {oauth2: 'config'};
      for (const inp of inputs) {
        initialValues[inp.id] = (inp.type === 'checkbox') ? inp.checked : inp.value;
        const parts = inp.id.substr(3).split('-');
        let sec = parts[0];
        sec = virtualSectionMap[sec] || sec;
        parts.shift();
        const keyPath = parts.join('-').replace(/--/g, '.');
        const keys = keyPath.split('.');
        let originalVal = (originalProvisioning && originalProvisioning[sec]) ? originalProvisioning[sec] : undefined;
        for (const k of keys) {
          if (originalVal && Object.prototype.hasOwnProperty.call(originalVal, k))
            originalVal = originalVal[k];
          else {
            originalVal = undefined;
            break
          }
        }
        const dt = inp.getAttribute('data-type');
        if (dt === 'boolean') {
          originalValues[inp.id] = !!originalVal
        }
        else if (dt === 'array') {
          originalValues[inp.id] = (originalVal || []).join(', ')
        }
        else {
          originalValues[inp.id] = originalVal === undefined || originalVal === null ? '' : String(originalVal)
        }
      }
      function updateModifiedFieldVisual(input) {
        const cur = (input.type === 'checkbox') ? input.checked : input.value;
        const isModified = String(cur) !== String(initialValues[input.id]);
        const rowWrapper = input.closest('.phonebar-settings-row-wrapper') || input.parentElement;
        if (isModified) {
          rowWrapper.classList.add('phonebar-field-modified')
        }
        else {
          rowWrapper.classList.remove('phonebar-field-modified')
        }
        const revertButton = rowWrapper.querySelector('.phonebar-revert-button');
        if (revertButton) {
          revertButton.disabled = !isModified
        }
        const originalValue = originalValues[input.id];
        const isDifferentFromOriginal = String(cur) !== String(originalValue);
        const restoreDefaultButton = rowWrapper.querySelector('.phonebar-restore-default-button');
        if (restoreDefaultButton) {
          restoreDefaultButton.style.display = isDifferentFromOriginal ? 'inline-flex' : 'none'
        }
      }
      function checkDirty() {
        let dirty = false;
        for (const inp of inputs) {
          const cur = (inp.type === 'checkbox') ? inp.checked : inp.value;
          if (String(cur) !== String(initialValues[inp.id])) {
            dirty = true;
            break
          }
        }
        adjustDialogButtons(dirty)
      }
      function adjustDialogButtons(dirty) {
        const buttonEls = dialogBodyRef.querySelectorAll('button');
        for (const b of buttonEls) {
          if ((b.textContent || b.innerText).trim() === (strings.ButtonSave || 'Save')) {
            b.disabled = !dirty;
            b.classList[dirty ? 'remove' : 'add']('disabled')
          }
          if (((b.textContent || b.innerText).trim() === (strings.ButtonCancel || 'Cancel')) || ((b.textContent || b.innerText).trim() === (strings.ButtonClose || 'Close'))) {
            b.innerHTML = dirty ? (strings.ButtonCancel || 'Cancel') : (strings.ButtonClose || 'Close')
          }
        }
      }
      for (const inp of inputs) {
        inp.addEventListener('input', function() {
          const dt = inp.getAttribute('data-type');
          if (dt === 'number' && inp.value && isNaN(Number(inp.value))) {
            inp.classList.add('phonebar-input-invalid')
          }
          else {
            inp.classList.remove('phonebar-input-invalid')
          }
          updateModifiedFieldVisual(inp);
          checkDirty()
        });
        if (inp.getAttribute('data-type') === 'boolean') {
          inp.addEventListener('change', function() {
            updateModifiedFieldVisual(inp);
            checkDirty()
          })
        }
      }
      const revertButtons = dialogBodyRef.querySelectorAll('.phonebar-revert-button');
      for (const rb of revertButtons) {
        rb.addEventListener('click', function() {
          const targetId = rb.dataset.target;
          const target = dialogBodyRef.querySelector('#' + targetId);
          if (!target)
            return;
          const savedValue = initialValues[targetId];
          if (target.type === 'checkbox') {
            target.checked = savedValue
          }
          else {
            target.value = savedValue
          }
          target.dispatchEvent(new Event('input', {bubbles: true}));
          target.dispatchEvent(new Event('change', {bubbles: true}))
        })
      }
      const restoreDefaultButtons = dialogBodyRef.querySelectorAll('.phonebar-restore-default-button');
      for (const rdb of restoreDefaultButtons) {
        rdb.addEventListener('click', function() {
          const targetId = rdb.dataset.target;
          const target = dialogBodyRef.querySelector('#' + targetId);
          if (!target)
            return;
          const originalValue = originalValues[targetId];
          if (target.type === 'checkbox') {
            target.checked = originalValue
          }
          else {
            target.value = originalValue
          }
          target.dispatchEvent(new Event('input', {bubbles: true}));
          target.dispatchEvent(new Event('change', {bubbles: true}))
        })
      }
      const restoreButtons = dialogBodyRef.querySelectorAll('.phonebar-restore-section-button');
      for (const rb of restoreButtons) {
        rb.addEventListener('click', function() {
          const sec = rb.dataset.section;
          const overrides = readLocalOverrides();
          if (overrides && Object.prototype.hasOwnProperty.call(overrides, sec)) {
            delete overrides[sec];
            saveLocalOverrides(overrides)
          }
          const pane = dialogBodyRef.querySelector('.phonebar-settings-pane[data-section="' + sec + '"]');
          if (!pane)
            return;
          const provisioning = phonebar.getPhoneBarConfiguration();
          const sectionObj = provisioning && provisioning[sec] ? provisioning[sec] : {};
          const inputsInPane = pane.querySelectorAll('[id^="pb-"]');
          for (const inp of inputsInPane) {
            const parts = inp.id.substr(3).split('-');
            parts.shift();
            const keyPath = parts.join('-').replace(/_/g, '.');
            const keys = keyPath.split('.');
            let val = sectionObj;
            for (const k of keys) {
              if (val && Object.prototype.hasOwnProperty.call(val, k))
                val = val[k];
              else {
                val = undefined;
                break
              }
            }
            const dt = inp.getAttribute('data-type');
            if (dt === 'boolean') {
              inp.checked = !!val
            }
            else if (dt === 'array') {
              inp.value = (val || []).join(', ')
            }
            else {
              inp.value = val === undefined || val === null ? '' : String(val)
            }
            inp.dispatchEvent(new Event('input', {bubbles: true}));
            inp.dispatchEvent(new Event('change', {bubbles: true}))
          }
          commands.showMessage(strings.SaveSuccess || 'Saved', 'information')
        })
      }
      adjustDialogButtons(false);
      for (const inp of inputs)
        updateModifiedFieldVisual(inp)
    })
  }
  const settingsUISchema = {
      config: {
        _order: ['useProvisioning', 'language', 'service', 'phoneDevice', 'recordingsPath'], debug: {hidden: true}, language: {enum: [{
                value: 'it', label: 'Italiano'
              }, {
                value: 'en', label: 'English'
              }]}, phoneDevice: {enum: [{
                value: '', label: 'External or no device'
              }, {
                value: 'SPC', label: 'Softphone Controller (SPC)'
              }, {
                value: 'WebRTC', label: 'WebRTC Phone'
              }]}
      }, oauth2: {_order: ['enableOAuth2', 'authorityUrl', 'authorityIsAdfs', 'clientId', 'scopes']}, softphoneconfig: {_order: ['service', 'domain']}, webrtcconfig: {_order: ['SBCConfig.domain', 'SBCConfig.addresses', 'SBCConfig.iceServers', 'SBCConfig.useDomainOfLoggedUser']}, xmppconfig: {
          _order: ['service', 'server', 'mediatypes', 'ftservice', 'nickname', 'domain_nrt', 'domain_saf', 'admin_nrt', 'admin_saf', 'useBuiltinXmppWindow'], debug: {hidden: true}, mediatypes: {
              bitmask: [{
                  value: 8, label: 'Near Real-Time (chat)'
                }, {
                  value: 16, label: 'Store and Forward (email/social)'
                }], combinations: [{
                    value: 8, label: 'Near Real-Time (chat)'
                  }, {
                    value: 16, label: 'Store and Forward (email/social)'
                  }, {
                    value: 24, label: 'Near Real-Time + Store and Forward'
                  }]
            }
        }
    };
  const optionsUISchema = {options: {
        _order: ['hideClockInPause', 'hidePausedAgents', 'disableManualCall', 'autoAnswerPhone', 'autoAnswerRings', 'popupIncomingCall', 'callingNumber', 'rememberCredentials', 'loginOnStart'], useDefaultUI: {hidden: true}, autoAnswerPhone: {enum: [{
                value: 0, label: 'Do not answer automatically)'
              }, {
                value: 1, label: '#phones outbound calls'
              }, {
                value: 2, label: '#phones inbound and outbound calls'
              }, {
                value: 3, label: 'All calls (#phones and manual)'
              }]}, loginOnStart: {enum: [{
                value: 0, label: 'Do not log in automatically'
              }, {
                value: 1, label: 'Show dialog'
              }, {
                value: 2, label: 'Automatically log in'
              }]}, popupIncomingCall: {
            bitmask: [{
                value: 1, label: 'Phone'
              }, {
                value: 8, label: 'Chat'
              }, {
                value: 16, label: 'Email/social'
              }], combinations: [{
                  value: 0, label: 'None'
                }, {
                  value: 1, label: 'Phone only'
                }, {
                  value: 8, label: 'Chat only'
                }, {
                  value: 16, label: 'Email/social only'
                }, {
                  value: 9, label: 'Phone and Chat'
                }, {
                  value: 25, label: 'All'
                }]
          }, rememberCredentials: {enum: [{
                value: 0, label: 'Do not remember'
              }, {
                value: 1, label: 'Remember username only'
              }, {
                value: 2, label: 'Remember username and password'
              }]}, confirmNavigation: {hidden: true}, preventBackspace: {hidden: true}, preventHardRefresh: {hidden: true}, preventHardRefresh: {hidden: true}, preventRefresh: {hidden: true}, preventRightClick: {hidden: true}
      }};
  var el = Ifm.PhoneBar.UI.Elements,
    t = Ifm.PhoneBar.UI.Templates;
  var _uiInitialized = false;
  return commands
})()
