
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";function buildCandy(n=jQuery){var t=function(n,t){return n.about={name:"Candy",version:"1.10.0"},n.init=function(i,r,u="#candy"){r.viewClass||(r.viewClass=n.View);r.viewClass.init(t(u),r.view);n.Core.init(i,r.core)},n}(t||{},n);t.Core=function(n,i,r){var u=null,l=null,f=null,o={},c=!1,a,e={autojoin:undefined,disconnectWithoutTabs:!0,debug:!1,disableWindowUnload:!1,presencePriority:1,resource:t.about.name},s=function(n,t){i.addNamespace(n,t)},p=function(){s("PRIVATE","jabber:iq:private");s("BOOKMARKS","storage:bookmarks");s("PRIVACY","jabber:iq:privacy");s("DELAY","jabber:x:delay");s("PUBSUB","http://jabber.org/protocol/pubsub")},v=function(n){var t=i.getNodeFromJid(n),r=i.getDomainFromJid(n);return t?i.escapeNode(t)+"@"+r:r},h=function(){var n=t.Core.getConnection().jid;n&&window.sessionStorage.removeItem("candy-cache-"+n)},y=function(){var n=t.Core.getConnection().jid;n&&f&&window.sessionStorage.setItem("candy-cache-"+n,JSON.stringify({nick:f.getNick(),rooms:o}))};return n.init=function(t,f){l=t;r.extend(!0,e,f);e.debug&&(n.debug=e.debug.toString().indexOf("verbose")>-1?function(){var n=[];n.push("[Debug]");n.push("[Candy]");Array.prototype.push.apply(n,arguments);console.debug.apply(console,n)}:function(){},n.xml=e.debug.toString().indexOf("xml")>-1?function(n,t){t=r.parseXML(t);n?console.debug(n,t):console.debug(t)}:function(){},n.log=function(){var n=[];n.push("[Info]");n.push("[Candy]");Array.prototype.push.apply(n,arguments);console.log.apply(console,n)},i.log=function(n){var t,r,u;switch(n){case i.LogLevel.DEBUG:if(e.debug.toString().indexOf("http")>=0)t="Debug",r="debug";else return;break;case i.LogLevel.INFO:t="Info";r="log";break;case i.LogLevel.WARN:t="WARN";r="warn";break;case i.LogLevel.ERROR:t="ERROR";r="error";break;case i.LogLevel.FATAL:t="FATAL";r="error"}u=Array.prototype.slice.call(arguments,1);u.unshift("[Strophe]","["+t+"]");try{console[r].apply(console,u)}catch(f){}},n.debug("[Init] Debugging enabled"));p();u=new i.Connection(l,{keepalive:!0,mechanisms:[i.SASLAnonymous]});u.rawInput=n.rawInput.bind(n);u.rawOutput=n.rawOutput.bind(n);u.caps.node="https://candy-chat.github.io/candy/";e.disableWindowUnload||(window.onbeforeunload=n.onWindowUnload)},n.registerEventHandlers=function(){n.addHandler(n.Event.Jabber.Version,i.NS.VERSION,"iq");n.addHandler(n.Event.Jabber.Presence,null,"presence");n.addHandler(n.Event.Jabber.Message,null,"message");n.addHandler(n.Event.Jabber.Bookmarks,i.NS.PRIVATE,"iq");n.addHandler(n.Event.Jabber.Room.Disco,i.NS.DISCO_INFO,"iq","result")},n.connect=function(s,l,a){var w,y,p,b;if(u.reset(),n.registerEventHandlers(),r(t).triggerHandler("candy:core.before-connect",{connection:u}),u.isRestoreSupported()){if(u.isRestorable(null,90)){this.debug("Restoring session");w=u.restore(null,t.Core.Event.Strophe.Connect);this.debug("Restoring cache");try{if(y=JSON.parse(window.sessionStorage.getItem("candy-cache-"+w.jid)),typeof y!=typeof undefined&&y!==null){f=new n.ChatUser(w.jid,y.nick||a||i.getNodeFromJid(w.jid));for(p in y.rooms)b=new t.Core.ChatRoom(p),b.setUser(t.Core.getUser()),o[p]=b,t.Core.Action.Jabber.Room.Disco(p),Candies.getRoomHistory(p)}else this.log("No restorable cache")}catch(k){this.log("Invalid cache content");this.log(k);h()}return}this.log("No restorable session");h()}else this.debug("Sessions not restorable in this configuration");c=c?!0:s&&s.indexOf("@")<0;s&&l?(u.connect(v(s)+"/"+e.resource,l,t.Core.Event.Strophe.Connect),f=a?new n.ChatUser(s,a):new n.ChatUser(s,i.getNodeFromJid(s))):s&&a?(u.connect(v(s)+"/"+e.resource,null,t.Core.Event.Strophe.Connect),f=new n.ChatUser(null,a)):s?t.Core.Event.Login(s):t.Core.Event.Login()},n.attach=function(r,e,o){f=new n.ChatUser(r,i.getNodeFromJid(r));n.registerEventHandlers();u.attach(r,e,o,t.Core.Event.Strophe.Connect)},n.disconnect=function(){u.connected&&(h(),r.each(n.getRooms(),function(){t.Core.Action.Jabber.Room.Leave(this.getJid())}),u.disconnect())},n.addHandler=function(n,t,i,r,f,e,o){return u.addHandler(n,t,i,r,f,e,o)},n.getUser=function(){return f},n.setUser=function(n){f=n;y()},n.getConnection=function(){return u},n.removeRoom=function(n){delete o[n]},n.getRooms=function(){return o},n.getStropheStatus=function(){return a},n.setStropheStatus=function(n){a=n},n.isAnonymousConnection=function(){return c},n.getOptions=function(){return e},n.getRoom=function(n){return o[n]?o[n]:null},n.onWindowUnload=function(){return;var t},n.rawInput=function(n){this.xml("RECV:",n)},n.rawOutput=function(n){this.xml("SENT:",n)},n.clearCache=function(){h()},n.updateCache=function(){y()},n.debug=function(){},n.log=function(){},n.xml=function(){},n}(t.Core||{},Strophe,n);t.View=function(n,i){var r={container:null,roomJid:null},u={language:"en",assets:"res/",messages:{limit:2e3,remove:500},crop:{message:{nickname:15,body:1e3},roster:{nickname:15}},enableXHTML:!1},f=function(t){i.i18n.load(n.Translation[t])},e=function(){i(t).on("candy:core.chat.connection",n.Observer.Chat.Connection);i(t).on("candy:core.chat.message",n.Observer.Chat.Message);i(t).on("candy:core.login",n.Observer.Login);i(t).on("candy:core.autojoin-missing",n.Observer.AutojoinMissing);i(t).on("candy:core.presence",n.Observer.Presence.update);i(t).on("candy:core.presence.leave",n.Observer.Presence.update);i(t).on("candy:core.presence.room",n.Observer.Presence.update);i(t).on("candy:core.presence.error",n.Observer.PresenceError);i(t).on("candy:core.message",n.Observer.Message)},o=function(){t.Util.getIeVersion()<9?i(document).focusin(t.View.Pane.Window.onFocus).focusout(t.View.Pane.Window.onBlur):i(window).focus(t.View.Pane.Window.onFocus).blur(t.View.Pane.Window.onBlur);i(window).resize(t.View.Pane.Chat.fitTabs)},s=function(){n.Pane.Chat.Toolbar.init()},h=function(){i("body").delegate("li[data-tooltip]","mouseenter",t.View.Pane.Chat.Tooltip.show)};return n.init=function(n,c){c.resources&&(c.assets=c.resources,delete c.resources);i.extend(!0,u,c);f(u.language);t.Util.Parser.setEmoticonPath("img/emoticons/");r.container=n;r.container.html(Mustache.to_html(t.View.Template.Chat.pane,{tooltipEmoticons:i.i18n._("tooltipEmoticons"),tooltipSound:i.i18n._("tooltipSound"),tooltipAutoscroll:i.i18n._("tooltipAutoscroll"),tooltipStatusmessage:i.i18n._("tooltipStatusmessage"),tooltipAdministration:i.i18n._("tooltipAdministration"),tooltipUsercount:i.i18n._("tooltipUsercount")},{tabs:t.View.Template.Chat.tabs,rooms:t.View.Template.Chat.rooms,modal:t.View.Template.Chat.modal,toolbar:t.View.Template.Chat.toolbar}));o();s();e();h()},n.getCurrent=function(){return r},n.getOptions=function(){return u},n}(t.View||{},n);t.Util=function(n,i){n.jidToId=function(n){return MD5.hexdigest(n)};n.escapeJid=function(n){var i=Strophe.escapeNode(Strophe.getNodeFromJid(n)),r=Strophe.getDomainFromJid(n),t=Strophe.getResourceFromJid(n);return n=i+"@"+r,t&&(n+="/"+t),n};n.unescapeJid=function(n){var i=Strophe.unescapeNode(Strophe.getNodeFromJid(n)),r=Strophe.getDomainFromJid(n),t=Strophe.getResourceFromJid(n);return n=i+"@"+r,t&&(n+="/"+t),n};n.crop=function(n,t){return n.length>t&&(n=n.substr(0,t-3)+"..."),n};n.getDisplayName=function(n){var t=Strophe.unescapeNode(n);return t.lastIndexOf("_")>0?t.substring(0,t.lastIndexOf("_")):t};n.parseAndCropXhtml=function(t,r){return i("<div/>").append(n.createHtml(i(t).get(0),r)).html()};n.setCookie=function(n,t,i){var r=new Date;r.setDate(r.getDate()+i);document.cookie=n+"="+t+";expires="+r.toUTCString()+";path=/"};n.cookieExists=function(n){return document.cookie.indexOf(n)>-1};n.getCookie=function(n){if(document.cookie){var i=new RegExp(escape(n)+"=([^;]*)","gm"),t=i.exec(document.cookie);if(t)return t[1]}};n.deleteCookie=function(n){document.cookie=n+"=;expires=Thu, 01-Jan-70 00:00:01 GMT;path=/"};n.getPosLeftAccordingToWindowBounds=function(n,t){var f=i(document).width(),r=n.outerWidth(),e=r-n.outerWidth(!0),u="left",o=i(document).find("#candy").length>0?i("#candy").offset().left:0;return t+r>=f&&(t-=r-e,u="right"),{px:t-o,backgroundPositionAlignment:u}};n.getPosTopAccordingToWindowBounds=function(n,t){var f=i(document).height(),r=n.outerHeight(),e=r-n.outerHeight(!0),u="top",o=i(document).find("#candy").length>0?i("#candy").offset().top:0;return t+r>=f&&(t-=r-e,u="bottom"),{px:t-o,backgroundPositionAlignment:u}};n.localizedTime=function(t){if(t===undefined)return undefined;var r=n.iso8601toDate(t);return r.toDateString()===(new Date).toDateString()?r.format(i.i18n._("timeFormat")):r.format(i.i18n._("dateFormat"))};n.iso8601toDate=function(n){var r=Date.parse(n),t,i;if(isNaN(r)){if(t=/^(\d{4}|[+\-]\d{6})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?))?/.exec(n),t)return i=0,t[8]!=="Z"&&(i=+t[10]*60+ +t[11],t[9]==="+"&&(i=-i)),i-=(new Date).getTimezoneOffset(),new Date(+t[1],+t[2]-1,+t[3],+t[4],+t[5]+i,+t[6],t[7]?+t[7].substr(0,3):0);r=Date.parse(n.replace(/^(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")+"Z")}return new Date(r)};n.isEmptyObject=function(n){for(var t in n)if(n.hasOwnProperty(t))return!1;return!0};n.forceRedraw=function(n){n.css({display:"none"});setTimeout(function(){this.css({display:"block"})}.bind(n),1)};var r=function(){for(var i,n=3,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+ ++n+"]><i><\/i><![endif]-->",r[0];);return n>4?n:i}();return n.getIeVersion=function(){return r},n.Parser={_emoticonPath:"",setEmoticonPath:function(n){t.View.getOptions().assets&&(this._emoticonPath=t.View.getOptions().assets+n)},emoticons:[{plain:":)",regex:/((\s):-?\)|:-?\)(\s|$))/gm,image:"Smiling.png"},{plain:";)",regex:/((\s);-?\)|;-?\)(\s|$))/gm,image:"Winking.png"},{plain:":D",regex:/((\s):-?D|:-?D(\s|$))/gm,image:"Grinning.png"},{plain:"XD",regex:/((\s)XD|XD(\s|$))/gm,image:"Laughing.png"},{plain:":(",regex:/((\s):-?\(|:-?\((\s|$))/gm,image:"Unhappy.png"},{plain:"^^",regex:/((\s)\^\^|\^\^(\s|$))/gm,image:"Happy.png"},{plain:":P",regex:/((\s):-?P|:-?P(\s|$))/igm,image:"Tease.png"},{plain:";P",regex:/((\s);-?P|;-?P(\s|$))/igm,image:"Tongue_Out_Winking.png"},{plain:":S",regex:/((\s):-?S|:-?S(\s|$))/igm,image:"Confused.png"},{plain:":/",regex:/((\s):-?\/|:-?\/(\s|$))/gm,image:"Uncertain.png"},{plain:"8)",regex:/((\s)8-?\)|8-?\)(\s|$))/gm,image:"Cool.png"},{plain:":OK:",regex:/((\s):OK:|:OK:(\s|$))/gm,image:"Thumb_Up.png"},{plain:"oO",regex:/((\s)oO|oO(\s|$))/gm,image:"Huh.png"},{plain:":x",regex:/((\s):x|:x(\s|$))/gm,image:"Lips_Sealed.png"},{plain:":666:",regex:/((\s):666:|:666:(\s|$))/gm,image:"Devil.png"},{plain:"<3",regex:/((\s)&lt;3|&lt;3(\s|$))/gm,image:"Heart.png"}],emotify:function(n){if(!t.View.getOptions().assets)return n;for(var i=this.emoticons.length-1;i>=0;i--)n=n.replace(this.emoticons[i].regex,'$2<img class="emoticon" alt="$1" src="'+this._emoticonPath+this.emoticons[i].image+'" />$3');return n},linkify:function(n){return n=n.replace(/(^|[^\/])(www\.[^\.]+\.[\S]+(\b|$))/gi,"$1http://$2"),n.replace(/(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/ig,'<a href="$1" target="_blank">$1<\/a>')},escape:function(n){return i("<div/>").text(n).html()},nl2br:function(n){return n.replace(/\r\n|\r|\n/g,"<br />")},all:function(n){return n&&(n=this.escape(n),n=this.linkify(n),n=this.emotify(n),n=this.nl2br(n)),n}},n.createHtml=function(r,u,f){var e,s,a,l,c,o,v,y,p,w,b,h;if(f=f||0,r.nodeType===Strophe.ElementType.NORMAL)if(l=r.nodeName.toLowerCase(),Strophe.XHTML.validTag(l))try{for(s=i("<"+l+"/>"),e=0;e<Strophe.XHTML.attributes[l].length;e++)if(c=Strophe.XHTML.attributes[l][e],o=r.getAttribute(c),typeof o!="undefined"&&o!==null&&o!==""&&o!==!1&&o!==0)if(c==="style"&&typeof o=="object"&&typeof o.cssText!="undefined"&&(o=o.cssText),c==="style"){for(v=[],y=o.split(";"),a=0;a<y.length;a++)p=y[a].split(":"),w=p[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),Strophe.XHTML.validCSS(w)&&(b=p[1].replace(/^\s*/,"").replace(/\s*$/,""),v.push(w+": "+b));v.length>0&&(o=v.join("; "),s.attr(c,o))}else s.attr(c,o);for(e=0;e<r.childNodes.length;e++)s.append(n.createHtml(r.childNodes[e],u,f))}catch(k){t.Core.log("[Util:createHtml] Error while parsing XHTML:");t.Core.log(k);s=Strophe.xmlTextNode("")}else for(s=Strophe.xmlGenerator().createDocumentFragment(),e=0;e<r.childNodes.length;e++)s.appendChild(n.createHtml(r.childNodes[e],u,f));else if(r.nodeType===Strophe.ElementType.FRAGMENT)for(s=Strophe.xmlGenerator().createDocumentFragment(),e=0;e<r.childNodes.length;e++)s.appendChild(n.createHtml(r.childNodes[e],u,f));else r.nodeType===Strophe.ElementType.TEXT&&(h=r.nodeValue,f+=h.length,u&&f>u&&(h=h.substring(0,u)),h=t.Util.Parser.all(h),s=i.parseHTML(h));return s},n}(t.Util||{},n);t.Core.Action=function(n,i,r){return n.Jabber={Version:function(n){t.Core.getConnection().sendIQ($iq({type:"result",to:t.Util.escapeJid(n.attr("from")),from:t.Util.escapeJid(n.attr("to")),id:n.attr("id")}).c("query",{name:t.about.name,version:t.about.version,os:navigator.userAgent}))},SetNickname:function(n,i){i=i instanceof Array?i:t.Core.getRooms();var u,f,e=t.Core.getConnection();r.each(i,function(i){u=t.Util.escapeJid(i+"/"+n);f=$pres({to:u,from:e.jid,id:"pres:"+e.getUniqueId()});t.Core.getConnection().send(f)})},Roster:function(){t.Core.getConnection().sendIQ($iq({type:"get",xmlns:i.NS.CLIENT}).c("query",{xmlns:i.NS.ROSTER}).tree())},Presence:function(n,i){var r=t.Core.getConnection(),u;n=n||{};n.id||(n.id="pres:"+r.getUniqueId());u=$pres(n).c("priority").t(t.Core.getOptions().presencePriority.toString()).up().c("c",r.caps.generateCapsAttrs()).up();i&&u.node.appendChild(i.node);r.send(u.tree())},Services:function(){t.Core.getConnection().sendIQ($iq({type:"get",xmlns:i.NS.CLIENT}).c("query",{xmlns:i.NS.DISCO_ITEMS}).tree())},Autojoin:function(){if(t.Core.getOptions().autojoin===!0){t.Core.getConnection().sendIQ($iq({type:"get",xmlns:i.NS.CLIENT}).c("query",{xmlns:i.NS.PRIVATE}).c("storage",{xmlns:i.NS.BOOKMARKS}).tree());var u=t.Core.getConnection().getUniqueId("pubsub");t.Core.addHandler(t.Core.Event.Jabber.Bookmarks,i.NS.PUBSUB,"iq","result",u);t.Core.getConnection().sendIQ($iq({type:"get",id:u}).c("pubsub",{xmlns:i.NS.PUBSUB}).c("items",{node:i.NS.BOOKMARKS}).tree())}else r.isArray(t.Core.getOptions().autojoin)?r.each(t.Core.getOptions().autojoin,function(){n.Jabber.Room.Join.apply(null,this.valueOf().split(":",2))}):r(t).triggerHandler("candy:core.autojoin-missing")},ResetIgnoreList:function(){t.Core.getConnection().sendIQ($iq({type:"set",from:t.Core.getUser().getEscapedJid()}).c("query",{xmlns:i.NS.PRIVACY}).c("list",{name:"ignore"}).c("item",{action:"allow",order:"0"}).tree())},RemoveIgnoreList:function(){t.Core.getConnection().sendIQ($iq({type:"set",from:t.Core.getUser().getEscapedJid()}).c("query",{xmlns:i.NS.PRIVACY}).c("list",{name:"ignore"}).tree())},GetIgnoreList:function(){var n=$iq({type:"get",from:t.Core.getUser().getEscapedJid()}).c("query",{xmlns:i.NS.PRIVACY}).c("list",{name:"ignore"}).tree(),r=t.Core.getConnection().sendIQ(n);t.Core.addHandler(t.Core.Event.Jabber.PrivacyList,null,"iq",null,r)},SetIgnoreListActive:function(){t.Core.getConnection().sendIQ($iq({type:"set",from:t.Core.getUser().getEscapedJid()}).c("query",{xmlns:i.NS.PRIVACY}).c("active",{name:"ignore"}).tree())},GetJidIfAnonymous:function(){t.Core.getUser().getJid()||(t.Core.debug("[Jabber] Anonymous login"),t.Core.getUser().data.jid=t.Core.getConnection().jid)},Room:{Join:function(r,u){n.Jabber.Room.Disco(r);r=t.Util.escapeJid(r);var f=t.Core.getConnection(),o=r+"/"+t.Core.getUser().getNick(),e=$pres({to:o,id:"pres:"+f.getUniqueId()}).c("x",{xmlns:i.NS.MUC});u&&e.c("password").t(u);e.up().c("c",f.caps.generateCapsAttrs());f.send(e.tree())},Leave:function(n){var r=t.Core.getRoom(n),i;r&&(i=r.getUser(),i&&(n=t.Util.escapeJid(n),t.Core.getConnection().muc.leave(n,i.getNick(),function(){})))},Disco:function(n){t.Core.getConnection().sendIQ($iq({type:"get",from:t.Core.getUser().getEscapedJid(),to:t.Util.escapeJid(n)}).c("query",{xmlns:i.NS.DISCO_INFO}).tree())},Message:function(n,u,f,e){if(u=r.trim(u),u==="")return!1;var o=null;return f==="chat"&&(o=i.getResourceFromJid(n),n=i.getBareJidFromJid(n)),t.Core.getConnection().muc.message(n,o,u,e,f),!0},Invite:function(n,u,f,e){f=r.trim(f);var s=$msg({to:n}),o=s.c("x",{xmlns:i.NS.MUC_USER});r.each(u,function(n,t){t=i.getBareJidFromJid(t);o.c("invite",{to:t});typeof f!="undefined"&&f!==""&&o.c("reason",f)});typeof e!="undefined"&&e!==""&&o.c("password",e);t.Core.getConnection().send(s)},IgnoreUnignore:function(n){t.Core.getUser().addToOrRemoveFromPrivacyList("ignore",n);t.Core.Action.Jabber.Room.UpdatePrivacyList()},UpdatePrivacyList:function(){var i=t.Core.getUser(),n=$iq({type:"set",from:i.getEscapedJid()}).c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"ignore"}),u=i.getPrivacyList("ignore");u.length>0?r.each(u,function(i,r){n.c("item",{type:"jid",value:t.Util.escapeJid(r),action:"deny",order:i}).c("message").up().up()}):n.c("item",{action:"allow",order:"0"});t.Core.getConnection().sendIQ(n.tree())},Admin:{UserAction:function(n,r,u,f){n=t.Util.escapeJid(n);r=t.Util.escapeJid(r);var e={nick:i.getResourceFromJid(r)};switch(u){case"kick":e.role="none";break;case"ban":e.affiliation="outcast";break;default:return!1}return t.Core.getConnection().sendIQ($iq({type:"set",from:t.Core.getUser().getEscapedJid(),to:n}).c("query",{xmlns:i.NS.MUC_ADMIN}).c("item",e).c("reason").t(f).tree()),!0},SetSubject:function(n,i){t.Core.getConnection().muc.setTopic(t.Util.escapeJid(n),i)}}}},n}(t.Core.Action||{},Strophe,n);t.Core.ChatRoom=function(n){this.room={jid:n,name:Strophe.getNodeFromJid(n)};this.user=null;this.roster=new t.Core.ChatRoster;this.setUser=function(n){this.user=n;t.Core.updateCache()};this.getUser=function(){return this.user};this.getJid=function(){return this.room.jid};this.setName=function(n){this.room.name=n;t.Core.updateCache()};this.getName=function(){return this.room.name};this.setRoster=function(n){this.roster=n;t.Core.updateCache()};this.getRoster=function(){return this.roster}};t.Core.ChatRoster=function(){this.items={};this.add=function(n){this.items[n.getJid()]=n};this.remove=function(n){delete this.items[n]};this.get=function(n){return this.items[n]};this.getAll=function(){return this.items}};t.Core.ChatUser=function(n,i,r,u){this.ROLE_MODERATOR="moderator";this.AFFILIATION_OWNER="owner";this.data={jid:n,nick:Strophe.unescapeNode(i),affiliation:r,role:u,privacyLists:{},customData:{},previousNick:undefined};this.getJid=function(){if(this.data.jid)return t.Util.unescapeJid(this.data.jid)};this.getEscapedJid=function(){return t.Util.escapeJid(this.data.jid)};this.setJid=function(n){this.data.jid=n};this.getNick=function(n){var t=Strophe.unescapeNode(this.data.nick);return n&&t.lastIndexOf("_")>0?t.substring(0,t.lastIndexOf("_")):t};this.setNick=function(n){this.data.nick=n};this.getRole=function(){return this.data.role};this.setRole=function(n){this.data.role=n};this.setAffiliation=function(n){this.data.affiliation=n};this.getAffiliation=function(){return this.data.affiliation};this.isModerator=function(){return this.getRole()===this.ROLE_MODERATOR||this.getAffiliation()===this.AFFILIATION_OWNER};this.addToOrRemoveFromPrivacyList=function(n,t){this.data.privacyLists[n]||(this.data.privacyLists[n]=[]);var i=-1;return(i=this.data.privacyLists[n].indexOf(t))!==-1?this.data.privacyLists[n].splice(i,1):this.data.privacyLists[n].push(t),this.data.privacyLists[n]};this.getPrivacyList=function(n){return this.data.privacyLists[n]||(this.data.privacyLists[n]=[]),this.data.privacyLists[n]};this.setPrivacyLists=function(n){this.data.privacyLists=n};this.isInPrivacyList=function(n,t){return this.data.privacyLists[n]?this.data.privacyLists[n].indexOf(t)!==-1:!1};this.setCustomData=function(n){this.data.customData=n};this.getCustomData=function(){return this.data.customData};this.setPreviousNick=function(n){this.data.previousNick=n};this.getPreviousNick=function(){return this.data.previousNick}};t.Core.Event=function(n,i,r){return n.Login=function(n){r(t).triggerHandler("candy:core.login",{presetJid:n})},n.Strophe={Connect:function(n){t.Core.setStropheStatus(n);switch(n){case i.Status.CONNECTED:t.Core.log("[Connection] Connected");t.Core.Action.Jabber.GetJidIfAnonymous();t.Core.updateCache();case i.Status.ATTACHED:t.Core.log("[Connection] Attached");t.Core.Action.Jabber.Presence();break;case i.Status.DISCONNECTED:t.Core.log("[Connection] Disconnected");break;case i.Status.AUTHFAIL:t.Core.log("[Connection] Authentication failed");t.Core.clearCache();break;case i.Status.CONNECTING:t.Core.log("[Connection] Connecting");break;case i.Status.DISCONNECTING:t.Core.log("[Connection] Disconnecting");t.Core.clearCache();break;case i.Status.AUTHENTICATING:t.Core.log("[Connection] Authenticating");break;case i.Status.ERROR:case i.Status.CONNFAIL:t.Core.log("[Connection] Failed ("+n+")");t.Core.clearCache();break;default:t.Core.log("[Connection] What?!");t.Core.clearCache()}r(t).triggerHandler("candy:core.chat.connection",{status:n})}},n.Jabber={Version:function(n){return t.Core.debug("[Jabber] Version"),t.Core.Action.Jabber.Version(r(n)),!0},Presence:function(u){return t.Core.debug("[Jabber] Presence"),u=r(u),u.children('x[xmlns^="'+i.NS.MUC+'"]').length>0?u.attr("type")==="error"?n.Jabber.Room.PresenceError(u):n.Jabber.Room.Presence(u):r(t).triggerHandler("candy:core.presence",{from:u.attr("from"),stanza:u}),!0},Bookmarks:function(n){return t.Core.debug("[Jabber] Bookmarks"),r("conference",n).each(function(){var n=r(this);n.attr("autojoin")&&t.Core.Action.Jabber.Room.Join(n.attr("jid"))}),!0},PrivacyList:function(i){t.Core.debug("[Jabber] PrivacyList");var u=t.Core.getUser();return(i=r(i),i.attr("type")==="result")?(r('list[name="ignore"] item',i).each(function(){var n=r(this);n.attr("action")==="deny"&&u.addToOrRemoveFromPrivacyList("ignore",n.attr("value"))}),t.Core.Action.Jabber.SetIgnoreListActive(),!1):n.Jabber.PrivacyListError(i)},PrivacyListError:function(n){return r('error[code="503"][type="cancel"] service-unavailable',n)?!1:(t.Core.log("[Jabber] PrivacyListError"),r('error[code="404"][type="cancel"] item-not-found',n)&&(t.Core.Action.Jabber.ResetIgnoreList(),t.Core.Action.Jabber.SetIgnoreListActive()),!1)},Message:function(u){var s,o;t.Core.debug("[Jabber] Message");u=r(u);var e=u.attr("from"),f=u.attr("type")||"undefined",h=u.attr("to");if(f==="normal"||f==="undefined"){if(s=u.find("invite"),o=u.find('x[xmlns="jabber:x:conference"]'),s.length>0){var c=u.find("password"),l=null,a=s.find("continue"),v=null;c&&(l=c.text());a&&(v=a.attr("thread"));r(t).triggerHandler("candy:core:chat:invite",{roomJid:e,from:s.attr("from")||"undefined",reason:s.find("reason")||"",password:l,continuedThread:v,inviteType:"MediatedInvite"})}return o.length>0&&r(t).triggerHandler("candy:core:chat:invite",{roomJid:o.attr("jid"),from:e,reason:o.attr("reason")||"",password:o.attr("password"),continuedThread:o.attr("thread"),inviteType:"DirectInvite"}),r(t).triggerHandler("candy:core:chat:message:normal",{type:f||"normal",message:u}),!0}return f!=="groupchat"&&f!=="chat"&&f!=="error"&&f!=="headline"?(r(t).triggerHandler("candy:core:chat:message:other",{type:f,message:u}),!0):(e!==i.getDomainFromJid(e)&&(f==="groupchat"||f==="chat"||f==="error")?n.Jabber.Room.Message(u):h||e!==i.getDomainFromJid(e)?h&&e===i.getDomainFromJid(e)&&r(t).triggerHandler("candy:core.chat.message.server",{type:f||"message",subject:u.children("subject").text(),message:u.children("body").text()}):r(t).triggerHandler("candy:core.chat.message.admin",{type:f||"message",message:u.children("body").text()}),!0)},Room:{Leave:function(n){var e,u,s,l;if(t.Core.debug("[Jabber:Room] Leave"),n=r(n),e=t.Util.unescapeJid(n.attr("from")),u=i.getBareJidFromJid(e),!t.Core.getRoom(u))return!0;var a=t.Core.getRoom(u).getName(),f=n.find("item"),o="leave",h,c;return delete t.Core.getRooms()[u],t.Core.updateCache(),f.attr("role")==="none"&&(s=n.find("status").attr("code"),s==="307"?o="kick":s==="301"&&(o="ban"),h=f.find("reason").text(),c=f.find("actor").attr("jid")),l=new t.Core.ChatUser(e,i.getResourceFromJid(e),f.attr("affiliation"),f.attr("role")),r(t).triggerHandler("candy:core.presence.leave",{roomJid:u,roomName:a,type:o,reason:h,actor:c,user:l}),!0},Disco:function(n){var u,f,o,e;return(t.Core.debug("[Jabber:Room] Disco"),n=r(n),!n.find('identity[category="conference"]').length)?!0:(u=i.getBareJidFromJid(t.Util.unescapeJid(n.attr("from"))),t.Core.getRooms()[u]||(t.Core.getRooms()[u]=new t.Core.ChatRoom(u)),f=n.find("identity"),f.length&&(o=f.attr("name"),e=t.Core.getRoom(u),e.getName()===null&&e.setName(i.unescapeNode(o))),t.Core.updateCache(),!0)},Presence:function(u){var v,g,nt,b,o,y,s,h,f,l,c,tt,it;t.Core.debug("[Jabber:Room] Presence");var e=t.Util.unescapeJid(u.attr("from")),a=i.getBareJidFromJid(e),k=u.attr("type"),p=u.find("status"),d=!1,w=!1;if(p.length)for(v=0,g=p.length;v<g;v++)nt=r(p[v]),b=nt.attr("code"),b==="303"?w=!0:b==="210"&&(d=!0);return(o=t.Core.getRoom(a),o||(t.Core.getRooms()[a]=new t.Core.ChatRoom(a),o=t.Core.getRoom(a)),y=o.getUser()?o.getUser():t.Core.getUser(),i.getResourceFromJid(e)===y.getNick()&&k==="unavailable"&&w===!1)?(n.Jabber.Room.Leave(u),!0):(s=o.getRoster(),c=u.find("item"),k!=="unavailable"?s.get(e)?(f=s.get(e),tt=c.attr("role"),it=c.attr("affiliation"),f.setRole(tt),f.setAffiliation(it),h="join"):(l=i.getResourceFromJid(e),f=new t.Core.ChatUser(e,l,c.attr("affiliation"),c.attr("role")),o.getUser()===null&&(t.Core.getUser().getNick()===l||d)&&(o.setUser(f),y=f),s.add(f),h="join"):(f=s.get(e),s.remove(e),w?(l=c.attr("nick"),h="nickchange",f.setPreviousNick(f.getNick()),f.setNick(l),f.setJid(i.getBareJidFromJid(e)+"/"+l),s.add(f)):(h="leave",c.attr("role")==="none"&&(u.find("status").attr("code")==="307"?h="kick":u.find("status").attr("code")==="301"&&(h="ban")))),r(t).triggerHandler("candy:core.presence.room",{roomJid:a,roomName:o.getName(),user:f,action:h,currentUser:y}),t.Core.updateCache(),!0)},PresenceError:function(n){t.Core.log("[Jabber:Room] Presence Error");var e=t.Util.unescapeJid(n.attr("from")),u=i.getBareJidFromJid(e),f=t.Core.getRooms()[u],o=f&&f.getName()||null;return t.Core.removeRoom(u),f=undefined,r(t).triggerHandler("candy:core.presence.error",{msg:n,type:n.children("error").children()[0].tagName.toLowerCase(),roomJid:u,roomName:o}),!0},Message:function(n){var u,f,s,l,a,o,w,v,h,c,e,y,b,p,k;if(t.Core.debug("[Jabber:Room] Message"),n.children("subject").length>0&&n.children("subject").text().length>0&&n.attr("type")==="groupchat")u=t.Util.unescapeJid(i.getBareJidFromJid(n.attr("from"))),f={name:i.getNodeFromJid(u),body:n.children("subject").text(),type:"subject"};else if(n.attr("type")==="error")l=n.children("error"),l.children("text").length>0&&(u=n.attr("from"),f={type:"info",body:l.children("text").text()});else{if(n.children("composing").length>0||n.children("inactive").length>0||n.children("paused").length>0||n.children("gone").length>0)return a=t.Util.unescapeJid(n.attr("from")),u=i.getBareJidFromJid(a),s=i.getResourceFromJid(a),n.children("active").length>0?o="active":n.children("composing").length>0?o="composing":n.children("paused").length>0?o="paused":n.children("inactive").length>0?o="inactive":n.children("gone").length>0&&(o="gone"),r(t).triggerHandler("candy:core.message.chatstate",{name:s,displayName:t.Util.getDisplayName(s),roomJid:u,chatstate:o}),!0;if(n.children("body").length>=0){if(n.attr("type")==="chat"||n.attr("type")==="normal")u=t.Util.unescapeJid(n.attr("from")),w=i.getBareJidFromJid(u),v=!t.Core.getRoom(w),s=v?i.getNodeFromJid(u):i.getResourceFromJid(u),f={name:s,body:n.children("body").text(),type:n.attr("type"),isNoConferenceRoomJid:v};else if(u=t.Util.unescapeJid(i.getBareJidFromJid(n.attr("from"))),h=i.getResourceFromJid(n.attr("from")),h)h=i.unescapeNode(h),f={name:h,body:n.children("body").text(),type:n.attr("type")};else{if(!t.View.Pane.Chat.rooms[n.attr("from")])return!0;f={name:"",body:n.children("body").text(),type:"info"}}for(c=[],e=0;e<n[0].attributes.length;e++)c.push(n[0].attributes[e]);for(f.attributes={},e=0;e<c.length;e++)f.attributes[c[e].name]=c[e].value;y=n.children('html[xmlns="'+i.NS.XHTML_IM+'"]');t.View.getOptions().enableXHTML===!0&&y.length>0&&(b=y.children('body[xmlns="'+i.NS.XHTML+'"]').first().html(),f.xhtmlMessage=b)}else return!0}return p=n.children("delay")?n.children("delay"):n.children('x[xmlns="'+i.NS.DELAY+'"]'),k=p!==undefined?p.attr("stamp"):null,r(t).triggerHandler("candy:core.message",{roomJid:u,message:f,timestamp:k}),!0}}},n}(t.Core.Event||{},Strophe,n);t.View.Observer=function(n,i){var r=!0;return n.Chat={Connection:function(n,u){var e="candy:view.connection.status-"+u.status,f;if(i(t).triggerHandler(e)===!1)return!1;switch(u.status){case Strophe.Status.CONNECTING:case Strophe.Status.AUTHENTICATING:t.View.Pane.Chat.Modal.show(i.i18n._("statusConnecting"),!1,!0);break;case Strophe.Status.ATTACHED:case Strophe.Status.CONNECTED:r===!0&&(t.View.Pane.Chat.Modal.show(i.i18n._("statusConnected")),t.View.Pane.Chat.Modal.hide());break;case Strophe.Status.DISCONNECTING:t.View.Pane.Chat.Modal.show(i.i18n._("statusDisconnecting"),!1,!0);break;case Strophe.Status.DISCONNECTED:f=t.Core.isAnonymousConnection()?Strophe.getDomainFromJid(t.Core.getUser().getJid()):null;t.View.Pane.Chat.Modal.showLoginForm(i.i18n._("statusDisconnected"),f);break;case Strophe.Status.AUTHFAIL:t.View.Pane.Chat.Modal.showLoginForm(i.i18n._("statusAuthfail"));break;default:t.View.Pane.Chat.Modal.show(i.i18n._("status",u.status))}},Message:function(n,i){if(i.type==="message")t.View.Pane.Chat.adminMessage(i.subject||"",i.message);else if(i.type==="chat"||i.type==="groupchat")t.View.Pane.Chat.onInfoMessage(t.View.getCurrent().roomJid,i.subject||"",i.message)}},n.Presence={update:function(n,r){if(r.type==="leave"||r.type==="kick"||r.type==="ban"){var u={type:r.type,reason:r.reason,roomJid:r.roomJid,user:r.user};i(t).triggerHandler("candy:view.presence",[u])}else if(r.roomJid){if(!r.user)return!1;if(r.roomJid=t.Util.unescapeJid(r.roomJid),!t.View.Pane.Chat.rooms[r.roomJid]){if(t.View.Pane.Room.init(r.roomJid,r.roomName)===!1)return!1;i("#chat-rooms").children().length===1&&t.View.Pane.Room.show(r.roomJid)}t.View.Pane.Roster.update(r.roomJid,r.user,r.action,r.currentUser);t.View.Pane.Chat.rooms[r.user.getJid()]&&r.action!=="nickchange"&&(t.View.Pane.Roster.update(r.user.getJid(),r.user,r.action,r.currentUser),t.View.Pane.PrivateRoom.setStatus(r.user.getJid(),r.action))}},notifyPrivateChats:function(n,i){t.Core.log("[View:Observer] notify Private Chats");for(var r in t.View.Pane.Chat.rooms)t.View.Pane.Chat.rooms.hasOwnProperty(r)&&t.View.Pane.Room.getUser(r)&&n.getJid()===t.View.Pane.Room.getUser(r).getJid()&&(t.View.Pane.Roster.update(r,n,i,n),t.View.Pane.PrivateRoom.setStatus(r,i))}},n.PresenceError=function(n,r){switch(r.type){case"not-authorized":var u;r.msg.children("x").children("password").length>0&&(u=i.i18n._("passwordEnteredInvalid",[r.roomName]));t.View.Pane.Chat.Modal.showEnterPasswordForm(r.roomJid,r.roomName,u);break;case"conflict":t.View.Pane.Chat.Modal.showNicknameConflictForm(r.roomJid);break;case"registration-required":t.View.Pane.Chat.Modal.showError("errorMembersOnly",[r.roomName]);break;case"service-unavailable":t.View.Pane.Chat.Modal.showError("errorMaxOccupantsReached",[r.roomName])}},n.Message=function(n,i){t.View.Pane.Chat.rooms[i.roomJid]||(t.View.Pane.Room.init(i.roomJid,i.message.name),t.View.Pane.Room.setUser(i.roomJid,t.Core.getUser()),t.View.Pane.Room.show(i.roomJid));i.message.type==="subject"?t.View.Pane.Room.setSubject(i.roomJid,i.message.body):i.message.type==="info"?t.View.Pane.Chat.infoMessage(i.roomJid,i.message.body):(i.message.type!=="chat"||t.View.Pane.Chat.rooms[i.roomJid]||t.View.Pane.PrivateRoom.open(i.roomJid,i.message.name,!1,i.message.isNoConferenceRoomJid),t.View.Pane.Message.show(i.roomJid,i.message.name,i.message.body,i.message.xhtmlMessage,i.timestamp,i.message.attributes))},n.Login=function(n,i){t.View.Pane.Chat.Modal.showLoginForm(null,i.presetJid)},n.AutojoinMissing=function(){r=!1;t.View.Pane.Chat.Modal.showError("errorAutojoinMissing")},n}(t.View.Observer||{},n);t.View.Pane=function(n,i){return n.Window={_hasFocus:!0,_plainTitle:document.title,_unreadMessagesCount:0,autoscroll:!0,hasFocus:function(){return n.Window._hasFocus},increaseUnreadMessages:function(){n.Window.renderUnreadMessages(++n.Window._unreadMessagesCount)},reduceUnreadMessages:function(t){n.Window._unreadMessagesCount-=t;n.Window._unreadMessagesCount<=0?n.Window.clearUnreadMessages():n.Window.renderUnreadMessages(n.Window._unreadMessagesCount)},clearUnreadMessages:function(){n.Window._unreadMessagesCount=0;document.title=n.Window._plainTitle},renderUnreadMessages:function(i){document.title=t.View.Template.Window.unreadmessages.replace("{{count}}",i).replace("{{title}}",n.Window._plainTitle)},onFocus:function(){n.Window._hasFocus=!0;t.View.getCurrent().roomJid&&(n.Room.setFocusToForm(t.View.getCurrent().roomJid),n.Chat.clearUnreadMessages(t.View.getCurrent().roomJid))},onBlur:function(){n.Window._hasFocus=!1}},n.Chat={rooms:[],addTab:function(r,u,f){var o=t.Util.jidToId(r),s=Mustache.to_html(t.View.Template.Chat.tab,{roomJid:r,roomId:o,name:u||Strophe.getNodeFromJid(r),privateUserChat:function(){return f==="chat"},roomType:f}),e=i(s).appendTo("#chat-tabs");e.click(n.Chat.tabClick);i("a.close",e).click(n.Chat.tabClose);n.Chat.clearUnreadMessages(r);n.Chat.fitTabs()},getTab:function(n){return i("#chat-tabs").children('li[data-roomjid="'+n+'"]')},removeTab:function(t){n.Chat.getTab(t).remove();n.Chat.fitTabs()},setActiveTab:function(n){i("#chat-tabs").children().each(function(){var t=i(this);t.attr("data-roomjid")===n?t.addClass("active"):t.removeClass("active")})},increaseUnreadMessages:function(t){var i=this.getTab(t).find(".unread");i.show().text(i.text()!==""?parseInt(i.text(),10)+1:1);n.Chat.rooms[t].type==="chat"&&n.Window.increaseUnreadMessages()},clearUnreadMessages:function(t){var i=n.Chat.getTab(t).find(".unread");n.Window.reduceUnreadMessages(i.text());i.hide().text("")},tabClick:function(r){var u=t.View.getCurrent().roomJid;n.Chat.rooms[u].scrollPosition=n.Room.getPane(u,".message-pane-wrapper").scrollTop();n.Room.show(i(this).attr("data-roomjid"));r.preventDefault()},tabClose:function(){var r=i(this).parent().attr("data-roomjid");return n.Chat.rooms[r].type==="chat"?n.Room.close(r):t.Core.Action.Jabber.Room.Leave(r),!1},allTabsClosed:function(){n.Chat.Toolbar.hide();t.Core.getOptions().disconnectWithoutTabs&&t.Core.disconnect()},fitTabs:function(){var t=i("#chat-tabs").innerWidth(),r=0,n=i("#chat-tabs").children(),u,f;n.each(function(){r+=i(this).css({width:"auto",overflow:"visible"}).outerWidth(!0)});r>t&&(u=n.outerWidth(!0)-n.width(),f=Math.floor(t/n.length)-u,n.css({width:f,overflow:"hidden"}))},adminMessage:function(r,u){if(t.View.getCurrent().roomJid){var f=Mustache.to_html(t.View.Template.Chat.adminMessage,{subject:r,message:u,sender:i.i18n._("administratorMessageSubject"),time:t.Util.localizedTime((new Date).toGMTString())});i("#chat-rooms").children().each(function(){n.Room.appendToMessagePane(i(this).attr("data-roomjid"),f)});i(t).triggerHandler("candy:view.chat.admin-message",{subject:r,message:u})}},infoMessage:function(t,i,r){n.Chat.onInfoMessage(t,i,r)},onInfoMessage:function(r,u,f){if(t.View.Pane.Room.getPane(r)){var e=Mustache.to_html(t.View.Template.Chat.infoMessage,{subject:u,message:i.i18n._(f),time:t.Util.localizedTime((new Date).toGMTString())});n.Room.appendToMessagePane(r,e)}},Toolbar:{_supportsNativeAudio:null,init:function(){i("#emoticons-icon").click(function(t){n.Chat.Context.showEmoticonsMenu(t.currentTarget);t.stopPropagation()});i("#chat-autoscroll-control").click(n.Chat.Toolbar.onAutoscrollControlClick);try{if(!!document.createElement("audio").canPlayType){var r=document.createElement("audio");r.canPlayType("audio/mpeg;").replace(/no/,"")?n.Chat.Toolbar._supportsNativeAudio="mp3":r.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")?n.Chat.Toolbar._supportsNativeAudio="ogg":!r.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,"")||(n.Chat.Toolbar._supportsNativeAudio="m4a")}}catch(u){t.Core.log("[View:Pane:Toolbar] init error:");t.Core.log(u)}i("#chat-sound-control").click(n.Chat.Toolbar.onSoundControlClick);t.Util.cookieExists("candy-nosound")&&i("#chat-sound-control").click();i("#chat-statusmessage-control").click(n.Chat.Toolbar.onStatusMessageControlClick);t.Util.cookieExists("candy-nostatusmessages")&&i("#chat-statusmessage-control").click()},show:function(){i("#chat-toolbar").show()},hide:function(){i("#chat-toolbar").hide()},update:function(t){var r=i("#chat-toolbar").find(".context"),u=n.Room.getUser(t);u&&u.isModerator()?r.show().click(function(i){n.Chat.Context.show(i.currentTarget,t);i.stopPropagation()}):r.hide();n.Chat.Toolbar.updateUsercount(n.Chat.rooms[t].usercount)},playSound:function(t){n.Chat.Toolbar.onPlaySound(t)},onPlaySound:function(r){if(t.View.getOptions().assets){var u=r||"new_message";try{n.Chat.Toolbar._supportsNativeAudio!==null?new Audio(t.View.getOptions().assets+"sfx/"+u+"."+n.Chat.Toolbar._supportsNativeAudio).play():(i("#chat-sound-control bgsound").remove(),i("<bgsound/>").attr({src:t.View.getOptions().assets+"sfx/"+u+".mp3",loop:1,autostart:!0}).appendTo("#chat-sound-control"))}catch(f){t.Core.log("[View:Pane:Toolbar] onPlaySound error:");t.Core.log(f)}}},onSoundControlClick:function(){var r=i("#chat-sound-control");r.hasClass("checked")?(n.Chat.Toolbar.playSound=function(){},t.Util.setCookie("candy-nosound","1",365)):(n.Chat.Toolbar.playSound=function(t){n.Chat.Toolbar.onPlaySound(t)},t.Util.deleteCookie("candy-nosound"),n.Chat.Toolbar.playSound("toggle_on"));r.toggleClass("checked")},onAutoscrollControlClick:function(){var r=i("#chat-autoscroll-control");r.hasClass("checked")?(n.Room.scrollToBottom=function(t){n.Room.onScrollToStoredPosition(t)},n.Window.autoscroll=!1):(n.Room.scrollToBottom=function(t){n.Room.onScrollToBottom(t)},n.Room.scrollToBottom(t.View.getCurrent().roomJid),n.Window.autoscroll=!0);r.toggleClass("checked")},onStatusMessageControlClick:function(){var r=i("#chat-statusmessage-control");r.hasClass("checked")?(n.Chat.infoMessage=function(){},t.Util.setCookie("candy-nostatusmessages","1",365)):(n.Chat.infoMessage=function(t,i,r){n.Chat.onInfoMessage(t,i,r)},t.Util.deleteCookie("candy-nostatusmessages"));r.toggleClass("checked")},updateUsercount:function(n){i("#chat-usercount").text(n)}},Modal:{show:function(t,r,u){r?n.Chat.Modal.showCloseControl():n.Chat.Modal.hideCloseControl();u?n.Chat.Modal.showSpinner():n.Chat.Modal.hideSpinner();i("#chat-modal").stop(!1,!0);i("#chat-modal-body").html(t);i("#chat-modal").fadeIn("fast");i("#chat-modal-overlay").show()},hide:function(n){i("#chat-modal").fadeOut("fast",function(){i("#chat-modal-body").text("");i("#chat-modal-overlay").hide()});i(document).keydown(function(n){n.which===27&&n.preventDefault()});n&&n()},showSpinner:function(){i("#chat-modal-spinner").show()},hideSpinner:function(){i("#chat-modal-spinner").hide()},showCloseControl:function(){i("#admin-message-cancel").show().click(function(t){n.Chat.Modal.hide();t.preventDefault()});i(document).keydown(function(t){t.which===27&&(n.Chat.Modal.hide(),t.preventDefault())})},hideCloseControl:function(){i("#admin-message-cancel").hide().click(function(){})},showLoginForm:function(r,u){n.Chat.Modal.show((r?r:"")+Mustache.to_html(t.View.Template.Login.form,{_labelNickname:i.i18n._("labelNickname"),_labelUsername:i.i18n._("labelUsername"),_labelPassword:i.i18n._("labelPassword"),_loginSubmit:i.i18n._("loginSubmit"),displayPassword:!t.Core.isAnonymousConnection(),displayUsername:!u,displayNickname:t.Core.isAnonymousConnection(),presetJid:u?u:!1}));i("#login-form").children(":input:first").focus();i("#login-form").submit(function(){var n=i("#username").val(),f=i("#password").val(),r;return t.Core.isAnonymousConnection()?t.Core.connect(u,null,n):(r=t.Core.getUser()&&n.indexOf("@")<0?n+"@"+Strophe.getDomainFromJid(t.Core.getUser().getJid()):n,r.indexOf("@")<0&&!t.Core.getUser()?t.View.Pane.Chat.Modal.showLoginForm(i.i18n._("loginInvalid")):t.Core.connect(r,f)),!1})},showEnterPasswordForm:function(r,u,f){n.Chat.Modal.show(Mustache.to_html(t.View.Template.PresenceError.enterPasswordForm,{roomName:u,_labelPassword:i.i18n._("labelPassword"),_label:f?f:i.i18n._("enterRoomPassword",[u]),_joinSubmit:i.i18n._("enterRoomPasswordSubmit")}),!0);i("#password").focus();i("#enter-password-form").submit(function(){var u=i("#password").val();return n.Chat.Modal.hide(function(){t.Core.Action.Jabber.Room.Join(r,u)}),!1})},showNicknameConflictForm:function(r){n.Chat.Modal.show(Mustache.to_html(t.View.Template.PresenceError.nicknameConflictForm,{_labelNickname:i.i18n._("labelNickname"),_label:i.i18n._("nicknameConflict"),_loginSubmit:i.i18n._("loginSubmit")}));i("#nickname").focus();i("#nickname-conflict-form").submit(function(){var u=i("#nickname").val();return n.Chat.Modal.hide(function(){t.Core.getUser().data.nick=u;t.Core.Action.Jabber.Room.Join(r)}),!1})},showError:function(r,u){n.Chat.Modal.show(Mustache.to_html(t.View.Template.PresenceError.displayError,{_error:i.i18n._(r,u)}),!0)}},Tooltip:{show:function(n,r){var u=i("#tooltip"),f=i(n.currentTarget),e;r||(r=f.attr("data-tooltip"));u.length===0&&(e=Mustache.to_html(t.View.Template.Chat.tooltip),i("#chat-pane").append(e),u=i("#tooltip"));i("#context-menu").hide();u.stop(!1,!0);u.children("div").html(r);var o=f.offset(),s=t.Util.getPosLeftAccordingToWindowBounds(u,o.left),h=t.Util.getPosTopAccordingToWindowBounds(u,o.top);u.css({left:s.px,top:h.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(s.backgroundPositionAlignment+"-"+h.backgroundPositionAlignment).fadeIn("fast");f.mouseleave(function(n){n.stopPropagation();i("#tooltip").stop(!1,!0).fadeOut("fast",function(){i(this).css({top:0,left:0})})})}},Context:{init:function(){if(i("#context-menu").length===0){var n=Mustache.to_html(t.View.Template.Chat.Context.menu);i("#chat-pane").append(n);i("#context-menu").mouseleave(function(){i(this).fadeOut("fast")})}},show:function(r,u,f){var s,o,c,h,l;r=i(r);var p=n.Chat.rooms[u].id,e=i("#context-menu"),w=i("ul li",e);i("#tooltip").hide();f||(f=t.Core.getUser());w.remove();s=this.getMenuLinks(u,f,r);c=function(n,t){return function(r){r.data.callback(r,n,t);i("#context-menu").hide()}};for(o in s)s.hasOwnProperty(o)&&(h=s[o],l=Mustache.to_html(t.View.Template.Chat.Context.menulinks,{roomId:p,"class":h["class"],id:o,label:h.label}),i("ul",e).append(l),i("#context-menu-"+o).bind("click",h,c(u,f)));if(o){var a=r.offset(),v=t.Util.getPosLeftAccordingToWindowBounds(e,a.left),y=t.Util.getPosTopAccordingToWindowBounds(e,a.top);return e.css({left:v.px,top:y.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(v.backgroundPositionAlignment+"-"+y.backgroundPositionAlignment).fadeIn("fast"),i(t).triggerHandler("candy:view.roster.after-context-menu",{roomJid:u,user:f,element:e}),!0}},getMenuLinks:function(r,u,f){var e,o,s={roomJid:r,user:u,elem:f,menulinks:this.initialMenuLinks(f)};i(t).triggerHandler("candy:view.roster.context-menu",s);e=s.menulinks;for(o in e)e.hasOwnProperty(o)&&e[o].requiredPermission!==undefined&&!e[o].requiredPermission(u,n.Room.getUser(r),f)&&delete e[o];return e},initialMenuLinks:function(){return{"private":{requiredPermission:function(n,i){return i.getNick()!==n.getNick()&&t.Core.getRoom(t.View.getCurrent().roomJid)&&!t.Core.getUser().isInPrivacyList("ignore",n.getJid())},"class":"private",label:i.i18n._("privateActionLabel"),callback:function(n,r,u){i("#user-"+t.Util.jidToId(r)+"-"+t.Util.jidToId(u.getJid())).click()}},ignore:{requiredPermission:function(n,i){return i.getNick()!==n.getNick()&&!t.Core.getUser().isInPrivacyList("ignore",n.getJid())},"class":"ignore",label:i.i18n._("ignoreActionLabel"),callback:function(n,i,r){t.View.Pane.Room.ignoreUser(i,r.getJid())}},unignore:{requiredPermission:function(n,i){return i.getNick()!==n.getNick()&&t.Core.getUser().isInPrivacyList("ignore",n.getJid())},"class":"unignore",label:i.i18n._("unignoreActionLabel"),callback:function(n,i,r){t.View.Pane.Room.unignoreUser(i,r.getJid())}},kick:{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&t.isModerator()&&!n.isModerator()},"class":"kick",label:i.i18n._("kickActionLabel"),callback:function(r,u,f){n.Chat.Modal.show(Mustache.to_html(t.View.Template.Chat.Context.contextModalForm,{_label:i.i18n._("reason"),_submit:i.i18n._("kickActionLabel")}),!0);i("#context-modal-field").focus();i("#context-modal-form").submit(function(){return t.Core.Action.Jabber.Room.Admin.UserAction(u,f.getJid(),"kick",i("#context-modal-field").val()),n.Chat.Modal.hide(),!1})}},ban:{requiredPermission:function(n,t){return t.getNick()!==n.getNick()&&t.isModerator()&&!n.isModerator()},"class":"ban",label:i.i18n._("banActionLabel"),callback:function(r,u,f){n.Chat.Modal.show(Mustache.to_html(t.View.Template.Chat.Context.contextModalForm,{_label:i.i18n._("reason"),_submit:i.i18n._("banActionLabel")}),!0);i("#context-modal-field").focus();i("#context-modal-form").submit(function(){return t.Core.Action.Jabber.Room.Admin.UserAction(u,f.getJid(),"ban",i("#context-modal-field").val()),n.Chat.Modal.hide(),!1})}},subject:{requiredPermission:function(n,t){return t.getNick()===n.getNick()&&t.isModerator()},"class":"subject",label:i.i18n._("setSubjectActionLabel"),callback:function(r,u){n.Chat.Modal.show(Mustache.to_html(t.View.Template.Chat.Context.contextModalForm,{_label:i.i18n._("subject"),_submit:i.i18n._("setSubjectActionLabel")}),!0);i("#context-modal-field").focus();i("#context-modal-form").submit(function(r){t.Core.Action.Jabber.Room.Admin.SetSubject(u,i("#context-modal-field").val());n.Chat.Modal.hide();r.preventDefault()})}}}},showEmoticonsMenu:function(n){var e,o;n=i(n);var s=n.offset(),u=i("#context-menu"),h=i("ul",u),f="",r;for(i("#tooltip").hide(),r=t.Util.Parser.emoticons.length-1;r>=0;r--)f='<img src="'+t.Util.Parser._emoticonPath+t.Util.Parser.emoticons[r].image+'" alt="'+t.Util.Parser.emoticons[r].plain+'" />'+f;return h.html('<li class="emoticons">'+f+"<\/li>"),h.find("img").click(function(){var n=t.View.Pane.Room.getPane(t.View.getCurrent().roomJid,".message-form").children(".field"),r=n.val(),u=i(this).attr("alt")+" ";n.val(r?r+" "+u:u).focus()}),e=t.Util.getPosLeftAccordingToWindowBounds(u,s.left),o=t.Util.getPosTopAccordingToWindowBounds(u,s.top),u.css({left:e.px,top:o.px}).removeClass("left-top left-bottom right-top right-bottom").addClass(e.backgroundPositionAlignment+"-"+o.backgroundPositionAlignment).fadeIn("fast"),!0}}},n.Room={init:function(r,u,f){var e,o;return(f=f||"groupchat",r=t.Util.unescapeJid(r),e={roomJid:r,type:f},i(t).triggerHandler("candy:view.room.before-add",e)===!1)?!1:(t.Util.isEmptyObject(n.Chat.rooms)&&n.Chat.Toolbar.show(),o=t.Util.jidToId(r),n.Chat.rooms[r]={id:o,usercount:0,name:u,type:f,messageCount:0,scrollPosition:-1},i("#chat-rooms").append(Mustache.to_html(t.View.Template.Room.pane,{roomId:o,roomJid:r,roomType:f,form:{_messageSubmit:i.i18n._("messageSubmit")},roster:{_userOnline:i.i18n._("userOnline")}},{roster:t.View.Template.Roster.pane,messages:Mustache.to_html(t.View.Template.Message.pane,{},{header:t.View.Template.Message.header}),form:t.View.Template.Room.form})),n.Chat.addTab(r,u,f),n.Room.getPane(r,".message-form").submit(n.Message.submit),e.element=n.Room.getPane(r),i(t).triggerHandler("candy:view.room.after-add",e),n.Chat.Toolbar.playSound("new_chat"),o)},show:function(r){var f=n.Chat.rooms[r].id,u;i(".room-pane").each(function(){var e=i(this);u={roomJid:e.attr("data-roomjid"),element:e};e.attr("id")==="chat-room-"+f?(e.show(),t.View.getCurrent().roomJid=r,n.Chat.setActiveTab(r),n.Chat.Toolbar.update(r),n.Chat.clearUnreadMessages(r),n.Room.setFocusToForm(r),n.Room.scrollToBottom(r),i(t).triggerHandler("candy:view.room.after-show",u)):e.is(":visible")&&(e.hide(),i(t).triggerHandler("candy:view.room.after-hide",u))})},setSubject:function(r,u){u=t.Util.Parser.linkify(t.Util.Parser.escape(u));var f=Mustache.to_html(t.View.Template.Room.subject,{subject:u,roomName:n.Chat.rooms[r].name,_roomSubject:i.i18n._("roomSubject"),time:t.Util.localizedTime((new Date).toGMTString())});n.Room.appendToMessagePane(r,f);i(t).triggerHandler("candy:view.room.after-subject-change",{roomJid:r,element:n.Room.getPane(r),subject:u})},close:function(r){n.Chat.removeTab(r);n.Window.clearUnreadMessages();n.Room.getPane(r).remove();var u=i("#chat-rooms").children();t.View.getCurrent().roomJid===r&&(t.View.getCurrent().roomJid=null,u.length===0?n.Chat.allTabsClosed():n.Room.show(u.last().attr("data-roomjid")));delete n.Chat.rooms[r];i(t).triggerHandler("candy:view.room.after-close",{roomJid:r})},insertInMessagePane:function(t,r,u,f){var e=!1,o=n.Room.getPane(t,".message-pane");o.children('li[data-id="'+u+'"]').length>0||(o.children().each(function(){var n=i(this);if(Number(f)<Number(n.attr("data-seqid")))return n.before(r),e=!0,!1}),e||n.Room.getPane(t,".message-pane").append(r))},appendToMessagePane:function(i,r){n.Room.getPane(i,".message-pane").append(r);n.Chat.rooms[i].messageCount++;n.Room.sliceMessagePane(i);t.View.getCurrent().roomJid===i&&n.Room.scrollToBottom(i)},sliceMessagePane:function(i){if(n.Window.autoscroll){var r=t.View.getOptions().messages;n.Chat.rooms[i].messageCount>r.limit&&(n.Room.getPane(i,".message-pane").children().slice(0,r.remove).remove(),n.Chat.rooms[i].messageCount-=r.remove)}},scrollToBottom:function(t){n.Room.onScrollToBottom(t)},onScrollToBottom:function(t){var i=n.Room.getPane(t,".message-pane-wrapper");i.scrollTop(i.prop("scrollHeight"))},onScrollToStoredPosition:function(t){if(n.Chat.rooms[t].scrollPosition>-1){var i=n.Room.getPane(t,".message-pane-wrapper");i.scrollTop(n.Chat.rooms[t].scrollPosition);n.Chat.rooms[t].scrollPosition=-1}},setFocusToForm:function(t){var i=n.Room.getPane(t,".message-form");if(i)try{i.children(".field")[0].focus()}catch(r){}},setUser:function(t,r){n.Chat.rooms[t].user=r;var f=n.Room.getPane(t),u=i("#chat-pane");f.attr("data-userjid",r.getJid());r.isModerator()?(r.getRole()===r.ROLE_MODERATOR&&u.addClass("role-moderator"),r.getAffiliation()===r.AFFILIATION_OWNER&&u.addClass("affiliation-owner")):u.removeClass("role-moderator affiliation-owner");n.Chat.Context.init()},getUser:function(t){return n.Chat.rooms[t].user},ignoreUser:function(n,i){t.Core.Action.Jabber.Room.IgnoreUnignore(i);t.View.Pane.Room.addIgnoreIcon(n,i)},unignoreUser:function(n,i){t.Core.Action.Jabber.Room.IgnoreUnignore(i);t.View.Pane.Room.removeIgnoreIcon(n,i)},addIgnoreIcon:function(n,r){t.View.Pane.Chat.rooms[r]&&i("#user-"+t.View.Pane.Chat.rooms[r].id+"-"+t.Util.jidToId(r)).addClass("status-ignored");t.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)]&&i("#user-"+t.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)].id+"-"+t.Util.jidToId(r)).addClass("status-ignored")},removeIgnoreIcon:function(n,r){t.View.Pane.Chat.rooms[r]&&i("#user-"+t.View.Pane.Chat.rooms[r].id+"-"+t.Util.jidToId(r)).removeClass("status-ignored");t.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)]&&i("#user-"+t.View.Pane.Chat.rooms[Strophe.getBareJidFromJid(n)].id+"-"+t.Util.jidToId(r)).removeClass("status-ignored")},getPane:function(t,r){if(n.Chat.rooms[t])return r?n.Chat.rooms[t]["pane-"+r]?n.Chat.rooms[t]["pane-"+r]:(n.Chat.rooms[t]["pane-"+r]=i("#chat-room-"+n.Chat.rooms[t].id).find(r),n.Chat.rooms[t]["pane-"+r]):i("#chat-room-"+n.Chat.rooms[t].id)},changeDataUserJidIfUserIsMe:function(n,r){if(r.getNick()===t.Core.getUser().getNick()){var u=i("#chat-room-"+n);u.attr("data-userjid",Strophe.getBareJidFromJid(u.attr("data-userjid"))+"/"+r.getNick())}}},n.PrivateRoom={open:function(r,u,f,e){var o=e?t.Core.getUser():n.Room.getUser(Strophe.getBareJidFromJid(r)),s={roomJid:r,roomName:u,type:"chat"};if(i(t).triggerHandler("candy:view.private-room.before-open",s)===!1||t.Core.getUser().isInPrivacyList("ignore",r)||!n.Chat.rooms[r]&&n.Room.init(r,u,"chat")===!1)return!1;f&&n.Room.show(r);n.Roster.update(r,new t.Core.ChatUser(r,u),"join",o);n.Roster.update(r,o,"join",o);n.PrivateRoom.setStatus(r,"join");e&&n.Chat.infoMessage(r,i.i18n._("presenceUnknownWarningSubject"),i.i18n._("presenceUnknownWarning"));s.element=n.Room.getPane(r);i(t).triggerHandler("candy:view.private-room.after-open",s)},setStatus:function(t,i){var r=n.Room.getPane(t,".message-form");i==="join"?(n.Chat.getTab(t).addClass("online").removeClass("offline"),r.children(".field").removeAttr("disabled"),r.children(".submit").removeAttr("disabled"),n.Chat.getTab(t)):i==="leave"&&(n.Chat.getTab(t).addClass("offline").removeClass("online"),r.children(".field").attr("disabled",!0),r.children(".submit").attr("disabled",!0))},changeNick:function(r,u){t.Core.log("[View:Pane:PrivateRoom] changeNick");var o=r+"/"+u.getPreviousNick(),e=r+"/"+u.getNick(),h=t.Util.jidToId(o),l=t.Util.jidToId(e),s=n.Chat.rooms[o],f,c;n.Chat.rooms[e]&&n.Room.close(e);s?(s.name=u.getNick(!0),s.id=l,n.Chat.rooms[e]=s,delete n.Chat.rooms[o],f=i("#chat-room-"+h),f&&(f.attr("data-roomjid",e),f.attr("id","chat-room-"+l),c=i('#chat-tabs li[data-roomjid="'+o+'"]'),c.attr("data-roomjid",e),c.children("a.label").text("@"+u.getNick(!0)),t.View.getCurrent().roomJid===o&&(t.View.getCurrent().roomJid=e))):(f=i('.room-pane.roomtype-chat[data-userjid="'+o+'"]'),f.length&&(h=t.Util.jidToId(f.attr("data-roomjid")),f.attr("data-userjid",e)));f&&f.length&&n.Roster.changeNick(h,u)}},n.Roster={update:function(r,u,f,e){var c,y,l,p,w;t.Core.log("[View:Pane:Roster] "+f);var o=n.Chat.rooms[r].id,s=t.Util.jidToId(u.getJid()),h=-1,a=i("#user-"+o+"-"+s),v={roomJid:r,user:u,action:f,element:a};if(i(t).triggerHandler("candy:view.roster.before-update",v),f==="join")h=1,c=Mustache.to_html(t.View.Template.Roster.user,{roomId:o,userId:s,userJid:u.getJid(),nick:u.getNick(),displayNick:t.Util.crop(u.getNick(!0),t.View.getOptions().crop.roster.nickname),role:u.getRole(),affiliation:u.getAffiliation(),me:e!==undefined&&u.getNick()===e.getNick(),tooltipRole:i.i18n._("tooltipRole"),tooltipIgnored:i.i18n._("tooltipIgnored")}),a.length<1?(y=!1,l=n.Room.getPane(r,".roster-pane"),l.children().length>0&&(p=u.getNick().toUpperCase(),l.children().each(function(){var n=i(this);return n.attr("data-nick").toUpperCase()>p?(n.before(c),y=!0,!1):!0})),y||l.append(c),n.Roster.showJoinAnimation(u,s,o,r,e),n.Roster.showJoinMessage(u,s,o,r,e)):(h=0,a.replaceWith(c),i("#user-"+o+"-"+s).css({opacity:1}).show(),e!==undefined&&u.getNick()===e.getNick()&&n.Room.getUser(r)&&n.Chat.Toolbar.update(r)),e!==undefined&&e.getNick()===u.getNick()?n.Room.setUser(r,u):i("#user-"+o+"-"+s).click(n.Roster.userClick),i("#user-"+o+"-"+s+" .context").click(function(t){n.Chat.Context.show(t.currentTarget,r,u);t.stopPropagation()}),e!==undefined&&e.isInPrivacyList("ignore",u.getJid())&&t.View.Pane.Room.addIgnoreIcon(r,u.getJid());else if(f==="leave"||f==="kick"||f==="ban")if(n.Roster.leaveAnimation("user-"+o+"-"+s),n.Chat.rooms[r].type==="chat")n.Chat.onInfoMessage(r,i.i18n._("userLeftRoom",[u.getNick(!0)]));else n.Chat.infoMessage(r,i.i18n._("userLeftRoom",[u.getNick(!0)]));else if(f==="nickchange"){h=0;n.Roster.changeNick(o,u);n.Room.changeDataUserJidIfUserIsMe(o,u);n.PrivateRoom.changeNick(r,u);w=i.i18n._("userChangedNick",[u.getPreviousNick(),u.getNick(!0)]);n.Chat.onInfoMessage(r,w)}t.View.Pane.Chat.rooms[r].usercount+=h;r===t.View.getCurrent().roomJid&&t.View.Pane.Chat.Toolbar.updateUsercount(t.View.Pane.Chat.rooms[r].usercount);v.element=i("#user-"+o+"-"+s);i(t).triggerHandler("candy:view.roster.after-update",v)},userClick:function(){var t=i(this);n.PrivateRoom.open(t.attr("data-jid"),t.attr("data-nick"),!0)},showJoinAnimation:function(t,r,u){var f="user-"+u+"-"+r,e=i("#"+f);t.getPreviousNick()&&e&&e.is(":visible")!==!1||n.Roster.joinAnimation(f)},showJoinMessage:function(t,r,u,f,e){if(!t.getPreviousNick()&&e!==undefined&&t.getNick()!==e.getNick()&&!t.isModerator())n.Chat.onInfoMessage(f,i.i18n._("userJoinedRoom",[t.getNick(!0)]))},joinAnimation:function(n){i("#"+n).stop(!0).slideDown("normal",function(){i(this).animate({opacity:1})})},leaveAnimation:function(n){i("#"+n).stop(!0).attr("id","#"+n+"-leaving").animate({opacity:0},{complete:function(){i(this).slideUp("normal",function(){i(this).remove()})}})},changeNick:function(n,r){t.Core.log("[View:Pane:Roster] changeNick");var f=Strophe.getBareJidFromJid(r.getJid())+"/"+r.getPreviousNick(),e="user-"+n+"-"+t.Util.jidToId(f),u=i("#"+e);u.attr("data-nick",r.getNick());u.attr("data-jid",r.getJid());u.children("div.label").text(r.getNick());u.attr("id","user-"+n+"-"+t.Util.jidToId(r.getJid()))}},n.Message={submit:function(r){var u=t.View.getCurrent().roomJid,s=t.View.Pane.Chat.rooms[u].type,f=i(this).children(".field").val().substring(0,t.View.getOptions().crop.message.body),e,o={roomJid:u,message:f,xhtmlMessage:e};if(i(t).triggerHandler("candy:view.message.before-send",o)===!1){r.preventDefault();return}f=o.message;e=o.xhtmlMessage;t.Core.Action.Jabber.Room.Message(u,f,s,e);s==="chat"&&f&&n.Message.show(u,n.Room.getUser(u).getNick(!0),f);i(this).children(".field").val("").trigger("change").focus();r.preventDefault()},show:function(r,u,f,e,o,s){var y=f,c,h,v,w;if(f=t.Util.Parser.all(f.substring(0,t.View.getOptions().crop.message.body)),e&&(e=t.Util.parseAndCropXhtml(e,t.View.getOptions().crop.message.body)),c=!!o,h={roomJid:r,name:u,rawMessage:y,attributes:s,message:f,xhtmlMessage:e,history:c},i(t).triggerHandler("candy:view.message.before-show",h)!==!1){f=h.message;e=h.xhtmlMessage;e!==undefined&&e.length>0&&(f=e);var l=new Date,p=n.Room.getUser(r),b=p&&p.getNick(),a={rawMessage:y,attributes:s,template:t.View.Template.Message.item,templateData:{name:u,displayName:t.Util.getDisplayName(u),croppedDisplayName:t.Util.crop(t.Util.getDisplayName(u),t.View.getOptions().crop.message.nickname),message:f,time:t.Util.localizedTime(o||l.toGMTString()),timestamp:o||l.toISOString(),stamp:(o&&new Date(o)||l).valueOf(),id:s.id||"",seqId:s.seqId||0x8000000000000,roomJid:r,sender:u===b?"sender-is-me":"sender-is-other"},history:c};i(t).triggerHandler("candy:view.message.before-render",a)!==!1&&(v=Mustache.to_html(a.template,a.templateData),c?n.Room.insertInMessagePane(r,v,s.id,s.seqId):(n.Room.appendToMessagePane(r,v),t.View.getCurrent().roomJid===r&&n.Window.hasFocus()||(n.Chat.increaseUnreadMessages(r),n.Chat.Toolbar.playSound("new_message"))),w=n.Room.getPane(r,".message-pane").children().last(),h.element=w,i(t).triggerHandler("candy:view.message.after-show",h))}}},n}(t.View.Pane||{},n);t.View.Template=function(n){return n.Window={unreadmessages:"({{count}}) {{title}}"},n.Chat={pane:'<div id="chat-pane">{{> tabs}}{{> toolbar}}{{> rooms}}<\/div>{{> modal}}',rooms:'<div id="chat-rooms" class="rooms"><\/div>',tabs:'<ul id="chat-tabs"><\/ul>',tab:'<li class="roomtype-{{roomType}}" data-roomjid="{{roomJid}}" data-roomtype="{{roomType}}"><a href="#" class="label">{{#privateUserChat}}@{{/privateUserChat}}{{name}}<\/a><small class="transfer"><\/small><small class="unread"><\/small><\/li>',modal:'<div id="chat-modal"><a id="admin-message-cancel" class="close" href="#">×<\/a><span id="chat-modal-body"><\/span><span id="chat-modal-spinner-wrapper"><div id="chat-modal-spinner" /><\/span><\/div><div id="chat-modal-overlay"><\/div>',adminMessage:'<li><small data-stamp="{{stamp}}">{{time}}<\/small><div class="adminmessage"><span class="label">{{sender}}<\/span><span class="spacer">▸<\/span><span class="message">{{subject}} {{message}}<\/span><\/div><\/li>',infoMessage:'<li><small data-stamp="{{stamp}}">{{time}}<\/small><div class="infomessage"><span class="spacer">•<\/span><span class="message">{{subject}} {{message}}<\/span><\/div><\/li>',stateMessage:'<li name="chat-state-message"><div class="statemessage">{{subject}} {{message}}<\/div><\/li>',toolbar:'<ul id="chat-toolbar"><li id="emoticons-icon" data-tooltip="{{tooltipEmoticons}}"><\/li><li id="chat-sound-control" class="checked" data-tooltip="{{tooltipSound}}"><\/li><li id="chat-autoscroll-control" class="checked" data-tooltip="{{tooltipAutoscroll}}"><\/li><li class="checked" id="chat-statusmessage-control" data-tooltip="{{tooltipStatusmessage}}"><\/li><li class="context" data-tooltip="{{tooltipAdministration}}"><\/li><li class="usercount" data-tooltip="{{tooltipUsercount}}"><span id="chat-usercount"><\/span><\/li><\/ul>',Context:{menu:'<div id="context-menu"><i class="arrow arrow-top"><\/i><ul><\/ul><i class="arrow arrow-bottom"><\/i><\/div>',menulinks:'<li class="{{class}}" id="context-menu-{{id}}">{{label}}<\/li>',contextModalForm:'<form action="#" id="context-modal-form"><label for="context-modal-label">{{_label}}<\/label><input type="text" name="contextModalField" id="context-modal-field" /><input type="submit" class="button" name="send" value="{{_submit}}" /><\/form>',adminMessageReason:'<a id="admin-message-cancel" class="close" href="#">×<\/a><p>{{_action}}<\/p>{{#reason}}<p>{{_reason}}<\/p>{{/reason}}'},tooltip:'<div id="tooltip"><i class="arrow arrow-top"><\/i><div><\/div><i class="arrow arrow-bottom"><\/i><\/div>'},n.Room={pane:'<div class="room-pane roomtype-{{roomType}}" id="chat-room-{{roomId}}" data-roomjid="{{roomJid}}" data-roomtype="{{roomType}}">{{> roster}}{{> messages}}{{> form}}<\/div>',subject:'<li><small data-stamp="{{stamp}}">{{time}}<\/small><div class="subject"><span class="label">{{roomName}}<\/span><span class="spacer">▸<\/span>{{_roomSubject}} {{{subject}}}<\/div><\/li>',form:'<div class="message-form-wrapper"><form method="post" class="message-form"><input name="message" class="field" type="text" aria-label="Message Form Text Field" autocomplete="off" maxlength="1000" /><input type="submit" class="submit" name="submit" value="{{_messageSubmit}}" /><\/form><\/div>'},n.Roster={pane:'<div class="roster-pane"><\/div>',user:'<div class="user role-{{role}} affiliation-{{affiliation}}{{#me}} me{{/me}}" id="user-{{roomId}}-{{userId}}" data-jid="{{userJid}}" data-nick="{{nick}}" data-role="{{role}}" data-affiliation="{{affiliation}}"><div class="label">{{displayNick}}<\/div><ul><li class="context" id="context-{{roomId}}-{{userId}}">&#x25BE;<\/li><li class="role role-{{role}} affiliation-{{affiliation}}" data-tooltip="{{tooltipRole}}"><\/li><li class="ignore" data-tooltip="{{tooltipIgnored}}"><\/li><\/ul><\/div>'},n.Message={pane:'{{> header}}<div class="message-pane-wrapper"><ul class="message-pane"><\/ul><\/div>',item:'<li class="{{sender}}" data-id="{{id}}" data-seqid="{{seqId}}"><small data-stamp="{{stamp}}">{{time}}<\/small><div><a class="label name" href="#">{{croppedDisplayName}}<\/a><span class="spacer">▸<\/span><span class="message">{{{message}}}<\/span><\/div><\/li>',header:'<div id="header"><\/div>'},n.Login={form:'<form method="post" id="login-form" class="login-form">{{#displayNickname}}<label for="username">{{_labelNickname}}<\/label><input type="text" id="username" name="username"/>{{/displayNickname}}{{#displayUsername}}<label for="username">{{_labelUsername}}<\/label><input type="text" id="username" name="username"/>{{/displayUsername}}{{#presetJid}}<input type="hidden" id="username" name="username" value="{{presetJid}}"/>{{/presetJid}}{{#displayPassword}}<label for="password">{{_labelPassword}}<\/label><input type="password" id="password" name="password" />{{/displayPassword}}<input type="submit" class="button" value="{{_loginSubmit}}" /><\/form>'},n.PresenceError={enterPasswordForm:'<strong>{{_label}}<\/strong><form method="post" id="enter-password-form" class="enter-password-form"><label for="password">{{_labelPassword}}<\/label><input type="password" id="password" name="password" /><input type="submit" class="button" value="{{_joinSubmit}}" /><\/form>',nicknameConflictForm:'<strong>{{_label}}<\/strong><form method="post" id="nickname-conflict-form" class="nickname-conflict-form"><label for="nickname">{{_labelNickname}}<\/label><input type="text" id="nickname" name="nickname" /><input type="submit" class="button" value="{{_loginSubmit}}" /><\/form>',displayError:"<strong>{{_error}}<\/strong>"},n}(t.View.Template||{});t.View.Translation={en:{status:"Status: %s",statusConnecting:"Connecting...",statusConnected:"Connected",statusDisconnecting:"Disconnecting...",statusDisconnected:"Disconnected",statusAuthfail:"Authentication failed",sessionRestored:"Session restored",roomSubject:"Subject:",messageSubmit:"Send",labelUsername:"Username:",labelNickname:"Nickname:",labelPassword:"Password:",loginSubmit:"Login",loginInvalid:"Invalid JID",reason:"Reason:",subject:"Subject:",reasonWas:"Reason was: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"You have been kicked from %2$s by %1$s",youHaveBeenKicked:"You have been kicked from %s",banActionLabel:"Ban",youHaveBeenBannedBy:"You have been banned from %1$s by %2$s",youHaveBeenBanned:"You have been banned from %s",privateActionLabel:"Private chat",ignoreActionLabel:"Ignore",unignoreActionLabel:"Unignore",setSubjectActionLabel:"Change Subject",administratorMessageSubject:"Administrator",userJoinedRoom:"%s joined the room.",userLeftRoom:"%s left the room.",userHasBeenKickedFromRoom:"%s has been kicked from the room.",userHasBeenBannedFromRoom:"%s has been banned from the room.",userChangedNick:"%1$s has changed his nickname to %2$s.",presenceUnknownWarningSubject:"Notice:",presenceUnknownWarning:"This user might be offline. We can't track his presence.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"You ignore this user",tooltipEmoticons:"Emoticons",tooltipSound:"Play sound for new messages",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Display status messages",tooltipAdministration:"Room Administration",tooltipUsercount:"Room Occupants",enterRoomPassword:'Room "%s" is password protected.',enterRoomPasswordSubmit:"Join room",passwordEnteredInvalid:'Invalid password for room "%s".',nicknameConflict:"Username already in use. Please choose another one.",errorMembersOnly:'You can\'t join room "%s": Insufficient rights.',errorMaxOccupantsReached:'You can\'t join room "%s": Too many occupants.',errorAutojoinMissing:"No autojoin parameter set in configuration. Please set one to continue.",antiSpamMessage:"Please do not spam. You have been blocked for a short-time."},de:{status:"Status: %s",statusConnecting:"Verbinden...",statusConnected:"Verbunden",statusDisconnecting:"Verbindung trennen...",statusDisconnected:"Verbindung getrennt",statusAuthfail:"Authentifizierung fehlgeschlagen",sessionRestored:"Session restored",roomSubject:"Thema:",messageSubmit:"Senden",labelUsername:"Benutzername:",labelNickname:"Spitzname:",labelPassword:"Passwort:",loginSubmit:"Anmelden",loginInvalid:"Ungültige JID",reason:"Begründung:",subject:"Titel:",reasonWas:"Begründung: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"Du wurdest soeben aus dem Raum %1$s gekickt (%2$s)",youHaveBeenKicked:"Du wurdest soeben aus dem Raum %s gekickt",banActionLabel:"Ban",youHaveBeenBannedBy:"Du wurdest soeben aus dem Raum %1$s verbannt (%2$s)",youHaveBeenBanned:"Du wurdest soeben aus dem Raum %s verbannt",privateActionLabel:"Privater Chat",ignoreActionLabel:"Ignorieren",unignoreActionLabel:"Nicht mehr ignorieren",setSubjectActionLabel:"Thema ändern",administratorMessageSubject:"Administrator",userJoinedRoom:"%s hat soeben den Raum betreten.",userLeftRoom:"%s hat soeben den Raum verlassen.",userHasBeenKickedFromRoom:"%s ist aus dem Raum gekickt worden.",userHasBeenBannedFromRoom:"%s ist aus dem Raum verbannt worden.",userChangedNick:"%1$s hat den Nicknamen zu %2$s geändert.",presenceUnknownWarningSubject:"Hinweis:",presenceUnknownWarning:"Dieser Benutzer könnte bereits abgemeldet sein. Wir können seine Anwesenheit nicht verfolgen.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Du ignorierst diesen Benutzer",tooltipEmoticons:"Smileys",tooltipSound:"Ton abspielen bei neuen Nachrichten",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Statusnachrichten anzeigen",tooltipAdministration:"Raum Administration",tooltipUsercount:"Anzahl Benutzer im Raum",enterRoomPassword:'Raum "%s" ist durch ein Passwort geschützt.',enterRoomPasswordSubmit:"Raum betreten",passwordEnteredInvalid:'Inkorrektes Passwort für Raum "%s".',nicknameConflict:"Der Benutzername wird bereits verwendet. Bitte wähle einen anderen.",errorMembersOnly:'Du kannst den Raum "%s" nicht betreten: Ungenügende Rechte.',errorMaxOccupantsReached:'Du kannst den Raum "%s" nicht betreten: Benutzerlimit erreicht.',errorAutojoinMissing:'Keine "autojoin" Konfiguration gefunden. Bitte setze eine konfiguration um fortzufahren.',antiSpamMessage:"Bitte nicht spammen. Du wurdest für eine kurze Zeit blockiert."},fr:{status:"Status: %s",statusConnecting:"Connexion…",statusConnected:"Connecté.",statusDisconnecting:"Déconnexion…",statusDisconnected:"Déconnecté.",statusAuthfail:"L'authentification a échoué",sessionRestored:"Session restored",roomSubject:"Sujet:",messageSubmit:"Envoyer",labelUsername:"Nom d'utilisateur:",labelPassword:"Mot de passe:",loginSubmit:"Connexion",loginInvalid:"JID invalide",reason:"Motif:",subject:"Titre:",reasonWas:"Motif: %s.",kickActionLabel:"Kick",youHaveBeenKickedBy:"Vous avez été expulsé du salon %1$s (%2$s)",youHaveBeenKicked:"Vous avez été expulsé du salon %s",banActionLabel:"Ban",youHaveBeenBannedBy:"Vous avez été banni du salon %1$s (%2$s)",youHaveBeenBanned:"Vous avez été banni du salon %s",privateActionLabel:"Chat privé",ignoreActionLabel:"Ignorer",unignoreActionLabel:"Ne plus ignorer",setSubjectActionLabel:"Changer le sujet",administratorMessageSubject:"Administrateur",userJoinedRoom:"%s vient d'entrer dans le salon.",userLeftRoom:"%s vient de quitter le salon.",userHasBeenKickedFromRoom:"%s a été expulsé du salon.",userHasBeenBannedFromRoom:"%s a été banni du salon.",presenceUnknownWarningSubject:"Note:",presenceUnknownWarning:"Cet utilisateur n'est malheureusement plus connecté, le message ne sera pas envoyé.",dateFormat:"dd/mm/yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Modérateur",tooltipIgnored:"Vous ignorez cette personne",tooltipEmoticons:"Smileys",tooltipSound:"Jouer un son lors de la réception de nouveaux messages",tooltipAutoscroll:"Défilement automatique",tooltipStatusmessage:"Messages d'état",tooltipAdministration:"Administration du salon",tooltipUsercount:"Nombre d'utilisateurs dans le salon",enterRoomPassword:'Le salon "%s" est protégé par un mot de passe.',enterRoomPasswordSubmit:"Entrer dans le salon",passwordEnteredInvalid:'Le mot de passe pour le salon "%s" est invalide.',nicknameConflict:"Le nom d'utilisateur est déjà utilisé. Veuillez en choisir un autre.",errorMembersOnly:'Vous ne pouvez pas entrer dans le salon "%s": droits insuffisants.',errorMaxOccupantsReached:'Vous ne pouvez pas entrer dans le salon "%s": Limite d\'utilisateur atteint.',antiSpamMessage:"Merci de ne pas envoyer de spam. Vous avez été bloqué pendant une courte période.."},nl:{status:"Status: %s",statusConnecting:"Verbinding maken...",statusConnected:"Verbinding is gereed",statusDisconnecting:"Verbinding verbreken...",statusDisconnected:"Verbinding is verbroken",statusAuthfail:"Authenticatie is mislukt",sessionRestored:"Session restored",roomSubject:"Onderwerp:",messageSubmit:"Verstuur",labelUsername:"Gebruikersnaam:",labelPassword:"Wachtwoord:",loginSubmit:"Inloggen",loginInvalid:"JID is onjuist",reason:"Reden:",subject:"Onderwerp:",reasonWas:"De reden was: %s.",kickActionLabel:"Verwijderen",youHaveBeenKickedBy:"Je bent verwijderd van %1$s door %2$s",youHaveBeenKicked:"Je bent verwijderd van %s",banActionLabel:"Blokkeren",youHaveBeenBannedBy:"Je bent geblokkeerd van %1$s door %2$s",youHaveBeenBanned:"Je bent geblokkeerd van %s",privateActionLabel:"Prive gesprek",ignoreActionLabel:"Negeren",unignoreActionLabel:"Niet negeren",setSubjectActionLabel:"Onderwerp wijzigen",administratorMessageSubject:"Beheerder",userJoinedRoom:"%s komt de chat binnen.",userLeftRoom:"%s heeft de chat verlaten.",userHasBeenKickedFromRoom:"%s is verwijderd.",userHasBeenBannedFromRoom:"%s is geblokkeerd.",presenceUnknownWarningSubject:"Mededeling:",presenceUnknownWarning:"Deze gebruiker is waarschijnlijk offline, we kunnen zijn/haar aanwezigheid niet vaststellen.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Je negeert deze gebruiker",tooltipEmoticons:"Emotie-iconen",tooltipSound:"Speel een geluid af bij nieuwe berichten.",tooltipAutoscroll:"Automatisch scrollen",tooltipStatusmessage:"Statusberichten weergeven",tooltipAdministration:"Instellingen",tooltipUsercount:"Gebruikers",enterRoomPassword:'De Chatroom "%s" is met een wachtwoord beveiligd.',enterRoomPasswordSubmit:"Ga naar Chatroom",passwordEnteredInvalid:'Het wachtwoord voor de Chatroom "%s" is onjuist.',nicknameConflict:"De gebruikersnaam is reeds in gebruik. Probeer a.u.b. een andere gebruikersnaam.",errorMembersOnly:'Je kunt niet deelnemen aan de Chatroom "%s": Je hebt onvoldoende rechten.',errorMaxOccupantsReached:'Je kunt niet deelnemen aan de Chatroom "%s": Het maximum aantal gebruikers is bereikt.',antiSpamMessage:"Het is niet toegestaan om veel berichten naar de server te versturen. Je bent voor een korte periode geblokkeerd."},es:{status:"Estado: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desconectando...",statusDisconnected:"Desconectado",statusAuthfail:"Falló la autenticación",sessionRestored:"Session restored",roomSubject:"Asunto:",messageSubmit:"Enviar",labelUsername:"Usuario:",labelPassword:"Clave:",loginSubmit:"Entrar",loginInvalid:"JID no válido",reason:"Razón:",subject:"Asunto:",reasonWas:"La razón fue: %s.",kickActionLabel:"Expulsar",youHaveBeenKickedBy:"Has sido expulsado de %1$s por %2$s",youHaveBeenKicked:"Has sido expulsado de %s",banActionLabel:"Prohibir",youHaveBeenBannedBy:"Has sido expulsado permanentemente de %1$s por %2$s",youHaveBeenBanned:"Has sido expulsado permanentemente de %s",privateActionLabel:"Chat privado",ignoreActionLabel:"Ignorar",unignoreActionLabel:"No ignorar",setSubjectActionLabel:"Cambiar asunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s se ha unido a la sala.",userLeftRoom:"%s ha dejado la sala.",userHasBeenKickedFromRoom:"%s ha sido expulsado de la sala.",userHasBeenBannedFromRoom:"%s ha sido expulsado permanentemente de la sala.",presenceUnknownWarningSubject:"Atención:",presenceUnknownWarning:"Éste usuario podría estar desconectado..",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Ignoras a éste usuario",tooltipEmoticons:"Emoticonos",tooltipSound:"Reproducir un sonido para nuevos mensajes",tooltipAutoscroll:"Desplazamiento automático",tooltipStatusmessage:"Mostrar mensajes de estado",tooltipAdministration:"Administración de la sala",tooltipUsercount:"Usuarios en la sala",enterRoomPassword:'La sala "%s" está protegida mediante contraseña.',enterRoomPasswordSubmit:"Unirse a la sala",passwordEnteredInvalid:'Contraseña incorrecta para la sala "%s".',nicknameConflict:"El nombre de usuario ya está siendo utilizado. Por favor elija otro.",errorMembersOnly:'No se puede unir a la sala "%s": no tiene privilegios suficientes.',errorMaxOccupantsReached:'No se puede unir a la sala "%s": demasiados participantes.',antiSpamMessage:"Por favor, no hagas spam. Has sido bloqueado temporalmente."},cn:{status:"状态: %s",statusConnecting:"连接中...",statusConnected:"已连接",statusDisconnecting:"断开连接中...",statusDisconnected:"已断开连接",statusAuthfail:"认证失败",sessionRestored:"Session restored",roomSubject:"主题:",messageSubmit:"发送",labelUsername:"用户名:",labelPassword:"密码:",loginSubmit:"登录",loginInvalid:"用户名不合法",reason:"原因:",subject:"主题:",reasonWas:"原因是: %s.",kickActionLabel:"踢除",youHaveBeenKickedBy:"你在 %1$s 被管理者 %2$s 请出房间",banActionLabel:"禁言",youHaveBeenBannedBy:"你在 %1$s 被管理者 %2$s 禁言",privateActionLabel:"单独对话",ignoreActionLabel:"忽略",unignoreActionLabel:"不忽略",setSubjectActionLabel:"变更主题",administratorMessageSubject:"管理员",userJoinedRoom:"%s 加入房间",userLeftRoom:"%s 离开房间",userHasBeenKickedFromRoom:"%s 被请出这个房间",userHasBeenBannedFromRoom:"%s 被管理者禁言",presenceUnknownWarningSubject:"注意:",presenceUnknownWarning:"这个会员可能已经下线，不能追踪到他的连接信息",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"管理",tooltipIgnored:"你忽略了这个会员",tooltipEmoticons:"表情",tooltipSound:"新消息发音",tooltipAutoscroll:"滚动条",tooltipStatusmessage:"禁用状态消息",tooltipAdministration:"房间管理",tooltipUsercount:"房间占有者",enterRoomPassword:'登录房间 "%s" 需要密码.',enterRoomPasswordSubmit:"加入房间",passwordEnteredInvalid:'登录房间 "%s" 的密码不正确',nicknameConflict:"用户名已经存在，请另选一个",errorMembersOnly:'您的权限不够，不能登录房间 "%s" ',errorMaxOccupantsReached:'房间 "%s" 的人数已达上限，您不能登录',antiSpamMessage:"因为您在短时间内发送过多的消息 服务器要阻止您一小段时间。"},ja:{status:"ステータス: %s",statusConnecting:"接続中…",statusConnected:"接続されました",statusDisconnecting:"ディスコネクト中…",statusDisconnected:"ディスコネクトされました",statusAuthfail:"認証に失敗しました",sessionRestored:"Session restored",roomSubject:"トピック：",messageSubmit:"送信",labelUsername:"ユーザーネーム：",labelPassword:"パスワード：",loginSubmit:"ログイン",loginInvalid:"ユーザーネームが正しくありません",reason:"理由：",subject:"トピック：",reasonWas:"理由: %s。",kickActionLabel:"キック",youHaveBeenKickedBy:"あなたは%2$sにより%1$sからキックされました。",youHaveBeenKicked:"あなたは%sからキックされました。",banActionLabel:"アカウントバン",youHaveBeenBannedBy:"あなたは%2$sにより%1$sからアカウントバンされました。",youHaveBeenBanned:"あなたは%sからアカウントバンされました。",privateActionLabel:"プライベートメッセージ",ignoreActionLabel:"無視する",unignoreActionLabel:"無視をやめる",setSubjectActionLabel:"トピックを変える",administratorMessageSubject:"管理者",userJoinedRoom:"%sは入室しました。",userLeftRoom:"%sは退室しました。",userHasBeenKickedFromRoom:"%sは部屋からキックされました。",userHasBeenBannedFromRoom:"%sは部屋からアカウントバンされました。",presenceUnknownWarningSubject:"忠告：",presenceUnknownWarning:"このユーザーのステータスは不明です。",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"モデレーター",tooltipIgnored:"このユーザーを無視設定にしている",tooltipEmoticons:"絵文字",tooltipSound:"新しいメッセージが届くたびに音を鳴らす",tooltipAutoscroll:"オートスクロール",tooltipStatusmessage:"ステータスメッセージを表示",tooltipAdministration:"部屋の管理",tooltipUsercount:"この部屋の参加者の数",enterRoomPassword:'"%s"の部屋に入るにはパスワードが必要です。',enterRoomPasswordSubmit:"部屋に入る",passwordEnteredInvalid:'"%s"のパスワードと異なるパスワードを入力しました。',nicknameConflict:"このユーザーネームはすでに利用されているため、別のユーザーネームを選んでください。",errorMembersOnly:'"%s"の部屋に入ることができません: 利用権限を満たしていません。',errorMaxOccupantsReached:'"%s"の部屋に入ることができません: 参加者の数はすでに上限に達しました。',antiSpamMessage:"スパムなどの行為はやめてください。あなたは一時的にブロックされました。"},sv:{status:"Status: %s",statusConnecting:"Ansluter...",statusConnected:"Ansluten",statusDisconnecting:"Kopplar från...",statusDisconnected:"Frånkopplad",statusAuthfail:"Autentisering misslyckades",sessionRestored:"Session restored",roomSubject:"Ämne:",messageSubmit:"Skicka",labelUsername:"Användarnamn:",labelPassword:"Lösenord:",loginSubmit:"Logga in",loginInvalid:"Ogiltigt JID",reason:"Anledning:",subject:"Ämne:",reasonWas:"Anledningen var: %s.",kickActionLabel:"Sparka ut",youHaveBeenKickedBy:"Du har blivit utsparkad från %2$s av %1$s",youHaveBeenKicked:"Du har blivit utsparkad från %s",banActionLabel:"Bannlys",youHaveBeenBannedBy:"Du har blivit bannlyst från %1$s av %2$s",youHaveBeenBanned:"Du har blivit bannlyst från %s",privateActionLabel:"Privat chatt",ignoreActionLabel:"Blockera",unignoreActionLabel:"Avblockera",setSubjectActionLabel:"Ändra ämne",administratorMessageSubject:"Administratör",userJoinedRoom:"%s kom in i rummet.",userLeftRoom:"%s har lämnat rummet.",userHasBeenKickedFromRoom:"%s har blivit utsparkad ur rummet.",userHasBeenBannedFromRoom:"%s har blivit bannlyst från rummet.",presenceUnknownWarningSubject:"Notera:",presenceUnknownWarning:"Denna användare kan vara offline. Vi kan inte följa dennes närvaro.",dateFormat:"yyyy-mm-dd",timeFormat:"HH:MM:ss",tooltipRole:"Moderator",tooltipIgnored:"Du blockerar denna användare",tooltipEmoticons:"Smilies",tooltipSound:"Spela upp ett ljud vid nytt meddelande",tooltipAutoscroll:"Autoskrolla",tooltipStatusmessage:"Visa statusmeddelanden",tooltipAdministration:"Rumadministrering",tooltipUsercount:"Antal användare i rummet",enterRoomPassword:'Rummet "%s" är lösenordsskyddat.',enterRoomPasswordSubmit:"Anslut till rum",passwordEnteredInvalid:'Ogiltigt lösenord för rummet "%s".',nicknameConflict:"Upptaget användarnamn. Var god välj ett annat.",errorMembersOnly:'Du kan inte ansluta till rummet "%s": Otillräckliga rättigheter.',errorMaxOccupantsReached:'Du kan inte ansluta till rummet "%s": Rummet är fullt.',antiSpamMessage:"Var god avstå från att spamma. Du har blivit blockerad för en kort stund."},it:{status:"Stato: %s",statusConnecting:"Connessione...",statusConnected:"Connessione",statusDisconnecting:"Disconnessione...",statusDisconnected:"Disconnesso",statusAuthfail:"Autenticazione fallita",sessionRestored:"Sessione ristabilita",roomSubject:"Oggetto:",messageSubmit:"Invia",labelUsername:"Nome utente:",labelPassword:"Password:",loginSubmit:"Login",loginInvalid:"JID non valido",reason:"Ragione:",subject:"Oggetto:",reasonWas:"Ragione precedente: %s.",kickActionLabel:"Espelli",youHaveBeenKickedBy:"Sei stato espulso da %2$s da %1$s",youHaveBeenKicked:"Sei stato espulso da %s",banActionLabel:"Escluso",youHaveBeenBannedBy:"Sei stato escluso da %1$s da %2$s",youHaveBeenBanned:"Sei stato escluso da %s",privateActionLabel:"Stanza privata",ignoreActionLabel:"Ignora",unignoreActionLabel:"Non ignorare",setSubjectActionLabel:"Cambia oggetto",administratorMessageSubject:"Amministratore",userJoinedRoom:"%s si è unito alla stanza.",userLeftRoom:"%s ha lasciato la stanza.",userHasBeenKickedFromRoom:"%s è stato espulso dalla stanza.",userHasBeenBannedFromRoom:"%s è stato escluso dalla stanza.",presenceUnknownWarningSubject:"Nota:",presenceUnknownWarning:"Questo utente potrebbe essere offline. Non possiamo tracciare la sua presenza.",dateFormat:"dd/mm/yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderatore",tooltipIgnored:"Stai ignorando questo utente",tooltipEmoticons:"Emoticons",tooltipSound:"Riproduci un suono quando arrivano messaggi",tooltipAutoscroll:"Autoscroll",tooltipStatusmessage:"Mostra messaggi di stato",tooltipAdministration:"Amministrazione stanza",tooltipUsercount:"Partecipanti alla stanza",enterRoomPassword:'La stanza "%s" è protetta da password.',enterRoomPasswordSubmit:"Unisciti alla stanza",passwordEnteredInvalid:'Password non valida per la stanza "%s".',nicknameConflict:"Nome utente già in uso. Scegline un altro.",errorMembersOnly:'Non puoi unirti alla stanza "%s": Permessi insufficienti.',errorMaxOccupantsReached:'Non puoi unirti alla stanza "%s": Troppi partecipanti.',antiSpamMessage:"Per favore non scrivere messaggi pubblicitari. Sei stato bloccato per un po' di tempo."},pt:{status:"Status: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desligando...",statusDisconnected:"Desligado",statusAuthfail:"Falha na autenticação",sessionRestored:"Session restored",roomSubject:"Assunto:",messageSubmit:"Enviar",labelUsername:"Usuário:",labelPassword:"Senha:",loginSubmit:"Entrar",loginInvalid:"JID inválido",reason:"Motivo:",subject:"Assunto:",reasonWas:"O motivo foi: %s.",kickActionLabel:"Excluir",youHaveBeenKickedBy:"Você foi excluido de %1$s por %2$s",youHaveBeenKicked:"Você foi excluido de %s",banActionLabel:"Bloquear",youHaveBeenBannedBy:"Você foi excluido permanentemente de %1$s por %2$s",youHaveBeenBanned:"Você foi excluido permanentemente de %s",privateActionLabel:"Bate-papo privado",ignoreActionLabel:"Ignorar",unignoreActionLabel:"Não ignorar",setSubjectActionLabel:"Trocar Assunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s entrou na sala.",userLeftRoom:"%s saiu da sala.",userHasBeenKickedFromRoom:"%s foi excluido da sala.",userHasBeenBannedFromRoom:"%s foi excluido permanentemente da sala.",presenceUnknownWarning:"Este usuário pode estar desconectado. Não é possível determinar o status.",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Você ignora este usuário",tooltipEmoticons:"Emoticons",tooltipSound:"Reproduzir o som para novas mensagens",tooltipAutoscroll:"Deslocamento automático",tooltipStatusmessage:"Mostrar mensagens de status",tooltipAdministration:"Administração da sala",tooltipUsercount:"Usuários na sala",enterRoomPassword:'A sala "%s" é protegida por senha.',enterRoomPasswordSubmit:"Junte-se à sala",passwordEnteredInvalid:'Senha incorreta para a sala "%s".',nicknameConflict:"O nome de usuário já está em uso. Por favor, escolha outro.",errorMembersOnly:'Você não pode participar da sala "%s":  privilégios insuficientes.',errorMaxOccupantsReached:'Você não pode participar da sala "%s": muitos participantes.',antiSpamMessage:"Por favor, não envie spam. Você foi bloqueado temporariamente."},pt_br:{status:"Estado: %s",statusConnecting:"Conectando...",statusConnected:"Conectado",statusDisconnecting:"Desconectando...",statusDisconnected:"Desconectado",statusAuthfail:"Autenticação falhou",sessionRestored:"Session restored",roomSubject:"Assunto:",messageSubmit:"Enviar",labelUsername:"Usuário:",labelPassword:"Senha:",loginSubmit:"Entrar",loginInvalid:"JID inválido",reason:"Motivo:",subject:"Assunto:",reasonWas:"Motivo foi: %s.",kickActionLabel:"Derrubar",youHaveBeenKickedBy:"Você foi derrubado de %2$s por %1$s",youHaveBeenKicked:"Você foi derrubado de %s",banActionLabel:"Banir",youHaveBeenBannedBy:"Você foi banido de %1$s por %2$s",youHaveBeenBanned:"Você foi banido de %s",privateActionLabel:"Conversa privada",ignoreActionLabel:"Ignorar",unignoreActionLabel:"Não ignorar",setSubjectActionLabel:"Mudar Assunto",administratorMessageSubject:"Administrador",userJoinedRoom:"%s entrou na sala.",userLeftRoom:"%s saiu da sala.",userHasBeenKickedFromRoom:"%s foi derrubado da sala.",userHasBeenBannedFromRoom:"%s foi banido da sala.",presenceUnknownWarningSubject:"Aviso:",presenceUnknownWarning:"Este usuário pode estar desconectado.. Não conseguimos rastrear sua presença..",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Você ignora este usuário",tooltipEmoticons:"Emoticons",tooltipSound:"Tocar som para novas mensagens",tooltipAutoscroll:"Auto-rolagem",tooltipStatusmessage:"Exibir mensagens de estados",tooltipAdministration:"Administração de Sala",tooltipUsercount:"Participantes da Sala",enterRoomPassword:'Sala "%s" é protegida por senha.',enterRoomPasswordSubmit:"Entrar na sala",passwordEnteredInvalid:'Senha inváida para sala "%s".',nicknameConflict:"Nome de usuário já em uso. Por favor escolha outro.",errorMembersOnly:'Você não pode entrar na sala "%s": privilégios insuficientes.',errorMaxOccupantsReached:'Você não pode entrar na sala "%s": máximo de participantes atingido.',antiSpamMessage:"Por favor, não faça spam. Você foi bloqueado temporariamente."},ru:{status:"Статус: %s",statusConnecting:"Подключение...",statusConnected:"Подключено",statusDisconnecting:"Отключение...",statusDisconnected:"Отключено",statusAuthfail:"Неверный логин",sessionRestored:"Session restored",roomSubject:"Топик:",messageSubmit:"Послать",labelUsername:"Имя:",labelPassword:"Пароль:",loginSubmit:"Логин",loginInvalid:"Неверный JID",reason:"Причина:",subject:"Топик:",reasonWas:"Причина была: %s.",kickActionLabel:"Выбросить",youHaveBeenKickedBy:"Пользователь %1$s выбросил вас из чата %2$s",youHaveBeenKicked:"Вас выбросили из чата %s",banActionLabel:"Запретить доступ",youHaveBeenBannedBy:"Пользователь %1$s запретил вам доступ в чат %2$s",youHaveBeenBanned:"Вам запретили доступ в чат %s",privateActionLabel:"Один-на-один чат",ignoreActionLabel:"Игнорировать",unignoreActionLabel:"Отменить игнорирование",setSubjectActionLabel:"Изменить топик",administratorMessageSubject:"Администратор",userJoinedRoom:"%s вошёл в чат.",userLeftRoom:"%s вышел из чата.",userHasBeenKickedFromRoom:"%s выброшен из чата.",userHasBeenBannedFromRoom:"%s запрещён доступ в чат.",presenceUnknownWarningSubject:"Уведомление:",presenceUnknownWarning:"Этот пользователь вероятнее всего оффлайн.",dateFormat:"mm.dd.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Модератор",tooltipIgnored:"Вы игнорируете этого пользователя.",tooltipEmoticons:"Смайлики",tooltipSound:"Озвучивать новое сообщение",tooltipAutoscroll:"Авто-прокручивание",tooltipStatusmessage:"Показывать статус сообщения",tooltipAdministration:"Администрирование чат комнаты",tooltipUsercount:"Участники чата",enterRoomPassword:'Чат комната "%s" защищена паролем.',enterRoomPasswordSubmit:"Войти в чат",passwordEnteredInvalid:'Неверный пароль для комнаты "%s".',nicknameConflict:"Это имя уже используется. Пожалуйста выберите другое имя.",errorMembersOnly:'Вы не можете войти в чат "%s": Недостаточно прав доступа.',errorMaxOccupantsReached:'Вы не можете войти в чат "%s": Слишком много участников.',antiSpamMessage:"Пожалуйста не рассылайте спам. Вас заблокировали на короткое время."},ca:{status:"Estat: %s",statusConnecting:"Connectant...",statusConnected:"Connectat",statusDisconnecting:"Desconnectant...",statusDisconnected:"Desconnectat",statusAuthfail:"Ha fallat la autenticació",sessionRestored:"Session restored",roomSubject:"Assumpte:",messageSubmit:"Enviar",labelUsername:"Usuari:",labelPassword:"Clau:",loginSubmit:"Entrar",loginInvalid:"JID no vàlid",reason:"Raó:",subject:"Assumpte:",reasonWas:"La raó ha estat: %s.",kickActionLabel:"Expulsar",youHaveBeenKickedBy:"Has estat expulsat de %1$s per %2$s",youHaveBeenKicked:"Has estat expulsat de %s",banActionLabel:"Prohibir",youHaveBeenBannedBy:"Has estat expulsat permanentment de %1$s per %2$s",youHaveBeenBanned:"Has estat expulsat permanentment de %s",privateActionLabel:"Xat privat",ignoreActionLabel:"Ignorar",unignoreActionLabel:"No ignorar",setSubjectActionLabel:"Canviar assumpte",administratorMessageSubject:"Administrador",userJoinedRoom:"%s ha entrat a la sala.",userLeftRoom:"%s ha deixat la sala.",userHasBeenKickedFromRoom:"%s ha estat expulsat de la sala.",userHasBeenBannedFromRoom:"%s ha estat expulsat permanentment de la sala.",presenceUnknownWarningSubject:"Atenció:",presenceUnknownWarning:"Aquest usuari podria estar desconnectat ...",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss",tooltipRole:"Moderador",tooltipIgnored:"Estàs ignorant aquest usuari",tooltipEmoticons:"Emoticones",tooltipSound:"Reproduir un so per a nous missatges",tooltipAutoscroll:"Desplaçament automàtic",tooltipStatusmessage:"Mostrar missatges d'estat",tooltipAdministration:"Administració de la sala",tooltipUsercount:"Usuaris dins la sala",enterRoomPassword:'La sala "%s" està protegida amb contrasenya.',enterRoomPasswordSubmit:"Entrar a la sala",passwordEnteredInvalid:'Contrasenya incorrecta per a la sala "%s".',nicknameConflict:"El nom d'usuari ja s'està utilitzant. Si us plau, escolleix-ne un altre.",errorMembersOnly:'No pots unir-te a la sala "%s": no tens prous privilegis.',errorMaxOccupantsReached:'No pots unir-te a la sala "%s": hi ha masses participants.',antiSpamMessage:"Si us plau, no facis spam. Has estat bloquejat temporalment."}};window.Candy=t}function buildCandies(){if(!window.Candy)throw Ifm.Diagnostics.Errors.miss("Candy");Candy.View.Translation.en.labelNickname="Your name:";Candy.View.Translation.en.loginSubmit="Enter chat";Candy.View.Translation.en.userJoinedRoom="%s has entered the conversation.";Candy.View.Translation.en.userLeftRoom="%s has left the conversation.";Candy.View.Translation.it.labelNickname="Il tuo nome:";Candy.View.Translation.it.loginSubmit="Entra in chat";Candy.View.Translation.it.userJoinedRoom="%s è entrato nella conversazione.";Candy.View.Translation.it.userLeftRoom="%s ha lasciato la conversazione.";var n=Candy.View.Pane.Chat.onInfoMessage;Candy.View.Pane.Chat.onInfoMessage=function(t,i,r){if(Candy.View.Pane.Room.getPane(t)){var u=Candy.View.Pane.Room.getPane(t,".message-pane").children().last().text();u.indexOf(i)<0&&u.indexOf(r)<0&&n(t,i,r)}};Candy.Core.isConnected=function(){return Candy.Core.getConnection().connected};Candy.Core.getUsername=function(){return Candy.Core.getUser().getNick()};Candy.Core.getRoomUserByName=function(n,t){var u=Candy.Core.getRoom(n),i,r;if(u){i=u.roster.getAll();for(r in i)if(Strophe.getResourceFromJid(i[r].getJid())===t)return i[r]}return null};Candy.Core.available=function(n){var t=$pres({from:Candy.Core.getConnection().jid,to:n});Ifm.Diagnostics.Debug.print("[Candy] [Extensions] sending availability to",n);Candy.Core.getConnection().send(t)};Candy.Core.subscribe=function(n,t,i){var u="pres:"+Candy.Core.getConnection().getUniqueId(),r=$pres({from:Candy.Core.getConnection().jid,to:n,id:u,type:"subscribe"});t&&r.c("nick",{xmlns:"http://jabber.org/protocol/nick"},t);i&&r.c("status",{},i);Ifm.Diagnostics.Debug.print("[Candy] [Extensions] requesting subscription to",n,"(id",u,")",t?"as "+t:"");Candy.Core.getConnection().send(r)};Candy.Core.subscribed=function(n,t){var i=t||"pres:"+Candy.Core.getConnection().getUniqueId(),r=$pres({from:Candy.Core.getConnection().jid,to:n,id:i,type:"subscribed"});Ifm.Diagnostics.Debug.print("[Candy] [Extensions] replying subscription to",n,"(id",i,")");Candy.Core.getConnection().send(r)};Candy.Core.notifystate=function(n,t){var i=$msg({from:Candy.Core.getConnection().jid,to:n,type:"groupchat"}).c(t,{xmlns:"http://jabber.org/protocol/chatstates"});Ifm.Diagnostics.Debug.print("[Candy] [Extensions] sending",t,"notification");Candy.Core.getConnection().send(i)};Candy.View.deletenotification=function(n){var i=Candy.View.Pane.Room.getPane(n),r,t;i&&(r=Candy.View.Pane.Room.getPane(n,".message-pane"),t=i.data(),t.resetnotificationtmr&&(clearTimeout(t.resetnotificationtmr),t.resetnotificationtmr=0),r.find("[name=chat-state-message]").remove())};Candy.View.movenotification=function(n){if(Candy.View.Pane.Room.getPane(n)){var t=Candy.View.Pane.Room.getPane(n,".message-pane"),i=t.find("[name=chat-state-message]");i.length&&t.append(i)}};Candy.View.updatenotification=function(n,t,i,r){var u,f;Candy.View.deletenotification(n);u=Candy.View.Pane.Room.getPane(n);u&&(f=Mustache.to_html(Candy.View.Template.Chat.stateMessage,{subject:t,message:r}),Candy.View.Pane.Room.appendToMessagePane(n,f),u.data({resetnotificationtmr:setTimeout(function(){Candy.View.deletenotification(n)},1e4)}))};window.Candies=window.Candies||{};Candies.appendToMessagePane=function(n,t,i,r){r=r||"";var u=new Date,f=Candy.View.Template.Message.item,e={name:r,displayName:Candy.Util.getDisplayName(r),croppedDisplayName:Candy.Util.crop(Candy.Util.getDisplayName(r),Candy.View.getOptions().crop.message.nickname),message:t,time:Candy.Util.localizedTime(u.toGMTString()),timestamp:u.toISOString(),stamp:u.valueOf(),id:"",seqId:0x8000000000000,roomJid:n,sender:i?"sender-is-me":"sender-is-other"},o=Mustache.to_html(f,e);Candy.View.Pane.Room.appendToMessagePane(n,o)};Candies.send=function(n,t){Candy.Core.Action.Jabber.Room.Message(n,t.toString())};Candies.sysMessage=function(n,t){for(var r=new Ifm.Messaging.FStringMessageWriter(t),i=2;i<arguments.length;i++)r.add(arguments[i]);Candies.send(n,r.end())};Candies.getRoomHistory=function(n){Candy.Core.debug("Getting messages of room "+n);var t=0;Candy.Core.getConnection().mam.query(n,{onMessage:function(i){t+=1;var u=$(i),r=u.find("forwarded message"),f=Candy.Util.unescapeJid(r.attr("from")),e=Strophe.getResourceFromJid(f),o={roomJid:n,message:{name:e,body:r.children("body").text(),type:r.attr("type"),attributes:{xmlns:r.attr("xmlns"),to:u.attr("to"),type:r.attr("type"),id:r.attr("id"),from:f,seqId:t}},timestamp:u.find("forwarded delay").attr("stamp")};return Candy.View.Observer.Message(null,o),!0},onComplete:function(i){Candy.Core.debug("[MAM] Response "+i);Candy.Core.debug("Got all messages of room "+n);t===0&&Candies.sysMessage(n,"CONTINUITY");Candy.View.Pane.Chat.onInfoMessage(n,$.i18n._("sessionRestored"));Candy.View.Pane.Room.scrollToBottom(n)}})}}var Occupant,RoomConfig,XmppRoom,__bind,Mustache,dateFormat,Candy;namespace("Ifm.Net").WebSocket=function(){function i(n){switch(n){case"403":return": no destination for protocol";case"500":return": client-gateway protocol error";case"502":return": gateway-server protocol error";case"503":return": no destination reachable";default:return""}}var n={},t;return n.ErrorReasons={Failed:"Connection failed",Lost:"Connection lost",Refused:"Connection refused"},n.MessageType={BINARY:"Binary",OBJECT:"Object",TEXT:"Text"},n.isSupported=function(){return global&&global.Ifm&&global.WebSocket?!0:!1},n.create=function(r,u){var f,e,o;if(!n.isSupported())throw Ifm.Diagnostics.Errors.notsup("WebSocket");if(!Ifm.Type.isString(r))throw Ifm.Diagnostics.Errors.arg("url");return f={},f.events=defineEvents("connecting","open","closing","closed","error","receive"),f.id=function(){return t+=1}(),f.connect=function(){function s(){o||(console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",t,r,u,"onopen"),o=!0,f.events.open.raise(f,{}))}if(!e||!(e.readyState<WebSocket.CLOSING)){f.events.connecting.raise(f,{});try{e=u?new WebSocket(r,u):new WebSocket(r)}catch(h){f.events.error.raise(f,{error:h});f.events.closed.raise(f,{clean:!1,reason:Ifm.Net.WebSocket.ErrorReasons.Failed});return}e.onmessage=function(e){var o,h;if(Ifm.Type.isString(e.data)){if(o=e.data,o.startsWith("#close")){var c=o.split("|"),l=c.length>1?c[1]:"0",a=l+i(l);console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s (%s)",t,r,u,"close notification",a);return}if(s(),o.startsWith("{")&&o.endsWith("}")){h=null;try{h=JSON.parse(o)}catch(v){}if(h!==null){f.events.receive.raise(f,{type:n.MessageType.OBJECT,message:h});return}}f.events.receive.raise(f,{type:n.MessageType.TEXT,message:o})}else s(),f.events.receive.raise(f,{type:n.MessageType.BINARY,message:e.data})};e.onclose=function(n){console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s (code: %d)",t,r,u,"onclose",n.code);f.events.closed.raise(f,{clean:n.wasClean,reason:n.wasClean?"":o?Ifm.Net.WebSocket.ErrorReasons.Lost:Ifm.Net.WebSocket.ErrorReasons.Refused});o=!1;e=null};e.onerror=function(n){f.events.error.raise(f,n)}}},f.close=function(){(console.debug("[Ifm.Net.WebSocket] %d [%s|%s] %s",t,r,u,"close"),e&&e.readyState!==WebSocket.CLOSED)&&(f.events.closing.raise(f,{}),e.close())},f.send=function(n){if(!e||e.readyState!==WebSocket.OPEN)throw Ifm.Diagnostics.Errors.op("WebSocket not open");e.send(n)},Object.defineProperties(f,{isOpen:{get:function(){return f.state===WebSocket.OPEN}},state:{get:function(){return e?e.readyState:WebSocket.CLOSED}}}),e=null,o=!1,f},t=0,n}();namespace("Ifm.Net").Peer=function(){var n={};return n.isSupported=function(){return Ifm&&Ifm.Net&&Ifm.Net.WebSocket&&Ifm.Net.WebSocket.isSupported()?!0:!1},n.query=function(t,i,r,u){n.create(t,i,function(n){n?n.query(r,function(t){u(t);n.close()}):u(null)})},n.create=function(t,i,r){function e(){u.events.closed.removeAllHandlers();u.events.receive.removeAllHandlers()}var f,u;if(!n.isSupported())throw Ifm.Diagnostics.Errors.notsup("Peer");if(!Ifm.Type.isFunction(r))throw Ifm.Diagnostics.Errors.func("callback");return f={},f.query=function(n,t){if(!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("query");if(!Ifm.Type.isFunction(t))throw Ifm.Diagnostics.Errors.func("callback");e();u.events.closed=function(){e();t(null)};u.events.receive=function(n,i){e();t(i)};u.isOpen?u.send(n):t(null)},f.receive=function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");e();u.events.closed=function(){n(null)};u.events.receive=function(t,i){n(i)}},f.send=function(n){u.isOpen&&u.send(n)},f.close=function(){e();u.close()},u=Ifm.Net.WebSocket.create(t,i),u.events.closed=function(){e();r(null)},u.events.receive=function(n,t){if(e(),t.type===Ifm.Net.WebSocket.MessageType.TEXT){var i=t.message.split("|");switch(i[0]){case"#ready":r(f);return;case"#close":console.warn(i[1]||"Forcibly closed by server");n.close();r(null);return}}console.warn("[Ifm.Net.Services.Peer] Unexpected message from server",t.message);n.close();r(null)},u.connect(),f},n}();namespace("Ifm.Net").TimeProvider=function(){function t(n){if(!(this instanceof t))throw Ifm.Diagnostics.Errors.ctor("TimeProvider");if(!Ifm.Net.WebSocket)throw Ifm.Diagnostics.Errors.miss("Ifm.Net.WebSocket");if(!n||Ifm.Type.isArray(n)&&n.length===0)throw Ifm.Diagnostics.Errors.arg("urls");n=Ifm.Type.isArray(n)?n:[n];setTimeout(e.bind(this,n,0))}function e(n,t){var u=t<n.length?n[t]:n[t=0],r,f;if(u.startsWith("*")){console.debug(i+" Skipping unsupported url: "+u);n.splice(t,1);n.length>0?o.call(this,n,t):console.debug(i+" No valid url to connect to, using native timers");return}console.debug(i+" Connecting to "+u);r=Ifm.Net.WebSocket.create(u,"itp");this._ws=r;f=this;r.events.open=function(){console.debug(i+" Connected, using remote timers")};r.events.closed=function(r,u){console.debug(i+" "+(u.reason||"Disconnected"));w.call(f);o.call(f,n,t+1)};r.events.receive=function(n,t){console.assert(t.type===Ifm.Net.WebSocket.MessageType.TEXT);b.call(f,t.message)};r.connect()}function o(n,t){this._closed||setTimeout(e.bind(this,n,t+1),5e3)}function s(t,i,r,e){var o=k(),s;return n[o]={callback:r.bind.apply(r,[window].concat(e)),type:t,delay:i,owner:this},this._ws&&this._ws.isOpen?c.call(this,g,o,t,i>0?i:0):(s=t===u?setTimeout:setInterval,n[o].nativeId=s(f.bind(this,o),i)),o}function w(){for(var t in n)n[t].nativeId||n[t].owner!==this||(n[t].type===u?(console.debug(i+" Invoking immediate tick for timer "+t),f.call(this,t)):n[t].type===a&&(console.debug(i+" Converting remote to native timer "+t),n[t].nativeId=setInterval(n[t].callback,n[t].delay)))}function h(t){t&&t in n&&(n[t].nativeId?clearTimeout(n[t].nativeId):c.call(this,d,t),delete n[t])}function b(n){var t=n.split(y),i,r;console.assert(t[0].startsWith(v));i=t[0].substr(1);i===nt&&(r=Number(t[1]),f.call(this,r))}function c(n,t,i,r){var u=[n,t],f;i!==undefined&&u.push(i);r!==undefined&&u.push(r);f=v+u.join(y);this._ws.send(f)}function f(t){if(t&&t in n){var i=n[t];i.callback();i.type===u&&delete n[t]}}function l(n,t){return t.length>n?Array.prototype.splice.call(t,n):[]}function k(){return p+=1}var r;t.getDefault=function(){if(Ifm.Net.timeProvider instanceof t)return Ifm.Net.timeProvider;if(t.settings){var n=t.settings.service;if(n)return Ifm.Net.timeProvider=new t(n),Ifm.Net.timeProvider}return window};r=t.prototype;r.close=function(){this._closed=!0;this._ws.close()};r.clearInterval=function(n){h.call(this,n)};r.clearTimeout=function(n){h.call(this,n)};r.setInterval=function(n,t,i){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("fn");return i=l(2,arguments),s.call(this,a,t,n,i)};r.setTimeout=function(n,t,i){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("fn");return i=l(2,arguments),s.call(this,u,t,n,i)};var i="[Ifm.Net.TimeProvider]",d="clear",g="set",nt="tick",a="0",u="1",v="#",y="|",p=0,n={};return t}();namespace("Ifm.Net.Services").FileTransfer=function(){var n={};n.ErrorReasons={Unavailable:"Service unavailable",RequestRefused:"Request refused",InvalidToken:"Invalid token",FileCorrupted:"File corrupted",FileReadError:"File read error",SecurityError:"Security error: {err}"};n.isSupported=function(){return global&&global.Ifm&&Ifm.Net.Peer&&Ifm.Net.Peer.isSupported()&&global.File&&global.FileList&&global.FileReader&&global.Blob?!0:!1};n.create=function(u){if(!n.isSupported())throw Ifm.Diagnostics.Errors.notsup("FileTransfer");var f={};return f.events=defineEvents("waiting","started","progress","finished","canceled","error"),f.id=function(){return r+=1}(),f.isSender=undefined,f.enabled=function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");Ifm.Net.Peer.query(u,i,"#enabled",function(t){n(t&&t.message||!1)})},f.receive=function(n){if(!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("token");if(f.isSender!==undefined)throw Ifm.Diagnostics.Errors.op("FileTransfer instance already in use");f.isSender=!1;var c=Ifm.Net.WebSocket.MessageType.BINARY,a=Ifm.Net.WebSocket.MessageType.OBJECT,l=Ifm.Net.WebSocket.MessageType.TEXT,r=Ifm.Net.Services.FileTransfer.ErrorReasons,e=[],o,s,h;Ifm.Net.Peer.create(u,i,function(i){if(!i){f.events.error.raise(f,{reason:r.Unavailable});return}f.accept=function(){f.accept=function(){};i.send("#start")};f.cancel=function(){f.cancel=function(){};i.send("#cancel");i.close();f.events.canceled.raise(f,{})};i.receive(function(u){var a,v;if(!u){f.events.error.raise(f,{reason:r.RequestRefused});return}if(u.type===l){a=u.message.split("|");switch(a[0]){case"#invalidtoken":i.close();f.events.error.raise(f,{reason:r.InvalidToken});break;case"#cancel":f.cancel();break;case"#paired":f.events.waiting.raise(f,{token:n});break;case"#info":o=a[1];s=Number(a[2]);h=a[3];f.events.started.raise(f,{});break;case"#finished":if(f.cancel=function(){},i.close(),v=new Blob(e,{type:h}),v.size!==s){f.events.error.raise(f,{reason:r.FileCorrupted});return}f.events.finished.raise(f,{fileBlob:v,openOrSaveFunc:function(){if(Ifm.Type.isFunction(window.navigator.msSaveOrOpenBlob))window.navigator.msSaveOrOpenBlob(v,o);else{var n=document.createElement("a");n.href=URL.createObjectURL(v);n.download=o;n.target="_blank";n.style.cssText="display:none!important;";document.body.appendChild(n);n.click();document.body.removeChild(n)}return!1}});break;default:console.warn("[Ifm.Net.Services.FileTransfer] %s Unexpected message: %s","receive()",u.message)}}else u.type===c&&(e.push(u.message),f.events.progress.raise(f,{percentage:Math.ceil(e.length*t*100/s)}))});i.send("#receive|"+n)})},f.transfer=function(n){if(!(n instanceof File))throw Ifm.Diagnostics.Errors.arg("file");if(f.isSender!==undefined)throw Ifm.Diagnostics.Errors.op("FileTransfer instance already in use");f.isSender=!0;var h=Ifm.Net.WebSocket.MessageType.BINARY,c=Ifm.Net.WebSocket.MessageType.OBJECT,s=Ifm.Net.WebSocket.MessageType.TEXT,e=Ifm.Net.Services.FileTransfer.ErrorReasons,r=0,o=!1;Ifm.Net.Peer.create(u,i,function(i){if(!i){f.events.error.raise(f,{reason:e.Unavailable});return}f.cancel=function(){f.cancel=function(){};o=!0;u&&(u.onloadend=function(){},u.onerror=function(){},u.abort(),u=null);i.send("#cancel");i.close();f.events.canceled.raise(f,{})};var u=new FileReader;u.onloadend=function(){var e,s;o||u.readyState===FileReader.DONE&&(i.send(u.result),r+=t,e=r+Math.min(t,n.size-r),r<n.size?(f.events.progress.raise(f,{percentage:Math.ceil(r*100/n.size)}),s=n.slice(r,e),u.readAsArrayBuffer(s)):(f.cancel=function(){},i.send("#finished"),i.close(),f.events.finished.raise(f,{fileBlob:n,openOrSaveFunc:null})))};u.onerror=function(){i.close();f.events.error.raise(f,{reason:e.FileReadError})};i.receive(function(o){var h,c;if(!o){f.events.error.raise(f,{reason:e.RequestRefused});return}if(o.type===s){h=o.message.split("|");switch(h[0]){case"#denied":i.close();f.events.error.raise(f,{reason:e.SecurityError.replace("{err}",h[1])});break;case"#cancel":f.cancel();break;case"#token":f.events.waiting.raise(f,{token:h[1]});break;case"#paired":break;case"#start":i.send("#info|"+n.name+"|"+n.size+"|"+n.type);f.events.started.raise(f,{});c=n.slice(r,Math.min(t,n.size));u.readAsArrayBuffer(c);break;default:console.warn("[Ifm.Net.Services.FileTransfer] %s Unexpected message: %s","transfer()",o.message)}}});i.send("#transfer|"+n.name+"|"+n.size+"|"+n.type)})},f.accept=function(){},f.cancel=function(){},f};var i="ift",t=32768,r=0;return n}();
/*!
 * IFM Strophe bundle 1.3.0-3823
 * Copyright (c) IFM Infomaster. All rights reserved.
 */
(function(n){if(function(n,t){typeof define=="function"&&define.amd?define("strophe-base64",function(){return t()}):n.Base64=t()}(globalThis,function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var o="",i,r,u,c,s,h,f,e=0;do i=t.charCodeAt(e++),r=t.charCodeAt(e++),u=t.charCodeAt(e++),c=i>>2,s=(i&3)<<4|r>>4,h=(r&15)<<2|u>>6,f=u&63,isNaN(r)?(s=(i&3)<<4,h=f=64):isNaN(u)&&(f=64),o=o+n.charAt(c)+n.charAt(s)+n.charAt(h)+n.charAt(f);while(e<t.length);return o},decode:function(t){var i="",o,s,h,c,f,u,e,r=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do c=n.indexOf(t.charAt(r++)),f=n.indexOf(t.charAt(r++)),u=n.indexOf(t.charAt(r++)),e=n.indexOf(t.charAt(r++)),o=c<<2|f>>4,s=(f&15)<<4|u>>2,h=(u&3)<<6|e,i=i+String.fromCharCode(o),u!=64&&(i=i+String.fromCharCode(s)),e!=64&&(i=i+String.fromCharCode(h));while(r<t.length);return i}}}),function(n,t){typeof define=="function"&&define.amd?define("strophe-sha1",function(){return t()}):n.SHA1=t()}(globalThis,function(){function t(t,i){t[i>>5]|=128<<24-i%32;t[(i+64>>9<<4)+15]=i;for(var l=new Array(80),f=1732584193,e=-271733879,h=-1732584194,c=271733878,a=-1009589776,r,y,p,w,b,k,d,v=0;v<t.length;v+=16){for(p=f,w=e,b=h,k=c,d=a,r=0;r<80;r++)l[r]=r<16?t[v+r]:u(l[r-3]^l[r-8]^l[r-14]^l[r-16],1),y=n(n(u(f,5),o(r,e,h,c)),n(n(a,l[r]),s(r))),a=c,c=h,h=u(e,30),e=f,f=y;f=n(f,p);e=n(e,w);h=n(h,b);c=n(c,k);a=n(a,d)}return[f,e,h,c,a]}function o(n,t,i,r){return n<20?t&i|~t&r:n<40?t^i^r:n<60?t&i|t&r|i&r:t^i^r}function s(n){return n<20?1518500249:n<40?1859775393:n<60?-1894007588:-899497514}function r(n,r){var f=i(n),e,o,u,s;for(f.length>16&&(f=t(f,n.length*8)),e=new Array(16),o=new Array(16),u=0;u<16;u++)e[u]=f[u]^909522486,o[u]=f[u]^1549556828;return s=t(e.concat(i(r)),512+r.length*8),t(o.concat(s),672)}function n(n,t){var i=(n&65535)+(t&65535),r=(n>>16)+(t>>16)+(i>>16);return r<<16|i&65535}function u(n,t){return n<<t|n>>>32-t}function i(n){for(var i=[],t=0;t<n.length*8;t+=8)i[t>>5]|=(n.charCodeAt(t/8)&255)<<24-t%32;return i}function f(n){for(var i="",t=0;t<n.length*32;t+=8)i+=String.fromCharCode(n[t>>5]>>>24-t%32&255);return i}function e(n){for(var r="",u,i,t=0;t<n.length*4;t+=3)for(u=(n[t>>2]>>8*(3-t%4)&255)<<16|(n[t+1>>2]>>8*(3-(t+1)%4)&255)<<8|n[t+2>>2]>>8*(3-(t+2)%4)&255,i=0;i<4;i++)r+=t*8+i*6>n.length*32?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(u>>6*(3-i)&63);return r}return{b64_hmac_sha1:function(n,t){return e(r(n,t))},b64_sha1:function(n){return e(t(i(n),n.length*8))},binb2str:f,core_hmac_sha1:r,str_hmac_sha1:function(n,t){return f(r(n,t))},str_sha1:function(n){return f(t(i(n),n.length*8))}}}),function(n,t){typeof define=="function"&&define.amd?define("strophe-md5",function(){return t()}):n.MD5=t()}(globalThis,function(){var u=function(n,t){var i=(n&65535)+(t&65535),r=(n>>16)+(t>>16)+(i>>16);return r<<16|i&65535},s=function(n,t){return n<<t|n>>>32-t},e=function(n){for(var i=[],t=0;t<n.length*8;t+=8)i[t>>5]|=(n.charCodeAt(t/8)&255)<<t%32;return i},h=function(n){for(var i="",t=0;t<n.length*32;t+=8)i+=String.fromCharCode(n[t>>5]>>>t%32&255);return i},c=function(n){for(var i="0123456789abcdef",r="",t=0;t<n.length*4;t++)r+=i.charAt(n[t>>2]>>t%4*8+4&15)+i.charAt(n[t>>2]>>t%4*8&15);return r},f=function(n,t,i,r,f,e){return u(s(u(u(t,n),u(r,e)),f),i)},n=function(n,t,i,r,u,e,o){return f(t&i|~t&r,n,t,u,e,o)},t=function(n,t,i,r,u,e,o){return f(t&r|i&~r,n,t,u,e,o)},i=function(n,t,i,r,u,e,o){return f(t^i^r,n,t,u,e,o)},r=function(n,t,i,r,u,e,o){return f(i^(t|~r),n,t,u,e,o)},o=function(f,e){var l;f[e>>5]|=128<<e%32;f[(e+64>>>9<<4)+14]=e;var o=1732584193,s=-271733879,h=-1732584194,c=271733878,a,v,y,p;for(l=0;l<f.length;l+=16)a=o,v=s,y=h,p=c,o=n(o,s,h,c,f[l+0],7,-680876936),c=n(c,o,s,h,f[l+1],12,-389564586),h=n(h,c,o,s,f[l+2],17,606105819),s=n(s,h,c,o,f[l+3],22,-1044525330),o=n(o,s,h,c,f[l+4],7,-176418897),c=n(c,o,s,h,f[l+5],12,1200080426),h=n(h,c,o,s,f[l+6],17,-1473231341),s=n(s,h,c,o,f[l+7],22,-45705983),o=n(o,s,h,c,f[l+8],7,1770035416),c=n(c,o,s,h,f[l+9],12,-1958414417),h=n(h,c,o,s,f[l+10],17,-42063),s=n(s,h,c,o,f[l+11],22,-1990404162),o=n(o,s,h,c,f[l+12],7,1804603682),c=n(c,o,s,h,f[l+13],12,-40341101),h=n(h,c,o,s,f[l+14],17,-1502002290),s=n(s,h,c,o,f[l+15],22,1236535329),o=t(o,s,h,c,f[l+1],5,-165796510),c=t(c,o,s,h,f[l+6],9,-1069501632),h=t(h,c,o,s,f[l+11],14,643717713),s=t(s,h,c,o,f[l+0],20,-373897302),o=t(o,s,h,c,f[l+5],5,-701558691),c=t(c,o,s,h,f[l+10],9,38016083),h=t(h,c,o,s,f[l+15],14,-660478335),s=t(s,h,c,o,f[l+4],20,-405537848),o=t(o,s,h,c,f[l+9],5,568446438),c=t(c,o,s,h,f[l+14],9,-1019803690),h=t(h,c,o,s,f[l+3],14,-187363961),s=t(s,h,c,o,f[l+8],20,1163531501),o=t(o,s,h,c,f[l+13],5,-1444681467),c=t(c,o,s,h,f[l+2],9,-51403784),h=t(h,c,o,s,f[l+7],14,1735328473),s=t(s,h,c,o,f[l+12],20,-1926607734),o=i(o,s,h,c,f[l+5],4,-378558),c=i(c,o,s,h,f[l+8],11,-2022574463),h=i(h,c,o,s,f[l+11],16,1839030562),s=i(s,h,c,o,f[l+14],23,-35309556),o=i(o,s,h,c,f[l+1],4,-1530992060),c=i(c,o,s,h,f[l+4],11,1272893353),h=i(h,c,o,s,f[l+7],16,-155497632),s=i(s,h,c,o,f[l+10],23,-1094730640),o=i(o,s,h,c,f[l+13],4,681279174),c=i(c,o,s,h,f[l+0],11,-358537222),h=i(h,c,o,s,f[l+3],16,-722521979),s=i(s,h,c,o,f[l+6],23,76029189),o=i(o,s,h,c,f[l+9],4,-640364487),c=i(c,o,s,h,f[l+12],11,-421815835),h=i(h,c,o,s,f[l+15],16,530742520),s=i(s,h,c,o,f[l+2],23,-995338651),o=r(o,s,h,c,f[l+0],6,-198630844),c=r(c,o,s,h,f[l+7],10,1126891415),h=r(h,c,o,s,f[l+14],15,-1416354905),s=r(s,h,c,o,f[l+5],21,-57434055),o=r(o,s,h,c,f[l+12],6,1700485571),c=r(c,o,s,h,f[l+3],10,-1894986606),h=r(h,c,o,s,f[l+10],15,-1051523),s=r(s,h,c,o,f[l+1],21,-2054922799),o=r(o,s,h,c,f[l+8],6,1873313359),c=r(c,o,s,h,f[l+15],10,-30611744),h=r(h,c,o,s,f[l+6],15,-1560198380),s=r(s,h,c,o,f[l+13],21,1309151649),o=r(o,s,h,c,f[l+4],6,-145523070),c=r(c,o,s,h,f[l+11],10,-1120210379),h=r(h,c,o,s,f[l+2],15,718787259),s=r(s,h,c,o,f[l+9],21,-343485551),o=u(o,a),s=u(s,v),h=u(h,y),c=u(c,p);return[o,s,h,c]};return{hexdigest:function(n){return c(o(e(n),n.length*8))},hash:function(n){return h(o(e(n),n.length*8))}}}),function(n,t){typeof define=="function"&&define.amd?define("strophe-utils",function(){return t()}):n.stropheUtils=t()}(globalThis,function(){return{utf16to8:function(n){for(var t,i="",u=n.length,r=0;r<u;r++)t=n.charCodeAt(r),t>=0&&t<=127?i+=n.charAt(r):t>2047?(i+=String.fromCharCode(224|t>>12&15),i+=String.fromCharCode(128|t>>6&63),i+=String.fromCharCode(128|t>>0&63)):(i+=String.fromCharCode(192|t>>6&31),i+=String.fromCharCode(128|t>>0&63));return i},addCookies:function(n){var i,t,r,o,u,f,e;for(i in n||{})u="",f="",e="",t=n[i],r=typeof t=="object",o=escape(unescape(r?t.value:t)),r&&(u=t.expires?";expires="+t.expires:"",f=t.domain?";domain="+t.domain:"",e=t.path?";path="+t.path:""),document.cookie=i+"="+o+u+f+e}}}),function(n,t){if(typeof define=="function"&&define.amd)define("strophe-polyfill",[],function(){return t()});else return t()}(globalThis,function(){Function.prototype.bind||(Function.prototype.bind=function(n){var i=this,t=Array.prototype.slice,r=Array.prototype.concat,u=t.call(arguments,1);return function(){return i.apply(n?n:this,r.call(u,t.call(arguments,0)))}});Array.isArray||(Array.isArray=function(n){return Object.prototype.toString.call(n)==="[object Array]"});Array.prototype.indexOf||(Array.prototype.indexOf=function(n){var i=this.length,t=Number(arguments[1])||0;for(t=t<0?Math.ceil(t):Math.floor(t),t<0&&(t+=i);t<i;t++)if(t in this&&this[t]===n)return t;return-1})}),Array.prototype.forEach||(Array.prototype.forEach=function(n,t){var u,i,r,f,e;if(this===null)throw new TypeError(" this is null or not defined");if(r=Object(this),f=r.length>>>0,typeof n!="function")throw new TypeError(n+" is not a function");for(arguments.length>1&&(u=t),i=0;i<f;)i in r&&(e=r[i],n.call(u,e,i,r)),i++}),function(n,t){if(typeof define=="function"&&define.amd)define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils","strophe-polyfill"],function(){return t.apply(this,arguments)});else{var i=t(n.SHA1,n.Base64,n.MD5,n.stropheUtils);window.Strophe=i.Strophe;window.$build=i.$build;window.$iq=i.$iq;window.$msg=i.$msg;window.$pres=i.$pres;window.SHA1=i.SHA1;window.Base64=i.Base64;window.MD5=i.MD5;window.b64_hmac_sha1=i.SHA1.b64_hmac_sha1;window.b64_sha1=i.SHA1.b64_sha1;window.str_hmac_sha1=i.SHA1.str_hmac_sha1;window.str_sha1=i.SHA1.str_sha1}}(globalThis,function(n,t,i,r){function e(n,t){return new u.Builder(n,t)}function s(n){return new u.Builder("message",n)}function f(n){return new u.Builder("iq",n)}function o(n){return new u.Builder("presence",n)}var u;return u={VERSION:"1.2.9",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(n){for(var t=0;t<u.XHTML.tags.length;t++)if(n==u.XHTML.tags[t])return!0;return!1},validAttribute:function(n,t){if(typeof u.XHTML.attributes[n]!="undefined"&&u.XHTML.attributes[n].length>0)for(var i=0;i<u.XHTML.attributes[n].length;i++)if(t==u.XHTML.attributes[n][i])return!0;return!1},validCSS:function(n){for(var t=0;t<u.XHTML.css.length;t++)if(n==u.XHTML.css[t])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(n,t){u.NS[n]=t},forEachChild:function(n,t,i){for(var f,r=0;r<n.childNodes.length;r++)f=n.childNodes[r],f.nodeType==u.ElementType.NORMAL&&(!t||this.isTagEqual(f,t))&&i(f)},isTagEqual:function(n,t){return n.tagName==t},_xmlGenerator:null,_makeGenerator:function(){var n;return document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(n=this._getIEXmlDom(),n.appendChild(n.createElement("strophe"))):n=document.implementation.createDocument("jabber:client","strophe",null),n},xmlGenerator:function(){return u._xmlGenerator||(u._xmlGenerator=u._makeGenerator()),u._xmlGenerator},_getIEXmlDom:function(){for(var n=null,i=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],t=0;t<i.length;t++)if(n===null)try{n=new ActiveXObject(i[t])}catch(r){n=null}else break;return n},xmlElement:function(n){var f,e,o,r,t,i;if(!n)return null;for(f=u.xmlGenerator().createElement(n),e=1;e<arguments.length;e++)if(t=arguments[e],t)if(typeof t=="string"||typeof t=="number")f.appendChild(u.xmlTextNode(t));else if(typeof t=="object"&&typeof t.sort=="function")for(o=0;o<t.length;o++)i=t[o],typeof i=="object"&&typeof i.sort=="function"&&i[1]!==undefined&&i[1]!==null&&f.setAttribute(i[0],i[1]);else if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&t[r]!==undefined&&t[r]!==null&&f.setAttribute(r,t[r]);return f},xmlescape:function(n){return n=n.replace(/\&/g,"&amp;"),n=n.replace(/</g,"&lt;"),n=n.replace(/>/g,"&gt;"),n=n.replace(/'/g,"&apos;"),n.replace(/"/g,"&quot;")},xmlunescape:function(n){return n=n.replace(/\&amp;/g,"&"),n=n.replace(/&lt;/g,"<"),n=n.replace(/&gt;/g,">"),n=n.replace(/&apos;/g,"'"),n.replace(/&quot;/g,'"')},xmlTextNode:function(n){return u.xmlGenerator().createTextNode(n)},xmlHtmlNode:function(n){var t,i;return window.DOMParser?(i=new DOMParser,t=i.parseFromString(n,"text/xml")):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(n)),t},getText:function(n){var i,t;if(!n)return null;for(i="",n.childNodes.length===0&&n.nodeType==u.ElementType.TEXT&&(i+=n.nodeValue),t=0;t<n.childNodes.length;t++)n.childNodes[t].nodeType==u.ElementType.TEXT&&(i+=n.childNodes[t].nodeValue);return u.xmlescape(i)},copyElement:function(n){var t,i;if(n.nodeType==u.ElementType.NORMAL){for(i=u.xmlElement(n.tagName),t=0;t<n.attributes.length;t++)i.setAttribute(n.attributes[t].nodeName,n.attributes[t].value);for(t=0;t<n.childNodes.length;t++)i.appendChild(u.copyElement(n.childNodes[t]))}else n.nodeType==u.ElementType.TEXT&&(i=u.xmlGenerator().createTextNode(n.nodeValue));return i},createHtml:function(n){var t,r,o,e,f,i,s,h,c,l,a;if(n.nodeType==u.ElementType.NORMAL)if(e=n.nodeName.toLowerCase(),u.XHTML.validTag(e))try{for(r=u.xmlElement(e),t=0;t<u.XHTML.attributes[e].length;t++)if(f=u.XHTML.attributes[e][t],i=n.getAttribute(f),typeof i!="undefined"&&i!==null&&i!==""&&i!==!1&&i!==0)if(f=="style"&&typeof i=="object"&&typeof i.cssText!="undefined"&&(i=i.cssText),f=="style"){for(s=[],h=i.split(";"),o=0;o<h.length;o++)c=h[o].split(":"),l=c[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),u.XHTML.validCSS(l)&&(a=c[1].replace(/^\s*/,"").replace(/\s*$/,""),s.push(l+": "+a));s.length>0&&(i=s.join("; "),r.setAttribute(f,i))}else r.setAttribute(f,i);for(t=0;t<n.childNodes.length;t++)r.appendChild(u.createHtml(n.childNodes[t]))}catch(v){r=u.xmlTextNode("")}else for(r=u.xmlGenerator().createDocumentFragment(),t=0;t<n.childNodes.length;t++)r.appendChild(u.createHtml(n.childNodes[t]));else if(n.nodeType==u.ElementType.FRAGMENT)for(r=u.xmlGenerator().createDocumentFragment(),t=0;t<n.childNodes.length;t++)r.appendChild(u.createHtml(n.childNodes[t]));else n.nodeType==u.ElementType.TEXT&&(r=u.xmlTextNode(n.nodeValue));return r},escapeNode:function(n){return typeof n!="string"?n:n.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(n){return typeof n!="string"?n:n.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(n){return n.indexOf("@")<0?null:n.split("@")[0]},getDomainFromJid:function(n){var t=u.getBareJidFromJid(n),i;return t.indexOf("@")<0?t:(i=t.split("@"),i.splice(0,1),i.join("@"))},getResourceFromJid:function(n){var t=n.split("/");return t.length<2?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(n){return n?n.split("/")[0]:null},_handleError:function(n){typeof n.stack!="undefined"&&u.fatal(n.stack);n.sourceURL?u.fatal("error: "+this.handler+" "+n.sourceURL+":"+n.line+" - "+n.name+": "+n.message):n.fileName?u.fatal("error: "+this.handler+" "+n.fileName+":"+n.lineNumber+" - "+n.name+": "+n.message):u.fatal("error: "+n.message)},log:function(){return},debug:function(n){this.log(this.LogLevel.DEBUG,n)},info:function(n){this.log(this.LogLevel.INFO,n)},warn:function(n){this.log(this.LogLevel.WARN,n)},error:function(n){this.log(this.LogLevel.ERROR,n)},fatal:function(n){this.log(this.LogLevel.FATAL,n)},serialize:function(n){var i,f,t,r;if(!n)return null;for(typeof n.tree=="function"&&(n=n.tree()),f=n.nodeName,n.getAttribute("_realname")&&(f=n.getAttribute("_realname")),i="<"+f,t=0;t<n.attributes.length;t++)n.attributes[t].nodeName!="_realname"&&(i+=" "+n.attributes[t].nodeName+"='"+u.xmlescape(n.attributes[t].value)+"'");if(n.childNodes.length>0){for(i+=">",t=0;t<n.childNodes.length;t++){r=n.childNodes[t];switch(r.nodeType){case u.ElementType.NORMAL:i+=u.serialize(r);break;case u.ElementType.TEXT:i+=u.xmlescape(r.nodeValue);break;case u.ElementType.CDATA:i+="<![CDATA["+r.nodeValue+"]\]>"}}i+="<\/"+f+">"}else i+="/>";return i},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(n,t){u._connectionPlugins[n]=t}},u.Builder=function(n,t){(n=="presence"||n=="message"||n=="iq")&&(t&&!t.xmlns?t.xmlns=u.NS.CLIENT:t||(t={xmlns:u.NS.CLIENT}));this.nodeTree=u.xmlElement(n,t);this.node=this.nodeTree},u.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return u.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(n){for(var t in n)n.hasOwnProperty(t)&&(n[t]===undefined?this.node.removeAttribute(t):this.node.setAttribute(t,n[t]));return this},c:function(n,t,i){var r=u.xmlElement(n,t,i);return this.node.appendChild(r),typeof i!="string"&&typeof i!="number"&&(this.node=r),this},cnode:function(n){var t,r=u.xmlGenerator(),i;try{t=r.importNode!==undefined}catch(f){t=!1}return i=t?r.importNode(n,!0):u.copyElement(n),this.node.appendChild(i),this.node=i,this},t:function(n){var t=u.xmlTextNode(n);return this.node.appendChild(t),this},h:function(n){var i=document.createElement("body"),t;for(i.innerHTML=n,t=u.createHtml(i);t.childNodes.length>0;)this.node.appendChild(t.childNodes[0]);return this}},u.Handler=function(n,t,i,r,f,e,o){this.handler=n;this.ns=t;this.name=i;this.type=r;this.id=f;this.options=o||{matchBareFromJid:!1,ignoreNamespaceFragment:!1};this.options.matchBare&&(u.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare);this.from=this.options.matchBareFromJid?e?u.getBareJidFromJid(e):null:e;this.user=!0},u.Handler.prototype={getNamespace:function(n){var t=n.getAttribute("xmlns");return t&&this.options.ignoreNamespaceFragment&&(t=t.split("#")[0]),t},namespaceMatch:function(n){var t=!1,i;if(this.ns)i=this,u.forEachChild(n,null,function(n){i.getNamespace(n)===i.ns&&(t=!0)}),t=t||this.getNamespace(n)===this.ns;else return!0;return t},isMatch:function(n){var t=n.getAttribute("from"),i;return(this.options.matchBareFromJid&&(t=u.getBareJidFromJid(t)),i=n.getAttribute("type"),this.namespaceMatch(n)&&(!this.name||u.isTagEqual(n,this.name))&&(!this.type||(Array.isArray(this.type)?this.type.indexOf(i)!=-1:i==this.type))&&(!this.id||n.getAttribute("id")==this.id)&&(!this.from||t==this.from))?!0:!1},run:function(n){var t=null;try{t=this.handler(n)}catch(i){u._handleError(i);throw i;}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},u.TimedHandler=function(n,t){this.period=n;this.handler=t;this.lastCalled=(new Date).getTime();this.user=!0},u.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},u.Connection=function(n,t){var e,i,o,f;this.service=n;this.options=t||{};e=this.options.protocol||"";this._proto=n.indexOf("ws:")===0||n.indexOf("wss:")===0||e.indexOf("ws")===0?new u.Websocket(this):new u.Bosh(this);this._timeProvider=u.timeProvider||window;this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=!1;this.do_bind=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.protocolErrorHandlers={HTTP:{},websocket:{}};this._idleTimeout=null;this._disconnectTimeout=null;this.authenticated=!1;this.connected=!1;this.disconnecting=!1;this.do_authentication=!0;this.paused=!1;this.restored=!1;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=this._timeProvider.setTimeout(function(){this._onIdle()}.bind(this),100);r.addCookies(this.options.cookies);this.registerSASLMechanisms(this.options.mechanisms);for(i in u._connectionPlugins)u._connectionPlugins.hasOwnProperty(i)&&(o=u._connectionPlugins[i],f=function(){},f.prototype=o,this[i]=new f,this[i].init(this))},u.Connection.prototype={reset:function(){this.jid&&(this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(n){var t=u.getNodeFromJid(this.jid),i=(Math.floor(Math.random()*4026531840)+268435456).toString(16);return typeof n=="string"||typeof n=="number"?++this._uniqueId+":"+t+"-"+i+":"+n:++this._uniqueId+":"+t+"-"+i},addProtocolErrorHandler:function(n,t,i){this.protocolErrorHandlers[n][t]=i},connect:function(n,t,i,r,f,e,o){this.jid=n;this.authzid=u.getBareJidFromJid(this.jid);this.authcid=o||u.getNodeFromJid(this.jid);this.pass=t;this.servtype="xmpp";this.connect_callback=i;this.disconnecting=!1;this.connected=!1;this.authenticated=!1;this.restored=!1;this.domain=u.getDomainFromJid(this.jid);this._changeConnectStatus(u.Status.CONNECTING,null);this._proto._connect(r,f,e)},attach:function(n,t,i,r,f,e,o){if(this._proto instanceof u.Bosh)this._proto._attach(n,t,i,r,f,e,o);else throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};},isRestoreSupported:function(){return this._sessionCachingSupported()},isRestorable:function(n,t){if(this._sessionCachingSupported()){var i=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(this._proto._isRestorable(i,n))return typeof t==typeof undefined?!0:typeof i.cts!=typeof undefined&&Date.now()-Number(i.cts)<t*1e3}return!1},restore:function(n,t,i,r,u){if(this._sessionCachingSupported())return this._proto._restore(n,t,i,r,u);throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};},_sessionCachingSupported:function(){if(this._proto instanceof u.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_");window.sessionStorage.removeItem("_strophe_")}catch(n){return!1}return!0}return!1},xmlInput:function(){return},xmlOutput:function(){return},rawInput:function(){return},rawOutput:function(){return},nextValidRid:function(){return},send:function(n){if(n!==null){if(typeof n.sort=="function")for(var t=0;t<n.length;t++)this._queueData(n[t]);else typeof n.tree=="function"?this._queueData(n.tree()):this._queueData(n);this._proto._send()}},flush:function(){this._timeProvider.clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(n,t,i,r){var e=null,h=this,f;typeof n.tree=="function"&&(n=n.tree());f=n.getAttribute("id");f||(f=this.getUniqueId("sendIQ"),n.setAttribute("id",f));var o=n.getAttribute("to"),s=this.jid,c=this.addHandler(function(n){var c,r,f;if(e&&h.deleteTimedHandler(e),c=!1,r=n.getAttribute("from"),r!==o&&(o||r!==u.getBareJidFromJid(s)&&r!==u.getDomainFromJid(s)&&r!==s)||(c=!0),!c)throw{name:"StropheError",message:"Got answer to IQ from wrong jid:"+r+"\nExpected jid: "+o};if(f=n.getAttribute("type"),f=="result")t&&t(n);else if(f=="error")i&&i(n);else throw{name:"StropheError",message:"Got bad IQ type of "+f};},null,"iq",["error","result"],f);return r&&(e=this.addTimedHandler(r,function(){return h.deleteHandler(c),i&&i(null),!1})),this.send(n),f},_queueData:function(n){if(n===null||!n.tagName||!n.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(n)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=this._timeProvider.setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(n,t){var i=new u.TimedHandler(n,t);return this.addTimeds.push(i),i},deleteTimedHandler:function(n){this.removeTimeds.push(n)},addHandler:function(n,t,i,r,f,e,o){var s=new u.Handler(n,t,i,r,f,e,o);return this.addHandlers.push(s),s},deleteHandler:function(n){this.removeHandlers.push(n);var t=this.addHandlers.indexOf(n);t>=0&&this.addHandlers.splice(t,1)},registerSASLMechanisms:function(n){this.mechanisms={};n=n||[u.SASLAnonymous,u.SASLExternal,u.SASLMD5,u.SASLOAuthBearer,u.SASLPlain,u.SASLSHA1];n.forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(n){this.mechanisms[n.prototype.name]=n},disconnect:function(n){if(this._changeConnectStatus(u.Status.DISCONNECTING,n),u.info("Disconnect was called because: "+n),this.connected){var t=!1;this.disconnecting=!0;this.authenticated&&(t=o({xmlns:u.NS.CLIENT,type:"unavailable"}));this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this));this._proto._disconnect(t)}else u.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests()},_changeConnectStatus:function(n,t){var i,r;for(i in u._connectionPlugins)if(u._connectionPlugins.hasOwnProperty(i)&&(r=this[i],r.statusChanged))try{r.statusChanged(n,t)}catch(e){u.error(""+i+" plugin caused an exception changing status: "+e)}if(this.connect_callback)try{this.connect_callback(n,t)}catch(f){u._handleError(f);u.error("User connection callback caused an exception: "+f)}},_doDisconnect:function(n){typeof this._idleTimeout=="number"&&this._timeProvider.clearTimeout(this._idleTimeout);this._disconnectTimeout!==null&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);u.debug("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=!1;this.disconnecting=!1;this.restored=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(u.Status.DISCONNECTED,n);this.connected=!1},_dataRecv:function(n,t){var i=this._proto._reqToData(n),e,s,o,r,h,f;if(i!==null){for(this.xmlInput!==u.Connection.prototype.xmlInput&&(i.nodeName===this._proto.strip&&i.childNodes.length?this.xmlInput(i.childNodes[0]):this.xmlInput(i)),this.rawInput!==u.Connection.prototype.rawInput&&(t?this.rawInput(t):this.rawInput(u.serialize(i)));this.removeHandlers.length>0;)s=this.removeHandlers.pop(),e=this.handlers.indexOf(s),e>=0&&this.handlers.splice(e,1);while(this.addHandlers.length>0)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return}if(o=i.getAttribute("type"),o!==null&&o=="terminate"){if(this.disconnecting)return;r=i.getAttribute("condition");h=i.getElementsByTagName("conflict");r!==null?(r=="remote-stream-error"&&h.length>0&&(r="conflict"),this._changeConnectStatus(u.Status.CONNFAIL,r)):this._changeConnectStatus(u.Status.CONNFAIL,"unknown");this._doDisconnect(r);return}f=this;u.forEachChild(i,null,function(n){var i,r,t;for(r=f.handlers,f.handlers=[],i=0;i<r.length;i++){t=r[i];try{t.isMatch(n)&&(f.authenticated||!t.user)?t.run(n)&&f.handlers.push(t):f.handlers.push(t)}catch(e){u.warn("Removing Strophe handlers due to uncaught exception: "+e.message)}}})}},mechanisms:{},_connect_cb:function(n,t,i){var r,c,l,f,e,s,o;u.debug("_connect_cb was called");this.connected=!0;try{r=this._proto._reqToData(n)}catch(h){if(h!="badformat")throw h;this._changeConnectStatus(u.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(r&&(this.xmlInput!==u.Connection.prototype.xmlInput&&(r.nodeName===this._proto.strip&&r.childNodes.length?this.xmlInput(r.childNodes[0]):this.xmlInput(r)),this.rawInput!==u.Connection.prototype.rawInput&&(i?this.rawInput(i):this.rawInput(u.serialize(r))),c=this._proto._connect_cb(r),c!==u.Status.CONNFAIL)){if(l=r.getElementsByTagNameNS?r.getElementsByTagNameNS(u.NS.STREAM,"features").length>0:r.getElementsByTagName("stream:features").length>0||r.getElementsByTagName("features").length>0,!l){this._proto._no_auth_received(t);return}if(f=[],o=r.getElementsByTagName("mechanism"),o.length>0)for(e=0;e<o.length;e++)s=u.getText(o[e]),this.mechanisms[s]&&f.push(this.mechanisms[s]);if(f.length===0&&r.getElementsByTagName("auth").length===0){this._proto._no_auth_received(t);return}this.do_authentication!==!1&&this.authenticate(f)}},sortMechanismsByPriority:function(n){for(var r,i,u,t=0;t<n.length-1;++t){for(i=t,r=t+1;r<n.length;++r)n[r].prototype.priority>n[i].prototype.priority&&(i=r);i!=t&&(u=n[t],n[t]=n[i],n[i]=u)}return n},_attemptSASLAuth:function(n){var i,r,f,o;for(n=this.sortMechanismsByPriority(n||[]),i=0,r=!1,i=0;i<n.length;++i)if(n[i].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new n[i];this._sasl_mechanism.onStart(this);f=e("auth",{xmlns:u.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(o=this._sasl_mechanism.onChallenge(this,null),f.t(t.encode(o)));this.send(f.tree());r=!0;break}return r},_attemptLegacyAuth:function(){u.getNodeFromJid(this.jid)===null?(this._changeConnectStatus(u.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(u.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(f({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:u.NS.AUTH}).c("username",{}).t(u.getNodeFromJid(this.jid)).tree()))},authenticate:function(n){this._attemptSASLAuth(n)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(n){var f=t.decode(u.getText(n)),i=this._sasl_mechanism.onChallenge(this,f),r=e("response",{xmlns:u.NS.SASL});return i!==""&&r.t(t.encode(i)),this.send(r.tree()),!0},_auth1_cb:function(){var n=f({type:"set",id:"_auth_2"}).c("query",{xmlns:u.NS.AUTH}).c("username",{}).t(u.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return u.getResourceFromJid(this.jid)||(this.jid=u.getBareJidFromJid(this.jid)+"/strophe"),n.up().c("resource",{}).t(u.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(n.tree()),!1},_sasl_success_cb:function(n){var i,r;if(this._sasl_data["server-signature"]){var f,o=t.decode(u.getText(n)),e=o.match(/([a-z]+)=([^,]+)(,|$)/);if(e[1]=="v"&&(f=e[2]),f!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}return u.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),i=[],r=function(n,t){while(n.length)this.deleteHandler(n.pop());return this._sasl_auth1_cb.bind(this)(t),!1},i.push(this._addSysHandler(function(n){r.bind(this)(i,n)}.bind(this),null,"stream:features",null,null)),i.push(this._addSysHandler(function(n){r.bind(this)(i,n)}.bind(this),u.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(n){var t,i,r;for(this.features=n,t=0;t<n.childNodes.length;t++)i=n.childNodes[t],i.nodeName=="bind"&&(this.do_bind=!0),i.nodeName=="session"&&(this.do_session=!0);if(this.do_bind)this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),r=u.getResourceFromJid(this.jid),r?this.send(f({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:u.NS.BIND}).c("resource",{}).t(r).tree()):this.send(f({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:u.NS.BIND}).tree());else return this._changeConnectStatus(u.Status.AUTHFAIL,null),!1;return!1},_sasl_bind_cb:function(n){var r,e,t,i;if(n.getAttribute("type")=="error")return u.info("SASL binding failed."),r=n.getElementsByTagName("conflict"),r.length>0&&(e="conflict"),this._changeConnectStatus(u.Status.AUTHFAIL,e),!1;if(t=n.getElementsByTagName("bind"),t.length>0)i=t[0].getElementsByTagName("jid"),i.length>0&&(this.jid=u.getText(i[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(f({type:"set",id:"_session_auth_2"}).c("session",{xmlns:u.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(u.Status.CONNECTED,null)));else return u.info("SASL binding failed."),this._changeConnectStatus(u.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(n){if(n.getAttribute("type")=="result")this.authenticated=!0,this._changeConnectStatus(u.Status.CONNECTED,null);else if(n.getAttribute("type")=="error")return u.info("Session creation failed."),this._changeConnectStatus(u.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(u.Status.AUTHFAIL,null),!1},_auth2_cb:function(n){return n.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(u.Status.CONNECTED,null)):n.getAttribute("type")=="error"&&(this._changeConnectStatus(u.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(n,t){var i=new u.TimedHandler(n,t);return i.user=!1,this.addTimeds.push(i),i},_addSysHandler:function(n,t,i,r,f){var e=new u.Handler(n,t,i,r,f);return e.user=!1,this.addHandlers.push(e),e},_onDisconnectTimeout:function(){return u.info("_onDisconnectTimeout was called"),this._changeConnectStatus(u.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var t,n,r,i,u;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());while(this.removeTimeds.length>0)n=this.removeTimeds.pop(),t=this.timedHandlers.indexOf(n),t>=0&&this.timedHandlers.splice(t,1);for(u=(new Date).getTime(),i=[],t=0;t<this.timedHandlers.length;t++)n=this.timedHandlers[t],(this.authenticated||!n.user)&&(r=n.lastCalled+n.period,r-u<=0?n.run()&&i.push(n):i.push(n));this.timedHandlers=i;this._timeProvider.clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=this._timeProvider.setTimeout(function(){this._onIdle()}.bind(this),100))}},u.SASLMechanism=function(n,t,i){this.name=n;this.isClientFirst=t;this.priority=i},u.SASLMechanism.prototype={test:function(){return!0},onStart:function(n){this._connection=n},onChallenge:function(){throw new Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},u.SASLAnonymous=function(){},u.SASLAnonymous.prototype=new u.SASLMechanism("ANONYMOUS",!1,10),u.SASLAnonymous.prototype.test=function(n){return n.authcid===null},u.SASLPlain=function(){},u.SASLPlain.prototype=new u.SASLMechanism("PLAIN",!0,20),u.SASLPlain.prototype.test=function(n){return n.authcid!==null},u.SASLPlain.prototype.onChallenge=function(n){var t=n.authzid;return t=t+"\x00",t=t+n.authcid,t=t+"\x00",t=t+n.pass,r.utf16to8(t)},u.SASLSHA1=function(){},u.SASLSHA1.prototype=new u.SASLMechanism("SCRAM-SHA-1",!0,40),u.SASLSHA1.prototype.test=function(n){return n.authcid!==null},u.SASLSHA1.prototype.onChallenge=function(u,f,e){var s=e||i.hexdigest(Math.random()*1234567890),o="n="+r.utf16to8(u.authcid);return o+=",r=",o+=s,u._sasl_data.cnonce=s,u._sasl_data["client-first-message-bare"]=o,o="n,,"+o,this.onChallenge=function(i,u){for(var c,s,b,e,l,a,v,f,y,h,k,d,p="c=biws,",w=i._sasl_data["client-first-message-bare"]+","+u+",",g=i._sasl_data.cnonce,nt=/([a-z]+)=([^,]+)(,|$)/,o;u.match(nt);){o=u.match(nt);u=u.replace(o[0],"");switch(o[1]){case"r":c=o[2];break;case"s":s=o[2];break;case"i":b=o[2]}}if(c.substr(0,g.length)!==g)return i._sasl_data={},i._sasl_failure_cb();for(p+="r="+c,w+=p,s=t.decode(s),s+="\x00\x00\x00\x01",y=r.utf16to8(i.pass),e=a=n.core_hmac_sha1(y,s),v=1;v<b;v++){for(l=n.core_hmac_sha1(y,n.binb2str(a)),f=0;f<5;f++)e[f]^=l[f];a=l}for(e=n.binb2str(e),h=n.core_hmac_sha1(e,"Client Key"),k=n.str_hmac_sha1(e,"Server Key"),d=n.core_hmac_sha1(n.str_sha1(n.binb2str(h)),w),i._sasl_data["server-signature"]=n.b64_hmac_sha1(k,w),f=0;f<5;f++)h[f]^=d[f];return p+(",p="+t.encode(n.binb2str(h)))}.bind(this),o},u.SASLMD5=function(){},u.SASLMD5.prototype=new u.SASLMechanism("DIGEST-MD5",!1,30),u.SASLMD5.prototype.test=function(n){return n.authcid!==null},u.SASLMD5.prototype._quote=function(n){return'"'+n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},u.SASLMD5.prototype.onChallenge=function(n,t,u){for(var a=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,h=u||i.hexdigest(""+Math.random()*1234567890),c="",l=null,s="",v="",e,o;t.match(a);){e=t.match(a);t=t.replace(e[0],"");e[2]=e[2].replace(/^"(.+)"$/,"$1");switch(e[1]){case"realm":c=e[2];break;case"nonce":s=e[2];break;case"qop":v=e[2];break;case"host":l=e[2]}}o=n.servtype+"/"+n.domain;l!==null&&(o=o+"/"+l);var y=r.utf16to8(n.authcid+":"+c+":"+this._connection.pass),p=i.hash(y)+":"+s+":"+h,w="AUTHENTICATE:"+o,f="";return f+="charset=utf-8,",f+="username="+this._quote(r.utf16to8(n.authcid))+",",f+="realm="+this._quote(c)+",",f+="nonce="+this._quote(s)+",",f+="nc=00000001,",f+="cnonce="+this._quote(h)+",",f+="digest-uri="+this._quote(o)+",",f+="response="+i.hexdigest(i.hexdigest(p)+":"+s+":00000001:"+h+":auth:"+i.hexdigest(w))+",",f+="qop=auth",this.onChallenge=function(){return""},f},u.SASLOAuthBearer=function(){},u.SASLOAuthBearer.prototype=new u.SASLMechanism("OAUTHBEARER",!0,50),u.SASLOAuthBearer.prototype.test=function(n){return n.authcid!==null},u.SASLOAuthBearer.prototype.onChallenge=function(n){var t="n,a=";return t=t+n.authzid,t=t+",",t=t+"\x01",t=t+"auth=Bearer ",t=t+n.pass,t=t+"\x01",t=t+"\x01",r.utf16to8(t)},u.SASLExternal=function(){},u.SASLExternal.prototype=new u.SASLMechanism("EXTERNAL",!0,60),u.SASLExternal.prototype.onChallenge=function(n){return n.authcid===n.authzid?"":n.authzid},{Strophe:u,$build:e,$msg:s,$iq:f,$pres:o,SHA1:n,Base64:t,MD5:i}}),function(n,t){if(typeof define=="function"&&define.amd)define("strophe-bosh",["strophe-core"],function(n){return t(n.Strophe,n.$build)});else return t(Strophe,$build)}(globalThis,function(n,t){return n.Request=function(t,i,r,u){this.id=++n._requestId;this.xmlData=t;this.data=n.serialize(t);this.origFunc=i;this.func=i;this.rid=r;this.date=NaN;this.sends=u||0;this.abort=!1;this.dead=null;this.age=function(){if(!this.date)return 0;var n=new Date;return(n-this.date)/1e3};this.timeDead=function(){if(!this.dead)return 0;var n=new Date;return(n-this.dead)/1e3};this.xhr=this._newXHR()},n.Request.prototype={getResponse:function(){var t=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(t=this.xhr.responseXML.documentElement,t.tagName=="parsererror"){n.error("invalid response received");n.error("responseText: "+this.xhr.responseText);n.error("responseXML: "+n.serialize(this.xhr.responseXML));throw"parsererror";}}else if(this.xhr.responseText){n.error("invalid response received");n.error("responseText: "+this.xhr.responseText);throw"badformat";}return t},_newXHR:function(){var n=null;return window.XMLHttpRequest?(n=new XMLHttpRequest,n.overrideMimeType&&n.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(n=new ActiveXObject("Microsoft.XMLHTTP")),n.onreadystatechange=this.func.bind(null,this),n}},n.Bosh=function(n){this._conn=n;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this._requests=[]},n.Bosh.prototype={strip:null,_buildBody:function(){var i=t("body",{rid:this.rid++,xmlns:n.NS.HTTPBIND});return this.sid!==null&&i.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),i},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.errors=0;this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_connect:function(t,i,r){var u,f;this.wait=t||this.wait;this.hold=i||this.hold;this.errors=0;u=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":n.NS.BOSH});r&&u.attrs({route:r});f=this._conn._connect_cb;this._requests.push(new n.Request(u.tree(),this._onRequestStateChange.bind(this,f.bind(this._conn)),u.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(t,i,r,u,f,e,o){this._conn.jid=t;this.sid=i;this.rid=r;this._conn.connect_callback=u;this._conn.domain=n.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=f||this.wait;this.hold=e||this.hold;this.window=o||this.window;this._conn._changeConnectStatus(n.Status.ATTACHED,null)},_isRestorable:function(t,i){return typeof t!="undefined"&&t!==null&&t.rid&&t.sid&&t.jid&&(typeof i=="undefined"||i===null||n.getBareJidFromJid(t.jid)===n.getBareJidFromJid(i))},_restore:function(n,t,i,r,u){var f=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(this._isRestorable(f,n))return this._conn.restored=!0,this._attach(f.jid,f.sid,f.rid,t,i,r,u),f;throw{name:"StropheSessionError",message:"_restore: no restorable session."};},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid,cts:Date.now()})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(t){var e=t.getAttribute("type"),i,o,r,u,f;if(e!==null&&e=="terminate")return i=t.getAttribute("condition"),n.error("BOSH-Connection failed: "+i),o=t.getElementsByTagName("conflict"),i!==null?(i=="remote-stream-error"&&o.length>0&&(i="conflict"),this._conn._changeConnectStatus(n.Status.CONNFAIL,i)):this._conn._changeConnectStatus(n.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(i),n.Status.CONNFAIL;this.sid||(this.sid=t.getAttribute("sid"));r=t.getAttribute("requests");r&&(this.window=parseInt(r,10));u=t.getAttribute("hold");u&&(this.hold=parseInt(u,10));f=t.getAttribute("wait");f&&(this.wait=parseInt(f,10))},_disconnect:function(n){this._sendTerminate(n)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295);this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return this._requests.length===0},_callProtocolErrorHandlers:function(n){var i=this._getRequestStatus(n),t;t=this._conn.protocolErrorHandlers.HTTP[i];t&&t.call(this,i)},_hitError:function(t){this.errors++;n.warn("request errored, status: "+t+", number of errors: "+this.errors);this.errors>4&&this._conn._onDisconnectTimeout()},_no_auth_received:function(t){t=t?t.bind(this._conn):this._conn._connect_cb.bind(this._conn);var i=this._buildBody();this._requests.push(new n.Request(i.tree(),this._onRequestStateChange.bind(this,t.bind(this._conn)),i.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var n;this._requests.length>0;)n=this._requests.pop(),n.abort=!0,n.xhr.abort(),n.xhr.onreadystatechange=function(){}},_onIdle:function(){var t=this._conn._data,r,i,u;if(this._conn.authenticated&&this._requests.length===0&&t.length===0&&!this._conn.disconnecting&&(n.debug("no requests during idle cycle, sending blank request"),t.push(null)),!this._conn.paused){if(this._requests.length<2&&t.length>0){for(r=this._buildBody(),i=0;i<t.length;i++)t[i]!==null&&(t[i]==="restart"?r.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":n.NS.BOSH}):r.cnode(t[i]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new n.Request(r.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),r.tree().getAttribute("rid")));this._throttledRequestHandler()}this._requests.length>0&&(u=this._requests[0].age(),this._requests[0].dead!==null&&this._requests[0].timeDead()>Math.floor(n.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),u>Math.floor(n.TIMEOUT*this.wait)&&(n.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(n.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}},_getRequestStatus:function(t,i){var r;if(t.xhr.readyState==4)try{r=t.xhr.status}catch(u){n.error("Caught an error while retrieving a request's status, reqStatus: "+r)}return typeof r=="undefined"&&(r=typeof i=="number"?i:0),r},_onRequestStateChange:function(t,i){var r,u,f;if(n.debug("request id "+i.id+"."+i.sends+" state changed to "+i.xhr.readyState),i.abort){i.abort=!1;return}if(i.xhr.readyState===4){if(r=this._getRequestStatus(i),this.disconnecting&&r>=400){this._hitError(r);this._callProtocolErrorHandlers(i);return}(r>0&&r<500||i.sends>5)&&(this._removeRequest(i),n.debug("request id "+i.id+" should now be removed"));r==200?(u=this._requests[0]==i,f=this._requests[1]==i,(f||u&&this._requests.length>0&&this._requests[0].age()>Math.floor(n.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(i.rid)+1),n.debug("request id "+i.id+"."+i.sends+" got 200"),t(i),this.errors=0):r===0||r>=400&&r<600||r>=12e3?(n.error("request id "+i.id+"."+i.sends+" error "+r+" happened"),this._hitError(r),this._callProtocolErrorHandlers(i),r>=400&&r<500&&(this._conn._changeConnectStatus(n.Status.DISCONNECTING,null),this._conn._doDisconnect())):n.error("request id "+i.id+"."+i.sends+" error "+r+" happened");(!(r>0&&r<500)||i.sends>5)&&this._throttledRequestHandler()}},_processRequest:function(t){var u=this,i=this._requests[t],f=this._getRequestStatus(i,-1),s,r,h;if(i.sends>this._conn.maxRetries){this._conn._onDisconnectTimeout();return}var e=i.age(),c=!isNaN(e)&&e>Math.floor(n.TIMEOUT*this.wait),o=i.dead!==null&&i.timeDead()>Math.floor(n.SECONDARY_TIMEOUT*this.wait),l=i.xhr.readyState==4&&(f<1||f>=500);if((c||o||l)&&(o&&n.error("Request "+this._requests[t].id+" timed out (secondary), restarting"),i.abort=!0,i.xhr.abort(),i.xhr.onreadystatechange=function(){},this._requests[t]=new n.Request(i.xmlData,i.origFunc,i.rid,i.sends),i=this._requests[t]),i.xhr.readyState===0){n.debug("request id "+i.id+"."+i.sends+" posting");try{s=this._conn.options.contentType||"text/xml; charset=utf-8";i.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0);typeof i.xhr.setRequestHeader!="undefined"&&i.xhr.setRequestHeader("Content-Type",s);this._conn.options.withCredentials&&(i.xhr.withCredentials=!0)}catch(a){n.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(n.Status.CONNFAIL,"bad-service");this._conn.disconnect();return}r=function(){var n,t;if(i.date=new Date,u._conn.options.customHeaders){n=u._conn.options.customHeaders;for(t in n)n.hasOwnProperty(t)&&i.xhr.setRequestHeader(t,n[t])}i.xhr.send(i.data)};i.sends>1?(h=Math.min(Math.floor(n.TIMEOUT*this.wait),Math.pow(i.sends,3))*1e3,this._conn._timeProvider.setTimeout(function(){r()},h)):r();i.sends++;this._conn.xmlOutput!==n.Connection.prototype.xmlOutput&&(i.xmlData.nodeName===this.strip&&i.xmlData.childNodes.length?this._conn.xmlOutput(i.xmlData.childNodes[0]):this._conn.xmlOutput(i.xmlData));this._conn.rawOutput!==n.Connection.prototype.rawOutput&&this._conn.rawOutput(i.data)}else n.debug("_processRequest: "+(t===0?"first":"second")+" request has readyState of "+i.xhr.readyState)},_removeRequest:function(t){n.debug("removing request");for(var i=this._requests.length-1;i>=0;i--)t==this._requests[i]&&this._requests.splice(i,1);t.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(n){var t=this._requests[n];t.dead===null&&(t.dead=new Date);this._processRequest(n)},_reqToData:function(n){try{return n.getResponse()}catch(t){if(t!="parsererror")throw t;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(t){var i,r;n.debug("_sendTerminate was called");i=this._buildBody().attrs({type:"terminate"});t&&i.cnode(t.tree());r=new n.Request(i.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),i.tree().getAttribute("rid"));this._requests.push(r);this._throttledRequestHandler()},_send:function(){this._conn._timeProvider.clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=this._conn._timeProvider.setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();this._conn._timeProvider.clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){(this._requests?n.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):n.debug("_throttledRequestHandler called with undefined requests"),this._requests&&this._requests.length!==0)&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},n}),function(n,t){if(typeof define=="function"&&define.amd)define("strophe-websocket",["strophe-core"],function(n){return t(n.Strophe,n.$build)});else return t(Strophe,$build)}(globalThis,function(n,t){return n.Websocket=function(n){var t,i;this._conn=n;this.strip="wrapper";t=n.service;t.indexOf("ws:")!==0&&t.indexOf("wss:")!==0&&(i="",i+=n.options.protocol==="ws"&&window.location.protocol!=="https:"?"ws":"wss",i+="://"+window.location.host,i+=t.indexOf("/")!==0?window.location.pathname+t:t,n.service=i)},n.Websocket.prototype={_buildStream:function(){return t("open",{xmlns:n.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(t,i){var o,f,u,e;if(o=t.getElementsByTagNameNS?t.getElementsByTagNameNS(n.NS.STREAM,"error"):t.getElementsByTagName("stream:error"),o.length===0)return!1;var s=o[0],r="",h="";for(f=0;f<s.childNodes.length;f++){if(u=s.childNodes[f],u.getAttribute("xmlns")!=="urn:ietf:params:xml:ns:xmpp-streams")break;u.nodeName==="text"?h=u.textContent:r=u.nodeName}return e="WebSocket stream error: ",e+=r?r:"unknown",h&&(e+=" - "+r),n.error(e),this._conn._changeConnectStatus(i,r),this._conn._doDisconnect(),!0},_reset:function(){return},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(t){var i=this._check_streamerror(t,n.Status.CONNFAIL);if(i)return n.Status.CONNFAIL},_handleStreamStart:function(t){var i=!1,u=t.getAttribute("xmlns"),r;return(typeof u!="string"?i="Missing xmlns in <open />":u!==n.NS.FRAMING&&(i="Wrong xmlns in <open />: "+u),r=t.getAttribute("version"),typeof r!="string"?i="Missing version in <open />":r!=="1.0"&&(i="Wrong version in <open />: "+r),i)?(this._conn._changeConnectStatus(n.Status.CONNFAIL,i),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(t){var r,i,u,f,e;if(t.data.indexOf("<open ")===0||t.data.indexOf("<?xml")===0){if(r=t.data.replace(/^(<\?.*?\?>\s*)*/,""),r==="")return;i=(new DOMParser).parseFromString(r,"text/xml").documentElement;this._conn.xmlInput(i);this._conn.rawInput(t.data);this._handleStreamStart(i)&&this._connect_cb(i)}else t.data.indexOf("<close ")===0?(this._conn.rawInput(t.data),this._conn.xmlInput(t),u=t.getAttribute("see-other-uri"),u?(this._conn._changeConnectStatus(n.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=u,this._connect()):(this._conn._changeConnectStatus(n.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(f=this._streamWrap(t.data),e=(new DOMParser).parseFromString(f,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(e,null,t.data))},_disconnect:function(i){var r,u;if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){i&&this._conn.send(i);r=t("close",{xmlns:n.NS.FRAMING});this._conn.xmlOutput(r);u=n.serialize(r);this._conn.rawOutput(u);try{this.socket.send(u)}catch(f){n.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){n.debug("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(n){return"<wrapper>"+n+"<\/wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(n){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(n.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):n.info("Websocket closed")},_no_auth_received:function(t){n.error("Server did not send any auth methods");this._conn._changeConnectStatus(n.Status.CONNFAIL,"Server did not send any auth methods");t&&(t=t.bind(this._conn),t());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(t){n.error("Websocket error "+t);this._conn._changeConnectStatus(n.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()},_onIdle:function(){var i=this._conn._data,t,r,u;if(i.length>0&&!this._conn.paused){for(t=0;t<i.length;t++)i[t]!==null&&(r=i[t]==="restart"?this._buildStream().tree():i[t],u=n.serialize(r),this._conn.xmlOutput(r),this._conn.rawOutput(u),this.socket.send(u));this._conn._data=[]}},_onMessage:function(t){var i,r,u='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(t.data===u){this._conn.rawInput(u);this._conn.xmlInput(t);this._conn.disconnecting||this._conn._doDisconnect();return}if(t.data.search("<open ")===0){if(i=(new DOMParser).parseFromString(t.data,"text/xml").documentElement,!this._handleStreamStart(i))return}else r=this._streamWrap(t.data),i=(new DOMParser).parseFromString(r,"text/xml").documentElement;if(!this._check_streamerror(i,n.Status.ERROR)){if(this._conn.disconnecting&&i.firstChild.nodeName==="presence"&&i.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(i);this._conn.rawInput(n.serialize(i));return}this._conn._dataRecv(i,t.data)}},_onOpen:function(){var t,i;n.info("Websocket open");t=this._buildStream();this._conn.xmlOutput(t.tree());i=n.serialize(t);this._conn.rawOutput(i);this.socket.send(i)},_reqToData:function(n){return n},_send:function(){this._conn.flush()},_sendRestart:function(){this._conn._timeProvider.clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}},n}),function(){typeof define=="function"&&define.amd&&define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(n){return n})}(this),n)if(typeof define=="function"&&define.amd){var t=n;typeof requirejs=="function"?requirejs(["strophe"],function(n){t(n.Strophe,n.$build,n.$msg,n.$iq,n.$pres)}):require(["strophe"],function(n){t(n.Strophe,n.$build,n.$msg,n.$iq,n.$pres)})}else return n(Strophe,$build,$msg,$iq,$pres)})(function(n,t,i,r,u){window.Strophe=n;window.$build=t;window.$msg=i;window.$iq=r;window.$pres=u});__bind=function(n,t){return function(){return n.apply(t,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(n){return this._connection=n,this._muc_handler=null,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user"),Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(n,t,i,r,u,f,e){var o,s,c,h=this;return s=this.test_append_nick(n,t),o=$pres({from:this._connection.jid,to:s}).c("x",{xmlns:Strophe.NS.MUC}),e!=null&&(o=o.c("history",e)),f!=null&&o.cnode(Strophe.xmlElement("password",[],f)),(c=this._muc_handler)==null&&(this._muc_handler=this._connection.addHandler(function(t){var f,c,i,e,o,l,s,r,u,a;if((f=t.getAttribute("from"),!f)||(o=f.split("/")[0],!h.rooms[o]))return!0;if(n=h.rooms[o],i={},t.nodeName==="message")i=n._message_handlers;else if(t.nodeName==="presence"&&(r=t.getElementsByTagName("x"),r.length>0))for(u=0,a=r.length;u<a;u++)if(l=r[u],s=l.getAttribute("xmlns"),s&&s.match(Strophe.NS.MUC)){i=n._presence_handlers;break}for(e in i)c=i[e],c(t,n)||delete i[e];return!0})),this.rooms.hasOwnProperty(n)||(this.rooms[n]=new XmppRoom(this,n,t,f),this.roomNames.push(n)),r&&this.rooms[n].addHandler("presence",r),i&&this.rooms[n].addHandler("message",i),u&&this.rooms[n].addHandler("roster",u),this._connection.send(o)},leave:function(n,t,i,r){var f,e,u,o;return f=this.roomNames.indexOf(n),delete this.rooms[n],f>=0&&(this.roomNames.splice(f,1),this.roomNames.length===0&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null)),o=this.test_append_nick(n,t),u=this._connection.getUniqueId(),e=$pres({type:"unavailable",id:u,from:this._connection.jid,to:o}),r!=null&&e.c("status",r),i!=null&&this._connection.addHandler(i,null,"presence",null,u),this._connection.send(e),u},message:function(n,t,i,r,u){var f,e,o,s;return s=this.test_append_nick(n,t),u=u||(t!=null?"chat":"groupchat"),e=this._connection.getUniqueId(),f=$msg({to:s,from:this._connection.jid,type:u,id:e}).c("body",{xmlns:Strophe.NS.CLIENT}).t(i),f.up(),r!=null&&(f.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).t(r),f.node.childNodes.length===0?(o=f.node.parentNode,f.up().up(),f.node.removeChild(o)):f.up().up()),f.c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(f),e},groupchat:function(n,t,i){return this.message(n,null,t,i)},invite:function(n,t,i){var r,u;return u=this._connection.getUniqueId(),r=$msg({from:this._connection.jid,to:n,id:u}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:t}),i!=null&&r.c("reason",i),this._connection.send(r),u},directInvite:function(n,t,i,r){var u,e,f;return f=this._connection.getUniqueId(),u={xmlns:"jabber:x:conference",jid:n},i!=null&&(u.reason=i),r!=null&&(u.password=r),e=$msg({from:this._connection.jid,to:t,id:f}).c("x",u),this._connection.send(e),f},queryOccupants:function(n,t,i){var r,u;return r={xmlns:Strophe.NS.DISCO_ITEMS},u=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",r),this._connection.sendIQ(u,t,i)},configure:function(n,t,i){var r,u;return r=$iq({to:n,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),u=r.tree(),this._connection.sendIQ(u,t,i)},cancelConfigure:function(n){var t,i;return t=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}),i=t.tree(),this._connection.sendIQ(i)},saveConfiguration:function(n,t,i,r){var e,u,o,f,s;if(u=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),t instanceof Form)t.type="submit",u.cnode(t.toXML());else for(u.c("x",{xmlns:"jabber:x:data",type:"submit"}),f=0,s=t.length;f<s;f++)e=t[f],u.cnode(e).up();return o=u.tree(),this._connection.sendIQ(o,i,r)},createInstantRoom:function(n,t,i){var r;return r=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this._connection.sendIQ(r.tree(),t,i)},setTopic:function(n,t){var i;return i=$msg({to:n,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(t),this._connection.send(i.tree())},_modifyPrivilege:function(n,t,i,r,u){var f;return f=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(t.node),i!=null&&f.c("reason",i),this._connection.sendIQ(f.tree(),r,u)},modifyRole:function(n,t,i,r,u,f){var e;return e=$build("item",{nick:t,role:i}),this._modifyPrivilege(n,e,r,u,f)},kick:function(n,t,i,r,u){return this.modifyRole(n,t,"none",i,r,u)},voice:function(n,t,i,r,u){return this.modifyRole(n,t,"participant",i,r,u)},mute:function(n,t,i,r,u){return this.modifyRole(n,t,"visitor",i,r,u)},op:function(n,t,i,r,u){return this.modifyRole(n,t,"moderator",i,r,u)},deop:function(n,t,i,r,u){return this.modifyRole(n,t,"participant",i,r,u)},modifyAffiliation:function(n,t,i,r,u,f){var e;return e=$build("item",{jid:t,affiliation:i}),this._modifyPrivilege(n,e,r,u,f)},ban:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"outcast",i,r,u)},member:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"member",i,r,u)},revoke:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"none",i,r,u)},owner:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"owner",i,r,u)},admin:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"admin",i,r,u)},changeNick:function(n,t){var i,r;return r=this.test_append_nick(n,t),i=$pres({from:this._connection.jid,to:r,id:this._connection.getUniqueId()}),this._connection.send(i.tree())},setStatus:function(n,t,i,r){var u,f;return f=this.test_append_nick(n,t),u=$pres({from:this._connection.jid,to:f}),i!=null&&u.c("show",i).up(),r!=null&&u.c("status",r),this._connection.send(u.tree())},listRooms:function(n,t,i){var r;return r=$iq({to:n,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),this._connection.sendIQ(r,t,i)},test_append_nick:function(n,t){return n+(t!=null?"/"+Strophe.escapeNode(t):"")}});XmppRoom=function(){function n(n,t,i,r){this.client=n;this.name=t;this.nick=i;this.password=r;this._roomRosterHandler=__bind(this._roomRosterHandler,this);this._addOccupant=__bind(this._addOccupant,this);this.roster={};this._message_handlers={};this._presence_handlers={};this._roster_handlers={};this._handler_ids=0;n.muc&&(this.client=n.muc);this.name=Strophe.getBareJidFromJid(t);this.addHandler("presence",this._roomRosterHandler)}return n.prototype.join=function(n,t,i){return this.client.join(this.name,this.nick,n,t,i,this.password)},n.prototype.leave=function(n,t){return this.client.leave(this.name,this.nick,n,t),delete this.client.rooms[this.name]},n.prototype.message=function(n,t,i,r){return this.client.message(this.name,n,t,i,r)},n.prototype.groupchat=function(n,t){return this.client.groupchat(this.name,n,t)},n.prototype.invite=function(n,t){return this.client.invite(this.name,n,t)},n.prototype.directInvite=function(n,t){return this.client.directInvite(this.name,n,t,this.password)},n.prototype.configure=function(n){return this.client.configure(this.name,n)},n.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)},n.prototype.saveConfiguration=function(n){return this.client.saveConfiguration(this.name,n)},n.prototype.queryOccupants=function(n,t){return this.client.queryOccupants(this.name,n,t)},n.prototype.setTopic=function(n){return this.client.setTopic(this.name,n)},n.prototype.modifyRole=function(n,t,i,r,u){return this.client.modifyRole(this.name,n,t,i,r,u)},n.prototype.kick=function(n,t,i,r){return this.client.kick(this.name,n,t,i,r)},n.prototype.voice=function(n,t,i,r){return this.client.voice(this.name,n,t,i,r)},n.prototype.mute=function(n,t,i,r){return this.client.mute(this.name,n,t,i,r)},n.prototype.op=function(n,t,i,r){return this.client.op(this.name,n,t,i,r)},n.prototype.deop=function(n,t,i,r){return this.client.deop(this.name,n,t,i,r)},n.prototype.modifyAffiliation=function(n,t,i,r,u){return this.client.modifyAffiliation(this.name,n,t,i,r,u)},n.prototype.ban=function(n,t,i,r){return this.client.ban(this.name,n,t,i,r)},n.prototype.member=function(n,t,i,r){return this.client.member(this.name,n,t,i,r)},n.prototype.revoke=function(n,t,i,r){return this.client.revoke(this.name,n,t,i,r)},n.prototype.owner=function(n,t,i,r){return this.client.owner(this.name,n,t,i,r)},n.prototype.admin=function(n,t,i,r){return this.client.admin(this.name,n,t,i,r)},n.prototype.changeNick=function(n){return this.nick=n,this.client.changeNick(this.name,n)},n.prototype.setStatus=function(n,t){return this.client.setStatus(this.name,this.nick,n,t)},n.prototype.addHandler=function(n,t){var i=this._handler_ids++;switch(n){case"presence":this._presence_handlers[i]=t;break;case"message":this._message_handlers[i]=t;break;case"roster":this._roster_handlers[i]=t;break;default:return this._handler_ids--,null}return i},n.prototype.removeHandler=function(n){return delete this._presence_handlers[n],delete this._message_handlers[n],delete this._roster_handlers[n]},n.prototype._addOccupant=function(n){var t;return t=new Occupant(n,this),this.roster[t.nick]=t,t},n.prototype._roomRosterHandler=function(t){var r,o,f,u,i,e;r=n._parsePresence(t);i=r.nick;u=r.newnick||null;switch(r.type){case"error":return;case"unavailable":u&&(r.nick=u,this.roster[i]&&this.roster[u]&&(this.roster[i].update(this.roster[u]),this.roster[u]=this.roster[i]),this.roster[i]&&!this.roster[u]&&(this.roster[u]=this.roster[i].update(r)));delete this.roster[i];break;default:this.roster[i]?this.roster[i].update(r):this._addOccupant(r)}e=this._roster_handlers;for(f in e)o=e[f],o(this.roster,this)||delete this._roster_handlers[f];return!0},n._parsePresence=function(n){var i,r,u,t,f,e,h,c,l,o,a,s,v,y,p,w;for(t={},i=n.attributes,t.nick=Strophe.getResourceFromJid(i.from.textContent),t.type=((l=i.type)!=null?l.textContent:void 0)||null,t.states=[],o=n.childNodes,f=0,h=o.length;f<h;f++){r=o[f];switch(r.nodeName){case"status":t.status=r.textContent||null;break;case"show":t.show=r.textContent||null;break;case"x":if(i=r.attributes,((a=i.xmlns)!=null?a.textContent:void 0)===Strophe.NS.MUC_USER)for(s=r.childNodes,e=0,c=s.length;e<c;e++){u=s[e];switch(u.nodeName){case"item":i=u.attributes;t.affiliation=((v=i.affiliation)!=null?v.textContent:void 0)||null;t.role=((y=i.role)!=null?y.textContent:void 0)||null;t.jid=((p=i.jid)!=null?p.textContent:void 0)||null;t.newnick=((w=i.nick)!=null?w.textContent:void 0)||null;break;case"status":u.attributes.code&&t.states.push(u.attributes.code.textContent)}}}}return t},n}();RoomConfig=function(){function n(n){this.parse=__bind(this.parse,this);n!=null&&this.parse(n)}return n.prototype.parse=function(n){var o,t,i,r,s,h,u,f,e,l,a,v,c;for(h=n.getElementsByTagName("query")[0].childNodes,this.identities=[],this.features=[],this.x=[],u=0,l=h.length;u<l;u++){i=h[u];t=i.attributes;switch(i.nodeName){case"identity":for(s={},f=0,a=t.length;f<a;f++)o=t[f],s[o.name]=o.textContent;this.identities.push(s);break;case"feature":this.features.push(t["var"].textContent);break;case"x":if(t=i.childNodes[0].attributes,!1)break;for(c=i.childNodes,e=0,v=c.length;e<v;e++)(r=c[e],r.attributes.type)||(t=r.attributes,this.x.push({"var":t["var"].textContent,label:t.label.textContent||"",value:r.firstChild.textContent||""}))}}return{identities:this.identities,features:this.features,x:this.x}},n}();Occupant=function(){function n(n,t){this.room=t;this.update=__bind(this.update,this);this.admin=__bind(this.admin,this);this.owner=__bind(this.owner,this);this.revoke=__bind(this.revoke,this);this.member=__bind(this.member,this);this.ban=__bind(this.ban,this);this.modifyAffiliation=__bind(this.modifyAffiliation,this);this.deop=__bind(this.deop,this);this.op=__bind(this.op,this);this.mute=__bind(this.mute,this);this.voice=__bind(this.voice,this);this.kick=__bind(this.kick,this);this.modifyRole=__bind(this.modifyRole,this);this.update(n)}return n.prototype.modifyRole=function(n,t,i,r){return this.room.modifyRole(this.nick,n,t,i,r)},n.prototype.kick=function(n,t,i){return this.room.kick(this.nick,n,t,i)},n.prototype.voice=function(n,t,i){return this.room.voice(this.nick,n,t,i)},n.prototype.mute=function(n,t,i){return this.room.mute(this.nick,n,t,i)},n.prototype.op=function(n,t,i){return this.room.op(this.nick,n,t,i)},n.prototype.deop=function(n,t,i){return this.room.deop(this.nick,n,t,i)},n.prototype.modifyAffiliation=function(n,t,i,r){return this.room.modifyAffiliation(this.jid,n,t,i,r)},n.prototype.ban=function(n,t,i){return this.room.ban(this.jid,n,t,i)},n.prototype.member=function(n,t,i){return this.room.member(this.jid,n,t,i)},n.prototype.revoke=function(n,t,i){return this.room.revoke(this.jid,n,t,i)},n.prototype.owner=function(n,t,i){return this.room.owner(this.jid,n,t,i)},n.prototype.admin=function(n,t,i){return this.room.admin(this.jid,n,t,i)},n.prototype.update=function(n){return this.nick=n.nick||null,this.affiliation=n.affiliation||null,this.role=n.role||null,this.jid=n.jid||null,this.status=n.status||null,this.show=n.show||null,this},n}();Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(n){this._connection=n;this._identities=[];this._features=[];this._items=[];n.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);n.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(n,t,i,r){typeof i=="undefined"&&(i="");typeof r=="undefined"&&(r="");for(var u=0;u<this._identities.length;u++)if(this._identities[u].category==n&&this._identities[u].type==t&&this._identities[u].name==i&&this._identities[u].lang==r)return!1;return this._identities.push({category:n,type:t,name:i,lang:r}),!0},addFeature:function(n){for(var t=0;t<this._features.length;t++)if(this._features[t]==n)return!1;return this._features.push(n),!0},removeFeature:function(n){for(var t=0;t<this._features.length;t++)if(this._features[t]===n)return this._features.splice(t,1),!0;return!1},addItem:function(n,t,i,r){return i&&!r?!1:(this._items.push({jid:n,name:t,node:i,call_back:r}),!0)},info:function(n,t,i,r,u){var f={xmlns:Strophe.NS.DISCO_INFO},e;t&&(f.node=t);e=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",f);this._connection.sendIQ(e,i,r,u)},items:function(n,t,i,r,u){var f={xmlns:Strophe.NS.DISCO_ITEMS},e;t&&(f.node=t);e=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",f);this._connection.sendIQ(e,i,r,u)},_buildIQResult:function(n,t){var u=n.getAttribute("id"),i=n.getAttribute("from"),r=$iq({type:"result",id:u});return i!==null&&r.attrs({to:i}),r.c("query",t)},_onDiscoInfo:function(n){var u=n.getElementsByTagName("query")[0].getAttribute("node"),i={xmlns:Strophe.NS.DISCO_INFO},t,r;for(u&&(i.node=u),r=this._buildIQResult(n,i),t=0;t<this._identities.length;t++)i={category:this._identities[t].category,type:this._identities[t].type},this._identities[t].name&&(i.name=this._identities[t].name),this._identities[t].lang&&(i["xml:lang"]=this._identities[t].lang),r.c("identity",i).up();for(t=0;t<this._features.length;t++)r.c("feature",{"var":this._features[t]}).up();return this._connection.send(r.tree()),!0},_onDiscoItems:function(n){var e={xmlns:Strophe.NS.DISCO_ITEMS},u=n.getElementsByTagName("query")[0].getAttribute("node"),i,t,f,r;if(u){for(e.node=u,i=[],t=0;t<this._items.length;t++)if(this._items[t].node==u){i=this._items[t].call_back(n);break}}else i=this._items;for(f=this._buildIQResult(n,e),t=0;t<i.length;t++)r={jid:i[t].jid},i[t].name&&(r.name=i[t].name),i[t].node&&(r.node=i[t].node),f.c("item",r).up();return this._connection.send(f.tree()),!0}});Strophe.addConnectionPlugin("caps",{HASH:"sha-1",node:"http://strophe.im/strophejs/",_ver:"",_connection:null,_knownCapabilities:{},_jidVerIndex:{},init:function(n){if(this._connection=n,Strophe.addNamespace("CAPS","http://jabber.org/protocol/caps"),!this._connection.disco)throw"Caps plugin requires the disco plugin to be installed.";this._connection.disco.addFeature(Strophe.NS.CAPS);this._connection.addHandler(this._delegateCapabilities.bind(this),Strophe.NS.CAPS)},generateCapsAttrs:function(){return{xmlns:Strophe.NS.CAPS,hash:this.HASH,node:this.node,ver:this.generateVer()}},generateVer:function(){var t,n;if(this._ver!=="")return this._ver;var i="",r=this._connection.disco._identities.sort(this._sortIdentities),f=r.length,u=this._connection.disco._features.sort(),e=u.length;for(n=0;n<f;n++)t=r[n],i+=t.category+"/"+t.type+"/"+t.lang+"/"+t.name+"<";for(n=0;n<e;n++)i+=u[n]+"<";return this._ver=b64_sha1(i),this._ver},getCapabilitiesByJid:function(n){return this._jidVerIndex[n]?this._knownCapabilities[this._jidVerIndex[n]]:null},_delegateCapabilities:function(n){var t=n.getAttribute("from"),r=n.getElementsByTagName("c")[0],i=r.getAttribute("ver"),u=r.getAttribute("node");if(this._knownCapabilities[i])this._jidVerIndex[t]=i;else return this._requestCapabilities(t,u,i);return this._jidVerIndex[t]&&!this._jidVerIndex[t]===i||(this._jidVerIndex[t]=i),!0},_requestCapabilities:function(n,t,i){if(n!==this._connection.jid){var r=this._connection.disco.info(n,t+"#"+i);this._connection.addHandler(this._handleDiscoInfoReply.bind(this),Strophe.NS.DISCO_INFO,"iq","result",r,n)}return!0},_handleDiscoInfoReply:function(n){var e=n.getElementsByTagName("query")[0],i=e.getAttribute("node").split("#"),t=i[1],r=n.getAttribute("from"),f,o,u;if(this._knownCapabilities[t])this._jidVerIndex[r]&&!this._jidVerIndex[r]===t||(this._jidVerIndex[r]=t);else{for(f=e.childNodes,o=f.length,this._knownCapabilities[t]=[],u=0;u<o;u++)i=f[u],this._knownCapabilities[t].push({name:i.nodeName,attributes:i.attributes});this._jidVerIndex[r]=t}return!1},_sortIdentities:function(n,t){return n.category>t.category?1:n.category<t.category?-1:n.type>t.type?1:n.type<t.type?-1:n.lang>t.lang?1:n.lang<t.lang?-1:0}}),function(n,t){typeof define=="function"&&define.amd?define("strophe.rsm",["strophe"],function(n){return t(n.Strophe,n.$build,n.$iq,n.$msg,n.$pres),n}):t(n.Strophe,n.$build,n.$iq,n.$msg,n.$pres)}(this,function(n,t){n.addNamespace("RSM","http://jabber.org/protocol/rsm");n.RSM=function(n){var t,i;if(this.attribs=["max","first","last","after","before","index","count"],typeof n.xml!="undefined")this.fromXMLElement(n.xml);else for(t=0;t<this.attribs.length;t++)i=this.attribs[t],this[i]=n[i]};n.RSM.prototype={toXML:function(){for(var i,r=t("set",{xmlns:n.NS.RSM}),u=0;u<this.attribs.length;u++)i=this.attribs[u],typeof this[i]!="undefined"&&(r=r.c(i).t(this[i].toString()).up());return r.tree()},next:function(t){return new n.RSM({max:t,after:this.last})},previous:function(t){return new n.RSM({max:t,before:this.first})},fromXMLElement:function(t){for(var u,i,r=0;r<this.attribs.length;r++)u=this.attribs[r],i=t.getElementsByTagName(u)[0],typeof i!="undefined"&&i!==null&&(this[u]=n.getText(i),u=="first"&&(this.index=i.getAttribute("index")))}}}),function(){Strophe.addConnectionPlugin("mam",{_c:null,_p:["with","start","end"],init:function(n){this._c=n;Strophe.addNamespace("MAM","urn:xmpp:mam:2")},query:function(n,t){var l=this._p,a={type:"set",to:n},f,i,r,u,e,s,h,o,c;for(t=t||{},f={xmlns:Strophe.NS.MAM},!t.queryid||(f.queryid=t.queryid,delete t.queryid),i=$iq(a).c("query",f).c("x",{xmlns:"jabber:x:data",type:"submit"}),i.c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value").t(Strophe.NS.MAM).up().up(),r=0;r<this._p.length;r++)u=l[r],e=t[u],delete t[u],!e||i.c("field",{"var":u}).c("value").t(e).up().up();return i.up(),s=t.onMessage,delete t.onMessage,h=t.onComplete,delete t.onComplete,i.cnode(new Strophe.RSM(t).toXML()),o=this._c,c=o.addHandler(s,Strophe.NS.MAM,"message",null),this._c.sendIQ(i,function(){o.deleteHandler(c);h.apply(this,arguments)})}})}();Mustache=function(){var n=function(){};return n.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},context:{},render:function(n,t,i,r){if(r||(this.context=t,this.buffer=[]),!this.includes("",n)){if(r)return n;this.send(n);return}n=this.render_pragmas(n);var u=this.render_section(n,t,i);if(r)return this.render_tags(u,t,i,r);this.render_tags(u,t,i,r)},send:function(n){n!=""&&this.buffer.push(n)},render_pragmas:function(n){if(!this.includes("%",n))return n;var t=this,i=new RegExp(this.otag+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+this.ctag);return n.replace(i,function(n,i,r){if(!t.pragmas_implemented[i])throw{message:"This implementation of mustache doesn't understand the '"+i+"' pragma"};if(t.pragmas[i]={},r){var u=r.split("=");t.pragmas[i][u[0]]=u[1]}return""})},render_partial:function(n,t,i){if(n=this.trim(n),!i||i[n]===undefined)throw{message:"unknown_partial '"+n+"'"};return typeof t[n]!="object"?this.render(i[n],t,i,!0):this.render(i[n],t[n],i,!0)},render_section:function(n,t,i){if(!this.includes("#",n)&&!this.includes("^",n))return n;var r=this,u=new RegExp(this.otag+"(\\^|\\#)\\s*(.+)\\s*"+this.ctag+"\n*([\\s\\S]+?)"+this.otag+"\\/\\s*\\2\\s*"+this.ctag+"\\s*","mg");return n.replace(u,function(n,u,f,e){var o=r.find(f,t);return u=="^"?!o||r.is_array(o)&&o.length===0?r.render(e,t,i,!0):"":u=="#"?r.is_array(o)?r.map(o,function(n){return r.render(e,r.create_context(n),i,!0)}).join(""):r.is_object(o)?r.render(e,r.create_context(o),i,!0):typeof o=="function"?o.call(t,e,function(n){return r.render(n,t,i,!0)}):o?r.render(e,t,i,!0):"":void 0})},render_tags:function(n,t,i,r){for(var u=this,o=function(){return new RegExp(u.otag+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+u.ctag+"+","g")},s=o(),h=function(n,r,f){switch(r){case"!":return"";case"=":return u.set_delimiters(f),s=o(),"";case">":return u.render_partial(f,t,i);case"{":return u.find(f,t);default:return u.escape(u.find(f,t))}},f=n.split("\n"),e=0;e<f.length;e++)f[e]=f[e].replace(s,h,this),r||this.send(f[e]);if(r)return f.join("\n")},set_delimiters:function(n){var t=n.split(" ");this.otag=this.escape_regex(t[0]);this.ctag=this.escape_regex(t[1])},escape_regex:function(n){if(!arguments.callee.sRE)arguments.callee.sRE=new RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g");return n.replace(arguments.callee.sRE,"\\$1")},find:function(n,t){function r(n){return n===!1||n===0||n}n=this.trim(n);var i;return(r(t[n])?i=t[n]:r(this.context[n])&&(i=this.context[n]),typeof i=="function")?i.apply(t):i!==undefined?i:""},includes:function(n,t){return t.indexOf(this.otag+n)!=-1},escape:function(n){return n=String(n===null?"":n),n.replace(/&(?!\w+;)|["<>\\]/g,function(n){switch(n){case"&":return"&amp;";case"\\":return"\\\\";case'"':return'"';case"<":return"&lt;";case">":return"&gt;";default:return n}})},create_context:function(n){var t,i;return this.is_object(n)?n:(t=".",this.pragmas["IMPLICIT-ITERATOR"]&&(t=this.pragmas["IMPLICIT-ITERATOR"].iterator),i={},i[t]=n,i)},is_object:function(n){return n&&typeof n=="object"},is_array:function(n){return Object.prototype.toString.call(n)==="[object Array]"},trim:function(n){return n.replace(/^\s*|\s*$/g,"")},map:function(n,t){var r,u,i;if(typeof n.map=="function")return n.map(t);for(r=[],u=n.length,i=0;i<u;i++)r.push(t(n[i]));return r}},{name:"mustache.js",version:"0.3.0",to_html:function(t,i,r,u){var f=new n;return u&&(f.send=u),f.render(t,i,r),u?void 0:f.buffer.join("\n")}}}(),function(n){var i=Array.prototype.slice,t={dict:null,missingPattern:null,load:function(t,i){this.dict!==null?n.extend(this.dict,t):this.dict=t;i&&(this.missingPattern=i)},unload:function(){this.dict=null;this.missingPattern=null},_:function(n){var t=this.dict,r;if(t&&t.hasOwnProperty(n))n=t[n];else if(this.missingPattern!==null)return this.printf(this.missingPattern,n);return r=i.call(arguments),r[0]=n,this.printf.apply(this,r)},printf:function(t,r){return arguments.length<2?t:(r=n.isArray(r)?r:i.call(arguments,1),t.replace(/([^%]|^)%(?:(\d+)\$)?s/g,function(n,t,i){return i?t+r[parseInt(i)-1]:t+r.shift()}).replace(/%%s/g,"%s"))}};n.fn._t=function(){return n(this).html(t._.apply(t,arguments))};n.i18n=t}(jQuery);dateFormat=function(){var t=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,i=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,r=/[^-+\dA-Z]/g,n=function(n,t){for(n=String(n),t=t||2;n.length<t;)n="0"+n;return n};return function(u,f,e){var h=dateFormat;if(arguments.length!=1||Object.prototype.toString.call(u)!="[object String]"||/\d/.test(u)||(f=u,u=undefined),u=u?new Date(u):new Date,isNaN(u))throw SyntaxError("invalid date");f=String(h.masks[f]||f||h.masks["default"]);f.slice(0,4)=="UTC:"&&(f=f.slice(4),e=!0);var o=e?"getUTC":"get",c=u[o+"Date"](),y=u[o+"Day"](),l=u[o+"Month"](),p=u[o+"FullYear"](),s=u[o+"Hours"](),w=u[o+"Minutes"](),b=u[o+"Seconds"](),a=u[o+"Milliseconds"](),v=e?0:u.getTimezoneOffset(),k={d:c,dd:n(c),ddd:h.i18n.dayNames[y],dddd:h.i18n.dayNames[y+7],m:l+1,mm:n(l+1),mmm:h.i18n.monthNames[l],mmmm:h.i18n.monthNames[l+12],yy:String(p).slice(2),yyyy:p,h:s%12||12,hh:n(s%12||12),H:s,HH:n(s),M:w,MM:n(w),s:b,ss:n(b),l:n(a,3),L:n(a>99?Math.round(a/10):a),t:s<12?"a":"p",tt:s<12?"am":"pm",T:s<12?"A":"P",TT:s<12?"AM":"PM",Z:e?"UTC":(String(u).match(i)||[""]).pop().replace(r,""),o:(v>0?"-":"+")+n(Math.floor(Math.abs(v)/60)*100+Math.abs(v)%60,4),S:["th","st","nd","rd"][c%10>3?0:(c%100-c%10!=10)*c%10]};return f.replace(t,function(n){return n in k?k[n]:n.slice(1,n.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(n,t){return dateFormat(this,n,t)};
/*!
 * IFM Candy bundle 1.3.1-0
 * Copyright (c) IFM Infomaster. All rights reserved.
 */
Candy={};namespace("Ifm.Chat.Extras.FileTransfer",function(){this.transferFile=function(n,t,i,r){if(!i||!i.name||i.size===undefined||!i.type===undefined){Ifm.Diagnostics.Debug.print("Invalid argument file");return}var u=i.token?!1:!0,f;f=i.size>=1073741824?Math.round(i.size/1073741824)+" GB":i.size>=1048576?Math.round(i.size/1048576)+" MB":i.size>=1024?Math.round(i.size/1024)+" KB":i.size>1?i.size+" bytes":i.size===1?"1 byte":"0 bytes";t.events.waiting=function(t,e){var h=Candy.View.Pane.Room.getPane(n),c=h&&h.data(),s,a,o;if(!c){t.cancel();return}u&&(s=new Ifm.Messaging.FStringMessageWriter("FTTOKEN"),s.add(e.token).add(i.name).add(i.size).add(i.type).end(),Candies.send(n,s));var l="ft-item-"+t.id,v="<span id='"+l+"'> <span class='filetransfer-title'> "+r.FileTransfer.TransferTitle+" <\/span> <span class='filetransfer-file'> <b>"+i.name+"<\/b> <\/span> <span class='filetransfer-status'> "+r.FileTransfer.Waiting+" <\/span> <a class='filetransfer-accept' href='#'> "+r.FileTransfer.Accept+" <\/a> <a class='filetransfer-cancel' href='#'> "+r.FileTransfer.Cancel+" <\/a> <\/span>",y=Candy.View.Template.FileTransfer.item,p={view:v,time:Candy.Util.localizedTime((new Date).toGMTString())},w=Mustache.to_html(y,p);Candy.View.Pane.Room.appendToMessagePane(n,w);a=Candy.View.Pane.Chat.getTab(n);a.find(".transfer").show();o=$("#"+l);c.filetransfers[t.id]={filetransfer:t,viewelement:o};o.find(".filetransfer-cancel").click(function(){return t.cancel(),!1});u?o.find(".filetransfer-accept").remove():(o.find(".filetransfer-status").text(f),o.find(".filetransfer-accept").click(function(){return t.accept(),o.find(".filetransfer-accept").remove(),!1}))};t.events.started=function(t){var f=Candy.View.Pane.Room.getPane(n),e=f&&f.data(),i,o;e&&(i=e.filetransfers[t.id].viewelement,u?i.find(".filetransfer-status").text(r.FileTransfer.Sending):i.find(".filetransfer-status").text(r.FileTransfer.Receiving),o=Candy.View.Pane.Chat.getTab(n),o.find(".transfer").hide())};t.events.progress=function(t,i){var r=Candy.View.Pane.Room.getPane(n),u=r&&r.data(),f;u&&(f=u.filetransfers[t.id].viewelement,f.find(".filetransfer-status").text(i.percentage+"%"))};t.events.finished=function(t,e){var s=Candy.View.Pane.Room.getPane(n),h=s&&s.data(),o;h&&(o=h.filetransfers[t.id].viewelement,o.find(".filetransfer-cancel").remove(),u?(o.find(".filetransfer-status").text(r.FileTransfer.Sent),Candies.send(n,r.FileTransfer.TransferTitle+" "+i.name+" "+f+" "+r.FileTransfer.Complete)):(o.find(".filetransfer-status").text(r.FileTransfer.Received),o.append($("<a>",{"class":"filetransfer-open",click:e.openOrSaveFunc,href:"#",text:r.FileTransfer.Open}))),Ifm.Chat.Extras.MediaPreview.generateThumbnail(n,i.name,e.fileBlob,u))};t.events.canceled=function(t){var f=Candy.View.Pane.Room.getPane(n),e=f&&f.data(),i,o;e&&(i=e.filetransfers[t.id].viewelement,i.find(".filetransfer-status").text(r.FileTransfer.Canceled),i.find(".filetransfer-cancel").remove(),u||i.find(".filetransfer-accept").remove(),o=Candy.View.Pane.Chat.getTab(n),o.find(".transfer").hide())};t.events.error=function(t,i){var o=Candy.View.Pane.Room.getPane(n),e=o&&o.data(),f,s;e&&(Candy.View.Pane.Chat.Modal.showError("File Transfer: "+i.reason),e.filetransfers[t.id]&&(f=e.filetransfers[t.id].viewelement,f.find(".filetransfer-status").text(r.FileTransfer.Error),f.find(".filetransfer-cancel").remove(),u||f.find(".filetransfer-accept").remove(),s=Candy.View.Pane.Chat.getTab(n),s.find(".transfer").hide()))};u?t.transfer(i):t.receive(i.token)}});namespace("Ifm.Chat.Extras.MediaPreview",function(){function n(n,t,i){Candies.appendToMessagePane(n,t,i)}function r(n){var t=document.getElementById(n),i;t&&(i=u(),i.src=t.src,i.alt=t.alt)}function u(){var n=document.getElementById(t),r,u;if(n)r=document.getElementById(i);else{n=document.createElement("div");n.id=t;r=document.createElement("img");r.id=i;n.appendChild(r);document.body.appendChild(n);u=function(){n.style.display="none";r.src="";r.alt=""};n.onclick=function(){u()};$("body").on("keydown",function(t){t.which!==27||n.style.display||u()})}return n.style.display="",r}this.generateThumbnail=function(t,i,u,f){var e,o,s;this.isTypeSupported(u)&&(e=URL.createObjectURL(u),o=u.type,o.startsWith("image/")?(s="media-preview-thumbnail-"+(+new Date).toString(36),n(t,'<img id="'+s+'" class="media-preview-thumbnail" src="'+e+'" alt="'+i+'">',f),document.getElementById(s).onclick=function(){r(s)}):o.startsWith("audio/")?n(t,'<audio class="media-preview-player" controls><source src="'+e+'" type="'+u.type+'"><\/audio>',f):o.startsWith("video/")&&n(t,'<video class="media-preview-player" controls><source src="'+e+'" type="'+u.type+'"><\/video>',f))};this.isTypeSupported=function(n){var t=n.type;return t.startsWith("image/")||t.startsWith("audio/")||t.startsWith("video/")};var t="media-preview-modal-div",i="media-preview-modal-img"});namespace("Ifm.Chat.Extras.UrlPreview",function(){function n(n,t){return new Promise(function(i){$.ajax({url:"https://api.linkpreview.net?key="+n+"&q="+t,success:function(n){if(!n.title&&!n.description||!n.image){Ifm.Diagnostics.Debug.print("[Candy] [UrlPreview] preview not available for",t);return}var r='<div class="message-url-preview-container"><h1 class="message-url-preview-title">'+n.title+'<\/h1><h2 class="message-url-preview-subtitle">'+n.description+'<\/h2><img class="message-url-preview-img" src="'+n.image+'" alt="'+n.title+'"><\/div>';i({url:t,html:r})},error:function(n){Ifm.Diagnostics.Debug.print("[Candy] [UrlPreview] review service returned an error:",n.statusText)}})})}function t(n,t,i){var r=document.getElementById(n);if(r){var f='<a class="message-url" href="'+t+'" target="_blank">'+i+"<\/a>",e=t.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1").replace(/&(?!amp;)/g,"&amp;"),u=new RegExp("<a[^>]*href\\s*=\\s*['\"`]"+e+"['\"`].*?>.*?<\\/a\\s*>","gi");r.innerHTML.match(u)&&(r.innerHTML=r.innerHTML.replace(u,f))}}this.findAndGenerate=function(i,r){var o=this.settings&&this.settings.authKey,u,f,e,s;if(o&&(u=/<a[^>]*href\s*=\s*['"`]((?!javascript)[^\s#'"`]+?)['"`].*?>.*?<\/a\s*>/gi,u.test(r))){for(u.lastIndex=0,f=r,e="message-url-preview-"+(+new Date).toString(36),r='<span id="'+e+'">'+f+"<\/span>";(s=u.exec(f))!==null;)n(o,s[1]).then(function(n){t(e,n.url,n.html)});Candy.View.Pane.Room.scrollToBottom(i)}return r}}),function(){var t=namespace("Ifm.PhoneBar.Media"),n;t.Xmpp={events:defineEvents("initialized","reachable","unreachable","newcall","newmessage","callclosed","filetransfer","showtransferform")};t.Xmpp.instance=function(){function y(h){var l,a;buildCandy(h);buildCandies();Ifm.Net.TimeProvider.settings&&!Ifm.Net.TimeProvider.settings.service&&(Ifm.Net.TimeProvider.settings.service=i.config.service);Strophe.timeProvider=Ifm.Net.TimeProvider.getDefault();document.getElementById("candy")||(l=document.createElement("div"),l.id="candy",l.style.display="none",document.body.appendChild(l));t.theme?(t.theme.endsWith("/")||(t.theme+="/"),h("head").append('<link rel="stylesheet" href="'+t.theme+'default.css" />')):document.getElementById("candy").style.display="none";Candy.init(t.service,{core:{debug:t.debug,autojoin:[],disconnectWithoutTabs:!1},view:{assets:t.theme,language:t.language}});Candy.View.getOptions().crop.message.body=1e6;e=Ifm.Chat.Strings[t.language]||Ifm.Chat.Strings.it;a=window.onbeforeunload;window.addEventListener?(window.addEventListener("pagehide",a),window.addEventListener("unload",a)):window.attachEvent("onunload",a);window.onbeforeunload=null;Candy.View.Template.FileTransfer={item:'<li><small>{{time}}<\/small><div class="filetransfer"><span class="spacer">•<\/span><span class="message">{{{view}}}<\/span><\/div><\/li>'};Candy.View.Template.Message.header='<div class="header-wrapper"><span class="chatstatus-text header-text"><\/span><span timerid="" class="chatduration-text header-text"><\/span><button class="header-button hangup-button"><\/button><button class="header-button chattransfer-button"><\/button><button class="header-button chatclosetab-button" style="display:none;"><\/button><\/div>';h(Candy).on("candy:core.chat.connection",function(n,r){switch(r.status){case Strophe.Status.CONNECTING:i.log("PhoneBar.Media.Xmpp","Debug","Connecting to XMPP server");break;case Strophe.Status.ATTACHED:i.log("PhoneBar.Media.Xmpp","Debug","Connection restored with XMPP server");p();break;case Strophe.Status.CONNECTED:i.log("PhoneBar.Media.Xmpp","Debug","Connected to XMPP server");setTimeout(function(){t.mediatypes&Ifm.PhoneBar.Mediatypes.NearRealTime&&(Candy.Core.subscribe(t.getPresence_nrt(),t.getAgentPre(),t.presence),Candy.Core.subscribe(t.getDomain_nrt()),Candy.Core.subscribe(t.getAdmin_nrt()));t.mediatypes&Ifm.PhoneBar.Mediatypes.StoreAndForward&&(Candy.Core.subscribe(t.getPresence_saf(),t.getAgentPre(),t.presence),Candy.Core.subscribe(t.getDomain_saf()),Candy.Core.subscribe(t.getAdmin_saf()))},100);break;case Strophe.Status.DISCONNECTING:i.log("PhoneBar.Media.Xmpp","Debug","Disconnecting from XMPP server");break;case Strophe.Status.DISCONNECTED:i.log("PhoneBar.Media.Xmpp","Debug","Disconnected from XMPP server");Candy.Core.keepconnected?setTimeout(function(){Candy.Core.connect(t.server,null,t.getUsername())},200):f.unreachable.raise(i,{reason:null});break;case Strophe.Status.CONNFAIL:case Strophe.Status.AUTHFAIL:i.log("PhoneBar.Media.Xmpp","Debug","Connection with XMPP server failed",r.status);f.unreachable.raise(i,{reason:"Connection with XMPP server failed"});break;default:i.log("PhoneBar.Media.Xmpp","Debug","Connection with XMPP server in status",r.status)}});h(Candy).on("candy:view.connection.status-6",function(){Candy.View.Pane.Chat.Modal.hide();for(var n in u)s(n),Candy.View.Pane.Room.close(n);return r={},u={},o(),!1});h(Candy).on("candy:view.connection.status-7",function(){return Candy.View.Pane.Chat.Modal.hide(),!1});h(Candy).on("candy:core.presence",function(n,r){var e=r.stanza,u=e.attr("from"),o=e.attr("id"),s=e.attr("type")||"available";i.log("PhoneBar.Media.Xmpp","Debug","Got",s,"message from",u,"(id",o||"none",")");switch(s){case"subscribe":Candy.Core.subscribed(u,o);break;case"subscribed":Candy.Core.available(u);u.startsWith(t.presence)&&f.reachable.raise(i,{})}});h(Candy).on("candy:core:chat:invite",function(n,t){var r,u;(t.inviteType===undefined||t.inviteType==="DirectInvite")&&(r=t.inviteType||"Invite",i.log("PhoneBar.Media.Xmpp","Debug","Got",r,"message from",t.roomJid),u=Candy.Util.unescapeJid(t.roomJid),Candy.Core.Action.Jabber.Room.Join(u,null))});h(Candy).on("candy:core.message.chatstate",function(n,t){t.chatstate&&t.name!==Candy.Core.getUsername()&&(t.chatstate==="composing"?Candy.View.updatenotification(t.roomJid,t.displayName,t.chatstate,e.ChatStateComposing):Candy.View.deletenotification(t.roomJid))});h(Candy).on("candy:view.room.before-add",function(n,t){var f=t.roomJid,e,h=f.substr(1,36).toUpperCase(),s;if(!u[f]||!r[u[f]]){i.log("PhoneBar.Media.Xmpp","Debug","Matching conversation");s=!1;for(e in r)if(h===r[e].callGuid){r[e].roomJid=f;u[f]=Number(e);o();s=!0;break}if(!s)return i.log("PhoneBar.Media.Xmpp","Debug","Unable to match, no active call for this conversation"),!1}});h(Candy).on("candy:view.room.after-add",function(i,f){var a=f.roomJid,v=u[a],o,h,w,b,y,s;Candy.View.Pane.Chat.getTab(a).find(".label").html(r[v].campaignName);o=Candy.View.Pane.Room.getPane(a);h=o.find(".hangup-button");h.click(function(){n.close(v)});h=o.find(".chatclosetab-button");h.click(function(){n.ready(v)});h=o.find(".chattransfer-button");t.showtransfer?h.click(function(){n.showTransferDialog(v)}):h.hide();w=o.find(".chatstatus-text");w.text(e.ChatStateTalking);var k=setInterval(function(){var u=new Date,t=Math.abs(b-u),i=Math.floor(t/36e5),n,r;i<10&&(i="0"+i);t-=i*36e5;n=Math.floor(t/6e4);n<10&&(n="0"+n);t-=n*6e4;r=Math.floor(t/1e3);r<10&&(r="0"+r);p.text(i+":"+n+":"+r)},1e3),p=o.find(".chatduration-text"),l=p.data();l.timerid=k;b=new Date;p.text("00:00:00");y=o.find(".message-pane-wrapper")[0];s=o.find("[name=message]")[0];l=o.data();l.filetransfers={};Candy.View.Pane.Chat.fitTabs();s.onchange=s.oninput=function(){s.value===""?(Candy.Core.notifystate(a,"paused"),l.lastnotificationsent=0):(!l.lastnotificationsent||dT()-l.lastnotificationsent>5e3)&&(Candy.Core.notifystate(a,"composing"),l.lastnotificationsent=dT())};y.ondragover=s.ondragover=function(n){n||(n=window.event);n&&n.preventDefault()};y.ondrop=s.ondrop=function(n){var i,t;if((n||(n=window.event),n&&n.preventDefault(),Candy.Core.isConnected())&&r[v]!==undefined&&!r[v].terminated&&n.source!==y&&n.source!==s){if(i=n.dataTransfer.getData("text"),i){s.value=i;s.select();return}if(t=n.dataTransfer.files,t&&t.length>0){c(a,t[0]);return}}}});h(Candy).on("candy:view.pane.roster.after-update",function(n,t){var c=t.roomJid,e=u[c],s,h;if(t.action==="join"){if(e===undefined){i.log("PhoneBar.Media.Xmpp","Debug","Discarding unmatched conversation notification");return}r[e].externalPartyUserName||(s=t.user,h=s.getNick(),s.getRole()!==s.ROLE_MODERATOR&&h!==Candy.Core.getUsername()&&(r[e].externalPartyUserName=h,r[e].externalPartyDisplayName=s.getNick(!0),o(),f.newcall.raise(i,{callId:e})))}else Candy.View.deletenotification(c)});h(Candy).on("candy:view.message.before-show",function(n,t){var i,r;if(t.message.startsWith("*begin*"))return t.history||t.name===Candy.Core.getUsername()||(i=new Ifm.Messaging.FStringMessageReader(t.message),i.type==="FTTOKEN"?(r={token:i.data[0],name:i.data[1],size:Number(i.data[2]),type:i.data[3]},c(t.roomJid,r)):i.type==="FTUNSUP"&&(s(t.roomJid),Candy.View.Pane.Chat.Modal.showError(e.FileTransfer.NotAvailOther))),!1});h(Candy).on("candy:view.message.before-render",function(n,t){var o=t.templateData,c=u[o.roomJid],l=o.displayName,h=l.startsWith("Synthetic"),a=o.name!==r[c].externalPartyUserName,s;return h&&e.BotNickname&&(o.displayName=e.BotNickname,o.croppedDisplayName=Candy.Util.crop(o.displayName,Candy.View.getOptions().crop.message.nickname)),s={callId:c,displayName:o.displayName,sender:l,senderIsBot:h,sentFromHere:a,rawMessage:t.rawMessage,message:o.message,time:o.time,timestamp:o.timestamp,history:t.history,attributes:t.attributes},o.sender=s.sentFromHere?"sender-is-me":"sender-is-other",h&&(o.sender+=" sender-is-bot"),f.newmessage.raise(i,s),s.displayName&&s.displayName!==o.displayName&&(o.displayName=s.displayName,o.croppedDisplayName=Candy.Util.crop(o.displayName,Candy.View.getOptions().crop.message.nickname)),o.message=Ifm.Chat.Extras.UrlPreview.findAndGenerate(t.templateData.roomJid,s.message),o.message?void 0:!1});h(Candy).on("candy:view.message.after-show",function(n,t){if(t.name!==Candy.Core.getUsername()){var i=t.element;i.addClass("new-message-highlight");setTimeout(function(){i.removeClass("new-message-highlight")},4e3);Candy.View.movenotification(t.roomJid)}});h(Candy).on("candy:view.presence",function(n,t){var c=t.roomJid,l=u[c],p=r[l]&&r[l].transferred,h=Candy.View.Pane.Room.getPane(c),a,v,y;Candy.View.deletenotification(c);s(c);p?Candy.View.Pane.Room.close(c):h&&(Candy.View.Pane.Chat.getTab(c).addClass("closed"),h.find(".message-form-wrapper").css({visibility:"hidden"}),h.find(".message-pane-wrapper").css({opacity:".80"}),h.find(".hangup-button").hide(),h.find(".chattransfer-button").hide(),h.find(".chatclosetab-button").show(),a=h.find(".chatduration-text"),v=a.data(),clearInterval(v.timerid),y=h.find(".chatstatus-text"),y.text(e.ChatStateClosed));r[l]&&r[l].callClosed!==!0&&(f.callclosed.raise(i,{callId:l}),r[l].callClosed=!0,o())});h(Candy).on("candy:view.room.after-close",function(n,t){var s=t.roomJid,e=u[s];r[e]&&r[e].callClosed!==!0&&(f.callclosed.raise(i,{callId:e}),r[e].callClosed=!0);delete r[e];delete u[s];o()})}function p(){var n=window.sessionStorage.getItem("chat-session-calls");n&&(r=JSON.parse(n));n=window.sessionStorage.getItem("chat-session-rooms");n&&(u=JSON.parse(n))}function o(){window.sessionStorage.setItem("chat-session-calls",JSON.stringify(r));window.sessionStorage.setItem("chat-session-rooms",JSON.stringify(u))}function c(n,o){var s,c,h;if(n===undefined||u[n]===undefined){i.log("PhoneBar.Media.Xmpp","Debug","Invalid conversation");return}if(s=u[n],r[s].mediatype!==Ifm.PhoneBar.Mediatypes.NearRealTime){Ifm.Diagnostics.Debug.print("Unsupported mediatype of call",s);return}if(!Ifm.Net.Services.FileTransfer.isSupported()||!t.ftservice){isSender?Candy.View.Pane.Chat.Modal.showError(e.FileTransfer.NotAvailable):(c=new Ifm.Messaging.FStringMessageWriter("FTUNSUP").end(),Candies.send(n,c));return}h=Ifm.Net.Services.FileTransfer.create(t.ftservice);Ifm.Chat.Extras.FileTransfer.transferFile(n,h,o,e);f.filetransfer.raise(i,{callId:u[n],file:o,filetransfer:h})}function s(n){var r=Candy.View.Pane.Room.getPane(n),t=r&&r.data(),i;if(t&&t.filetransfers)for(i in t.filetransfers)t.filetransfers[i].filetransfer.cancel(),delete t.filetransfers[i]}function w(n,t){if(n&&r[n]){var i=r[n].roomJid;i&&u[i]&&(Candy.Core.Action.Jabber.Room.Leave(i),t&&Candy.View.Pane.Room.getPane(i)&&(s(i),Candy.View.Pane.Room.close(i)))}}function a(n,t){(t.mediatype===Ifm.PhoneBar.Mediatypes.NearRealTime||t.mediatype===Ifm.PhoneBar.Mediatypes.StoreAndForward)&&(n.log("PhoneBar.Media.Xmpp","Debug","Assignment event"),r[t.callId]=t,o())}function v(n,t){r[t.callId]&&(n.log("PhoneBar.Media.Xmpp","Debug","CallFailure event"),w(t.callId,!0))}if(!window.jQuery)throw Ifm.Diagnostics.Errors.miss("jQuery");if(!window.Strophe)throw Ifm.Diagnostics.Errors.miss("Candy/Libs");if(!window.Candy)throw Ifm.Diagnostics.Errors.miss("Candy");var i=null,h=null,r={},u={},l=!1,e,f=Ifm.PhoneBar.Media.Xmpp.events,t={mediatypes:0,service:"",server:"",ftservice:"",nickname:"",theme:"assets/xmpp/",language:"it",domain_nrt:"xmpp-nrt",domain_saf:"xmpp-saf",admin_nrt:"lxadmin-nrt",admin_saf:"lxadmin-saf",presence:"login",debug:!1,showtransfer:!0,areValidMediatypes:function(){var n=Ifm.Type.isNumber(this.mediatypes)?this.mediatypes:parseInt(this.mediatypes);return isFinite(n)&&n==Ifm.PhoneBar.Mediatypes.NearRealTime||n==Ifm.PhoneBar.Mediatypes.StoreAndForward||n==Ifm.PhoneBar.Mediatypes.NearRealTime+Ifm.PhoneBar.Mediatypes.StoreAndForward?!0:!1},getAdmin_nrt:function(){return this.admin_nrt+"@"+this.server},getAdmin_saf:function(){return this.admin_saf+"@"+this.server},getDomain_nrt:function(){return this.domain_nrt+"."+this.server},getDomain_saf:function(){return this.domain_saf+"."+this.server},getPresence_nrt:function(){return this.presence+"@"+this.domain_nrt+"."+this.server},getPresence_saf:function(){return this.presence+"@"+this.domain_saf+"."+this.server},getAgentPre:function(){return"Agent_"+this.extension},getUsername:function(){return(this.displayname||"Agent")+"_"+this.extension}};return{isConnected:function(){return Candy.Core.isConnected()},activeCalls:function(){throw new Error("Obsolete. Use Ifm.PhoneBar.instance.calls() instead.");},getCall:function(){throw new Error("Obsolete. Use Ifm.PhoneBar.instance.calls() instead.");},initialize:function(n,r,u){function e(n){return r.hasOwnProperty(n)?r[n]:t[n]}function o(n){if(!r[n])throw Error("Invalid configuration, argument '"+n+"' is missing.");return r[n]}function s(n){l||(y(n),l=!0);f.initialized.raise(i,{})}if(!n)throw Ifm.Diagnostics.Errors.arg("pb");if(i=n,h=u||Ifm.PhoneBar,!r)throw Error("Invalid configuration.");if(t.service=o("service"),t.server=o("server"),t.mediatypes=o("mediatypes"),t.ftservice=e("ftservice"),t.nickname=e("nickname"),t.theme=e("theme"),t.language=e("language"),t.domain_nrt=e("domain_nrt"),t.domain_saf=e("domain_saf"),t.admin_nrt=e("admin_nrt"),t.admin_saf=e("admin_saf"),t.presence=e("presence"),t.debug=e("debug"),t.showtransfer=e("showtransfer"),!t.areValidMediatypes())throw Error("Invalid mediatype(s).");if(t.mediatypes=+t.mediatypes,h.events.assignment.addHandler(a),h.events.callfailure.addHandler(v),Ifm.Photon&&Ifm.Photon.app.isHosted){const n=Ifm.Dom.Photon.Cards.show('<div id="candy"><\/div>',"chat-window",!0,null,0,"Chat",{left:screen.availWidth-470,top:200,width:450,height:450,minimizeOnClose:!0,showInTaskbar:!0});n&&Ifm.Dom.whenWindowNavigates(n,"popup.html",function(){n.jQuery.i18n=jQuery.i18n;s(n.jQuery)})}else s(jQuery)},terminate:function(){if(this.isConnected())throw Ifm.Diagnostics.Errors.op("must be disconnected");h.events.assignment.removeHandler(a);h.events.callfailure.removeHandler(v)},connect:function(){var n=i.agent.extension,e=i.agent.firstName,s=i.agent.lastName,u,o,f,r;if(!n){i.log("PhoneBar.Media.Xmpp","Warn","Can't connect without an extension specified");Candy.Core.keepconnected=!1;Candy.Core.disconnect();return}u=t.extension||null;t.extension=n;o=t.firstname||null;t.firstname=e;f=t.displayname||null;t.displayname=t.nickname||t.firstname;r=Candy.Core.isConnected();(n!==u||t.displayname!==f)&&r&&(Candy.Core.keepconnected=!0,Candy.Core.disconnect());r||(i.log("PhoneBar.Media.Xmpp","Debug","Connecting as",t.displayname),Candy.Core.keepconnected=!0,Candy.Core.connect(t.server,null,t.getUsername()))},disconnect:function(){if(this.isConnected()){for(var n in u)Candy.Core.Action.Jabber.Room.Leave(n);setTimeout(function(){var n=0,t=setInterval(function(){var f=Ifm.Enum.getLength(u),r;if(f>0&&++n<10){i.log("PhoneBar.Media.Xmpp","Debug","Waiting for calls to close:",f,"remaining");return}clearInterval(t);for(r in u)s(r),Candy.View.Pane.Room.getPane(r)&&Candy.View.Pane.Room.close(r);Candy.Core.keepconnected=!1;Candy.Core.disconnect()},100)},100)}},handled:function(n){return this.sendSysMessage(n,"HANDLED")?(r[n].handled=!0,o(),!0):!1},send:function(n,t){if(!this.isConnected())return i.log("PhoneBar.Media.Xmpp","Warn","Cannot send messages while disconnected from XMPP server"),!1;if(r[n]===undefined||r[n].terminated)return i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n),!1;var u=r[n].roomJid;return u===undefined?(i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n),!1):(Candies.send(u,t),!0)},sendCallInfo:function(n,t){var i=new Ifm.Messaging.FStringMessageWriter("CALLINFO");for(var r in t)i.add(r+":"+t[r]);return this.send(n,i.end().toString())},sendSysMessage:function(n,t){for(var r=new Ifm.Messaging.FStringMessageWriter(t),i=2;i<arguments.length;i++)r.add(arguments[i]);return this.send(n,r.end().toString())},showTransferDialog:function(n){try{Ifm.PhoneBar.UI.Commands.showTransferForm(n)}catch(t){}f.showtransferform.raise(i,{callId:n})},close:function(n){if(this.isConnected()){if(r[n]===undefined||r[n].terminated){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}var t=r[n].roomJid;if(t===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}Candy.Core.Action.Jabber.Room.Leave(t)}},ready:function(n){if(i.calls(n)&&i.calls(n).postcall&&i.ready(n),Candy.Core.isConnected()){if(r[n]===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}if(!r[n].terminated){i.log("PhoneBar.Media.Xmpp","Warn","Call not yet terminated",n);return}var t=r[n].roomJid;if(t===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}Candy.View.Pane.Room.getPane(t)&&(s(t),Candy.View.Pane.Room.close(t))}},append:function(t,i){console.warn("Obsolete. Use xmpp.conversation.append() instead");n.conversation.append(t,i)},conversation:{append:function(n,t){var u;if(r[n]===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}if(u=r[n].roomJid,u===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}Candy.View.Pane.Chat.onInfoMessage(u,"{{message}}");var e=Candy.View.Pane.Room.getPane(u),f=e.find(".message-pane").children().last(),o=f.html();f.html(o.replace("{{message}}",t))},html:function(n){var t,u;if(r[n]===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}if(t=r[n].roomJid,t===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}return u=Candy.View.Pane.Room.getPane(t),u.find(".message-pane").html()},prepend:function(n,t){var u,f;if(r[n]===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}if(u=r[n].roomJid,u===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}t&&(f=Candy.View.Pane.Room.getPane(u),f.find(".message-pane").prepend(t))},select:function(n){if(r[n]===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}var t=r[n].roomJid;if(t===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}Candy.View.Pane.Room.show(t)}},queryFileTransfer:function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");if(!Ifm.Net.Services.FileTransfer.isSupported()||!t.ftservice){n(!1);return}var i=Ifm.Net.Services.FileTransfer.create(t.ftservice);i.enabled(n)},requestFileTransfer:function(n,t){var f,u;if(r[n]===undefined||r[n].terminated){i.log("PhoneBar.Media.Xmpp","Warn","Invalid callId",n);return}if(r[n].mediatype!==Ifm.PhoneBar.Mediatypes.NearRealTime){Ifm.Diagnostics.Debug.print("Unsupported mediatype of call",n);return}if(f=r[n].roomJid,f===undefined){i.log("PhoneBar.Media.Xmpp","Warn","Session not yet created for call",n);return}if(!t||!t.name||t.size===undefined||!t.type){u=document.createElement("input");u.type="file";u.style.cssText="display:none!important;";document.body.appendChild(u);u.click();document.body.removeChild(u);u.onchange=function(){u.files&&u.files.length>0&&c(f,u.files[0])};return}}}}();n=t.Xmpp.instance}();namespace("Ifm.Chat.Strings"),function(n){n.en={ChatStateComposing:"is writing...",ChatStateTalking:"Chatting",ChatStateClosed:"Chat terminated",BotNickname:"Synthetic",FileTransfer:{NotAvailable:"File transfer not available",NotAvailOther:"File transfer not available with this user",TransferTitle:"File",Complete:"transferred",Accept:"Accept",Cancel:"Cancel",Open:"Open",Waiting:"waiting",Canceled:"canceled",Error:"error",Receiving:"receiving",Sending:"sending",Received:"received",Sent:"sent"}};n.it={ChatStateComposing:"sta scrivendo...",ChatStateTalking:"In conversazione",ChatStateClosed:"Conversazione chiusa",BotNickname:"Synthetic",FileTransfer:{NotAvailable:"Trasferimento file non disponibile",NotAvailOther:"Trasferimento file non disponibile con questo utente",TransferTitle:"File",Complete:"trasferito",Accept:"Accetta",Cancel:"Annulla",Open:"Apri",Waiting:"in attesa",Canceled:"annullato",Error:"errore",Receiving:"ricezione",Sending:"invio",Received:"ricevuto",Sent:"inviato"}}}(Ifm.Chat.Strings);