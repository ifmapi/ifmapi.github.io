
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";function defineEvents(){for(var name,eventbox={},i=0;i<arguments.length;i++){if(name=arguments[i],!Ifm.Type.isString(name))throw Ifm.Diagnostics.Errors.arg("name");createEventAccessors(eventbox,name)}return eventbox}function createEventAccessors(owner,name){var evt=new Ifm.Event;Object.defineProperty(owner,name,{get:function(){return evt},set:function(handler){evt.addHandler(handler)}})}function inherits(ctorClass,ctorBase){if(!Ifm.Type.isFunction(ctorClass))throw Ifm.Diagnostics.Errors.func("ctorClass");if(!Ifm.Type.isFunction(ctorBase))throw Ifm.Diagnostics.Errors.func("ctorBase");return ctorClass.prototype=Object.create(ctorBase.prototype),ctorClass.prototype.constructor=ctorClass,ctorBase.prototype}function namespace(globalNamespace,factory){for(var part,e,ns=window,parts=globalNamespace.split("."),i=0;i<parts.length;i++)part=parts[i],ns[part]=ns[part]||{},ns=ns[part];if(typeof factory==typeof namespace)factory.call(ns);else for(e in factory)ns[e]=factory[e];return ns}function query(url){var query=url||window.location.search,pairs={};return query.replace(/[?&#]([^=]+)=([^&]*)?/g,function(match,key,val){return key&&(pairs[key]=val||""),""}),pairs}var global=global||window,T0,dT;if(Object.defineProperty?Object.defineProperty(global,"T0",{value:+new Date}):T0=+new Date,dT=function(){return new Date-T0},Function.getName=function(func){if(!Ifm.Type.isFunction(func))throw Ifm.Diagnostics.Errors.func("func");var res=/function\s+(\w+)/.exec(func);return res&&res.length===2?res[1]:(res=/(\w+)\s*=\s*function/.exec(func),res&&res.length===2)?res[1]:"anonymous function"},Function.prototype.toShortString=function(){var body=this.toString().replace(/[\r|\n]/g,"").replace(/[\s]+/g," ");return body.substr(0,body.indexOf("{")).trim()},Array.pushArray=function(array1,array2){if(!Ifm.Type.isArray(array1))throw Ifm.Diagnostics.Errors.arg("array1");if(!Ifm.Type.isArray(array2))throw Ifm.Diagnostics.Errors.arg("array2");return Array.prototype.push.apply(array1,array2)},!Array.prototype.find)try{Object.defineProperty(Array.prototype,"find",{enumerable:!1,value:function(func,thisArg){if(!Ifm.Type.isFunction(func))throw Ifm.Diagnostics.Errors.func("func");for(var i=0,len=this.length;i<len;i++)if(i in this&&func.call(thisArg,this[i],i,this))return this[i];return undefined}})}catch(e){}window.ArrayBuffer&&(ArrayBuffer.fromBytes=function(bytes){for(var len=bytes.length,buffer=new ArrayBuffer(len),bufView=new Uint8Array(buffer),i=0;i<len;i++)bufView[i]=bytes[i];return buffer},ArrayBuffer.prototype.getBytes=function(){for(var bufView=new Uint8Array(this),bytes=[],i=0,l=bufView.length;i<l;i++)bytes.push(bufView[i]);return bytes});Object.entries||(Object.entries=function(obj){var e=[];for(var i in obj)obj.hasOwnProperty(i)&&e.push([i,obj[i]]);return e});Object.keys||(Object.keys=function(obj){var k=[];for(var i in obj)obj.hasOwnProperty(i)&&k.push(i);return k});Object.values||(Object.values=function(obj){var v=[];for(var i in obj)obj.hasOwnProperty(i)&&v.push(obj[i]);return v});String.format=function(str){if(!str||!Ifm.Type.isString(str))return str;var args=Array.prototype.slice.call(arguments,1);return str.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!="undefined"?args[number]:""})};String.prototype.format=function(){var args=[this];return Array.prototype.push.apply(args,arguments),String.format.apply(null,args)};String.prototype.startsWith||(String.prototype.startsWith=function(str,position){return position=position||0,this.substr(position,str.length)===str});String.prototype.endsWith||(String.prototype.endsWith=function(str,position){position=position||this.length;var start=Math.max(position-str.length,0);return this.slice(start,position)===str});String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")});String.prototype.indexAfter=function(str){var p=this.indexOf(str);return p+(p<0?0:str.length)};String.prototype.lastIndexAfter=function(str){var p=this.lastIndexOf(str);return p+(p<0?0:str.length)};Date.now||(Date.now=function(){return+new Date});Date.prototype.toISOString||function(){function pad(number){var r=String(number);return r.length===1&&(r="0"+r),r}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}();Date.prototype.toISOLocaleDateString||(Date.prototype.toISOLocaleDateString=function(){var yyyy=""+this.getFullYear(),mm=""+(this.getMonth()+1),dd=""+this.getDate();return mm.length<2&&(mm="0"+mm),dd.length<2&&(dd="0"+dd),yyyy+"-"+mm+"-"+dd});namespace("Ifm",function(){Ifm.version="Ifm.js/1.0.92-4649";this.Objects={deepMerge:function recursive(o1,o2,skipNullOrUndefined){for(var i in o2)typeof o2[i]=="object"?(o2[i]===null?skipNullOrUndefined!==!0&&(o1[i]=null):(typeof o1[i]!="object"||o1[i]===null)&&(o1[i]={}),recursive(o1[i],o2[i],skipNullOrUndefined)):(o2[i]!==undefined||skipNullOrUndefined!==!0)&&(o1[i]=o2[i]);return o1}};this.Enum={};this.Enum.getName=function(enumObject,value){for(var name,names=Object.getOwnPropertyNames(enumObject),i=0,l=names.length;i<l;i++)if(name=names[i],enumObject[name]===value)return name;return""};this.Enum.getLength=function(enumObject){return Object.getOwnPropertyNames(enumObject).length};this.Type={};this.Type.getTypeName=function(o){var ecmaname=Object.prototype.toString.call(o).slice(8,-1),ctorname;return ecmaname==="Object"&&(ctorname=o&&o.constructor&&o.constructor.toString().match(/function\s+([^\s]{1,})\s*\(/),ctorname)?ctorname[1]:ecmaname};this.Type.isArray=function(o){return Object.prototype.toString.call(o)==="[object Array]"};this.Type.isLikeArray=function(o){return typeof o=="object"&&!Ifm.Type.isString(o)&&typeof o.length=="number"&&!o.propertyIsEnumerable("length")};this.Type.isFunction=function(o){return typeof o=="function"};this.Type.isNumber=function(o){return typeof o=="number"};this.Type.isString=function(o){return typeof o=="string"||o instanceof String};this.Event=function(){if(!(this instanceof Ifm.Event))throw Ifm.Diagnostics.Errors.ctor();var handlers=[];return{constructor:Ifm.Event,addHandler:function(func,owner=null,once=false){Ifm.Type.isFunction(func)&&handlers.push({func,owner,once})},hasHandlers:function(){return handlers.length>0},removeAllHandlers:function(){handlers.length=0},removeHandler:function(func){for(var len=handlers.length;len--;)handlers[len].func===func&&handlers.splice(len,1)},raise:function(){for(var len=handlers.length,h;len--;)h=handlers[len],h.func.apply(h.owner,arguments),h.once&&handlers.splice(len,1)}}}});namespace("Ifm.Diagnostics",function(){this.Debug={};this.Debug.onprint=new Ifm.Event;this.Debug.enabled=!1;this.Debug.popupAssertions=!1;this.Debug.assert=function(condition,message){if(Ifm.Diagnostics.Debug.enabled){if(Ifm.Type.isString(condition)){try{var tester=new Function("return "+condition);Ifm.Diagnostics.Debug.assert(tester(),condition+" "+message)}catch(e){Ifm.Diagnostics.Debug.fail("Invalid assert condition '"+condition+"' : "+e.message)}return}condition||Ifm.Diagnostics.Debug.fail(message)}};this.Debug.fail=function __fail(message){if(Ifm.Diagnostics.Debug.enabled){var st=arguments[1],fn=arguments[2]||__fail;if(!st)try{throw new Error("Assertion failed");}catch(e){st=e.stack||"[Callstack not available]"}window.console&&console.error&&console.error(message,st);Ifm.Diagnostics.Debug.popupAssertions&&alert(message+"\n\n----Stack----\n\n"+st)}};this.Debug.clear=function(){if(Ifm.Diagnostics.Debug.enabled){window.console&&console.clear&&console.clear();var conview=document.getElementById("consoleview");conview&&(conview.innerHTML="")}};this.Debug.print=function(str){var line,conview;Ifm.Diagnostics.Debug.enabled&&(line=arguments.length>1?Array.prototype.slice.call(arguments).join(" "):str&&str.toString()||null,line!==null)&&(window.console&&console.log&&console.log(line),Ifm.Diagnostics.Debug.onprint.raise(line),conview=document.getElementById("consoleview"),conview&&(conview.innerHTML+=line+"<br>",conview.scrollTop=conview.scrollHeight))};this.Debug.printf=function(){Ifm.Diagnostics.Debug.enabled&&Ifm.Diagnostics.Debug.print(String.format.apply(null,arguments))};this.Errors=function(){function _error(error,name){return new Error(error+(name?": '"+name+"'":""))}var instance={};return instance.arg=function(name){return _error("Invalid function argument",name)},instance.argsno=function(num){return _error("Invalid number of function arguments",num)},instance.browser=function(){return _error("Browser not supported")},instance.ctor=function(name){return _error("Invalid constructor call",name)},instance.func=function(name){return _error("Function argument expected",name)},instance.miss=function(name){return _error("Missing type or module",name)},instance.notimpl=function(name){return _error("Feature not implemented",name)},instance.notsup=function(name){return _error("Feature not supported",name)},instance.op=function(state){return _error("Invalid operation",state)},instance}()});namespace("Ifm");Ifm.Cookies={get:function(name){try{return document.cookie.replace(new RegExp("(?:(?:^|.*;\\s*)"+name+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1")}catch(err){return""}},"delete":function(name){try{document.cookie=name+"=;expires=Thu, 01-Jan-70 00:00:01 GMT;path=/"}catch(err){}},set:function(name,value){try{document.cookie=name+"="+value+";expires=Fri, 31 Dec 9999 23:59:59 GMT;path=/"}catch(err){}}};namespace("Ifm.Messaging"),function(){this.FMessage={HeaderLength:18,LengthPosition:16,ExtLenPosition:12,DataPosition:20,MessageHeaderId:1431655765};this.FMessageReader=function(messageBuffer){if(!messageBuffer)throw new Error("FMessageReader() -> Invalid message buffer");if(this._bytes=[],this._readingpos=0,messageBuffer instanceof ArrayBuffer)this._bytes=messageBuffer.getBytes();else if(messageBuffer instanceof Array)this._bytes=messageBuffer;else throw new Error("FMessageReader() -> Unsupported message data format: "+typeof messageBuffer);if(this._bytes.length<Ifm.Messaging.FMessage.DataPosition)throw new Error("FMessageReader() -> Invalid message length: "+this._bytes.length);var headerId=this.nextInt32();if(headerId!==Ifm.Messaging.FMessage.MessageHeaderId)throw new Error("FMessageReader() -> Invalid FMessage signature: "+headerId.toString(16));if(this._readingpos=Ifm.Messaging.FMessage.LengthPosition,this.length=this.nextInt16(),this.length===0&&(this._readingpos=Ifm.Messaging.FMessage.ExtLenPosition,this.length=this.nextInt32(),this.length===0))throw new Error("FMessageReader() -> Invalid FMessage length");this._readingpos=Ifm.Messaging.FMessage.HeaderLength;this.code=this.nextInt16()};this.FMessageReader.prototype.remainingBytes=function(){return this.length+Ifm.Messaging.FMessage.HeaderLength-this._readingpos};this.FMessageReader.prototype.nextByte=function(){if(this._readingpos<this._bytes.length)return this._bytes[this._readingpos++];throw new Error("FMessageReader.nextByte() -> No more bytes to read: "+this._readingpos);};this.FMessageReader.prototype.nextBool=function(){return this.nextByte()===0?!1:!0};this.FMessageReader.prototype.nextBool32=function(){return this.nextInt32()===0?!1:!0};this.FMessageReader.prototype.nextInt16=function(){return(this.nextByte()<<8)+this.nextByte()};this.FMessageReader.prototype.nextInt32=function(){return(this.nextInt16()<<16)+this.nextInt16()};this.FMessageReader.prototype.nextInt64=function(){return(this.nextInt32()<<32)+this.nextInt32()};this.FMessageReader.prototype.nextString=function(){for(var strlen=this.nextInt16(),bytes=[],i=0;i<strlen;i++)bytes.push(this.nextByte());return String.fromCharCode.apply(null,bytes)};this.FMessageReader.prototype.nextUniString=function(){for(var strlen=this.nextInt16(),bytes=[],i=0;i<strlen;i++)bytes.push(this.nextByte()),bytes.push(this.nextByte()<<8);return String.fromCharCode.apply(null,bytes)};this.FMessageWriter=function(code){this._bytes=[];this._len=0;this.addInt32(Ifm.Messaging.FMessage.MessageHeaderId);this.addInt32(0);this.addInt32(0);this.addInt32(0);this.addInt16(0);this._len=0;this.addInt16(code);this.code=code};this.FMessageWriter.prototype.addByte=function(byte){return this._bytes.push(byte),this._len++,this};this.FMessageWriter.prototype.addBool=function(bool){return this.addByte(bool?1:0),this};this.FMessageWriter.prototype.addBool32=function(bool){return this.addInt32(bool?1:0),this};this.FMessageWriter.prototype.addInt16=function(short){return this.addByte((65280&short)>>8),this.addByte(255&short),this};this.FMessageWriter.prototype.addInt32=function(int){return this.addInt16((4294901760&int)>>16),this.addInt16(65535&int),this};this.FMessageWriter.prototype.addInt64=function(long){return this.addInt32((-4294967296&long)>>32),this.addInt32(4294967295&long),this};this.FMessageWriter.prototype.addString=function(str){var strlen=str&&str.length||0,i;for(this.addInt16(strlen),i=0;i<strlen;i++)this.addByte(str.charCodeAt(i));return this};this.FMessageWriter.prototype.addUniString=function(str){var strlen=str&&str.length||0,i;for(this.addInt16(strlen),i=0;i<strlen;i++)this.addByte(255&str.charCodeAt(i)),this.addByte((65280&str.charCodeAt(i))>>8);return this};this.FMessageWriter.prototype.end=function(){this._bytes[Ifm.Messaging.FMessage.LengthPosition]=(65280&this._len)>>8;this._bytes[Ifm.Messaging.FMessage.LengthPosition+1]=255&this._len};this.FMessageWriter.prototype.toArrayBuffer=function(){return ArrayBuffer.fromBytes(this._bytes)}}.call(Ifm.Messaging);namespace("Ifm.Messaging"),function(ns){ns.FStringMessage={MessageHeaderV1:"*begin*",MessageTypeDelV1:"%%%",MessageFieldDelV1:"###",MessageFooterV1:"§end§",MessageHeaderV2:"|begin|",MessageTypeDelV2:"|%|",MessageFieldDelV2:"|#|",MessageFooterV2:"|end|",MinValidLength:16,ProtocolVersion:"V1"};ns.FStringMessageReader=function(messageBuffer){var matches;if(!(this instanceof Ifm.Messaging.FStringMessageReader))throw Ifm.Diagnostics.Errors.ctor("Ifm.Messaging.FStringMessageReader");if(!messageBuffer)throw Ifm.Diagnostics.Errors.arg("messageBuffer");if(this._message="",this._readingpos=0,Ifm.Type.isString(messageBuffer))this._message=messageBuffer;else throw new Error("FStringMessageReader() -> Unsupported message data format: "+typeof messageBuffer);if(this._message.length<ns.FStringMessage.MinValidLength)throw new Error("FStringMessageReader() -> Invalid message length: "+this._message.length);if(this._message.startsWith(ns.FStringMessage.MessageHeaderV1)){if(matches=this._message.match(/^\*begin\*([A-z0-9]*)%{3}/),matches&&matches.length==2)this.type=matches[1];else throw new Error("FStringMessageReader() -> Invalid FStringMessage type format");if(matches=this._message.match(/%{3}(.*)[\xA7|$]end[\xA7|$]/),matches&&matches.length==2)this.data=matches[1].split(ns.FStringMessage.MessageFieldDelV1);else throw new Error("FStringMessageReader() -> Invalid FStringMessage data format");}else if(this._message.startsWith(ns.FStringMessage.MessageHeaderV2)){if(matches=this._message.match(/^\x7Cbegin\x7C([A-z0-9]*)\x7C%\x7C/),matches&&matches.length==2)this.type=matches[1];else throw new Error("FStringMessageReader() -> Invalid FStringMessage type format");if(matches=this._message.match(/\x7C%\x7C(.*)[\x7C]end[\x7C]/),matches&&matches.length==2)this.data=matches[1].split(ns.FStringMessage.MessageFieldDelV2);else throw new Error("FStringMessageReader() -> Invalid FStringMessage data format");}else throw new Error("FStringMessageReader() -> Invalid FStringMessage signature");};ns.FStringMessageWriter=function(type,protocolVersion){if(!(this instanceof Ifm.Messaging.FStringMessageWriter))throw Ifm.Diagnostics.Errors.ctor("Ifm.Messaging.FStringMessageWriter");if(!Ifm.Type.isString(type))throw Ifm.Diagnostics.Errors.arg("type");this._dataAdded=!1;this.type=type;protocolVersion==="V2"?(ns.FStringMessage.protocolVersion=protocolVersion,this._message=ns.FStringMessage.MessageHeaderV2+type+ns.FStringMessage.MessageTypeDelV2):(ns.FStringMessage.protocolVersion="V1",this._message=ns.FStringMessage.MessageHeaderV1+type+ns.FStringMessage.MessageTypeDelV1)};ns.FStringMessageWriter.prototype.add=function(str){if(str===undefined||str===null)throw Ifm.Diagnostics.Errors.arg("str");return ns.FStringMessage.protocolVersion==="V1"?(this._dataAdded&&(this._message+=ns.FStringMessage.MessageFieldDelV1),this._message+=str,this._dataAdded=!0):(this._dataAdded&&(this._message+=ns.FStringMessage.MessageFieldDelV2),this._message+=str,this._dataAdded=!0),this};ns.FStringMessageWriter.prototype.end=function(){return this._message+=ns.FStringMessage.protocolVersion==="V1"?ns.FStringMessage.MessageFooterV1:ns.FStringMessage.MessageFooterV2,this};ns.FStringMessageWriter.prototype.toString=function(){return this._message}}(Ifm.Messaging);namespace("Ifm.Messaging"),function(){this.FMessageBuilder=function(){if(!window.ArrayBuffer)throw new Error("FMessageBuilder() -> ArrayBuffer not supported");this.message=new Ifm.Event;this._buffer=[];this.toString=function(){return"[object FMessageBuilder]"}};this.FMessageBuilder.isSupported=function(){return window.ArrayBuffer?!0:!1};this.FMessageBuilder.prototype.append=function(buffer){if(buffer)if(buffer instanceof ArrayBuffer)Array.pushArray(this._buffer,buffer.getBytes());else if(buffer instanceof Array)Array.pushArray(this._buffer,buffer);else throw new Error("FMessageBuilder.append() -> Unsupported message data format: "+typeof buffer);else throw new Error("FMessageBuilder.append() -> Invalid message buffer");while(this._buffer.length>Ifm.Messaging.FMessage.HeaderLength){var message=new Ifm.Messaging.FMessageReader(this._buffer);if(Ifm.Messaging.FMessage.HeaderLength+message.length<=this._buffer.length){try{this.message.raise(this,{message:message})}catch(e){console.error(e);Ifm.Diagnostics.Debug.print(this,"Error dispatching or processing message:",e.message);Ifm.Diagnostics.Debug.print(e.stack)}this._buffer.splice(0,Ifm.Messaging.FMessage.HeaderLength+message.length)}}}}.call(Ifm.Messaging);namespace("Ifm.Messaging").FPropertyList=function(pliststr){if(!(this instanceof Ifm.Messaging.FPropertyList))throw Ifm.Diagnostics.Errors.ctor();if(!pliststr||!Ifm.Type.isString(pliststr))throw Ifm.Diagnostics.Errors.arg("pliststr");pliststr=pliststr.trim();for(var list={},sort=[],match,re=/{\s*([^\s{]*)\s*=\s*([^}]*)}/g;match=re.exec(pliststr);)list[match[1]]=match[2],sort.push(match[1]);this.events=defineEvents("changed");this.originalString=pliststr;this.get=function(key){if(!key||!Ifm.Type.isString(key))throw Ifm.Diagnostics.Errors.arg("key");return list[key]};this.keys=function(){var properties=[];for(var p in list)properties.push(p);return properties};this.remove=function(key){if(!key||!Ifm.Type.isString(key))throw Ifm.Diagnostics.Errors.arg("key");if(list.hasOwnProperty(key)){delete list[key];for(var len=sort.length;len--;)sort[len]===key&&(sort.splice(len,1),this.events.changed.raise(this,{key:key,value:undefined}))}};this.set=function(key,value){if(!key||!Ifm.Type.isString(key))throw Ifm.Diagnostics.Errors.arg("key");value!==undefined&&(list.hasOwnProperty(key)||sort.push(key),list[key]!==value&&(list[key]=value,this.events.changed.raise(this,{key:key,value:value})))};this.toString=function(){for(var pliststr="{",i=0;i<sort.length;i++)pliststr+="{"+sort[i]+" = "+list[sort[i]]+"}";return pliststr+"}"}},function(){function getCloseReason(code){switch(code){case"403":return": no destination for protocol";case"500":return": client-gateway protocol error";case"502":return": gateway-server protocol error";case"503":return": no destination reachable";default:return""}}var ns=namespace("Ifm.Messaging"),This=ns.FPort=function FPort(){if(!(this instanceof FPort))throw Ifm.Diagnostics.Errors.ctor();this.opened=new Ifm.Event;this.closed=new Ifm.Event;this.message=new Ifm.Event},proto;This.isSupported=function(){return global.WebSocket&&global.ArrayBuffer?!0:!1};proto=This.prototype;proto.isClosed=function(){return this._websocket&&this._websocket.readyState===WebSocket.CLOSED||!0};proto.isOpen=function(){return this._websocket&&this._websocket.readyState===WebSocket.OPEN||!1};proto.open=function(address,opt_protocol){if(!This.isSupported())throw Ifm.Diagnostics.Errors.notsup("FPort");if(!address)throw Ifm.Diagnostics.Errors.arg("address");if(this.isOpen())throw Ifm.Diagnostics.Errors.op("port open");var port=this,msgBuilder=new Ifm.Messaging.FMessageBuilder;msgBuilder.message.addHandler(function(sender,e){this.message.raise(port,{reader:e.message})},this);this._closedhere=!1;this._wasconnected=!1;this._gateway=!1;this._localPort=null;Ifm.Diagnostics.Debug.print("[FPort] connecting to "+address);try{this._websocket=opt_protocol?new WebSocket(address,opt_protocol):new WebSocket(address);this._websocket.binaryType="arraybuffer";this._remoteAddress=address}catch(err){Ifm.Diagnostics.Debug.print("[FPort] connection failed: "+err.message);port.closed.raise(port,{clean:!1,failed:!0,lost:!1,reason:err.message});return}this._websocket.onmessage=function(e){var parts,code,reason,reader;if(Ifm.Type.isString(e.data)){parts=e.data.split("|");switch(parts[0]){case"#ready":Ifm.Diagnostics.Debug.print("[FPort] ready");port._websocket.send("#qlp");port._wasconnected=!0;port.opened.raise(port,{address:address,gateway:port._gateway});return;case"#qlp":port._localPort=Number(parts[1]);return;case"#close":code=parts.length>1?parts[1]:"0";reason=code+getCloseReason(code);Ifm.Diagnostics.Debug.printf("[FPort] closed ({0})",reason);return;default:if(parts[0].startsWith("#"))return}try{reader=new Ifm.Messaging.FStringMessageReader(e.data)}catch(err){Ifm.Diagnostics.Debug.printf("[FPort] invalid message {0}",e.data);Ifm.Diagnostics.Debug.print(err);return}port.message.raise(port,{reader:reader})}else e.data instanceof ArrayBuffer?msgBuilder.append(e.data):Ifm.Diagnostics.Debug.printf("[FPort] unknown message {0}",e.data)};this._websocket.onclose=function(e){Ifm.Diagnostics.Debug.print("[FPort] closed"+(port._wasconnected?port._closedhere?"":" (connection lost)":" (connection failed)"));port.closed.raise(port,{clean:port._closedhere,failed:!port._wasconnected,lost:port._wasconnected&&!port._closedhere,reason:port._closedhere?"":"Connection to "+address+" "+(port._wasconnected?e.reason?e.reason:"lost":"failed")});delete port._localPort;delete port._remoteAddress;delete port._websocket}};proto.close=function(){this.isClosed()&&(this._closedhere=!0,this._websocket.close())};proto.send=function(message){if(message&&this.isOpen())if(message instanceof Ifm.Messaging.FMessageWriter)this._websocket.send(message.toArrayBuffer());else if(message instanceof Ifm.Messaging.FStringMessageWriter)this._websocket.send(message.toString());else throw Error("Unsupported message format: "+message+" ("+Ifm.Type.getTypeName(message)+")");}}(),function(){var ns=namespace("Ifm.Messaging");ns.FConnection=function(){if(!(this instanceof Ifm.Messaging.FConnection))throw Ifm.Diagnostics.Errors.ctor();var port=null,disconnectionCause=null;return{constructor:ns.FConnection,events:defineEvents("connecting","connected","disconnecting","disconnected","binarymessage","stringmessage"),isSupported:function(){return!!(port&&port.isSupported())},isClosed:function(){return!!(port&&port.isClosed())},isConnected:function(){return!!(port&&port.isOpen())},getAddress:function(){return port&&port._remoteAddress||""},getLocalPort:function(){return port&&port._localPort||null},connect:function(address,protocol,onconnected){if(this.isConnected())return!0;if(!address||Ifm.Type.isArray(address)&&address.length===0)throw Ifm.Diagnostics.Errors.arg("address");port=new Ifm.Messaging.FPort;port.opened.addHandler(function(){this.events.connected.raise(this);Ifm.Type.isFunction(onconnected)&&onconnected()},this);port.closed.addHandler(function(sender,e){if(e.failed&&Ifm.Type.isArray(address)&&address.length>1){this.connect(address.slice().splice(1),protocol,onconnected);return}this.events.disconnected.raise(this,disconnectionCause||e);disconnectionCause=null},this);port.message.addHandler(function(sender,e){if(e.reader instanceof Ifm.Messaging.FStringMessageReader)this.events.stringmessage.raise(this,e);else if(e.reader instanceof Ifm.Messaging.FMessageReader)this.events.binarymessage.raise(this,e);else{Ifm.Diagnostics.Debug.fail("Invalid messageReader");return}},this);this.events.connecting.raise(this,{address:address});Ifm.Type.isArray(address)?port.open(address[0],protocol):port.open(address,protocol)},disconnect:function(opt_cause){if(!this.isConnected())return!0;disconnectionCause=opt_cause||null;this.events.disconnecting.raise(this);port.close()},send:function(message){if(!message)throw Ifm.Diagnostics.Errors.arg("message");if(!this.isConnected()){console.warn("[Ifm.Messaging.FConnection] Can't send, not connected");return}port.send(message)}}}}(),function(){var ns=namespace("Ifm.PhoneBar");ns.AgentListCampaigns={AnyCampaign:0,SpecificCampaign:256,OmitSynthetics:512,OmitHumans:1024};ns.AgentListStates={NotAvailable:1,Available:2,Assigned:4,Booked:8,Talking:16,Paused:32,Postcall:64,Othercall:128,AnyAvailable:254};ns.CampaignInfoFlags={Inactive:1,Active:2,Suspended:4,AnyStatusMask:7,Inbound:8,Outbound:16,AnyBoundness:24,NotAssigned:32,Assigned:64,AnyAssignment:96,PostCallWork:128,HideTransferNotAllowed:256,ExcludeSyntheticCampaigns:512,ExcludeHumanCampaigns:1024};ns.LoginReplyFailureCauses={Unspecified:0,AccountLockout:1,ExpiredPassword:2,WrongUsernameOrPassword:3,InvalidNewPassword:4,PasswordChangeNotAllowed:5,WrongState:6,InvalidExtension:7,ExtensionAlreadyInUse:8,TokenBasedLoginNotAvailable:9,InvalidToken:10,ProvisioningError:11,ExtensionTranslationError:128};ns.Mediatypes={Voice:1,NearRealTime:8,StoreAndForward:16};ns.States={Initialization:"[Initialization]",NotLoggedIn:"[Not Logged In]",Connecting:"[Connecting]",LoggedIn:"[Logged In]",Paused:"[Paused]",Ready:"[Ready]",Alerting:"[Alerting]",Talking:"[Talking]",PostCall:"[Post Call]",OtherCall:"[Other Call]",Assigned:"[Assigned]",WaitingOutbound:"[Waiting Outbound]",WaitingTransfer:"[Waiting Transfer]"};ns.TransferCallModes={Blind:0,Default:1,Consultative:2}}();namespace("Ifm.PhoneBar"),function(PhoneBar){PhoneBar.about={product:"#phones",title:"#phonebar",version:"1.0.78-6"};PhoneBar.events=defineEvents("initialized","languagechanged","displayStateChanged","booked","assignment","alerting","answered","callfailure","newcall","abortcall","othercall","pausebooked","pause","ready","readyfordetach","readyfortransfer","terminated","recordingstarted","recordingmutechanged","recordingstopped","maskeddigitreceived","maskedpayloadreceived","statechanged","statetimechanged","supervisormessage");PhoneBar.version=PhoneBar.about.title+"/"+PhoneBar.about.version;PhoneBar.canRun=function(){return!!(global&&global.WebSocket&&global.ArrayBuffer&&global.jQuery)};PhoneBar.run=function(settings,options){this.run=function(){self.log("PhoneBar","Debug","Already running")};this.instance.initialize(settings,options)};PhoneBar.instance=function(PhoneBar){function resetSessionData(){activeCalls={};callbacks={login:[],logout:[],pause:[],ready:[],make:[],transfer:[],abort:[],getAgentList:[],getCampaignList:[],getPauseReasons:[],getQueueInfo:[]};newCallRequest=null}function evalNextState(){currentState!==states.Paused&&(Object.values(activeCalls).some(function(c){return!c.terminated&&!c.transferred})?(changeState(states.Talking),changeCallEventDisplayState(strings.TalkingState)):Object.values(activeCalls).some(function(c){return c.postcall})?(changeState(states.PostCall),changeCallEventDisplayState(strings.PostCallState)):newCallRequest?(changeState(states.WaitingOutbound),changeDisplayState(strings.WaitingOutboundState)):goReady())}function changeState(newState){var oldState=currentState,resettime,starttimer;if(newState!==oldState||newState===states.Paused){self.log("PhoneBar","Debug","Changing state, from",oldState,"to",newState);currentState=newState;resettime=!1;starttimer=!1;switch(oldState){case states.Alerting:jQuery(el.PickupButton).removeClass("highlight blink");break;case states.Paused:newState!==states.Paused&&(currentStateReasonId=0,currentStateReason="");break;case states.WaitingOutbound:jQuery(el.AbortCallButton).disable().hide();(newState===states.Ready||newState===states.Paused)&&(newCallRequest=null)}switch(newState){case states.NotLoggedIn:jQuery([el.PauseButton,el.ReadyButton,el.LogoutButton,el.NumberLabel,el.NumberInput,el.CallButton,el.TransferButton,el.CampaignListButton,el.QueueInfoButton,el.PanicButton,el.StartRecordingButton,el.StopRecordingButton,el.MuteRecordingButton,el.UnmuteRecordingButton].join(", ")).disable();jQuery(el.LoginButton).enable();jQuery(el.LoginOrReadyButton).enable();jQuery(el.NumberInput).val("").change();Ifm.Dom&&Ifm.Dom.Photon&&(Ifm.Dom.Photon.Cards.close("campaignlist-card"),Ifm.Dom.Photon.Cards.close("queueinfo-card"));resettime=!0;break;case states.Connecting:jQuery([el.LoginButton,el.LoginOrReadyButton].join(", ")).disable();break;case states.LoggedIn:case states.Ready:jQuery([el.PauseButton,el.LogoutButton,el.NumberLabel,el.NumberInput,el.CampaignListButton,el.QueueInfoButton,el.PanicButton].join(", ")).enable();jQuery([el.LoginButton,el.LoginOrReadyButton,el.ReadyButton,el.TransferButton].join(", ")).disable();resettime=!0;break;case states.Paused:jQuery(el.PauseButton).disable();self.getPauseReasons(function(e){e.reasons.length>0&&jQuery(el.PauseButton).enable()});jQuery([el.ReadyButton,el.LoginOrReadyButton].join(", ")).enable();resettime=!0;starttimer=!self.options.hideClockInPause();break;case states.Talking:Object.values(activeCalls).some(function(call){return call.mediatype===PhoneBar.Mediatypes.Voice})&&jQuery(el.TransferButton).enable();resettime=!0;starttimer=!0;break;case states.PostCall:Object.values(activeCalls).some(function(call){return call.mediatype===PhoneBar.Mediatypes.Voice})&&jQuery([el.ReadyButton,el.LoginOrReadyButton].join(", ")).enable();resettime=!0;starttimer=!0;break;case states.OtherCall:stateTimeTimer||(resettime=!0,starttimer=!0);break;case states.Assigned:resettime=!0;starttimer=!0;break;case states.Alerting:jQuery(el.PickupButton).addClass("highlight blink");break;case states.WaitingOutbound:jQuery([el.ReadyButton,el.LoginOrReadyButton].join(", ")).disable();jQuery(el.AbortCallButton).show().enable();resettime=!0;starttimer=!0;break;case states.WaitingTransfer:break;default:self.log("PhoneBar","Debug","Unexpected state",newState);return}updateCallButton();events.statechanged.raise(self,{currentState:newState,previousState:oldState});resettime&&(currentStateTime=new Date,events.statetimechanged.raise(self,{stateTime:currentStateTime,startTimer:starttimer}),stateTimeTimer&&(stateTimeTimer=clearTimeout(stateTimeTimer)),starttimer&&(stateTimeTimer=setInterval(function(){var dT=new Date-currentStateTime;jQuery(el.StateTimeText).html(friendlyTime(dT,!0))},1e3)),jQuery(el.StateTimeText).html(""))}}function changeCallEventDisplayState(state,callId){var additionalStateInfo="",call;self.options.showCampaignNameForVoiceCalls()&&(call=callId&&activeCalls[callId],call&&call.mediatype==PhoneBar.Mediatypes.Voice||(call=getAudioCall()),call&&(additionalStateInfo=" ("+call.campaignName+")"));changeDisplayState(state+additionalStateInfo)}function changeMediatypeEventDisplayState(state,mediatype,campaignName){var additionalStateInfo="";self.options.showCampaignNameForVoiceCalls()&&mediatype===PhoneBar.Mediatypes.Voice&&campaignName.length>0&&(additionalStateInfo=" ("+campaignName+")");changeDisplayState(state+additionalStateInfo)}function changeDisplayState(label,timeout){timeout?(isTemporaryDisplayState=!0,jQuery(el.StateText).html(label),jQuery(el.StateText).addClass("phonebar-state-error-text"),events.displayStateChanged.raise(self,{label:label,isTemporary:!0}),setTimeout(function(){jQuery(el.StateText).removeClass("phonebar-state-error-text");isTemporaryDisplayState=!1;jQuery(el.StateText).html(lastDisplayState);events.displayStateChanged.raise(self,{label:lastDisplayState,isTemporary:!1})},timeout)):(lastDisplayState=label,isTemporaryDisplayState||(jQuery(el.StateText).html(label),events.displayStateChanged.raise(self,{label:label,isTemporary:!1})))}function getAudioCall(){return Object.values(activeCalls).find(function(c){return c.mediatype===PhoneBar.Mediatypes.Voice})||null}function goPaused(message){var newStateReasonId=message.reasonId||0;(currentState!==PhoneBar.States.Paused||newStateReasonId!==currentStateReasonId)&&(changeState(PhoneBar.States.Paused),currentStateReasonId=newStateReasonId,currentStateReasonId===0?(currentStateReason="",changeDisplayState(strings.PausedState)):(currentStateReason=message.reasonText,self.log("PhoneBar","Debug","Pause reason is",currentStateReason),changeDisplayState(strings.PausedState+" ("+currentStateReason+")")),events.pause.raise(self,message))}function goReady(){(currentState!==states.Ready||isBooked)&&(isBooked=!1,changeState(states.Ready),changeDisplayState(strings.ReadyState),events.ready.raise(self,{callId:null}))}function tokenChangeCallback(authInfo){authInfo.isRedirecting?self.log("PhoneBar","Info","Redirecting to",_config.authorityUrl):onTokenUpdated(authInfo.token,authInfo.username)}function onTokenUpdated(token,username){token||self.log("PhoneBar","Error","Missing access token");data.accessToken=token||"";username&&!self.agent.username!==username&&(self.agent.username=username);self.log("PhoneBar","Debug","Access token updated");self.isLoggedIn()&&(self.agent.password=token,self.agent.save(),self.media.phone&&self.media.phone.setAccessToken(token))}function stopRecording(callId,result){var call=activeCalls[callId];call&&call.isRecording?(call.isRecording=!1,updateRecordingButtons(callId),events.recordingstopped.raise(self,{callId:callId,result:result||0})):updateRecordingButtons(0)}function updateCallButton(){var states=PhoneBar.States;currentState===states.LoggedIn||currentState===states.Ready||currentState===states.Paused?jQuery(el.CallButton).enabled(jQuery(el.NumberInput).val()):jQuery(el.CallButton).disable()}function clearNumberInput(line){delete _inputNumbers[line];const q=jQuery(el.NumberInput);q.attr("title","");q.data("s")&&q.val("");q.removeData(["n","s"])}function updateNumberInput(line,displayNumber,displayName){const t=_inputNumbers[line]||(_inputNumbers[line]={});t.displayNumber=displayNumber||t.displayNumber;t.displayName=displayName||t.displayName;self.media.phone&&self.media.phone.selectedLineId===line&&showLineNumberInput(line)}function showLineNumberInput(line){const q=jQuery(el.NumberInput),t=_inputNumbers[line];t&&(t.displayName&&q.val(t.displayName),t.displayNumber&&t.displayNumber!==t.displayName&&(t.displayName?q.attr("title",t.displayNumber):q.val(t.displayNumber)),t.displayName&&t.displayNumber&&t.displayNumber!==t.displayName?(q.data("s",1),q.data("n",1)):q.removeData(["n","s"]))}function updateRecordingButtons(callId){var call=activeCalls[callId];call&&call.mediatype!==PhoneBar.Mediatypes.Voice||(call&&!call.terminated&&call.isRecording?call&&call.isRecording&&(jQuery(el.StartRecordingButton).disable(),jQuery(el.StartRecordingButton).hide(),jQuery(el.StopRecordingButton).enable(),jQuery(el.StopRecordingButton).show(),call.recordingData.rxChannelMuted||call.recordingData.txChannelMuted?(jQuery(el.MuteRecordingButton).disable(),jQuery(el.MuteRecordingButton).hide(),jQuery(el.UnmuteRecordingButton).enable(),jQuery(el.UnmuteRecordingButton).show()):(jQuery(el.MuteRecordingButton).enable(),jQuery(el.MuteRecordingButton).show(),jQuery(el.UnmuteRecordingButton).disable(),jQuery(el.UnmuteRecordingButton).hide())):(jQuery([el.StartRecordingButton,el.StopRecordingButton,el.MuteRecordingButton,el.UnmuteRecordingButton].join(", ")).disable(),jQuery(el.StopRecordingButton).hide(),jQuery(el.UnmuteRecordingButton).hide(),jQuery(el.StartRecordingButton).show(),jQuery(el.MuteRecordingButton).show()),!call||call.postcall||call.terminated||call.isRecording||jQuery(el.StartRecordingButton).enable())}function friendlyTime(dT,ms){var seconds,minutes;ms&&(dT=dT/1e3);seconds=Math.floor(dT%60);dT=dT/60;minutes=Math.floor(dT%60);dT=dT/60;var hours=Math.floor(dT%24),days=Math.floor(dT/24),timestr="";return days>0&&(timestr+=days+" d "),hours>0&&(timestr+=hours+" h "),minutes>0&&(timestr+=minutes+" m "),seconds>0&&(timestr+=seconds+" s "),timestr}function getPropertyValue(propertyName,call){switch(propertyName.toUpperCase()){case"CALLID":return call.id;case"CAMPAIGNID":return call.otherData.campaignId;case"CAMPAIGNNAME":return call.campaignName;case"SERVICEID":return call.otherData.serviceId;case"AGENTID":return self.agent.id;case"AGENTNAME":return self.agent.firstName+" "+self.agent.lastName;case"AGENTFIRSTNAME":return self.agent.firstName;case"AGENTLASTNAME":return self.agent.lastName;case"EXTENSION":return self.agent.extension}return""}function parseScriptName(scriptName,call){var parsed="",keyName="",value=scriptName,pos1,pos2;do pos1=value.indexOf("{$"),pos2=value.indexOf("{%"),pos1===-1&&pos2===-1?(parsed+=value,value=""):pos1>=0&&pos2===-1?(pos2=value.indexOf("}",pos1+2),pos2>=0?(parsed+=value.substr(0,pos1),keyName=value.substr(pos1+2,pos2-pos1-2),call.callData.get(keyName)&&(parsed+=call.callData.get(keyName)),value=value.substr(pos2+1)):(parsed+=value,value="")):pos1===-1&&pos2>=0?(pos1=pos2,pos2=value.indexOf("}",pos1+2),pos2>=0?(keyName=value.substr(pos1+2,pos2-pos1-2),parsed+=value.substr(0,pos1)+getPropertyValue(keyName,call),value=value.substr(pos2+1)):(parsed+=value,value="")):pos1<pos2?(pos2=value.indexOf("}",pos1+2),pos2>=0?(parsed+=value.substr(0,pos1),keyName=value.substr(pos1+2,pos2-pos1-2),call.callData.get(keyName)&&(parsed+=call.callData.get(keyName)),value=value.substr(pos2+1)):(parsed+=value,value="")):(pos1=pos2,pos2=value.indexOf("}",pos1+2),pos2>=0?(keyName=value.substr(pos1+2,pos2-pos1-2),parsed+=value.substr(0,pos1)+getPropertyValue(keyName,call),value=value.substr(pos2+1)):(parsed+=value,value=""));while(value.length>0);return parsed}function applyLanguage(){jQuery(el.LoginButton).attr("title",strings.TooltipLogin);jQuery(el.LoginOrReadyButton).attr("title",strings.TooltipLoginOrReady);jQuery(el.ReadyButton).attr("title",strings.TooltipReady);jQuery(el.PauseButton).attr("title",strings.TooltipPause);jQuery(el.LogoutButton).attr("title",strings.TooltipLogout);jQuery(el.CallButton).attr("title",strings.TooltipCall);jQuery(el.TransferButton).attr("title",strings.TooltipTransfer);jQuery(el.CampaignListButton).attr("title",strings.TooltipCampaignList);jQuery(el.QueueInfoButton).attr("title",strings.TooltipQueueInfo);jQuery(el.PanicButton).attr("title",strings.TooltipPanic);jQuery(el.MainMenuButton).attr("title",strings.TooltipMainMenu);jQuery(el.NumberLabel).attr("title",strings.TooltipPhoneNumber);jQuery(el.NumberInput).attr("placeholder","   "+strings.TooltipPhoneNumber);jQuery(el.StartRecordingButton).attr("title",strings.TooltipStartRec);jQuery(el.StopRecordingButton).attr("title",strings.TooltipStopRec);jQuery(el.MuteRecordingButton).attr("title",strings.TooltipMuteRec);jQuery(el.UnmuteRecordingButton).attr("title",strings.TooltipUnmuteRec);jQuery(el.HangupButton).attr("title",strings.TooltipHangup);jQuery(el.PickupButton).attr("title",strings.TooltipPickup);jQuery(el.FlashButton).attr("title",strings.TooltipFlash);jQuery(el.ManualTransferButton).attr("title",strings.TooltipManualTransfer);jQuery(el.Line1Button).attr("title",strings.TooltipLine1);jQuery(el.Line2Button).attr("title",strings.TooltipLine2);jQuery(el.EnterConferenceButton).attr("title",strings.TooltipEnterConf);jQuery(el.LeaveConferenceButton).attr("title",strings.TooltipLeaveConf);jQuery(el.MicrophoneVULabel+", "+el.MicrophoneVUMeter).attr("title",strings.TooltipMicVUMeter);jQuery(el.SpeakersVULabel+", "+el.SpeakersVUMeter).attr("title",strings.TooltipSpkVUMeter);jQuery(el.MicrophoneOffButton).attr("title",strings.TooltipMicOff);jQuery(el.MicrophoneOnButton).attr("title",strings.TooltipMicOn)}function sendNextAgentListRequest(){if(callbacks.getAgentList.length){var request=callbacks.getAgentList[0],campaignName=request.campaignName,mask=request.mask;self.log("PhoneBar","Debug","Sending AgentListRequest message");connection.send(new PhoneBar.Messages.AgentListRequest(campaignName,mask))}}function sendNextCampaignListRequest(){if(callbacks.getCampaignList.length){var request=callbacks.getCampaignList[0],mask=request.mask,callId=request.callId,mediatype=request.mediatype;self.log("PhoneBar","Debug","Sending CampaignListRequest message");connection.send(new PhoneBar.Messages.CampaignListRequest(mask,callId,mediatype))}}function sendNextPauseReasonListRequest(){callbacks.getPauseReasons.length&&(self.log("PhoneBar","Debug","Sending PauseReasonsRequest message"),connection.send(new PhoneBar.Messages.PauseReasonsRequest))}function sendNextQueueInfoRequest(){if(callbacks.getQueueInfo.length){var campaignName=callbacks.getQueueInfo[0].campaignName;self.log("PhoneBar","Debug","Sending CampaignQueueInfoRequest message");connection.send(new PhoneBar.Messages.CampaignQueueInfoRequest(campaignName))}}var self,events,_settings,_config,states,strings,el,isExtension=!!(window.chrome&&chrome.runtime&&chrome.runtime.id),isBooked=!1,currentState=PhoneBar.States.Initialization,lastDisplayState="",isTemporaryDisplayState=!1,currentStateReasonId=0,currentStateReason="",currentStateTime=0,stateTimeTimer,_inputNumbers={},data={accessToken:"",language:"it",localOAuth2:!1,loginRedirect:!1,logoutRedirect:!1},connection=new Ifm.Messaging.FConnection,activeCalls,callbacks,newCallRequest,CallFailureCauses={1:"[No Dial Tone]",2:"[No Ringback]",3:"[Line Busy]",4:"[No Answer]",5:"[Fax Tone]",6:"[Remote Hangup]",7:"[Agent: No Dial Tone]",8:"[Agent: No Ringback]",9:"[Agent: Line Busy]",10:"[Agent: No Answer]",255:"[Unknown]"},CallFailureCauseResources={1:"CallFailureNoDialTone",2:"CallFailureNoRingback",3:"CallFailureLineBusy",4:"CallFailureNoAnswer",5:"CallFailureFaxTone",6:"CallFailureRemoteHangUp",7:"CallFailureAgentNoDialTone",8:"CallFailureAgentNoRingback",9:"CallFailureAgentBusy",10:"CallFailureAgentNoAnswer",255:"CallFailureUnknown"},RecordingStates={RecordingInactive:0,RecordingActive:1,TxChannelMuted:2,RxChannelMuted:4},cookies={_root:"phonebar!",_agent:"agent!"};cookies.agent={firstName:cookies._root+cookies._agent+"firstName",lastName:cookies._root+cookies._agent+"lastName",password:cookies._root+cookies._agent+"password",extension:cookies._root+cookies._agent+"extension",username:cookies._root+cookies._agent+"username"};var DefaultPhonesFlags=0,DefaultPhonesProtocol="ipb",DefaultROPFlags=3,DefaultROPProtocol="ipr";return connection.events.connecting=function(){changeState(states.Connecting);changeDisplayState(strings.ConnectingState)},connection.events.disconnected=function(sender,e){var previousState=currentState;resetSessionData();changeState(states.NotLoggedIn);previousState!==states.Connecting&&previousState!==states.NotLoggedIn&&(self.media.phone&&self.media.phone.disconnect(),self.media.xmpp&&self.media.xmpp.disconnect());e.clean?changeDisplayState(strings.NotLoggedInState):e.failed?(self.log("Connection","Warn",e.reason),changeDisplayState(strings.ConnectionFailed)):e.lost&&(self.log("Connection","Warn","Connection lost"),changeDisplayState(strings.NotLoggedInState+" ("+strings.ConnectionLost+")"));updateRecordingButtons(0)},connection.events.binarymessage=function(sender,e){var messageReader=e.reader,message=null,Messages=PhoneBar.Messages,typename,callback,callId,p,call,i,c;for(typename in Messages.PhonesToPhoneBarMessages)if(messageReader.code===Messages.PhonesToPhoneBarMessages[typename]){message=new Messages[typename](messageReader);message.typecode=messageReader.code;break}if(message===null){self.log("PhoneBar","Warn","Unknown message received:",messageReader.code);return}if(message.typecode===Messages.PhonesToPhoneBarMessages.KeepAliveRequest){connection.send(new Messages.KeepAliveReply);return}callId=message.callId;callId?self.log("PhoneBar","Debug","Got",typename,"message, callId",callId):self.log("PhoneBar","Debug","Got",typename,"message");switch(message.typecode){case Messages.PhonesToPhoneBarMessages.AssignmentRequest:var callData=new Ifm.Messaging.FPropertyList(message.callDataStr),externalParty=callData.get("ExternalParty")||"",mediatype=message.mediatype||Number(callData.get("_MediaType_"))||PhoneBar.Mediatypes.Voice,hideNumber=!1;if(isBooked=!1,mediatype===PhoneBar.Mediatypes.Voice&&(newCallRequest?(hideNumber=newCallRequest.hideNumber,externalParty.endsWith(newCallRequest.externalParty)&&(externalParty=newCallRequest.externalParty,callData.set("ExternalParty",externalParty)),newCallRequest=null):callData.get("DDI")||(p=externalParty.lastIndexOf("+"),p>0&&(externalParty=externalParty.substring(p),callData.set("ExternalParty",externalParty)))),callData.save=function(){self.log("PhoneBar","Debug","Sending SetCallResultEvent message");connection.send(Messages.SetCallResultEvent(callId,callData.toString()))},call=activeCalls[callId]={callId:callId,callGuid:callData.get("GUID").toUpperCase(),mediatype:mediatype,hideNumber:hideNumber,displayNumber:hideNumber?"*****":externalParty,campaignName:message.campaignName,callData:callData,otherData:{serviceId:message.serviceId,campaignId:message.campaignId,scriptName:message.scriptName,scriptParameters:message.scriptParameters},isRecording:message.recordingState&RecordingStates.RecordingActive?!0:!1,recordingData:{fileName:message.recordingFileName,settings:message.recordingSettings,rxChannelMuted:message.recordingState&RecordingStates.RxChannelMuted?!0:!1,txChannelMuted:message.recordingState&RecordingStates.TxChannelMuted?!0:!1}},self.log("PhoneBar","Debug","Incoming call on campaign",call.campaignName,"with calldata",call.callData),self.log("PhoneBar","Debug","Sending AssignmentReply message"),connection.send(new Messages.AssignmentReply(callId,1)),changeState(states.Assigned),changeMediatypeEventDisplayState(strings.AssignedState,mediatype,message.campaignName),mediatype===PhoneBar.Mediatypes.Voice&&updateNumberInput(0,call.displayNumber),updateRecordingButtons(callId),events.assignment.raise(self,call),call.isRecording&&(events.recordingstarted.raise(self,{callId:callId,fileName:message.recordingFileName}),events.recordingmutechanged.raise(self,{callId:callId,rxChannelMuted:call.recordingData.rxChannelMuted,txChannelMuted:call.recordingData.txChannelMuted})),message.scriptName&&message.scriptName.length>0){self.log("PhoneBar","Debug","Script Type:",message.scriptName,"with parameters:",message.scriptParameters);switch(message.scriptName){case"OLE2":case"Preloaded":case"PTT":case"PLUGIN":break;default:window.open(parseScriptName(message.scriptName,call))}}break;case Messages.PhonesToPhoneBarMessages.LoginReply:message.accepted===0?(self.log("PhoneBar","Warn","Login request refused, cause",message.failureCause,Ifm.Enum.getName(PhoneBar.LoginReplyFailureCauses,message.failureCause)),changeState(states.NotLoggedIn),changeDisplayState(strings.RequestRefused,1e3),connection.disconnect(),self.options.forgetPassword()):(Ifm.Dom&&Ifm.Dom.Photon&&Ifm.Dom.Photon.Cards.close("login-dialog"),self.agent.id=message.agentId,message.extension&&(self.agent.extension=message.extension),message.username&&(self.agent.firstName=message.firstName,self.agent.lastName=message.lastName,self.agent.username=message.username),self.agent.save(),changeState(states.LoggedIn),changeDisplayState(strings.LoggedInState),self.media.phone&&(Ifm.PhoneBar.Media.Phone.events.connected.addHandler(function(){data.accessToken&&self.media.phone.setAccessToken(data.accessToken);self.media.phone.register()},null,!0),self.media.phone.connect()),self.options.autoConnectToXmpp()!==!1&&self.media.xmpp&&self.media.xmpp.connect());callback=callbacks.login.shift();callback&&callback(message);break;case Messages.PhonesToPhoneBarMessages.LogoutReply:message.accepted===0?(self.log("PhoneBar","Warn","Logout request refused"),changeDisplayState(strings.RequestRefused,1e3)):(delete self.agent.id,self.options.forgetPassword(),connection.disconnect(),data.localOAuth2&&Ifm.Iam.OAuth2.logout());callback=callbacks.logout.shift();callback&&callback(message);break;case Messages.PhonesToPhoneBarMessages.PauseReply:switch(message.accepted){case 0:self.log("PhoneBar","Warn","Pause request refused");changeDisplayState(strings.RequestRefused,1e3);break;case 1:goPaused(message);break;case 2:self.log("PhoneBar","Info","Pause booked");changeDisplayState(strings.PauseBooked,1e3);events.pausebooked.raise(self,message)}message.accepted===3?(callback=callbacks.getPauseReasons.shift(),callback&&callback({reasons:message.reasons}),sendNextPauseReasonListRequest()):(callback=callbacks.pause.shift(),callback&&callback(message));break;case Messages.PhonesToPhoneBarMessages.ReadyReply:message.accepted===0?(self.log("PhoneBar","Warn","Ready request refused"),changeDisplayState(strings.RequestRefused,1e3)):(callId&&activeCalls[callId]&&(activeCalls[callId].postcall=!1,activeCalls[callId].terminated=!0),events.ready.raise(self,{callId:callId}));callback=callbacks.ready.shift();callback&&callback(message);message.accepted===1&&(callId&&activeCalls[callId]?(stopRecording(callId),delete activeCalls[callId],evalNextState()):activeCalls.length>0?evalNextState():goReady());break;case Messages.PhonesToPhoneBarMessages.NewCallReply:message.accepted===0?(self.log("PhoneBar","Warn","New call request refused"),changeDisplayState(strings.RequestRefused,1e3)):(newCallRequest.callId=callId,self.log("PhoneBar","Info","New call request accepted, callId",callId),changeState(states.WaitingOutbound),changeDisplayState(strings.WaitingOutboundState));callback=callbacks.make.shift();callback&&callback(message);events.newcall.raise(self,{accepted:message.accepted,callId:message.callId,campaignName:newCallRequest.campaignName,hideNumber:newCallRequest.hideNumber});message.accepted===0&&(newCallRequest=null);break;case Messages.PhonesToPhoneBarMessages.AbortCallReply:message.accepted===0?(self.log("PhoneBar","Warn","Abort call request refused"),changeDisplayState(strings.RequestRefused,1e3)):newCallRequest&&newCallRequest.callId===message.callId&&(self.log("PhoneBar","Info","Abort call request accepted, callId",callId),message.campaign=newCallRequest.campaignName);callback=callbacks.abort.shift();callback&&callback(message);events.abortcall.raise(self,{accepted:message.accepted,callId:message.callId,campaignName:newCallRequest.campaignName,hideNumber:newCallRequest.hideNumber});break;case Messages.PhonesToPhoneBarMessages.TransferCallReply:message.accepted===0?(self.log("PhoneBar","Warn","Transfer call request refused"),changeDisplayState(strings.RequestRefused,1e3)):(self.log("PhoneBar","Info","Transfer call request accepted, callId",callId),activeCalls[callId].transferred=!0,activeCalls[callId].mediatype===PhoneBar.Mediatypes.Voice&&(changeState(states.WaitingTransfer),changeDisplayState(strings.WaitingTransferState)),events.readyfortransfer.raise(self,message));callback=callbacks.transfer.shift();callback&&callback(message);break;case Messages.PhonesToPhoneBarMessages.AgentListReply:callback=callbacks.getAgentList.shift();callback&&callback.callback(message);sendNextAgentListRequest();break;case Messages.PhonesToPhoneBarMessages.CampaignListReply:callback=callbacks.getCampaignList.shift();callback&&callback.callback(message);sendNextCampaignListRequest();break;case Messages.PhonesToPhoneBarMessages.CampaignQueueInfoReply:for(message.avgTimestamp=message.avgTime,message.avgTime=friendlyTime(message.avgTime),message.maxTimestamp=message.maxTime,message.maxTime=friendlyTime(message.maxTime),i=0;i<message.campaigns.length;i++)c=message.campaigns[i],c.avgTimestamp=c.avgTime,c.avgTime=friendlyTime(c.avgTime),c.maxTimestamp=c.maxTime,c.maxTime=friendlyTime(c.maxTime);callback=callbacks.getQueueInfo.shift();callback&&callback.callback(message);sendNextQueueInfoRequest();break;case Messages.PhonesToPhoneBarMessages.BookedEvent:isBooked=!0;changeMediatypeEventDisplayState(strings.AssignmentBooked,message.mediatype,message.campaignName);events.booked.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.AlertingEvent:changeState(states.Alerting);changeCallEventDisplayState(strings.AlertingState,message.callId);events.alerting.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.AnsweredEvent:changeState(states.Talking);changeCallEventDisplayState(strings.TalkingState,message.callId);events.answered.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.CallFailureEvent:self.log("PhoneBar","Warn","Call failure: callId",callId,"cause",message.cause,CallFailureCauses[message.cause],"ISDN cause",message.protocolTerminationCause,message.protocolTerminationDescription,"detected content cause",message.detectedContentCode,message.detectedContentDescription);message.description=strings[CallFailureCauseResources[message.cause]];newCallRequest&&newCallRequest.callId===callId||changeDisplayState(strings.CallFailure+" ("+message.description+")",3e3);activeCalls[callId]&&(activeCalls[callId].terminated=!0,stopRecording(callId));events.callfailure.raise(self,message);newCallRequest&&newCallRequest.callId===callId&&(newCallRequest=null);delete activeCalls[callId];evalNextState();break;case Messages.PhonesToPhoneBarMessages.OtherCallEvent:currentState!==states.WaitingOutbound&&(changeState(states.OtherCall),changeDisplayState(strings.OtherCallState),events.othercall.raise(self,message));break;case Messages.PhonesToPhoneBarMessages.PauseEvent:case Messages.PhonesToPhoneBarMessages.ReadyEvent:Object.values(activeCalls).forEach(function(c){c.transferred&&(stopRecording(c.callId),delete activeCalls[c.callId])});newCallRequest=null;message.typecode===Messages.PhonesToPhoneBarMessages.PauseEvent?goPaused(message):evalNextState();break;case Messages.PhonesToPhoneBarMessages.ReadyForDetachEvent:events.readyfordetach.raise(self,message);activeCalls[callId]&&activeCalls[callId].transferred&&activeCalls[callId].mediatype>PhoneBar.Mediatypes.Voice&&(delete activeCalls[callId],evalNextState());break;case Messages.PhonesToPhoneBarMessages.ReadyForTransferEvent:events.readyfortransfer.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.SupervisorMessageEvent:events.supervisormessage.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.TerminatedEvent:activeCalls[callId].terminated=!0;message.postCallWork&&(activeCalls[callId].postcall=!0);events.terminated.raise(self,message);activeCalls[callId].postcall?updateRecordingButtons():(stopRecording(callId),delete activeCalls[callId]);evalNextState();break;case Messages.PhonesToPhoneBarMessages.PostCallWorkEvent:evalNextState();break;case Messages.PhonesToPhoneBarMessages.AudioRecordingStartedEvent:activeCalls[callId]&&(activeCalls[callId].recordingData.fileName=message.fileName,updateRecordingButtons(callId),events.recordingstarted.raise(self,message));break;case Messages.PhonesToPhoneBarMessages.AudioRecordingCompletedEvent:stopRecording(callId,message.result);break;case Messages.PhonesToPhoneBarMessages.AudioRecordingMutedEvent:activeCalls[callId].recordingData.rxChannelMuted=message.rxChannelMuted;activeCalls[callId].recordingData.txChannelMuted=message.txChannelMuted;updateRecordingButtons(callId);events.recordingmutechanged.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.MaskedDigitReceivedEvent:events.maskeddigitreceived.raise(self,message);break;case Messages.PhonesToPhoneBarMessages.MaskedPayloadReceivedEvent:events.maskedpayloadreceived.raise(self,message);break;default:self.log("PhoneBar","Debug","Not implemented:",typename)}},{calls:function(filter){var predicate=typeof filter=="function"?filter:null,c;return arguments.length>0&&predicate===null?activeCalls[filter]||null:(c=Object.values(activeCalls),predicate)?c.filter(predicate):c},currentState:function(){return currentState},currentStateReason:function(){return currentStateReason},currentStateReasonId:function(){return currentStateReasonId},currentStateTime:function(){return currentStateTime},getConfiguration:function(){return _settings},getPhoneBarConfiguration:function(){return _config},language:function(lang){if(arguments.length===0)return data.language;lang&&PhoneBar.Strings[lang]&&(strings=PhoneBar.Strings[lang],data.language=lang,applyLanguage(),self.log("PhoneBar","Debug","Language set to '"+lang+"'"),events.languagechanged.raise(self,{language:lang}))},isLoggedIn:function(){return self&&self.connection&&self.connection.isConnected()},isOAuth2Enabled:function(){return data.localOAuth2},isRedirectedAfterOAuth2Signin:function(){return data.loginRedirect},isRedirectedAfterOAuth2Signout:function(){return data.logoutRedirect},initialize:function(settings,options){if(arguments.length==1&&(options=settings.options),currentState!==PhoneBar.States.Initialization&&currentState!==states.NotLoggedIn)throw Ifm.Diagnostics.Errors.op("must be not logged in");if(_settings=settings,_config=settings.config,self)!(Ifm.Iam&&Ifm.Iam.OAuth2&&_config.enableOAuth2)||data.localOAuth2||(data.localOAuth2=!0,data.loginRedirect=Ifm.Iam.OAuth2.isOAuth2Redirect(),data.logoutRedirect=Ifm.Iam.OAuth2.isLogoutRedirect(),Ifm.Iam.OAuth2.addLogCallback(self.log),Ifm.Iam.OAuth2.addTokenChangeCallback(tokenChangeCallback));else{if(!PhoneBar.canRun())throw Ifm.Diagnostics.Errors.browser();Ifm.version=PhoneBar.version+"; "+Ifm.version;self=this;events=PhoneBar.events;states=PhoneBar.States;el=PhoneBar.UI.Elements;self.log("PhoneBar","Info",Ifm.version);window.addEventListener("pagehide",function(){self.media.phone&&self.media.phone.disconnect();self.media.xmpp&&self.media.xmpp.disconnect()});jQuery.fn.extend({enable:function(){return this.each(function(){jQuery(this).prop("disabled",!1);jQuery(this).removeAttr("disabled")})},disable:function(){return this.each(function(){jQuery(this).prop("disabled",!0);jQuery(this).attr("disabled","")})},enabled:function(state){return this.each(function(){state?jQuery(this).enable():jQuery(this).disable()})}});data.localOAuth2=!!(Ifm.Iam&&Ifm.Iam.OAuth2&&_config.enableOAuth2);data.localOAuth2&&(data.loginRedirect=Ifm.Iam.OAuth2.isOAuth2Redirect(),data.logoutRedirect=Ifm.Iam.OAuth2.isLogoutRedirect(),Ifm.Iam.OAuth2.addLogCallback(self.log),Ifm.Iam.OAuth2.addTokenChangeCallback(tokenChangeCallback));jQuery(el.NumberInput).attr("maxlength",255).on("change input",function(){var filteredNumberInput=jQuery(el.NumberInput).val().replace(/([^0-9#*])/g,"");jQuery(el.NumberInput).val(filteredNumberInput);updateCallButton()});Ifm.PhoneBar.Media.Phone.events.calldisconnected=function(_,e){clearNumberInput(e.lineId)};Ifm.PhoneBar.Media.Phone.events.lineselected=function(_,e){showLineNumberInput(e.lineId)};Ifm.PhoneBar.Media.Phone.events.displayname=function(_,e){e.displayName&&updateNumberInput(e.lineId,undefined,e.displayName)}}Ifm.Diagnostics.Debug.enabled=_config.debug||!1;self.language(PhoneBar.Strings[_config.language]?_config.language:"it");jQuery('[class^="phonebar-phone"]').hide();jQuery(el.AbortCallButton).disable().hide();jQuery("#page-layout").show();self.media.phone&&(self.media.phone.terminate(),delete self.media.phone);let asyncPhoneInit,asyncXmppInit;return new Promise(function(resolve){_config.phoneDevice&&_config.phoneDevice!=="NoDevice"&&(_config.phoneDevice in PhoneBar.Media?(self.media.phone=new PhoneBar.Media[_config.phoneDevice](self),self.media.phone.updateCallButton=updateCallButton,asyncPhoneInit=self.media.phone.initialize(settings)):self.log("PhoneBar","Error","Invalid configuration argument PhoneDevice:",_config.phoneDevice));self.media.xmpp&&(self.media.xmpp.terminate(),delete self.media.xmpp);PhoneBar.Media.Xmpp.instance&&settings.xmppconfig&&settings.xmppconfig.service&&settings.xmppconfig.useBuiltinXmppWindow!==!1&&(self.media.xmpp=PhoneBar.Media.Xmpp.instance,asyncXmppInit=self.media.xmpp.initialize(self,settings.xmppconfig));resetSessionData();changeState(states.NotLoggedIn);changeDisplayState(strings.NotLoggedInState);updateRecordingButtons(0);self.agent.load();for(var option in options)self.options[option]&&self.options[option](options[option]);Promise.all([asyncPhoneInit,asyncXmppInit]).then(function(){events.initialized.raise(self,{settings:settings,options:options});data.localOAuth2&&!data.logoutRedirect&&data.loginRedirect&&self.getToken(function(token){self.loginWithToken(token,self.agent.extension)});resolve()})})},login:function(firstName,lastName,password,extension,callback){var isLoginWithToken,cloudService,userParts,userDomain;if(arguments.length<4||arguments.length>5)throw Ifm.Diagnostics.Errors.argsno("4 (+1)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");if(self.connection.isConnected())throw Ifm.Diagnostics.Errors.op("already logged in");extension=extension!=undefined&&extension!=null?extension.toString():"";isLoginWithToken=firstName==="\t";isLoginWithToken||(self.agent.firstName=firstName,self.agent.lastName=lastName);self.agent.password=password;self.agent.extension=extension;self.agent.save();var service=_config.service,protocol=_config.protocol||DefaultPhonesProtocol,flags=_config.flags||DefaultPhonesFlags;if(Ifm.Type.isString(extension)&&extension.startsWith("@")&&(service=_config.service_rop||_config.service,protocol=_config.protocol_rop||DefaultROPProtocol,flags=_config.flags_rop||DefaultROPFlags,extension=self.agent.extension=extension.slice(1)),isLoginWithToken){if(cloudService=(Ifm.Type.isArray(service)?service[0]:service)||"",cloudService.startsWith("*")){if(!self.agent.username){if(data.localOAuth2){self.getToken(function(token){self.login(firstName,lastName,token,extension,callback)});return}self.log("PhoneBar","Error","External token must specify a valid username for cloud-based login.")}userParts=self.agent.username.split("@");userDomain=userParts.length==2?userParts[1]:"";userDomain=userDomain.replace(/\./g,"-");service=cloudService.replace("*","wss://"+userDomain+"-agents")}self.log("PhoneBar","Info","Loggin'in to",service,"via OAuth2 as",self.agent.username,"extension",extension||"(auto)")}else self.log("PhoneBar","Info","Loggin'in to",service,"as",firstName,lastName,"extension",extension||"(auto)");connection.connect(service,protocol,function(){callback&&callbacks.login.push(callback);self.log("PhoneBar","Debug","Sending LoginRequest message");connection.send(new PhoneBar.Messages.LoginRequest(firstName,lastName,password,extension,flags))})},loginEx:function(firstName,lastName,oldPassword,newPassword,extension,callback){if(arguments.length<5||arguments.length>6)throw Ifm.Diagnostics.Errors.argsno("5 (+1)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");if(self.connection.isConnected())throw Ifm.Diagnostics.Errors.op("already logged in");extension=extension!=undefined&&extension!=null?extension.toString():"";self.agent.firstName=firstName;self.agent.lastName=lastName;self.agent.password=newPassword;self.agent.extension=extension;self.agent.save();var service=_config.service,protocol=_config.protocol||DefaultPhonesProtocol,flags=_config.flags||DefaultPhonesFlags;Ifm.Type.isString(extension)&&extension.startsWith("@")&&(service=_config.service_rop||_config.service,protocol=_config.protocol_rop||DefaultROPProtocol,flags=_config.flags_rop||DefaultROPFlags,extension=self.agent.extension=extension.slice(1));self.log("PhoneBar","Info","Loggin'in to",service,"as",firstName,lastName,"extension",extension||"(auto)");connection.connect(service,protocol,function(){callback&&callbacks.login.push(callback);self.log("PhoneBar","Debug","Sending LoginRequest message");connection.send(new PhoneBar.Messages.LoginExRequest(firstName,lastName,oldPassword,newPassword,extension,flags))})},getToken:function(callback,username,authConfig){if(arguments.length>3)throw Ifm.Diagnostics.Errors.argsno("0 (+3)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");if(!authConfig&&!data.localOAuth2)throw Ifm.Diagnostics.Errors.notsup("OAuth2");const cfg=authConfig?{authorityUrl:authConfig.authorityurl,authorityIsAdfs:authConfig.isadfs,clientId:authConfig.clientid,scopes:authConfig.scopes}:_config;"usePopup"in cfg||(cfg.usePopup=Ifm.Photon&&Ifm.Photon.app.isHosted||!1);Ifm.Iam.OAuth2.getToken(cfg,username||self.agent.username).then(function(authInfo){callback&&authInfo.token&&callback(authInfo.token)}).catch(function(error){self.log("PhoneBar","Error",error&&(error.message||error.errorMessage)||error);callback(null)})},loginWithToken:function(token,extension,username,callback){if(arguments.length<2||arguments.length>4)throw Ifm.Diagnostics.Errors.argsno("2 (+2)");onTokenUpdated(token,username);self.login("\t","\t",token,extension,callback)},updateToken:function(token,username){if(arguments.length>2)throw Ifm.Diagnostics.Errors.argsno("1 (+1)");onTokenUpdated(token,username)},logout:function(callback){if(arguments.length>1)throw Ifm.Diagnostics.Errors.argsno("0 (+1)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");callback&&callbacks.logout.push(callback);self.log("PhoneBar","Debug","Sending LogoutRequest message");connection.send(new PhoneBar.Messages.LogoutRequest)},pause:function(reasonId,callback){if(arguments.length>2)throw Ifm.Diagnostics.Errors.argsno("0 (+2)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");callback&&callbacks.pause.push(callback);self.log("PhoneBar","Debug","Sending PauseRequest message");connection.send(new PhoneBar.Messages.PauseRequest(reasonId))},ready:function(callId,callback){if(arguments.length>2)throw Ifm.Diagnostics.Errors.argsno("0 (+2)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");callback&&callbacks.ready.push(callback);self.log("PhoneBar","Debug","Sending ReadyRequest message",callId?"for call "+callId:"");connection.send(new PhoneBar.Messages.ReadyRequest(callId))},makeCall:function(phoneNumber,campaignName,callingNumber,callback){if(arguments.length<2||arguments.length>4)throw Ifm.Diagnostics.Errors.argsno("2 (+1)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");if(newCallRequest)throw Ifm.Diagnostics.Errors.op("a previous request is pending");callback&&callbacks.make.push(callback);let hiddenFlag=!1;if(Ifm.Type.isString(phoneNumber)){const parts=phoneNumber.split(";");if(parts.length>1){const flags=parts[1].split(",").filter(function(f){return hiddenFlag|=f==="H"||f==="h",!hiddenFlag});phoneNumber=parts[0];flags.length>0&&(phoneNumber+=";"+flags.join(","))}}newCallRequest={campaignName:campaignName,externalParty:phoneNumber,hideNumber:hiddenFlag};self.log("PhoneBar","Debug","Sending NewCallRequest message");connection.send(new PhoneBar.Messages.NewCallRequest(phoneNumber,campaignName,callingNumber||""))},abortCall:function(callback){if(arguments.length>1)throw Ifm.Diagnostics.Errors.argsno("0 (+1)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");newCallRequest?(callback&&callbacks.abort.push(callback),self.log("PhoneBar","Debug","Sending AbortCallRequest messagefor call",newCallRequest.callId),connection.send(new PhoneBar.Messages.AbortCallRequest(newCallRequest.callId))):callback&&callback({callId:0,campaign:"",accepted:0})},transferCall:function(callId,campaignName,agentFirstName,agentLastName,mandatory,mode,callback){if(arguments.length<2||arguments.length>7)throw Ifm.Diagnostics.Errors.argsno("2 (+5)");if(callback&&!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");activeCalls[callId]&&activeCalls[callId].mediatype>PhoneBar.Mediatypes.Voice?mode=0:mode!==0&&mode!==2&&(mode=PhoneBar.TransferCallModes.Default);callback&&callbacks.transfer.push(callback);var callDataStr=activeCalls[callId]&&activeCalls[callId].callData.toString();self.log("PhoneBar","Debug","Sending TransferCallRequest message for call",callId);connection.send(new PhoneBar.Messages.TransferCallRequest(callId,mode,campaignName,callDataStr,agentFirstName,agentLastName,mandatory))},getAgentList:function(campaignName,mask,callback){if(arguments.length!==3)throw Ifm.Diagnostics.Errors.argsno("3");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");self.isLoggedIn()&&(callbacks.getAgentList.push({campaignName:campaignName,mask:mask,callback:callback}),callbacks.getAgentList.length===1&&sendNextAgentListRequest())},getTransferAgentList:function(campaignName,callback){var mask=1022;return self.options.hidePausedAgents()&&(mask=990),self.getAgentList(campaignName,mask,callback)},getCampaignList:function(callId,mediatype,mask,callback){if(arguments.length!==4)throw Ifm.Diagnostics.Errors.argsno("4");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");self.isLoggedIn()&&(callbacks.getCampaignList.push({callId:callId,mediatype:mediatype,mask:mask,callback:callback}),callbacks.getCampaignList.length===1&&sendNextCampaignListRequest())},getAssignedCampaignList:function(callback){return self.getCampaignList(0,0,95,callback)},getOutboundCampaignList:function(callback){return self.getCampaignList(0,0,82,callback)},getTransferCampaignList:function(callId,callback){var mediatype=0,mask;return callId&&self.calls(callId)&&(mediatype=self.calls(callId).mediatype),mask=378,self.getCampaignList(callId,mediatype,mask,callback)},getPauseReasons:function(callback){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");self.isLoggedIn()&&(callbacks.getPauseReasons.push(callback),callbacks.getPauseReasons.length===1&&sendNextPauseReasonListRequest())},getQueueInfo:function(campaignName,callback){if(arguments.length!==2)throw Ifm.Diagnostics.Errors.argsno("2");if(!Ifm.Type.isFunction(callback))throw Ifm.Diagnostics.Errors.func("callback");self.isLoggedIn()&&(callbacks.getQueueInfo.push({campaignName:campaignName,callback:callback}),callbacks.getQueueInfo.length===1&&sendNextQueueInfoRequest())},panic:function(){if(arguments.length!==0)throw Ifm.Diagnostics.Errors.argsno("0");self.log("PhoneBar","Debug","Sending AgentPanicEvent message");connection.send(new PhoneBar.Messages.AgentPanicEvent)},log:function(context,severity){var views;if(arguments.length<3)throw Ifm.Diagnostics.Errors.argsno("3+");var line="",now=new Date,timestamp=now.toLocaleTimeString()+"."+("000"+now.getMilliseconds()).slice(-3),method=severity.toLowerCase();isExtension&&method!=="debug"&&(method="log");context&&(line+="["+context+"] ");severity&&(line+="["+severity+"] ");line+=Array.prototype.splice.call(arguments,2).join(" ");try{console[method](line)}catch(err){console.log(line)}views=jQuery(el.LogText);views.length&&(line=line.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),jQuery(el.LogText).append("<div class='phonebar-log-text-"+severity.toLowerCase()+"'><span class='phonebar-log-text-timestamp'>"+timestamp+" <\/span><span class='phonebar-log-text-line'>"+line+"<\/span><\/div>").parent().scrollTop(jQuery(el.LogText).height()))},startRecording:function(callId,fileName,settings){var mediatype,partNumber,part;if(arguments.length<1||arguments.length>3)throw Ifm.Diagnostics.Errors.argsno("1 (+2)");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");if(mediatype=self.calls(callId).mediatype,mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");Ifm.Type.isString(fileName)||(fileName=_config.recordingsPath||"C:\\Recordings\\",fileName.endsWith("\\")||(fileName+="\\"),partNumber=self.calls(callId).lastRecordingPart=(self.calls(callId).lastRecordingPart||0)+1,part=partNumber>1?" ("+partNumber+")":"",fileName+=(new Date).toISOLocaleDateString()+" "+callId+" "+self.agent.getName()+part+".wav");jQuery(el.StartRecordingButton).disable();self.calls(callId).isRecording=!0;self.log("PhoneBar","Debug","Sending StartAudioRecordingRequest message for call",callId);connection.send(new PhoneBar.Messages.StartAudioRecordingRequest(callId,fileName,settings||0))},stopRecording:function(callId){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");var mediatype=self.calls(callId).mediatype;if(mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");jQuery(el.StopRecordingButton).disable();self.log("PhoneBar","Debug","Sending StopAudioRecordingRequest message for call",callId);connection.send(new PhoneBar.Messages.StopAudioRecordingRequest(callId))},muteRecording:function(callId,muteRxChannel,muteTxChannel,tag){if(arguments.length<3||arguments.length>4)throw Ifm.Diagnostics.Errors.argsno("3 (+1)");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");var mediatype=self.calls(callId).mediatype;if(mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");self.log("PhoneBar","Debug","Sending SetAudioRecordingMuteRequest message for call",callId);connection.send(new PhoneBar.Messages.SetAudioRecordingMuteRequest(callId,muteTxChannel,muteRxChannel,!!tag,tag||""))},tagRecording:function(callId,tag){if(arguments.length!==2)throw Ifm.Diagnostics.Errors.argsno("2");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");var mediatype=self.calls(callId).mediatype;if(mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");self.log("PhoneBar","Debug","Sending AppendCueSheetEntryRequest message for call",callId);connection.send(new PhoneBar.Messages.AppendCueSheetEntryRequest(callId,tag||""))},swapCall:function(callId){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");var mediatype=self.calls(callId).mediatype;if(mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support swap");self.log("PhoneBar","Debug","Sending ConsultationCallControlRequest message for call",callId);connection.send(new PhoneBar.Messages.ConsultationCallControlRequest(callId,1))},startDTMFMasking:function(callId,numberOfDigits,terminationDigit){if(arguments.length!==3)throw Ifm.Diagnostics.Errors.argsno("3");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");var mediatype=self.calls(callId).mediatype;if(mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support DTMFMasking");self.log("PhoneBar","Debug","Sending StartDTMFMaskingRequest - callId:",callId,"numberOfDigits:",numberOfDigits,"terminationDigit:",terminationDigit);connection.send(new PhoneBar.Messages.StartDTMFMaskingRequest(callId,numberOfDigits,terminationDigit))},stopDTMFMasking:function(callId){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!callId||!self.calls(callId))throw Ifm.Diagnostics.Errors.arg("callId");var mediatype=self.calls(callId).mediatype;if(mediatype!==PhoneBar.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support DTMFMasking");self.log("PhoneBar","Debug","Sending StopDTMFMaskingRequest - callId:",callId);connection.send(new PhoneBar.Messages.StopDTMFMaskingRequest(callId))},agent:{firstName:"",lastName:"",password:"",extension:"",username:"",getName:function(){return this.firstName+" "+this.lastName},load:function(){self.agent.extension=Ifm.Cookies.get(cookies.agent.extension);self.options.rememberCredentials()&&(self.agent.firstName=Ifm.Cookies.get(cookies.agent.firstName),self.agent.lastName=Ifm.Cookies.get(cookies.agent.lastName),self.agent.username=Ifm.Cookies.get(cookies.agent.username),self.agent.password=Ifm.Cookies.get(cookies.agent.password))},save:function(){Ifm.Cookies.set(cookies.agent.extension,this.extension);self.options.rememberCredentials()&&(Ifm.Cookies.set(cookies.agent.firstName,this.firstName),Ifm.Cookies.set(cookies.agent.lastName,this.lastName),Ifm.Cookies.set(cookies.agent.username,this.username));self.options.rememberCredentials()===2&&Ifm.Cookies.set(cookies.agent.password,this.password)}},config:{},connection:{events:connection.events,isConnected:function(){return connection.isConnected()},_getConnection:function(){return connection}},media:{},options:function(){var autoanswerphone=1,autoanswerrings=1,callingnumber="",remembercredentials=1,loginonstart=1,popupincomingcalls=1,hideclockinpause=!1,hidepausedagents=!1,confirmnavigation=!1,preventbackspace=!1,preventhardrefresh=!1,preventrefresh=!1,preventrightclick=!1,autoconnecttoxmpp=!0,showcampaignnameforvoicecalls=!1,InputControlTypes=/INPUT|SELECT|TEXTAREA/i;jQuery(document).on("keydown keyup",function(e){if(e.which===9)return!1;if(e.which===8&&!e.ctrlKey&&!e.shiftKey&&!e.altkey&&preventbackspace){var target=e.target;if(!InputControlTypes.test(target.tagName)||target.disabled||target.readOnly)return!1}return e.which===82&&e.ctrlKey&&preventhardrefresh?!1:e.which===116&&(!e.ctrlKey&&preventrefresh||e.ctrlKey&&preventhardrefresh)?!1:void 0});jQuery(document).on("contextmenu",function(){return preventrightclick&&Ifm.PhoneBar.UI.Commands&&setTimeout(Ifm.PhoneBar.UI.Commands.showMenu,0),!preventrightclick});jQuery(window).on("beforeunload",function(){if(confirmnavigation&&PhoneBar.instance.isLoggedIn())return strings.UnloadPageConfirm});return{autoAnswerPhone:function(value){if(value===undefined)return autoanswerphone;value>=0&&value<=3&&(autoanswerphone=value)},autoAnswerRings:function(value){if(value===undefined)return autoanswerrings;autoanswerrings=value},autoConnectToXmpp:function(value){if(value===undefined)return autoconnecttoxmpp;autoconnecttoxmpp=value},hideClockInPause:function(value){if(value===undefined)return hideclockinpause;hideclockinpause=!!value},hidePausedAgents:function(value){if(value===undefined)return hidepausedagents;hidepausedagents=!!value},callingNumber:function(value){if(value===undefined)return callingnumber;callingnumber=value},rememberCredentials:function(value){if(value===undefined)return remembercredentials;(value===0||value===1||value===2)&&(remembercredentials=value);value<2&&this.forgetPassword();value<1&&(Ifm.Cookies.delete(cookies.agent.firstName),Ifm.Cookies.delete(cookies.agent.lastName),Ifm.Cookies.delete(cookies.agent.username))},loginOnStart:function(value){if(value===undefined)return loginonstart;(value===0||value===1||value===2)&&(loginonstart=value)},popupIncomingCalls:function(value){if(value===undefined)return popupincomingcalls;Ifm.Type.isNumber(value)&&(popupincomingcalls=value)},confirmNavigation:function(value){if(value===undefined)return confirmnavigation;confirmnavigation=!!value},preventBackspace:function(value){if(value===undefined)return preventbackspace;preventbackspace=!!value},preventHardRefresh:function(value){if(value===undefined)return preventhardrefresh;preventhardrefresh=!!value},preventRefresh:function(value){if(value===undefined)return preventrefresh;preventrefresh=!!value},preventRightClick:function(value){if(value===undefined)return preventrightclick;preventrightclick=!!value},showCampaignNameForVoiceCalls:function(value){if(value===undefined)return showcampaignnameforvoicecalls;showcampaignnameforvoicecalls=!!value},forgetPassword:function(){Ifm.Cookies.delete(cookies.agent.password);PhoneBar.instance.agent.password=""}}}()}}(Ifm.PhoneBar)}(Ifm.PhoneBar);namespace("Ifm.PhoneBar.UI").Elements={MainToolbar:".phonebar-toolbar",PhoneToolbar:".phonebar-phone-toolbar",PhoneDialPad:".phonebar-phone-dialpad",LogText:".phonebar-log-text",StateText:".phonebar-state-text",StateTimeText:".phonebar-state-time-text",PhoneStateText:".phonebar-phone-state-text",RecordingStateText:".phonebar-recording-state-text",NumberLabel:".phonebar-number-label",NumberInput:".phonebar-number-input",LoginButton:".phonebar-login-button",LoginOrReadyButton:".phonebar-login-ready-button",ReadyButton:".phonebar-ready-button",PauseButton:".phonebar-pause-button",LogoutButton:".phonebar-logout-button",CallButton:".phonebar-call-button",AbortCallButton:".phonebar-abort-call-button",TransferButton:".phonebar-transfer-button",CampaignListButton:".phonebar-campaignlist-button",QueueInfoButton:".phonebar-queueinfo-button",PanicButton:".phonebar-panic-button",StartRecordingButton:".phonebar-start-recording-button",StopRecordingButton:".phonebar-stop-recording-button",MuteRecordingButton:".phonebar-mute-recording-button",UnmuteRecordingButton:".phonebar-unmute-recording-button",MainMenuButton:".phonebar-mainmenu-button",HangupButton:".phonebar-phone-hangup-button",PickupButton:".phonebar-phone-pickup-button",FlashButton:".phonebar-phone-flash-button",ManualTransferButton:".phonebar-phone-manual-transfer-button",Line1Button:".phonebar-phone-line1-button",Line2Button:".phonebar-phone-line2-button",EnterConferenceButton:".phonebar-phone-enter-conference-button",LeaveConferenceButton:".phonebar-phone-leave-conference-button",MicrophoneVULabel:".phonebar-phone-microphone-label",MicrophoneVUMeter:".phonebar-phone-microphone-meter",SpeakersVULabel:".phonebar-phone-speakers-label",SpeakersVUMeter:".phonebar-phone-speakers-meter",MicrophoneOffButton:".phonebar-phone-microphone-off-button",MicrophoneOnButton:".phonebar-phone-microphone-on-button",HideDialPadButton:".phonebar-phone-dialpad-hide-button",ShowDialPadButton:".phonebar-phone-dialpad-show-button",ToggleDialPadButton:".phonebar-phone-dialpad-toggle-button",DialPadDigit0Button:".phonebar-phone-key-digit0",DialPadDigit1Button:".phonebar-phone-key-digit1",DialPadDigit2Button:".phonebar-phone-key-digit2",DialPadDigit3Button:".phonebar-phone-key-digit3",DialPadDigit4Button:".phonebar-phone-key-digit4",DialPadDigit5Button:".phonebar-phone-key-digit5",DialPadDigit6Button:".phonebar-phone-key-digit6",DialPadDigit7Button:".phonebar-phone-key-digit7",DialPadDigit8Button:".phonebar-phone-key-digit8",DialPadDigit9Button:".phonebar-phone-key-digit9",DialPadHashButton:".phonebar-phone-key-hash",DialPadStarButton:".phonebar-phone-key-star",TransferCampaignList:".phonebar-transfer-campaign-list",TransferAgentList:".phonebar-transfer-agent-list",TransferMandatoryCheck:".phonebar-transfer-mandatory-check"};namespace("Ifm.PhoneBar.Media");namespace("Ifm.PhoneBar.Media.Phone");namespace("Ifm.PhoneBar.Media.Phone.events");namespace("Ifm.PhoneBar.Media.Xmpp");namespace("Ifm.PhoneBar.Media.Xmpp.events");namespace("Ifm.PhoneBar.Messages"),function(){this.PhonesToPhoneBarMessages={AssignmentRequest:12292,KeepAliveRequest:12543,LoginReply:20480,LogoutReply:20481,ReadyReply:20482,PauseReply:20483,NewCallReply:20485,TransferCallReply:20486,CampaignListReply:20487,AgentListReply:20488,CampaignQueueInfoReply:20489,SetCampaignStatusReply:20490,AbortCallReply:20494,RetrieveCallReply:20495,ReadyEvent:36866,PauseEvent:36867,AlertingEvent:38912,AnsweredEvent:38913,TerminatedEvent:38914,CallFailureEvent:38915,OtherCallEvent:38916,PostCallWorkEvent:38917,SupervisorMessageEvent:38919,ReadyForTransferEvent:38920,ReadyForDetachEvent:38921,BookedEvent:38924,AudioRecordingStartedEvent:38933,AudioRecordingMutedEvent:38934,AudioRecordingCompletedEvent:38935,MaskedDigitReceivedEvent:38936,MaskedPayloadReceivedEvent:38937};this.AssignmentRequest=function(message){this.callId=message.nextInt32();this.rejectable=message.nextByte();this.campaignName=message.nextString();this.scriptName=message.nextString();this.scriptParameters=message.nextString();this.callDataStr=message.nextString();this.dummy=message.nextByte();this.cfgVersion=message.nextString();this.serviceId=message.nextString();this.campaignId=message.nextString();this.recordingState=message.remainingBytes()>=1?message.nextByte():0;this.recordingFileName=message.remainingBytes()>=2?message.nextString():"";this.recordingSettings=message.remainingBytes()>=4?message.nextInt32():0;this.mediatype=message.remainingBytes()>=4?message.nextInt32():0};this.KeepAliveRequest=function(){};this.LoginReply=function(message){this.accepted=message.nextByte();message.remainingBytes()&&(this.agentId=message.nextString(),message.nextString(),this.failureCause=message.nextByte(),this.extension=message.remainingBytes()>=2?message.nextString():null);message.remainingBytes()&&(this.firstName=message.nextString(),this.lastName=message.nextString(),this.username=message.nextString())};this.LogoutReply=function(message){this.accepted=message.nextByte()};this.ReadyReply=function(message){this.accepted=message.nextByte();this.callId=message.remainingBytes()>=4?message.nextInt32():null};this.PauseReply=function(message){var number,i,id,text;if(this.accepted=message.nextByte(),this.accepted<3&&message.remainingBytes())this.reasonId=message.nextInt32(),this.reasonText=message.nextString();else if(this.accepted===3)for(number=message.nextInt32(),this.reasons=[],i=0;i<number;i++)id=message.nextInt32(),text=message.nextString(),this.reasons.push({id:id,text:text})};this.NewCallReply=function(message){this.callId=message.nextInt32();this.accepted=message.nextByte()};this.TransferCallReply=function(message){this.callId=message.nextInt32();this.accepted=message.nextByte()};this.CampaignListReply=function(message){function unpack(c){return c.name=c.serviceName+"/"+c.campaignName,c.active=!!(mask&2),c.status=mask&7,c.boundness=mask&8?"Inbound":"Outbound",c.assigned=!!(mask&64),c.transfer=!!(mask&256),c}var number=message.nextInt16(),i,name,mask,names,j,m;for(this.campaigns=[],i=0;i<number;i++)if(name=message.nextString(),mask=message.nextInt32()&2147483679,mask&2147483648)for(names=name.split("\t"),j=1;j<names.length;j++)name=names[j].slice(0,-1),m=names[j].slice(-1).charCodeAt(0)*2,this.campaigns.push(unpack({campaignName:name,serviceName:names[0],flags:m+(mask&~2147483648)}));else this.campaigns.push(unpack({campaignName:name.split("/")[1],serviceName:name.split("/")[0],flags:mask}));this.campaigns.sort(function(a,b){var aName=a.name.toUpperCase(),bName=b.name.toUpperCase();return aName<bName?-1:aName>bName?1:0})};this.AgentListReply=function(message){var number=message.nextInt16(),i,first,last;for(this.agents=[],i=0;i<number;i++)first=message.nextString(),last=message.nextString(),this.agents.push({firstName:first,lastName:last,name:first+" "+last,campaignName:message.nextString(),state:message.remainingBytes()>=4?message.nextInt32():0,time:message.remainingBytes()>=4?message.nextInt32():0});this.agents.sort(function(a,b){var aLF=(a.lastName+" "+a.firstName).toUpperCase(),bLF=(b.lastName+" "+b.firstName).toUpperCase();return aLF<bLF?-1:aLF>bLF?1:0})};this.CampaignQueueInfoReply=function(message){var number=message.nextInt16(),i;for(this.calls=0,this.avgTime=0,this.maxTime=0,this.campaigns=[],i=0;i<number;i++){var name=message.nextString(),calls=message.nextInt32(),maxTime=message.nextInt32(),avgTime=message.nextInt32();this.campaigns.push({name:name,calls:calls,avgTime:avgTime,maxTime:maxTime});this.calls+calls>0&&(this.avgTime=(this.avgTime*this.calls+avgTime*calls)/(this.calls+calls));maxTime>this.maxTime&&(this.maxTime=maxTime);this.calls+=calls}};this.SetCampaignStatusReply=function(){};this.AbortCallReply=function(message){this.callId=message.nextInt32();this.accepted=message.nextByte()};this.RetrieveCallReply=function(){};this.ReadyEvent=function(){};this.PauseEvent=function(message){message.remainingBytes()?(this.reasonId=message.nextInt32(),this.reasonText=message.nextString()):(this.reasonId=0,this.reasonText="")};this.AlertingEvent=function(message){this.callId=message.nextInt32()};this.AnsweredEvent=function(message){this.callId=message.nextInt32()};this.TerminatedEvent=function(message){this.callId=message.nextInt32();this.postCallWork=message.nextByte()};this.CallFailureEvent=function(message){this.callId=message.nextInt32();this.cause=message.nextByte();this.protocolTerminationCause=message.remainingBytes()>=4?message.nextInt32():0;this.protocolTerminationDescription=message.remainingBytes()>=2?message.nextString():"";this.detectedContentCode=message.remainingBytes()>=4?message.nextInt32():0;this.detectedContentDescription=message.remainingBytes()>=2?message.nextString():""};this.OtherCallEvent=function(message){this.callId=message.nextInt32()};this.PostCallWorkEvent=function(message){this.callId=message.nextInt32()};this.SupervisorMessageEvent=function(message){this.severity=message.nextInt16();this.message=message.nextString()};this.ReadyForTransferEvent=function(message){this.callId=message.nextInt32();this.campaignName=message.nextString();this.agentFirstName=message.nextString();this.agentLastName=message.nextString()};this.ReadyForDetachEvent=function(message){this.callId=message.nextInt32();this.callTerminated=message.remainingBytes()>=1?message.nextByte()!==0?!0:!1:undefined;this.protocolTerminationCause=message.remainingBytes()>=4?message.nextInt32():0;this.protocolTerminationDescription=message.remainingBytes()>=2?message.nextString():"";this.detectedContentCode=message.remainingBytes()>=4?message.nextInt32():0;this.detectedContentDescription=message.remainingBytes()>=2?message.nextString():""};this.BookedEvent=function(message){this.campaignName=message.nextString();this.mediatype=message.remainingBytes()>=4?message.nextInt32():0};this.AudioRecordingStartedEvent=function(message){this.callId=message.nextInt32();this.fileName=message.nextString()};this.AudioRecordingMutedEvent=function(message){this.callId=message.nextInt32();this.txChannelMuted=message.nextByte()!==0?!0:!1;this.rxChannelMuted=message.nextByte()!==0?!0:!1};this.AudioRecordingCompletedEvent=function(message){this.callId=message.nextInt32();this.result=message.nextInt32()};this.MaskedDigitReceivedEvent=function(message){this.callId=message.nextInt32()};this.MaskedPayloadReceivedEvent=function(message){this.callId=message.nextInt32();this.payload=message.nextString();this.result=message.nextInt32()};this.PhoneBarToPhonesMessages={LoginRequest:8192,LogoutRequest:8193,ReadyRequest:8194,PauseRequest:8195,NewCallRequest:8197,TransferCallRequest:8198,CampaignListRequest:8199,AgentListRequest:8200,CampaignQueueInfoRequest:8201,SetCampaignStatusRequest:8202,LoginExRequest:8204,AbortCallRequest:8206,RetrieveCallRequest:8207,AssignmentReply:16388,KeepAliveReply:16639,AgentPanicEvent:32779,SetAgentScriptStateEvent:34826,SetCallResultEvent:34827,AgentNewCallEvent:34829,RemoteOffHookEvent:34830,RemoteOnHookEvent:34831,RemoteRingingEvent:34832,RemoteManualHangUpEvent:34835,DelcoTunnelMessageEvent:34836};this.DelcoTunnelMessages={ConsultationCallControlRequest:9218,StartAudioRecordingRequest:9219,StopAudioRecordingRequest:9220,SetAudioRecordingMuteRequest:9221,AppendCueSheetEntryRequest:9222,StartDTMFMaskingRequest:9223,StopDTMFMaskingRequest:9224};this.LoginRequest=function(firstName,lastName,password,extension,flags){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.LoginRequest);return message.addString(firstName).addString(lastName).addString(password).addString(extension).addByte(flags||0).end(),message};this.LogoutRequest=function(){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.LogoutRequest);return message.end(),message};this.ReadyRequest=function(callId){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.ReadyRequest);return message.addInt32(callId!==undefined?callId:-1).end(),message};this.PauseRequest=function(reasonId){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.PauseRequest);return reasonId&&message.addByte(1).addInt32(reasonId),message.end(),message};this.PauseReasonsRequest=function(){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.PauseRequest);return message.addByte(3).addInt32(0).end(),message};this.NewCallRequest=function(phoneNumber,campaignName,callingNumber){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.NewCallRequest);return message.addString(phoneNumber).addString(campaignName).addString(callingNumber).end(),message};this.TransferCallRequest=function(callId,mode,campaignName,callDataStr,firstName,lastName,mandatory){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.TransferCallRequest);return message.addInt32(callId).addInt32(mode).addString(campaignName).addString(callDataStr).addString(firstName).addString(lastName).addByte(mandatory?1:0).end(),message};this.CampaignListRequest=function(mask,callId,mediatype){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.CampaignListRequest);return message.addInt32(mask|2147483648).addInt32(mediatype).addInt32(callId).end(),message};this.AgentListRequest=function(campaignName,mask){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AgentListRequest);return message.addString(campaignName).addInt32(mask).end(),message};this.CampaignQueueInfoRequest=function(campaignName){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.CampaignQueueInfoRequest);return message.addString(campaignName).addInt32(campaignName?0:2).end(),message};this.SetCampaignStatusRequest=function(){};this.LoginExRequest=function(firstName,lastName,oldPassword,newPassword,extension,flags){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.LoginExRequest);return message.addString(firstName).addString(lastName).addString(oldPassword).addString(newPassword).addString(extension).addByte(flags||0).end(),message};this.AbortCallRequest=function(callId){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AbortCallRequest);return message.addInt32(callId).end(),message};this.RetrieveCallRequest=function(){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.RetrieveCallRequest);return message.addInt32(callId).end(),message};this.AssignmentReply=function(callId,accept){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AssignmentReply);return message.addInt32(callId).addByte(accept).end(),message};this.KeepAliveReply=function(){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.KeepAliveReply);return message.end(),message};this.AgentPanicEvent=function(){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AgentPanicEvent);return message.addByte(1).end(),message};this.SetAgentScriptStateEvent=function(callId,scriptState){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.SetAgentScriptStateEvent);return message.addInt32(callId).addString((scriptState||0)+255).end(),message};this.SetCallResultEvent=function(callId,callDataStr){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.SetCallResultEvent);return message.addInt32(callId).addString(callDataStr).end(),message};this.AgentNewCallEvent=function(){};this.RemoteOffHookEvent=function(){};this.RemoteOnHookEvent=function(){};this.RemoteRingingEvent=function(){};this.RemoteManualHangUpEvent=function(){};this.ConsultationCallControlRequest=function(callId,action){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(12).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.ConsultationCallControlRequest).addByte(1).addByte(1).addInt32(4).addInt32(action).end(),message};this.StartAudioRecordingRequest=function(callId,fileName,settings){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(19+fileName.length*2).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StartAudioRecordingRequest).addByte(1).addByte(1).addInt32(2+fileName.length*2).addUniString(fileName).addByte(1).addInt32(4).addInt32(settings).end(),message};this.StopAudioRecordingRequest=function(callId){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(3).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StopAudioRecordingRequest).addByte(1).end(),message};this.SetAudioRecordingMuteRequest=function(callId,muteTxChannel,muteRxChannel,appendCueSheetEntry,cueSheetEntry){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(37+cueSheetEntry.length*2).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.SetAudioRecordingMuteRequest).addByte(1).addByte(1).addInt32(4).addBool32(muteTxChannel).addByte(1).addInt32(4).addBool32(muteRxChannel).addByte(1).addInt32(4).addBool32(appendCueSheetEntry).addByte(1).addInt32(2+cueSheetEntry.length*2).addUniString(cueSheetEntry).end(),message};this.AppendCueSheetEntryRequest=function(callId,cueSheetEntry){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(10+cueSheetEntry.length*2).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.AppendCueSheetEntryRequest).addByte(1).addByte(1).addInt32(2+cueSheetEntry.length*2).addUniString(cueSheetEntry).end(),message};this.StartDTMFMaskingRequest=function(callId,numberOfDigits,terminationDigit){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(18).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StartDTMFMaskingRequest).addByte(1).addByte(1).addInt32(4).addInt32(numberOfDigits).addByte(1).addInt32(1).addByte(terminationDigit).end(),message};this.StopDTMFMaskingRequest=function(callId){var message=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return message.addInt32(callId).addInt32(3).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StopDTMFMaskingRequest).addByte(1).end(),message}}.call(Ifm.PhoneBar.Messages),function(){function Phone(phonebar){if(!(this instanceof Phone))throw Ifm.Diagnostics.Errors.ctor();this.phonebar=phonebar;this._isConnected=!1;this._isMuted=!1;this._isRegistered=undefined;this._lineStates=[];for(var i=0;i<this.numberOfLines;i++)this._lineStates.push(Phone.States.Idle);this._selectedLineId=0;this._isInConference=!1;this._accessToken=""}function q(args_selectors){return args_selectors=Array.prototype.slice.call(arguments),jQuery(args_selectors.join(","))}var ns=namespace("Ifm.PhoneBar.Media");Phone.events=defineEvents("initialized","connected","disconnected","registeredstatechanged","linestatechanged","conferencestatechanged","lineselected","calling","callconnected","calldisconnected","displayname","incomingcall","ringing","mutechanged","vumeter");Phone.States={Idle:"[Idle]",Incoming:"[Incoming]",Calling:"[Calling]",Talking:"[Talking]"};Phone.prototype.numberOfLines=1;Phone.prototype.supportsConference=!1;Object.defineProperties(Phone.prototype,{isConnected:{get:function(){return this._isConnected}},isInConference:{get:function(){return this._isInConference}},isMuted:{get:function(){return this._isMuted}},isRegistered:{get:function(){return this._isRegistered}},selectedLineId:{get:function(){return this._selectedLineId}},state:{get:function(){return this._lineStates[this._selectedLineId]}}});Phone.prototype.initialize=function(settings){this.phonebar.log(THIS,DEBUG,"Initializing");this._settings=settings||{};const self=this;return new Promise(function(resolve){Phone.events.initialized.addHandler(resolve,null,!0);self._initializeElements();self._enableAllElements(!1);self._initialize()})};Phone.prototype.connect=function(){this.phonebar.log(THIS,DEBUG,"Connecting");this._connect()};Phone.prototype.disconnect=function(){this.phonebar.log(THIS,DEBUG,"Disconnecting");this._disconnect()};Phone.prototype.setAccessToken=function(token){this.phonebar.log(THIS,DEBUG,"Setting Access Token");this._accessToken=token;this._isConnected&&this._setAccessToken(token)};Phone.prototype.terminate=function(){this.phonebar.log(THIS,DEBUG,"Terminating");this._terminate()};Phone.prototype.answer=function(){this.phonebar.log(THIS,DEBUG,"Answering");this._answer()};Phone.prototype.canConference=function(){if(!this.supportsConference)return!1;for(var i=0,count=0;i<this.numberOfLines;i++)this._lineStates[i]===Phone.States.Talking&&count++;return count>1};Phone.prototype.dial=function(number){if(!number&&number!==0){this.phonebar.log(THIS,WARN,"No number to dial");return}if(this.state===Phone.States.Ringing){this.phonebar.log(THIS,WARN,"Can't dial in current state");return}this.phonebar.log(THIS,DEBUG,"Dialing number",number);this.state===Phone.States.Idle?this._dial(number):this._dtmf(number)};Phone.prototype.dtmf=function(tones){if(!tones&&tones!==0){this.phonebar.log(THIS,WARN,"No dtmf to dial");return}if(this.state===Phone.States.Idle||this.state===Phone.States.Ringing){this.phonebar.log(THIS,WARN,"Can't dial in current state");return}this.phonebar.log(THIS,DEBUG,"Dialing tones",tones);this._dtmf(tones)};Phone.prototype.drop=function(){this.phonebar.log(THIS,DEBUG,"Dropping");this._drop()};Phone.prototype.enterConference=function(){if(!this.supportsConference){this.phonebar.log(THIS,WARN,"Device doesn't support conference");return}this.phonebar.log(THIS,DEBUG,"Entering conference");this._enterConference()};Phone.prototype.getLineState=function(lineId){if(!(lineId>=0&&lineId<this.numberOfLines)){this.phonebar.log(THIS,WARN,"Invalid lineId specified:",lineId);return}return this._lineStates[lineId]};Phone.prototype.leaveConference=function(){if(!this.supportsConference){this.phonebar.log(THIS,WARN,"Device doesn't support conference");return}this.phonebar.log(THIS,DEBUG,"Leaving conference");this._leaveConference()};Phone.prototype.mute=function(){this.phonebar.log(THIS,DEBUG,"Muting microphone");this._mute()};Phone.prototype.register=function(){var domain=this.domain,extension=this.phonebar.agent.extension;this.phonebar.log(THIS,DEBUG,"Registering device to",domain,extension);this._register(domain,extension)};Phone.prototype.selectLine=function(lineId){if(this.numberOfLines<2){this.phonebar.log(THIS,WARN,"Device doesn't support multiple lines");return}this.phonebar.log(THIS,DEBUG,"Selecting line",lineId);this._selectLine(lineId)};Phone.prototype.unmute=function(){this.phonebar.log(THIS,DEBUG,"Unmuting microphone");this._unmute()};Phone.prototype.unregister=function(){this.phonebar.log(THIS,DEBUG,"Unregistering device");this._unregister()};Phone.prototype._initialize=function(){};Phone.prototype._connect=function(){};Phone.prototype._disconnect=function(){};Phone.prototype._setAccessToken=function(){};Phone.prototype._terminate=function(){};Phone.prototype._answer=function(){};Phone.prototype._dial=function(){};Phone.prototype._dtmf=function(){};Phone.prototype._drop=function(){};Phone.prototype._enterConference=function(){};Phone.prototype._leaveConference=function(){};Phone.prototype._mute=function(){};Phone.prototype._register=function(){};Phone.prototype._selectLine=function(){};Phone.prototype._unmute=function(){};Phone.prototype._unregister=function(){};Phone.prototype._onInitialized=function(){this.phonebar.log(THIS,DEBUG,"Initialized");Phone.events.initialized.raise(this,{})};Phone.prototype._onConnected=function(){this.phonebar.log(THIS,DEBUG,"Connected");this._isConnected=!0;this._enableAllElements(!0);var E=Ifm.PhoneBar.UI.Elements;q(E.PhoneStateText).html("").removeClass("blink");Phone.events.connected.raise(this,{});this._accessToken&&this.setAccessToken(this._accessToken)};Phone.prototype._onDisconnected=function(clean){var E,S,self;this.phonebar.log(THIS,DEBUG,"Disconnected");this._isConnected=!1;this._enableAllElements(!1);Phone.events.disconnected.raise(this,{clean:clean});this.phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn&&(E=Ifm.PhoneBar.UI.Elements,S=Ifm.PhoneBar.Strings[this.phonebar.language()],q(E.PhoneStateText).html(S.PhoneNotConnected).addClass("blink"),self=this,setTimeout(function(){self._isConnected||self.phonebar.currentState()===Ifm.PhoneBar.States.NotLoggedIn||self.connect()},1e4))};Phone.prototype._onRegisteredStateChanged=function(isRegistered){var E,S,self;this.phonebar.log(THIS,INFO,"Device",isRegistered?"is":"is not","registered");this._isRegistered=isRegistered;E=Ifm.PhoneBar.UI.Elements;S=Ifm.PhoneBar.Strings[this.phonebar.language()];isRegistered?q(E.PhoneStateText).html("").removeClass("blink"):this._isConnected&&(self=this,setTimeout(function(){self._isConnected&&!self._isRegistered&&self.phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn&&(self.register(),setTimeout(function(){self._isConnected&&!self._isRegistered&&self.phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn&&q(E.PhoneStateText).html(S.PhoneNotRegistered).addClass("blink")},5e3))},5e3));Phone.events.registeredstatechanged.raise(this,{isRegistered:isRegistered})};Phone.prototype._onLineStateChanged=function(lineId,state){this.phonebar.log(THIS,INFO,"Line",lineId+1,"in state",state);this._lineStates[lineId]=state;this._updateLineSelectors(lineId,!1,!0);lineId===this._selectedLineId&&this._updateCurrentLineControls();Phone.events.linestatechanged.raise(this,{lineId:lineId,state:state})};Phone.prototype._onConferenceStateChanged=function(inConference){this.phonebar.log(THIS,DEBUG,"Lines are",inConference?"":"not","in conference");this._isInConference=inConference;this._updateConferenceButtons(inConference);this._updateCurrentLineControls();Phone.events.conferencestatechanged.raise(this,{inConference:inConference})};Phone.prototype._onLineSelected=function(lineId){this.phonebar.log(THIS,DEBUG,"Line",lineId+1,"selected");this._selectedLineId=lineId;this._updateLineSelectors(lineId,!0,!1);Phone.events.lineselected.raise(this,{lineId:lineId})};Phone.prototype._onCalling=function(lineId){this.phonebar.log(THIS,DEBUG,"Calling on line",lineId+1);Phone.events.calling.raise(this,{lineId:lineId})};Phone.prototype._onCallConnected=function(lineId){this.phonebar.log(THIS,DEBUG,"Call connected on line",lineId+1);Phone.events.callconnected.raise(this,{lineId:lineId})};Phone.prototype._onCallDisconnected=function(lineId,sipCode,sipCause){this.phonebar.log(THIS,DEBUG,"Call disconnected on line",lineId+1,"; sip code:",sipCode,"sip cause:",sipCause);Phone.events.calldisconnected.raise(this,{lineId:lineId,sipCode:sipCode,sipCause:sipCause})};Phone.prototype._onDisplayName=function(lineId,displayName){var call=this._getAudioCall();lineId===0&&call&&call.hideNumber&&(displayName=call.displayNumber);this.phonebar.log(THIS,DEBUG,"Got display name",displayName,"for incoming call on line",lineId+1);Phone.events.displayname.raise(this,{lineId:lineId,displayName:displayName})};Phone.prototype._onIncomingCall=function(lineId){this.phonebar.log(THIS,DEBUG,"Incoming call on line",lineId+1);Phone.events.incomingcall.raise(this,{lineId:lineId})};Phone.prototype._onRinging=function(lineId,rings){if(this.phonebar.log(THIS,DEBUG,"Line",lineId+1,"is ringing;",rings,"ring(s)"),Phone.events.ringing.raise(this,{lineId:lineId,rings:rings}),this.phonebar.options.autoAnswerPhone()){var callType=0,call=this._getAudioCall();callType=call===null?3:call.callId<32768?2:1;callType<=this.phonebar.options.autoAnswerPhone()&&rings>=this.phonebar.options.autoAnswerRings()&&(this.phonebar.log(THIS,DEBUG,"Attempting autoanswer on line",lineId),this._answer())}};Phone.prototype._onMuteChanged=function(isMuted){this.phonebar.log(THIS,DEBUG,"Microphone is",isMuted?"":"not","muted");this._isMuted=isMuted;this._updateMicMuteButtons(isMuted);Phone.events.mutechanged.raise(this,{isMuted:isMuted})};Phone.prototype._onVUMeter=function(microphone,speakers){var E=Ifm.PhoneBar.UI.Elements;q(E.MicrophoneVUMeter).val(microphone);q(E.SpeakersVUMeter).val(speakers);Phone.events.vumeter.raise(this,{microphone:microphone,speakers:speakers})};Phone.prototype._getAudioCall=function(){return this.phonebar.calls(function(call){return call.mediatype===Ifm.PhoneBar.Mediatypes.Voice})[0]||null};Phone.prototype._initializeElements=function(){var self=this,E=Ifm.PhoneBar.UI.Elements;q('[class^="phonebar-phone"]').show();q(E.PhoneDialPad,E.HideDialPadButton).hide();q(E.ShowDialPadButton,E.ToggleDialPadButton).disable();q(E.NumberInput).on("change input",function(){self._updateCurrentLineFlashControls()});if(this.numberOfLines===1)q(E.Line1Button,E.Line2Button).remove();else if(this.numberOfLines!==2)throw Error("Unsupported number of lines specified: "+this.numberOfLines);(this.numberOfLines<2||!this.supportsConference)&&q(E.EnterConferenceButton,E.LeaveConferenceButton).remove()};Phone.prototype._enableAllElements=function(connected){var E=Ifm.PhoneBar.UI.Elements;q(E.MicrophoneOnButton,E.MicrophoneOffButton,E.Line1Button,E.Line2Button).enabled(connected);q(E.MicrophoneOnButton).hide().enabled(connected);connected?(q(E.ShowDialPadButton,E.ToggleDialPadButton).enable(),this._updateCurrentLineControls()):(q(E.PickupButton,E.LeaveConferenceButton).hide().disable(),q(E.HangupButton,E.FlashButton,E.ManualTransferButton,E.EnterConferenceButton).disable(),q(E.Line1Button,E.Line2Button).removeClass("selected"),q(E.PhoneDialPad,E.HideDialPadButton).hide(),q(E.HideDialPadButton,E.ShowDialPadButton,E.ToggleDialPadButton).disable(),q('[class^="phonebar-phone-key"]').disable())};Phone.prototype._updateCurrentLineControls=function(){var E=Ifm.PhoneBar.UI.Elements;switch(this.state){case Phone.States.Incoming:q(E.HangupButton).hide().disable();q(E.PickupButton).show().enable();break;case Phone.States.Calling:case Phone.States.Talking:q(E.PickupButton).hide().disable();q(E.HangupButton).show().enable();break;default:q(E.PickupButton).hide().disable();q(E.HangupButton).show().disable()}this._updateCurrentLineFlashControls()};Phone.prototype._updateCurrentLineFlashControls=function(){var E=Ifm.PhoneBar.UI.Elements;this.state===Phone.States.Talking?(q('[class^="phonebar-phone-key"]').enable(),q(E.FlashButton).enabled(!this._isInConference),q(E.ManualTransferButton).enabled(!this._isInConference&&q(E.NumberInput).val())):q('[class^="phonebar-phone-key"]',E.FlashButton,E.ManualTransferButton).disable();this.phonebar.currentState()===Ifm.PhoneBar.States.WaitingOutbound&&this._selectedLineId===0?q(E.CallButton).enabled(!1):this._selectedLineId>0?q(E.CallButton).enabled(this.state===Phone.States.Idle&&q(E.NumberInput).val()):this.updateCallButton()};Phone.prototype._updateLineSelectors=function(lineId,updateSelection,updateState){var E=Ifm.PhoneBar.UI.Elements,t1=lineId===0?E.Line1Button:E.Line2Button,t2=lineId===1?E.Line1Button:E.Line2Button;if(updateSelection&&(q(t2).removeClass("selected"),q(t1).addClass("selected")),updateState){switch(this._lineStates[lineId]){case Phone.States.Idle:q(t1).removeClass("highlight blink");break;case Phone.States.Talking:q(t1).addClass("highlight").removeClass("blink");break;default:q(t1).addClass("highlight blink")}this.supportsConference&&q(E.EnterConferenceButton).enabled(this.canConference())}lineId===this._selectedLineId&&this._updateCurrentLineControls()};Phone.prototype._updateConferenceButtons=function(inConference){var E=Ifm.PhoneBar.UI.Elements;inConference?(q(E.EnterConferenceButton).hide().disable(),q(E.LeaveConferenceButton).show().enable()):(q(E.LeaveConferenceButton).hide().disable(),q(E.EnterConferenceButton).show().disable(),this.supportsConference&&this.canConference()&&q(E.EnterConferenceButton).enable())};Phone.prototype._updateMicMuteButtons=function(isMuted){var E=Ifm.PhoneBar.UI.Elements,t1=isMuted?E.MicrophoneOffButton:E.MicrophoneOnButton,t2=isMuted?E.MicrophoneOnButton:E.MicrophoneOffButton;q(t1).hide();q(t2).show()};Phone.prototype._updateVUMeterElements=function(microphone,speakers){var E=Ifm.PhoneBar.UI.Elements;q(E.MicrophoneVUMeter).val(microphone);q(E.SpeakersVUMeter).val(speakers)};var THIS="PhoneBar.Media.Phone",DEBUG="Debug",INFO="Info",WARN="Warn";ns.Phone=Phone}();namespace("Ifm.PhoneBar.Strings",{en:{UnloadPageConfirm:"If you leave the page, you close any conversation open and you won't be able to receive new calls!",NoBrowserSupport:"Your browser does not have the features needed to run the PhoneBar",Loading:"Loading",AccountLockedOut:"Your logon has been locked out. Contact the administrator",CantChangePassword:"You're not authorized to change your password",InvalidNewPassword:"The new password doesn't meet security requirements",PasswordExpired:"Your password has expired, change it to log in",PasswordsDontMatch:"The new passwords don't match",UserOrExtensionTaken:"Logon credentials or extension already taken",WrongCredentials:"Invalid logon credentials",InvalidExtension:"Invalid extension",ExtensionInUse:"Extension already taken",TokenBasedLoginError:"Error occourred with domain authentication",NotLoggedInState:"Not available",ConnectingState:"Connecting",LoggedInState:"Available",PausedState:"Paused",ReadyState:"Available",TalkingState:"Talking",PostCallState:"In post-call",OtherCallState:"In manual conversation",AssignedState:"Assigned",AlertingState:"Incoming call",WaitingOutboundState:"Dialing call",WaitingTransferState:"Transferring",PhoneNotConnected:"Phone not connected!",PhoneNotRegistered:"Phone not reachable!",ConnectionFailed:"Connection failed",ConnectionLost:"Connection lost",AssignmentBooked:"Booked",PauseBooked:"Pause booked",RequestRefused:"Request refused",CallFailure:"Call failure",GenericBusyState:"Busy",CallFailureNoDialTone:"no dial tone",CallFailureNoRingback:"no ringback",CallFailureLineBusy:"number busy",CallFailureNoAnswer:"no answer",CallFailureFaxTone:"fax",CallFailureRemoteHangUp:"hangup",CallFailureAgentNoDialTone:"no dial tone by the agent",CallFailureAgentNoRingback:"no ringback by the agent",CallFailureAgentBusy:"agent busy",CallFailureAgentNoAnswer:"no answer by the agent",CallFailureUnknown:"unknown cause",OutboundManualCall:"Manual call",PauseGenericReason:"Generic pause",TooltipLogin:"Log in",TooltipLoginOrReady:"Ready",TooltipReady:"Ready",TooltipPause:"Pause",TooltipLogout:"Log out",TooltipCall:"Call",TooltipTransfer:"Transfer window",TooltipQueueInfo:"Display queue info",TooltipCampaignList:"Display assigned campaigns",TooltipPanic:"HELP ME!",TooltipMainMenu:"Menu",TooltipPhoneNumber:"Phone number",TooltipStartRec:"Start recording",TooltipStopRec:"Stop recording",TooltipMuteRec:"Suspend recording",TooltipUnmuteRec:"Resume recording",TooltipHangup:"Hang up",TooltipPickup:"Pick up",TooltipFlash:"Hold and retrieve",TooltipManualTransfer:"Manual transfer",TooltipMicVUMeter:"Microphone",TooltipSpkVUMeter:"Speakers",TooltipMicOff:"Turn microphone OFF",TooltipMicOn:"Turn microphone ON",TooltipLine1:"Line 1",TooltipLine2:"Line 2",TooltipEnterConf:"Join conference",TooltipLeaveConf:"Leave conference",MenuItemAbout:"About PhoneBar",MenuItemCampaigns:"Assigned Campaigns",MenuItemDialpad:"Dialpad",MenuItemExit:"Exit",MenuItemPanic:"Request Assistance",MenuItemQueueInfo:"Queue State",MenuItemAutoHide:"Auto Hide",MenuItemDevTools:"Activate Debugger",MenuItemOptions:"Options",MenuItemRefresh:"Refresh",MenuItemReload:"Reload (no cache)",MenuItemReset:"Reset",MenuItemShowLogs:"Show Logs",ButtonOK:"OK",ButtonCancel:"Cancel",ButtonChangePassword:"Change Password...",ButtonRefresh:"Refresh",ButtonRetry:"Retry",ButtonTransfer:"Trasferisci",AssignmentsTitle:"Assigned Campaigns",IncomingCallText:"INCOMING CALL!",UnknownCallingNumber:"Unknown Number",QueueInfoTitle:"Queue Info",queuedAvgTimeText:"avg T",queuedMaxTimeText:"max T",queuedNumberText:"queued",LoginTitle:"Enter your credentials",LoginOAuth2Title:"Domain Authentication",LoginFirstName:"First name:",LoginLastName:"Last name:",LoginUsername:"Username:",LoginPassword:"Password:",LoginOldPassword:"Current password:",LoginNewPassword:"New password:",LoginConfirmPassword:"Confirm password:",LoginExtension:"Extension:",SupervisorTitle:"Supervisor Message",TransferTitle:"Call transfer",TransferCampaign:"Campaign:",TransferService:"Service:",TransferAnybody:"(Anybody)",TransferMandatory:"Transfer to the selected agent only",DialpadTitle:"Dialpad",OptionsTitle:"Options & Preferences"}});namespace("Ifm.PhoneBar.Strings",{it:{UnloadPageConfirm:"Se chiudi questa pagina, le conversazioni attive saranno perdute e non potrai ricevere nuove chiamate!",NoBrowserSupport:"Questo browser non ha le funzioni necessarie per la PhoneBar",Loading:"Caricamento",AccountLockedOut:"Il tuo accesso è stato sospeso. Contatta l'amministratore",CantChangePassword:"Non sei autorizzato a modificare la tua password",InvalidNewPassword:"La nuova password non soddisfa i criteri di sicurezza",PasswordExpired:"La tua password è scaduta, cambiala per accedere",PasswordsDontMatch:"Le nuove password non corrispondono",UserOrExtensionTaken:"Credenziali di accesso o interno già in uso",WrongCredentials:"Credenziali di accesso non valide",InvalidExtension:"Interno non valido",ExtensionInUse:"Interno già in uso",TokenBasedLoginError:"Si è verificato un errore con l'autenticazione di dominio",NotLoggedInState:"Non disponibile",ConnectingState:"Connessione in corso",LoggedInState:"Disponibile",PausedState:"In pausa",ReadyState:"Disponibile",TalkingState:"In conversazione",PostCallState:"In post-chiamata",OtherCallState:"In conversazione manuale",AssignedState:"In assegnazione",AlertingState:"Chiamata in arrivo",WaitingOutboundState:"In generazione chiamata",WaitingTransferState:"In trasferimento",PhoneNotConnected:"Telefono non collegato!",PhoneNotRegistered:"Telefono non raggiungibile!",ConnectionFailed:"Connessione fallita",ConnectionLost:"Caduta connessione",AssignmentBooked:"In pre-assegnazione",PauseBooked:"Pausa prenotata",RequestRefused:"Richiesta rifiutata",CallFailure:"Chiamata fallita",GenericBusyState:"Impegnato/a",CallFailureNoDialTone:"nessun tono di chiamata",CallFailureNoRingback:"nessuno squillo",CallFailureLineBusy:"numero occupato",CallFailureNoAnswer:"nessuna risposta",CallFailureFaxTone:"fax",CallFailureRemoteHangUp:"riaggancio",CallFailureAgentNoDialTone:"nessun tono di chiamata sull'operatore",CallFailureAgentNoRingback:"nessuno squillo sull'operatore",CallFailureAgentBusy:"operatore occupato",CallFailureAgentNoAnswer:"nessuna risposta da operatore",CallFailureUnknown:"causa sconosciuta",OutboundManualCall:"Chiamata manuale",PauseGenericReason:"Pausa generica",TooltipLogin:"Accesso",TooltipLoginOrReady:"Disponibile",TooltipReady:"Disponibile",TooltipPause:"Pause",TooltipLogout:"Logout",TooltipCall:"Chiama",TooltipTransfer:"Finestra di trasferimento",TooltipQueueInfo:"Mostra stato code",TooltipCampaignList:"Mostra campagne assegnate",TooltipPanic:"AIUTO!",TooltipMainMenu:"Menu",TooltipPhoneNumber:"Numero di telefono",TooltipStartRec:"Avvia registrazione",TooltipStopRec:"Ferma registrazione",TooltipMuteRec:"Sospendi registrazione",TooltipUnmuteRec:"Riprendi registrazione",TooltipHangup:"Aggancia",TooltipPickup:"Rispondi",TooltipFlash:"In attesa e riprendi",TooltipManualTransfer:"Trasferimento manuale",TooltipMicVUMeter:"Microfono",TooltipSpkVUMeter:"Cuffie",TooltipMicOff:"DISATTIVA microfono",TooltipMicOn:"ATTIVA microfono",TooltipLine1:"Linea 1",TooltipLine2:"Linea 2",TooltipEnterConf:"Avvia conferenza",TooltipLeaveConf:"Chiudi conferenza",MenuItemAbout:"Info su PhoneBar",MenuItemCampaigns:"Campagne Assegnate",MenuItemDialpad:"Tastiera Virtuale",MenuItemExit:"Esci",MenuItemPanic:"Richiedi Assistenza",MenuItemQueueInfo:"Stato Code",MenuItemAutoHide:"Nascondi Automaticamente",MenuItemDevTools:"Attiva Debugger",MenuItemOptions:"Opzioni",MenuItemRefresh:"Ricarica",MenuItemReload:"Ricarica (no cache)",MenuItemReset:"Reimposta",MenuItemShowLogs:"Mostra Logs",ButtonOK:"OK",ButtonCancel:"Annulla",ButtonChangePassword:"Cambia Password...",ButtonRefresh:"Aggiorna",ButtonRetry:"Riprova",ButtonTransfer:"Trasferisci",AssignmentsTitle:"Assegnazioni",IncomingCallText:"CHIAMATA IN ARRIVO!",UnknownCallingNumber:"Numero Sconosciuto",QueueInfoTitle:"Stato Code",queuedAvgTimeText:"T medio",queuedMaxTimeText:"T max",queuedNumberText:"in coda",LoginTitle:"Inserisci le tue credenziali",LoginOAuth2Title:"Autenticazione di dominio",LoginFirstName:"Nome:",LoginLastName:"Cognome:",LoginUsername:"Username:",LoginPassword:"Password:",LoginOldPassword:"Password attuale:",LoginNewPassword:"Nuova password:",LoginConfirmPassword:"Conferma password:",LoginExtension:"Interno:",SupervisorTitle:"Messaggio del Supervisore",TransferTitle:"Trasferimento di chiamata",TransferCampaign:"Campagna:",TransferService:"Servizio:",TransferAnybody:"(Chiunque)",TransferMandatory:"Trasferisci solo all'agente selezionato",DialpadTitle:"Tastiera Virtuale",OptionsTitle:"Opzioni & Preferenze"}});