
//============================================================================

// Copyright (c) IFM Infomaster. All rights reserved.

//============================================================================

"use strict";function defineEvents(){for(var t,i={},n=0;n<arguments.length;n++){if(t=arguments[n],!Ifm.Type.isString(t))throw Ifm.Diagnostics.Errors.arg("name");createEventAccessors(i,t)}return i}function createEventAccessors(n,t){var i=new Ifm.Event;Object.defineProperty(n,t,{get:function(){return i},set:function(n){i.addHandler(n)}})}function inherits(n,t){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("ctorClass");if(!Ifm.Type.isFunction(t))throw Ifm.Diagnostics.Errors.func("ctorBase");return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,t.prototype}function namespace(n,t){for(var r,f,i=window,e=n.split("."),u=0;u<e.length;u++)r=e[u],i[r]=i[r]||{},i=i[r];if(typeof t==typeof namespace)t.call(i);else for(f in t)i[f]=t[f];return i}function query(n){var i=n||window.location.search,t={};return i.replace(/[?&#]([^=]+)=([^&]*)?/g,function(n,i,r){return i&&(t[i]=r||""),""}),t}var global=global||window,T0,dT;if(Object.defineProperty?Object.defineProperty(global,"T0",{value:+new Date}):T0=+new Date,dT=function(){return new Date-T0},Function.getName=function(n){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("func");var t=/function\s+(\w+)/.exec(n);return t&&t.length===2?t[1]:(t=/(\w+)\s*=\s*function/.exec(n),t&&t.length===2)?t[1]:"anonymous function"},Function.prototype.toShortString=function(){var n=this.toString().replace(/[\r|\n]/g,"").replace(/[\s]+/g," ");return n.substr(0,n.indexOf("{")).trim()},Array.pushArray=function(n,t){if(!Ifm.Type.isArray(n))throw Ifm.Diagnostics.Errors.arg("array1");if(!Ifm.Type.isArray(t))throw Ifm.Diagnostics.Errors.arg("array2");return Array.prototype.push.apply(n,t)},!Array.prototype.find)try{Object.defineProperty(Array.prototype,"find",{enumerable:!1,value:function(n,t){if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("func");for(var i=0,r=this.length;i<r;i++)if(i in this&&n.call(t,this[i],i,this))return this[i];return undefined}})}catch(e){}window.ArrayBuffer&&(ArrayBuffer.fromBytes=function(n){for(var i=n.length,r=new ArrayBuffer(i),u=new Uint8Array(r),t=0;t<i;t++)u[t]=n[t];return r},ArrayBuffer.prototype.getBytes=function(){for(var t=new Uint8Array(this),i=[],n=0,r=t.length;n<r;n++)i.push(t[n]);return i});Object.entries||(Object.entries=function(n){var i=[];for(var t in n)n.hasOwnProperty(t)&&i.push([t,n[t]]);return i});Object.keys||(Object.keys=function(n){var t=[];for(var i in n)n.hasOwnProperty(i)&&t.push(i);return t});Object.values||(Object.values=function(n){var t=[];for(var i in n)n.hasOwnProperty(i)&&t.push(n[i]);return t});String.format=function(n){if(!n||!Ifm.Type.isString(n))return n;var t=Array.prototype.slice.call(arguments,1);return n.replace(/{(\d+)}/g,function(n,i){return typeof t[i]!="undefined"?t[i]:""})};String.prototype.format=function(){var n=[this];return Array.prototype.push.apply(n,arguments),String.format.apply(null,n)};String.prototype.startsWith||(String.prototype.startsWith=function(n,t){return t=t||0,this.substr(t,n.length)===n});String.prototype.endsWith||(String.prototype.endsWith=function(n,t){t=t||this.length;var i=Math.max(t-n.length,0);return this.slice(i,t)===n});String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")});String.prototype.indexAfter=function(n){var t=this.indexOf(n);return t+(t<0?0:n.length)};String.prototype.lastIndexAfter=function(n){var t=this.lastIndexOf(n);return t+(t<0?0:n.length)};Date.now||(Date.now=function(){return+new Date});Date.prototype.toISOString||function(){function n(n){var t=String(n);return t.length===1&&(t="0"+t),t}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+n(this.getUTCMonth()+1)+"-"+n(this.getUTCDate())+"T"+n(this.getUTCHours())+":"+n(this.getUTCMinutes())+":"+n(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}();Date.prototype.toISOLocaleDateString||(Date.prototype.toISOLocaleDateString=function(){var i=""+this.getFullYear(),n=""+(this.getMonth()+1),t=""+this.getDate();return n.length<2&&(n="0"+n),t.length<2&&(t="0"+t),i+"-"+n+"-"+t});namespace("Ifm",function(){Ifm.version="Ifm.js/1.0.91-3984";this.Objects={deepMerge:function n(t,i,r){for(var u in i)typeof i[u]=="object"?(i[u]===null?r!==!0&&(t[u]=null):(typeof t[u]!="object"||t[u]===null)&&(t[u]={}),n(t[u],i[u],r)):(i[u]!==undefined||r!==!0)&&(t[u]=i[u]);return t}};this.Enum={};this.Enum.getName=function(n,t){for(var r,u=Object.getOwnPropertyNames(n),i=0,f=u.length;i<f;i++)if(r=u[i],n[r]===t)return r;return""};this.Enum.getLength=function(n){return Object.getOwnPropertyNames(n).length};this.Type={};this.Type.getTypeName=function(n){var i=Object.prototype.toString.call(n).slice(8,-1),t;return i==="Object"&&(t=n&&n.constructor&&n.constructor.toString().match(/function\s+([^\s]{1,})\s*\(/),t)?t[1]:i};this.Type.isArray=function(n){return Object.prototype.toString.call(n)==="[object Array]"};this.Type.isLikeArray=function(n){return typeof n=="object"&&!Ifm.Type.isString(n)&&typeof n.length=="number"&&!n.propertyIsEnumerable("length")};this.Type.isFunction=function(n){return typeof n=="function"};this.Type.isNumber=function(n){return typeof n=="number"};this.Type.isString=function(n){return typeof n=="string"||n instanceof String};this.Event=function(){if(!(this instanceof Ifm.Event))throw Ifm.Diagnostics.Errors.ctor();var n=[];return{constructor:Ifm.Event,addHandler:function(t,i){Ifm.Type.isFunction(t)&&n.push({f:t,o:i||null})},hasHandlers:function(){return n.length>0},removeAllHandlers:function(){n.length=0},removeHandler:function(t){for(var i=n.length;i--;)n[i].f===t&&n.splice(i,1)},raise:function(){for(var i=n.length,t;i--;)t=n[i],t.f.apply(t.o,arguments)}}}});namespace("Ifm.Diagnostics",function(){this.Debug={};this.Debug.onprint=new Ifm.Event;this.Debug.enabled=!1;this.Debug.popupAssertions=!1;this.Debug.assert=function(n,t){if(Ifm.Diagnostics.Debug.enabled){if(Ifm.Type.isString(n)){try{var i=new Function("return "+n);Ifm.Diagnostics.Debug.assert(i(),n+" "+t)}catch(r){Ifm.Diagnostics.Debug.fail("Invalid assert condition '"+n+"' : "+r.message)}return}n||Ifm.Diagnostics.Debug.fail(t)}};this.Debug.fail=function n(t){if(Ifm.Diagnostics.Debug.enabled){var i=arguments[1],u=arguments[2]||n;if(!i)try{throw new Error("Assertion failed");}catch(r){i=r.stack||"[Callstack not available]"}window.console&&console.error&&console.error(t,i);Ifm.Diagnostics.Debug.popupAssertions&&alert(t+"\n\n----Stack----\n\n"+i)}};this.Debug.clear=function(){if(Ifm.Diagnostics.Debug.enabled){window.console&&console.clear&&console.clear();var n=document.getElementById("consoleview");n&&(n.innerHTML="")}};this.Debug.print=function(n){var t,i;Ifm.Diagnostics.Debug.enabled&&(t=arguments.length>1?Array.prototype.slice.call(arguments).join(" "):n&&n.toString()||null,t!==null)&&(window.console&&console.log&&console.log(t),Ifm.Diagnostics.Debug.onprint.raise(t),i=document.getElementById("consoleview"),i&&(i.innerHTML+=t+"<br>",i.scrollTop=i.scrollHeight))};this.Debug.printf=function(){Ifm.Diagnostics.Debug.enabled&&Ifm.Diagnostics.Debug.print(String.format.apply(null,arguments))};this.Errors=function(){function t(n,t){return new Error(n+(t?": '"+t+"'":""))}var n={};return n.arg=function(n){return t("Invalid function argument",n)},n.argsno=function(n){return t("Invalid number of function arguments",n)},n.browser=function(){return t("Browser not supported")},n.ctor=function(n){return t("Invalid constructor call",n)},n.func=function(n){return t("Function argument expected",n)},n.miss=function(n){return t("Missing type or module",n)},n.notimpl=function(n){return t("Feature not implemented",n)},n.notsup=function(n){return t("Feature not supported",n)},n.op=function(n){return t("Invalid operation",n)},n}()});namespace("Ifm");Ifm.Cookies={get:function(n){try{return document.cookie.replace(new RegExp("(?:(?:^|.*;\\s*)"+n+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1")}catch(t){return""}},"delete":function(n){try{document.cookie=n+"=;expires=Thu, 01-Jan-70 00:00:01 GMT;path=/"}catch(t){}},set:function(n,t){try{document.cookie=n+"="+t+";expires=Fri, 31 Dec 9999 23:59:59 GMT;path=/"}catch(i){}}};namespace("Ifm.Messaging"),function(){this.FMessage={HeaderLength:18,LengthPosition:16,ExtLenPosition:12,DataPosition:20,MessageHeaderId:1431655765};this.FMessageReader=function(n){if(!n)throw new Error("FMessageReader() -> Invalid message buffer");if(this._bytes=[],this._readingpos=0,n instanceof ArrayBuffer)this._bytes=n.getBytes();else if(n instanceof Array)this._bytes=n;else throw new Error("FMessageReader() -> Unsupported message data format: "+typeof n);if(this._bytes.length<Ifm.Messaging.FMessage.DataPosition)throw new Error("FMessageReader() -> Invalid message length: "+this._bytes.length);var t=this.nextInt32();if(t!==Ifm.Messaging.FMessage.MessageHeaderId)throw new Error("FMessageReader() -> Invalid FMessage signature: "+t.toString(16));if(this._readingpos=Ifm.Messaging.FMessage.LengthPosition,this.length=this.nextInt16(),this.length===0&&(this._readingpos=Ifm.Messaging.FMessage.ExtLenPosition,this.length=this.nextInt32(),this.length===0))throw new Error("FMessageReader() -> Invalid FMessage length");this._readingpos=Ifm.Messaging.FMessage.HeaderLength;this.code=this.nextInt16()};this.FMessageReader.prototype.remainingBytes=function(){return this.length+Ifm.Messaging.FMessage.HeaderLength-this._readingpos};this.FMessageReader.prototype.nextByte=function(){if(this._readingpos<this._bytes.length)return this._bytes[this._readingpos++];throw new Error("FMessageReader.nextByte() -> No more bytes to read: "+this._readingpos);};this.FMessageReader.prototype.nextBool=function(){return this.nextByte()===0?!1:!0};this.FMessageReader.prototype.nextBool32=function(){return this.nextInt32()===0?!1:!0};this.FMessageReader.prototype.nextInt16=function(){return(this.nextByte()<<8)+this.nextByte()};this.FMessageReader.prototype.nextInt32=function(){return(this.nextInt16()<<16)+this.nextInt16()};this.FMessageReader.prototype.nextInt64=function(){return(this.nextInt32()<<32)+this.nextInt32()};this.FMessageReader.prototype.nextString=function(){for(var i=this.nextInt16(),n=[],t=0;t<i;t++)n.push(this.nextByte());return String.fromCharCode.apply(null,n)};this.FMessageReader.prototype.nextUniString=function(){for(var i=this.nextInt16(),n=[],t=0;t<i;t++)n.push(this.nextByte()),n.push(this.nextByte()<<8);return String.fromCharCode.apply(null,n)};this.FMessageWriter=function(n){this._bytes=[];this._len=0;this.addInt32(Ifm.Messaging.FMessage.MessageHeaderId);this.addInt32(0);this.addInt32(0);this.addInt32(0);this.addInt16(0);this._len=0;this.addInt16(n);this.code=n};this.FMessageWriter.prototype.addByte=function(n){return this._bytes.push(n),this._len++,this};this.FMessageWriter.prototype.addBool=function(n){return this.addByte(n?1:0),this};this.FMessageWriter.prototype.addBool32=function(n){return this.addInt32(n?1:0),this};this.FMessageWriter.prototype.addInt16=function(n){return this.addByte((65280&n)>>8),this.addByte(255&n),this};this.FMessageWriter.prototype.addInt32=function(n){return this.addInt16((4294901760&n)>>16),this.addInt16(65535&n),this};this.FMessageWriter.prototype.addInt64=function(n){return this.addInt32((-4294967296&n)>>32),this.addInt32(4294967295&n),this};this.FMessageWriter.prototype.addString=function(n){var i=n&&n.length||0,t;for(this.addInt16(i),t=0;t<i;t++)this.addByte(n.charCodeAt(t));return this};this.FMessageWriter.prototype.addUniString=function(n){var i=n&&n.length||0,t;for(this.addInt16(i),t=0;t<i;t++)this.addByte(255&n.charCodeAt(t)),this.addByte((65280&n.charCodeAt(t))>>8);return this};this.FMessageWriter.prototype.end=function(){this._bytes[Ifm.Messaging.FMessage.LengthPosition]=(65280&this._len)>>8;this._bytes[Ifm.Messaging.FMessage.LengthPosition+1]=255&this._len};this.FMessageWriter.prototype.toArrayBuffer=function(){return ArrayBuffer.fromBytes(this._bytes)}}.call(Ifm.Messaging);namespace("Ifm.Messaging"),function(n){n.FStringMessage={MessageHeaderV1:"*begin*",MessageTypeDelV1:"%%%",MessageFieldDelV1:"###",MessageFooterV1:"§end§",MessageHeaderV2:"|begin|",MessageTypeDelV2:"|%|",MessageFieldDelV2:"|#|",MessageFooterV2:"|end|",MinValidLength:16,ProtocolVersion:"V1"};n.FStringMessageReader=function(t){var i;if(!(this instanceof Ifm.Messaging.FStringMessageReader))throw Ifm.Diagnostics.Errors.ctor("Ifm.Messaging.FStringMessageReader");if(!t)throw Ifm.Diagnostics.Errors.arg("messageBuffer");if(this._message="",this._readingpos=0,Ifm.Type.isString(t))this._message=t;else throw new Error("FStringMessageReader() -> Unsupported message data format: "+typeof t);if(this._message.length<n.FStringMessage.MinValidLength)throw new Error("FStringMessageReader() -> Invalid message length: "+this._message.length);if(this._message.startsWith(n.FStringMessage.MessageHeaderV1)){if(i=this._message.match(/^\*begin\*([A-z0-9]*)%{3}/),i&&i.length==2)this.type=i[1];else throw new Error("FStringMessageReader() -> Invalid FStringMessage type format");if(i=this._message.match(/%{3}(.*)[\xA7|$]end[\xA7|$]/),i&&i.length==2)this.data=i[1].split(n.FStringMessage.MessageFieldDelV1);else throw new Error("FStringMessageReader() -> Invalid FStringMessage data format");}else if(this._message.startsWith(n.FStringMessage.MessageHeaderV2)){if(i=this._message.match(/^\x7Cbegin\x7C([A-z0-9]*)\x7C%\x7C/),i&&i.length==2)this.type=i[1];else throw new Error("FStringMessageReader() -> Invalid FStringMessage type format");if(i=this._message.match(/\x7C%\x7C(.*)[\x7C]end[\x7C]/),i&&i.length==2)this.data=i[1].split(n.FStringMessage.MessageFieldDelV2);else throw new Error("FStringMessageReader() -> Invalid FStringMessage data format");}else throw new Error("FStringMessageReader() -> Invalid FStringMessage signature");};n.FStringMessageWriter=function(t,i){if(!(this instanceof Ifm.Messaging.FStringMessageWriter))throw Ifm.Diagnostics.Errors.ctor("Ifm.Messaging.FStringMessageWriter");if(!Ifm.Type.isString(t))throw Ifm.Diagnostics.Errors.arg("type");this._dataAdded=!1;this.type=t;i==="V2"?(n.FStringMessage.protocolVersion=i,this._message=n.FStringMessage.MessageHeaderV2+t+n.FStringMessage.MessageTypeDelV2):(n.FStringMessage.protocolVersion="V1",this._message=n.FStringMessage.MessageHeaderV1+t+n.FStringMessage.MessageTypeDelV1)};n.FStringMessageWriter.prototype.add=function(t){if(t===undefined||t===null)throw Ifm.Diagnostics.Errors.arg("str");return n.FStringMessage.protocolVersion==="V1"?(this._dataAdded&&(this._message+=n.FStringMessage.MessageFieldDelV1),this._message+=t,this._dataAdded=!0):(this._dataAdded&&(this._message+=n.FStringMessage.MessageFieldDelV2),this._message+=t,this._dataAdded=!0),this};n.FStringMessageWriter.prototype.end=function(){return this._message+=n.FStringMessage.protocolVersion==="V1"?n.FStringMessage.MessageFooterV1:n.FStringMessage.MessageFooterV2,this};n.FStringMessageWriter.prototype.toString=function(){return this._message}}(Ifm.Messaging);namespace("Ifm.Messaging"),function(){this.FMessageBuilder=function(){if(!window.ArrayBuffer)throw new Error("FMessageBuilder() -> ArrayBuffer not supported");this.message=new Ifm.Event;this._buffer=[];this.toString=function(){return"[object FMessageBuilder]"}};this.FMessageBuilder.isSupported=function(){return window.ArrayBuffer?!0:!1};this.FMessageBuilder.prototype.append=function(n){if(n)if(n instanceof ArrayBuffer)Array.pushArray(this._buffer,n.getBytes());else if(n instanceof Array)Array.pushArray(this._buffer,n);else throw new Error("FMessageBuilder.append() -> Unsupported message data format: "+typeof n);else throw new Error("FMessageBuilder.append() -> Invalid message buffer");while(this._buffer.length>Ifm.Messaging.FMessage.HeaderLength){var t=new Ifm.Messaging.FMessageReader(this._buffer);if(Ifm.Messaging.FMessage.HeaderLength+t.length<=this._buffer.length){try{this.message.raise(this,{message:t})}catch(i){console.error(i);Ifm.Diagnostics.Debug.print(this,"Error dispatching or processing message:",i.message);Ifm.Diagnostics.Debug.print(i.stack)}this._buffer.splice(0,Ifm.Messaging.FMessage.HeaderLength+t.length)}}}}.call(Ifm.Messaging);namespace("Ifm.Messaging").FPropertyList=function(n){if(!(this instanceof Ifm.Messaging.FPropertyList))throw Ifm.Diagnostics.Errors.ctor();if(!n||!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("pliststr");n=n.trim();for(var t={},i=[],r,u=/{\s*([^\s{]*)\s*=\s*([^}]*)}/g;r=u.exec(n);)t[r[1]]=r[2],i.push(r[1]);this.events=defineEvents("changed");this.originalString=n;this.get=function(n){if(!n||!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("key");return t[n]};this.keys=function(){var n=[];for(var i in t)n.push(i);return n};this.remove=function(n){if(!n||!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("key");if(t.hasOwnProperty(n)){delete t[n];for(var r=i.length;r--;)i[r]===n&&(i.splice(r,1),this.events.changed.raise(this,{key:n,value:undefined}))}};this.set=function(n,r){if(!n||!Ifm.Type.isString(n))throw Ifm.Diagnostics.Errors.arg("key");r!==undefined&&(t.hasOwnProperty(n)||i.push(n),t[n]!==r&&(t[n]=r,this.events.changed.raise(this,{key:n,value:r})))};this.toString=function(){for(var r="{",n=0;n<i.length;n++)r+="{"+i[n]+" = "+t[i[n]]+"}";return r+"}"}},function(){function u(n){switch(n){case"403":return": no destination for protocol";case"500":return": client-gateway protocol error";case"502":return": gateway-server protocol error";case"503":return": no destination reachable";default:return""}}var i=namespace("Ifm.Messaging"),t=i.FPort=function r(){if(!(this instanceof r))throw Ifm.Diagnostics.Errors.ctor();this.opened=new Ifm.Event;this.closed=new Ifm.Event;this.message=new Ifm.Event},n;t.isSupported=function(){return global.WebSocket&&global.ArrayBuffer?!0:!1};n=t.prototype;n.isClosed=function(){return this._websocket&&this._websocket.readyState===WebSocket.CLOSED||!0};n.isOpen=function(){return this._websocket&&this._websocket.readyState===WebSocket.OPEN||!1};n.open=function(n,i){if(!t.isSupported())throw Ifm.Diagnostics.Errors.notsup("FPort");if(!n)throw Ifm.Diagnostics.Errors.arg("address");if(this.isOpen())throw Ifm.Diagnostics.Errors.op("port open");var r=this,f=new Ifm.Messaging.FMessageBuilder;f.message.addHandler(function(n,t){this.message.raise(r,{reader:t.message})},this);this._closedhere=!1;this._wasconnected=!1;this._gateway=!1;this._localPort=null;Ifm.Diagnostics.Debug.print("[FPort] connecting to "+n);try{this._websocket=i?new WebSocket(n,i):new WebSocket(n);this._websocket.binaryType="arraybuffer";this._remoteAddress=n}catch(e){Ifm.Diagnostics.Debug.print("[FPort] connection failed: "+e.message);r.closed.raise(r,{clean:!1,failed:!0,lost:!1,reason:e.message});return}this._websocket.onmessage=function(t){var i,e,o,s;if(Ifm.Type.isString(t.data)){i=t.data.split("|");switch(i[0]){case"#ready":Ifm.Diagnostics.Debug.print("[FPort] ready");r._websocket.send("#qlp");r._wasconnected=!0;r.opened.raise(r,{address:n,gateway:r._gateway});return;case"#qlp":r._localPort=Number(i[1]);return;case"#close":e=i.length>1?i[1]:"0";o=e+u(e);Ifm.Diagnostics.Debug.printf("[FPort] closed ({0})",o);return;default:if(i[0].startsWith("#"))return}try{s=new Ifm.Messaging.FStringMessageReader(t.data)}catch(h){Ifm.Diagnostics.Debug.printf("[FPort] invalid message {0}",t.data);Ifm.Diagnostics.Debug.print(h);return}r.message.raise(r,{reader:s})}else t.data instanceof ArrayBuffer?f.append(t.data):Ifm.Diagnostics.Debug.printf("[FPort] unknown message {0}",t.data)};this._websocket.onclose=function(t){Ifm.Diagnostics.Debug.print("[FPort] closed"+(r._wasconnected?r._closedhere?"":" (connection lost)":" (connection failed)"));r.closed.raise(r,{clean:r._closedhere,failed:!r._wasconnected,lost:r._wasconnected&&!r._closedhere,reason:r._closedhere?"":"Connection to "+n+" "+(r._wasconnected?t.reason?t.reason:"lost":"failed")});delete r._localPort;delete r._remoteAddress;delete r._websocket}};n.close=function(){this.isClosed()&&(this._closedhere=!0,this._websocket.close())};n.send=function(n){if(n&&this.isOpen())if(n instanceof Ifm.Messaging.FMessageWriter)this._websocket.send(n.toArrayBuffer());else if(n instanceof Ifm.Messaging.FStringMessageWriter)this._websocket.send(n.toString());else throw Error("Unsupported message format: "+n+" ("+Ifm.Type.getTypeName(n)+")");}}(),function(){var n=namespace("Ifm.Messaging");n.FConnection=function(){if(!(this instanceof Ifm.Messaging.FConnection))throw Ifm.Diagnostics.Errors.ctor();var t=null,i=null;return{constructor:n.FConnection,events:defineEvents("connecting","connected","disconnecting","disconnected","binarymessage","stringmessage"),isSupported:function(){return!!(t&&t.isSupported())},isClosed:function(){return!!(t&&t.isClosed())},isConnected:function(){return!!(t&&t.isOpen())},getAddress:function(){return t&&t._remoteAddress||""},getLocalPort:function(){return t&&t._localPort||null},connect:function(n,r,u){if(this.isConnected())return!0;if(!n||Ifm.Type.isArray(n)&&n.length===0)throw Ifm.Diagnostics.Errors.arg("address");t=new Ifm.Messaging.FPort;t.opened.addHandler(function(){this.events.connected.raise(this);Ifm.Type.isFunction(u)&&u()},this);t.closed.addHandler(function(t,f){if(f.failed&&Ifm.Type.isArray(n)&&n.length>1){this.connect(n.slice().splice(1),r,u);return}this.events.disconnected.raise(this,i||f);i=null},this);t.message.addHandler(function(n,t){if(t.reader instanceof Ifm.Messaging.FStringMessageReader)this.events.stringmessage.raise(this,t);else if(t.reader instanceof Ifm.Messaging.FMessageReader)this.events.binarymessage.raise(this,t);else{Ifm.Diagnostics.Debug.fail("Invalid messageReader");return}},this);this.events.connecting.raise(this,{address:n});Ifm.Type.isArray(n)?t.open(n[0],r):t.open(n,r)},disconnect:function(n){if(!this.isConnected())return!0;i=n||null;this.events.disconnecting.raise(this);t.close()},send:function(n){if(!n)throw Ifm.Diagnostics.Errors.arg("message");if(!this.isConnected()){console.warn("[Ifm.Messaging.FConnection] Can't send, not connected");return}t.send(n)}}}}(),function(){var n=namespace("Ifm.PhoneBar");n.AgentListCampaigns={AnyCampaign:0,SpecificCampaign:256,OmitSynthetics:512,OmitHumans:1024};n.AgentListStates={NotAvailable:1,Available:2,Assigned:4,Booked:8,Talking:16,Paused:32,Postcall:64,Othercall:128,AnyAvailable:254};n.CampaignInfoFlags={Inactive:1,Active:2,Suspended:4,AnyStatusMask:7,Inbound:8,Outbound:16,AnyBoundness:24,NotAssigned:32,Assigned:64,AnyAssignment:96,PostCallWork:128,HideTransferNotAllowed:256,ExcludeSyntheticCampaigns:512,ExcludeHumanCampaigns:1024};n.LoginReplyFailureCauses={Unspecified:0,AccountLockout:1,ExpiredPassword:2,WrongUsernameOrPassword:3,InvalidNewPassword:4,PasswordChangeNotAllowed:5,WrongState:6,InvalidExtension:7,ExtensionAlreadyInUse:8,TokenBasedLoginNotAvailable:9,InvalidToken:10,ProvisioningError:11,ExtensionTranslationError:128};n.Mediatypes={Voice:1,NearRealTime:8,StoreAndForward:16};n.States={Initialization:"[Initialization]",NotLoggedIn:"[Not Logged In]",Connecting:"[Connecting]",LoggedIn:"[Logged In]",Paused:"[Paused]",Ready:"[Ready]",Alerting:"[Alerting]",Talking:"[Talking]",PostCall:"[Post Call]",OtherCall:"[Other Call]",Assigned:"[Assigned]",WaitingOutbound:"[Waiting Outbound]",WaitingTransfer:"[Waiting Transfer]"};n.TransferCallModes={Blind:0,Default:1,Consultative:2}}();namespace("Ifm.PhoneBar"),function(n){n.about={product:"#phones",title:"#phonebar",version:"1.0.75-0"};n.events=defineEvents("initialized","languagechanged","displayStateChanged","booked","assignment","alerting","answered","callfailure","newcall","abortcall","othercall","pausebooked","pause","ready","readyfordetach","readyfortransfer","terminated","recordingstarted","recordingmutechanged","recordingstopped","maskeddigitreceived","maskedpayloadreceived","statechanged","statetimechanged","supervisormessage");n.version=n.about.title+"/"+n.about.version;n.canRun=function(){return!!(global&&global.WebSocket&&global.ArrayBuffer&&global.jQuery)};n.run=function(n,t){this.run=function(){self.log("PhoneBar","Debug","Already running")};this.instance.initialize(n,t)};n.instance=function(n){function pt(){u={};e={login:[],logout:[],pause:[],ready:[],make:[],transfer:[],abort:[],getAgentList:[],getCampaignList:[],getPauseReasons:[],getQueueInfo:[]};c=null}function b(){p!==f.Paused&&(Object.values(u).some(function(n){return!n.terminated&&!n.transferred})?(y(f.Talking),ut(r.TalkingState)):Object.values(u).some(function(n){return n.postcall})?(y(f.PostCall),ut(r.PostCallState)):c?(y(f.WaitingOutbound),a(r.WaitingOutboundState)):kt())}function y(r){var h=p,e,o;if(r!==h||r===f.Paused){t.log("PhoneBar","Debug","Changing state, from",h,"to",r);p=r;e=!1;o=!1;switch(h){case f.Paused:r!==f.Paused&&(d=0,k="");break;case f.WaitingOutbound:jQuery(i.AbortCallButton).disable().hide();(r===f.Ready||r===f.Paused)&&(c=null)}switch(r){case f.NotLoggedIn:jQuery([i.PauseButton,i.ReadyButton,i.LogoutButton,i.NumberLabel,i.NumberInput,i.CallButton,i.TransferButton,i.CampaignListButton,i.QueueInfoButton,i.PanicButton,i.StartRecordingButton,i.StopRecordingButton,i.MuteRecordingButton,i.UnmuteRecordingButton].join(", ")).disable();jQuery(i.LoginButton).enable();jQuery(i.LoginOrReadyButton).enable();jQuery(i.NumberInput).val("").change();Ifm.Dom&&Ifm.Dom.Photon&&(Ifm.Dom.Photon.Cards.close("login-dialog"),Ifm.Dom.Photon.Cards.close("campaignlist-card"),Ifm.Dom.Photon.Cards.close("queueinfo-card"));e=!0;break;case f.Connecting:jQuery([i.LoginButton,i.LoginOrReadyButton].join(", ")).disable();break;case f.LoggedIn:case f.Ready:jQuery([i.PauseButton,i.LogoutButton,i.NumberLabel,i.NumberInput,i.CampaignListButton,i.QueueInfoButton,i.PanicButton].join(", ")).enable();jQuery([i.LoginButton,i.LoginOrReadyButton,i.ReadyButton,i.TransferButton].join(", ")).disable();e=!0;break;case f.Paused:jQuery(i.PauseButton).disable();t.getPauseReasons(function(n){n.reasons.length>0&&jQuery(i.PauseButton).enable()});jQuery([i.ReadyButton,i.LoginOrReadyButton].join(", ")).enable();e=!0;o=!t.options.hideClockInPause();break;case f.Talking:Object.values(u).some(function(t){return t.mediatype===n.Mediatypes.Voice})&&jQuery(i.TransferButton).enable();e=!0;o=!0;break;case f.PostCall:Object.values(u).some(function(t){return t.mediatype===n.Mediatypes.Voice})&&jQuery([i.ReadyButton,i.LoginOrReadyButton].join(", ")).enable();e=!0;o=!0;break;case f.OtherCall:g||(e=!0,o=!0);break;case f.Assigned:e=!0;o=!0;break;case f.Alerting:break;case f.WaitingOutbound:jQuery([i.ReadyButton,i.LoginOrReadyButton].join(", ")).disable();jQuery(i.AbortCallButton).show().enable();e=!0;o=!0;break;case f.WaitingTransfer:break;default:t.log("PhoneBar","Debug","Unexpected state",r);return}ct();s.statechanged.raise(t,{currentState:r,previousState:h});e&&(rt=new Date,s.statetimechanged.raise(t,{stateTime:rt,startTimer:o}),g&&(g=clearTimeout(g)),o&&(g=setInterval(function(){var n=new Date-rt;jQuery(i.StateTimeText).html(tt(n,!0))},1e3)),jQuery(i.StateTimeText).html(""))}}function ut(i,r){var e="",f;t.options.showCampaignNameForVoiceCalls()&&(f=r&&u[r],f&&f.mediatype==n.Mediatypes.Voice||(f=oi()),f&&(e=" ("+f.campaignName+")"));a(i+e)}function wt(i,r,u){var f="";t.options.showCampaignNameForVoiceCalls()&&r===n.Mediatypes.Voice&&u.length>0&&(f=" ("+u+")");a(i+f)}function a(n,r){r?(ot=!0,jQuery(i.StateText).html(n),jQuery(i.StateText).addClass("phonebar-state-error-text"),s.displayStateChanged.raise(t,{label:n,isTemporary:!0}),setTimeout(function(){jQuery(i.StateText).removeClass("phonebar-state-error-text");ot=!1;jQuery(i.StateText).html(et);s.displayStateChanged.raise(t,{label:et,isTemporary:!1})},r)):(et=n,ot||(jQuery(i.StateText).html(n),s.displayStateChanged.raise(t,{label:n,isTemporary:!1})))}function oi(){return Object.values(u).find(function(t){return t.mediatype===n.Mediatypes.Voice})||null}function bt(i){var u=i.reasonId||0;(p!==n.States.Paused||u!==d)&&(y(n.States.Paused),d=u,d===0?(k="",a(r.PausedState)):(k=i.reasonText,t.log("PhoneBar","Debug","Pause reason is",k),a(r.PausedState+" ("+k+")")),s.pause.raise(t,i))}function kt(){(p!==f.Ready||it)&&(it=!1,y(f.Ready),a(r.ReadyState),s.ready.raise(t,{callId:null}))}function dt(n){n.isRedirecting?t.log("PhoneBar","Info","Redirecting to",h.authorityUrl):ht(n.token,n.username)}function ht(n,i){n||t.log("PhoneBar","Error","Missing access token");v.accessToken=n||"";i&&!t.agent.username!==i&&(t.agent.username=i);t.log("PhoneBar","Debug","Access token updated");t.isLoggedIn()&&(t.agent.password=n,t.agent.save(),t.media.phone&&t.media.phone.setAccessToken(n))}function nt(n,i){var r=u[n];r&&r.isRecording?(r.isRecording=!1,w(n),s.recordingstopped.raise(t,{callId:n,result:i||0})):w(0)}function ct(){var t=n.States;p===t.LoggedIn||p===t.Ready||p===t.Paused?jQuery(i.CallButton).enabled(jQuery(i.NumberInput).val()):jQuery(i.CallButton).disable()}function w(t){var r=u[t];r&&r.mediatype!==n.Mediatypes.Voice||(r&&!r.terminated&&r.isRecording?r&&r.isRecording&&(jQuery(i.StartRecordingButton).disable(),jQuery(i.StartRecordingButton).hide(),jQuery(i.StopRecordingButton).enable(),jQuery(i.StopRecordingButton).show(),r.recordingData.rxChannelMuted||r.recordingData.txChannelMuted?(jQuery(i.MuteRecordingButton).disable(),jQuery(i.MuteRecordingButton).hide(),jQuery(i.UnmuteRecordingButton).enable(),jQuery(i.UnmuteRecordingButton).show()):(jQuery(i.MuteRecordingButton).enable(),jQuery(i.MuteRecordingButton).show(),jQuery(i.UnmuteRecordingButton).disable(),jQuery(i.UnmuteRecordingButton).hide())):(jQuery([i.StartRecordingButton,i.StopRecordingButton,i.MuteRecordingButton,i.UnmuteRecordingButton].join(", ")).disable(),jQuery(i.StopRecordingButton).hide(),jQuery(i.UnmuteRecordingButton).hide(),jQuery(i.StartRecordingButton).show(),jQuery(i.MuteRecordingButton).show()),!r||r.postcall||r.terminated||r.isRecording||jQuery(i.StartRecordingButton).enable())}function tt(n,t){var r,u;t&&(n=n/1e3);r=Math.floor(n%60);n=n/60;u=Math.floor(n%60);n=n/60;var f=Math.floor(n%24),e=Math.floor(n/24),i="";return e>0&&(i+=e+" d "),f>0&&(i+=f+" h "),u>0&&(i+=u+" m "),r>0&&(i+=r+" s "),i}function gt(n,i){switch(n.toUpperCase()){case"CALLID":return i.id;case"CAMPAIGNID":return i.otherData.campaignId;case"CAMPAIGNNAME":return i.campaignName;case"SERVICEID":return i.otherData.serviceId;case"AGENTID":return t.agent.id;case"AGENTNAME":return t.agent.firstName+" "+t.agent.lastName;case"AGENTFIRSTNAME":return t.agent.firstName;case"AGENTLASTNAME":return t.agent.lastName;case"EXTENSION":return t.agent.extension}return""}function si(n,t){var f="",e="",i=n,r,u;do r=i.indexOf("{$"),u=i.indexOf("{%"),r===-1&&u===-1?(f+=i,i=""):r>=0&&u===-1?(u=i.indexOf("}",r+2),u>=0?(f+=i.substr(0,r),e=i.substr(r+2,u-r-2),t.callData.get(e)&&(f+=t.callData.get(e)),i=i.substr(u+1)):(f+=i,i="")):r===-1&&u>=0?(r=u,u=i.indexOf("}",r+2),u>=0?(e=i.substr(r+2,u-r-2),f+=i.substr(0,r)+gt(e,t),i=i.substr(u+1)):(f+=i,i="")):r<u?(u=i.indexOf("}",r+2),u>=0?(f+=i.substr(0,r),e=i.substr(r+2,u-r-2),t.callData.get(e)&&(f+=t.callData.get(e)),i=i.substr(u+1)):(f+=i,i="")):(r=u,u=i.indexOf("}",r+2),u>=0?(e=i.substr(r+2,u-r-2),f+=i.substr(0,r)+gt(e,t),i=i.substr(u+1)):(f+=i,i=""));while(i.length>0);return f}function hi(){jQuery(i.LoginButton).attr("title",r.TooltipLogin);jQuery(i.LoginOrReadyButton).attr("title",r.TooltipLoginOrReady);jQuery(i.ReadyButton).attr("title",r.TooltipReady);jQuery(i.PauseButton).attr("title",r.TooltipPause);jQuery(i.LogoutButton).attr("title",r.TooltipLogout);jQuery(i.CallButton).attr("title",r.TooltipCall);jQuery(i.TransferButton).attr("title",r.TooltipTransfer);jQuery(i.CampaignListButton).attr("title",r.TooltipCampaignList);jQuery(i.QueueInfoButton).attr("title",r.TooltipQueueInfo);jQuery(i.PanicButton).attr("title",r.TooltipPanic);jQuery(i.MainMenuButton).attr("title",r.TooltipMainMenu);jQuery(i.NumberLabel+", "+i.NumberInput).attr("placeholder"," · ").attr("title",r.TooltipPhoneNumber);jQuery(i.StartRecordingButton).attr("title",r.TooltipStartRec);jQuery(i.StopRecordingButton).attr("title",r.TooltipStopRec);jQuery(i.MuteRecordingButton).attr("title",r.TooltipMuteRec);jQuery(i.UnmuteRecordingButton).attr("title",r.TooltipUnmuteRec);jQuery(i.HangupButton).attr("title",r.TooltipHangup);jQuery(i.PickupButton).attr("title",r.TooltipPickup);jQuery(i.FlashButton).attr("title",r.TooltipFlash);jQuery(i.ManualTransferButton).attr("title",r.TooltipManualTransfer);jQuery(i.Line1Button).attr("title",r.TooltipLine1);jQuery(i.Line2Button).attr("title",r.TooltipLine2);jQuery(i.EnterConferenceButton).attr("title",r.TooltipEnterConf);jQuery(i.LeaveConferenceButton).attr("title",r.TooltipLeaveConf);jQuery(i.MicrophoneVULabel+", "+i.MicrophoneVUMeter).attr("title",r.TooltipMicVUMeter);jQuery(i.SpeakersVULabel+", "+i.SpeakersVUMeter).attr("title",r.TooltipSpkVUMeter);jQuery(i.MicrophoneOffButton).attr("title",r.TooltipMicOff);jQuery(i.MicrophoneOnButton).attr("title",r.TooltipMicOn)}function ni(){if(e.getAgentList.length){var i=e.getAgentList[0],r=i.campaignName,u=i.mask;t.log("PhoneBar","Debug","Sending AgentListRequest message");o.send(new n.Messages.AgentListRequest(r,u))}}function ti(){if(e.getCampaignList.length){var i=e.getCampaignList[0],r=i.mask,u=i.callId,f=i.mediatype;t.log("PhoneBar","Debug","Sending CampaignListRequest message");o.send(new n.Messages.CampaignListRequest(r,u,f))}}function ii(){e.getPauseReasons.length&&(t.log("PhoneBar","Debug","Sending PauseReasonsRequest message"),o.send(new n.Messages.PauseReasonsRequest))}function ri(){if(e.getQueueInfo.length){var i=e.getQueueInfo[0].campaignName;t.log("PhoneBar","Debug","Sending CampaignQueueInfoRequest message");o.send(new n.Messages.CampaignQueueInfoRequest(i))}}var t,s,h,ft,f,r,i,ui=!!(window.chrome&&chrome.runtime&&chrome.runtime.id),it=!1,p=n.States.Initialization,et="",ot=!1,d=0,k="",rt=0,g,v={accessToken:"",language:"it",localOAuth2:!1,loginRedirect:!1,logoutRedirect:!1},o=new Ifm.Messaging.FConnection,u,e,c,fi={1:"[No Dial Tone]",2:"[No Ringback]",3:"[Line Busy]",4:"[No Answer]",5:"[Fax Tone]",6:"[Remote Hangup]",7:"[Agent: No Dial Tone]",8:"[Agent: No Ringback]",9:"[Agent: Line Busy]",10:"[Agent: No Answer]",255:"[Unknown]"},ei={1:"CallFailureNoDialTone",2:"CallFailureNoRingback",3:"CallFailureLineBusy",4:"CallFailureNoAnswer",5:"CallFailureFaxTone",6:"CallFailureRemoteHangUp",7:"CallFailureAgentNoDialTone",8:"CallFailureAgentNoRingback",9:"CallFailureAgentBusy",10:"CallFailureAgentNoAnswer",255:"CallFailureUnknown"},st={RecordingInactive:0,RecordingActive:1,TxChannelMuted:2,RxChannelMuted:4},l={_root:"phonebar!",_agent:"agent!"};l.agent={firstName:l._root+l._agent+"firstName",lastName:l._root+l._agent+"lastName",password:l._root+l._agent+"password",extension:l._root+l._agent+"extension",username:l._root+l._agent+"username"};var lt=0,at="ipb",vt=3,yt="ipr";return o.events.connecting=function(){y(f.Connecting);a(r.ConnectingState)},o.events.disconnected=function(n,i){var u=p;pt();y(f.NotLoggedIn);u!==f.Connecting&&u!==f.NotLoggedIn&&(t.media.phone&&t.media.phone.disconnect(),t.media.xmpp&&t.media.xmpp.disconnect());i.clean?a(r.NotLoggedInState):i.failed?(t.log("Connection","Warn",i.reason),a(r.ConnectionFailed)):i.lost&&(t.log("Connection","Warn","Connection lost"),a(r.NotLoggedInState+" ("+r.ConnectionLost+")"));w(0)},o.events.binarymessage=function(i,h){var ct=h.reader,l=null,d=n.Messages,ht,g,k,yt,ot,lt,ft;for(ht in d.PhonesToPhoneBarMessages)if(ct.code===d.PhonesToPhoneBarMessages[ht]){l=new d[ht](ct);l.typecode=ct.code;break}if(l===null){t.log("PhoneBar","Warn","Unknown message received:",ct.code);return}if(l.typecode===d.PhonesToPhoneBarMessages.KeepAliveRequest){o.send(new d.KeepAliveReply);return}k=l.callId;k?t.log("PhoneBar","Debug","Got",ht,"message, callId",k):t.log("PhoneBar","Debug","Got",ht,"message");switch(l.typecode){case d.PhonesToPhoneBarMessages.AssignmentRequest:var rt=new Ifm.Messaging.FPropertyList(l.callDataStr),et=rt.get("ExternalParty")||"",at=l.mediatype||Number(rt.get("_MediaType_"))||n.Mediatypes.Voice,vt=!1;if(it=!1,at===n.Mediatypes.Voice&&(c?(vt=c.hideNumber,et.endsWith(c.externalParty)&&(et=c.externalParty,rt.set("ExternalParty",et)),c=null):rt.get("DDI")||(yt=et.lastIndexOf("+"),yt>0&&(et=et.substring(yt),rt.set("ExternalParty",et)))),rt.save=function(){t.log("PhoneBar","Debug","Sending SetCallResultEvent message");o.send(d.SetCallResultEvent(k,rt.toString()))},ot=u[k]={callId:k,callGuid:rt.get("GUID").toUpperCase(),mediatype:at,hideNumber:vt,displayNumber:vt?"*****":et,campaignName:l.campaignName,callData:rt,otherData:{serviceId:l.serviceId,campaignId:l.campaignId,scriptName:l.scriptName,scriptParameters:l.scriptParameters},isRecording:l.recordingState&st.RecordingActive?!0:!1,recordingData:{fileName:l.recordingFileName,settings:l.recordingSettings,rxChannelMuted:l.recordingState&st.RxChannelMuted?!0:!1,txChannelMuted:l.recordingState&st.TxChannelMuted?!0:!1}},t.log("PhoneBar","Debug","Incoming call on campaign",ot.campaignName,"with calldata",ot.callData),t.log("PhoneBar","Debug","Sending AssignmentReply message"),o.send(new d.AssignmentReply(k,1)),y(f.Assigned),wt(r.AssignedState,at,l.campaignName),w(k),s.assignment.raise(t,ot),ot.isRecording&&(s.recordingstarted.raise(t,{callId:k,fileName:l.recordingFileName}),s.recordingmutechanged.raise(t,{callId:k,rxChannelMuted:ot.recordingData.rxChannelMuted,txChannelMuted:ot.recordingData.txChannelMuted})),l.scriptName&&l.scriptName.length>0){t.log("PhoneBar","Debug","Script Type:",l.scriptName,"with parameters:",l.scriptParameters);switch(l.scriptName){case"OLE2":case"Preloaded":case"PTT":case"PLUGIN":break;default:window.open(si(l.scriptName,ot))}}break;case d.PhonesToPhoneBarMessages.LoginReply:l.accepted===0?(t.log("PhoneBar","Warn","Login request refused, cause",l.failureCause,Ifm.Enum.getName(n.LoginReplyFailureCauses,l.failureCause)),y(f.NotLoggedIn),a(r.RequestRefused,1e3),o.disconnect(),t.options.forgetPassword()):(Ifm.Dom&&Ifm.Dom.Photon&&Ifm.Dom.Photon.Cards.close("login-dialog"),t.agent.id=l.agentId,l.extension&&(t.agent.extension=l.extension),l.username&&(t.agent.firstName=l.firstName,t.agent.lastName=l.lastName,t.agent.username=l.username),t.agent.save(),y(f.LoggedIn),a(r.LoggedInState),t.media.phone&&(Ifm.PhoneBar.Media.Phone.events.connected.addHandler(function(){v.accessToken&&t.media.phone.setAccessToken(v.accessToken);t.media.phone.register()}),t.media.phone.connect()),t.options.autoConnectToXmpp()!==!1&&t.media.xmpp&&t.media.xmpp.connect());g=e.login.shift();g&&g(l);break;case d.PhonesToPhoneBarMessages.LogoutReply:l.accepted===0?(t.log("PhoneBar","Warn","Logout request refused"),a(r.RequestRefused,1e3)):(delete t.agent.id,t.options.forgetPassword(),o.disconnect(),v.localOAuth2&&Ifm.Iam.OAuth2.logout());g=e.logout.shift();g&&g(l);break;case d.PhonesToPhoneBarMessages.PauseReply:switch(l.accepted){case 0:t.log("PhoneBar","Warn","Pause request refused");a(r.RequestRefused,1e3);break;case 1:bt(l);break;case 2:t.log("PhoneBar","Info","Pause booked");a(r.PauseBooked,1e3);s.pausebooked.raise(t,l)}l.accepted===3?(g=e.getPauseReasons.shift(),g&&g({reasons:l.reasons}),ii()):(g=e.pause.shift(),g&&g(l));break;case d.PhonesToPhoneBarMessages.ReadyReply:l.accepted===0?(t.log("PhoneBar","Warn","Ready request refused"),a(r.RequestRefused,1e3)):(k&&u[k]&&(u[k].postcall=!1,u[k].terminated=!0),s.ready.raise(t,{callId:k}));g=e.ready.shift();g&&g(l);l.accepted===1&&(k&&u[k]?(nt(k),delete u[k],b()):u.length>0?b():kt());break;case d.PhonesToPhoneBarMessages.NewCallReply:l.accepted===0?(t.log("PhoneBar","Warn","New call request refused"),a(r.RequestRefused,1e3)):(c.callId=k,t.log("PhoneBar","Info","New call request accepted, callId",k),y(f.WaitingOutbound),a(r.WaitingOutboundState));g=e.make.shift();g&&g(l);s.newcall.raise(t,{accepted:l.accepted,callId:l.callId,campaignName:c.campaignName,hideNumber:c.hideNumber});l.accepted===0&&(c=null);break;case d.PhonesToPhoneBarMessages.AbortCallReply:l.accepted===0?(t.log("PhoneBar","Warn","Abort call request refused"),a(r.RequestRefused,1e3)):c&&c.callId===l.callId&&(t.log("PhoneBar","Info","Abort call request accepted, callId",k),l.campaign=c.campaignName);g=e.abort.shift();g&&g(l);s.abortcall.raise(t,{accepted:l.accepted,callId:l.callId,campaignName:c.campaignName,hideNumber:c.hideNumber});break;case d.PhonesToPhoneBarMessages.TransferCallReply:l.accepted===0?(t.log("PhoneBar","Warn","Transfer call request refused"),a(r.RequestRefused,1e3)):(t.log("PhoneBar","Info","Transfer call request accepted, callId",k),u[k].transferred=!0,u[k].mediatype===n.Mediatypes.Voice&&(y(f.WaitingTransfer),a(r.WaitingTransferState)),s.readyfortransfer.raise(t,l));g=e.transfer.shift();g&&g(l);break;case d.PhonesToPhoneBarMessages.AgentListReply:g=e.getAgentList.shift();g&&g.callback(l);ni();break;case d.PhonesToPhoneBarMessages.CampaignListReply:g=e.getCampaignList.shift();g&&g.callback(l);ti();break;case d.PhonesToPhoneBarMessages.CampaignQueueInfoReply:for(l.avgTimestamp=l.avgTime,l.avgTime=tt(l.avgTime),l.maxTimestamp=l.maxTime,l.maxTime=tt(l.maxTime),lt=0;lt<l.campaigns.length;lt++)ft=l.campaigns[lt],ft.avgTimestamp=ft.avgTime,ft.avgTime=tt(ft.avgTime),ft.maxTimestamp=ft.maxTime,ft.maxTime=tt(ft.maxTime);g=e.getQueueInfo.shift();g&&g.callback(l);ri();break;case d.PhonesToPhoneBarMessages.BookedEvent:it=!0;wt(r.AssignmentBooked,l.mediatype,l.campaignName);s.booked.raise(t,l);break;case d.PhonesToPhoneBarMessages.AlertingEvent:y(f.Alerting);ut(r.AlertingState,l.callId);s.alerting.raise(t,l);break;case d.PhonesToPhoneBarMessages.AnsweredEvent:y(f.Talking);ut(r.TalkingState,l.callId);s.answered.raise(t,l);break;case d.PhonesToPhoneBarMessages.CallFailureEvent:t.log("PhoneBar","Warn","Call failure: callId",k,"cause",l.cause,fi[l.cause],"ISDN cause",l.protocolTerminationCause,l.protocolTerminationDescription,"detected content cause",l.detectedContentCode,l.detectedContentDescription);l.description=r[ei[l.cause]];c&&c.callId===k||a(r.CallFailure+" ("+l.description+")",3e3);u[k]&&(u[k].terminated=!0,nt(k));s.callfailure.raise(t,l);c&&c.callId===k&&(c=null);delete u[k];b();break;case d.PhonesToPhoneBarMessages.OtherCallEvent:p!==f.WaitingOutbound&&(y(f.OtherCall),a(r.OtherCallState),s.othercall.raise(t,l));break;case d.PhonesToPhoneBarMessages.PauseEvent:case d.PhonesToPhoneBarMessages.ReadyEvent:Object.values(u).forEach(function(n){n.transferred&&(nt(n.callId),delete u[n.callId])});c=null;l.typecode===d.PhonesToPhoneBarMessages.PauseEvent?bt(l):b();break;case d.PhonesToPhoneBarMessages.ReadyForDetachEvent:s.readyfordetach.raise(t,l);u[k]&&u[k].transferred&&u[k].mediatype>n.Mediatypes.Voice&&(delete u[k],b());break;case d.PhonesToPhoneBarMessages.ReadyForTransferEvent:s.readyfortransfer.raise(t,l);break;case d.PhonesToPhoneBarMessages.SupervisorMessageEvent:s.supervisormessage.raise(t,l);break;case d.PhonesToPhoneBarMessages.TerminatedEvent:u[k].terminated=!0;l.postCallWork&&(u[k].postcall=!0);s.terminated.raise(t,l);u[k].postcall?w():(nt(k),delete u[k]);b();break;case d.PhonesToPhoneBarMessages.PostCallWorkEvent:b();break;case d.PhonesToPhoneBarMessages.AudioRecordingStartedEvent:u[k]&&(u[k].recordingData.fileName=l.fileName,w(k),s.recordingstarted.raise(t,l));break;case d.PhonesToPhoneBarMessages.AudioRecordingCompletedEvent:nt(k,l.result);break;case d.PhonesToPhoneBarMessages.AudioRecordingMutedEvent:u[k].recordingData.rxChannelMuted=l.rxChannelMuted;u[k].recordingData.txChannelMuted=l.txChannelMuted;w(k);s.recordingmutechanged.raise(t,l);break;case d.PhonesToPhoneBarMessages.MaskedDigitReceivedEvent:s.maskeddigitreceived.raise(t,l);break;case d.PhonesToPhoneBarMessages.MaskedPayloadReceivedEvent:s.maskedpayloadreceived.raise(t,l);break;default:t.log("PhoneBar","Debug","Not implemented:",ht)}},{calls:function(n){var t=typeof n=="function"?n:null,i;return arguments.length>0&&t===null?u[n]||null:(i=Object.values(u),t)?i.filter(t):i},currentState:function(){return p},currentStateReason:function(){return k},currentStateReasonId:function(){return d},currentStateTime:function(){return rt},getConfiguration:function(){return ft},language:function(i){if(arguments.length===0)return v.language;i&&n.Strings[i]&&(r=n.Strings[i],v.language=i,hi(),t.log("PhoneBar","Debug","Language set to '"+i+"'"),s.languagechanged.raise(t,{language:i}))},isLoggedIn:function(){return t.connection.isConnected()},isOAuth2Enabled:function(){return v.localOAuth2},isRedirectedAfterOAuth2Signin:function(){return v.loginRedirect},isRedirectedAfterOAuth2Signout:function(){return v.logoutRedirect},initialize:function(u,e){if(arguments.length==1&&(e=u.options),p!==n.States.Initialization&&p!==f.NotLoggedIn)throw Ifm.Diagnostics.Errors.op("must be not logged in");if(t)ft=u,t.config=h=u.config,!(Ifm.Iam&&Ifm.Iam.OAuth2&&h.enableOAuth2)||v.localOAuth2||(v.localOAuth2=!0,v.loginRedirect=Ifm.Iam.OAuth2.isOAuth2Redirect(),v.logoutRedirect=Ifm.Iam.OAuth2.isLogoutRedirect(),Ifm.Iam.OAuth2.addLogCallback(t.log),Ifm.Iam.OAuth2.addTokenChangeCallback(dt));else{if(!n.canRun())throw Ifm.Diagnostics.Errors.browser();Ifm.version=n.version+"; "+Ifm.version;t=this;ft=u;t.config=h=u.config;s=n.events;f=n.States;i=n.UI.Elements;jQuery.fn.extend({enable:function(){return this.each(function(){jQuery(this).prop("disabled",!1);jQuery(this).removeAttr("disabled")})},disable:function(){return this.each(function(){jQuery(this).prop("disabled",!0);jQuery(this).attr("disabled","")})},enabled:function(n){return this.each(function(){n?jQuery(this).enable():jQuery(this).disable()})}});v.localOAuth2=!!(Ifm.Iam&&Ifm.Iam.OAuth2&&h.enableOAuth2);v.localOAuth2&&(v.loginRedirect=Ifm.Iam.OAuth2.isOAuth2Redirect(),v.logoutRedirect=Ifm.Iam.OAuth2.isLogoutRedirect(),Ifm.Iam.OAuth2.addLogCallback(t.log),Ifm.Iam.OAuth2.addTokenChangeCallback(dt));jQuery(i.NumberInput).attr("maxlength",255).on("change input",function(){var n=jQuery(i.NumberInput).val().replace(/([^0-9#*])/g,"");jQuery(i.NumberInput).val(n);ct()})}t.log("PhoneBar","Info",Ifm.version);Ifm.Diagnostics.Debug.enabled=h.debug||!1;t.language(n.Strings[h.language]?h.language:"it");jQuery('[class^="phonebar-phone"]').hide();jQuery(i.AbortCallButton).disable().hide();jQuery("#page-layout").show();"value"in document.createElement("meter")||jQuery(i.SpeakersVULabel+", "+i.SpeakersVUMeter+", "+i.MicrophoneVULabel+", "+i.MicrophoneVUMeter).remove();t.media.phone&&(t.media.phone.terminate(),delete t.media.phone);h.phoneDevice&&(h.phoneDevice in n.Media?(t.media.phone=new n.Media[h.phoneDevice](t),t.media.phone.updateCallButton=ct,t.media.phone.initialize(u)):t.log("PhoneBar","Error","Invalid configuration argument PhoneDevice:",h.phoneDevice));t.media.xmpp&&(t.media.xmpp.terminate(),delete t.media.xmpp);n.Media.Xmpp.instance&&u.xmppconfig&&u.xmppconfig.service&&u.xmppconfig.useBuiltinXmppWindow!==!1&&(t.media.xmpp=n.Media.Xmpp.instance,t.media.xmpp.initialize(t,u.xmppconfig));pt();y(f.NotLoggedIn);a(r.NotLoggedInState);w(0);t.agent.load();for(var o in e)t.options[o]&&t.options[o](e[o]);s.initialized.raise(t,{settings:u,options:e});v.localOAuth2&&!v.logoutRedirect&&v.loginRedirect&&t.getToken(function(n){t.loginWithToken(n,t.agent.extension)})},login:function(i,r,u,f,s){var a,y,p,l;if(arguments.length<4||arguments.length>5)throw Ifm.Diagnostics.Errors.argsno("4 (+1)");if(s&&!Ifm.Type.isFunction(s))throw Ifm.Diagnostics.Errors.func("callback");if(t.connection.isConnected())throw Ifm.Diagnostics.Errors.op("already logged in");f=f!=undefined&&f!=null?f.toString():"";a=i==="\t";a||(t.agent.firstName=i,t.agent.lastName=r);t.agent.password=u;t.agent.extension=f;t.agent.save();var c=h.service,w=h.protocol||at,b=h.flags||lt;if(Ifm.Type.isString(f)&&f.startsWith("@")&&(c=h.service_rop||h.service,w=h.protocol_rop||yt,b=h.flags_rop||vt,f=t.agent.extension=f.slice(1)),a){if(y=(Ifm.Type.isArray(c)?c[0]:c)||"",y.startsWith("*")){if(!t.agent.username){if(v.localOAuth2){t.getToken(function(n){t.login(i,r,n,f,s)});return}t.log("PhoneBar","Error","External token must specify a valid username for cloud-based login.")}p=t.agent.username.split("@");l=p.length==2?p[1]:"";l=l.replace(/\./g,"-");c=y.replace("*","wss://"+l+"-agents")}t.log("PhoneBar","Info","Loggin'in to",c,"via OAuth2 as",t.agent.username,"extension",f)}else t.log("PhoneBar","Info","Loggin'in to",c,"as",i,r,"extension",f);o.connect(c,w,function(){s&&e.login.push(s);t.log("PhoneBar","Debug","Sending LoginRequest message");o.send(new n.Messages.LoginRequest(i,r,u,f,b))})},loginEx:function(i,r,u,f,s,c){if(arguments.length<5||arguments.length>6)throw Ifm.Diagnostics.Errors.argsno("5 (+1)");if(c&&!Ifm.Type.isFunction(c))throw Ifm.Diagnostics.Errors.func("callback");if(t.connection.isConnected())throw Ifm.Diagnostics.Errors.op("already logged in");s=s!=undefined&&s!=null?s.toString():"";t.agent.firstName=i;t.agent.lastName=r;t.agent.password=f;t.agent.extension=s;t.agent.save();var l=h.service,a=h.protocol||at,v=h.flags||lt;Ifm.Type.isString(s)&&s.startsWith("@")&&(l=h.service_rop||h.service,a=h.protocol_rop||yt,v=h.flags_rop||vt,s=t.agent.extension=s.slice(1));t.log("PhoneBar","Info","Loggin'in to",l,"as",i,r,"ext.",s);o.connect(l,a,function(){c&&e.login.push(c);t.log("PhoneBar","Debug","Sending LoginRequest message");o.send(new n.Messages.LoginExRequest(i,r,u,f,s,v))})},getToken:function(n,i,r){if(arguments.length>3)throw Ifm.Diagnostics.Errors.argsno("0 (+3)");if(n&&!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");if(!r&&!v.localOAuth2)throw Ifm.Diagnostics.Errors.notsup("OAuth2");const u=r?{authorityUrl:r.authorityurl,authorityIsAdfs:r.isadfs,clientId:r.clientid,scopes:r.scopes}:h;"usePopup"in u||(u.usePopup=Ifm.Photon&&Ifm.Photon.app.isHosted||!1);Ifm.Iam.OAuth2.getToken(u,i||t.agent.username).then(function(t){n&&t.token&&n(t.token)}).catch(function(n){t.log("PhoneBar","Error",n&&(n.message||n.errorMessage)||n)})},loginWithToken:function(n,i,r,u){if(arguments.length<2||arguments.length>4)throw Ifm.Diagnostics.Errors.argsno("2 (+2)");ht(n,r);t.login("\t","\t",n,i,u)},updateToken:function(n,t){if(arguments.length>2)throw Ifm.Diagnostics.Errors.argsno("1 (+1)");ht(n,t)},logout:function(i){if(arguments.length>1)throw Ifm.Diagnostics.Errors.argsno("0 (+1)");if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");i&&e.logout.push(i);t.log("PhoneBar","Debug","Sending LogoutRequest message");o.send(new n.Messages.LogoutRequest)},pause:function(i,r){if(arguments.length>2)throw Ifm.Diagnostics.Errors.argsno("0 (+2)");if(r&&!Ifm.Type.isFunction(r))throw Ifm.Diagnostics.Errors.func("callback");r&&e.pause.push(r);t.log("PhoneBar","Debug","Sending PauseRequest message");o.send(new n.Messages.PauseRequest(i))},ready:function(i,r){if(arguments.length>2)throw Ifm.Diagnostics.Errors.argsno("0 (+2)");if(r&&!Ifm.Type.isFunction(r))throw Ifm.Diagnostics.Errors.func("callback");r&&e.ready.push(r);t.log("PhoneBar","Debug","Sending ReadyRequest message",i?"for call "+i:"");o.send(new n.Messages.ReadyRequest(i))},makeCall:function(i,r,u,f){if(arguments.length<2||arguments.length>4)throw Ifm.Diagnostics.Errors.argsno("2 (+1)");if(f&&!Ifm.Type.isFunction(f))throw Ifm.Diagnostics.Errors.func("callback");if(c)throw Ifm.Diagnostics.Errors.op("a previous request is pending");f&&e.make.push(f);let s=!1;if(Ifm.Type.isString(i)){const n=i.split(";");if(n.length>1){const t=n[1].split(",").filter(function(n){return s|=n==="H"||n==="h",!s});i=n[0];t.length>0&&(i+=";"+t.join(","))}}c={campaignName:r,externalParty:i,hideNumber:s};t.log("PhoneBar","Debug","Sending NewCallRequest message");o.send(new n.Messages.NewCallRequest(i,r,u||""))},abortCall:function(i){if(arguments.length>1)throw Ifm.Diagnostics.Errors.argsno("0 (+1)");if(i&&!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");c?(i&&e.abort.push(i),t.log("PhoneBar","Debug","Sending AbortCallRequest messagefor call",c.callId),o.send(new n.Messages.AbortCallRequest(c.callId))):i&&i({callId:0,campaign:"",accepted:0})},transferCall:function(i,r,f,s,h,c,l){if(arguments.length<2||arguments.length>7)throw Ifm.Diagnostics.Errors.argsno("2 (+5)");if(l&&!Ifm.Type.isFunction(l))throw Ifm.Diagnostics.Errors.func("callback");u[i]&&u[i].mediatype>n.Mediatypes.Voice?c=0:c!==0&&c!==2&&(c=n.TransferCallModes.Default);l&&e.transfer.push(l);var a=u[i]&&u[i].callData.toString();t.log("PhoneBar","Debug","Sending TransferCallRequest message for call",i);o.send(new n.Messages.TransferCallRequest(i,c,r,a,f,s,h))},getAgentList:function(n,i,r){if(arguments.length!==3)throw Ifm.Diagnostics.Errors.argsno("3");if(!Ifm.Type.isFunction(r))throw Ifm.Diagnostics.Errors.func("callback");t.isLoggedIn()&&(e.getAgentList.push({campaignName:n,mask:i,callback:r}),e.getAgentList.length===1&&ni())},getTransferAgentList:function(n,i){var r=1022;return t.options.hidePausedAgents()&&(r=990),t.getAgentList(n,r,i)},getCampaignList:function(n,i,r,u){if(arguments.length!==4)throw Ifm.Diagnostics.Errors.argsno("4");if(!Ifm.Type.isFunction(u))throw Ifm.Diagnostics.Errors.func("callback");t.isLoggedIn()&&(e.getCampaignList.push({callId:n,mediatype:i,mask:r,callback:u}),e.getCampaignList.length===1&&ti())},getAssignedCampaignList:function(n){return t.getCampaignList(0,0,95,n)},getOutboundCampaignList:function(n){return t.getCampaignList(0,0,82,n)},getTransferCampaignList:function(n,i){var r=0,u;return n&&t.calls(n)&&(r=t.calls(n).mediatype),u=378,t.getCampaignList(n,r,u,i)},getPauseReasons:function(n){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!Ifm.Type.isFunction(n))throw Ifm.Diagnostics.Errors.func("callback");t.isLoggedIn()&&(e.getPauseReasons.push(n),e.getPauseReasons.length===1&&ii())},getQueueInfo:function(n,i){if(arguments.length!==2)throw Ifm.Diagnostics.Errors.argsno("2");if(!Ifm.Type.isFunction(i))throw Ifm.Diagnostics.Errors.func("callback");t.isLoggedIn()&&(e.getQueueInfo.push({campaignName:n,callback:i}),e.getQueueInfo.length===1&&ri())},panic:function(){if(arguments.length!==0)throw Ifm.Diagnostics.Errors.argsno("0");t.log("PhoneBar","Debug","Sending AgentPanicEvent message");o.send(new n.Messages.AgentPanicEvent)},log:function(n,t){var e;if(arguments.length<3)throw Ifm.Diagnostics.Errors.argsno("3+");var r="",f=new Date,o=f.toLocaleTimeString()+"."+("000"+f.getMilliseconds()).slice(-3),u=t.toLowerCase();ui&&u!=="debug"&&(u="log");n&&(r+="["+n+"] ");t&&(r+="["+t+"] ");r+=Array.prototype.splice.call(arguments,2).join(" ");try{console[u](r)}catch(s){console.log(r)}e=jQuery(i.LogText);e.length&&(r=r.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),jQuery(i.LogText).append("<div class='phonebar-log-text-"+t.toLowerCase()+"'><span class='phonebar-log-text-timestamp'>"+o+" <\/span><span class='phonebar-log-text-line'>"+r+"<\/span><\/div>").parent().scrollTop(jQuery(i.LogText).height()))},startRecording:function(r,u,f){var s,e,c;if(arguments.length<1||arguments.length>3)throw Ifm.Diagnostics.Errors.argsno("1 (+2)");if(!r||!t.calls(r))throw Ifm.Diagnostics.Errors.arg("callId");if(s=t.calls(r).mediatype,s!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");Ifm.Type.isString(u)||(u=h.recordingsPath||"C:\\Recordings\\",u.endsWith("\\")||(u+="\\"),e=t.calls(r).lastRecordingPart=(t.calls(r).lastRecordingPart||0)+1,c=e>1?" ("+e+")":"",u+=(new Date).toISOLocaleDateString()+" "+r+" "+t.agent.getName()+c+".wav");jQuery(i.StartRecordingButton).disable();t.calls(r).isRecording=!0;t.log("PhoneBar","Debug","Sending StartAudioRecordingRequest message for call",r);o.send(new n.Messages.StartAudioRecordingRequest(r,u,f||0))},stopRecording:function(r){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!r||!t.calls(r))throw Ifm.Diagnostics.Errors.arg("callId");var u=t.calls(r).mediatype;if(u!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");jQuery(i.StopRecordingButton).disable();t.log("PhoneBar","Debug","Sending StopAudioRecordingRequest message for call",r);o.send(new n.Messages.StopAudioRecordingRequest(r))},muteRecording:function(i,r,u,f){if(arguments.length<3||arguments.length>4)throw Ifm.Diagnostics.Errors.argsno("3 (+1)");if(!i||!t.calls(i))throw Ifm.Diagnostics.Errors.arg("callId");var e=t.calls(i).mediatype;if(e!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");t.log("PhoneBar","Debug","Sending SetAudioRecordingMuteRequest message for call",i);o.send(new n.Messages.SetAudioRecordingMuteRequest(i,u,r,!!f,f||""))},tagRecording:function(i,r){if(arguments.length!==2)throw Ifm.Diagnostics.Errors.argsno("2");if(!i||!t.calls(i))throw Ifm.Diagnostics.Errors.arg("callId");var u=t.calls(i).mediatype;if(u!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support recording");t.log("PhoneBar","Debug","Sending AppendCueSheetEntryRequest message for call",i);o.send(new n.Messages.AppendCueSheetEntryRequest(i,r||""))},swapCall:function(i){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!i||!t.calls(i))throw Ifm.Diagnostics.Errors.arg("callId");var r=t.calls(i).mediatype;if(r!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support swap");t.log("PhoneBar","Debug","Sending ConsultationCallControlRequest message for call",i);o.send(new n.Messages.ConsultationCallControlRequest(i,1))},startDTMFMasking:function(i,r,u){if(arguments.length!==3)throw Ifm.Diagnostics.Errors.argsno("3");if(!i||!t.calls(i))throw Ifm.Diagnostics.Errors.arg("callId");var f=t.calls(i).mediatype;if(f!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support DTMFMasking");t.log("PhoneBar","Debug","Sending StartDTMFMaskingRequest - callId:",i,"numberOfDigits:",r,"terminationDigit:",u);o.send(new n.Messages.StartDTMFMaskingRequest(i,r,u))},stopDTMFMasking:function(i){if(arguments.length!==1)throw Ifm.Diagnostics.Errors.argsno("1");if(!i||!t.calls(i))throw Ifm.Diagnostics.Errors.arg("callId");var r=t.calls(i).mediatype;if(r!==n.Mediatypes.Voice)throw Ifm.Diagnostics.Errors.op("this call's mediatype does not support DTMFMasking");t.log("PhoneBar","Debug","Sending StopDTMFMaskingRequest - callId:",i);o.send(new n.Messages.StopDTMFMaskingRequest(i))},agent:{firstName:"",lastName:"",password:"",extension:"",username:"",getName:function(){return this.firstName+" "+this.lastName},load:function(){t.agent.extension=Ifm.Cookies.get(l.agent.extension);t.options.rememberCredentials()&&(t.agent.firstName=Ifm.Cookies.get(l.agent.firstName),t.agent.lastName=Ifm.Cookies.get(l.agent.lastName),t.agent.username=Ifm.Cookies.get(l.agent.username),t.agent.password=Ifm.Cookies.get(l.agent.password))},save:function(){Ifm.Cookies.set(l.agent.extension,this.extension);t.options.rememberCredentials()&&(Ifm.Cookies.set(l.agent.firstName,this.firstName),Ifm.Cookies.set(l.agent.lastName,this.lastName),Ifm.Cookies.set(l.agent.username,this.username));t.options.rememberCredentials()===2&&Ifm.Cookies.set(l.agent.password,this.password)}},config:{},connection:{events:o.events,isConnected:function(){return o.isConnected()},_getConnection:function(){return o}},media:{},options:function(){var o=1,s=1,h="",c=1,a=1,v=1,y=!1,p=!1,u=!1,f=!1,t=!1,e=!1,i=!1,w=!0,b=!1,k=/INPUT|SELECT|TEXTAREA/i;jQuery(document).on("keydown keyup",function(n){if(n.which===8&&!n.ctrlKey&&!n.shiftKey&&!n.altkey&&f){var i=n.target;if(!k.test(i.tagName)||i.disabled||i.readOnly)return!1}return n.which===82&&n.ctrlKey&&t?!1:n.which===116&&(!n.ctrlKey&&e||n.ctrlKey&&t)?!1:void 0});jQuery(document).on("contextmenu",function(){return i&&Ifm.PhoneBar.UI.Commands&&setTimeout(Ifm.PhoneBar.UI.Commands.showMenu,0),!i});jQuery(window).on("beforeunload",function(){if(u&&n.instance.isLoggedIn())return r.UnloadPageConfirm});return{autoAnswerPhone:function(n){if(n===undefined)return o;n>=0&&n<=3&&(o=n)},autoAnswerRings:function(n){if(n===undefined)return s;s=n},autoConnectToXmpp:function(n){if(n===undefined)return w;w=n},hideClockInPause:function(n){if(n===undefined)return y;y=!!n},hidePausedAgents:function(n){if(n===undefined)return p;p=!!n},callingNumber:function(n){if(n===undefined)return h;h=n},rememberCredentials:function(n){if(n===undefined)return c;(n===0||n===1||n===2)&&(c=n);n<2&&this.forgetPassword();n<1&&(Ifm.Cookies.delete(l.agent.firstName),Ifm.Cookies.delete(l.agent.lastName),Ifm.Cookies.delete(l.agent.username))},loginOnStart:function(n){if(n===undefined)return a;(n===0||n===1||n===2)&&(a=n)},popupIncomingCalls:function(n){if(n===undefined)return v;Ifm.Type.isNumber(n)&&(v=n)},confirmNavigation:function(n){if(n===undefined)return u;u=!!n},preventBackspace:function(n){if(n===undefined)return f;f=!!n},preventHardRefresh:function(n){if(n===undefined)return t;t=!!n},preventRefresh:function(n){if(n===undefined)return e;e=!!n},preventRightClick:function(n){if(n===undefined)return i;i=!!n},showCampaignNameForVoiceCalls:function(n){if(n===undefined)return b;b=!!n},forgetPassword:function(){Ifm.Cookies.delete(l.agent.password);n.instance.agent.password=""}}}()}}(Ifm.PhoneBar)}(Ifm.PhoneBar);namespace("Ifm.PhoneBar.UI").Elements={MainToolbar:".phonebar-toolbar",PhoneToolbar:".phonebar-phone-toolbar",PhoneDialPad:".phonebar-phone-dialpad",LogText:".phonebar-log-text",StateText:".phonebar-state-text",StateTimeText:".phonebar-state-time-text",PhoneStateText:".phonebar-phone-state-text",RecordingStateText:".phonebar-recording-state-text",NumberLabel:".phonebar-number-label",NumberInput:".phonebar-number-input",LoginButton:".phonebar-login-button",LoginOrReadyButton:".phonebar-login-ready-button",ReadyButton:".phonebar-ready-button",PauseButton:".phonebar-pause-button",LogoutButton:".phonebar-logout-button",CallButton:".phonebar-call-button",AbortCallButton:".phonebar-abort-call-button",TransferButton:".phonebar-transfer-button",CampaignListButton:".phonebar-campaignlist-button",QueueInfoButton:".phonebar-queueinfo-button",PanicButton:".phonebar-panic-button",StartRecordingButton:".phonebar-start-recording-button",StopRecordingButton:".phonebar-stop-recording-button",MuteRecordingButton:".phonebar-mute-recording-button",UnmuteRecordingButton:".phonebar-unmute-recording-button",MainMenuButton:".phonebar-mainmenu-button",HangupButton:".phonebar-phone-hangup-button",PickupButton:".phonebar-phone-pickup-button",FlashButton:".phonebar-phone-flash-button",ManualTransferButton:".phonebar-phone-manual-transfer-button",Line1Button:".phonebar-phone-line1-button",Line2Button:".phonebar-phone-line2-button",EnterConferenceButton:".phonebar-phone-enter-conference-button",LeaveConferenceButton:".phonebar-phone-leave-conference-button",MicrophoneVULabel:".phonebar-phone-microphone-label",MicrophoneVUMeter:".phonebar-phone-microphone-meter",SpeakersVULabel:".phonebar-phone-speakers-label",SpeakersVUMeter:".phonebar-phone-speakers-meter",MicrophoneOffButton:".phonebar-phone-microphone-off-button",MicrophoneOnButton:".phonebar-phone-microphone-on-button",HideDialPadButton:".phonebar-phone-dialpad-hide-button",ShowDialPadButton:".phonebar-phone-dialpad-show-button",ToggleDialPadButton:".phonebar-phone-dialpad-toggle-button",DialPadDigit0Button:".phonebar-phone-key-digit0",DialPadDigit1Button:".phonebar-phone-key-digit1",DialPadDigit2Button:".phonebar-phone-key-digit2",DialPadDigit3Button:".phonebar-phone-key-digit3",DialPadDigit4Button:".phonebar-phone-key-digit4",DialPadDigit5Button:".phonebar-phone-key-digit5",DialPadDigit6Button:".phonebar-phone-key-digit6",DialPadDigit7Button:".phonebar-phone-key-digit7",DialPadDigit8Button:".phonebar-phone-key-digit8",DialPadDigit9Button:".phonebar-phone-key-digit9",DialPadHashButton:".phonebar-phone-key-hash",DialPadStarButton:".phonebar-phone-key-star",TransferCampaignList:".phonebar-transfer-campaign-list",TransferAgentList:".phonebar-transfer-agent-list",TransferMandatoryCheck:".phonebar-transfer-mandatory-check"};namespace("Ifm.PhoneBar.Media");namespace("Ifm.PhoneBar.Media.Phone");namespace("Ifm.PhoneBar.Media.Phone.events");namespace("Ifm.PhoneBar.Media.Xmpp");namespace("Ifm.PhoneBar.Media.Xmpp.events");namespace("Ifm.PhoneBar.Messages"),function(){this.PhonesToPhoneBarMessages={AssignmentRequest:12292,KeepAliveRequest:12543,LoginReply:20480,LogoutReply:20481,ReadyReply:20482,PauseReply:20483,NewCallReply:20485,TransferCallReply:20486,CampaignListReply:20487,AgentListReply:20488,CampaignQueueInfoReply:20489,SetCampaignStatusReply:20490,AbortCallReply:20494,RetrieveCallReply:20495,ReadyEvent:36866,PauseEvent:36867,AlertingEvent:38912,AnsweredEvent:38913,TerminatedEvent:38914,CallFailureEvent:38915,OtherCallEvent:38916,PostCallWorkEvent:38917,SupervisorMessageEvent:38919,ReadyForTransferEvent:38920,ReadyForDetachEvent:38921,BookedEvent:38924,AudioRecordingStartedEvent:38933,AudioRecordingMutedEvent:38934,AudioRecordingCompletedEvent:38935,MaskedDigitReceivedEvent:38936,MaskedPayloadReceivedEvent:38937};this.AssignmentRequest=function(n){this.callId=n.nextInt32();this.rejectable=n.nextByte();this.campaignName=n.nextString();this.scriptName=n.nextString();this.scriptParameters=n.nextString();this.callDataStr=n.nextString();this.dummy=n.nextByte();this.cfgVersion=n.nextString();this.serviceId=n.nextString();this.campaignId=n.nextString();this.recordingState=n.remainingBytes()>=1?n.nextByte():0;this.recordingFileName=n.remainingBytes()>=2?n.nextString():"";this.recordingSettings=n.remainingBytes()>=4?n.nextInt32():0;this.mediatype=n.remainingBytes()>=4?n.nextInt32():0};this.KeepAliveRequest=function(){};this.LoginReply=function(n){this.accepted=n.nextByte();n.remainingBytes()&&(this.agentId=n.nextString(),n.nextString(),this.failureCause=n.nextByte(),this.extension=n.remainingBytes()>=2?n.nextString():null);n.remainingBytes()&&(this.firstName=n.nextString(),this.lastName=n.nextString(),this.username=n.nextString())};this.LogoutReply=function(n){this.accepted=n.nextByte()};this.ReadyReply=function(n){this.accepted=n.nextByte();this.callId=n.remainingBytes()>=4?n.nextInt32():null};this.PauseReply=function(n){var i,t,r,u;if(this.accepted=n.nextByte(),this.accepted<3&&n.remainingBytes())this.reasonId=n.nextInt32(),this.reasonText=n.nextString();else if(this.accepted===3)for(i=n.nextInt32(),this.reasons=[],t=0;t<i;t++)r=n.nextInt32(),u=n.nextString(),this.reasons.push({id:r,text:u})};this.NewCallReply=function(n){this.callId=n.nextInt32();this.accepted=n.nextByte()};this.TransferCallReply=function(n){this.callId=n.nextInt32();this.accepted=n.nextByte()};this.CampaignListReply=function(n){function e(n){return n.name=n.serviceName+"/"+n.campaignName,n.active=!!(t&2),n.status=t&7,n.boundness=t&8?"Inbound":"Outbound",n.assigned=!!(t&64),n.transfer=!!(t&256),n}var s=n.nextInt16(),f,i,t,r,u,o;for(this.campaigns=[],f=0;f<s;f++)if(i=n.nextString(),t=n.nextInt32()&2147483679,t&2147483648)for(r=i.split("\t"),u=1;u<r.length;u++)i=r[u].slice(0,-1),o=r[u].slice(-1).charCodeAt(0)*2,this.campaigns.push(e({campaignName:i,serviceName:r[0],flags:o+(t&~2147483648)}));else this.campaigns.push(e({campaignName:i.split("/")[1],serviceName:i.split("/")[0],flags:t}));this.campaigns.sort(function(n,t){var i=n.name.toUpperCase(),r=t.name.toUpperCase();return i<r?-1:i>r?1:0})};this.AgentListReply=function(n){var u=n.nextInt16(),t,i,r;for(this.agents=[],t=0;t<u;t++)i=n.nextString(),r=n.nextString(),this.agents.push({firstName:i,lastName:r,name:i+" "+r,campaignName:n.nextString(),state:n.remainingBytes()>=4?n.nextInt32():0,time:n.remainingBytes()>=4?n.nextInt32():0});this.agents.sort(function(n,t){var i=(n.lastName+" "+n.firstName).toUpperCase(),r=(t.lastName+" "+t.firstName).toUpperCase();return i<r?-1:i>r?1:0})};this.CampaignQueueInfoReply=function(n){var f=n.nextInt16(),i;for(this.calls=0,this.avgTime=0,this.maxTime=0,this.campaigns=[],i=0;i<f;i++){var e=n.nextString(),t=n.nextInt32(),r=n.nextInt32(),u=n.nextInt32();this.campaigns.push({name:e,calls:t,avgTime:u,maxTime:r});this.calls+t>0&&(this.avgTime=(this.avgTime*this.calls+u*t)/(this.calls+t));r>this.maxTime&&(this.maxTime=r);this.calls+=t}};this.SetCampaignStatusReply=function(){};this.AbortCallReply=function(n){this.callId=n.nextInt32();this.accepted=n.nextByte()};this.RetrieveCallReply=function(){};this.ReadyEvent=function(){};this.PauseEvent=function(n){n.remainingBytes()?(this.reasonId=n.nextInt32(),this.reasonText=n.nextString()):(this.reasonId=0,this.reasonText="")};this.AlertingEvent=function(n){this.callId=n.nextInt32()};this.AnsweredEvent=function(n){this.callId=n.nextInt32()};this.TerminatedEvent=function(n){this.callId=n.nextInt32();this.postCallWork=n.nextByte()};this.CallFailureEvent=function(n){this.callId=n.nextInt32();this.cause=n.nextByte();this.protocolTerminationCause=n.remainingBytes()>=4?n.nextInt32():0;this.protocolTerminationDescription=n.remainingBytes()>=2?n.nextString():"";this.detectedContentCode=n.remainingBytes()>=4?n.nextInt32():0;this.detectedContentDescription=n.remainingBytes()>=2?n.nextString():""};this.OtherCallEvent=function(n){this.callId=n.nextInt32()};this.PostCallWorkEvent=function(n){this.callId=n.nextInt32()};this.SupervisorMessageEvent=function(n){this.severity=n.nextInt16();this.message=n.nextString()};this.ReadyForTransferEvent=function(n){this.callId=n.nextInt32();this.campaignName=n.nextString();this.agentFirstName=n.nextString();this.agentLastName=n.nextString()};this.ReadyForDetachEvent=function(n){this.callId=n.nextInt32();this.callTerminated=n.remainingBytes()>=1?n.nextByte()!==0?!0:!1:undefined;this.protocolTerminationCause=n.remainingBytes()>=4?n.nextInt32():0;this.protocolTerminationDescription=n.remainingBytes()>=2?n.nextString():"";this.detectedContentCode=n.remainingBytes()>=4?n.nextInt32():0;this.detectedContentDescription=n.remainingBytes()>=2?n.nextString():""};this.BookedEvent=function(n){this.campaignName=n.nextString();this.mediatype=n.remainingBytes()>=4?n.nextInt32():0};this.AudioRecordingStartedEvent=function(n){this.callId=n.nextInt32();this.fileName=n.nextString()};this.AudioRecordingMutedEvent=function(n){this.callId=n.nextInt32();this.txChannelMuted=n.nextByte()!==0?!0:!1;this.rxChannelMuted=n.nextByte()!==0?!0:!1};this.AudioRecordingCompletedEvent=function(n){this.callId=n.nextInt32();this.result=n.nextInt32()};this.MaskedDigitReceivedEvent=function(n){this.callId=n.nextInt32()};this.MaskedPayloadReceivedEvent=function(n){this.callId=n.nextInt32();this.payload=n.nextString();this.result=n.nextInt32()};this.PhoneBarToPhonesMessages={LoginRequest:8192,LogoutRequest:8193,ReadyRequest:8194,PauseRequest:8195,NewCallRequest:8197,TransferCallRequest:8198,CampaignListRequest:8199,AgentListRequest:8200,CampaignQueueInfoRequest:8201,SetCampaignStatusRequest:8202,LoginExRequest:8204,AbortCallRequest:8206,RetrieveCallRequest:8207,AssignmentReply:16388,KeepAliveReply:16639,AgentPanicEvent:32779,SetAgentScriptStateEvent:34826,SetCallResultEvent:34827,AgentNewCallEvent:34829,RemoteOffHookEvent:34830,RemoteOnHookEvent:34831,RemoteRingingEvent:34832,RemoteManualHangUpEvent:34835,DelcoTunnelMessageEvent:34836};this.DelcoTunnelMessages={ConsultationCallControlRequest:9218,StartAudioRecordingRequest:9219,StopAudioRecordingRequest:9220,SetAudioRecordingMuteRequest:9221,AppendCueSheetEntryRequest:9222,StartDTMFMaskingRequest:9223,StopDTMFMaskingRequest:9224};this.LoginRequest=function(n,t,i,r,u){var f=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.LoginRequest);return f.addString(n).addString(t).addString(i).addString(r).addByte(u||0).end(),f};this.LogoutRequest=function(){var n=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.LogoutRequest);return n.end(),n};this.ReadyRequest=function(n){var t=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.ReadyRequest);return t.addInt32(n!==undefined?n:-1).end(),t};this.PauseRequest=function(n){var t=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.PauseRequest);return n&&t.addByte(1).addInt32(n),t.end(),t};this.PauseReasonsRequest=function(){var n=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.PauseRequest);return n.addByte(3).addInt32(0).end(),n};this.NewCallRequest=function(n,t,i){var r=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.NewCallRequest);return r.addString(n).addString(t).addString(i).end(),r};this.TransferCallRequest=function(n,t,i,r,u,f,e){var o=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.TransferCallRequest);return o.addInt32(n).addInt32(t).addString(i).addString(r).addString(u).addString(f).addByte(e?1:0).end(),o};this.CampaignListRequest=function(n,t,i){var r=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.CampaignListRequest);return r.addInt32(n|2147483648).addInt32(i).addInt32(t).end(),r};this.AgentListRequest=function(n,t){var i=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AgentListRequest);return i.addString(n).addInt32(t).end(),i};this.CampaignQueueInfoRequest=function(n){var t=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.CampaignQueueInfoRequest);return t.addString(n).addInt32(n?0:2).end(),t};this.SetCampaignStatusRequest=function(){};this.LoginExRequest=function(n,t,i,r,u,f){var e=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.LoginExRequest);return e.addString(n).addString(t).addString(i).addString(r).addString(u).addByte(f||0).end(),e};this.AbortCallRequest=function(n){var t=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AbortCallRequest);return t.addInt32(n).end(),t};this.RetrieveCallRequest=function(){var n=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.RetrieveCallRequest);return n.addInt32(callId).end(),n};this.AssignmentReply=function(n,t){var i=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AssignmentReply);return i.addInt32(n).addByte(t).end(),i};this.KeepAliveReply=function(){var n=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.KeepAliveReply);return n.end(),n};this.AgentPanicEvent=function(){var n=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.AgentPanicEvent);return n.addByte(1).end(),n};this.SetAgentScriptStateEvent=function(n,t){var i=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.SetAgentScriptStateEvent);return i.addInt32(n).addString((t||0)+255).end(),i};this.SetCallResultEvent=function(n,t){var i=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.SetCallResultEvent);return i.addInt32(n).addString(t).end(),i};this.AgentNewCallEvent=function(){};this.RemoteOffHookEvent=function(){};this.RemoteOnHookEvent=function(){};this.RemoteRingingEvent=function(){};this.RemoteManualHangUpEvent=function(){};this.ConsultationCallControlRequest=function(n,t){var i=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return i.addInt32(n).addInt32(12).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.ConsultationCallControlRequest).addByte(1).addByte(1).addInt32(4).addInt32(t).end(),i};this.StartAudioRecordingRequest=function(n,t,i){var r=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return r.addInt32(n).addInt32(19+t.length*2).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StartAudioRecordingRequest).addByte(1).addByte(1).addInt32(2+t.length*2).addUniString(t).addByte(1).addInt32(4).addInt32(i).end(),r};this.StopAudioRecordingRequest=function(n){var t=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return t.addInt32(n).addInt32(3).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StopAudioRecordingRequest).addByte(1).end(),t};this.SetAudioRecordingMuteRequest=function(n,t,i,r,u){var f=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return f.addInt32(n).addInt32(37+u.length*2).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.SetAudioRecordingMuteRequest).addByte(1).addByte(1).addInt32(4).addBool32(t).addByte(1).addInt32(4).addBool32(i).addByte(1).addInt32(4).addBool32(r).addByte(1).addInt32(2+u.length*2).addUniString(u).end(),f};this.AppendCueSheetEntryRequest=function(n,t){var i=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return i.addInt32(n).addInt32(10+t.length*2).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.AppendCueSheetEntryRequest).addByte(1).addByte(1).addInt32(2+t.length*2).addUniString(t).end(),i};this.StartDTMFMaskingRequest=function(n,t,i){var r=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return r.addInt32(n).addInt32(18).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StartDTMFMaskingRequest).addByte(1).addByte(1).addInt32(4).addInt32(t).addByte(1).addInt32(1).addByte(i).end(),r};this.StopDTMFMaskingRequest=function(n){var t=new Ifm.Messaging.FMessageWriter(Ifm.PhoneBar.Messages.PhoneBarToPhonesMessages.DelcoTunnelMessageEvent);return t.addInt32(n).addInt32(3).addInt16(Ifm.PhoneBar.Messages.DelcoTunnelMessages.StopDTMFMaskingRequest).addByte(1).end(),t}}.call(Ifm.PhoneBar.Messages),function(){function n(t){if(!(this instanceof n))throw Ifm.Diagnostics.Errors.ctor();this.phonebar=t;this._isConnected=!1;this._isMuted=!1;this._isRegistered=undefined;this._lineStates=[];for(var i=0;i<this.numberOfLines;i++)this._lineStates.push(n.States.Idle);this._selectedLineId=0;this._isInConference=!1;this._accessToken=""}function t(n){return n=Array.prototype.slice.call(arguments),jQuery(n.join(","))}var e=namespace("Ifm.PhoneBar.Media");n.events=defineEvents("initialized","connected","disconnected","registeredstatechanged","linestatechanged","conferencestatechanged","lineselected","calling","callconnected","calldisconnected","displayname","incomingcall","ringing","mutechanged","vumeter");n.States={Idle:"[Idle]",Incoming:"[Incoming]",Calling:"[Calling]",Talking:"[Talking]"};n.prototype.numberOfLines=1;n.prototype.supportsConference=!1;Object.defineProperties(n.prototype,{isConnected:{get:function(){return this._isConnected}},isInConference:{get:function(){return this._isInConference}},isMuted:{get:function(){return this._isMuted}},isRegistered:{get:function(){return this._isRegistered}},selectedLineId:{get:function(){return this._selectedLineId}},state:{get:function(){return this._lineStates[this._selectedLineId]}}});n.prototype.initialize=function(n){this.phonebar.log(i,r,"Initializing");this._settings=n||{};this._initializeElements();this._enableAllElements(!1);this._initialize()};n.prototype.connect=function(){this.phonebar.log(i,r,"Connecting");this._connect()};n.prototype.disconnect=function(){this.phonebar.log(i,r,"Disconnecting");this._disconnect()};n.prototype.setAccessToken=function(n){this.phonebar.log(i,r,"Setting Access Token");this._accessToken=n;this._isConnected&&this._setAccessToken(n)};n.prototype.terminate=function(){this.phonebar.log(i,r,"Terminating");this._terminate()};n.prototype.answer=function(){this.phonebar.log(i,r,"Answering");this._answer()};n.prototype.canConference=function(){if(!this.supportsConference)return!1;for(var t=0,i=0;t<this.numberOfLines;t++)this._lineStates[t]===n.States.Talking&&i++;return i>1};n.prototype.dial=function(t){if(!t&&t!==0){this.phonebar.log(i,u,"No number to dial");return}if(this.state===n.States.Ringing){this.phonebar.log(i,u,"Can't dial in current state");return}this.phonebar.log(i,r,"Dialing number",t);this.state===n.States.Idle?this._dial(t):this._dtmf(t)};n.prototype.dtmf=function(t){if(!t&&t!==0){this.phonebar.log(i,u,"No dtmf to dial");return}if(this.state===n.States.Idle||this.state===n.States.Ringing){this.phonebar.log(i,u,"Can't dial in current state");return}this.phonebar.log(i,r,"Dialing tones",t);this._dtmf(t)};n.prototype.drop=function(){this.phonebar.log(i,r,"Dropping");this._drop()};n.prototype.enterConference=function(){if(!this.supportsConference){this.phonebar.log(i,u,"Device doesn't support conference");return}this.phonebar.log(i,r,"Entering conference");this._enterConference()};n.prototype.getLineState=function(n){if(!(n>=0&&n<this.numberOfLines)){this.phonebar.log(i,u,"Invalid lineId specified:",n);return}return this._lineStates[n]};n.prototype.leaveConference=function(){if(!this.supportsConference){this.phonebar.log(i,u,"Device doesn't support conference");return}this.phonebar.log(i,r,"Leaving conference");this._leaveConference()};n.prototype.mute=function(){this.phonebar.log(i,r,"Muting microphone");this._mute()};n.prototype.register=function(){var n=this.domain,t=this.phonebar.agent.extension;this.phonebar.log(i,r,"Registering device to",n,t);this._register(n,t)};n.prototype.selectLine=function(n){if(this.numberOfLines<2){this.phonebar.log(i,u,"Device doesn't support multiple lines");return}this.phonebar.log(i,r,"Selecting line",n);this._selectLine(n)};n.prototype.unmute=function(){this.phonebar.log(i,r,"Unmuting microphone");this._unmute()};n.prototype.unregister=function(){this.phonebar.log(i,r,"Unregistering device");this._unregister()};n.prototype._initialize=function(){};n.prototype._connect=function(){};n.prototype._disconnect=function(){};n.prototype._setAccessToken=function(){};n.prototype._terminate=function(){};n.prototype._answer=function(){};n.prototype._dial=function(){};n.prototype._dtmf=function(){};n.prototype._drop=function(){};n.prototype._enterConference=function(){};n.prototype._leaveConference=function(){};n.prototype._mute=function(){};n.prototype._register=function(){};n.prototype._selectLine=function(){};n.prototype._unmute=function(){};n.prototype._unregister=function(){};n.prototype._onInitialized=function(){this.phonebar.log(i,r,"Initialized");n.events.initialized.raise(this,{})};n.prototype._onConnected=function(){this.phonebar.log(i,r,"Connected");this._isConnected=!0;this._enableAllElements(!0);var u=Ifm.PhoneBar.UI.Elements;t(u.PhoneStateText).html("").removeClass("blink");n.events.connected.raise(this,{});this._accessToken&&this.setAccessToken(this._accessToken)};n.prototype._onDisconnected=function(u){var e,o,f;this.phonebar.log(i,r,"Disconnected");this._isConnected=!1;this._enableAllElements(!1);n.events.disconnected.raise(this,{clean:u});this.phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn&&(e=Ifm.PhoneBar.UI.Elements,o=Ifm.PhoneBar.Strings[this.phonebar.language()],t(e.PhoneStateText).html(o.PhoneNotConnected).addClass("blink"),f=this,setTimeout(function(){f._isConnected||f.phonebar.currentState()===Ifm.PhoneBar.States.NotLoggedIn||f.connect()},1e4))};n.prototype._onRegisteredStateChanged=function(r){var e,o,u;this.phonebar.log(i,f,"Device",r?"is":"is not","registered");this._isRegistered=r;e=Ifm.PhoneBar.UI.Elements;o=Ifm.PhoneBar.Strings[this.phonebar.language()];r?t(e.PhoneStateText).html("").removeClass("blink"):this._isConnected&&(u=this,setTimeout(function(){u._isConnected&&!u._isRegistered&&u.phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn&&(u.register(),setTimeout(function(){u._isConnected&&!u._isRegistered&&u.phonebar.currentState()!==Ifm.PhoneBar.States.NotLoggedIn&&t(e.PhoneStateText).html(o.PhoneNotRegistered).addClass("blink")},5e3))},5e3));n.events.registeredstatechanged.raise(this,{isRegistered:r})};n.prototype._onLineStateChanged=function(t,r){this.phonebar.log(i,f,"Line",t+1,"in state",r);this._lineStates[t]=r;this._updateLineSelectors(t,!1,!0);t===this._selectedLineId&&this._updateCurrentLineControls();n.events.linestatechanged.raise(this,{lineId:t,state:r})};n.prototype._onConferenceStateChanged=function(t){this.phonebar.log(i,r,"Lines are",t?"":"not","in conference");this._isInConference=t;this._updateConferenceButtons(t);this._updateCurrentLineControls();n.events.conferencestatechanged.raise(this,{inConference:t})};n.prototype._onLineSelected=function(t){this.phonebar.log(i,r,"Line",t+1,"selected");this._selectedLineId=t;this._updateLineSelectors(t,!0,!1);n.events.lineselected.raise(this,{lineId:t})};n.prototype._onCalling=function(t){this.phonebar.log(i,r,"Calling on line",t+1);n.events.calling.raise(this,{lineId:t})};n.prototype._onCallConnected=function(t){this.phonebar.log(i,r,"Call connected on line",t+1);n.events.callconnected.raise(this,{lineId:t})};n.prototype._onCallDisconnected=function(t,u,f){this.phonebar.log(i,r,"Call disconnected on line",t+1,"; sip code:",u,"sip cause:",f);n.events.calldisconnected.raise(this,{lineId:t,sipCode:u,sipCause:f})};n.prototype._onDisplayName=function(t,u){var f=this._getAudioCall();t===0&&f&&f.hideNumber&&(u=f.displayNumber);this.phonebar.log(i,r,"Got display name",u,"for incoming call on line",t+1);n.events.displayname.raise(this,{lineId:t,displayName:u})};n.prototype._onIncomingCall=function(t){this.phonebar.log(i,r,"Incoming call on line",t+1);n.events.incomingcall.raise(this,{lineId:t})};n.prototype._onRinging=function(t,u){if(this.phonebar.log(i,r,"Line",t+1,"is ringing;",u,"ring(s)"),n.events.ringing.raise(this,{lineId:t,rings:u}),this.phonebar.options.autoAnswerPhone()){var f=0,e=this._getAudioCall();f=e===null?3:e.callId<32768?2:1;f<=this.phonebar.options.autoAnswerPhone()&&u>=this.phonebar.options.autoAnswerRings()&&(this.phonebar.log(i,r,"Attempting autoanswer on line",t),this._answer())}};n.prototype._onMuteChanged=function(t){this.phonebar.log(i,r,"Microphone is",t?"":"not","muted");this._isMuted=t;this._updateMicMuteButtons(t);n.events.mutechanged.raise(this,{isMuted:t})};n.prototype._onVUMeter=function(i,r){var u=Ifm.PhoneBar.UI.Elements;t(u.MicrophoneVUMeter).val(i);t(u.SpeakersVUMeter).val(r);n.events.vumeter.raise(this,{microphone:i,speakers:r})};n.prototype._getAudioCall=function(){return this.phonebar.calls(function(n){return n.mediatype===Ifm.PhoneBar.Mediatypes.Voice})[0]||null};n.prototype._initializeElements=function(){var i=this,n=Ifm.PhoneBar.UI.Elements;t('[class^="phonebar-phone"]').show();t(n.PhoneDialPad,n.HideDialPadButton).hide();t(n.ShowDialPadButton,n.ToggleDialPadButton).disable();t(n.NumberInput).on("change input",function(){i._updateCurrentLineFlashControls()});if(this.numberOfLines===1)t(n.Line1Button,n.Line2Button).remove();else if(this.numberOfLines!==2)throw Error("Unsupported number of lines specified: "+this.numberOfLines);(this.numberOfLines<2||!this.supportsConference)&&t(n.EnterConferenceButton,n.LeaveConferenceButton).remove()};n.prototype._enableAllElements=function(n){var i=Ifm.PhoneBar.UI.Elements;t(i.MicrophoneOnButton,i.MicrophoneOffButton,i.Line1Button,i.Line2Button).enabled(n);t(i.MicrophoneOnButton).hide().enabled(n);n?(t(i.ShowDialPadButton,i.ToggleDialPadButton).enable(),this._updateCurrentLineControls()):(t(i.PickupButton,i.LeaveConferenceButton).hide().disable(),t(i.HangupButton,i.FlashButton,i.ManualTransferButton,i.EnterConferenceButton).disable(),t(i.Line1Button,i.Line2Button).removeClass("selected"),t(i.PhoneDialPad,i.HideDialPadButton).hide(),t(i.HideDialPadButton,i.ShowDialPadButton,i.ToggleDialPadButton).disable(),t('[class^="phonebar-phone-key"]').disable())};n.prototype._updateCurrentLineControls=function(){var i=Ifm.PhoneBar.UI.Elements;switch(this.state){case n.States.Incoming:t(i.HangupButton).hide().disable();t(i.PickupButton).show().enable();break;case n.States.Calling:case n.States.Talking:t(i.PickupButton).hide().disable();t(i.HangupButton).show().enable();break;default:t(i.PickupButton).hide().disable();t(i.HangupButton).show().disable()}this._updateCurrentLineFlashControls()};n.prototype._updateCurrentLineFlashControls=function(){var i=Ifm.PhoneBar.UI.Elements;this.state===n.States.Talking?(t('[class^="phonebar-phone-key"]').enable(),t(i.FlashButton).enabled(!this._isInConference),t(i.ManualTransferButton).enabled(!this._isInConference&&t(i.NumberInput).val())):t('[class^="phonebar-phone-key"]',i.FlashButton,i.ManualTransferButton).disable();this.phonebar.currentState()===Ifm.PhoneBar.States.WaitingOutbound&&this._selectedLineId===0?t(i.CallButton).enabled(!1):this._selectedLineId>0?t(i.CallButton).enabled(this.state===n.States.Idle&&t(i.NumberInput).val()):this.updateCallButton()};n.prototype._updateLineSelectors=function(i,r,u){var f=Ifm.PhoneBar.UI.Elements,e=i===0?f.Line1Button:f.Line2Button,o=i===1?f.Line1Button:f.Line2Button;if(r&&(t(o).removeClass("selected"),t(e).addClass("selected")),u){switch(this._lineStates[i]){case n.States.Idle:t(e).removeClass("highlight blink");break;case n.States.Talking:t(e).addClass("highlight").removeClass("blink");break;default:t(e).addClass("highlight blink")}this.supportsConference&&t(f.EnterConferenceButton).enabled(this.canConference())}i===this._selectedLineId&&this._updateCurrentLineControls()};n.prototype._updateConferenceButtons=function(n){var i=Ifm.PhoneBar.UI.Elements;n?(t(i.EnterConferenceButton).hide().disable(),t(i.LeaveConferenceButton).show().enable()):(t(i.LeaveConferenceButton).hide().disable(),t(i.EnterConferenceButton).show().disable(),this.supportsConference&&this.canConference()&&t(i.EnterConferenceButton).enable())};n.prototype._updateMicMuteButtons=function(n){var i=Ifm.PhoneBar.UI.Elements,r=n?i.MicrophoneOffButton:i.MicrophoneOnButton,u=n?i.MicrophoneOnButton:i.MicrophoneOffButton;t(r).hide();t(u).show()};n.prototype._updateVUMeterElements=function(n,i){var r=Ifm.PhoneBar.UI.Elements;t(r.MicrophoneVUMeter).val(n);t(r.SpeakersVUMeter).val(i)};var i="PhoneBar.Media.Phone",r="Debug",f="Info",u="Warn";e.Phone=n}();namespace("Ifm.PhoneBar.Strings",{en:{UnloadPageConfirm:"If you leave the page, you close any conversation open and you won't be able to receive new calls!",NoBrowserSupport:"Your browser does not have the features needed to run the PhoneBar",Loading:"Loading",AccountLockedOut:"Your logon has been locked out. Contact the administrator",CantChangePassword:"You're not authorized to change your password",InvalidNewPassword:"The new password doesn't meet security requirements",PasswordExpired:"Your password has expired, change it to log in",PasswordsDontMatch:"The new passwords don't match",UserOrExtensionTaken:"Logon credentials or extension already taken",WrongCredentials:"Invalid logon credentials",InvalidExtension:"Invalid extension",ExtensionInUse:"Extension already taken",TokenBasedLoginError:"Error occourred with domain authentication",NotLoggedInState:"Not available",ConnectingState:"Connecting",LoggedInState:"Available",PausedState:"Paused",ReadyState:"Available",TalkingState:"Talking",PostCallState:"In post-call",OtherCallState:"In manual conversation",AssignedState:"Assigned",AlertingState:"Incoming call",WaitingOutboundState:"Dialing call",WaitingTransferState:"Transferring",PhoneNotConnected:"Phone not connected!",PhoneNotRegistered:"Phone not reachable!",ConnectionFailed:"Connection failed",ConnectionLost:"Connection lost",AssignmentBooked:"Booked",PauseBooked:"Pause booked",RequestRefused:"Request refused",CallFailure:"Call failure",GenericBusyState:"Busy",CallFailureNoDialTone:"no dial tone",CallFailureNoRingback:"no ringback",CallFailureLineBusy:"number busy",CallFailureNoAnswer:"no answer",CallFailureFaxTone:"fax",CallFailureRemoteHangUp:"hangup",CallFailureAgentNoDialTone:"no dial tone by the agent",CallFailureAgentNoRingback:"no ringback by the agent",CallFailureAgentBusy:"agent busy",CallFailureAgentNoAnswer:"no answer by the agent",CallFailureUnknown:"unknown cause",OutboundManualCall:"Manual call",PauseGenericReason:"Generic pause",TooltipLogin:"Log in",TooltipLoginOrReady:"Ready",TooltipReady:"Ready",TooltipPause:"Pause",TooltipLogout:"Log out",TooltipCall:"Call",TooltipTransfer:"Transfer window",TooltipQueueInfo:"Display queue info",TooltipCampaignList:"Display assigned campaigns",TooltipPanic:"HELP ME!",TooltipMainMenu:"Menu",TooltipPhoneNumber:"Phone number",TooltipStartRec:"Start recording",TooltipStopRec:"Stop recording",TooltipMuteRec:"Suspend recording",TooltipUnmuteRec:"Resume recording",TooltipHangup:"Hang up",TooltipPickup:"Pick up",TooltipFlash:"Hold and retrieve",TooltipManualTransfer:"Manual transfer",TooltipMicVUMeter:"Microphone",TooltipSpkVUMeter:"Speakers",TooltipMicOff:"Turn microphone OFF",TooltipMicOn:"Turn microphone ON",TooltipLine1:"Line 1",TooltipLine2:"Line 2",TooltipEnterConf:"Join conference",TooltipLeaveConf:"Leave conference",MenuItemAbout:"About PhoneBar",MenuItemCampaigns:"Assigned Campaigns",MenuItemDialpad:"Dialpad",MenuItemExit:"Exit",MenuItemPanic:"Request Assistance",MenuItemQueueInfo:"Queue State",MenuItemAutoHide:"Auto Hide",MenuItemDevTools:"Activate Debugger",MenuItemOptions:"Options",MenuItemRefresh:"Refresh",MenuItemReload:"Reload (no cache)",MenuItemReset:"Reset",MenuItemShowLogs:"Show Logs",ButtonOK:"OK",ButtonCancel:"Cancel",ButtonChangePassword:"Change Password...",ButtonRefresh:"Refresh",ButtonRetry:"Retry",ButtonTransfer:"Trasferisci",AssignmentsTitle:"Assigned Campaigns",IncomingCallText:"INCOMING CALL!",UnknownCallingNumber:"Unknown Number",QueueInfoTitle:"Queue Info",queuedAvgTimeText:"avg T",queuedMaxTimeText:"max T",queuedNumberText:"queued",LoginTitle:"Enter your credentials",LoginOAuth2Title:"Domain Authentication",LoginFirstName:"First name:",LoginLastName:"Last name:",LoginUsername:"Username:",LoginPassword:"Password:",LoginOldPassword:"Current password:",LoginNewPassword:"New password:",LoginConfirmPassword:"Confirm password:",LoginExtension:"Extension:",SupervisorTitle:"Supervisor Message",TransferTitle:"Call transfer",TransferCampaign:"Campaign:",TransferService:"Service:",TransferAnybody:"(Anybody)",TransferMandatory:"Transfer to the selected agent only",DialpadTitle:"Dialpad",OptionsTitle:"Options & Preferences"}});namespace("Ifm.PhoneBar.Strings",{it:{UnloadPageConfirm:"Se chiudi questa pagina, le conversazioni attive saranno perdute e non potrai ricevere nuove chiamate!",NoBrowserSupport:"Questo browser non ha le funzioni necessarie per la PhoneBar",Loading:"Caricamento",AccountLockedOut:"Il tuo accesso è stato sospeso. Contatta l'amministratore",CantChangePassword:"Non sei autorizzato a modificare la tua password",InvalidNewPassword:"La nuova password non soddisfa i criteri di sicurezza",PasswordExpired:"La tua password è scaduta, cambiala per accedere",PasswordsDontMatch:"Le nuove password non corrispondono",UserOrExtensionTaken:"Credenziali di accesso o interno già in uso",WrongCredentials:"Credenziali di accesso non valide",InvalidExtension:"Interno non valido",ExtensionInUse:"Interno già in uso",TokenBasedLoginError:"Si è verificato un errore con l'autenticazione di dominio",NotLoggedInState:"Non disponibile",ConnectingState:"Connessione in corso",LoggedInState:"Disponibile",PausedState:"In pausa",ReadyState:"Disponibile",TalkingState:"In conversazione",PostCallState:"In post-chiamata",OtherCallState:"In conversazione manuale",AssignedState:"In assegnazione",AlertingState:"Chiamata in arrivo",WaitingOutboundState:"In generazione chiamata",WaitingTransferState:"In trasferimento",PhoneNotConnected:"Telefono non collegato!",PhoneNotRegistered:"Telefono non raggiungibile!",ConnectionFailed:"Connessione fallita",ConnectionLost:"Caduta connessione",AssignmentBooked:"In pre-assegnazione",PauseBooked:"Pausa prenotata",RequestRefused:"Richiesta rifiutata",CallFailure:"Chiamata fallita",GenericBusyState:"Impegnato/a",CallFailureNoDialTone:"nessun tono di chiamata",CallFailureNoRingback:"nessuno squillo",CallFailureLineBusy:"numero occupato",CallFailureNoAnswer:"nessuna risposta",CallFailureFaxTone:"fax",CallFailureRemoteHangUp:"riaggancio",CallFailureAgentNoDialTone:"nessun tono di chiamata sull'operatore",CallFailureAgentNoRingback:"nessuno squillo sull'operatore",CallFailureAgentBusy:"operatore occupato",CallFailureAgentNoAnswer:"nessuna risposta da operatore",CallFailureUnknown:"causa sconosciuta",OutboundManualCall:"Chiamata manuale",PauseGenericReason:"Pausa generica",TooltipLogin:"Accesso",TooltipLoginOrReady:"Disponibile",TooltipReady:"Disponibile",TooltipPause:"Pause",TooltipLogout:"Logout",TooltipCall:"Chiama",TooltipTransfer:"Finestra di trasferimento",TooltipQueueInfo:"Mostra stato code",TooltipCampaignList:"Mostra campagne assegnate",TooltipPanic:"AIUTO!",TooltipMainMenu:"Menu",TooltipPhoneNumber:"Numero di telefono",TooltipStartRec:"Avvia registrazione",TooltipStopRec:"Ferma registrazione",TooltipMuteRec:"Sospendi registrazione",TooltipUnmuteRec:"Riprendi registrazione",TooltipHangup:"Aggancia",TooltipPickup:"Rispondi",TooltipFlash:"In attesa e riprendi",TooltipManualTransfer:"Trasferimento manuale",TooltipMicVUMeter:"Microfono",TooltipSpkVUMeter:"Cuffie",TooltipMicOff:"DISATTIVA microfono",TooltipMicOn:"ATTIVA microfono",TooltipLine1:"Linea 1",TooltipLine2:"Linea 2",TooltipEnterConf:"Avvia conferenza",TooltipLeaveConf:"Chiudi conferenza",MenuItemAbout:"Info su PhoneBar",MenuItemCampaigns:"Campagne Assegnate",MenuItemDialpad:"Tastiera Virtuale",MenuItemExit:"Esci",MenuItemPanic:"Richiedi Assistenza",MenuItemQueueInfo:"Stato Code",MenuItemAutoHide:"Nascondi Automaticamente",MenuItemDevTools:"Attiva Debugger",MenuItemOptions:"Opzioni",MenuItemRefresh:"Ricarica",MenuItemReload:"Ricarica (no cache)",MenuItemReset:"Reimposta",MenuItemShowLogs:"Mostra Logs",ButtonOK:"OK",ButtonCancel:"Annulla",ButtonChangePassword:"Cambia Password...",ButtonRefresh:"Aggiorna",ButtonRetry:"Riprova",ButtonTransfer:"Trasferisci",AssignmentsTitle:"Assegnazioni",IncomingCallText:"CHIAMATA IN ARRIVO!",UnknownCallingNumber:"Numero Sconosciuto",QueueInfoTitle:"Stato Code",queuedAvgTimeText:"T medio",queuedMaxTimeText:"T max",queuedNumberText:"in coda",LoginTitle:"Inserisci le tue credenziali",LoginOAuth2Title:"Autenticazione di dominio",LoginFirstName:"Nome:",LoginLastName:"Cognome:",LoginUsername:"Username:",LoginPassword:"Password:",LoginOldPassword:"Password attuale:",LoginNewPassword:"Nuova password:",LoginConfirmPassword:"Conferma password:",LoginExtension:"Interno:",SupervisorTitle:"Messaggio del Supervisore",TransferTitle:"Trasferimento di chiamata",TransferCampaign:"Campagna:",TransferService:"Servizio:",TransferAnybody:"(Chiunque)",TransferMandatory:"Trasferisci solo all'agente selezionato",DialpadTitle:"Tastiera Virtuale",OptionsTitle:"Opzioni & Preferenze"}});